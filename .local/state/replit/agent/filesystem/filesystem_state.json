{"file_contents":{"client/src/components/PlayPage.tsx":{"content":"import { useState, useEffect, useCallback, useRef, useMemo, useLayoutEffect } from \"react\";\nimport { InputGrid, type CellFeedback } from \"./InputGrid\";\nimport { NumericKeyboard, type KeyState } from \"./NumericKeyboard\";\nimport { EndGameModal } from \"./EndGameModal\";\nimport { HelpDialog } from \"./HelpDialog\";\nimport { StreakCelebrationPopup } from \"./StreakCelebrationPopup\";\nimport { StreakSaverExitWarning } from \"./StreakSaverExitWarning\";\nimport { IntroScreen } from \"./IntroScreen\";\nimport { useInterstitialAd } from \"./InterstitialAd\";\nimport { BadgeCelebrationPopup } from \"./badges\";\nimport { useBadgeChecker } from \"@/hooks/useBadgeChecker\";\nimport type { UserBadgeWithDetails } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { ChevronLeft, Umbrella } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useGameData } from \"@/hooks/useGameData\";\nimport { useUserStats } from \"@/hooks/useUserStats\";\nimport { useUserSettings } from \"@/hooks/useUserSettings\";\nimport { useStreakSaverStatus } from \"@/hooks/useStreakSaverStatus\";\nimport { useStreakSaver } from \"@/contexts/StreakSaverContext\";\nimport { useGuessCache } from \"@/contexts/GuessCacheContext\";\nimport { useUserDateFormat } from \"@/hooks/useUserDateFormat\";\nimport { useGameMode } from \"@/contexts/GameModeContext\";\nimport { useSpinner, useSpinnerWithTimeout } from \"@/lib/SpinnerProvider\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { parseUserDateWithContext, formatCanonicalDate as formatCanonicalDateUtil } from \"@/lib/dateFormat\";\nimport greyHelpIcon from \"@assets/Grey-Help-Grey_1760979822771.png\";\nimport whiteHelpIcon from \"@assets/White-Help-DarkMode.svg\";\nimport mechanicHamsterGrey from \"@assets/Mechanic-Hamster-Grey.svg\";\nimport { readLocal, writeLocal, CACHE_KEYS } from \"@/lib/localCache\";\nimport { getSupabaseClient } from \"@/lib/supabaseClient\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { pageVariants, pageTransition } from \"@/lib/pageAnimations\";\n\ninterface PlayPageProps {\n  answerDateCanonical: string; // YYYY-MM-DD format - the canonical historical date\n  eventTitle: string;\n  eventDescription: string;\n  category?: string; // Only present in Local mode (user-specific puzzles)\n  clue1?: string;\n  clue2?: string;\n  maxGuesses?: number;\n  viewOnly?: boolean;\n  puzzleId?: number;\n  puzzleDate?: string; // The date this puzzle should be played (YYYY-MM-DD format)\n  fromArchive?: boolean;\n  hasExistingProgress?: boolean; // Whether the game has any existing guesses or is completed\n  skipIntro?: boolean; // Whether to skip the intro screen (e.g., when coming from OnboardingScreen)\n  showCelebrationFirst?: boolean;\n  hasOpenedCelebration?: boolean;\n  puzzleSourceMode?: 'global' | 'local'; // Explicit mode from parent - overrides context when set\n  onBack: () => void;\n  onHomeFromCelebration?: () => void;\n  onSetHasOpenedCelebration?: (value: boolean) => void;\n  onViewStats?: () => void;\n  onViewArchive?: () => void;\n  onContinueToLogin?: () => void; // For guest users after game ends\n}\n\ninterface GuessRecord {\n  guessValue: string;\n  feedbackResult: CellFeedback[];\n  categoryName?: string | null; // add this field\n}\n\ntype AllocatedGuessRow = {\n  id: number;\n  gameAttemptId: number;\n  guessValue: string;\n  slot_type: string;\n  category_id: number | null;\n  categories?: { name: string } | null;\n};\n\nexport function PlayPage({\n  answerDateCanonical,\n  eventTitle,\n  eventDescription,\n  category,\n  clue1,\n  clue2,\n  maxGuesses = 5,\n  viewOnly = false,\n  puzzleId,\n  puzzleDate,\n  fromArchive = false,\n  hasExistingProgress = false,\n  skipIntro = false,\n  showCelebrationFirst = false,\n  hasOpenedCelebration = false,\n  puzzleSourceMode,\n  onBack,\n  onHomeFromCelebration,\n  onSetHasOpenedCelebration,\n  onViewStats,\n  onViewArchive,\n  onContinueToLogin,\n}: PlayPageProps) {\n  const { user, isAuthenticated } = useAuth();\n  const { toast } = useToast();\n  // Pass puzzleSourceMode to useGameData to ensure we fetch from the correct tables\n  const { gameAttempts, getAllGuesses, loadingAttempts } = useGameData(\n    puzzleSourceMode ? { modeOverride: puzzleSourceMode } : undefined\n  );\n  const { stats: supabaseStats } = useUserStats();\n  const { settings } = useUserSettings();\n  const { holidayActive, holidayEndDate, endHoliday, isEndingHoliday, useStreakSaver: useStreakSaverMutation, declineStreakSaver, refetch: refetchStreakStatus } = useStreakSaverStatus();\n  const { isInStreakSaverMode, session: streakSaverSession, completeStreakSaverSession, cancelStreakSaverSession } = useStreakSaver();\n  const { getGuessesForPuzzle, setGuessesForPuzzle, addGuessToCache } = useGuessCache();\n  const { isLocalMode: contextIsLocalMode } = useGameMode();\n  \n  // Use explicit puzzleSourceMode if provided, otherwise fall back to context mode\n  // This ensures we use the correct mode that was active when the puzzle was selected\n  const isLocalMode = puzzleSourceMode ? puzzleSourceMode === 'local' : contextIsLocalMode;\n  \n  // Debug logging to help trace mode issues (CRITICAL for detecting cross-contamination bugs)\n  // Log once on mount and when mode changes\n  useEffect(() => {\n    console.log('[PlayPage] Mode configuration:', {\n      puzzleSourceMode,\n      contextIsLocalMode,\n      resolvedIsLocalMode: isLocalMode,\n      puzzleId,\n      puzzleDate,\n      willUseEndpoint: isLocalMode ? '/api/user/*' : '/api/*'\n    });\n  }, [puzzleSourceMode, contextIsLocalMode, isLocalMode, puzzleId, puzzleDate]);\n  \n  // Cache mode for guess cache operations - must match the data source mode\n  const cacheMode: 'global' | 'local' = isLocalMode ? 'local' : 'global';\n  const { showAd, triggerAd, handleClose: closeInterstitialAd, InterstitialAdComponent } = useInterstitialAd();\n  \n  // Get user's date format preferences\n  const {\n    formatCanonicalDate,\n    parseUserDate,\n    validateGuess,\n    formatWithOrdinal,\n    placeholders,\n    numDigits,\n    dateFormat,\n    isLoading: formatLoading\n  } = useUserDateFormat();\n  \n  // Format the answer in user's preferred format (e.g., \"010125\" or \"01011925\")\n  const formattedAnswer = formatCanonicalDate(answerDateCanonical);\n  \n  // Helper function to check if this puzzle is today's puzzle\n  const isPlayingTodaysPuzzle = (): boolean => {\n    if (!puzzleDate) return false;\n    \n    const today = new Date();\n    const year = today.getFullYear();\n    const month = String(today.getMonth() + 1).padStart(2, '0');\n    const day = String(today.getDate()).padStart(2, '0');\n    const todayDate = `${year}-${month}-${day}`;\n    \n    return puzzleDate === todayDate;\n  };\n  const [currentInput, setCurrentInput] = useState(\"\");\n  const [guesses, setGuesses] = useState<CellFeedback[][]>([]);\n  const [keyStates, setKeyStates] = useState<Record<string, KeyState>>({});\n  const [gameOver, setGameOver] = useState(false);\n  const [isWin, setIsWin] = useState(false);\n  const [showHelp, setShowHelp] = useState(false);\n  const [cluesEnabled, setCluesEnabled] = useState(true);\n  const [wrongGuessCount, setWrongGuessCount] = useState(0);\n  const [guessRecords, setGuessRecords] = useState<GuessRecord[]>([]);\n  const [showStreakCelebration, setShowStreakCelebration] = useState(false);\n  const [currentStreak, setCurrentStreak] = useState(0);\n  const [showCelebrationModal, setShowCelebrationModal] = useState(false);\n  const [pendingEndModal, setPendingEndModal] = useState(false); // Track if EndGameModal should show after streak celebration\n  const [earnedBadge, setEarnedBadge] = useState<UserBadgeWithDetails | null>(null);\n  const [pendingBadgeCheck, setPendingBadgeCheck] = useState(false); // Track if badge check should run after streak celebration\n  const [finalGuessCount, setFinalGuessCount] = useState<number | null>(null); // Store final guess count when game ends - prevents race condition issues\n  const [endModalDelayElapsed, setEndModalDelayElapsed] = useState(false); // Track when 2.5s delay has passed\n  const [endModalReady, setEndModalReady] = useState(false); // Track when modal data is ready to show\n  \n  // Badge checker hook\n  const { checkAllBadgesOnGameComplete } = useBadgeChecker();\n  const [currentGameAttemptId, setCurrentGameAttemptId] = useState<number | null>(null);\n  const [showEndModal, setShowEndModal] = useState(false);\n  const [lockedDigits, setLockedDigits] = useState<string | null>(null);\n  const [digitsCheckComplete, setDigitsCheckComplete] = useState(false);\n  const [showIntroScreen, setShowIntroScreen] = useState(false);\n  const [introExitingViaBack, setIntroExitingViaBack] = useState(false); // Track if IntroScreen is animating off via back button\n  const introScreenChecked = useRef(false); // Track if we've already made the intro screen decision\n  \n  // Streak saver exit warning dialog state\n  const [showStreakSaverExitWarning, setShowStreakSaverExitWarning] = useState(false);\n  \n  // Holiday mode warning dialog state\n  const [showHolidayWarning, setShowHolidayWarning] = useState(false);\n  const [holidayWarningDismissed, setHolidayWarningDismissed] = useState(false);\n  \n  // Track when guesses are being fetched asynchronously\n  const [guessesLoading, setGuessesLoading] = useState(false);\n  // Track when guesses have fully loaded (for triggering the 0.6s delay)\n  const [guessesLoaded, setGuessesLoaded] = useState(false);\n  \n  // Delay showing grid data for games with existing progress (smoother transition)\n  // Starts false and only becomes true 0.6s AFTER guesses have loaded\n  const [gridDataReady, setGridDataReady] = useState(false);\n  \n  // Track spinner state for game loading\n  const gameLoadingSpinnerRef = useRef(false);\n  \n  // Track dark mode state for background color\n  const [isDarkMode, setIsDarkMode] = useState(() => \n    document.documentElement.classList.contains('dark')\n  );\n  \n  // Listen for dark mode changes\n  useEffect(() => {\n    const observer = new MutationObserver((mutations) => {\n      mutations.forEach((mutation) => {\n        if (mutation.attributeName === 'class') {\n          setIsDarkMode(document.documentElement.classList.contains('dark'));\n        }\n      });\n    });\n    \n    observer.observe(document.documentElement, { attributes: true });\n    return () => observer.disconnect();\n  }, []);\n  \n  // Background color that adapts to dark mode\n  // Light mode: #FAFAFA (near white), Dark mode: hsl(222, 47%, 11%) = dark blue\n  const pageBackgroundColor = isDarkMode ? 'hsl(222, 47%, 11%)' : '#FAFAFA';\n  \n  // Show EndGameModal when both delay has elapsed AND modal is ready\n  // This ensures minimum 2.5s delay without adding delay on top of async work\n  useEffect(() => {\n    if (endModalDelayElapsed && endModalReady && !showEndModal && !showStreakCelebration) {\n      setShowEndModal(true);\n    }\n  }, [endModalDelayElapsed, endModalReady, showEndModal, showStreakCelebration]);\n  \n  // Spinner timeout callbacks for game loading\n  const handleGameLoadRetry = useCallback(() => {\n    console.log('[PlayPage] Game loading spinner timeout - triggering retry');\n    // Force re-check by invalidating and refetching\n    window.location.reload();\n  }, []);\n  \n  const handleGameLoadTimeout = useCallback(() => {\n    console.log('[PlayPage] Game loading spinner timeout - failed to load');\n    toast({\n      title: 'Failed to load',\n      description: 'Please try again in a bit.',\n      variant: 'destructive',\n    });\n    onBack();\n  }, [toast, onBack]);\n  \n  // Check if this is a streak saver game in progress\n  const isCurrentStreakSaverGame = isInStreakSaverMode && streakSaverSession && !gameOver;\n  \n  // Handle back button press - show warning if in streak saver mode\n  const handleBackButtonPress = useCallback(() => {\n    if (isCurrentStreakSaverGame) {\n      setShowStreakSaverExitWarning(true);\n    } else {\n      onBack();\n    }\n  }, [isCurrentStreakSaverGame, onBack]);\n  \n  // Spinner for cancel streak saver operation\n  const { showSpinner, hideSpinner } = useSpinner();\n  \n  // Handle cancel streak saver and lose streak\n  // This is called when user confirms they want to exit without completing the puzzle\n  // The streak is reset to 0 but the streak saver is NOT consumed\n  const handleCancelStreakSaver = useCallback(async () => {\n    setShowStreakSaverExitWarning(false);\n    \n    // Show spinner during async operations\n    showSpinner();\n    \n    // Reset streak via decline API (does NOT use a streak saver)\n    if (streakSaverSession) {\n      try {\n        console.log('[CancelStreakSaver] Declining streak saver - resetting streak without consuming saver');\n        await declineStreakSaver(streakSaverSession.gameType);\n        // Refetch streak status to update UI\n        await refetchStreakStatus();\n      } catch (error) {\n        console.error('[CancelStreakSaver] Failed to decline streak saver:', error);\n      }\n    }\n    \n    // Clear the session context\n    cancelStreakSaverSession();\n    \n    // Hide spinner before navigating back\n    hideSpinner();\n    onBack();\n  }, [streakSaverSession, declineStreakSaver, refetchStreakStatus, cancelStreakSaverSession, onBack, showSpinner, hideSpinner]);\n  \n  // Handle continue playing - reset exit animation state and close dialog\n  const handleContinuePlaying = useCallback(() => {\n    setShowStreakSaverExitWarning(false);\n    // Reset the exit animation state so the IntroScreen content is visible again\n    setIntroExitingViaBack(false);\n  }, []);\n  \n  // Spinner with timeout for game loading\n  // Note: /api/puzzles can take 5-7 seconds, so we use a generous 15s timeout\n  const gameLoadingSpinner = useSpinnerWithTimeout({\n    retryDelayMs: 6000,\n    timeoutMs: 15000,\n    onRetry: handleGameLoadRetry,\n    onTimeout: handleGameLoadTimeout,\n  });\n  \n  \n  // Check if game is loading based on actual data loading states\n  // Show spinner when: format loading, attempts loading, or guesses being fetched\n  // But NEVER show spinner when game is already over (prevents spinner after win/loss)\n  const isGameLoading = !gameOver && (formatLoading || loadingAttempts || guessesLoading);\n  \n  // Manage game loading spinner with timeout\n  useEffect(() => {\n    if (isGameLoading && !gameLoadingSpinnerRef.current) {\n      console.log('[PlayPage] Showing spinner with timeout - waiting for game data');\n      gameLoadingSpinner.start(0);\n      gameLoadingSpinnerRef.current = true;\n    } else if (!isGameLoading && gameLoadingSpinnerRef.current) {\n      console.log('[PlayPage] Game data loaded - completing spinner');\n      gameLoadingSpinner.complete();\n      gameLoadingSpinnerRef.current = false;\n    }\n    \n    // Cleanup on unmount\n    return () => {\n      if (gameLoadingSpinnerRef.current) {\n        gameLoadingSpinner.cancel();\n        gameLoadingSpinnerRef.current = false;\n      }\n    };\n  }, [isGameLoading, gameLoadingSpinner]);\n  \n  // Ref to always have the latest puzzleId (prevents stale closure issues)\n  const puzzleIdRef = useRef<number | undefined>(puzzleId);\n  useEffect(() => {\n    puzzleIdRef.current = puzzleId;\n  }, [puzzleId]);\n  \n  // Queue for pending guesses that failed to save (for retry)\n  const pendingGuessesRef = useRef<Array<{ attemptId: number; guess: GuessRecord }>>([]);\n\n  // Use locked digits if available, otherwise use user's current preference\n  const activeNumDigits = lockedDigits ? parseInt(lockedDigits) : numDigits;\n\n  // Generate active placeholders based on locked digit mode\n  const activePlaceholders = useMemo(() => {\n    const yearDigits = activeNumDigits === 8 ? 4 : 2;\n    const yearPlaceholders = Array(yearDigits).fill('Y');\n    \n    // Respect the user's region preference (DD/MM or MM/DD)\n    if (dateFormat.startsWith('dd')) {\n      return ['D', 'D', 'M', 'M', ...yearPlaceholders];\n    } else {\n      return ['M', 'M', 'D', 'D', ...yearPlaceholders];\n    }\n  }, [activeNumDigits, dateFormat]);\n\n  // Format the answer in the active digit mode\n  const activeFormattedAnswer = useMemo(() => {\n    // Create a date format string that matches the active digit mode\n    const activeFormat = activeNumDigits === 8 \n      ? (dateFormat.startsWith('dd') ? 'ddmmyyyy' : 'mmddyyyy')\n      : (dateFormat.startsWith('dd') ? 'ddmmyy' : 'mmddyy');\n    \n    return formatCanonicalDateUtil(answerDateCanonical, activeFormat as any);\n  }, [answerDateCanonical, activeNumDigits, dateFormat]);\n\n  // Check if current input is a valid date (memoized to avoid recomputation)\n  const isValidGuess = useMemo(() => {\n    if (currentInput.length !== activeNumDigits) {\n      return false;\n    }\n    // parseUserDate from useUserDateFormat already has format baked in\n    return parseUserDate(currentInput) !== null;\n  }, [currentInput, activeNumDigits, parseUserDate]);\n\n  // Load clues setting from Supabase or localStorage\n  useEffect(() => {\n    if (isAuthenticated && settings) {\n      setCluesEnabled(settings.cluesEnabled ?? true);\n    } else if (!isAuthenticated) {\n      const storedCluesEnabled = localStorage.getItem(\"cluesEnabled\");\n      setCluesEnabled(storedCluesEnabled ? storedCluesEnabled === \"true\" : true);\n    }\n  }, [isAuthenticated, settings]);\n\n  // Reset state when answerDateCanonical changes\n  // Note: This runs before loadCompletedPuzzle, so completed puzzles will reload their guesses after reset\n  useEffect(() => {\n    setCurrentInput(\"\");\n    setGuesses([]);\n    setKeyStates({});\n    setGameOver(false);\n    setIsWin(false);\n    setWrongGuessCount(0);\n    setGuessRecords([]);\n    setCurrentGameAttemptId(null);\n    setShowEndModal(false);\n    setFinalGuessCount(null);\n    setLockedDigits(null);\n    setDigitsCheckComplete(false);\n    setShowIntroScreen(false);\n    introScreenChecked.current = false; // Reset so intro screen can show for new puzzle\n    // Reset loading and ready states\n    setGuessesLoading(false);\n    setGuessesLoaded(false);\n    setGridDataReady(false);\n    // Reset holiday warning state for new puzzle\n    setHolidayWarningDismissed(false);\n    setShowHolidayWarning(false);\n  }, [answerDateCanonical]);\n  \n  // Show holiday warning popup when playing today's puzzle while holiday mode is active\n  // Applies to both Global and Local puzzles since streaks work the same way\n  // Wait for spinner to finish, then delay 300ms before showing popup\n  useEffect(() => {\n    if (\n      holidayActive &&\n      isPlayingTodaysPuzzle() &&\n      !gameOver &&\n      !holidayWarningDismissed &&\n      !showHolidayWarning &&\n      !isGameLoading // Wait for spinner to finish\n    ) {\n      const timer = setTimeout(() => {\n        setShowHolidayWarning(true);\n      }, 300);\n      return () => clearTimeout(timer);\n    }\n  }, [holidayActive, puzzleDate, gameOver, holidayWarningDismissed, showHolidayWarning, isGameLoading]);\n  \n  // Delay showing grid data after guesses have loaded (smoother page transition)\n  // Only applies to games with existing progress - triggers 0.6s after guesses load\n  useEffect(() => {\n    if (guessesLoaded && !gridDataReady) {\n      const timer = setTimeout(() => {\n        setGridDataReady(true);\n      }, 600); // 0.6 second delay after guesses load\n      \n      return () => clearTimeout(timer);\n    }\n  }, [guessesLoaded, gridDataReady]);\n  \n  // For new games (no existing progress), show grid immediately\n  // This runs after attempts are checked and no prior attempt is found\n  useEffect(() => {\n    if (!hasExistingProgress && digitsCheckComplete && !gridDataReady) {\n      setGridDataReady(true);\n    }\n  }, [hasExistingProgress, digitsCheckComplete, gridDataReady]);\n\n  // Check if puzzle is already completed and redirect if needed\n  // IMPORTANT: Skip if gameOver is already true - means we just completed the game in this session\n  // and already have the correct guesses in state. Re-running would cause a race condition where\n  // stale data from cache/DB overwrites the correct guesses.\n  useEffect(() => {\n    let mounted = true;\n    \n    const loadCompletedPuzzle = async () => {\n      // Skip if game is already over in this session - we already have correct state\n      if (gameOver) return;\n      \n      if (!viewOnly && !loadingAttempts) {\n        if (isAuthenticated && gameAttempts && puzzleId) {\n          // For authenticated users, check Supabase data using result !== null as completion check\n          const completedAttempt = gameAttempts.find(\n            attempt => attempt.puzzleId === puzzleId && attempt.result !== null\n          );\n          \n          if (completedAttempt && mounted) {\n            // Puzzle already completed - set to view-only mode\n            setGameOver(true);\n            setShowEndModal(true); // Show modal immediately for completed puzzles\n            // Defensive normalization: handle both \"won\"/\"lost\" (current) and \"win\"/\"loss\" (legacy)\n            const isWinResult = completedAttempt.result === \"won\" || completedAttempt.result === \"win\";\n            setIsWin(isWinResult);\n            // Set finalGuessCount immediately from attempt data to prevent race condition\n            // where user clicks Continue before guesses are loaded from async operation\n            if (completedAttempt.numGuesses != null) {\n              setFinalGuessCount(completedAttempt.numGuesses);\n            }\n            \n            // Lock digit mode from the completed attempt if it's set\n            if ((completedAttempt as any).digits) {\n              console.log('[loadCompletedPuzzle] Locking digit mode to:', (completedAttempt as any).digits);\n              setLockedDigits((completedAttempt as any).digits);\n            }\n            setDigitsCheckComplete(true);\n            \n            // Try to load guesses from cache first for faster loading (using mode-aware cache)\n            const cachedGuesses = puzzleId ? getGuessesForPuzzle(puzzleId, cacheMode) : null;\n            let attemptGuesses = cachedGuesses;\n            \n            if (!cachedGuesses) {\n              // Cache miss - need to fetch from Supabase\n              setGuessesLoading(true);\n              try {\n                const allGuesses = await getAllGuesses();\n                attemptGuesses = allGuesses.filter(g => g.gameAttemptId === completedAttempt.id);\n                \n                // Always cache results (including empty arrays) to avoid refetching\n                if (puzzleId) {\n                  setGuessesForPuzzle(puzzleId, cacheMode, attemptGuesses || []);\n                }\n              } finally {\n                if (mounted) {\n                  setGuessesLoading(false);\n                }\n              }\n            }\n            \n            if (mounted && attemptGuesses && attemptGuesses.length > 0) {\n              // Recalculate feedback client-side (not stored in DB)\n              // Convert canonical guesses from DB using LOCKED digit mode, not current preference\n              \n              // Create format based on locked digit mode from attempt\n              const lockedDigits = (completedAttempt as any).digits || '6';\n              const baseFormat = dateFormat.startsWith('dd') ? 'dd' : 'mm';\n              const lockedFormat = lockedDigits === '8' \n                ? (baseFormat === 'dd' ? 'ddmmyyyy' : 'mmddyyyy')\n                : (baseFormat === 'dd' ? 'ddmmyy' : 'mmddyy');\n              \n              let newKeyStates: Record<string, KeyState> = {};\n              const feedbackArrays = attemptGuesses.map(guess => {\n                // Convert canonical format (YYYY-MM-DD) using LOCKED digit mode\n                const displayFormat = formatCanonicalDateUtil(guess.guessValue, lockedFormat as any);\n                const feedback = calculateFeedbackForGuess(displayFormat, newKeyStates);\n                newKeyStates = updateKeyStates(displayFormat, feedback, newKeyStates);\n                return feedback;\n              });\n              setGuesses(feedbackArrays);\n              setKeyStates(newKeyStates);\n              // Set final guess count for completed puzzles (fixes bug where count shows 0 when returning from Archive)\n              setFinalGuessCount(feedbackArrays.length);\n              \n              // Reconstruct guess records for display with recalculated feedback\n              const records: GuessRecord[] = [];\n              let recordKeyStates: Record<string, KeyState> = {};\n              for (const guess of attemptGuesses) {\n                // Convert canonical format using LOCKED digit mode\n                const displayFormat = formatCanonicalDateUtil(guess.guessValue, lockedFormat as any);\n                const feedback = calculateFeedbackForGuess(displayFormat, recordKeyStates);\n                recordKeyStates = updateKeyStates(displayFormat, feedback, recordKeyStates);\n                records.push({\n                  guessValue: displayFormat,\n                  feedbackResult: feedback,\n                  categoryName: (guess as any).categoryName ?? null\n                });\n              }\n              setGuessRecords(records);\n              // Mark guesses as loaded to trigger the 0.6s delay\n              setGuessesLoaded(true);\n            } else if (mounted) {\n              // No guesses found but attempt exists - mark as loaded\n              setGuessesLoaded(true);\n            }\n          } else if (mounted) {\n            // No completed attempt found for authenticated users\n            setDigitsCheckComplete(true);\n            // Mark guesses as loaded so grid can show for new games\n            setGuessesLoaded(true);\n          }\n        } else {\n          // For guest users, check localStorage\n          const storedStats = localStorage.getItem(\"elementle-stats\");\n          if (storedStats) {\n            const stats = JSON.parse(storedStats);\n            const completion = stats.puzzleCompletions?.[formattedAnswer];\n            \n            if (completion && completion.completed && mounted) {\n              // Puzzle already completed - set to view-only mode\n              setGameOver(true);\n              setIsWin(completion.won);\n              if (completion.guesses && Array.isArray(completion.guesses)) {\n                const feedbackArrays = completion.guesses.map((gr: GuessRecord) => gr.feedbackResult);\n                setGuesses(feedbackArrays);\n                setGuessRecords(completion.guesses);\n                // Set final guess count for completed puzzles (fixes bug where count shows 0 when returning from Archive)\n                setFinalGuessCount(feedbackArrays.length);\n              }\n              // Guest data is sync from localStorage - mark as loaded immediately\n              setGuessesLoaded(true);\n            }\n          }\n          // For guest users, always mark digits check complete and guesses loaded (no database to check)\n          if (mounted) {\n            setDigitsCheckComplete(true);\n            setGuessesLoaded(true);\n          }\n        }\n      }\n    };\n    \n    loadCompletedPuzzle();\n    \n    return () => { mounted = false; };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [formattedAnswer, viewOnly, isAuthenticated, gameAttempts, loadingAttempts, puzzleId, dateFormat, cacheMode, gameOver]);\n\n  // Load completed puzzle guesses for view-only mode\n  useEffect(() => {\n    let mounted = true;\n    \n    const loadViewOnlyPuzzle = async () => {\n      if (viewOnly && !loadingAttempts) {\n        if (isAuthenticated && gameAttempts && puzzleId) {\n          // For authenticated users, check Supabase data using result !== null as completion check\n          const completedAttempt = gameAttempts.find(\n            attempt => attempt.puzzleId === puzzleId && attempt.result !== null\n          );\n          \n          if (completedAttempt && mounted) {\n            setGameOver(true);\n            setShowEndModal(true); // Show modal immediately for view-only mode\n            // Defensive normalization: handle both \"won\"/\"lost\" (current) and \"win\"/\"loss\" (legacy)\n            const isWinResult = completedAttempt.result === \"won\" || completedAttempt.result === \"win\";\n            setIsWin(isWinResult);\n            // Set finalGuessCount immediately from attempt data to prevent race condition\n            // where user clicks Continue before guesses are loaded from async operation\n            if (completedAttempt.numGuesses != null) {\n              setFinalGuessCount(completedAttempt.numGuesses);\n            }\n            \n            // Lock digit mode from the completed attempt if it's set\n            if ((completedAttempt as any).digits) {\n              console.log('[loadViewOnlyPuzzle] Locking digit mode to:', (completedAttempt as any).digits);\n              setLockedDigits((completedAttempt as any).digits);\n            }\n            setDigitsCheckComplete(true);\n            \n            // Try to load guesses from cache first for faster loading (using mode-aware cache)\n            const cachedGuesses = puzzleId ? getGuessesForPuzzle(puzzleId, cacheMode) : null;\n            let attemptGuesses = cachedGuesses;\n            \n            if (!cachedGuesses) {\n              // Cache miss - need to fetch from Supabase\n              setGuessesLoading(true);\n              try {\n                const allGuesses = await getAllGuesses();\n                attemptGuesses = allGuesses.filter(g => g.gameAttemptId === completedAttempt.id);\n                \n                // Always cache results (including empty arrays) to avoid refetching\n                if (puzzleId) {\n                  setGuessesForPuzzle(puzzleId, cacheMode, attemptGuesses || []);\n                }\n              } finally {\n                if (mounted) {\n                  setGuessesLoading(false);\n                }\n              }\n            }\n            \n            if (mounted && attemptGuesses && attemptGuesses.length > 0) {\n              // Recalculate feedback client-side (not stored in DB)\n              // Convert canonical guesses from DB using LOCKED digit mode, not current preference\n              \n              // Create format based on locked digit mode from attempt\n              const lockedDigits = (completedAttempt as any).digits || '6';\n              const baseFormat = dateFormat.startsWith('dd') ? 'dd' : 'mm';\n              const lockedFormat = lockedDigits === '8' \n                ? (baseFormat === 'dd' ? 'ddmmyyyy' : 'mmddyyyy')\n                : (baseFormat === 'dd' ? 'ddmmyy' : 'mmddyy');\n              \n              let newKeyStates: Record<string, KeyState> = {};\n              const feedbackArrays = attemptGuesses.map(guess => {\n                // Convert canonical format (YYYY-MM-DD) using LOCKED digit mode\n                const displayFormat = formatCanonicalDateUtil(guess.guessValue, lockedFormat as any);\n                const feedback = calculateFeedbackForGuess(displayFormat, newKeyStates);\n                newKeyStates = updateKeyStates(displayFormat, feedback, newKeyStates);\n                return feedback;\n              });\n              setGuesses(feedbackArrays);\n              setKeyStates(newKeyStates);\n              // Set final guess count for completed puzzles (fixes bug where count shows 0 when returning from Archive)\n              setFinalGuessCount(feedbackArrays.length);\n              \n              // Reconstruct guess records for display with recalculated feedback\n              const records: GuessRecord[] = [];\n              let recordKeyStates: Record<string, KeyState> = {};\n              for (const guess of attemptGuesses) {\n                // Convert canonical format using LOCKED digit mode\n                const displayFormat = formatCanonicalDateUtil(guess.guessValue, lockedFormat as any);\n                const feedback = calculateFeedbackForGuess(displayFormat, recordKeyStates);\n                recordKeyStates = updateKeyStates(displayFormat, feedback, recordKeyStates);\n                records.push({\n                  guessValue: displayFormat,\n                  feedbackResult: feedback,\n                  categoryName: (guess as any).categoryName ?? null\n                });\n              }\n              setGuessRecords(records);\n              // Mark guesses as loaded to trigger the 0.6s delay\n              setGuessesLoaded(true);\n            } else if (mounted) {\n              // No guesses found but attempt exists - mark as loaded\n              setGuessesLoaded(true);\n            }\n          } else if (mounted) {\n            // No completed attempt found\n            setDigitsCheckComplete(true);\n            // Mark guesses as loaded so grid can show\n            setGuessesLoaded(true);\n          }\n        } else {\n          // For guest users, check localStorage\n          const storedStats = localStorage.getItem(\"elementle-stats\");\n          if (storedStats) {\n            const stats = JSON.parse(storedStats);\n            const completion = stats.puzzleCompletions?.[formattedAnswer];\n            \n            if (completion && mounted) {\n              setGameOver(true);\n              setIsWin(completion.won);\n              if (completion.guesses && Array.isArray(completion.guesses)) {\n                const feedbackArrays = completion.guesses.map((gr: GuessRecord) => gr.feedbackResult);\n                setGuesses(feedbackArrays);\n                setGuessRecords(completion.guesses);\n                // Set final guess count for completed puzzles (fixes bug where count shows 0 when returning from Archive)\n                setFinalGuessCount(feedbackArrays.length);\n              }\n              // Guest data is sync from localStorage - mark as loaded immediately\n              setGuessesLoaded(true);\n            }\n          }\n          // For guest users, always mark digits check complete and guesses loaded (no database to check)\n          if (mounted) {\n            setDigitsCheckComplete(true);\n            setGuessesLoaded(true);\n          }\n        }\n      }\n    };\n    \n    loadViewOnlyPuzzle();\n    \n    return () => { mounted = false; };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewOnly, formattedAnswer, isAuthenticated, gameAttempts, loadingAttempts, puzzleId, dateFormat, cacheMode]);\n\n  // Auto-open celebration modal when returning from stats for completed archive puzzles\n  useEffect(() => {\n    if (showCelebrationFirst && gameOver && hasOpenedCelebration && !showCelebrationModal) {\n      setShowCelebrationModal(true);\n    }\n  }, [showCelebrationFirst, gameOver, hasOpenedCelebration, showCelebrationModal]);\n\n  // Load in-progress guesses when resuming a puzzle\n  useEffect(() => {\n    let mounted = true;\n    \n    const loadInProgressGame = async () => {\n      console.log('[loadInProgressGame] Starting...', {\n        viewOnly,\n        gameOver,\n        loadingAttempts,\n        isAuthenticated,\n        puzzleId,\n        gameAttemptsLength: gameAttempts?.length\n      });\n      \n      if (!viewOnly && !gameOver && !loadingAttempts) {\n        if (isAuthenticated && gameAttempts && puzzleId) {\n          console.log('[loadInProgressGame] Looking for in-progress attempt for puzzleId:', puzzleId, 'type:', typeof puzzleId);\n          console.log('[loadInProgressGame] gameAttempts:', gameAttempts.map(a => ({ id: a.id, puzzleId: a.puzzleId, result: a.result, numGuesses: a.numGuesses })));\n          \n          // For authenticated users, load from database\n          const inProgressAttempt = gameAttempts.find(\n            attempt => attempt.puzzleId === puzzleId && attempt.result === null && (attempt.numGuesses ?? 0) > 0\n          );\n          \n          console.log('[loadInProgressGame] Found in-progress attempt:', inProgressAttempt);\n          \n          if (inProgressAttempt && mounted) {\n            console.log('[loadInProgressGame] Setting currentGameAttemptId to:', inProgressAttempt.id);\n            // Set the current attempt ID so future guesses save to the correct attempt\n            setCurrentGameAttemptId(inProgressAttempt.id);\n            \n            // Lock digit mode from the game attempt if it's set\n            if ((inProgressAttempt as any).digits) {\n              console.log('[loadInProgressGame] Locking digit mode to:', (inProgressAttempt as any).digits);\n              setLockedDigits((inProgressAttempt as any).digits);\n            }\n            setDigitsCheckComplete(true);\n            \n            // Try to load guesses from cache first for faster loading (using mode-aware cache)\n            console.log('[loadInProgressGame] Checking cache for puzzleId:', puzzleId, 'mode:', cacheMode);\n            const cachedGuesses = puzzleId ? getGuessesForPuzzle(puzzleId, cacheMode) : null;\n            let attemptGuesses = cachedGuesses;\n            \n            if (!cachedGuesses) {\n              // Cache miss - need to fetch from Supabase\n              console.log('[loadInProgressGame] Cache miss - fetching from API for attemptId:', inProgressAttempt.id);\n              setGuessesLoading(true);\n              try {\n                const allGuesses = await getAllGuesses();\n                console.log('[loadInProgressGame] Fetched all guesses:', allGuesses.length);\n                attemptGuesses = allGuesses.filter((g: any) => g.gameAttemptId === inProgressAttempt.id);\n                \n                // Always cache results (including empty arrays) to avoid refetching\n                if (puzzleId) {\n                  console.log('[loadInProgressGame] Caching', attemptGuesses?.length || 0, 'guesses for puzzle', puzzleId);\n                  setGuessesForPuzzle(puzzleId, cacheMode, attemptGuesses || []);\n                }\n              } finally {\n                if (mounted) {\n                  setGuessesLoading(false);\n                }\n              }\n            } else {\n              console.log('[loadInProgressGame] Cache hit - using', cachedGuesses.length, 'cached guesses');\n            }\n            \n            if (mounted && attemptGuesses && attemptGuesses.length > 0) {\n              console.log('[loadInProgressGame] Recalculating feedback for', attemptGuesses.length, 'guesses');\n              // Recalculate feedback for each guess (don't use stored feedbackResult)\n              const freshGuessRecords: GuessRecord[] = [];\n              const freshFeedbackArrays: CellFeedback[][] = [];\n              let newKeyStates = {};\n              \n              // Create format based on locked digit mode from attempt, not current user preference\n              const lockedDigits = (inProgressAttempt as any).digits || '6';\n              const baseFormat = dateFormat.startsWith('dd') ? 'dd' : 'mm';\n              const lockedFormat = lockedDigits === '8' \n                ? (baseFormat === 'dd' ? 'ddmmyyyy' : 'mmddyyyy')\n                : (baseFormat === 'dd' ? 'ddmmyy' : 'mmddyy');\n              \n              attemptGuesses.forEach((guess: any) => {\n                // Convert canonical format (YYYY-MM-DD) to display format using LOCKED digit mode\n                const displayFormat = formatCanonicalDateUtil(guess.guessValue, lockedFormat as any);\n                const feedback = calculateFeedbackForGuess(displayFormat, newKeyStates);\n                freshFeedbackArrays.push(feedback);\n                freshGuessRecords.push({\n                  guessValue: displayFormat,\n                  feedbackResult: feedback\n                });\n                newKeyStates = updateKeyStates(displayFormat, feedback, newKeyStates);\n              });\n              \n              console.log('[loadInProgressGame] Setting state with', freshFeedbackArrays.length, 'guesses');\n              setGuesses(freshFeedbackArrays);\n              setGuessRecords(freshGuessRecords);\n              setKeyStates(newKeyStates);\n              setWrongGuessCount(freshFeedbackArrays.length - freshFeedbackArrays.filter(fb => fb.every(cell => cell.state === 'correct')).length);\n              console.log('[loadInProgressGame] State updated successfully');\n              // Mark guesses as loaded to trigger the 0.6s delay\n              setGuessesLoaded(true);\n            } else if (mounted) {\n              console.log('[loadInProgressGame] No guesses to load or component unmounted');\n              // No guesses found but attempt exists - mark as loaded\n              setGuessesLoaded(true);\n            }\n          } else if (mounted) {\n            // No in-progress attempt found for authenticated users\n            setDigitsCheckComplete(true);\n            // Mark guesses as loaded so grid can show for new games\n            setGuessesLoaded(true);\n          }\n        } else if (!isAuthenticated) {\n          // For guest users, load from localStorage\n          const inProgressKey = `puzzle-progress-${formattedAnswer}`;\n          const savedProgress = localStorage.getItem(inProgressKey);\n          \n          if (savedProgress && mounted) {\n            const progress = JSON.parse(savedProgress);\n            if (progress.guessRecords && Array.isArray(progress.guessRecords)) {\n              const feedbackArrays = progress.guessRecords.map((gr: GuessRecord) => gr.feedbackResult);\n              setGuesses(feedbackArrays);\n              setGuessRecords(progress.guessRecords);\n              setWrongGuessCount(progress.wrongGuessCount || 0);\n              \n              // Restore key states\n              if (progress.keyStates) {\n                setKeyStates(progress.keyStates);\n              }\n              // Guest data is sync from localStorage - mark as loaded immediately\n              setGuessesLoaded(true);\n            }\n          }\n          // For guest users, always mark digits check complete and guesses loaded (no database to check)\n          if (mounted) {\n            setDigitsCheckComplete(true);\n            setGuessesLoaded(true);\n          }\n        }\n      }\n    };\n    \n    loadInProgressGame();\n    \n    return () => { mounted = false; };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewOnly, formattedAnswer, isAuthenticated, gameAttempts, loadingAttempts, puzzleId, dateFormat, cacheMode]);\n\n  // Check if we should show the intro screen (new game with no guesses)\n  // IntroScreen handles its own loading state internally, so we just set showIntroScreen to true\n  useEffect(() => {\n    // Only proceed if all conditions are met and we haven't decided yet\n    if (!viewOnly && !gameOver && guessRecords.length === 0 && digitsCheckComplete && !introScreenChecked.current) {\n      // Mark as checked so we don't re-run this logic\n      introScreenChecked.current = true;\n      \n      // Skip intro if parent tells us there's existing progress or skipIntro is true\n      if (hasExistingProgress || skipIntro) {\n        return;\n      }\n      \n      // Show the intro screen - it handles its own loading spinner internally\n      setShowIntroScreen(true);\n    }\n  }, [guessRecords.length, digitsCheckComplete, gameOver, viewOnly, hasExistingProgress, skipIntro]);\n\n  // Helper function to format date for intro display\n  const formatDateForIntro = (dateCanonical: string): string => {\n    // dateCanonical is in YYYY-MM-DD format\n    const [year, month, day] = dateCanonical.split('-');\n    const date = new Date(dateCanonical + 'T00:00:00Z'); // Add time to avoid timezone issues\n    \n    const dayNum = parseInt(day, 10);\n    const monthNum = parseInt(month, 10);\n    \n    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',\n      'July', 'August', 'September', 'October', 'November', 'December'];\n    const monthName = monthNames[monthNum - 1];\n    \n    const getOrdinal = (n: number) => {\n      if (n > 3 && n < 21) return 'th';\n      switch (n % 10) {\n        case 1: return 'st';\n        case 2: return 'nd';\n        case 3: return 'rd';\n        default: return 'th';\n      }\n    };\n    \n    // Format based on user's date preference\n    if (dateFormat.startsWith('dd')) {\n      // DD/MM/YY -> \"25th November 2025\"\n      return `${dayNum}${getOrdinal(dayNum)} ${monthName} ${year}`;\n    } else {\n      // MM/DD/YY -> \"November 25, 2025\"\n      return `${monthName} ${dayNum}, ${year}`;\n    }\n  };\n  \n  // Helper function to calculate feedback without updating state\n  const calculateFeedbackForGuess = (guess: string, currentKeyStates: Record<string, KeyState>, targetAnswer?: string): CellFeedback[] => {\n    const feedback: CellFeedback[] = [];\n    const answer = targetAnswer || activeFormattedAnswer;\n    const numDigits = guess.length; // Use guess length instead of activeNumDigits\n    \n    for (let i = 0; i < numDigits; i++) {\n      const guessDigit = guess[i];\n      const targetDigit = answer[i];\n      \n      if (guessDigit === targetDigit) {\n        feedback.push({ digit: guessDigit, state: \"correct\" });\n      } else if (answer.includes(guessDigit)) {\n        const arrow = parseInt(guessDigit) < parseInt(targetDigit) ? \"up\" : \"down\";\n        feedback.push({ digit: guessDigit, state: \"inSequence\", arrow });\n      } else {\n        const arrow = parseInt(guessDigit) < parseInt(targetDigit) ? \"up\" : \"down\";\n        feedback.push({ digit: guessDigit, state: \"notInSequence\", arrow });\n      }\n    }\n    \n    return feedback;\n  };\n  \n  // Helper function to update key states without modifying state\n  const updateKeyStates = (guess: string, feedback: CellFeedback[], currentKeyStates: Record<string, KeyState>): Record<string, KeyState> => {\n    const newKeyStates = { ...currentKeyStates };\n    const numDigits = guess.length; // Use guess length instead of activeNumDigits\n    \n    for (let i = 0; i < numDigits; i++) {\n      const guessDigit = guess[i];\n      const cellFeedback = feedback[i];\n      \n      if (cellFeedback.state === \"correct\") {\n        newKeyStates[guessDigit] = \"correct\";\n      } else if (cellFeedback.state === \"inSequence\") {\n        if (newKeyStates[guessDigit] !== \"correct\") {\n          newKeyStates[guessDigit] = \"inSequence\";\n        }\n      } else if (cellFeedback.state === \"notInSequence\") {\n        newKeyStates[guessDigit] = \"ruledOut\";\n      }\n    }\n    \n    return newKeyStates;\n  };\n\n  const calculateFeedback = (guess: string): CellFeedback[] => {\n    const feedback: CellFeedback[] = [];\n    const newKeyStates = { ...keyStates };\n\n    for (let i = 0; i < activeNumDigits; i++) {\n      const guessDigit = guess[i];\n      const targetDigit = activeFormattedAnswer[i];\n      \n      if (guessDigit === targetDigit) {\n        feedback.push({ digit: guessDigit, state: \"correct\" });\n        newKeyStates[guessDigit] = \"correct\";\n      } else if (activeFormattedAnswer.includes(guessDigit)) {\n        const arrow = parseInt(guessDigit) < parseInt(targetDigit) ? \"up\" : \"down\";\n        feedback.push({ digit: guessDigit, state: \"inSequence\", arrow });\n        if (newKeyStates[guessDigit] !== \"correct\") {\n          newKeyStates[guessDigit] = \"inSequence\";\n        }\n      } else {\n        const arrow = parseInt(guessDigit) < parseInt(targetDigit) ? \"up\" : \"down\";\n        feedback.push({ digit: guessDigit, state: \"notInSequence\", arrow });\n        newKeyStates[guessDigit] = \"ruledOut\";\n      }\n    }\n\n    setKeyStates(newKeyStates);\n    return feedback;\n  };\n\n  useEffect(() => {\n    const storedClues = localStorage.getItem(\"cluesEnabled\");\n    if (storedClues !== null) setCluesEnabled(storedClues === \"true\");\n  }, []);\n\n  const handleSubmit = useCallback(async () => {\n    if (currentInput.length !== activeNumDigits || gameOver) return;\n\n    const feedback = calculateFeedback(currentInput);\n    const newGuesses = [...guesses, feedback];\n    const newGuessRecords = [...guessRecords, { guessValue: currentInput, feedbackResult: feedback }];\n    const newWrongGuessCount = currentInput !== activeFormattedAnswer ? wrongGuessCount + 1 : wrongGuessCount;\n    \n    // Convert user input to canonical format for database storage\n    const canonicalGuess = parseUserDateWithContext(currentInput, dateFormat, answerDateCanonical);\n    \n    // For local state, keep the user-formatted version\n    const currentGuess = { guessValue: currentInput, feedbackResult: feedback };\n    // For database storage, use canonical format\n    const dbGuess = { guessValue: canonicalGuess || currentInput, feedbackResult: feedback };\n    \n    setGuesses(newGuesses);\n    setGuessRecords(newGuessRecords);\n    setCurrentInput(\"\");\n\n    // For guest users: update archive progress immediately\n    if (!isAuthenticated) {\n      const storedStats = localStorage.getItem(\"elementle-stats\");\n      const stats = storedStats ? JSON.parse(storedStats) : { puzzleCompletions: {} };\n\n      const completion = stats.puzzleCompletions[formattedAnswer] || {\n        completed: false,\n        won: false,\n        guessCount: 0,\n        guesses: []\n      };\n\n      completion.guessCount = newGuesses.length;\n      completion.guesses = newGuessRecords;\n      completion.completed = false; // still in progress\n      completion.won = false;\n\n      stats.puzzleCompletions[formattedAnswer] = completion;\n      localStorage.setItem(\"elementle-stats\", JSON.stringify(stats));\n    }\n    \n    // For authenticated users: progressive database saving\n    // Use ref to get latest puzzleId (handles race conditions where prop isn't set yet)\n    let attemptId: number | null = null;\n    const currentPuzzleId = puzzleIdRef.current;\n    \n    if (isAuthenticated) {\n      if (!currentPuzzleId) {\n        console.warn('[handleSubmit] puzzleId is undefined for authenticated user - will retry in createOrGetGameAttempt');\n      }\n      \n      // Create or get game attempt on first guess (includes retry logic for missing puzzleId)\n      attemptId = await createOrGetGameAttempt();\n      \n      // Save this guess to database (using canonical format)\n      if (attemptId) {\n        await saveGuessToDatabase(attemptId, dbGuess);\n      } else {\n        console.error('[handleSubmit] CRITICAL: Could not create/get game attempt. Guess NOT saved to database!', {\n          puzzleId: currentPuzzleId,\n          isLocalMode,\n          guessValue: dbGuess.guessValue\n        });\n      }\n    }\n\n    const isWinningGuess = currentInput === activeFormattedAnswer;\n    const isLosingGuess = !isWinningGuess && newGuesses.length >= maxGuesses;\n\n    if (isWinningGuess) {\n      // Game won\n      setIsWin(true);\n      setGameOver(true);\n      setFinalGuessCount(newGuesses.length); // Store final count to prevent race condition issues\n      localStorage.removeItem(`puzzle-progress-${formattedAnswer}`);\n      \n      // Start 2.5s timer immediately - modal will show when BOTH timer elapses AND ready\n      setTimeout(() => {\n        setEndModalDelayElapsed(true);\n      }, 2500);\n      \n      // Track if we're showing a streak celebration (to delay EndGameModal)\n      let hasStreakCelebration = false;\n      \n      // === FAST PATH: Check for streak celebration quickly ===\n      // For authenticated users playing today's puzzle, we need to check streak\n      // But we do this as quickly as possible before any slow API calls\n      if (isAuthenticated && attemptId && isPlayingTodaysPuzzle()) {\n        // Complete game attempt first (required for streak calculation)\n        await completeGameAttempt(attemptId, true, newGuesses.length);\n        \n        // Fetch stats to check for streak celebration\n        const statsEndpoint = isLocalMode ? \"/api/user/stats\" : \"/api/stats\";\n        const statsRes = await apiRequest(\"GET\", statsEndpoint);\n        if (statsRes.ok) {\n          const freshStats = await statsRes.json();\n          console.log('[Win] Fresh stats loaded for streak celebration:', freshStats);\n          if (freshStats.currentStreak) {\n            setCurrentStreak(freshStats.currentStreak);\n            setShowStreakCelebration(true);\n            hasStreakCelebration = true;\n            // Mark that EndGameModal should show after streak celebration is dismissed\n            setPendingEndModal(true);\n            // Mark that badge check should run after streak celebration\n            setPendingBadgeCheck(true);\n          } else {\n            // No streak celebration - set modal ready immediately, run badge check in background\n            setEndModalReady(true);\n            // Check badges in background (don't await)\n            const gameType = isLocalMode ? 'USER' : 'REGION';\n            checkAllBadgesOnGameComplete(true, newGuesses.length, freshStats.currentStreak || 0, gameType)\n              .then(badge => { if (badge) setEarnedBadge(badge); });\n          }\n        } else {\n          // Stats fetch failed - still show modal\n          setEndModalReady(true);\n        }\n      } else if (isAuthenticated && attemptId && !isPlayingTodaysPuzzle()) {\n        // Not playing today's puzzle - no streak celebration, set modal ready immediately\n        setEndModalReady(true);\n        // Complete game attempt in background\n        completeGameAttempt(attemptId, true, newGuesses.length);\n        // Check badges in background\n        const gameType = isLocalMode ? 'USER' : 'REGION';\n        const statsEndpoint = isLocalMode ? \"/api/user/stats\" : \"/api/stats\";\n        apiRequest(\"GET\", statsEndpoint).then(async statsRes => {\n          const freshStats = statsRes.ok ? await statsRes.json() : { currentStreak: 0 };\n          const badge = await checkAllBadgesOnGameComplete(true, newGuesses.length, freshStats.currentStreak || 0, gameType);\n          if (badge) setEarnedBadge(badge);\n        });\n      } else if (isAuthenticated && !attemptId) {\n        // CRITICAL: Authenticated user won but we couldn't save to database!\n        console.error('[handleSubmit] CRITICAL: Game WON but could not save to database!', {\n          puzzleId: puzzleIdRef.current,\n          numGuesses: newGuesses.length,\n          isLocalMode\n        });\n        // Still show modal even though DB save failed\n        setEndModalReady(true);\n      } else if (!isAuthenticated) {\n        // Guest user: use localStorage stats\n        await updateStats(true, newGuesses.length, newGuessRecords);\n        \n        // Show streak celebration only when playing today's puzzle (regardless of access method)\n        if (isPlayingTodaysPuzzle()) {\n          const stats = JSON.parse(localStorage.getItem(\"elementle-stats\") || \"{}\");\n          if (stats.currentStreak) {\n            setCurrentStreak(stats.currentStreak);\n            setShowStreakCelebration(true);\n            hasStreakCelebration = true;\n            // Mark that EndGameModal should show after streak celebration is dismissed\n            setPendingEndModal(true);\n          } else {\n            setEndModalReady(true);\n          }\n        } else {\n          setEndModalReady(true);\n        }\n      } else {\n        // Fallback - always show modal\n        setEndModalReady(true);\n      }\n      \n      // Cache today's outcome (only if playing today's puzzle)\n      if (isPlayingTodaysPuzzle()) {\n        writeLocal(CACHE_KEYS.TODAY_OUTCOME, {\n          date: answerDateCanonical,\n          puzzleId: puzzleId,\n          isWin: true,\n          guessCount: newGuesses.length,\n        });\n      }\n      \n      // Handle streak saver completion - mark as used only after puzzle played to conclusion\n      if (isInStreakSaverMode && streakSaverSession && isAuthenticated) {\n        const gameType = streakSaverSession.gameType;\n        console.log('[Win] Completing streak saver session:', { gameType, won: true });\n        try {\n          // Mark streak saver as used in database\n          await useStreakSaverMutation(gameType);\n          // Refetch streak status to update UI\n          await refetchStreakStatus();\n          // Complete the session context\n          completeStreakSaverSession(true);\n          console.log('[Win] Streak saver used successfully - streak extended by 1 day');\n        } catch (error) {\n          console.error('[Win] Failed to use streak saver:', error);\n          // Still complete the session to clear the mode\n          completeStreakSaverSession(true);\n        }\n      }\n    } else if (isLosingGuess) {\n      // Game lost\n      setIsWin(false);\n      setGameOver(true);\n      setFinalGuessCount(newGuesses.length); // Store final count to prevent race condition issues\n      localStorage.removeItem(`puzzle-progress-${formattedAnswer}`);\n      \n      // Start 2.5s timer immediately - modal will show when BOTH timer elapses AND ready\n      setTimeout(() => {\n        setEndModalDelayElapsed(true);\n      }, 2500);\n      \n      // Mark modal as ready immediately (losses don't have streak celebrations)\n      setEndModalReady(true);\n      \n      if (isAuthenticated && attemptId) {\n        // Complete game attempt and recalculate stats from database (use attemptId, not state)\n        await completeGameAttempt(attemptId, false, newGuesses.length);\n      } else if (isAuthenticated && !attemptId) {\n        // CRITICAL: Authenticated user lost but we couldn't save to database!\n        console.error('[handleSubmit] CRITICAL: Game LOST but could not save to database!', {\n          puzzleId: puzzleIdRef.current,\n          numGuesses: newGuesses.length,\n          isLocalMode\n        });\n      } else if (!isAuthenticated) {\n        // Guest user: use localStorage stats\n        await updateStats(false, newGuesses.length, newGuessRecords);\n      }\n      \n      // Cache today's outcome (only if playing today's puzzle)\n      if (isPlayingTodaysPuzzle()) {\n        writeLocal(CACHE_KEYS.TODAY_OUTCOME, {\n          date: answerDateCanonical,\n          puzzleId: puzzleId,\n          isWin: false,\n          guessCount: newGuesses.length,\n        });\n      }\n      \n      // Handle streak saver completion - mark as used only after puzzle played to conclusion\n      // On loss: still uses streak saver, but streak resets to 0\n      if (isInStreakSaverMode && streakSaverSession && isAuthenticated) {\n        const gameType = streakSaverSession.gameType;\n        console.log('[Lose] Completing streak saver session:', { gameType, won: false });\n        try {\n          // Mark streak saver as used in database\n          await useStreakSaverMutation(gameType);\n          // Refetch streak status to update UI\n          await refetchStreakStatus();\n          // Complete the session context (with false to indicate loss)\n          completeStreakSaverSession(false);\n          console.log('[Lose] Streak saver used - streak reset to 0 due to loss');\n        } catch (error) {\n          console.error('[Lose] Failed to use streak saver:', error);\n          // Still complete the session to clear the mode\n          completeStreakSaverSession(false);\n        }\n      }\n    } else {\n      // Game in progress - save current state to localStorage\n      setWrongGuessCount(newWrongGuessCount);\n      const inProgressKey = `puzzle-progress-${formattedAnswer}`;\n      const newKeyStates = { ...keyStates };\n      \n      // Update key states from the feedback we just calculated\n      for (let i = 0; i < activeNumDigits; i++) {\n        const digit = currentInput[i];\n        const state = feedback[i].state;\n        if (state === \"correct\") {\n          newKeyStates[digit] = \"correct\";\n        } else if (state === \"inSequence\" && newKeyStates[digit] !== \"correct\") {\n          newKeyStates[digit] = \"inSequence\";\n        } else if (state === \"notInSequence\") {\n          newKeyStates[digit] = \"ruledOut\";\n        }\n      }\n      \n      localStorage.setItem(inProgressKey, JSON.stringify({\n        guessRecords: newGuessRecords,\n        wrongGuessCount: newWrongGuessCount,\n        keyStates: newKeyStates\n      }));\n    }\n  }, [currentInput, gameOver, guesses, guessRecords, formattedAnswer, maxGuesses, keyStates, wrongGuessCount, isAuthenticated, puzzleId, currentGameAttemptId, activeNumDigits, isInStreakSaverMode, streakSaverSession, useStreakSaverMutation, refetchStreakStatus, completeStreakSaverSession]);\n\n  const handleKeyPress = useCallback((e: KeyboardEvent) => {\n    if (gameOver || viewOnly) return;\n\n    if (e.key >= \"0\" && e.key <= \"9\") {\n      if (currentInput.length < activeNumDigits) {\n        setCurrentInput(currentInput + e.key);\n      }\n    } else if (e.key === \"Backspace\" || e.key === \"Delete\") {\n      setCurrentInput(currentInput.slice(0, -1));\n    } else if (e.key === \"Enter\") {\n      handleSubmit();\n    } else if (e.key === \"Escape\") {\n      setCurrentInput(\"\");\n    }\n  }, [currentInput, gameOver, handleSubmit, activeNumDigits]);\n\n  useEffect(() => {\n    window.addEventListener(\"keydown\", handleKeyPress);\n    return () => window.removeEventListener(\"keydown\", handleKeyPress);\n  }, [handleKeyPress]);\n\n  const createOrGetGameAttempt = async (retryCount = 0): Promise<number | null> => {\n    // Use ref to get the LATEST puzzleId (prevents stale closure issues)\n    const currentPuzzleId = puzzleIdRef.current;\n    \n    if (!isAuthenticated) {\n      console.log('[createOrGetGameAttempt] Not authenticated, skipping database save');\n      return null;\n    }\n    \n    if (!currentPuzzleId) {\n      console.warn('[createOrGetGameAttempt] CRITICAL: puzzleId is undefined for authenticated user!', {\n        puzzleIdFromRef: puzzleIdRef.current,\n        puzzleIdFromProps: puzzleId,\n        isLocalMode,\n        retryCount\n      });\n      \n      // Retry up to 3 times with exponential backoff if puzzleId is missing\n      // This handles race conditions where puzzle data hasn't loaded yet\n      if (retryCount < 3) {\n        const delay = Math.pow(2, retryCount) * 500; // 500ms, 1s, 2s\n        console.log(`[createOrGetGameAttempt] Retrying in ${delay}ms (attempt ${retryCount + 1}/3)`);\n        await new Promise(resolve => setTimeout(resolve, delay));\n        return createOrGetGameAttempt(retryCount + 1);\n      }\n      \n      console.error('[createOrGetGameAttempt] FAILED: puzzleId still undefined after 3 retries. Game data will NOT be saved!');\n      return null;\n    }\n\n    // If we already have one in state, reuse it\n    if (currentGameAttemptId) {\n      console.log('[createOrGetGameAttempt] Reusing existing attemptId from state:', currentGameAttemptId);\n      return currentGameAttemptId;\n    }\n\n    try {\n      console.log('[createOrGetGameAttempt] POSTing to find or create attempt for puzzleId:', currentPuzzleId);\n      \n      // POST to mode-aware endpoint - server will find existing open attempt or create new one\n      const endpoint = isLocalMode ? \"/api/user/game-attempts\" : \"/api/game-attempts\";\n      const res = await apiRequest(\"POST\", endpoint, {\n        puzzleId: currentPuzzleId,\n        result: null,\n        numGuesses: 0\n      });\n      \n      const gameAttempt = await res.json();\n      console.log('[createOrGetGameAttempt] Got attemptId:', gameAttempt.id, 'numGuesses:', gameAttempt.numGuesses);\n      \n      setCurrentGameAttemptId(gameAttempt.id);\n      return gameAttempt.id;\n    } catch (error) {\n      console.error(\"[createOrGetGameAttempt] Error:\", error);\n      \n      // Retry on network/server errors (up to 2 additional attempts)\n      if (retryCount < 2) {\n        const delay = Math.pow(2, retryCount) * 1000; // 1s, 2s\n        console.log(`[createOrGetGameAttempt] Network error, retrying in ${delay}ms (attempt ${retryCount + 1}/2)`);\n        await new Promise(resolve => setTimeout(resolve, delay));\n        return createOrGetGameAttempt(retryCount + 1);\n      }\n      \n      console.error('[createOrGetGameAttempt] FAILED after retries. Game data may not be saved!');\n      return null;\n    }\n  };\n\n  const saveGuessToDatabase = async (gameAttemptId: number, guess: GuessRecord, retryCount = 0): Promise<boolean> => {\n    if (!isAuthenticated) return false;\n\n    try {\n      console.log('[saveGuessToDatabase] Saving guess:', {\n        gameAttemptId,\n        guessValue: guess.guessValue,\n        feedbackLength: guess.feedbackResult.length,\n        retryCount\n      });\n      \n      const endpoint = isLocalMode ? \"/api/user/guesses\" : \"/api/guesses\";\n      const res = await apiRequest(\"POST\", endpoint, {\n        gameAttemptId,\n        guessValue: guess.guessValue,\n        feedbackResult: guess.feedbackResult\n      });\n      \n      const savedGuess = await res.json();\n      console.log('[saveGuessToDatabase] Guess saved successfully:', savedGuess.id);\n      return true;\n    } catch (error) {\n      console.error(\"[saveGuessToDatabase] Error:\", error);\n      \n      // Retry on network/server errors (up to 2 additional attempts)\n      if (retryCount < 2) {\n        const delay = Math.pow(2, retryCount) * 500; // 500ms, 1s\n        console.log(`[saveGuessToDatabase] Retrying in ${delay}ms (attempt ${retryCount + 1}/2)`);\n        await new Promise(resolve => setTimeout(resolve, delay));\n        return saveGuessToDatabase(gameAttemptId, guess, retryCount + 1);\n      }\n      \n      // Queue for later retry if all attempts fail\n      console.error('[saveGuessToDatabase] FAILED after retries. Queuing for later retry.');\n      pendingGuessesRef.current.push({ attemptId: gameAttemptId, guess });\n      return false;\n    }\n  };\n\n  const completeGameAttempt = async (gameAttemptId: number, won: boolean, numGuesses: number) => {\n    if (!isAuthenticated) return;\n\n    try {\n      // Determine if this is a streak saver play (accessed via streak saver popup, not archive)\n      const isStreakSaverPlay = isInStreakSaverMode && !!streakSaverSession;\n      \n      console.log('[completeGameAttempt] Completing attempt:', {\n        gameAttemptId,\n        won,\n        numGuesses,\n        isStreakSaverPlay\n      });\n      \n      // Update the game attempt with result and completion time\n      // Pass isStreakSaverPlay to server so it knows whether to update streak_day_status\n      const patchEndpoint = isLocalMode ? `/api/user/game-attempts/${gameAttemptId}` : `/api/game-attempts/${gameAttemptId}`;\n      const patchRes = await apiRequest(\"PATCH\", patchEndpoint, {\n        result: won ? \"won\" : \"lost\",\n        numGuesses,\n        isStreakSaverPlay\n      });\n      \n      if (!patchRes.ok) {\n        console.error('[completeGameAttempt] Failed to PATCH attempt:', patchRes.status);\n        return;\n      }\n      \n      const updatedAttempt = await patchRes.json();\n      console.log('[completeGameAttempt] Attempt updated:', updatedAttempt);\n\n      // Recalculate stats from database\n      console.log('[completeGameAttempt] Recalculating stats...');\n      const recalcEndpoint = isLocalMode ? \"/api/user/stats/recalculate\" : \"/api/stats/recalculate\";\n      const recalcRes = await apiRequest(\"POST\", recalcEndpoint);\n      \n      if (!recalcRes.ok) {\n        console.error('[completeGameAttempt] Failed to recalculate stats:', recalcRes.status);\n      } else {\n        const recalcStats = await recalcRes.json();\n        console.log('[completeGameAttempt] Stats recalculated:', recalcStats);\n      }\n\n      // Invalidate caches to refetch fresh data\n      const { queryClient } = await import(\"@/lib/queryClient\");\n      const statsQueryKey = isLocalMode ? ['/api/user/stats'] : ['/api/stats'];\n      const attemptsQueryKey = isLocalMode ? ['/api/user/game-attempts/user'] : ['/api/game-attempts/user'];\n      await queryClient.invalidateQueries({ queryKey: statsQueryKey });\n      await queryClient.invalidateQueries({ queryKey: attemptsQueryKey });\n      \n      // Pre-load percentile and stats for instant rendering\n      try {\n        console.log('[completeGameAttempt] Pre-loading percentile and stats...');\n        \n        // Fetch and cache percentile\n        const percentileEndpoint = isLocalMode ? \"/api/user/stats/percentile\" : \"/api/stats/percentile\";\n        const percentileRes = await apiRequest(\"GET\", percentileEndpoint);\n        if (percentileRes.ok) {\n          const percentileData = await percentileRes.json();\n          writeLocal(CACHE_KEYS.PERCENTILE, percentileData);\n          console.log('[completeGameAttempt] Percentile cached:', percentileData);\n        }\n        \n        // Fetch and cache stats\n        const statsEndpoint = isLocalMode ? \"/api/user/stats\" : \"/api/stats\";\n        const statsRes = await apiRequest(\"GET\", statsEndpoint);\n        if (statsRes.ok) {\n          const statsData = await statsRes.json();\n          writeLocal(CACHE_KEYS.STATS, statsData);\n          console.log('[completeGameAttempt] Stats cached:', statsData);\n        }\n      } catch (error) {\n        console.error(\"[completeGameAttempt] Error pre-loading data:\", error);\n      }\n    } catch (error) {\n      console.error(\"[completeGameAttempt] Error:\", error);\n    }\n  };\n\n  const updateStats = async (won: boolean, numGuesses: number, allGuessRecords: GuessRecord[]) => {\n    // For authenticated users, stats are now calculated from database\n    // This function only handles localStorage for guest users\n    if (isAuthenticated) {\n      // Authenticated users: database handles everything via recalculate\n      return;\n    }\n\n    console.log('[updateStats] Updating guest stats:', { won, numGuesses });\n\n    // Guest users: use old localStorage increment logic\n    const storedStats = localStorage.getItem(\"elementle-stats\");\n    const currentStats = storedStats ? JSON.parse(storedStats) : {\n      played: 0,\n      won: 0,\n      currentStreak: 0,\n      maxStreak: 0,\n      guessDistribution: { \"1\": 0, \"2\": 0, \"3\": 0, \"4\": 0, \"5\": 0 },\n      puzzleCompletions: {}\n    };\n\n    // Ensure guessDistribution is always initialized with string keys\n    if (!currentStats.guessDistribution || typeof currentStats.guessDistribution !== 'object') {\n      currentStats.guessDistribution = { \"1\": 0, \"2\": 0, \"3\": 0, \"4\": 0, \"5\": 0 };\n    }\n\n    if (!currentStats.puzzleCompletions) {\n      currentStats.puzzleCompletions = {};\n    }\n\n    // Use formattedAnswer as the key (formatted date) to match user's format\n    currentStats.puzzleCompletions[formattedAnswer] = {\n      completed: true,\n      won,\n      guessCount: numGuesses,\n      guesses: allGuessRecords,\n      puzzleTargetDate: answerDateCanonical,\n      date: new Date().toISOString()\n    };\n\n    currentStats.played += 1;\n    if (won) {\n      currentStats.won += 1;\n      currentStats.currentStreak += 1;\n      currentStats.maxStreak = Math.max(currentStats.maxStreak, currentStats.currentStreak);\n      \n      // Use string key for guessDistribution (convert numGuesses to string)\n      const guessKey = numGuesses.toString();\n      if (numGuesses >= 1 && numGuesses <= 5) {\n        currentStats.guessDistribution[guessKey] = (currentStats.guessDistribution[guessKey] || 0) + 1;\n      }\n      \n      console.log('[updateStats] Updated distribution:', currentStats.guessDistribution);\n    } else {\n      currentStats.currentStreak = 0;\n    }\n\n    // Save to localStorage for guest users\n    localStorage.setItem(\"elementle-stats\", JSON.stringify(currentStats));\n    console.log('[updateStats] Stats saved to localStorage');\n  };\n\n  const handlePlayAgain = () => {\n    setCurrentInput(\"\");\n    setGuesses([]);\n    setKeyStates({});\n    setGameOver(false);\n    setIsWin(false);\n    setWrongGuessCount(0);\n    setFinalGuessCount(null);\n  };\n\n  // Show loading state until date format and digit mode are ready\n  // This prevents the grid from rendering in the wrong format and then flipping\n  // The spinner overlay is managed by the gameLoadingSpinner effect above\n  if (formatLoading || !digitsCheckComplete) {\n    return (\n      <div className=\"h-dvh\" data-testid=\"game-loading\" />\n    );\n  }\n\n\n  // Calculate puzzle date for intro screen\n  const today = new Date();\n  const puzzleDateToShow = puzzleDate || `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;\n\n  // Calculate streak info for intro screen\n  const todayDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;\n  const isPlayingToday = puzzleDateToShow === todayDate;\n  \n  // Check if there's an existing attempt for this puzzle\n  const hasExistingAttempt = isAuthenticated && gameAttempts && puzzleId \n    ? gameAttempts.some(attempt => attempt.puzzleId === puzzleId && attempt.result !== null)\n    : false;\n  \n  // Get current streak from Supabase stats if authenticated, otherwise from localStorage\n  let currentStreakValue = 0;\n  if (isAuthenticated && supabaseStats) {\n    currentStreakValue = supabaseStats.currentStreak || 0;\n  } else {\n    const guestStats = localStorage.getItem(\"elementle-stats\");\n    if (guestStats) {\n      try {\n        const stats = JSON.parse(guestStats);\n        currentStreakValue = stats.currentStreak || 0;\n      } catch (e) {}\n    }\n  }\n  \n  // This is a streak game if: playing today, no existing attempt, and has a streak to continue\n  const isStreakGame = isPlayingToday && !hasExistingAttempt && currentStreakValue > 0;\n\n  return (\n    <>\n      {/* IntroScreen overlay - handles its own loading state internally */}\n      <AnimatePresence>\n        {showIntroScreen && (\n          <IntroScreen\n            puzzleDateCanonical={puzzleDateToShow}\n            eventTitle={eventTitle}\n            hasCluesEnabled={cluesEnabled}\n            isLocalMode={isLocalMode}\n            categoryName={category}\n            locationName={undefined}\n            onPlayClick={() => setShowIntroScreen(false)}\n            onBack={handleBackButtonPress}\n            onExitStart={() => setIntroExitingViaBack(true)}\n            formatDateForDisplay={formatDateForIntro}\n            currentStreak={currentStreakValue}\n            isStreakGame={isStreakGame}\n            isStreakSaverGame={isInStreakSaverMode && !!streakSaverSession}\n          />\n        )}\n      </AnimatePresence>\n      \n      {/* Main game content - fades out when IntroScreen is exiting via back button */}\n      {/* When introExitingViaBack is true, content fades out so IntroScreen animates over solid background */}\n      <div \n        className=\"fixed inset-0 flex flex-col overflow-hidden touch-none\"\n        style={{ \n          backgroundColor: pageBackgroundColor,\n          opacity: introExitingViaBack ? 0 : 1,\n          transition: 'opacity 150ms ease-out',\n          pointerEvents: introExitingViaBack ? 'none' : 'auto'\n        }}\n      >\n      {/* Fixed Header */}\n      <div className=\"shrink-0 flex items-center justify-between px-4 pt-4\">\n        <button\n          onClick={handleBackButtonPress}\n          data-testid=\"button-back\"\n          className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n        >\n          <ChevronLeft className=\"h-10 w-10 text-gray-700 dark:text-gray-200\" />\n        </button>\n\n        <h2 className=\"text-4xl font-bold text-foreground\">\n          {viewOnly ? \"View Puzzle\" : \"Elementle\"}\n        </h2>\n\n        <button\n          onClick={() => setShowHelp(true)}\n          data-testid=\"button-help\"\n          className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n        >\n          {/* Light mode icon */}\n          <img\n            src={greyHelpIcon}\n            alt=\"Help\"\n            className=\"h-9 w-9 block dark:hidden\"\n          />\n          {/* Dark mode icon */}\n          <img\n            src={whiteHelpIcon}\n            alt=\"Help\"\n            className=\"h-9 w-9 hidden dark:block\"\n          />\n        </button>\n\n      </div>\n\n      {/* Middle Content - fills remaining space */}\n      <div className=\"flex-1 min-h-0 flex flex-col justify-center items-center px-4 overflow-hidden\">\n        <div className=\"w-full max-w-md space-y-0.5 sm:space-y-1\">\n          {cluesEnabled && (\n            <div className=\"text-center mb-3\">\n              {isLocalMode && (\n                <div\n                  className=\"text-sm font-medium text-muted-foreground mb-1 tracking-wide\"\n                  data-testid=\"text-category\"\n                >\n                  {guessRecords[0]?.categoryName || category || \"\"}\n                </div>\n              )}\n\n              <h3\n                className=\"text-xl font-semibold text-foreground\"\n                data-testid=\"text-event-title\"\n              >\n                {eventTitle}\n              </h3>\n            </div>\n          )}\n\n          <InputGrid\n            guesses={gridDataReady ? guesses : []}\n            currentInput={gridDataReady ? currentInput : \"\"}\n            maxGuesses={maxGuesses}\n            placeholders={activePlaceholders}\n          />\n          \n          {gameOver && !isWin && (\n            <div className=\"w-full mt-6 sm:mt-12\">\n              <p className=\"text-center text-sm text-muted-foreground mb-2 sm:mb-3\">Correct answer:</p>\n              <div className=\"flex gap-2 justify-center\">\n                {activeFormattedAnswer.split('').map((digit, i) => (\n                  <div\n                    key={i}\n                    className=\"flex-1 basis-0 shrink min-h-[40px] sm:min-h-[56px] md:min-h-[64px]\"\n                    data-testid={`answer-container-${i}`}\n                  >\n                    <div\n                      className=\"w-full h-full flex items-center justify-center bg-game-correct text-white border-2 border-game-correct text-2xl sm:text-3xl md:text-4xl font-semibold rounded-md\"\n                      data-testid={`answer-digit-${i}`}\n                    >\n                      {digit}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Fixed Bottom - Numpad or Continue button */}\n      <div className=\"shrink-0 px-4 pb-4\">\n        {showCelebrationFirst && gameOver && !hasOpenedCelebration && (\n          <div className=\"w-full max-w-md mx-auto\">\n            <Button\n              variant=\"outline\"\n              className=\"w-full h-14 sm:h-16 md:h-20 flex items-center justify-center px-6 rounded-3xl shadow-sm bg-brand-grey\"\n              onClick={() => {\n                onSetHasOpenedCelebration?.(true);\n                setShowCelebrationModal(true);\n              }}\n              data-testid=\"button-continue\"\n            >\n              <span className=\"text-lg sm:text-xl md:text-2xl font-bold text-gray-800\">\n                Continue\n              </span>\n            </Button>\n          </div>\n        )}\n\n        {!viewOnly && !showCelebrationFirst && (\n          <div className=\"w-full max-w-md mx-auto\">\n            <NumericKeyboard\n              onDigitPress={(digit) => {\n                if (currentInput.length < activeNumDigits) {\n                  setCurrentInput(currentInput + digit);\n                }\n              }}\n              onDelete={() => setCurrentInput(currentInput.slice(0, -1))}\n              onClear={() => setCurrentInput(\"\")}\n              onEnter={handleSubmit}\n              keyStates={keyStates}\n              canSubmit={isValidGuess}\n            />\n          </div>\n        )}\n      </div>\n\n      <EndGameModal\n        isOpen={showCelebrationFirst ? showCelebrationModal : showEndModal}\n        isWin={isWin}\n        answerDateCanonical={answerDateCanonical}\n        formattedAnswer={formattedAnswer}\n        eventTitle={eventTitle}\n        eventDescription={eventDescription}\n        numGuesses={finalGuessCount ?? guesses.length}\n        onPlayAgain={handlePlayAgain}\n        onHome={() => {\n          const isTodaysPuzzle = isPlayingTodaysPuzzle();\n          if (!isTodaysPuzzle && fromArchive) {\n            triggerAd(() => {\n              (onHomeFromCelebration || onBack)();\n            });\n          } else {\n            (onHomeFromCelebration || onBack)();\n          }\n        }}\n        onViewStats={onViewStats}\n        onViewArchive={onViewArchive}\n        isLocalMode={isLocalMode}\n        isGuest={!isAuthenticated}\n        onContinueToLogin={onContinueToLogin}\n      />\n\n      <HelpDialog isOpen={showHelp} onClose={() => setShowHelp(false)} />\n      \n      <StreakSaverExitWarning\n        open={showStreakSaverExitWarning}\n        onClose={() => setShowStreakSaverExitWarning(false)}\n        onCancelAndLoseStreak={handleCancelStreakSaver}\n        onContinuePlaying={handleContinuePlaying}\n      />\n      \n      <AlertDialog \n        open={showHolidayWarning} \n        onOpenChange={(open) => {\n          if (!open) {\n            setHolidayWarningDismissed(true);\n            setShowHolidayWarning(false);\n          }\n        }}\n      >\n        <AlertDialogContent className=\"rounded-xl max-w-[calc(100vw-2rem)] sm:max-w-md\" data-testid=\"holiday-warning-dialog\">\n          <AlertDialogHeader className=\"text-center\">\n            <AlertDialogTitle className=\"flex items-center justify-center gap-2\">\n              <Umbrella className=\"h-5 w-5 text-yellow-500\" />\n              Holiday Mode Active\n            </AlertDialogTitle>\n            <AlertDialogDescription asChild>\n              <div className=\"text-center space-y-3 text-sm text-muted-foreground\">\n                <p>\n                  Playing today won't extend your streak unless you exit holiday mode.\n                </p>\n                {holidayEndDate && (\n                  <p className=\"font-medium text-foreground\">\n                    Holiday runs until {new Date(holidayEndDate).toLocaleDateString('en-GB', { \n                      weekday: 'long', \n                      day: 'numeric', \n                      month: 'long' \n                    })}\n                  </p>\n                )}\n                <p>\n                  Choose how you'd like to continue:\n                </p>\n              </div>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter className=\"flex-col sm:flex-row gap-2 justify-center items-center\">\n            <AlertDialogCancel \n              onClick={async () => {\n                // Exit holiday mode first, then allow normal play\n                try {\n                  await endHoliday(false);\n                  await refetchStreakStatus();\n                } catch (error) {\n                  console.error('[HolidayWarning] Failed to end holiday:', error);\n                }\n                setHolidayWarningDismissed(true);\n                setShowHolidayWarning(false);\n              }}\n              className=\"w-3/4 sm:w-auto mx-auto\"\n              data-testid=\"button-holiday-exit-mode\"\n            >\n              Exit Holiday Mode\n            </AlertDialogCancel>\n            <AlertDialogAction \n              onClick={() => {\n                // Continue playing in holiday mode - attempt will be recorded with streak_day_status = 0\n                setHolidayWarningDismissed(true);\n                setShowHolidayWarning(false);\n              }}\n              className=\"w-3/4 sm:w-auto mx-auto\"\n              data-testid=\"button-holiday-continue-playing\"\n            >\n              Continue in Holiday Mode\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {showStreakCelebration && (\n        <StreakCelebrationPopup\n          streak={currentStreak}\n          onDismiss={async () => {\n            // If badge check was pending (waiting for streak celebration to finish), run it now\n            if (pendingBadgeCheck) {\n              setPendingBadgeCheck(false);\n              const gameType = isLocalMode ? 'USER' : 'REGION';\n              const guessCountForBadge = finalGuessCount ?? guesses.length;\n              console.log('[StreakCelebration] Checking badges after streak celebration:', { \n                guessCount: guessCountForBadge, \n                streak: currentStreak,\n                gameType \n              });\n              const badge = await checkAllBadgesOnGameComplete(\n                true, \n                guessCountForBadge, \n                currentStreak,\n                gameType\n              );\n              if (badge) {\n                setEarnedBadge(badge);\n                setShowStreakCelebration(false);\n                return; // Wait for badge celebration before showing end modal\n              }\n            }\n            \n            // If EndGameModal was pending (waiting for streak celebration to finish), mark as ready FIRST\n            // Then hide streak celebration to avoid flash of PlayPage\n            if (pendingEndModal) {\n              setPendingEndModal(false);\n              setEndModalReady(true);\n            }\n            // Hide streak celebration after EndGameModal is ready\n            setShowStreakCelebration(false);\n          }}\n        />\n      )}\n      \n      {earnedBadge && (\n        <BadgeCelebrationPopup\n          badge={earnedBadge}\n          onDismiss={async () => {\n            // Mark the badge as awarded in the backend\n            try {\n              await apiRequest('POST', `/api/badges/${earnedBadge.id}/award`);\n              // Invalidate badges queries so stats page shows the new badge\n              const { queryClient } = await import(\"@/lib/queryClient\");\n              const endpoint = isLocalMode ? '/api/user/badges/earned' : '/api/badges/earned';\n              queryClient.invalidateQueries({ queryKey: [endpoint] });\n            } catch (error) {\n              console.error('[BadgeCelebration] Failed to mark badge as awarded:', error);\n            }\n            \n            setEarnedBadge(null);\n            // If EndGameModal was pending, mark as ready\n            // Modal will show when both 2.5s delay has elapsed AND ready flag is set\n            if (pendingEndModal) {\n              setPendingEndModal(false);\n              setEndModalReady(true);\n            }\n          }}\n        />\n      )}\n      \n      <InterstitialAdComponent />\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":85208,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n    //  This is the key bit: ensures SPA routes fall back to index.html\n    historyApiFallback: true,\n  },\n  preview: {\n    // Also apply fallback when running `vite preview` or in Replit hosting\n    historyApiFallback: true,\n  },\n});\n","path":null,"size_bytes":1310,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"design_guidelines.md":{"content":"# Elementle Design Guidelines\n\n## Design Approach\n\n**Reference-Based Design**: Drawing inspiration from NYT Games (Wordle, Connections) for clean puzzle mechanics, combined with Duolingo's playful character-driven personality. The design balances serious historical content with lighthearted hamster mascot engagement.\n\n**Core Principles:**\n- Clarity over decoration: puzzle mechanics must be instantly readable\n- Playful personality through hamster animations, not overwhelming UI flourishes\n- Focus-driven layouts that guide attention to the active puzzle state\n- Sophisticated color system that works for game feedback AND brand identity\n\n---\n\n## Color Palette\n\n### Light Mode (Primary)\n**Background & Surfaces:**\n- Page background: 0 0% 98%\n- Card/container background: 0 0% 100%\n- Input cells (empty): 0 0% 100% with 220 13% 91% border\n- Elevated surfaces: 0 0% 100% with subtle shadow\n\n**Game Feedback Colors:**\n- Correct position (green): 142 71% 45%\n- In sequence (amber): 38 92% 50%\n- Not in sequence (grey): 0 0% 60%\n- Keyboard ruled out: 0 0% 80%\n- Arrow indicators: Inherit amber/green background with white icons\n\n**Brand & Accent:**\n- Primary brand: 220 90% 56% (trustworthy blue for headers/CTAs)\n- Success state: 142 71% 45% (matches correct feedback)\n- Text primary: 222 47% 11%\n- Text secondary: 215 16% 47%\n\n### Dark Mode\n**Background & Surfaces:**\n- Page background: 222 47% 11%\n- Card/container background: 217 33% 17%\n- Input cells (empty): 217 33% 17% with 215 25% 27% border\n\n**Game Feedback Colors:**\n- Correct position: 142 71% 35% (slightly desaturated)\n- In sequence: 38 92% 45%\n- Not in sequence: 215 14% 34%\n- Keyboard ruled out: 215 14% 28%\n\n**Brand & Accent:**\n- Primary brand: 220 90% 66% (brighter for visibility)\n- Text primary: 210 40% 98%\n- Text secondary: 215 20% 65%\n\n---\n\n## Typography\n\n**Font System:** Inter (via Google Fonts CDN)\n\n**Scale & Hierarchy:**\n- H1 (Welcome/Title): 700 weight, 2.5rem (40px) desktop / 2rem mobile\n- H2 (Screen headers): 600 weight, 1.875rem (30px) desktop / 1.5rem mobile\n- Button labels: 500 weight, 1rem (16px)\n- Input cells: 600 weight, 1.5rem (24px) - large for readability\n- Body text: 400 weight, 1rem (16px)\n- Event titles: 600 weight, 1.25rem (20px)\n- Event descriptions: 400 weight, 0.875rem (14px)\n- Small labels (streaks, stats): 500 weight, 0.75rem (12px)\n\n---\n\n## Layout System\n\n**Spacing Primitives:** Tailwind units of 2, 4, 6, 8, 12, 16\n- Tight spacing (grid cells, keyboard buttons): p-2, gap-2\n- Standard component spacing: p-4, p-6, gap-4\n- Section spacing: py-8, py-12, px-4\n- Large screen separation: py-16, gap-16\n\n**Container Strategy:**\n- Max width: max-w-md (448px) for puzzle interface - keeps it focused\n- Welcome/Selection screens: max-w-lg (512px) centered\n- Responsive breakpoints: sm (640px), md (768px), lg (1024px)\n- Mobile-first with comfortable tap targets (min 44x44px)\n\n---\n\n## Component Library\n\n### Input Grid\n- 5 rows  8 columns fixed grid\n- Cell dimensions: 40x40px mobile, 52x52px desktop\n- Border: 2px solid, rounded-md (6px)\n- Gap between cells: gap-1 (4px)\n- Gap between rows: gap-2 (8px)\n- Active row has subtle glow: shadow-sm\n- Feedback states fill entire cell with color + border removed\n- Arrow icons: 16x16px, white, positioned top-right of amber/green cells\n\n### Numeric Keyboard\n- 34 grid layout: [1-9] in three rows, [Clear, 0, Del, Enter] bottom row\n- Button size: 56x56px mobile, 64x64px desktop\n- Rounded: rounded-lg (8px)\n- Default state: bg white/dark surface, border subtle\n- Hover: slight scale (scale-105), shadow\n- Active press: scale-95\n- Disabled (ruled out): bg grey, opacity-50, cursor-not-allowed\n- Amber state: bg amber, text white\n- Green state: bg green, text white\n\n### Buttons (Navigation/Actions)\n- Primary CTA: bg-blue-600, text-white, px-8 py-3, rounded-lg, hover:bg-blue-700\n- Secondary: bg-transparent, border-2 border-blue-600, text-blue-600, hover:bg-blue-50\n- Placeholder buttons: opacity-60, cursor-not-allowed\n- \"Play without signing in\": smaller text-sm, text-secondary\n\n### Cards & Containers\n- Welcome/Selection screens: bg-white/dark-surface, rounded-xl, shadow-lg, p-8\n- Event reveal card: bg-white/dark-surface, rounded-lg, p-6, border-l-4 border-blue-600\n- Streak display: inline-flex items-center, gap-2, bg-blue-50/dark-variant, rounded-full, px-4 py-2\n\n---\n\n## Hamster Animation Character\n\n**Placement:** Center of end-game reveal modal, 120x120px container\n\n**Win State Animation:**\n- Dancing hamster GIF/animation (bouncing, arms up)\n- Confetti particles: falling from top, randomized colors (blue, green, amber, pink)\n- Fireworks: 2-3 bursts radiating from behind hamster\n- Animation duration: 3-4 seconds, loops once\n\n**Loss State Animation:**\n- Hamster shaking head side-to-side (2-3 shakes)\n- Paws/hands cover face afterward\n- Subtle shake applied to entire reveal card\n- Animation duration: 2 seconds, plays once\n\n---\n\n## Screen-Specific Layouts\n\n### Welcome Screen\n- Centered vertical layout, max-w-lg\n- Logo/title at top (consider simple hamster icon + \"Elementle\" wordmark)\n- Large primary buttons stacked: \"Login\" and \"Sign up\" (60px height)\n- Small \"Play without signing in\" link below, text-sm\n- Soft gradient background option: blue-50 to white\n\n### Game Selection Screen\n- Grid layout: 23 on desktop, 1 column on mobile\n- \"Play\" button: larger, blue gradient, prominent\n- Placeholder buttons: greyed out, same size\n- Button size: 140x140px desktop, full-width mobile, 80px height\n\n### Play Screen\n- Input grid: centered, mb-8\n- Keyboard: centered below grid, mb-4\n- Guess history: above grid, right-aligned, compact list (previous guesses with small feedback indicators)\n- Streak counter: top-right corner, badge style\n- All contained within max-w-md container\n\n### End Game Reveal Modal\n- Overlay: bg-black/50 backdrop blur\n- Modal card: max-w-lg, centered, bg-white/dark-surface, rounded-xl, p-8\n- Hamster animation: top center, mb-6\n- Event title: h2 styling, mb-2\n- Event description: body text, mb-6\n- Stats comparison: simple grid, 3 columns (You, Bot, Global - placeholders)\n- \"Play Again\" button: primary CTA at bottom\n\n---\n\n## Animations & Interactions\n\n**Minimal Animation Philosophy:** Use sparingly, only for meaningful feedback\n\n**Applied Animations:**\n- Cell reveal: Stagger fill animation on guess submission (0.1s delay per cell)\n- Keyboard state change: Smooth color transition (200ms)\n- Modal entrance: Scale up from 0.95 + fade in (300ms)\n- Incorrect guess: Horizontal shake on row (400ms)\n- Hamster win/loss: As described above\n- Button interactions: Subtle scale transforms only\n\n**No Animations For:**\n- Screen transitions (instant)\n- Text appearance\n- Background changes\n\n---\n\n## Accessibility & Responsive Design\n\n- Color feedback supplemented by icons (arrows) for colorblind users\n- Focus states: 2px blue ring on all interactive elements\n- Touch targets: minimum 44x44px\n- Keyboard navigation: full support with visible focus indicators\n- Screen reader labels on all game state changes\n- Dark mode toggle: top-right corner of all screens, moon/sun icon\n- Mobile: stack all grids to single column, increase touch targets\n- Tablet: maintain desktop layout with adjusted spacing\n\n---\n\n## Images\n\n**No hero images required.** This is a focused puzzle game application. Visual interest comes from:\n- Optional hamster mascot icon in header/logo\n- Game feedback colors and grid patterns\n- End-game hamster animations (GIF or Lottie files)\n\nIf mascot artwork needed: Simple, friendly cartoon hamster, 2D illustration style, warm browns/oranges, minimal detail for versatility across UI scales.","path":null,"size_bytes":7596,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-xl text-sm font-semibold focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-brand-blue text-white hover:bg-brand-blue/90 border border-transparent\",\n        success:\n          \"bg-brand-green text-white hover:bg-brand-green/90 border border-transparent\",\n        warning:\n          \"bg-brand-yellow text-black hover:bg-brand-yellow/90 border border-transparent\",\n        outline:\n          \"border border-brand-grey text-brand-blue hover:bg-brand-grey/20 bg-transparent\",\n        ghost:\n          \"border border-transparent text-brand-blue hover:bg-brand-grey/10\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n      },\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-lg px-3 text-xs\",\n        lg: \"min-h-12 px-6 text-lg\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2010,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed bottom-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:right-0 sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4824,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/components/examples/ThemeToggle.tsx":{"content":"import { ThemeToggle } from '../ThemeToggle';\n\nexport default function ThemeToggleExample() {\n  return <ThemeToggle />;\n}\n","path":null,"size_bytes":122,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/examples/EndGameModal.tsx":{"content":"import { EndGameModal } from '../EndGameModal';\nimport { useState } from 'react';\nimport { Button } from '@/components/ui/button';\n\nexport default function EndGameModalExample() {\n  const [isOpen, setIsOpen] = useState(true);\n  const [isWin, setIsWin] = useState(true);\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex gap-2 justify-center\">\n        <Button onClick={() => { setIsWin(true); setIsOpen(true); }}>Show Win</Button>\n        <Button onClick={() => { setIsWin(false); setIsOpen(true); }}>Show Loss</Button>\n      </div>\n      <EndGameModal\n        isOpen={isOpen}\n        isWin={isWin}\n        targetDate=\"200769\"\n        eventTitle=\"Apollo 11 Moon Landing\"\n        eventDescription=\"Neil Armstrong becomes the first human to set foot on the Moon.\"\n        numGuesses={3}\n        onPlayAgain={() => setIsOpen(false)}\n        onHome={() => console.log('Home')}\n        onViewStats={() => console.log('View Stats')}\n        onViewArchive={() => console.log('View Archive')}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":1032,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport {\n  pgTable,\n  text,\n  varchar,\n  timestamp,\n  index,\n  jsonb,\n  integer,\n  boolean,\n  date,\n  serial,\n  uuid,\n  unique,\n  numeric,\n} from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Postcodes table - UK postcodes for autocomplete\nexport const postcodes = pgTable(\"postcodes\", {\n  id: serial(\"id\").primaryKey(),\n  name1: text(\"name1\").notNull().unique(), // The postcode itself (e.g., \"SW1A 1AA\")\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => ({\n  name1Idx: index(\"idx_postcodes_name1\").on(table.name1),\n}));\n\nexport const insertPostcodeSchema = createInsertSchema(postcodes).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertPostcode = z.infer<typeof insertPostcodeSchema>;\nexport type Postcode = typeof postcodes.$inferSelect;\n\n// Pro Subscription tiers (legacy enum kept for backward compatibility)\nexport const ProTierEnum = z.enum(['free', 'bronze', 'silver', 'gold', 'standard', 'pro_monthly', 'pro_annual', 'pro_lifetime']);\nexport type ProTier = z.infer<typeof ProTierEnum>;\n\n// User Tier table - defines available subscription tiers per region\n// This table is managed in Supabase and defines tier metadata\n// Unique constraint: (region, tier, tier_type)\nexport const userTier = pgTable(\"user_tier\", {\n  id: uuid(\"id\").primaryKey(),\n  region: text(\"region\").notNull(), // e.g., 'UK', 'US'\n  tier: text(\"tier\").notNull(), // e.g., 'Standard', 'Pro', 'Education'\n  tierType: text(\"tier_type\").notNull().default(\"default\"), // e.g., 'default', 'monthly', 'annual', 'lifetime'\n  billingPeriod: text(\"billing_period\"), // 'month', 'quarter', 'year' - for Stripe billing\n  stripePriceId: text(\"stripe_price_id\"), // Stripe Price ID for checkout\n  subscriptionCost: numeric(\"subscription_cost\", { precision: 10, scale: 2 }), // Cost in currency (e.g., 11.99)\n  currency: text(\"currency\").default(\"GBP\"), // e.g., 'GBP', 'USD'\n  subscriptionDurationMonths: integer(\"subscription_duration_months\").default(1), // null for lifetime\n  streakSavers: integer(\"streak_savers\").default(1),\n  holidaySavers: integer(\"holiday_savers\").default(0),\n  holidayDurationDays: integer(\"holiday_duration_days\").default(14),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true }).defaultNow(),\n  active: boolean(\"active\").default(true),\n  description: text(\"description\"),\n  sortOrder: integer(\"sort_order\"),\n}, (table) => ({\n  activeIdx: index(\"idx_user_tier_active\").on(table.active),\n  stripePriceIdIdx: index(\"idx_user_tier_stripe_price_id\").on(table.stripePriceId),\n}));\n\nexport type UserTier = typeof userTier.$inferSelect;\nexport type InsertUserTier = typeof userTier.$inferInsert;\n\n// LEGACY: Type for user_active_tier_view - deprecated, use SubscriptionResponse instead\nexport interface UserActiveTier {\n  userId: string;\n  tierId: string;\n  tier: string;\n  region: string;\n  subscriptionCost: number | null;\n  currency: string | null;\n  subscriptionDurationMonths: number | null;\n  streakSavers: number;\n  holidaySavers: number;\n  holidayDurationDays: number;\n  description: string | null;\n  expiresAt: string | null;\n  autoRenew: boolean;\n  isActive: boolean;\n}\n\n// New subscription response interface - reads from user_profiles + user_tier + user_subscriptions\nexport interface SubscriptionResponse {\n  tier: 'free' | 'pro'; // Display tier: 'pro' if tier != 'Standard', else 'free'\n  tierName: string; // Canonical tier name from user_tier.tier (e.g., 'Standard', 'Pro')\n  tierType: 'monthly' | 'annual' | 'lifetime' | 'default'; // Variant from user_tier.tier_type\n  tierId: string | null; // FK from user_profiles.user_tier_id\n  userId: string | null; // From user_profiles.id (null if no user profile found)\n  endDate: string | null; // From user_profiles.subscription_end_date\n  autoRenew: boolean; // From latest user_subscriptions.auto_renew\n  isActive: boolean; // Derived: endDate > now() or (endDate is null and tierType is lifetime)\n  isExpired: boolean; // Derived: endDate is not null and < now()\n  metadata: {\n    streakSavers: number;\n    holidaySavers: number;\n    holidayDurationDays: number;\n    subscriptionCost: number | null;\n    currency: string;\n    subscriptionDurationMonths: number | null;\n    description: string | null;\n    sortOrder: number | null;\n  } | null;\n  // Stripe fields from user_subscriptions (for managing subscription via Stripe)\n  stripeSubscriptionId?: string | null;\n  stripeCustomerId?: string | null;\n  stripePriceId?: string | null;\n}\n\n// User profiles table - extends Supabase Auth users\n// References auth.users(id) from Supabase Auth\nexport const userProfiles = pgTable(\"user_profiles\", {\n  id: uuid(\"id\").primaryKey(),\n  email: varchar(\"email\"), // Nullable: Google/Apple OAuth may not share email\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  isAdmin: boolean(\"is_admin\").default(false),\n\n  // Current consent flags\n  acceptedTerms: boolean(\"accepted_terms\").notNull().default(false),\n  adsConsent: boolean(\"ads_consent\").notNull().default(false),\n\n  // Audit timestamps (keep these)\n  acceptedTermsAt: timestamp(\"accepted_terms_at\", { withTimezone: true }),\n  adsConsentUpdatedAt: timestamp(\"ads_consent_updated_at\", { withTimezone: true }),\n\n  // Email verification mirror from Supabase Auth\n  emailVerified: boolean(\"email_verified\").default(false),\n\n  // Region and location fields\n  region: text(\"region\").default(\"UK\"), // ISO country code (e.g., 'UK', 'US')\n  postcode: text(\"postcode\"), // References postcodes.name1\n  location: text(\"location\"), // Geography type stored as text\n  \n  // Postcode change tracking\n  postcodeLastChangedAt: timestamp(\"postcode_last_changed_at\", { withTimezone: true }),\n  \n  // Category change tracking (Pro users)\n  categoriesLastChangedAt: timestamp(\"categories_last_changed_at\", { withTimezone: true }),\n  \n  // Archive puzzle sync count\n  archiveSyncedCount: integer(\"archive_synced_count\").default(0),\n  \n  // Authentication method tracking\n  // signup_method: how user first signed up ('password', 'magic_link', 'google', 'apple')\n  signupMethod: text(\"signup_method\"), // null until first login recorded\n  // password_created: whether user has created a password (true if signed up with password or created one later)\n  passwordCreated: boolean(\"password_created\").default(false),\n  // OAuth provider linking status:\n  // NULL = Not signed up with this provider yet\n  // TRUE = Authorized and linked\n  // FALSE = Authorized but requested to be unlinked\n  googleLinked: boolean(\"google_linked\"),\n  appleLinked: boolean(\"apple_linked\"),\n  // NOTE: magic_link column exists in database but not in Drizzle schema\n  // to avoid breaking queries if column doesn't exist. Queried separately.\n  \n  // Foreign key to user_tier table (managed by Supabase trigger)\n  userTierId: uuid(\"user_tier_id\").references(() => userTier.id),\n  \n  // Subscription end date - null means Standard tier or lifetime subscription\n  // Managed by Supabase trigger (sync_user_profile_user_tier_id_and_end_date)\n  subscriptionEndDate: timestamp(\"subscription_end_date\", { withTimezone: true }),\n\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => ({\n  regionIdx: index(\"idx_user_profiles_region\").on(table.region),\n}));\n\nexport const insertUserProfileSchema = createInsertSchema(userProfiles)\n.omit({\n  createdAt: true,\n  updatedAt: true,\n})\n.extend({\n  acceptedTermsAt: z.date().optional().nullable(),\n  adsConsentUpdatedAt: z.date().optional().nullable(),\n  emailVerified: z.boolean().optional(),\n});\n\n\nexport type InsertUserProfile = z.infer<typeof insertUserProfileSchema>;\nexport type UserProfile = typeof userProfiles.$inferSelect;\n\n// User Subscriptions table - stores active user subscriptions\n// References user_tier for tier metadata, managed by Supabase triggers and Stripe webhooks\n// Note: 'validity' column is GENERATED ALWAYS (tstzrange) - not in Drizzle schema\nexport const userSubscriptions = pgTable(\"user_subscriptions\", {\n  id: uuid(\"id\").primaryKey(), // UUID for Stripe integration\n  userId: uuid(\"user_id\").notNull().references(() => userProfiles.id, { onDelete: \"cascade\" }),\n  userTierId: uuid(\"user_tier_id\").references(() => userTier.id), // FK to user_tier.id (tier_id in brief)\n  \n  // Stripe integration fields\n  stripeCustomerId: text(\"stripe_customer_id\"), // Stripe Customer ID\n  stripeSubscriptionId: text(\"stripe_subscription_id\").unique(), // Stripe Subscription ID (unique constraint)\n  billingPeriod: text(\"billing_period\"), // 'month', 'quarter', 'year'\n  \n  // Payment and subscription state\n  amountPaid: numeric(\"amount_paid\", { precision: 10, scale: 2 }), // Latest invoice amount\n  currency: text(\"currency\").default(\"GBP\"),\n  expiresAt: timestamp(\"expires_at\", { withTimezone: true }), // Stripe current_period_end\n  autoRenew: boolean(\"auto_renew\").notNull().default(true),\n  status: text(\"status\").default(\"active\"), // 'active', 'canceled', 'incomplete', 'past_due'\n  \n  // Discount tracking (from Stripe coupons/promotions)\n  discountType: text(\"discount_type\"), // 'fixed' or 'percent'\n  discountValue: numeric(\"discount_value\", { precision: 10, scale: 2 }), // GBP for fixed, % for percent\n  discountDurationMonths: integer(\"discount_duration_months\"), // Null for one-time\n  discountExpiresAt: timestamp(\"discount_expires_at\", { withTimezone: true }),\n  \n  // Legacy fields (kept for backward compatibility)\n  paymentReference: text(\"payment_reference\"),\n  source: text(\"source\"), // e.g., 'stripe', 'apple', 'google'\n  effectiveStartAt: timestamp(\"effective_start_at\", { withTimezone: true }).defaultNow(),\n  tier: text(\"tier\"), // 'school', 'trial', 'pro' - nullable\n  \n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true }).defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"idx_user_subscriptions_user_id\").on(table.userId),\n  statusIdx: index(\"idx_user_subscriptions_status\").on(table.status),\n  expiresAtIdx: index(\"idx_user_subscriptions_expires_at\").on(table.expiresAt),\n}));\n\nexport const insertUserSubscriptionSchema = createInsertSchema(userSubscriptions).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertUserSubscription = z.infer<typeof insertUserSubscriptionSchema>;\nexport type UserSubscription = typeof userSubscriptions.$inferSelect;\n\n// User Pro Categories table - stores selected categories for Pro users\n// Note: This table needs to be created in Supabase SQL editor\n// CREATE TABLE user_pro_categories (\n//   id SERIAL PRIMARY KEY,\n//   user_id UUID REFERENCES user_profiles(id) ON DELETE CASCADE NOT NULL,\n//   category_id INTEGER NOT NULL,\n//   created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n//   UNIQUE(user_id, category_id)\n// );\nexport const userProCategories = pgTable(\"user_pro_categories\", {\n  id: serial(\"id\").primaryKey(),\n  userId: uuid(\"user_id\").notNull().references(() => userProfiles.id, { onDelete: \"cascade\" }),\n  categoryId: integer(\"category_id\").notNull(),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n}, (table) => ({\n  userCategoryUnique: unique().on(table.userId, table.categoryId),\n}));\n\nexport const insertUserProCategorySchema = createInsertSchema(userProCategories).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertUserProCategory = z.infer<typeof insertUserProCategorySchema>;\nexport type UserProCategory = typeof userProCategories.$inferSelect;\n\n// LEGACY: Puzzles table removed - use questions_master_region and questions_allocated_region instead\n// Types kept for backward compatibility in frontend\nexport type Puzzle = {\n  id: number;\n  date: string;\n  answerDateCanonical: string;\n  eventTitle: string;\n  eventDescription: string;\n  clue1?: string | null;\n  clue2?: string | null;\n  createdAt?: Date;\n};\n\n// User settings table - stores preferences per user\nexport const userSettings = pgTable(\"user_settings\", {\n  id: serial(\"id\").primaryKey(),\n  userId: uuid(\"user_id\").notNull().unique().references(() => userProfiles.id, { onDelete: \"cascade\" }),\n  textSize: varchar(\"text_size\", { length: 20 }).default(\"medium\"), // small, medium, large\n  soundsEnabled: boolean(\"sounds_enabled\").default(false),\n  darkMode: boolean(\"dark_mode\").default(false),\n  cluesEnabled: boolean(\"clues_enabled\").default(true),\n  \n  // Date format preferences\n  dateFormatPreference: text(\"date_format_preference\").default(\"ddmmyy\"), // ddmmyy, mmddyy, ddmmyyyy, mmddyyyy\n  useRegionDefault: boolean(\"use_region_default\").default(true), // Auto-detect from region\n  digitPreference: varchar(\"digit_preference\", { length: 1 }).default(\"8\"), // '6' or '8' for 6-digit vs 8-digit dates\n  \n  // Category preferences (for future use)\n  categoryPreferences: jsonb(\"category_preferences\"),\n  \n  // Streak saver preferences\n  streakSaverActive: boolean(\"streak_saver_active\").default(true), // Toggle for streak saver popup workflow\n  holidaySaverActive: boolean(\"holiday_saver_active\").default(true), // Toggle for holiday protection (Pro/Education only)\n  \n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertUserSettingsSchema = createInsertSchema(userSettings).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport type InsertUserSettings = z.infer<typeof insertUserSettingsSchema>;\nexport type UserSettings = typeof userSettings.$inferSelect;\n\n// LEGACY: Game attempts table removed - use game_attempts_region instead\n// Types kept for backward compatibility in frontend\nexport type GameAttempt = {\n  id: number;\n  userId?: string | null;\n  puzzleId: number;\n  result?: string | null;\n  numGuesses?: number;\n  startedAt?: Date;\n  completedAt?: Date | null;\n};\n\n// LEGACY: Guesses table removed - use guesses_region instead\n// Types kept for backward compatibility in frontend\nexport type Guess = {\n  id: number;\n  gameAttemptId: number;\n  guessValue: string;\n  guessedAt?: Date;\n};\n\n// LEGACY: User stats table removed - use user_stats_region instead\n// Types kept for backward compatibility in frontend\nexport type UserStats = {\n  id: number;\n  userId: string;\n  gamesPlayed?: number;\n  gamesWon?: number;\n  currentStreak?: number;\n  maxStreak?: number;\n  guessDistribution?: Record<string, number>;\n  updatedAt?: Date;\n};\n\n// ============================================================================\n// REGION GAME MODE TABLES\n// ============================================================================\n\n// Regions table - Available regions/countries for puzzles\nexport const regions = pgTable(\"regions\", {\n  code: text(\"code\").primaryKey(), // ISO country code (e.g., 'UK', 'US')\n  name: text(\"name\").notNull(), // Display name (e.g., 'United Kingdom', 'United States')\n  defaultDateFormat: text(\"default_date_format\").notNull(), // Default date format preference (ddmmyy, mmddyy)\n});\n\nexport const insertRegionSchema = createInsertSchema(regions);\n\nexport type InsertRegion = z.infer<typeof insertRegionSchema>;\nexport type Region = typeof regions.$inferSelect;\n\n// Categories table - Available puzzle categories\nexport const categories = pgTable(\"categories\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull().unique(), // Category name (e.g., 'Science', 'Sports', 'History')\n  description: text(\"description\"), // Full details of the category\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true }).defaultNow(),\n});\n\nexport const insertCategorySchema = createInsertSchema(categories).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertCategory = z.infer<typeof insertCategorySchema>;\nexport type Category = typeof categories.$inferSelect;\n\n// Questions master (region) - Canonical question bank for region mode\nexport const questionsMasterRegion = pgTable(\"questions_master_region\", {\n  id: serial(\"id\").primaryKey(),\n  answerDateCanonical: date(\"answer_date_canonical\").notNull(), // Canonical historical date (YYYY-MM-DD)\n  eventTitle: text(\"event_title\").notNull(),\n  eventDescription: text(\"event_description\").notNull(),\n  regions: jsonb(\"regions\"), // Regions this question is relevant for\n  categories: jsonb(\"categories\").notNull(), // Categories this question belongs to\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertQuestionMasterRegionSchema = createInsertSchema(questionsMasterRegion).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertQuestionMasterRegion = z.infer<typeof insertQuestionMasterRegionSchema>;\nexport type QuestionMasterRegion = typeof questionsMasterRegion.$inferSelect;\n\n// Questions allocated (region) - Daily puzzle allocations per region\nexport const questionsAllocatedRegion = pgTable(\n  \"questions_allocated_region\",\n  {\n    id: serial(\"id\").primaryKey(),\n    questionId: integer(\"question_id\").notNull().references(() => questionsMasterRegion.id, { onDelete: \"cascade\" }),\n    region: text(\"region\").notNull(), // ISO country code (e.g., 'GB', 'US')\n    puzzleDate: date(\"puzzle_date\").notNull(), // The date this question is allocated for (YYYY-MM-DD)\n  },\n  (table) => {\n    return {\n      regionDateUnique: unique().on(table.region, table.puzzleDate),\n    };\n  }\n);\n\nexport const insertQuestionAllocatedRegionSchema = createInsertSchema(questionsAllocatedRegion).omit({\n  id: true,\n});\n\nexport type InsertQuestionAllocatedRegion = z.infer<typeof insertQuestionAllocatedRegionSchema>;\nexport type QuestionAllocatedRegion = typeof questionsAllocatedRegion.$inferSelect;\n\n// Game attempts (region) - User attempts for region mode puzzles\nexport const gameAttemptsRegion = pgTable(\n  \"game_attempts_region\",\n  {\n    id: serial(\"id\").primaryKey(),\n    userId: uuid(\"user_id\").references(() => userProfiles.id, { onDelete: \"cascade\" }), // null for guest users\n    allocatedRegionId: integer(\"allocated_region_id\").notNull().references(() => questionsAllocatedRegion.id),\n    result: varchar(\"result\", { length: 10 }), // 'won' or 'lost' - null for in-progress\n    numGuesses: integer(\"num_guesses\").default(0),\n    digits: varchar(\"digits\", { length: 1 }), // '6' or '8' - locked on first guess\n    streakDayStatus: integer(\"streak_day_status\"), // 0 = holiday (maintains streak), 1 = played (increments streak), NULL = missed (breaks streak)\n    startedAt: timestamp(\"started_at\").defaultNow(),\n    completedAt: timestamp(\"completed_at\"), // null for in-progress games\n  },\n  (table) => {\n    return {\n      userAllocatedUnique: unique().on(table.userId, table.allocatedRegionId),\n    };\n  }\n);\n\nexport const insertGameAttemptRegionSchema = createInsertSchema(gameAttemptsRegion).omit({\n  id: true,\n  startedAt: true,\n  completedAt: true,\n});\n\nexport type InsertGameAttemptRegion = z.infer<typeof insertGameAttemptRegionSchema>;\nexport type GameAttemptRegion = typeof gameAttemptsRegion.$inferSelect;\n\n// Guesses (region) - Individual guesses for region mode\nexport const guessesRegion = pgTable(\"guesses_region\", {\n  id: serial(\"id\").primaryKey(),\n  gameAttemptId: integer(\"game_attempt_id\").notNull().references(() => gameAttemptsRegion.id, { onDelete: \"cascade\" }),\n  guessValue: varchar(\"guess_value\", { length: 8 }).notNull(), // Date string in user's format (DDMMYY or DDMMYYYY)\n  guessedAt: timestamp(\"guessed_at\").defaultNow(),\n});\n\nexport const insertGuessRegionSchema = createInsertSchema(guessesRegion).omit({\n  id: true,\n  guessedAt: true,\n});\n\nexport type InsertGuessRegion = z.infer<typeof insertGuessRegionSchema>;\nexport type GuessRegion = typeof guessesRegion.$inferSelect;\n\n// User stats (region) - Aggregated statistics for region mode\n// Each user can have one stats row per region (e.g., UK, US) to preserve history when changing regions\nexport const userStatsRegion = pgTable(\"user_stats_region\", {\n  id: serial(\"id\").primaryKey(),\n  userId: uuid(\"user_id\").notNull().references(() => userProfiles.id, { onDelete: \"cascade\" }),\n  region: text(\"region\").notNull().default(\"UK\"), // Region code (e.g., 'UK', 'US') - defaults to UK for existing data\n  gamesPlayed: integer(\"games_played\").default(0),\n  gamesWon: integer(\"games_won\").default(0),\n  currentStreak: integer(\"current_streak\").default(0),\n  maxStreak: integer(\"max_streak\").default(0),\n  guessDistribution: jsonb(\"guess_distribution\").default({ \"1\": 0, \"2\": 0, \"3\": 0, \"4\": 0, \"5\": 0 }), // JSON object tracking wins by guess count\n  // Streak saver fields (managed by nightly cron and API endpoints)\n  streakSaversUsedMonth: integer(\"streak_savers_used_month\").default(0),\n  missedYesterdayFlagRegion: boolean(\"missed_yesterday_flag_region\").default(false), // Tracks missed region puzzles\n  // Cumulative monthly percentile score (updated by badge check logic)\n  cumulativeMonthlyPercentile: integer(\"cumulative_monthly_percentile\"),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => ({\n  // Unique constraint on (user_id, region) to allow one stats row per user per region\n  userIdRegionIdx: unique(\"user_stats_region_user_id_region_unique\").on(table.userId, table.region),\n}));\n\nexport const insertUserStatsRegionSchema = createInsertSchema(userStatsRegion).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport type InsertUserStatsRegion = z.infer<typeof insertUserStatsRegionSchema>;\nexport type UserStatsRegion = typeof userStatsRegion.$inferSelect;\n\n// ============================================================================\n// USER GAME MODE TABLES\n// ============================================================================\n\n// Populated places - Location data for Local History category\nexport const populatedPlaces = pgTable(\"populated_places\", {\n  id: varchar(\"id\", { length: 50 }).primaryKey(), // String ID from external source\n  name1: text(\"name1\"), // Primary place name (e.g., \"Henley-on-Thames\")\n});\n\nexport type PopulatedPlace = typeof populatedPlaces.$inferSelect;\n\n// Questions master (user) - Canonical question bank for user mode\nexport const questionsMasterUser = pgTable(\"questions_master_user\", {\n  id: serial(\"id\").primaryKey(),\n  answerDateCanonical: date(\"answer_date_canonical\").notNull(), // Canonical historical date (YYYY-MM-DD)\n  eventTitle: text(\"event_title\").notNull(),\n  eventDescription: text(\"event_description\").notNull(),\n  regions: jsonb(\"regions\"), // Regions this question is relevant for\n  categories: jsonb(\"categories\").notNull(), // Categories this question belongs to\n  populatedPlaceId: varchar(\"populated_place_id\", { length: 50 }), // Link to populated_places for Local History\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertQuestionMasterUserSchema = createInsertSchema(questionsMasterUser).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertQuestionMasterUser = z.infer<typeof insertQuestionMasterUserSchema>;\nexport type QuestionMasterUser = typeof questionsMasterUser.$inferSelect;\n\n// Questions allocated (user) - Daily puzzle allocations per user\nexport const questionsAllocatedUser = pgTable(\n  \"questions_allocated_user\",\n  {\n    id: serial(\"id\").primaryKey(),\n    questionId: integer(\"question_id\").notNull().references(() => questionsMasterUser.id, { onDelete: \"cascade\" }),\n    userId: uuid(\"user_id\").notNull().references(() => userProfiles.id, { onDelete: \"cascade\" }),\n    puzzleDate: date(\"puzzle_date\").notNull(), // The date this question is allocated for (YYYY-MM-DD)\n    categoryId: integer(\"category_id\").notNull(), // Category ID for this puzzle\n  },\n  (table) => {\n    return {\n      userDateUnique: unique().on(table.userId, table.puzzleDate),\n    };\n  }\n);\n\nexport const insertQuestionAllocatedUserSchema = createInsertSchema(questionsAllocatedUser).omit({\n  id: true,\n});\n\nexport type InsertQuestionAllocatedUser = z.infer<typeof insertQuestionAllocatedUserSchema>;\nexport type QuestionAllocatedUser = typeof questionsAllocatedUser.$inferSelect;\n\n// Game attempts (user) - User attempts for user mode puzzles\nexport const gameAttemptsUser = pgTable(\n  \"game_attempts_user\",\n  {\n    id: serial(\"id\").primaryKey(),\n    userId: uuid(\"user_id\").notNull().references(() => userProfiles.id, { onDelete: \"cascade\" }),\n    allocatedUserId: integer(\"allocated_user_id\").notNull().references(() => questionsAllocatedUser.id),\n    result: varchar(\"result\", { length: 10 }), // 'won' or 'lost' - null for in-progress\n    numGuesses: integer(\"num_guesses\").default(0),\n    digits: varchar(\"digits\", { length: 1 }), // '6' or '8' - locked on first guess\n    streakDayStatus: integer(\"streak_day_status\"), // 0 = holiday (maintains streak), 1 = played (increments streak), NULL = missed (breaks streak)\n    startedAt: timestamp(\"started_at\").defaultNow(),\n    completedAt: timestamp(\"completed_at\"), // null for in-progress games\n  },\n  (table) => {\n    return {\n      userAllocatedUnique: unique().on(table.userId, table.allocatedUserId),\n    };\n  }\n);\n\nexport const insertGameAttemptUserSchema = createInsertSchema(gameAttemptsUser).omit({\n  id: true,\n  startedAt: true,\n  completedAt: true,\n});\n\nexport type InsertGameAttemptUser = z.infer<typeof insertGameAttemptUserSchema>;\nexport type GameAttemptUser = typeof gameAttemptsUser.$inferSelect;\n\n// Guesses (user) - Individual guesses for user mode\nexport const guessesUser = pgTable(\"guesses_user\", {\n  id: serial(\"id\").primaryKey(),\n  gameAttemptId: integer(\"game_attempt_id\").notNull().references(() => gameAttemptsUser.id, { onDelete: \"cascade\" }),\n  guessValue: varchar(\"guess_value\", { length: 10 }).notNull(), // Date string in user's format (DDMMYY or DDMMYYYY)\n  guessedAt: timestamp(\"guessed_at\").defaultNow(),\n});\n\nexport const insertGuessUserSchema = createInsertSchema(guessesUser).omit({\n  id: true,\n  guessedAt: true,\n});\n\nexport type InsertGuessUser = z.infer<typeof insertGuessUserSchema>;\nexport type GuessUser = typeof guessesUser.$inferSelect;\n\n// User stats (user) - Aggregated statistics for user mode\nexport const userStatsUser = pgTable(\"user_stats_user\", {\n  id: serial(\"id\").primaryKey(),\n  userId: uuid(\"user_id\").notNull().unique().references(() => userProfiles.id, { onDelete: \"cascade\" }),\n  gamesPlayed: integer(\"games_played\").default(0),\n  gamesWon: integer(\"games_won\").default(0),\n  currentStreak: integer(\"current_streak\").default(0),\n  maxStreak: integer(\"max_streak\").default(0),\n  guessDistribution: jsonb(\"guess_distribution\").default({ \"1\": 0, \"2\": 0, \"3\": 0, \"4\": 0, \"5\": 0 }), // JSON object tracking wins by guess count\n  // Streak saver and holiday fields (managed by nightly cron and API endpoints)\n  streakSaversUsedMonth: integer(\"streak_savers_used_month\").default(0),\n  holidayActive: boolean(\"holiday_active\").default(false),\n  holidayStartDate: date(\"holiday_start_date\"),\n  holidayEndDate: date(\"holiday_end_date\"),\n  holidayDaysTakenCurrentPeriod: integer(\"holiday_days_taken_current_period\").default(0), // Days taken in current holiday period\n  holidayEnded: boolean(\"holiday_ended\").default(false), // Set by cron when max days reached (auto-ended)\n  holidaysUsedYear: integer(\"holidays_used_year\").default(0), // Number of holidays used this year\n  nextHolidayResetDate: date(\"next_holiday_reset_date\"), // Date when holiday allowance resets\n  missedYesterdayFlagUser: boolean(\"missed_yesterday_flag_user\").default(false), // Tracks missed user puzzles\n  // Cumulative monthly percentile score (updated by badge check logic)\n  cumulativeMonthlyPercentile: integer(\"cumulative_monthly_percentile\"),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertUserStatsUserSchema = createInsertSchema(userStatsUser).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport type InsertUserStatsUser = z.infer<typeof insertUserStatsUserSchema>;\nexport type UserStatsUser = typeof userStatsUser.$inferSelect;\n\n// User Holiday Events - Tracks annual holiday usage for Pro users\nexport const userHolidayEvents = pgTable(\"user_holiday_events\", {\n  id: serial(\"id\").primaryKey(),\n  userId: uuid(\"user_id\").notNull().references(() => userProfiles.id, { onDelete: \"cascade\" }),\n  mode: varchar(\"mode\", { length: 10 }).notNull(), // 'region' or 'user'\n  startedAt: timestamp(\"started_at\", { withTimezone: true }).notNull(),\n  endedAt: timestamp(\"ended_at\", { withTimezone: true }),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n});\n\nexport const insertUserHolidayEventSchema = createInsertSchema(userHolidayEvents).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertUserHolidayEvent = z.infer<typeof insertUserHolidayEventSchema>;\nexport type UserHolidayEvent = typeof userHolidayEvents.$inferSelect;\n\n// Badges table - defines available badges\nexport const badges = pgTable(\"badges\", {\n  id: serial(\"id\").primaryKey(),\n  name: varchar(\"name\", { length: 100 }).notNull(),\n  category: varchar(\"category\", { length: 50 }).notNull(), // 'elementle', 'streak', 'percentile'\n  threshold: integer(\"threshold\").notNull(), // numeric condition (1, 2 for elementle; 7, 14, etc. for streak; 50, 40, etc. for percentile)\n  iconUrl: text(\"icon_url\"),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n});\n\nexport const insertBadgeSchema = createInsertSchema(badges).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertBadge = z.infer<typeof insertBadgeSchema>;\nexport type Badge = typeof badges.$inferSelect;\n\n// User Badges table - tracks badges earned by users\nexport const userBadges = pgTable(\"user_badges\", {\n  id: serial(\"id\").primaryKey(),\n  userId: uuid(\"user_id\").notNull().references(() => userProfiles.id, { onDelete: \"cascade\" }),\n  badgeId: integer(\"badge_id\").notNull().references(() => badges.id, { onDelete: \"cascade\" }),\n  isAwarded: boolean(\"is_awarded\").notNull().default(false), // false until shown in popup, true after\n  region: varchar(\"region\", { length: 20 }).notNull().default(\"GLOBAL\"), // 'GLOBAL' for User game, region code for Region game\n  gameType: varchar(\"game_type\", { length: 20 }).notNull().default(\"USER\"), // 'USER' or 'REGION'\n  awardedAt: timestamp(\"awarded_at\", { withTimezone: true }).defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"idx_user_badges_user_id\").on(table.userId),\n  badgeIdIdx: index(\"idx_user_badges_badge_id\").on(table.badgeId),\n}));\n\nexport const insertUserBadgeSchema = createInsertSchema(userBadges).omit({\n  id: true,\n  awardedAt: true,\n});\n\nexport type InsertUserBadge = z.infer<typeof insertUserBadgeSchema>;\nexport type UserBadge = typeof userBadges.$inferSelect;\n\n// Type for user badge with badge details joined\nexport interface UserBadgeWithDetails extends UserBadge {\n  badge: Badge;\n}\n\n// Admin Settings table - stores configurable system settings\nexport const adminSettings = pgTable(\"admin_settings\", {\n  id: serial(\"id\").primaryKey(),\n  key: varchar(\"key\", { length: 100 }).notNull().unique(),\n  value: text(\"value\").notNull(),\n  description: text(\"description\"),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  updatedBy: uuid(\"updated_by\").references(() => userProfiles.id),\n});\n\nexport const insertAdminSettingSchema = createInsertSchema(adminSettings).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport type InsertAdminSetting = z.infer<typeof insertAdminSettingSchema>;\nexport type AdminSetting = typeof adminSettings.$inferSelect;\n\n// Demand Scheduler Config - stored in Supabase (not via Drizzle)\n// This table must be created in Supabase SQL editor:\n// create table public.demand_scheduler_config (\n//   id uuid primary key default gen_random_uuid(),\n//   start_time text not null, -- format 'HH:mm'\n//   frequency_hours integer not null check (frequency_hours > 0),\n//   updated_at timestamp with time zone default now(),\n//   updated_by uuid references user_profiles(id)\n// );\nexport const demandSchedulerConfigSchema = z.object({\n  id: z.string().uuid(),\n  start_time: z.string().regex(/^\\d{2}:\\d{2}$/, \"Must be in HH:mm format\"),\n  frequency_hours: z.number().int().positive(),\n  updated_at: z.string().optional(),\n  updated_by: z.string().uuid().optional().nullable(),\n});\n\nexport type DemandSchedulerConfig = z.infer<typeof demandSchedulerConfigSchema>;\n\nexport const insertDemandSchedulerConfigSchema = demandSchedulerConfigSchema.omit({\n  id: true,\n  updated_at: true,\n});\n\nexport type InsertDemandSchedulerConfig = z.infer<typeof insertDemandSchedulerConfigSchema>;\n\n// ============================================================================\n// STRIPE PROMOTIONS TABLES\n// ============================================================================\n\n// Promotions table - defines available promotion codes and discounts\nexport const promotions = pgTable(\"promotions\", {\n  id: uuid(\"id\").primaryKey(),\n  code: text(\"code\").notNull().unique(), // Human-readable code like 'WELCOME60'\n  name: text(\"name\").notNull(), // Internal name\n  description: text(\"description\"),\n  \n  // Tier and billing targeting\n  tierType: text(\"tier_type\"), // e.g., 'pro'\n  billingPeriod: text(\"billing_period\"), // 'month', 'quarter', 'year'\n  \n  // Discount configuration\n  discountType: text(\"discount_type\").notNull(), // 'fixed' or 'percent'\n  discountValue: numeric(\"discount_value\", { precision: 10, scale: 2 }).notNull(), // GBP for fixed, % for percent\n  discountDurationMonths: integer(\"discount_duration_months\"), // null for once/trial, or repeating months\n  \n  // Eligibility requirements\n  requiresActive: boolean(\"requires_active\").default(false), // User must have active subscription\n  requiresLapsed: boolean(\"requires_lapsed\").default(false), // User must be a lapsed subscriber\n  \n  // Validity period\n  startsAt: timestamp(\"starts_at\", { withTimezone: true }).notNull(),\n  endsAt: timestamp(\"ends_at\", { withTimezone: true }), // null for no end date\n  \n  // Stripe integration\n  stripeCouponId: text(\"stripe_coupon_id\"), // Stripe Coupon ID\n  stripePromotionCodeId: text(\"stripe_promotion_code_id\"), // Stripe Promotion Code ID\n  \n  active: boolean(\"active\").default(true),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n}, (table) => ({\n  activeIdx: index(\"idx_promotions_active\").on(table.active),\n  codeIdx: index(\"idx_promotions_code\").on(table.code),\n  dateRangeIdx: index(\"idx_promotions_date_range\").on(table.startsAt, table.endsAt),\n}));\n\nexport const insertPromotionSchema = createInsertSchema(promotions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertPromotion = z.infer<typeof insertPromotionSchema>;\nexport type Promotion = typeof promotions.$inferSelect;\n\n// User Promo Grants table - tracks promotions granted to specific users\nexport const userPromoGrants = pgTable(\"user_promo_grants\", {\n  id: uuid(\"id\").primaryKey(),\n  userId: uuid(\"user_id\").notNull().references(() => userProfiles.id, { onDelete: \"cascade\" }),\n  promotionId: uuid(\"promotion_id\").notNull().references(() => promotions.id, { onDelete: \"cascade\" }),\n  promotionCode: text(\"promotion_code\").notNull(), // Copy of promotions.code for quick lookup\n  \n  // Grant status\n  status: text(\"status\").default(\"granted\"), // 'granted', 'redeemed', 'expired', 'revoked'\n  \n  // Timestamps\n  grantedAt: timestamp(\"granted_at\", { withTimezone: true }).defaultNow(),\n  expiresAt: timestamp(\"expires_at\", { withTimezone: true }), // When the grant expires if not redeemed\n  redeemedAt: timestamp(\"redeemed_at\", { withTimezone: true }), // When the user redeemed the promotion\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"idx_user_promo_grants_user_id\").on(table.userId),\n  statusIdx: index(\"idx_user_promo_grants_status\").on(table.status),\n  expiresAtIdx: index(\"idx_user_promo_grants_expires_at\").on(table.expiresAt),\n}));\n\nexport const insertUserPromoGrantSchema = createInsertSchema(userPromoGrants).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertUserPromoGrant = z.infer<typeof insertUserPromoGrantSchema>;\nexport type UserPromoGrant = typeof userPromoGrants.$inferSelect;\n","path":null,"size_bytes":35855,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/EndGameModal.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport happyHamster from \"@assets/Celebration-Hamster-Grey.svg\";\nimport sadHamster from \"@assets/Commiseration-Hamster-Grey.svg\";\nimport happyHamsterDark from \"@assets/Celebration-Hamster-DarkMode.svg\";\nimport sadHamsterDark from \"@assets/Commiseration-Hamster-DarkMode.svg\";\nimport historianHamsterBlue from \"@assets/Historian-Hamster-Blue.svg\";\nimport librarianHamsterYellow from \"@assets/Librarian-Hamster-Yellow.svg\";\nimport mathsHamsterGreen from \"@assets/Maths-Hamster-Green.svg\";\nimport historianHamsterLocal from \"@assets/Historian-Hamster-Local.svg\";\nimport librarianHamsterLocal from \"@assets/Librarian-Hamster-Local.svg\";\nimport mathsHamsterLocal from \"@assets/Maths-Hamster-Local.svg\";\nimport { useEffect, useState } from \"react\";\nimport { Home, BarChart3, Archive } from \"lucide-react\";\nimport { formatFullDateWithOrdinal, formatDateWithOrdinal } from \"@/lib/dateFormat\";\nimport { soundManager } from \"@/lib/sounds\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useProfile } from \"@/hooks/useProfile\";\nimport { useUserDateFormat } from \"@/hooks/useUserDateFormat\";\nimport { motion } from \"framer-motion\";\nimport { pageVariants, pageTransition } from \"@/lib/pageAnimations\";\n\ninterface EndGameModalProps {\n  isOpen: boolean;\n  isWin: boolean;\n  answerDateCanonical: string; // YYYY-MM-DD format - the canonical historical date\n  formattedAnswer: string; // The formatted answer in user's preference (e.g., \"010125\" or \"01011925\")\n  eventTitle: string;\n  eventDescription: string;\n  numGuesses?: number;\n  onPlayAgain: () => void;\n  onHome: () => void;\n  onViewStats?: () => void;\n  onViewArchive?: () => void;\n  isLocalMode?: boolean;\n  isGuest?: boolean;\n  onContinueToLogin?: () => void;\n}\n\nexport function EndGameModal({\n  isOpen,\n  isWin,\n  answerDateCanonical,\n  formattedAnswer,\n  eventTitle,\n  eventDescription,\n  numGuesses,\n  onPlayAgain,\n  onHome,\n  onViewStats,\n  onViewArchive,\n  isLocalMode = false,\n  isGuest = false,\n  onContinueToLogin,\n}: EndGameModalProps) {\n  const { isAuthenticated } = useAuth();\n  const { profile } = useProfile();\n  const { formatWithOrdinal } = useUserDateFormat();\n  const [showConfetti, setShowConfetti] = useState(false);\n  const [showRain, setShowRain] = useState(false);\n\n  // Select colors and hamster images based on mode\n  const statsColor = isLocalMode ? \"#93cd78\" : \"#A4DB57\";\n  const homeColor = isLocalMode ? \"#66becb\" : \"#7DAAE8\";\n  const archiveColor = isLocalMode ? \"#fdab58\" : \"#FFD429\";\n  \n  const historianHamster = isLocalMode ? historianHamsterLocal : historianHamsterBlue;\n  const librarianHamster = isLocalMode ? librarianHamsterLocal : librarianHamsterYellow;\n  const mathsHamster = isLocalMode ? mathsHamsterLocal : mathsHamsterGreen;\n\n  useEffect(() => {\n    if (isOpen) {\n      if (isWin) {\n        soundManager.playCelebration();\n        setShowConfetti(true);\n        setShowRain(false);\n      } else {\n        soundManager.playCommiseration();\n        setShowRain(true);\n        setShowConfetti(false);\n      }\n    } else {\n      setShowConfetti(false);\n      setShowRain(false);\n    }\n  }, [isOpen, isWin]);\n\n  if (!isOpen) return null;\n\n  return (\n    <motion.div \n      className=\"fixed inset-0 bg-background z-50 overflow-y-auto\" \n      data-testid=\"end-game-modal\"\n      initial={pageVariants.fadeIn.initial}\n      animate={pageVariants.fadeIn.animate}\n      exit={pageVariants.fadeIn.exit}\n      transition={pageTransition}\n    >\n      <div className=\"min-h-screen p-4 pt-8\">\n        <div className=\"w-full max-w-md mx-auto space-y-6\">\n          <h2 className=\"text-center text-3xl font-bold\">\n            {isWin ? \"Congratulations!\" : \"Unlucky!\"}\n          </h2>\n\n          <div className=\"relative flex justify-center my-4\">\n            {/* Light mode hamster */}\n            <img\n              src={isWin ? happyHamster : sadHamster}\n              alt={isWin ? \"Happy hamster\" : \"Sad hamster\"}\n              className={`${isWin ? \"max-w-[150px]\" : \"max-w-[150px]\"} w-full h-auto object-contain ${!isWin ? \"animate-fade-in\" : \"\"} block dark:hidden`}\n              data-testid=\"hamster-image\"\n            />\n\n            {/* Dark mode hamster */}\n            <img\n              src={isWin ? happyHamsterDark : sadHamsterDark}\n              alt={isWin ? \"Happy hamster dark\" : \"Sad hamster dark\"}\n              className={`${isWin ? \"max-w-[150px]\" : \"max-w-[150px]\"} w-full h-auto object-contain ${!isWin ? \"animate-fade-in\" : \"\"} hidden dark:block`}\n              data-testid=\"hamster-image-dark\"\n            />\n\n            {showConfetti && (\n              <div className=\"confetti-container\">\n                {Array.from({ length: 20 }).map((_, i) => (\n                  <div\n                    key={i}\n                    className=\"confetti\"\n                    style={{\n                      left: `${Math.random() * 100}%`,\n                      animationDelay: `${Math.random() * 0.5}s`,\n                      backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ec4899'][Math.floor(Math.random() * 4)],\n                    }}\n                  />\n                ))}\n              </div>\n            )}\n\n            {showRain && (\n              <div className=\"rain-container\">\n                {Array.from({ length: 40 }).map((_, i) => (\n                  <div\n                    key={i}\n                    className=\"raindrop\"\n                    style={{\n                      left: `${Math.random() * 100}%`,\n                      animationDuration: `${1 + Math.random() * 1.5}s`,\n                      animationDelay: `${Math.random() * 2}s`,\n                    }}\n                  />\n                ))}\n              </div>\n            )}\n          </div>\n\n          <div className=\"space-y-4 text-center\">\n            <p\n              className=\"text-2xl font-bold truncate max-w-full overflow-hidden text-ellipsis\"\n              data-testid=\"text-target-date\"\n            >\n              {formatWithOrdinal(answerDateCanonical)}\n            </p>\n\n            <div className=\"bg-muted p-4 rounded-lg space-y-2\">\n              <h3 className=\"font-semibold text-lg\" data-testid=\"text-event-title\">\n                {eventTitle}\n              </h3>\n              <p className=\"text-sm text-muted-foreground\" data-testid=\"text-event-description\">\n                {eventDescription}\n              </p>\n            </div>\n\n            {isWin && numGuesses && (\n              <p className=\"text-sm text-muted-foreground\">\n                You solved it in {numGuesses} {numGuesses === 1 ? \"guess\" : \"guesses\"}!\n              </p>\n            )}\n          </div>\n\n          {isGuest && onContinueToLogin ? (\n            <div className=\"space-y-3\">\n              <Button\n                className=\"w-full h-16 sm:h-20 md:h-24 text-lg sm:text-xl md:text-2xl font-bold bg-blue-500 hover:bg-blue-600 text-white\"\n                onClick={onContinueToLogin}\n                data-testid=\"button-continue-to-login\"\n              >\n                Continue\n              </Button>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {/* Stats button: full width, color based on mode */}\n              <button\n                className=\"w-full h-16 sm:h-20 md:h-24 flex items-center justify-between px-6 rounded-3xl shadow-sm hover:shadow-md\"\n                style={{ backgroundColor: statsColor }}\n                onClick={onViewStats}\n                data-testid=\"button-stats\"\n              >\n                <span className=\"text-lg sm:text-xl md:text-2xl font-bold text-gray-800\">Stats</span>\n                <div className=\"flex-shrink-0 flex items-center\">\n                  <img\n                    src={mathsHamster}\n                    alt=\"Stats\"\n                    className=\"h-14 sm:h-16 md:h-20 w-auto object-contain\"\n                  />\n                </div>\n              </button>\n\n              <div className=\"flex gap-3\">\n                {/* Home button: half width, color based on mode */}\n                <button\n                  className=\"flex-1 h-16 sm:h-20 md:h-24 flex items-center justify-between px-4 rounded-3xl shadow-sm hover:shadow-md\"\n                  style={{ backgroundColor: homeColor }}\n                  onClick={onHome}\n                  data-testid=\"button-home\"\n                >\n                  <span className=\"text-base sm:text-lg md:text-xl font-bold text-gray-800\">Home</span>\n                  <div className=\"flex-shrink-0 flex items-center\">\n                    <img\n                      src={historianHamster}\n                      alt=\"Home\"\n                      className=\"h-14 sm:h-16 md:h-20 w-auto object-contain\"\n                    />\n                  </div>\n                </button>\n\n                {/* Archive button: half width, color based on mode */}\n                <button\n                  className=\"flex-1 h-16 sm:h-20 md:h-24 flex items-center justify-between px-4 rounded-3xl shadow-sm hover:shadow-md\"\n                  style={{ backgroundColor: archiveColor }}\n                  onClick={onViewArchive}\n                  data-testid=\"button-archive\"\n                >\n                  <div className=\"flex flex-col items-start flex-1\">\n                    <span className=\"text-base sm:text-lg md:text-xl font-bold text-gray-800\">Archive</span>\n                  </div>\n                  <div className=\"flex-shrink-0 flex items-center\">\n                    <img\n                      src={librarianHamster}\n                      alt=\"Archive\"\n                      className=\"h-14 sm:h-16 md:h-20 w-auto object-contain\"\n                    />\n                  </div>\n                </button>\n              </div>\n            </div>\n          )}\n\n\n\n      </div>\n    </div>\n\n      <style>{`\n        .confetti-container {\n          position: absolute;\n          top: 0;\n          left: 0;\n          right: 0;\n          height: 100%;\n          pointer-events: none;\n          overflow: hidden;\n        }\n        \n        .confetti {\n          position: absolute;\n          width: 8px;\n          height: 8px;\n          top: 0;\n          animation: confetti-fall 2s linear infinite;\n        }\n        \n        .animate-fade-in {\n          animation: fade-in 0.8s ease-in forwards;\n        }\n        \n        @keyframes confetti-fall {\n          to {\n            transform: translateY(200px) rotate(360deg);\n            opacity: 0;\n          }\n        }\n        \n        @keyframes fade-in {\n          from {\n            opacity: 0;\n          }\n          to {\n            opacity: 1;\n          }\n        }\n\n        .rain-container {\n          position: absolute;\n          top: 0;\n          left: 0;\n          right: 0;\n          height: 100%;\n          pointer-events: none;\n          overflow: hidden;\n        }\n\n        .raindrop {\n          position: absolute;\n          top: -20px;\n          width: 2px;\n          height: 12px;\n          background: linear-gradient(to bottom, #60a5fa, #3b82f6); /* light to darker blue */\n          opacity: 0.7;\n          border-radius: 1px;\n          animation: rain-fall linear infinite;\n        }\n\n        @keyframes rain-fall {\n          to {\n            transform: translateY(110vh);\n            opacity: 0.2;\n          }\n        }\n        \n      `}</style>\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":11292,"size_tokens":null},"client/src/components/ArchivePage.tsx":{"content":"import { useState, useEffect, useRef, useCallback, useMemo } from \"react\";\nimport { useQueryClient, useQuery } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { ArrowLeft, ChevronLeft, ChevronRight, X } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useProfile } from \"@/hooks/useProfile\";\nimport { useGameData } from \"@/hooks/useGameData\";\nimport { useUserDateFormat } from \"@/hooks/useUserDateFormat\";\nimport { useGameMode } from \"@/contexts/GameModeContext\";\nimport { useRealtimeSubscriptions } from \"@/hooks/useRealtimeSubscriptions\";\nimport { readLocal, writeLocal, CACHE_KEYS } from \"@/lib/localCache\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { pageVariants, pageTransition } from \"@/lib/pageAnimations\";\nimport { useSwipeable } from \"react-swipeable\";\nimport { useMotionValue, animate } from \"framer-motion\";\nimport { useAdBannerActive } from \"@/components/AdBanner\";\nimport { useStreakSaverStatus } from \"@/hooks/useStreakSaverStatus\";\n\ninterface ArchivePageProps {\n  onBack: () => void;\n  onPlayPuzzle: (puzzleId: string) => void;\n  puzzles: Array<{\n    id: number;\n    date: string;\n    answerDateCanonical: string;\n    eventTitle: string;\n    eventDescription: string;\n    clue1?: string;\n    clue2?: string;\n  }>;\n  initialMonth?: Date | null;\n  onMonthChange?: (month: Date) => void;\n}\n\ninterface DayStatus {\n  completed: boolean;\n  won: boolean;\n  guessCount?: number;\n  inProgress?: boolean;\n  isHoliday?: boolean;\n}\n\nexport function ArchivePage({ onBack, onPlayPuzzle, puzzles, initialMonth, onMonthChange }: ArchivePageProps) {\n  const { user, isAuthenticated } = useAuth();\n  const { profile } = useProfile();\n  const { gameAttempts, loadingAttempts } = useGameData();\n  const { formatCanonicalDate } = useUserDateFormat();\n  const { isLocalMode } = useGameMode();\n  const queryClient = useQueryClient();\n  const adBannerActive = useAdBannerActive();\n  const { holidayActive } = useStreakSaverStatus();\n  // Set up realtime subscriptions for automatic UI refresh when database changes occur\n  useRealtimeSubscriptions({\n    userId: user?.id,\n    region: profile?.region || 'UK',\n    isAuthenticated,\n  });\n\n  // Force immediate data refresh on mount for authenticated users\n  // This ensures fresh data is fetched every time user navigates to Archive\n  const hasMountedRef = useRef(false);\n  useEffect(() => {\n    if (isAuthenticated && !hasMountedRef.current) {\n      hasMountedRef.current = true;\n      console.log('[ArchivePage] Mount: forcing data refresh for authenticated user');\n      // Refetch puzzles and game attempts\n      queryClient.refetchQueries({ queryKey: ['/api/user/puzzles'] });\n      queryClient.refetchQueries({ queryKey: ['/api/puzzles'] });\n      queryClient.refetchQueries({ queryKey: ['/api/user/game-attempts/user'] });\n      queryClient.refetchQueries({ queryKey: ['/api/game-attempts/user'] });\n    }\n  }, [isAuthenticated, queryClient]);\n\n  \n  const [currentMonth, setCurrentMonth] = useState(() => {\n    if (initialMonth) {\n      return new Date(initialMonth);\n    }\n    const now = new Date();\n    return new Date(now.getFullYear(), now.getMonth(), 1);\n  });\n  const [dayStatuses, setDayStatuses] = useState<Record<string, DayStatus>>({});\n  const [showMonthPicker, setShowMonthPicker] = useState(false);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const x = useMotionValue(0);\n  const swipeStartX = useRef<number>(0);\n\n  useEffect(() => {\n    if (initialMonth) {\n      const newMonth = new Date(initialMonth);\n      setCurrentMonth(newMonth);\n    }\n  }, [initialMonth]);\n\n  useEffect(() => {\n    const monthKey = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;\n    const cachedMonthData = readLocal<any>(`${CACHE_KEYS.ARCHIVE_PREFIX}${monthKey}`);\n    \n    if (cachedMonthData && Array.isArray(cachedMonthData)) {\n      const statusMap: Record<string, DayStatus> = {};\n      cachedMonthData.forEach((puzzle: any) => {\n        if (puzzle.completed && puzzle.date) {\n          statusMap[puzzle.date] = {\n            completed: true,\n            won: puzzle.won || false,\n            guessCount: puzzle.guessCount || 0\n          };\n        }\n      });\n      setDayStatuses(statusMap);\n    }\n  }, [currentMonth]);\n\n  useEffect(() => {\n    if (isAuthenticated && gameAttempts && !loadingAttempts) {\n      const statusMap: Record<string, DayStatus> = {};\n      gameAttempts.forEach(attempt => {\n        const embeddedPuzzle = (attempt as any).puzzle;\n        const puzzle = embeddedPuzzle || puzzles.find(p => p.id === attempt.puzzleId);\n        \n        const puzzleDate = puzzle?.date || embeddedPuzzle?.date;\n        if (puzzleDate) {\n          const isCompleted = attempt.result !== null;\n          const isWon = attempt.result === \"won\";\n          const isInProgress = attempt.result === null && (attempt.numGuesses ?? 0) > 0;\n          // Holiday day: any row with streak_day_status=0 should have yellow border\n          // This applies to ALL historical holiday days, regardless of whether played\n          const streakDayStatus = (attempt as any).streakDayStatus;\n          const isHoliday = streakDayStatus === 0;\n          \n          statusMap[puzzleDate] = {\n            completed: isCompleted,\n            won: isWon,\n            guessCount: attempt.numGuesses ?? 0,\n            inProgress: isInProgress,\n            isHoliday: isHoliday,\n          };\n        }\n      });\n      \n      setDayStatuses(statusMap);\n      \n      const monthKey = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;\n      const monthPuzzles = puzzles.map(puzzle => ({\n        ...puzzle,\n        completed: statusMap[puzzle.date]?.completed || false,\n        won: statusMap[puzzle.date]?.won || false,\n        guessCount: statusMap[puzzle.date]?.guessCount || 0,\n      }));\n      writeLocal(`${CACHE_KEYS.ARCHIVE_PREFIX}${monthKey}`, monthPuzzles);\n    } else if (!isAuthenticated) {\n      const storedStats = localStorage.getItem(\"elementle-stats\");\n      const stats = storedStats ? JSON.parse(storedStats) : { puzzleCompletions: {} };\n      \n      const statusMap: Record<string, DayStatus> = {};\n      const completions = stats.puzzleCompletions || {};\n      \n      puzzles.forEach(puzzle => {\n        const formattedAnswer = formatCanonicalDate(puzzle.answerDateCanonical);\n        const completion = completions[formattedAnswer];\n        \n        if (completion && puzzle.date) {\n          statusMap[puzzle.date] = {\n            completed: completion.completed || false,\n            won: completion.won || false,\n            guessCount: completion.guessCount,\n            inProgress: !completion.completed && (completion.guessCount > 0)\n          };\n        }\n      });\n      \n      setDayStatuses(statusMap);\n    }\n  }, [isAuthenticated, gameAttempts, puzzles, currentMonth, loadingAttempts]);\n\n  const getDaysInMonth = (date: Date) => {\n    const year = date.getFullYear();\n    const month = date.getMonth();\n    const firstDay = new Date(year, month, 1);\n    const lastDay = new Date(year, month + 1, 0);\n    const daysInMonth = lastDay.getDate();\n    const startingDayOfWeek = firstDay.getDay();\n    \n    return { daysInMonth, startingDayOfWeek };\n  };\n\n  const getPuzzleForDay = (day: number, month: Date) => {\n    const year = month.getFullYear();\n    const monthStr = String(month.getMonth() + 1).padStart(2, '0');\n    const dayStr = String(day).padStart(2, '0');\n    const puzzleDate = `${year}-${monthStr}-${dayStr}`;\n    \n    return puzzles.find(p => p.date === puzzleDate);\n  };\n\n  const getDayStatus = (day: number, month: Date): DayStatus | null => {\n    const year = month.getFullYear();\n    const monthStr = String(month.getMonth() + 1).padStart(2, '0');\n    const dayStr = String(day).padStart(2, '0');\n    const puzzleDate = `${year}-${monthStr}-${dayStr}`;\n    \n    return dayStatuses[puzzleDate] || null;\n  };\n\n  // Compute the set of consecutive holiday dates going backwards from today (when holidayActive)\n  const activeHolidayDates = useMemo(() => {\n    const dates = new Set<string>();\n    if (!holidayActive) return dates;\n    \n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    \n    // Walk backwards from today, collecting consecutive holiday days\n    let currentDate = new Date(today);\n    while (true) {\n      const year = currentDate.getFullYear();\n      const monthStr = String(currentDate.getMonth() + 1).padStart(2, '0');\n      const dayStr = String(currentDate.getDate()).padStart(2, '0');\n      const dateStr = `${year}-${monthStr}-${dayStr}`;\n      \n      const status = dayStatuses[dateStr];\n      if (status?.isHoliday) {\n        dates.add(dateStr);\n        // Move to previous day\n        currentDate.setDate(currentDate.getDate() - 1);\n      } else {\n        break; // Stop when we hit a non-holiday day\n      }\n    }\n    \n    return dates;\n  }, [holidayActive, dayStatuses]);\n\n  const renderCalendarDays = (month: Date) => {\n    const { daysInMonth, startingDayOfWeek } = getDaysInMonth(month);\n    const days = [];\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n\n    for (let i = 0; i < startingDayOfWeek; i++) {\n      days.push(<div key={`empty-${i}`} className=\"aspect-square\" />);\n    }\n\n    for (let day = 1; day <= daysInMonth; day++) {\n      const puzzle = getPuzzleForDay(day, month);\n      const status = getDayStatus(day, month);\n\n      const puzzleDate = new Date(month.getFullYear(), month.getMonth(), day);\n      puzzleDate.setHours(0, 0, 0, 0);\n      const isFuture = puzzleDate > today;\n      const isToday = puzzleDate.getTime() === today.getTime();\n      const isPlayable = puzzle && !isFuture;\n      \n      // Check if this date is in the active holiday period (consecutive from today)\n      const year = month.getFullYear();\n      const monthStr = String(month.getMonth() + 1).padStart(2, '0');\n      const dayStr = String(day).padStart(2, '0');\n      const dateStr = `${year}-${monthStr}-${dayStr}`;\n      const isActiveHolidayDate = activeHolidayDates.has(dateStr);\n\n      days.push(\n        <div\n          key={day}\n          className={cn(\n            \"aspect-square p-2 flex flex-col items-center justify-center transition-all min-h-[48px] min-w-[48px] rounded-md\",\n            isPlayable && \"cursor-pointer hover-elevate\",\n            !isPlayable && \"cursor-not-allowed\",\n            // Background colors - priority order: completed > in-progress > default\n            status?.completed && status.won && \"bg-green-100 dark:bg-green-900/30\",\n            status?.completed && !status.won && \"bg-red-100 dark:bg-red-900/30\",\n            status?.inProgress && \"bg-blue-100 dark:bg-blue-900/30\",\n            // Default gray for playable days with no status (including unplayed holiday days)\n            !status?.completed && !status?.inProgress && isPlayable && \"bg-gray-100 dark:bg-gray-800\",\n            (!puzzle || isFuture) && \"bg-background opacity-40\",\n            // Ring/border styles - holiday dates get bright yellow border\n            isActiveHolidayDate && \"ring-2 ring-yellow-300 dark:ring-yellow-300\",\n            status?.isHoliday && !isActiveHolidayDate && \"ring-2 ring-yellow-300 dark:ring-yellow-300\",\n            // Today ring only if not a holiday day\n            isToday && !status?.isHoliday && !isActiveHolidayDate && \"ring-2 ring-gray-500 dark:ring-gray-400\"\n          )}\n          onClick={() => isPlayable && onPlayPuzzle(puzzle.id.toString())}\n          data-testid={`calendar-day-${day}`}\n        >\n          <span className={cn(\n            \"text-sm font-semibold\",\n            // Text color priority: completed > in-progress > default\n            status?.completed && status.won && \"text-green-700 dark:text-green-300\",\n            status?.completed && !status.won && \"text-red-700 dark:text-red-300\",\n            status?.inProgress && \"text-blue-700 dark:text-blue-300\",\n            !status?.completed && !status?.inProgress && isPlayable && \"text-foreground\",\n            (!puzzle || isFuture) && \"text-muted-foreground\"\n          )}>\n            {day}\n          </span>\n          {status?.completed && (\n            <span className=\"text-xs mt-1 opacity-70\">\n              {status.won ? ` ${status.guessCount}` : ''}\n            </span>\n          )}\n          {status?.inProgress && (\n            <span className=\"text-xs mt-1 opacity-70\">\n              {status.guessCount}\n            </span>\n          )}\n        </div>\n      );\n    }\n\n    return days;\n  };\n\n  const monthYear = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });\n  \n  const earliestMonth = (() => {\n    if (puzzles.length === 0) {\n      return new Date(2025, 9, 1);\n    }\n    \n    const earliestPuzzle = puzzles.reduce((earliest, puzzle) => {\n      return puzzle.date < earliest.date ? puzzle : earliest;\n    }, puzzles[0]);\n    \n    const [year, month, day] = earliestPuzzle.date.split('-').map(Number);\n    return new Date(year, month - 1, 1);\n  })();\n  \n  const currentDate = new Date();\n  const currentMonthDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);\n  \n  const canGoPrevious = currentMonth > earliestMonth;\n  const canGoNext = currentMonth < currentMonthDate;\n\n  const hasMonthPuzzles = (year: number, month: number) => {\n    const monthStr = String(month + 1).padStart(2, '0');\n    return puzzles.some(p => p.date.startsWith(`${year}-${monthStr}`));\n  };\n\n  const handleSwipeStart = useCallback(() => {\n    swipeStartX.current = x.get();\n  }, [x]);\n\n  const handleSwiping = useCallback((deltaX: number) => {\n    const newX = swipeStartX.current + deltaX;\n    x.set(newX);\n  }, [x]);\n\n  const handleSwiped = useCallback((velocity: number, direction: 'Left' | 'Right') => {\n    const threshold = 50;\n    const velocityThreshold = 0.5;\n    const currentX = x.get();\n    \n    let shouldNavigate = false;\n    let navigateDirection: 'prev' | 'next' | null = null;\n\n    if (Math.abs(velocity) > velocityThreshold) {\n      if (direction === 'Left' && canGoNext) {\n        shouldNavigate = true;\n        navigateDirection = 'next';\n      } else if (direction === 'Right' && canGoPrevious) {\n        shouldNavigate = true;\n        navigateDirection = 'prev';\n      }\n    } else if (Math.abs(currentX) > threshold) {\n      if (currentX > 0 && canGoPrevious) {\n        shouldNavigate = true;\n        navigateDirection = 'prev';\n      } else if (currentX < 0 && canGoNext) {\n        shouldNavigate = true;\n        navigateDirection = 'next';\n      }\n    }\n\n    if (shouldNavigate && navigateDirection) {\n      if (navigateDirection === 'next') {\n        const nextMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);\n        setCurrentMonth(nextMonth);\n        onMonthChange?.(nextMonth);\n      } else if (navigateDirection === 'prev') {\n        const prevMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);\n        setCurrentMonth(prevMonth);\n        onMonthChange?.(prevMonth);\n      }\n    }\n\n    animate(x, 0, { duration: 0.3, ease: 'easeOut' });\n  }, [x, currentMonth, canGoNext, canGoPrevious, onMonthChange]);\n\n  const swipeHandlers = useSwipeable({\n    onSwipeStart: handleSwipeStart,\n    onSwiping: (eventData) => handleSwiping(eventData.deltaX),\n    onSwiped: (eventData) => {\n      handleSwiped(eventData.velocity, eventData.dir as 'Left' | 'Right');\n    },\n    trackMouse: true,\n    preventScrollOnSwipe: true,\n  });\n\n  const { ref: swipeRef, ...swipeProps } = swipeHandlers;\n\n  return (\n    <motion.div \n      className={`min-h-screen flex flex-col p-4 bg-background touch-none overflow-hidden ${adBannerActive ? 'pb-[50px]' : ''}`}\n      initial={pageVariants.slideLeft.initial}\n      animate={pageVariants.slideLeft.animate}\n      exit={pageVariants.slideLeft.exit}\n      transition={pageTransition}\n    >\n      <div className=\"flex items-center justify-between mb-8\">\n        <button\n          onClick={onBack}\n          data-testid=\"button-back\"\n          className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n        >\n          <ChevronLeft className=\"h-10 w-10 text-gray-700\" />\n        </button>\n\n        <h2 className=\"text-4xl font-bold\">Archive</h2>\n\n        <div className=\"w-14\" />\n      </div>\n\n      <div className=\"flex-1 w-full max-w-[31.5rem] mx-auto flex flex-col\">\n        <div className=\"mb-6 flex items-center justify-between\">\n          <Button\n            variant=\"outline\"\n            size=\"icon\"\n            onClick={() => {\n              const newMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);\n              setCurrentMonth(newMonth);\n              onMonthChange?.(newMonth);\n            }}\n            disabled={!canGoPrevious}\n            data-testid=\"button-prev-month\"\n          >\n            <ChevronLeft className=\"h-4 w-4\" />\n          </Button>\n          \n          <button\n            onClick={() => setShowMonthPicker(true)}\n            className=\"text-xl font-bold hover:opacity-70 transition-opacity cursor-pointer\"\n            data-testid=\"button-month-picker\"\n          >\n            {monthYear}\n          </button>\n          \n          <Button\n            variant=\"outline\"\n            size=\"icon\"\n            onClick={() => {\n              const newMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);\n              setCurrentMonth(newMonth);\n              onMonthChange?.(newMonth);\n            }}\n            disabled={!canGoNext}\n            data-testid=\"button-next-month\"\n          >\n            <ChevronRight className=\"h-4 w-4\" />\n          </Button>\n        </div>\n\n        <div className=\"grid grid-cols-7 gap-2 mb-2\">\n          {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (\n            <div key={day} className=\"text-center text-sm font-semibold text-muted-foreground\">\n              {day}\n            </div>\n          ))}\n        </div>\n\n        {/* Swipeable Calendar Container */}\n        <div\n          ref={containerRef}\n          className=\"flex-grow overflow-hidden p-2 -m-2\"\n          {...swipeProps}\n        >\n          <motion.div\n            className=\"grid grid-cols-7 gap-2\"\n            style={{ x }}\n            initial={{ x: 0 }}\n          >\n            {renderCalendarDays(currentMonth)}\n          </motion.div>\n        </div>\n      </div>\n\n      {/* Month/Year Picker Modal */}\n      <AnimatePresence>\n        {showMonthPicker && (\n          <motion.div\n            className=\"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50\"\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            onClick={() => setShowMonthPicker(false)}\n          >\n            <motion.div\n              className=\"bg-white dark:bg-gray-900 rounded-lg p-6 max-w-sm w-full\"\n              initial={{ scale: 0.95 }}\n              animate={{ scale: 1 }}\n              exit={{ scale: 0.95 }}\n              onClick={(e) => e.stopPropagation()}\n            >\n              <div className=\"flex items-center justify-between mb-6\">\n                <h3 className=\"text-2xl font-bold\">Select Month</h3>\n                <button\n                  onClick={() => setShowMonthPicker(false)}\n                  className=\"p-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded transition-colors\"\n                  data-testid=\"button-close-picker\"\n                >\n                  <X className=\"h-5 w-5\" />\n                </button>\n              </div>\n\n              <div className=\"mb-6 flex items-center justify-between\">\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => {\n                    const newYear = new Date(currentMonth.getFullYear() - 1, currentMonth.getMonth(), 1);\n                    setCurrentMonth(newYear);\n                    setShowMonthPicker(false);\n                    onMonthChange?.(newYear);\n                  }}\n                  disabled={currentMonth.getFullYear() === earliestMonth.getFullYear()}\n                  data-testid=\"button-prev-year\"\n                >\n                  <ChevronLeft className=\"h-4 w-4\" />\n                </Button>\n\n                <span className=\"text-lg font-bold\" data-testid=\"text-year\">\n                  {currentMonth.getFullYear()}\n                </span>\n\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => {\n                    const newYear = new Date(currentMonth.getFullYear() + 1, currentMonth.getMonth(), 1);\n                    setCurrentMonth(newYear);\n                    setShowMonthPicker(false);\n                    onMonthChange?.(newYear);\n                  }}\n                  disabled={currentMonth.getFullYear() === currentMonthDate.getFullYear()}\n                  data-testid=\"button-next-year\"\n                >\n                  <ChevronRight className=\"h-4 w-4\" />\n                </Button>\n              </div>\n\n              <div className=\"grid grid-cols-3 gap-2\">\n                {Array.from({ length: 12 }).map((_, i) => {\n                  const hasData = hasMonthPuzzles(currentMonth.getFullYear(), i);\n                  const isFutureMonth = currentMonth.getFullYear() === currentDate.getFullYear() && i > currentDate.getMonth();\n                  const isSelectable = hasData && !isFutureMonth;\n                  const isSelected = i === currentMonth.getMonth();\n                  const monthName = new Date(2025, i, 1).toLocaleDateString('en-US', { month: 'short' });\n\n                  return (\n                    <button\n                      key={i}\n                      onClick={() => {\n                        if (isSelectable) {\n                          const newMonth = new Date(currentMonth.getFullYear(), i, 1);\n                          setCurrentMonth(newMonth);\n                          setShowMonthPicker(false);\n                          onMonthChange?.(newMonth);\n                        }\n                      }}\n                      disabled={!isSelectable}\n                      className={cn(\n                        \"py-2 px-3 rounded-md font-medium transition-colors\",\n                        isSelectable && \"cursor-pointer\",\n                        !isSelectable && \"opacity-40 cursor-not-allowed\",\n                        isSelected && isSelectable && \"bg-primary text-primary-foreground\",\n                        !isSelected && isSelectable && \"bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700\",\n                      )}\n                      data-testid={`button-month-${i}`}\n                    >\n                      {monthName}\n                    </button>\n                  );\n                })}\n              </div>\n            </motion.div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":22996,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/components/examples/WelcomePage.tsx":{"content":"import { WelcomePage } from '../WelcomePage';\n\nexport default function WelcomePageExample() {\n  return <WelcomePage onPlayWithoutSignIn={() => console.log('Play without sign in')} />;\n}\n","path":null,"size_bytes":186,"size_tokens":null},"client/src/components/examples/InputGrid.tsx":{"content":"import { InputGrid } from '../InputGrid';\n\nexport default function InputGridExample() {\n  const guesses = [\n    [\n      { digit: \"2\", state: \"notInSequence\" as const, arrow: \"down\" as const },\n      { digit: \"0\", state: \"correct\" as const },\n      { digit: \"0\", state: \"inSequence\" as const, arrow: \"up\" as const },\n      { digit: \"7\", state: \"correct\" as const },\n      { digit: \"6\", state: \"correct\" as const },\n      { digit: \"9\", state: \"correct\" as const },\n    ],\n  ];\n\n  return <InputGrid guesses={guesses} currentInput=\"1234\" maxGuesses={5} />;\n}\n","path":null,"size_bytes":555,"size_tokens":null},"client/src/components/InputGrid.tsx":{"content":"import { ArrowUp, ArrowDown } from \"lucide-react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { useRef, useEffect } from \"react\";\n\nexport type CellState = \"empty\" | \"correct\" | \"inSequence\" | \"notInSequence\";\n\nexport interface CellFeedback {\n  digit: string;\n  state: CellState;\n  arrow?: \"up\" | \"down\";\n}\n\ninterface InputGridProps {\n  guesses: CellFeedback[][];\n  currentInput: string;\n  maxGuesses: number;\n  placeholders?: string[];\n}\n\nexport function InputGrid({\n  guesses,\n  currentInput,\n  maxGuesses,\n  placeholders = [\"D\", \"D\", \"M\", \"M\", \"Y\", \"Y\"],\n}: InputGridProps) {\n  const numCells = placeholders.length;\n  const is8Digit = numCells === 8;\n  const prevInputLengthRef = useRef(currentInput.length);\n\n  // Detect when a digit is added to trigger animation\n  const digitJustAdded = currentInput.length > prevInputLengthRef.current;\n  \n  useEffect(() => {\n    prevInputLengthRef.current = currentInput.length;\n  }, [currentInput]);\n\n  const getCellClasses = (state: CellState, hasDigit: boolean = false) => {\n    switch (state) {\n      case \"correct\":\n        return \"bg-game-correct text-white border-game-correct\";\n      case \"inSequence\":\n        return \"bg-game-inSequence text-white border-game-inSequence\";\n      case \"notInSequence\":\n        return \"bg-game-notInSequence text-white border-game-notInSequence\";\n      default:\n        // For empty state, apply dark grey border if digit is present\n        return hasDigit ? \"bg-card border-[#4a4a4a] dark:border-[#6b6b6b]\" : \"bg-card border-border\";\n    }\n  };\n\n  const rows = Array.from({ length: maxGuesses }, (_, i) => {\n    if (i < guesses.length) return guesses[i];\n    if (i === guesses.length) {\n      return Array.from({ length: numCells }, (_, j) => ({\n        digit: currentInput[j] || \"\",\n        state: \"empty\" as CellState,\n      }));\n    }\n    return Array(numCells).fill({ digit: \"\", state: \"empty\" });\n  });\n\n  return (\n    <div className=\"space-y-2 w-full px-2\" data-testid=\"input-grid\">\n      {rows.map((row, rowIdx) => {\n        const isActiveRow = rowIdx === guesses.length;\n        const rowHasArrow = row.some(\n          (c) => c.state !== \"empty\" && typeof c.arrow !== \"undefined\"\n        );\n\n        // Only lower numbers if in 8-digit mode AND row has an arrow\n        const needsLowering = is8Digit && rowHasArrow;\n\n        return (\n          <div\n            key={rowIdx}\n            className=\"flex gap-1 sm:gap-2 justify-center w-full\"\n          >\n            {row.map((cell, cellIdx) => {\n              const showPlaceholder = isActiveRow && !cell.digit;\n              const cellHasDigit = isActiveRow && !!cell.digit;\n              const cellJustGotDigit = isActiveRow && digitJustAdded && cellIdx === currentInput.length - 1;\n\n              return (\n                <div\n                  key={`${rowIdx}-${cellIdx}`}\n                  className=\"\n                    relative flex-1 basis-0 shrink\n                    min-h-[56px] sm:min-h-[64px]\n                    max-w-[72px] sm:max-w-[80px] md:max-w-[96px]\n                  \"\n                  style={{ perspective: \"1000px\" }}\n                  data-testid={`cell-${rowIdx}-${cellIdx}`}\n                >\n                  <AnimatePresence mode=\"wait\">\n                    {cell.state !== \"empty\" ? (\n                      <motion.div\n                        key={`${rowIdx}-${cellIdx}-${cell.state}`}\n                        className={`\n                          absolute inset-0\n                          flex items-center justify-center\n                          border-2 rounded-md\n                          font-semibold\n                          text-3xl sm:text-3xl md:text-4xl lg:text-4xl\n                          ${getCellClasses(cell.state)}\n                          ${needsLowering ? \"pt-2\" : \"\"}\n                        `}\n                        initial={{ rotateX: 90, opacity: 0 }}\n                        animate={{ rotateX: 0, opacity: 1 }}\n                        exit={{ rotateX: -90, opacity: 0 }}\n                        transition={{ duration: 1, delay: cellIdx * 0.25 }}\n                      >\n                        {cell.digit}\n                        {cell.arrow && (\n                          <div className=\"absolute top-0.5 right-0.5\">\n                            {cell.arrow === \"up\" ? (\n                              <ArrowUp\n                                className={\n                                  is8Digit\n                                    ? \"h-3 w-3 sm:h-4 sm:w-4 md:h-5 md:w-5\" // small on phones, step up on larger\n                                    : \"h-4 w-4 sm:h-5 sm:w-5 md:h-6 md:w-6\"\n                                }\n                              />\n                            ) : (\n                              <ArrowDown\n                                className={\n                                  is8Digit\n                                    ? \"h-3 w-3 sm:h-4 sm:w-4 md:h-5 md:w-5\"\n                                    : \"h-4 w-4 sm:h-5 sm:w-5 md:h-6 md:w-6\"\n                                }\n                              />\n                            )}\n                          </div>\n                        )}\n                      </motion.div>\n                    ) : (\n                      <motion.div\n                        key={`${rowIdx}-${cellIdx}-empty`}\n                        className={`\n                          absolute inset-0\n                          flex items-center justify-center\n                          border-2 rounded-md\n                          font-semibold\n                          text-3xl sm:text-3xl md:text-4xl lg:text-4xl\n                          ${getCellClasses(cell.state, cellHasDigit)}\n                          ${needsLowering ? \"pt-2\" : \"\"}\n                          transition-colors duration-200\n                        `}\n                        animate={\n                          cellJustGotDigit\n                            ? {\n                                scale: [1, 1.08, 1],\n                                transition: { duration: 0.2, times: [0, 0.5, 1] }\n                              }\n                            : {}\n                        }\n                      >\n                        {cell.digit}\n                        <AnimatePresence>\n                          {showPlaceholder && (\n                            <motion.span\n                              key={`ph-${rowIdx}-${cellIdx}`}\n                              className=\"absolute text-muted-foreground opacity-30 font-normal pointer-events-none select-none\n                                         text-2xl sm:text-2xl md:text-3xl lg:text-3xl\"\n                              initial={{ opacity: 0 }}\n                              animate={{ opacity: 0.3, transition: { duration: 0.2 } }}\n                              exit={{ opacity: 0, transition: { duration: 0 } }}\n                            >\n                              {placeholders[cellIdx]}\n                            </motion.span>\n                          )}\n                        </AnimatePresence>\n                      </motion.div>\n                    )}\n                  </AnimatePresence>\n                </div>\n              );\n            })}\n          </div>\n        );\n      })}\n    </div>\n  );\n}\n","path":null,"size_bytes":7250,"size_tokens":null},"client/src/components/examples/GameSelectionPage.tsx":{"content":"import { GameSelectionPage } from '../GameSelectionPage';\n\nexport default function GameSelectionPageExample() {\n  return (\n    <div className=\"relative min-h-screen\">\n      <GameSelectionPage \n        onPlayGame={() => console.log('Play game')} \n        onViewStats={() => console.log('View stats')}\n        onViewArchive={() => console.log('View archive')}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":385,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"replit.md":{"content":"# Elementle - Daily Historical Date Puzzle Game\n\n## Overview\nElementle is a daily puzzle game inspired by NYT Games and Duolingo, where players guess historical dates. It is a full-stack web application designed for daily engagement and educational entertainment, featuring a hamster mascot and color-coded feedback. The project aims to engage players daily with historical events through a fun puzzle format, providing a blend of education and entertainment with market potential for broad appeal.\n\n## User Preferences\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### UI/UX Decisions\nThe application features a responsive, mobile-first design with a custom color palette and a \"New York\" style UI derived from Shadcn UI. Lottie animations are used for loading and game-specific visual feedback, including a hamster wheel spinner. The UI provides dynamic displays for subscription tiers, real-time updates, and an intro screen.\n\n### Technical Implementations\n- **Frontend**: React with TypeScript, Vite, Wouter for routing. State management uses TanStack Query for server state and local React state with LocalStorage for persistence. A `PreloadProvider` caches critical data for fast rendering.\n- **Backend**: Express.js with Node.js and TypeScript, currently using in-memory storage, designed for future PostgreSQL integration.\n- **Game Modes**: Supports Global and Local game modes with independent data handling, ensuring proper data loading and state management to prevent race conditions during mode switching.\n- **Authentication & User Management**: Direct email/password signup via Supabase, with OTP for email changes. Implements a comprehensive onboarding flow, Google OAuth sign-in, and specific handling for iOS PWA authentication challenges. Users are guided through a mandatory \"Personalise your game\" screen before accessing protected content. Session persistence is managed with a `useAuth` hook, including debounced auth guards and optimized session refreshing. Sign-out clears all caches and resets user-specific flags.\n- **OAuth Linking (Soft Unlink Design)**: user_profiles tracks google_linked/apple_linked (NULL=never used, TRUE=linked, FALSE=unlinked). Unlinking just sets DB to FALSE without revoking Supabase identity - allows instant re-connect without re-authorization. UI \"connected\" state is based on profile fields, not Supabase identity. Welcome back screen shows login options based on these profile fields.\n- **Subscription & Monetization**: Dynamic, database-driven Pro subscription tiers with regional pricing, including API endpoints for status, checkout, and renewal. Ad banners and interstitial ads are displayed for non-Pro users.\n- **Game Mechanics**: Client-side puzzle validation, feedback calculation, and LocalStorage-based statistics. Features include a Streak Saver system with tier-based allowances and a Pro-only Holiday Protection system to pause local puzzles.\n- **Badge System**: Achievements for milestones (Elementle In, Streak, Percentile) with a monthly cron job for percentile rankings. Badges are processed and celebrated via a dedicated popup and displayed on the Stats screen.\n- **Restrictions**: Cooldowns for location and category changes managed by admin settings and implemented with React Query.\n\n### System Design Choices\nThe architecture prioritizes client-side performance through data preloading and efficient state management. Authentication and user personalization are deeply integrated, ensuring a tailored experience. The system is designed for scalability with planned PostgreSQL integration and robust error handling for various user flows, including password recovery and OAuth linking. Modularity is emphasized through component-based UI development and clear separation of frontend and backend concerns.\n\n## External Dependencies\n\n- **Database**: Drizzle ORM for PostgreSQL (`@neondatabase/serverless`), `drizzle-kit`.\n- **UI Components**: Radix UI, Lucide React, cmdk, embla-carousel-react, date-fns.\n- **Form Handling**: React Hook Form with Zod, drizzle-zod.\n- **Authentication**: Supabase.\n- **Advertising**: Google AdMob.\n- **Animation**: Lottie.","path":null,"size_bytes":4167,"size_tokens":null},"client/src/components/examples/NumericKeyboard.tsx":{"content":"import { NumericKeyboard } from '../NumericKeyboard';\nimport { useState } from 'react';\n\nexport default function NumericKeyboardExample() {\n  const [input, setInput] = useState('');\n  \n  const keyStates = {\n    '1': 'ruledOut' as const,\n    '5': 'inSequence' as const,\n    '9': 'correct' as const,\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"text-center text-xl font-mono\">{input || 'Press keys...'}</div>\n      <NumericKeyboard\n        onDigitPress={(d) => setInput(input + d)}\n        onDelete={() => setInput(input.slice(0, -1))}\n        onClear={() => setInput('')}\n        onEnter={() => console.log('Enter:', input)}\n        keyStates={keyStates}\n        canSubmit={input.length === 8}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":746,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"client/src/components/examples/PlayPage.tsx":{"content":"import { PlayPage } from '../PlayPage';\n\nexport default function PlayPageExample() {\n  return (\n    <PlayPage\n      targetDate=\"200769\"\n      eventTitle=\"Apollo 11 Moon Landing\"\n      eventDescription=\"Neil Armstrong becomes the first human to set foot on the Moon.\"\n      maxGuesses={5}\n      onBack={() => console.log('Back')}\n      onViewStats={() => console.log('View Stats')}\n      onViewArchive={() => console.log('View Archive')}\n    />\n  );\n}\n","path":null,"size_bytes":451,"size_tokens":null},"client/src/components/GameSelectionPage.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { HelpDialog } from \"./HelpDialog\";\nimport { ModeToggle } from \"./ModeToggle\";\nimport { GoProButton } from \"./GoProButton\";\nimport { ProSubscriptionDialog } from \"./ProSubscriptionDialog\";\nimport { GuestRestrictionPopup } from \"./GuestRestrictionPopup\";\nimport { CategorySelectionScreen } from \"./CategorySelectionScreen\";\nimport { StreakSaverPopup, type StreakSaverCloseAction } from \"./StreakSaverPopup\";\nimport { BadgeCelebrationPopup } from \"./badges/BadgeCelebrationPopup\";\nimport { HolidayActivationOverlay } from \"./HolidayActivationOverlay\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useProfile } from \"@/hooks/useProfile\";\nimport { useGameData } from \"@/hooks/useGameData\";\nimport { useSubscription } from \"@/hooks/useSubscription\";\nimport { useStreakSaverStatus } from \"@/hooks/useStreakSaverStatus\";\nimport { useStreakSaver } from \"@/contexts/StreakSaverContext\";\nimport { useRealtimeSubscriptions } from \"@/hooks/useRealtimeSubscriptions\";\nimport { useCategoryRestriction } from \"@/hooks/useCategoryRestriction\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { motion, useTransform, AnimatePresence } from \"framer-motion\";\nimport { useSwipeable } from \"react-swipeable\";\nimport { useModeController } from \"@/hooks/useModeController\";\nimport { readLocal, writeLocal, CACHE_KEYS } from \"@/lib/localCache\";\nimport type { UserProfile, UserBadgeWithDetails } from \"@shared/schema\";\nimport { getSupabaseClient } from \"@/lib/supabaseClient\";\nimport { useUserDateFormat } from \"@/hooks/useUserDateFormat\";\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useAdBannerActive } from \"@/components/AdBanner\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport historianHamsterBlue from \"@assets/Historian-Hamster-Blue.svg\";\nimport historianHamsterLocal from \"@assets/Historian-Hamster-Local.svg\";\nimport librarianHamsterYellow from \"@assets/Librarian-Hamster-Yellow.svg\";\nimport librarianHamsterLocal from \"@assets/Librarian-Hamster-Local.svg\";\nimport mathsHamsterGreen from \"@assets/Maths-Hamster-Green.svg\";\nimport mathsHamsterLocal from \"@assets/Maths-Hamster-Local.svg\";\nimport mechanicHamsterGrey from \"@assets/Mechanic-Hamster-Grey.svg\";\nimport winhamsterblue from \"@assets/Win-Hamster-Blue.svg\";\nimport winhamsterlocal from \"@assets/Win-Hamster-Local.svg\";\nimport losthamsterblue from \"@assets/Lost-Hamster-Blue.svg\";\nimport losthamsterlocal from \"@assets/Lost-Hamster-Local.svg\";\nimport greyHelpIcon from \"@assets/Grey-Help-Grey_1760979822771.png\";\nimport greyCogIcon from \"@assets/Grey-Cog-Grey_1760979822772.png\";\nimport whiteHelpIcon from \"@assets/White-Help-DarkMode.svg\";\nimport whiteCogIcon from \"@assets/White-Cog-DarkMode.svg\";\n\ninterface TodayOutcome {\n  date: string;\n  puzzleId?: number;\n  isWin: boolean;\n  guessCount: number;\n}\n\ninterface GameSelectionPageProps {\n  onPlayGame: () => void;\n  onViewStats: () => void;\n  onViewArchive: () => void;\n  onOpenSettings?: () => void;\n  onOpenOptions?: () => void;\n  onLogin?: () => void;\n  onRegister?: () => void;\n  todayPuzzleId?: number;\n  todayPuzzleAnswerDateCanonical?: string;\n  onPlayGameLocal?: () => void;\n  onViewStatsLocal?: () => void;\n  onViewArchiveLocal?: () => void;\n  onOpenOptionsLocal?: () => void;\n  onPlayYesterdaysPuzzle?: (gameType: \"region\" | \"user\", puzzleDate: string) => void;\n  onViewStatsWithBadge?: (badge: UserBadgeWithDetails, gameType: 'USER' | 'REGION') => void;\n  initialShowProDialog?: boolean;\n  onProDialogShown?: () => void;\n}\n\nexport function GameSelectionPage({ \n  onPlayGame, \n  onViewStats, \n  onViewArchive, \n  onOpenSettings, \n  onOpenOptions, \n  onLogin,\n  onRegister, \n  todayPuzzleId, \n  todayPuzzleAnswerDateCanonical,\n  onPlayGameLocal,\n  onViewStatsLocal,\n  onViewArchiveLocal,\n  onOpenOptionsLocal,\n  onPlayYesterdaysPuzzle,\n  onViewStatsWithBadge,\n  initialShowProDialog,\n  onProDialogShown,\n}: GameSelectionPageProps) {\n  const { user, isAuthenticated } = useAuth();\n  const { profile } = useProfile();\n  const adBannerActive = useAdBannerActive();\n  const { gameAttempts, loadingAttempts } = useGameData();\n  const { formatCanonicalDate } = useUserDateFormat();\n  const { isPro, tier } = useSubscription();\n  const { containerRef, x, gameMode, snapTo, handleSwipeStart, handleSwiping, handleSwiped, isDesktop } = useModeController(() => setShowGuestRestriction('personal'));\n  const { isRestricted, restrictionDays } = useCategoryRestriction();\n  const { toast } = useToast();\n  // Set up realtime subscriptions for automatic UI refresh when database changes occur\n  const { refreshLocalData, refreshGlobalData } = useRealtimeSubscriptions({\n    userId: user?.id,\n    region: profile?.region || 'UK',\n    isAuthenticated,\n  });\n  const queryClient = useQueryClient();\n  const [showHelp, setShowHelp] = useState(false);\n  const [showProDialog, setShowProDialog] = useState(false);\n  const [showGuestRestriction, setShowGuestRestriction] = useState<'archive' | 'personal' | null>(null);\n  const [showCategorySelection, setShowCategorySelection] = useState(false);\n  const [showStreakSaverPopup, setShowStreakSaverPopup] = useState<'region' | 'user' | null>(null);\n  const isLocalMode = gameMode === 'local';\n  \n  // Holiday activation overlay state (triggered from StreakSaverPopup)\n  const [showHolidayOverlay, setShowHolidayOverlay] = useState(false);\n  const [holidayOverlayData, setHolidayOverlayData] = useState<{\n    regionHolidayDates: string[];\n    userHolidayDates: string[];\n    showUserAfterRegion: boolean;\n    holidayDurationDays: number;\n  }>({\n    regionHolidayDates: [],\n    userHolidayDates: [],\n    showUserAfterRegion: false,\n    holidayDurationDays: 0,\n  });\n  // Track if holiday mode was just activated - prevents showing second streak saver popup\n  const [holidayJustActivated, setHolidayJustActivated] = useState(false);\n  \n  // Animation key - increments on each mount to force animation replay\n  const [animationKey, setAnimationKey] = useState(0);\n  useEffect(() => {\n    setAnimationKey(prev => prev + 1);\n  }, []);\n\n  // Handle initial Pro dialog trigger (e.g., from canceled subscription checkout)\n  useEffect(() => {\n    if (initialShowProDialog) {\n      setShowProDialog(true);\n      onProDialogShown?.();\n    }\n  }, [initialShowProDialog, onProDialogShown]);\n\n  const {\n    status: streakStatus,\n    isLoading: streakStatusLoading,\n    hasMissedRegion,\n    hasMissedUser,\n    holidayActive,\n    holidayEndDate,\n    clearHolidayMissedFlags,\n  } = useStreakSaverStatus();\n\n  // Get streak saver context to check if a streak saver was just completed\n  // This prevents the popup from re-appearing after the user completes a streak saver puzzle\n  const { isJustCompleted, acknowledgeCompletion } = useStreakSaver();\n\n  const [hasShownRegionPopup, setHasShownRegionPopup] = useState(false);\n  const [hasShownUserPopup, setHasShownUserPopup] = useState(false);\n  // Track if user popup is pending (waiting for user to return from region streak saver puzzle)\n  // Persisted in localStorage so it survives navigation (e.g., user abandons puzzle without completing)\n  const [userPopupPendingOnReturn, setUserPopupPendingOnReturn] = useState(() => {\n    const stored = localStorage.getItem('userStreakSaverPopupPending');\n    return stored === 'true';\n  });\n  \n  // Persist userPopupPendingOnReturn to localStorage\n  useEffect(() => {\n    if (userPopupPendingOnReturn) {\n      localStorage.setItem('userStreakSaverPopupPending', 'true');\n    } else {\n      localStorage.removeItem('userStreakSaverPopupPending');\n    }\n  }, [userPopupPendingOnReturn]);\n  \n  // Pending badge popup state\n  const [pendingBadgeToShow, setPendingBadgeToShow] = useState<UserBadgeWithDetails | null>(null);\n  const [pendingBadgeGameType, setPendingBadgeGameType] = useState<'USER' | 'REGION'>('REGION');\n  // Track which badge IDs we've already processed this session (to avoid re-showing)\n  const [processedBadgeIds, setProcessedBadgeIds] = useState<Set<number>>(new Set());\n  const [isAwarding, setIsAwarding] = useState(false);\n\n  // Query for pending badges (isAwarded=false) - Global mode (always enabled for authenticated users)\n  const { data: pendingGlobalBadges = [], refetch: refetchGlobalPending } = useQuery<UserBadgeWithDetails[]>({\n    queryKey: ['/api/badges/pending'],\n    queryFn: () => fetchAuthenticated('/api/badges/pending'),\n    enabled: isAuthenticated,\n  });\n  \n  // Query for pending badges (isAwarded=false) - Local mode (always enabled for authenticated users)\n  const { data: pendingLocalBadges = [], refetch: refetchLocalPending } = useQuery<UserBadgeWithDetails[]>({\n    queryKey: ['/api/user/badges/pending'],\n    queryFn: () => fetchAuthenticated('/api/user/badges/pending'),\n    enabled: isAuthenticated,\n  });\n\n  // Check for pending badges and show popup\n  useEffect(() => {\n    if (!isAuthenticated) return;\n    \n    // Don't show a new popup if one is already showing or we're in the process of awarding\n    if (pendingBadgeToShow || isAwarding) return;\n    \n    // Find first unprocessed pending badge (prioritize global over local)\n    const unprocessedGlobal = pendingGlobalBadges.find(b => !processedBadgeIds.has(b.id));\n    const unprocessedLocal = pendingLocalBadges.find(b => !processedBadgeIds.has(b.id));\n    \n    if (unprocessedGlobal) {\n      setPendingBadgeToShow(unprocessedGlobal);\n      setPendingBadgeGameType('REGION');\n    } else if (unprocessedLocal) {\n      setPendingBadgeToShow(unprocessedLocal);\n      setPendingBadgeGameType('USER');\n    }\n    // No pending badges or all already processed - nothing to do\n  }, [isAuthenticated, pendingGlobalBadges, pendingLocalBadges, pendingBadgeToShow, processedBadgeIds, isAwarding]);\n\n  // Track if we've already cleared holiday missed flags this session\n  const [hasClearedHolidayFlags, setHasClearedHolidayFlags] = useState(false);\n\n  useEffect(() => {\n    // Wait for authentication and status to load\n    if (!isAuthenticated || streakStatusLoading || !streakStatus) return;\n    \n    // If in holiday mode and there are missed flags, clear them silently instead of showing popup\n    if (holidayActive && (hasMissedRegion || hasMissedUser) && !hasClearedHolidayFlags) {\n      setHasClearedHolidayFlags(true);\n      clearHolidayMissedFlags();\n      return;\n    }\n    \n    // Don't show popups if in holiday mode\n    if (holidayActive) return;\n    \n    // When API confirms the missed flag is cleared, acknowledge the completion\n    // This clears the \"just completed\" state so future misses can trigger the popup\n    if (!hasMissedRegion && isJustCompleted('region')) {\n      acknowledgeCompletion('region');\n    }\n    if (!hasMissedUser && isJustCompleted('user')) {\n      acknowledgeCompletion('user');\n    }\n    \n    // Get current streaks to determine if there's something worth protecting\n    const regionCurrentStreak = streakStatus?.region?.currentStreak ?? 0;\n    const userCurrentStreak = streakStatus?.user?.currentStreak ?? 0;\n    \n    // Show region popup if missed, not yet shown, and has a streak worth protecting\n    // Also check if the streak saver was just completed (prevents re-showing due to stale cache)\n    if (hasMissedRegion && regionCurrentStreak > 0 && !hasShownRegionPopup && !showStreakSaverPopup && !isJustCompleted('region')) {\n      setShowStreakSaverPopup('region');\n      setHasShownRegionPopup(true);\n    }\n    // Show user popup if:\n    // 1. User popup was pending on return (user completed region streak saver puzzle and came back), OR\n    // 2. User missed AND has streak AND region is resolved AND not just completed\n    else if (\n      userPopupPendingOnReturn && \n      hasMissedUser && \n      userCurrentStreak > 0 && \n      !showStreakSaverPopup && \n      !isJustCompleted('user')\n    ) {\n      // User returned from region streak saver puzzle - show user popup now\n      setUserPopupPendingOnReturn(false);\n      setShowStreakSaverPopup('user');\n      setHasShownUserPopup(true);\n    }\n    else if (hasMissedUser && userCurrentStreak > 0 && !hasShownUserPopup && !showStreakSaverPopup && !hasMissedRegion && !isJustCompleted('user')) {\n      setShowStreakSaverPopup('user');\n      setHasShownUserPopup(true);\n    }\n  }, [isAuthenticated, streakStatusLoading, streakStatus, hasMissedRegion, hasMissedUser, hasShownRegionPopup, hasShownUserPopup, showStreakSaverPopup, holidayActive, hasClearedHolidayFlags, clearHolidayMissedFlags, isJustCompleted, acknowledgeCompletion, userPopupPendingOnReturn]);\n\n  // Cache user name and region label locally to prevent flicker\n  const [cachedUserName, setCachedUserName] = useState<string>(() => {\n    const cached = readLocal<UserProfile>(CACHE_KEYS.PROFILE);\n    return cached?.firstName || 'Personal';\n  });\n  const [cachedRegionLabel, setCachedRegionLabel] = useState<string>(() => {\n    const cached = readLocal<UserProfile>(CACHE_KEYS.PROFILE);\n    return cached?.region ? `${cached.region} Edition` : 'UK Edition';\n  });\n\n  // Update cache when profile loads\n  useEffect(() => {\n    if (profile) {\n      if (profile.firstName) {\n        // If name is 12+ characters, use \"Personal\" instead\n        const displayName = profile.firstName.length >= 12 ? 'Personal' : profile.firstName;\n        setCachedUserName(displayName);\n      }\n      if (profile.region) {\n        setCachedRegionLabel(`${profile.region} Edition`);\n      }\n    }\n  }, [profile]);\n\n  // Handler for opening category selection with restriction check\n  const handleOpenProCategories = () => {\n    if (isRestricted) {\n      toast({\n        title: \"Categories restricted\",\n        description: `You can update your categories once every ${restrictionDays} days and Hammie will regenerate your questions.`,\n        variant: \"default\",\n      });\n      return;\n    }\n    setShowCategorySelection(true);\n  };\n\n  // Transform for Options button - moves based on content width, not viewport\n  // Track container width, content width, and Stats row vertical position\n  const [containerWidth, setContainerWidth] = useState(0);\n  const [contentWidth, setContentWidth] = useState(0);\n  const [statsRowTop, setStatsRowTop] = useState(0);\n  const contentRef = useRef<HTMLDivElement>(null);\n  const statsRowRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const updateDimensions = () => {\n      if (containerRef.current) {\n        setContainerWidth(containerRef.current.offsetWidth);\n      }\n      if (contentRef.current) {\n        setContentWidth(contentRef.current.offsetWidth);\n      }\n      // Track Stats row position relative to the container\n      if (statsRowRef.current && containerRef.current) {\n        const containerRect = containerRef.current.getBoundingClientRect();\n        const statsRect = statsRowRef.current.getBoundingClientRect();\n        setStatsRowTop(statsRect.top - containerRect.top);\n      }\n    };\n    updateDimensions();\n    window.addEventListener('resize', updateDimensions);\n    // Also observe for layout changes (text size, etc.)\n    const observer = new MutationObserver(updateDimensions);\n    if (containerRef.current) {\n      observer.observe(containerRef.current, { childList: true, subtree: true, attributes: true });\n    }\n    return () => {\n      window.removeEventListener('resize', updateDimensions);\n      observer.disconnect();\n    };\n  }, [containerRef]);\n\n  // Options button moves to stay aligned with content area\n  // Movement is based on content width (max-w-md), not full container width\n  // Button width is calc(50% - 0.5rem), so to move from right-aligned to left-aligned:\n  // needs to move by contentWidth/2 + 8px (the 8px accounts for the 0.5rem gap)\n  const buttonX = useTransform(\n    x,\n    [0, -Math.max(containerWidth, 1)],\n    [0, -Math.max(contentWidth, 1) / 2 - 8], // Align left edge with Archive button on Local\n    { clamp: true }\n  );\n\n  // Authenticated fetch helper\n  const fetchAuthenticated = async (endpoint: string) => {\n    if (!isAuthenticated) return null;\n    const supabase = await getSupabaseClient();\n    const { data: { session } } = await supabase.auth.getSession();\n    if (!session) {\n      // Throw error instead of returning null so TanStack Query retries\n      // This handles race conditions where auth state is established before session\n      throw new Error('Session not available yet');\n    }\n\n    const response = await fetch(endpoint, {\n      credentials: 'include',\n      headers: {\n        'Authorization': `Bearer ${session.access_token}`,\n      },\n    });\n    if (!response.ok) throw new Error(`Failed to fetch ${endpoint}`);\n    return response.json();\n  };\n\n  // Fetch Global game attempts (always from region data)\n  const { data: globalGameAttempts = [] } = useQuery<any[]>({\n    queryKey: ['/api/game-attempts/user'],\n    queryFn: () => fetchAuthenticated('/api/game-attempts/user'),\n    enabled: isAuthenticated,\n  });\n\n  // Fetch Local game attempts (always from user data)\n  const { data: localGameAttempts = [] } = useQuery<any[]>({\n    queryKey: ['/api/user/game-attempts/user'],\n    queryFn: () => fetchAuthenticated('/api/user/game-attempts/user'),\n    enabled: isAuthenticated,\n  });\n\n  // Fetch Global stats\n  const { data: globalStats } = useQuery<any>({\n    queryKey: ['/api/stats'],\n    queryFn: () => fetchAuthenticated('/api/stats'),\n    enabled: isAuthenticated,\n  });\n\n  // Fetch Local stats  \n  const { data: localStats } = useQuery<any>({\n    queryKey: ['/api/user/stats'],\n    queryFn: () => fetchAuthenticated('/api/user/stats'),\n    enabled: isAuthenticated,\n  });\n\n  // Fetch Global puzzles (for authenticated users - uses region data)\n  const { data: globalPuzzles = [] } = useQuery<any[]>({\n    queryKey: ['/api/puzzles'],\n    queryFn: () => fetchAuthenticated('/api/puzzles'),\n    enabled: isAuthenticated,\n    retry: 3,\n    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 5000),\n  });\n\n  // Fetch Local puzzles (for authenticated users - uses user-specific data)\n  const { data: localPuzzles = [], isLoading: localPuzzlesLoading } = useQuery<any[]>({\n    queryKey: ['/api/user/puzzles'],\n    queryFn: () => fetchAuthenticated('/api/user/puzzles'),\n    enabled: isAuthenticated,\n    retry: 3,\n    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 5000),\n  });\n\n  // Fetch guest puzzles (for unauthenticated users - Global mode only)\n  const { data: guestPuzzles = [] } = useQuery<any[]>({\n    queryKey: ['/api/puzzles/guest'],\n    queryFn: async () => {\n      const response = await fetch('/api/puzzles/guest');\n      if (!response.ok) throw new Error('Failed to fetch guest puzzles');\n      return response.json();\n    },\n    enabled: !isAuthenticated,\n  });\n\n  // Helper to find today's puzzle from a list\n  const getTodayDateString = () => {\n    const today = new Date();\n    const year = today.getFullYear();\n    const month = String(today.getMonth() + 1).padStart(2, '0');\n    const day = String(today.getDate()).padStart(2, '0');\n    return `${year}-${month}-${day}`;\n  };\n\n  const hasTodayPuzzle = (puzzles: any[]): boolean => {\n    if (!puzzles || puzzles.length === 0) return false;\n    const todayDate = getTodayDateString();\n    return puzzles.some(p => p.date === todayDate);\n  };\n\n  // Force data refresh for authenticated users if today's puzzle is missing\n  // Triggers on: mount, mode switch (Global <-> Local), or when puzzle data changes\n  const lastRefreshRef = useRef<number>(0);\n  useEffect(() => {\n    if (!isAuthenticated) return;\n    \n    const hasTodayGlobal = hasTodayPuzzle(globalPuzzles);\n    const hasTodayLocal = hasTodayPuzzle(localPuzzles);\n    \n    // Only refresh if today's puzzle is missing from either mode\n    if (!hasTodayGlobal || !hasTodayLocal) {\n      // Prevent rapid refreshes - minimum 1 second between refreshes\n      const now = Date.now();\n      if (now - lastRefreshRef.current > 1000) {\n        lastRefreshRef.current = now;\n        console.log('[GameSelectionPage] Today puzzle missing - refreshing data', { gameMode, hasTodayGlobal, hasTodayLocal });\n        queryClient.refetchQueries({ queryKey: ['/api/user/puzzles'] });\n        queryClient.refetchQueries({ queryKey: ['/api/puzzles'] });\n        queryClient.refetchQueries({ queryKey: ['/api/user/game-attempts/user'] });\n        queryClient.refetchQueries({ queryKey: ['/api/game-attempts/user'] });\n      }\n    } else {\n      console.log('[GameSelectionPage] Today puzzles loaded - no refresh needed');\n    }\n  }, [isAuthenticated, globalPuzzles, localPuzzles, queryClient, gameMode]);\n\n\n  // Helper to find today's puzzle from a list\n  const findTodayPuzzle = (puzzles: any[]): any | undefined => {\n    if (!puzzles || puzzles.length === 0) return undefined;\n    const today = new Date();\n    const year = today.getFullYear();\n    const month = String(today.getMonth() + 1).padStart(2, '0');\n    const day = String(today.getDate()).padStart(2, '0');\n    const todayDate = `${year}-${month}-${day}`;\n    return puzzles.find(p => p.date === todayDate);\n  };\n\n  // Compute today's puzzle ID for each mode independently\n  const todayGlobalPuzzle = isAuthenticated ? findTodayPuzzle(globalPuzzles) : findTodayPuzzle(guestPuzzles);\n  const todayLocalPuzzle = isAuthenticated ? findTodayPuzzle(localPuzzles) : undefined;\n  const todayGlobalPuzzleId = todayGlobalPuzzle?.id;\n  const todayLocalPuzzleId = todayLocalPuzzle?.id;\n\n  // Helper function to compute play button status for a given set of attempts\n  const computePlayButtonStatus = (attempts: any[], puzzleId?: number) => {\n    if (!isAuthenticated || !puzzleId || !attempts) {\n      return { status: 'not-played' as const, count: 0 };\n    }\n\n    const todayAttempt = attempts.find(attempt => \n      attempt.puzzleId === puzzleId && attempt.result !== null\n    );\n\n    if (todayAttempt) {\n      const isWin = todayAttempt.result === 'won' || todayAttempt.result === 'win';\n      const count = todayAttempt.numGuesses ?? 0;\n\n      return {\n        status: (isWin ? 'solved' : 'failed') as 'solved' | 'failed',\n        count\n      };\n    }\n\n    return { status: 'not-played' as const, count: 0 };\n  };\n\n  // NOTE: Old shared state effects removed - each pane now independently fetches and computes its own data\n\n  const getFormattedDate = () => {\n    const today = new Date();\n    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\n    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n\n    const dayName = days[today.getDay()];\n    const date = today.getDate();\n    const month = months[today.getMonth()];\n\n    const getOrdinal = (n: number) => {\n      const s = [\"th\", \"st\", \"nd\", \"rd\"];\n      const v = n % 100;\n      return n + (s[(v - 20) % 10] || s[v] || s[0]);\n    };\n\n    return `${dayName} ${getOrdinal(date)} ${month}`;\n  };\n\n  const getGreeting = () => {\n    const hour = new Date().getHours();\n    if (hour >= 5 && hour < 12) return \"Good morning\";\n    if (hour >= 12 && hour < 18) return \"Good afternoon\";\n    return \"Good evening\";\n  };\n\n  // Track the locked direction for the current swipe gesture using a ref for synchronous updates\n  const swipeDirectionRef = useRef<'horizontal' | 'vertical' | null>(null);\n\n  const swipeHandlers = useSwipeable({\n    onSwipeStart: () => {\n      handleSwipeStart();\n      swipeDirectionRef.current = null; // Reset direction lock at start of each gesture\n    },\n    onSwiping: (eventData) => {\n      // Determine and lock direction on first significant movement\n      if (swipeDirectionRef.current === null) {\n        const absX = Math.abs(eventData.deltaX);\n        const absY = Math.abs(eventData.deltaY);\n        \n        // Only lock direction if there's meaningful movement (threshold of 10px)\n        if (absX > 10 || absY > 10) {\n          swipeDirectionRef.current = absX > absY ? 'horizontal' : 'vertical';\n        }\n      }\n\n      // Only apply horizontal movement if locked to horizontal\n      if (swipeDirectionRef.current === 'horizontal') {\n        handleSwiping(eventData.deltaX);\n      }\n      // Vertical scrolling happens naturally when direction is vertical or null\n    },\n    onSwiped: (eventData) => {\n      const velocity = eventData.velocity;\n      const direction = eventData.dir as 'Left' | 'Right' | 'Up' | 'Down';\n      \n      // Only handle horizontal swipes for pane switching\n      if (swipeDirectionRef.current === 'horizontal' && (direction === 'Left' || direction === 'Right')) {\n        handleSwiped(velocity, direction);\n      }\n      \n      // Reset direction lock\n      swipeDirectionRef.current = null;\n    },\n    trackMouse: true,\n    preventScrollOnSwipe: false, // Allow vertical scrolling\n  });\n\n  // Extract ref from swipeHandlers to avoid duplicate ref warning\n  const { ref: swipeRef, ...swipeProps} = swipeHandlers;\n\n  // Render Global Pane\n  const renderGlobalPane = () => {\n    // Compute Global-specific data\n    const globalPlayStatus = computePlayButtonStatus(globalGameAttempts, todayGlobalPuzzleId);\n    const totalGamesGlobal = globalGameAttempts.filter(attempt => attempt.result === \"won\" || attempt.result === \"lost\").length;\n    const globalStreak = globalStats?.currentStreak || 0;\n    \n    // Use cumulative monthly percentile from stats (only show if day of month >= 5)\n    const dayOfMonth = new Date().getDate();\n    const globalCumulativePercentile = globalStats?.cumulativeMonthlyPercentile ?? null;\n\n    // Compute Global intro message\n    let globalIntroMessage = null;\n    if (isAuthenticated) {\n      if (globalPlayStatus.status === 'not-played') {\n        const greeting = getGreeting();\n        const streakMessage = globalStreak === 0\n          ? \"Start your streak with today's puzzle\"\n          : `Continue your streak of ${globalStreak} ${globalStreak === 1 ? 'day' : 'days'} in a row`;\n        globalIntroMessage = { firstLine: greeting, secondLine: streakMessage };\n      } else {\n        let percentileMessage = \"Play the archive to boost your ranking\";\n        // Only show percentile if day >= 5 and we have a valid percentile score\n        if (dayOfMonth >= 5 && globalCumulativePercentile !== null && globalCumulativePercentile > 0) {\n          const roundedPercentile = Math.floor(globalCumulativePercentile / 5) * 5;\n          if (globalCumulativePercentile >= 50) {\n            percentileMessage = `You're in the top ${roundedPercentile}% of players - play the archive to boost your ranking`;\n          }\n        }\n        globalIntroMessage = { firstLine: \"Welcome back\", secondLine: percentileMessage };\n      }\n    }\n\n    // Compute Global play button content\n    let playContentGlobal;\n    switch (globalPlayStatus.status) {\n      case 'solved':\n        playContentGlobal = {\n          title: \"Today's puzzle solved!\",\n          subtitle: `Solved in ${globalPlayStatus.count} ${globalPlayStatus.count === 1 ? 'guess' : 'guesses'}`,\n          image: winhamsterblue\n        };\n        break;\n      case 'failed':\n        playContentGlobal = {\n          title: \"Better luck tomorrow...\",\n          subtitle: \"\",\n          image: losthamsterblue\n        };\n        break;\n      default:\n        playContentGlobal = {\n          title: \"Play today's puzzle\",\n          subtitle: getFormattedDate(),\n          image: historianHamsterBlue\n        };\n    }\n\n    return (\n      <div className={isDesktop ? \"w-full flex-shrink-0\" : \"w-1/2 flex-shrink-0\"} style={{ paddingLeft: isDesktop ? 0 : '1rem', paddingRight: isDesktop ? 0 : '1rem' }}>\n        <div className=\"max-w-md mx-auto w-full\">\n          {/* Desktop: Show region label title */}\n          {isDesktop && isAuthenticated && (\n            <div className=\"text-center mb-0\">\n              <h2 className=\"text-2xl font-bold text-foreground font-bold\">{cachedRegionLabel}</h2>\n            </div>\n          )}\n\n          {/* Desktop: Show only secondary message (no \"Welcome back\") */}\n          {isDesktop && isAuthenticated && globalIntroMessage && (\n            <div className=\"text-center mb-2 h-12 flex flex-col justify-center\" data-testid=\"intro-message-global\">\n              <div className=\"text-base text-gray-600 dark:text-gray-400\" data-testid=\"intro-second-line-global\">\n                {globalIntroMessage.secondLine}\n              </div>\n            </div>\n          )}\n\n          {/* Mobile: Show only secondary message with fixed height (first line is in fixed header) */}\n          {!isDesktop && isAuthenticated && globalIntroMessage && (\n            <div className=\"text-center mt-2 mb-3 h-[3rem] flex items-center justify-center\" data-testid=\"intro-message\">\n              <div className=\"text-lg sm:text-xl text-gray-600 dark:text-gray-400 line-clamp-2\" data-testid=\"intro-second-line\">\n                {globalIntroMessage.secondLine}\n              </div>\n            </div>\n          )}\n\n          <div className=\"flex flex-col items-stretch space-y-4 mt-1\">\n            {/* Play Today's Puzzle (Global) */}\n            <motion.button\n              className=\"w-full h-32 flex items-center justify-between px-6 rounded-3xl shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n              style={{ backgroundColor: \"#7DAAE8\", touchAction: 'pan-y' }}\n              onClick={onPlayGame}\n              disabled={!todayGlobalPuzzleId}\n              data-testid=\"button-play\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ duration: 0.25, ease: \"easeOut\" }}\n            >\n              <div className=\"flex flex-col items-start justify-center text-left\">\n                <span className=\"text-xl font-bold text-gray-800\">\n                  {playContentGlobal.title}\n                </span>\n                {playContentGlobal.subtitle && (\n                  <span className=\"text-sm font-medium text-gray-700 mt-0.5\">\n                    {playContentGlobal.subtitle}\n                  </span>\n                )}\n              </div>\n              <div className=\"flex-shrink-0 flex items-center\">\n                <img\n                  src={playContentGlobal.image}\n                  alt={playContentGlobal.title}\n                  className=\"max-h-20 w-auto object-contain\"\n                />\n              </div>\n            </motion.button>\n\n            {/* Archive (Global) */}\n            <motion.button\n              className=\"w-full h-24 flex items-center justify-between px-6 rounded-3xl shadow-sm hover:shadow-md\"\n              style={{ backgroundColor: \"#FFD429\", touchAction: 'pan-y' }}\n              onClick={() => {\n                if (!isAuthenticated) {\n                  setShowGuestRestriction('archive');\n                  return;\n                }\n                onViewArchive();\n              }}\n              data-testid=\"button-archive\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ duration: 0.25, delay: 0.15, ease: \"easeOut\" }}\n            >\n              <div className=\"flex flex-col items-start justify-center text-left\">\n                <span className=\"text-xl font-bold text-gray-800\">Archive</span>\n                <span className=\"text-sm font-medium text-gray-700 mt-0.5\">\n                  {isAuthenticated ? `${totalGamesGlobal} total games played` : 'Sign in to access'}\n                </span>\n              </div>\n              <div className=\"flex-shrink-0 flex items-center\">\n                <img\n                  src={librarianHamsterYellow}\n                  alt=\"Archive\"\n                  className=\"max-h-20 w-auto object-contain\"\n                />\n              </div>\n            </motion.button>\n\n            {/* Mobile only: Stats row - contains Global Stats button */}\n            {!isDesktop && (\n              <div ref={statsRowRef} className=\"relative h-40\">\n                {/* Global Stats button */}\n                <motion.button\n                  className=\"absolute left-0 h-40 w-[calc(50%-0.5rem)] flex flex-col items-center px-4 py-3 rounded-3xl shadow-sm hover:shadow-md\"\n                  style={{ backgroundColor: \"#A4DB57\", touchAction: 'pan-y' }}\n                  onClick={() => {\n                    if (!isAuthenticated) {\n                      setShowGuestRestriction('personal');\n                      return;\n                    }\n                    onViewStats();\n                  }}\n                  data-testid=\"button-stats-global\"\n                  initial={{ opacity: 0, y: 20 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ duration: 0.25, delay: 0.3, ease: \"easeOut\" }}\n                >\n                  <span className=\"text-xl font-bold text-gray-800 text-center h-12 flex items-center\">\n                    {cachedRegionLabel.split(' ')[0]} Stats\n                  </span>\n                  <img\n                    src={mathsHamsterGreen}\n                    alt=\"Global Stats\"\n                    className=\"max-h-[72px] w-auto object-contain flex-1 mt-2\"\n                  />\n                </motion.button>\n              </div>\n            )}\n\n            {/* Mobile only: Add bottom spacing */}\n            {!isDesktop && <div className=\"h-24\" />}\n          </div>\n        </div>\n      </div>\n    );\n  };\n\n  // Render Local Pane\n  const renderLocalPane = () => {\n    // Compute Local-specific data\n    const localPlayStatus = computePlayButtonStatus(localGameAttempts, todayLocalPuzzleId);\n    const totalGamesLocal = localGameAttempts.filter(attempt => attempt.result === \"won\" || attempt.result === \"lost\").length;\n    const localStreak = localStats?.currentStreak || 0;\n    \n    // Use cumulative monthly percentile from stats (only show if day of month >= 5)\n    const dayOfMonth = new Date().getDate();\n    const localCumulativePercentile = localStats?.cumulativeMonthlyPercentile ?? null;\n\n    // Compute Local intro message\n    let localIntroMessage = null;\n    if (isAuthenticated) {\n      if (localPlayStatus.status === 'not-played') {\n        const greeting = getGreeting();\n        const streakMessage = localStreak === 0\n          ? \"Start your streak with today's puzzle\"\n          : `Continue your streak of ${localStreak} ${localStreak === 1 ? 'day' : 'days'} in a row`;\n        localIntroMessage = { firstLine: greeting, secondLine: streakMessage };\n      } else {\n        let percentileMessage = \"Play your personalised puzzles\";\n        // Only show percentile if day >= 5 and we have a valid percentile score\n        if (dayOfMonth >= 5 && localCumulativePercentile !== null && localCumulativePercentile > 0) {\n          const roundedPercentile = Math.floor(localCumulativePercentile / 5) * 5;\n          if (localCumulativePercentile >= 50) {\n            percentileMessage = `You're in the top ${roundedPercentile}% of players`;\n          }\n        }\n        localIntroMessage = { \n          firstLine: \"Welcome back\", \n          secondLine: percentileMessage \n        };\n      }\n    }\n\n    // Compute Local play button content\n    // Differentiate between: still loading, no puzzle available, puzzle available\n    const isStillLoading = isAuthenticated && localPuzzlesLoading;\n    const noPuzzleAvailable = isAuthenticated && !localPuzzlesLoading && !todayLocalPuzzleId;\n    \n    let playContentLocal;\n    if (isStillLoading) {\n      // Data still loading - show default button text but disabled\n      playContentLocal = {\n        title: \"Play today's puzzle\",\n        subtitle: \"\",\n        image: historianHamsterLocal,\n        isLoading: true\n      };\n    } else if (noPuzzleAvailable) {\n      // Data loaded but no puzzle for today - show cooking message\n      playContentLocal = {\n        title: \"Hammie is still cooking up today's personal puzzle for you - won't take long...\",\n        subtitle: \"\",\n        image: historianHamsterLocal,\n        isLoading: true\n      };\n    } else {\n      switch (localPlayStatus.status) {\n        case 'solved':\n          playContentLocal = {\n            title: \"Today's puzzle solved!\",\n            subtitle: `Solved in ${localPlayStatus.count} ${localPlayStatus.count === 1 ? 'guess' : 'guesses'}`,\n            image: winhamsterlocal,\n            isLoading: false\n          };\n          break;\n        case 'failed':\n          playContentLocal = {\n            title: \"Better luck tomorrow...\",\n            subtitle: \"\",\n            image: losthamsterlocal,\n            isLoading: false\n          };\n          break;\n        default:\n          playContentLocal = {\n            title: \"Play today's puzzle\",\n            subtitle: getFormattedDate(),\n            image: historianHamsterLocal,\n            isLoading: false\n          };\n      }\n    }\n\n    return (\n      <div className={isDesktop ? \"w-full flex-shrink-0\" : \"w-1/2 flex-shrink-0\"} style={{ paddingLeft: isDesktop ? 0 : '1rem', paddingRight: isDesktop ? 0 : '1rem' }}>\n        <div className=\"max-w-md mx-auto w-full\">\n          {/* Desktop: Show user name title */}\n          {isDesktop && isAuthenticated && (\n            <div className=\"text-center mb-0\">\n              <h2 className=\"text-2xl font-bold text-foreground font-bold\">{cachedUserName}</h2>\n            </div>\n          )}\n\n          {/* Desktop: Show only secondary message (no \"Welcome back\") */}\n          {isDesktop && isAuthenticated && localIntroMessage && (\n            <div className=\"text-center mb-2 h-12 flex flex-col justify-center\" data-testid=\"intro-message-local-desktop\">\n              <div className=\"text-base text-gray-600 dark:text-gray-400\" data-testid=\"intro-second-line-local\">\n                {localIntroMessage.secondLine}\n              </div>\n            </div>\n          )}\n\n          {/* Mobile: Show only secondary message with fixed height (first line is in fixed header) */}\n          {!isDesktop && isAuthenticated && localIntroMessage && (\n            <div className=\"text-center mt-2 mb-3 h-[3rem] flex items-center justify-center\" data-testid=\"intro-message-local\">\n              <div className=\"text-lg sm:text-xl text-gray-600 dark:text-gray-400 line-clamp-2\">\n                {localIntroMessage.secondLine}\n              </div>\n            </div>\n          )}\n\n          <div className=\"flex flex-col items-stretch space-y-4 mt-1\">\n            {/* Play Today's Puzzle (Local) */}\n            <motion.button\n              className=\"w-full h-32 flex items-center justify-between px-6 rounded-3xl shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n              style={{ backgroundColor: \"#66becb\", touchAction: 'pan-y' }}\n              onClick={() => {\n                if (!isAuthenticated) {\n                  setShowGuestRestriction('personal');\n                  return;\n                }\n                onPlayGameLocal?.();\n              }}\n              disabled={!todayLocalPuzzleId}\n              data-testid=\"button-play-local\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ duration: 0.25, ease: \"easeOut\" }}\n            >\n              <div className=\"flex flex-col items-start justify-center text-left\">\n                {playContentLocal.isLoading ? (\n                  <span className=\"text-base text-gray-800\">\n                    <span className=\"font-bold\">Hammie</span> is still cooking up today's personal puzzle for you - won't take long...\n                  </span>\n                ) : (\n                  <span className={`font-bold text-gray-800 ${playContentLocal.isLoading ? 'text-base' : 'text-xl'}`}>\n                    {isAuthenticated ? playContentLocal.title : 'Play today\\'s puzzle'}\n                  </span>\n                )}\n                {(isAuthenticated ? playContentLocal.subtitle : 'Sign in to access') && (\n                  <span className=\"text-sm font-medium text-gray-700 mt-0.5\">\n                    {isAuthenticated ? playContentLocal.subtitle : 'Sign in to access'}\n                  </span>\n                )}\n              </div>\n              <div className=\"flex-shrink-0 flex items-center\">\n                <img\n                  src={playContentLocal.image}\n                  alt={playContentLocal.title}\n                  className=\"max-h-20 w-auto object-contain\"\n                />\n              </div>\n            </motion.button>\n\n            {/* Archive (Local) */}\n            <motion.button\n              className=\"w-full h-24 flex items-center justify-between px-6 rounded-3xl shadow-sm hover:shadow-md\"\n              style={{ backgroundColor: \"#fdab58\", touchAction: 'pan-y' }}\n              onClick={() => {\n                if (!isAuthenticated) {\n                  setShowGuestRestriction('personal');\n                  return;\n                }\n                onViewArchiveLocal?.();\n              }}\n              data-testid=\"button-archive-local\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ duration: 0.25, delay: 0.15, ease: \"easeOut\" }}\n            >\n              <div className=\"flex flex-col items-start justify-center text-left\">\n                <span className=\"text-xl font-bold text-gray-800\">Archive</span>\n                <span className=\"text-sm font-medium text-gray-700 mt-0.5\">\n                  {isAuthenticated ? `${totalGamesLocal} total games played` : 'Sign in to access'}\n                </span>\n              </div>\n              <div className=\"flex-shrink-0 flex items-center\">\n                <img\n                  src={librarianHamsterLocal}\n                  alt=\"Archive\"\n                  className=\"max-h-20 w-auto object-contain\"\n                />\n              </div>\n            </motion.button>\n\n            {/* Mobile only: Stats row - contains Local Stats button (Options is in Global pane) */}\n            {!isDesktop && (\n              <div className=\"relative h-40\">\n                {/* Local Stats button */}\n                <motion.button\n                  className=\"absolute right-0 h-40 w-[calc(50%-0.5rem)] flex flex-col items-center px-4 py-3 rounded-3xl shadow-sm hover:shadow-md\"\n                  style={{ backgroundColor: \"#93cd78\", touchAction: 'pan-y' }}\n                  onClick={() => {\n                    if (!isAuthenticated) {\n                      setShowGuestRestriction('personal');\n                      return;\n                    }\n                    onViewStatsLocal?.();\n                  }}\n                  data-testid=\"button-stats-local\"\n                  initial={{ opacity: 0, y: 20 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ duration: 0.25, delay: 0.3, ease: \"easeOut\" }}\n                >\n                  <span className=\"text-xl font-bold text-gray-800 text-center h-12 flex items-center\">\n                    Personal Stats\n                  </span>\n                  <img\n                    src={mathsHamsterLocal}\n                    alt=\"Local Stats\"\n                    className=\"max-h-[72px] w-auto object-contain flex-1 mt-2\"\n                  />\n                </motion.button>\n              </div>\n            )}\n\n            {/* Mobile only: Add bottom spacing */}\n            {!isDesktop && <div className=\"h-24\" />}\n          </div>\n        </div>\n      </div>\n    );\n  };\n\n  return (\n    <div className={`flex flex-col min-h-screen overflow-hidden ${adBannerActive ? 'pb-[50px]' : ''}`}>\n      {/* Mobile: Fixed Header with dynamic greeting text */}\n      {!isDesktop ? (\n        <div className=\"fixed top-0 left-0 right-0 z-50 bg-background\">\n          <div className=\"p-3 pb-2\">\n            <div className=\"max-w-md mx-auto w-full\">\n              <div className=\"flex items-center justify-between mb-1\">\n                <button\n                  onClick={() => setShowHelp(true)}\n                  data-testid=\"button-help\"\n                  className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n                >\n                  <img src={greyHelpIcon} alt=\"Help\" className=\"h-9 w-9 block dark:hidden\" />\n                  <img src={whiteHelpIcon} alt=\"Help\" className=\"h-9 w-9 hidden dark:block\" />\n                </button>\n\n                <h1 className=\"text-4xl sm:text-5xl font-bold text-gray-900 dark:text-gray-100\" data-testid=\"text-title\">\n                  Elementle\n                </h1>\n\n                <button\n                  onClick={onOpenSettings}\n                  disabled={!onOpenSettings}\n                  data-testid=\"button-settings\"\n                  className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors disabled:opacity-50 mr-1\"\n                >\n                  <img src={greyCogIcon} alt=\"Settings\" className=\"h-9 w-9 block dark:hidden\" />\n                  <img src={whiteCogIcon} alt=\"Settings\" className=\"h-9 w-9 hidden dark:block\" />\n                </button>\n              </div>\n\n              <div className=\"flex items-center pr-2 mb-1 relative\">\n                {/* Mode toggle - always centered */}\n                <div className=\"flex-1 flex justify-center\">\n                  <ModeToggle \n                    onModeChange={(mode) => {\n                      if (mode === 'local' && !isAuthenticated) {\n                        setShowGuestRestriction('personal');\n                        snapTo('global'); // Snap back to global\n                        return;\n                      }\n                      snapTo(mode);\n                    }} \n                    onLocalClickGuest={() => setShowGuestRestriction('personal')}\n                    globalLabel={cachedRegionLabel || profile?.region || 'UK Edition'}\n                  />\n                </div>\n\n                {/* Go Pro / Ads button - right side, only for authenticated users */}\n                {isAuthenticated && (\n                  <div className={`absolute flex-shrink-0 ${isPro ? 'right-2' : 'right-0'}`}>\n                    {isPro ? (\n                      <GoProButton onClick={handleOpenProCategories} isPro />\n                    ) : (\n                      <GoProButton onClick={() => setShowProDialog(true)} />\n                    )}\n                  </div>\n                )}\n              </div>\n\n              <div className=\"text-center mb-1\">\n                <div className=\"text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200\" data-testid=\"intro-first-line-fixed\">\n                  {getGreeting()}\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      ) : (\n        /* Desktop: Header (not fixed) */\n        <div className=\"flex-shrink-0 p-4\">\n          <div className=\"max-w-[calc(2*28rem+0.5rem)] mx-auto w-full\">\n            <div className=\"relative flex items-center justify-between mb-2\">\n              <button\n                onClick={() => setShowHelp(true)}\n                data-testid=\"button-help\"\n                className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors z-10\"\n              >\n                <img src={greyHelpIcon} alt=\"Help\" className=\"h-9 w-9 block dark:hidden\" />\n                <img src={whiteHelpIcon} alt=\"Help\" className=\"h-9 w-9 hidden dark:block\" />\n              </button>\n\n              <h1 className=\"absolute left-1/2 -translate-x-1/2 text-4xl sm:text-5xl font-bold text-gray-900 dark:text-gray-100\" data-testid=\"text-title\">\n                Elementle\n              </h1>\n\n              <div className=\"flex items-center gap-2 z-10\">\n                {/* Go Pro / Ads button - next to settings, only for authenticated users */}\n                {isAuthenticated && (\n                  <div className=\"flex-shrink-0\">\n                    {isPro ? (\n                      <GoProButton onClick={handleOpenProCategories} isPro />\n                    ) : (\n                      <GoProButton onClick={() => setShowProDialog(true)} />\n                    )}\n                  </div>\n                )}\n                \n                <button\n                  onClick={onOpenSettings}\n                  disabled={!onOpenSettings}\n                  data-testid=\"button-settings\"\n                  className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors disabled:opacity-50\"\n                >\n                  <img src={greyCogIcon} alt=\"Settings\" className=\"h-9 w-9 block dark:hidden\" />\n                  <img src={whiteCogIcon} alt=\"Settings\" className=\"h-9 w-9 hidden dark:block\" />\n                </button>\n              </div>\n            </div>\n\n            <div className=\"flex justify-center mb-2\">\n              <div className=\"text-center\">\n                <div className=\"text-2xl font-bold text-foreground\">\n                  {getGreeting()}\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Sliding Viewport Container */}\n      <div className={`flex-grow overflow-hidden relative ${!isDesktop ? 'pt-[160px]' : ''}`} style={{minHeight: !isDesktop ? '100vh' : 'auto'}}>\n        {isDesktop ? (\n          /* Desktop: Side-by-side layout centered around middle */\n          <div className=\"h-full w-full flex flex-col\">\n            {/* Panes Container */}\n            <div className=\"flex-grow flex justify-center gap-2 px-4 overflow-hidden\">\n              {/* Global Pane */}\n              <div className=\"w-full max-w-md flex flex-col\">\n                {renderGlobalPane()}\n              </div>\n\n              {/* Local Pane */}\n              <div className=\"w-full max-w-md flex flex-col\">\n                {renderLocalPane()}\n              </div>\n            </div>\n\n            {/* Desktop: Bottom buttons - Options always visible, Stats visible for all */}\n            <div className=\"flex-shrink-0 px-4 pb-24 mt-4\">\n              <AnimatePresence mode=\"wait\">\n                <motion.div\n                  key={`desktop-buttons-${animationKey}`}\n                  className=\"max-w-[calc(2*28rem+0.5rem)] mx-auto flex gap-2\"\n                  initial=\"hidden\"\n                  animate=\"visible\"\n                  variants={{\n                    hidden: {},\n                    visible: {\n                      transition: {\n                        staggerChildren: 0.08,\n                        delayChildren: 0.1\n                      }\n                    }\n                  }}\n                >\n                  <motion.button\n                    className=\"flex-1 h-36 flex flex-col items-center justify-center px-4 rounded-3xl shadow-sm hover:shadow-md\"\n                    style={{ backgroundColor: \"#A4DB57\" }}\n                    onClick={() => {\n                      if (!isAuthenticated) {\n                        setShowGuestRestriction('personal');\n                        return;\n                      }\n                      onViewStats();\n                    }}\n                    data-testid=\"button-stats-desktop-global\"\n                    variants={{\n                      hidden: { opacity: 0, y: 20 },\n                      visible: { opacity: 1, y: 0, transition: { duration: 0.25, ease: \"easeOut\" } }\n                    }}\n                  >\n                    <span className=\"text-xl font-bold text-gray-800 text-center\">\n                      {cachedRegionLabel.split(' ')[0]} Stats\n                    </span>\n                    <img\n                      src={mathsHamsterGreen}\n                      alt=\"Global Stats\"\n                      className=\"max-h-[72px] w-auto object-contain mt-4\"\n                    />\n                  </motion.button>\n\n                  <motion.button\n                    className=\"flex-1 h-36 flex flex-col items-center justify-center px-4 rounded-3xl shadow-sm hover:shadow-md\"\n                    style={{ backgroundColor: \"#C4C9D4\" }}\n                    onClick={onOpenOptions}\n                    data-testid=\"button-options-desktop\"\n                    variants={{\n                      hidden: { opacity: 0, y: 20 },\n                      visible: { opacity: 1, y: 0, transition: { duration: 0.25, ease: \"easeOut\" } }\n                    }}\n                  >\n                    <span className=\"text-xl font-bold text-gray-800 text-center\">\n                      Options\n                    </span>\n                    <img\n                      src={mechanicHamsterGrey}\n                      alt=\"Options\"\n                      className=\"max-h-[72px] w-auto object-contain mt-4\"\n                    />\n                  </motion.button>\n\n                  <motion.button\n                    className=\"flex-1 h-36 flex flex-col items-center justify-center px-4 rounded-3xl shadow-sm hover:shadow-md\"\n                    style={{ backgroundColor: \"#93cd78\" }}\n                    onClick={() => {\n                      if (!isAuthenticated) {\n                        setShowGuestRestriction('personal');\n                        return;\n                      }\n                      onViewStatsLocal?.();\n                    }}\n                    data-testid=\"button-stats-desktop-local\"\n                    variants={{\n                      hidden: { opacity: 0, y: 20 },\n                      visible: { opacity: 1, y: 0, transition: { duration: 0.25, ease: \"easeOut\" } }\n                    }}\n                  >\n                    <span className=\"text-xl font-bold text-gray-800 text-center\">\n                      Personal Stats\n                    </span>\n                    <img\n                      src={mathsHamsterLocal}\n                      alt=\"Local Stats\"\n                      className=\"max-h-[72px] w-auto object-contain mt-4\"\n                    />\n                  </motion.button>\n                </motion.div>\n              </AnimatePresence>\n            </div>\n          </div>\n        ) : (\n          /* Mobile: Swipeable panes with floating Options button */\n          <div className=\"h-full w-full flex flex-col relative overflow-y-auto\">\n            {/* Swipeable Content */}\n            <div \n              ref={(node) => {\n                // Set containerRef from hook\n                if (containerRef && 'current' in containerRef) {\n                  (containerRef as React.MutableRefObject<HTMLDivElement | null>).current = node;\n                }\n                // Set swipeRef\n                if (swipeRef) {\n                  if (typeof swipeRef === 'function') {\n                    swipeRef(node);\n                  } else if ('current' in swipeRef) {\n                    (swipeRef as React.MutableRefObject<HTMLDivElement | null>).current = node;\n                  }\n                }\n              }}\n              className=\"flex-grow min-h-full\"\n              {...swipeProps}\n            >\n              <motion.div\n                className=\"flex h-full\"\n                style={{ \n                  x: x,\n                  width: '200%'\n                }}\n              >\n                {/* Global Pane */}\n                {renderGlobalPane()}\n\n                {/* Local Pane */}\n                {renderLocalPane()}\n              </motion.div>\n            </div>\n\n            {/* Options button overlay - positioned at Stats row level, moves at half-speed */}\n            {containerWidth > 0 && statsRowTop > 0 && (\n              <div \n                className=\"absolute left-0 right-0 pointer-events-none\"\n                style={{\n                  // Position at same vertical level as Stats row (dynamically tracked)\n                  top: `${statsRowTop}px`\n                }}\n              >\n                <div style={{ paddingLeft: '1rem', paddingRight: '1rem' }}>\n                  <div ref={contentRef} className=\"max-w-md mx-auto w-full relative h-40\">\n                    <motion.button\n                      className=\"absolute h-40 w-[calc(50%-0.5rem)] flex flex-col items-center justify-center px-4 rounded-3xl shadow-sm hover:shadow-md pointer-events-auto\"\n                      style={{ \n                        backgroundColor: \"#C4C9D4\",\n                        right: '-0px',\n                        x: buttonX,\n                        touchAction: 'pan-y'\n                      }}\n                      onClick={gameMode === 'global' ? onOpenOptions : onOpenOptionsLocal}\n                      data-testid=\"button-options-mobile\"\n                      initial={{ opacity: 0, y: 20 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      transition={{ duration: 0.25, delay: 0.3, ease: \"easeOut\" }}\n                    >\n                      <span className=\"text-xl font-bold text-gray-800 text-center\">\n                        Options\n                      </span>\n                      <img\n                        src={mechanicHamsterGrey}\n                        alt=\"Options\"\n                        className=\"max-h-[72px] w-auto object-contain mt-4\"\n                      />\n                    </motion.button>\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n        )}\n      </div>\n\n      <HelpDialog isOpen={showHelp} onClose={() => setShowHelp(false)} />\n\n      {/* Pro Subscription Dialog */}\n      <ProSubscriptionDialog\n        isOpen={showProDialog}\n        onClose={() => setShowProDialog(false)}\n        onSuccess={(selectedTier) => {\n          setShowProDialog(false);\n          setShowCategorySelection(true);\n        }}\n        onLoginRequired={onLogin}\n      />\n\n      {/* Category Selection Screen (after Pro subscription) */}\n      <CategorySelectionScreen\n        isOpen={showCategorySelection}\n        onClose={() => setShowCategorySelection(false)}\n        onGenerate={() => {\n          setShowCategorySelection(false);\n        }}\n      />\n\n      {/* Guest Restriction Popups */}\n      <GuestRestrictionPopup\n        isOpen={showGuestRestriction !== null}\n        type={showGuestRestriction || 'archive'}\n        onClose={() => {\n          setShowGuestRestriction(null);\n          // Always snap back to Global mode when closing restriction popup\n          snapTo('global');\n        }}\n        onRegister={() => {\n          setShowGuestRestriction(null);\n          if (onRegister) onRegister();\n        }}\n        onLogin={() => {\n          setShowGuestRestriction(null);\n          if (onLogin) onLogin();\n        }}\n      />\n\n      {/* Streak Saver Popup */}\n      {showStreakSaverPopup && streakStatus && (\n        <StreakSaverPopup\n          open={true}\n          onClose={(action?: StreakSaverCloseAction) => {\n            const currentType = showStreakSaverPopup;\n            setShowStreakSaverPopup(null);\n            \n            // If we just closed region popup and user also needs attention\n            // But NOT if holiday mode was just activated (covers both game modes)\n            const userCurrentStreak = streakStatus?.user?.currentStreak ?? 0;\n            if (currentType === 'region' && hasMissedUser && userCurrentStreak > 0 && !hasShownUserPopup && !holidayJustActivated) {\n              if (action === 'decline') {\n                // User let streak end - show user popup immediately\n                setHasShownUserPopup(true);\n                setTimeout(() => setShowStreakSaverPopup('user'), 300);\n              } else if (action === 'use_streak_saver') {\n                // User is navigating to play yesterday's puzzle\n                // Mark user popup as pending - will show when they return to GameSelectionPage\n                setUserPopupPendingOnReturn(true);\n              }\n              // For 'holiday' action: holidayJustActivated flag already prevents user popup\n              // For 'dismiss' action: don't show user popup (user explicitly dismissed)\n            }\n          }}\n          gameType={showStreakSaverPopup}\n          currentStreak={\n            showStreakSaverPopup === 'region' \n              ? streakStatus.region?.currentStreak || 0\n              : streakStatus.user?.currentStreak || 0\n          }\n          onPlayYesterdaysPuzzle={onPlayYesterdaysPuzzle}\n          onStartHolidayWithAnimation={(data) => {\n            // Mark holiday as just activated to prevent second streak saver popup\n            setHolidayJustActivated(true);\n            setHolidayOverlayData(data);\n            setShowHolidayOverlay(true);\n          }}\n          onShowCategorySelection={() => {\n            setShowStreakSaverPopup(null);\n            setShowCategorySelection(true);\n          }}\n        />\n      )}\n\n      {/* Holiday Activation Overlay */}\n      <HolidayActivationOverlay\n        show={showHolidayOverlay}\n        regionHolidayDates={holidayOverlayData.regionHolidayDates}\n        userHolidayDates={holidayOverlayData.userHolidayDates}\n        showUserAfterRegion={holidayOverlayData.showUserAfterRegion}\n        holidayDurationDays={holidayOverlayData.holidayDurationDays}\n        onComplete={() => {\n          setShowHolidayOverlay(false);\n          toast({\n            title: \"Holiday mode activated\",\n            description: `Your streak is now protected for the next ${holidayOverlayData.holidayDurationDays} days.`,\n          });\n        }}\n      />\n\n      {/* Pending Badge Celebration Popup */}\n      {pendingBadgeToShow && (\n        <BadgeCelebrationPopup\n          badge={pendingBadgeToShow}\n          onDismiss={async () => {\n            const badge = pendingBadgeToShow;\n            const gameType = pendingBadgeGameType;\n            \n            // Mark this badge as processed so we don't re-show it\n            setProcessedBadgeIds(prev => new Set(Array.from(prev).concat(badge.id)));\n            setIsAwarding(true);\n            \n            // Mark the badge as awarded in the backend\n            try {\n              await apiRequest('POST', `/api/badges/${badge.id}/award`);\n              \n              // Invalidate badges queries and wait for them to complete\n              const earnedEndpoint = gameType === 'USER' ? '/api/user/badges/earned' : '/api/badges/earned';\n              const pendingEndpoint = gameType === 'USER' ? '/api/user/badges/pending' : '/api/badges/pending';\n              await Promise.all([\n                queryClient.invalidateQueries({ queryKey: [earnedEndpoint] }),\n                queryClient.invalidateQueries({ queryKey: [pendingEndpoint] }),\n                queryClient.invalidateQueries({ queryKey: ['/api/badges/pending'] }),\n                queryClient.invalidateQueries({ queryKey: ['/api/user/badges/pending'] }),\n              ]);\n              \n              // Refetch to get fresh pending badge data\n              await Promise.all([\n                refetchGlobalPending(),\n                refetchLocalPending(),\n              ]);\n              \n              // Clear current popup\n              setPendingBadgeToShow(null);\n              setIsAwarding(false);\n              \n              // Navigate to stats page with the badge info for animation\n              if (onViewStatsWithBadge) {\n                onViewStatsWithBadge(badge, gameType);\n              }\n            } catch (error) {\n              console.error('[GameSelectionPage] Failed to mark badge as awarded:', error);\n              // Show error toast\n              toast({\n                title: \"Unable to save badge\",\n                description: \"Please try again later.\",\n                variant: \"destructive\",\n              });\n              // Remove from processed so it can be retried\n              setProcessedBadgeIds(prev => {\n                const newSet = new Set(prev);\n                newSet.delete(badge.id);\n                return newSet;\n              });\n              // Dismiss popup but allow retry\n              setPendingBadgeToShow(null);\n              setIsAwarding(false);\n            }\n          }}\n        />\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":63656,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\nimport { getSupabaseClient } from \"./supabaseClient\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const supabase = await getSupabaseClient();\n  \n  // Helper to make the request with current session\n  const makeRequest = async (): Promise<Response> => {\n    const { data: { session } } = await supabase.auth.getSession();\n    \n    const headers: HeadersInit = data ? { \"Content-Type\": \"application/json\" } : {};\n    \n    // Add Authorization header if user is authenticated\n    if (session?.access_token) {\n      headers[\"Authorization\"] = `Bearer ${session.access_token}`;\n    }\n\n    return await fetch(url, {\n      method,\n      headers,\n      body: data ? JSON.stringify(data) : undefined,\n      credentials: \"include\",\n    });\n  };\n\n  // Try the request\n  let res = await makeRequest();\n\n  // If 401, try to refresh session once and retry\n  if (res.status === 401) {\n    try {\n      const { data: { session: refreshedSession }, error } = await supabase.auth.refreshSession();\n      \n      if (!error && refreshedSession) {\n        // Retry with refreshed session\n        res = await makeRequest();\n      }\n    } catch (refreshError) {\n      console.error(\"Session refresh failed:\", refreshError);\n    }\n  }\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const supabase = await getSupabaseClient();\n    \n    // Helper to make the request with current session\n    const makeRequest = async (): Promise<Response> => {\n      const { data: { session } } = await supabase.auth.getSession();\n      \n      const headers: HeadersInit = {};\n      \n      // Add Authorization header if user is authenticated\n      if (session?.access_token) {\n        headers[\"Authorization\"] = `Bearer ${session.access_token}`;\n      }\n\n      return await fetch(queryKey.join(\"/\") as string, {\n        credentials: \"include\",\n        headers,\n      });\n    };\n\n    // Try the request\n    let res = await makeRequest();\n\n    // If 401, ALWAYS try to refresh session once and retry (regardless of on401 mode)\n    if (res.status === 401) {\n      try {\n        const { data: { session: refreshedSession }, error } = await supabase.auth.refreshSession();\n        \n        if (!error && refreshedSession) {\n          // Retry with refreshed session\n          res = await makeRequest();\n        }\n      } catch (refreshError) {\n        console.error(\"Session refresh failed:\", refreshError);\n      }\n      \n      // After retry attempt, apply the on401 behavior\n      if (res.status === 401) {\n        if (unauthorizedBehavior === \"returnNull\") {\n          return null;\n        }\n        // For \"throw\", let throwIfResNotOk handle it below\n      }\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":3531,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"server/routes.ts":{"content":"// Server routes for Elementle app with Supabase Auth\nimport type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { verifySupabaseAuth, requireAdmin } from \"./supabaseAuth\";\nimport { supabaseAdmin } from \"./supabase\";\nimport { db } from \"./db\";\nimport { sql } from \"drizzle-orm\";\n\n// Helper to calculate subscription end date\nfunction calculateEndDate(tier: string): Date | null {\n  const now = new Date();\n  if (tier === 'bronze') {\n    return new Date(now.setMonth(now.getMonth() + 1));\n  } else if (tier === 'silver') {\n    return new Date(now.setFullYear(now.getFullYear() + 1));\n  }\n  return null; // Gold is lifetime\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Supabase config endpoint (public - anon key is safe to expose)\n  app.get(\"/api/supabase-config\", (req, res) => {\n    res.json({\n      url: process.env.SUPABASE_URL,\n      anonKey: process.env.SUPABASE_ANON_KEY,\n    });\n  });\n\n  // Get all available regions\n  app.get(\"/api/regions\", async (req, res) => {\n    try {\n      const regions = await storage.getRegions();\n      res.json(regions);\n    } catch (error) {\n      console.error(\"Error fetching regions:\", error);\n      res.status(500).json({ error: \"Failed to fetch regions\" });\n    }\n  });\n\n  // Validate postcode exists in the location-based postcode table\n  // This checks against the same dataset used by populate_user_locations RPC\n  app.get(\"/api/postcodes/validate\", async (req, res) => {\n    try {\n      const postcode = req.query.postcode as string;\n      \n      if (!postcode) {\n        return res.json({ valid: true }); // Empty postcode is valid (optional field)\n      }\n      \n      // Sanitize: remove all non-alphanumeric characters and uppercase\n      const sanitizedPostcode = postcode.replace(/[^a-zA-Z0-9]/g, \"\").toUpperCase();\n      \n      // Validate UK postcode pattern (basic format: 2-4 chars, then 1 digit, then 2 alphanumerics)\n      // UK postcodes are 5-7 characters without spaces\n      const ukPostcodePattern = /^[A-Z]{1,2}[0-9][0-9A-Z]?[0-9][A-Z]{2}$/;\n      if (!ukPostcodePattern.test(sanitizedPostcode)) {\n        console.log(\"[GET /api/postcodes/validate] Invalid UK postcode format:\", sanitizedPostcode);\n        return res.json({ valid: false, reason: \"Invalid postcode format\" });\n      }\n      \n      console.log(\"[GET /api/postcodes/validate] Checking postcode:\", sanitizedPostcode);\n      \n      // Format postcode with space for database lookup (outward + inward code)\n      // UK postcodes have 3-character inward code at the end\n      const outward = sanitizedPostcode.slice(0, -3);\n      const inward = sanitizedPostcode.slice(-3);\n      const formattedPostcode = `${outward} ${inward}`;\n      \n      // Helper function to query the postcodes table with retry logic\n      // Uses .eq() with formatted postcode (canonical format) for better query performance\n      const queryPostcode = async (attempt: number = 1): Promise<{ data: any; error: any }> => {\n        const result = await supabaseAdmin\n          .from(\"postcodes\")\n          .select(\"name1\")\n          .eq(\"name1\", formattedPostcode)\n          .limit(1);\n        \n        // If timeout error (57014) and first attempt, retry once after short delay\n        if (result.error?.code === '57014' && attempt === 1) {\n          console.log(\"[GET /api/postcodes/validate] Query timeout, retrying...\");\n          await new Promise(resolve => setTimeout(resolve, 500));\n          return queryPostcode(2);\n        }\n        \n        return result;\n      };\n      \n      const { data, error } = await queryPostcode();\n      \n      if (error) {\n        console.error(\"[GET /api/postcodes/validate] Database error:\", error);\n        // FAIL CLOSED: On database errors, reject the postcode for safety\n        return res.json({ valid: false, reason: \"Could not validate postcode\" });\n      }\n      \n      const isValid = data && data.length > 0;\n      console.log(\"[GET /api/postcodes/validate] Postcode valid:\", isValid, \"Result:\", data);\n      \n      res.json({ valid: isValid });\n    } catch (error: any) {\n      console.error(\"[GET /api/postcodes/validate] Error:\", error);\n      // FAIL CLOSED: On any error, reject the postcode\n      res.json({ valid: false, reason: \"Validation error\" });\n    }\n  });\n\n  // PUBLIC puzzle endpoint for guests (defaults to UK region)\n  app.get(\"/api/puzzles/guest\", async (req, res) => {\n    try {\n      const region = 'UK'; // Default region for guests\n      \n      console.log('[GET /api/puzzles/guest] Fetching puzzles for guest with region:', region);\n      \n      // Set a timeout for the database query to prevent hanging\n      const timeoutPromise = new Promise<never>((_, reject) => \n        setTimeout(() => reject(new Error('Database query timeout')), 5000)\n      );\n      \n      const allocatedQuestions = await Promise.race([\n        storage.getAllocatedQuestionsByRegion(region),\n        timeoutPromise\n      ]);\n      \n      console.log('[GET /api/puzzles/guest] Found allocated questions:', allocatedQuestions.length);\n      \n      // Transform to frontend-compatible format - avoid N+1 queries by not fetching categories\n      const puzzles = allocatedQuestions.map((aq) => {\n        const categoriesArray = aq.masterQuestion.categories as number[] | null;\n        const categoryId = categoriesArray && categoriesArray.length > 0 ? categoriesArray[0] : null;\n        \n        return {\n          id: aq.id,\n          date: aq.puzzleDate,\n          answerDateCanonical: aq.masterQuestion.answerDateCanonical,\n          eventTitle: aq.masterQuestion.eventTitle,\n          eventDescription: aq.masterQuestion.eventDescription,\n          category: null, // Skip category name lookup for guests to improve performance\n          clue1: null,\n          clue2: null,\n          region: aq.region,\n          allocatedRegionId: aq.id,\n          masterQuestionId: aq.questionId,\n        };\n      });\n      \n      res.json(puzzles);\n    } catch (error) {\n      console.error(\"Error fetching guest puzzles:\", error);\n      res.status(500).json({ error: \"Failed to fetch puzzles\" });\n    }\n  });\n\n  // Server-side signup endpoint - creates both Supabase Auth user and profile\n  app.post(\"/api/auth/signup\", async (req, res) => {\n    try {\n      // Accept camelCase from frontend (TypeScript convention)\n      const { email, password, firstName, lastName, region, acceptedTerms, adsConsent } = req.body;\n\n      // Create auth user - email verification will be required\n      // Explicitly set first_login_completed to false to ensure GeneratingQuestionsScreen runs\n      const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({\n        email,\n        password,\n        email_confirm: false, // Require email verification\n        user_metadata: {\n          first_name: firstName,\n          last_name: lastName,\n          first_login_completed: false, // Ensure onboarding screen runs for new users\n        },\n      });\n\n      if (authError || !authData.user) {\n        return res.status(400).json({ error: authError?.message || 'Failed to create user' });\n      }\n\n      const now = new Date();\n\n      // Get the region's default date format\n      const regions = await storage.getRegions();\n      const finalRegion = region || (regions.length > 0 ? regions[0].code : null);\n      const selectedRegion = regions.find(r => r.code === finalRegion);\n      const defaultDateFormat = selectedRegion?.defaultDateFormat ?? 'ddmmyy';\n\n      // Create user profile with consent fields and region\n      const profileData: any = {\n        id: authData.user.id,\n        email: authData.user.email!,\n        firstName,\n        lastName,\n        region: finalRegion,\n        acceptedTerms: acceptedTerms ?? false,\n        adsConsent: adsConsent ?? false,\n      };\n\n      // Set timestamps for consents that were accepted\n      if (acceptedTerms) {\n        profileData.acceptedTermsAt = now;\n      }\n      if (adsConsent) {\n        profileData.adsConsentUpdatedAt = now;\n      }\n\n      await storage.upsertUserProfile(profileData);\n\n      // Create user settings with default date format preference based on region\n      await storage.upsertUserSettings({\n        userId: authData.user.id,\n        dateFormatPreference: defaultDateFormat,\n        useRegionDefault: true,\n        digitPreference: '6',\n        soundsEnabled: true,\n        darkMode: false,\n        cluesEnabled: true,\n        categoryPreferences: null,\n      });\n\n      res.json({ user: authData.user });\n    } catch (error) {\n      console.error(\"Signup error:\", error);\n      res.status(500).json({ error: \"Failed to sign up\" });\n    }\n  });\n\n  // Check if user exists and their auth method (for login page)\n  app.get(\"/api/auth/check-user\", async (req, res) => {\n    try {\n      const email = req.query.email as string;\n      \n      if (!email) {\n        return res.status(400).json({ error: \"Email is required\" });\n      }\n\n      // Check if user profile exists in our database first (fast lookup)\n      const { data: profiles, error: profileError } = await supabaseAdmin\n        .from(\"user_profiles\")\n        .select(\"id, email, password_created, google_linked, apple_linked\")\n        .eq(\"email\", email.toLowerCase())\n        .limit(1);\n\n      if (profileError) {\n        console.error(\"[GET /api/auth/check-user] Profile lookup error:\", profileError);\n      }\n\n      // If no profile found in our database, user hasn't signed up through our app\n      if (!profiles || profiles.length === 0) {\n        console.log(\"[GET /api/auth/check-user] User not found in profiles:\", email);\n        return res.json({ exists: false, hasPassword: false, hasMagicLink: false, magicLinkEnabled: true });\n      }\n\n      // Check actual fields from user_profiles\n      const hasPassword = profiles[0].password_created === true;\n      const googleLinked = profiles[0].google_linked === true;\n      const appleLinked = profiles[0].apple_linked === true;\n      \n      // Fetch magic_link separately to avoid breaking if column doesn't exist\n      let magicLinkEnabled = true; // Default to true\n      try {\n        const { data: mlData } = await supabaseAdmin\n          .from(\"user_profiles\")\n          .select(\"magic_link\")\n          .eq(\"id\", profiles[0].id)\n          .single();\n        if (mlData && mlData.magic_link !== undefined) {\n          magicLinkEnabled = mlData.magic_link !== false;\n        }\n      } catch (e) {\n        // Column might not exist yet, default to true\n        console.log(\"[GET /api/auth/check-user] magic_link column not available, defaulting to true\");\n      }\n      \n      console.log(\"[GET /api/auth/check-user] User found:\", email, \"hasPassword:\", hasPassword, \"googleLinked:\", googleLinked, \"appleLinked:\", appleLinked, \"magicLinkEnabled:\", magicLinkEnabled);\n      \n      res.json({ \n        exists: true, \n        hasPassword: hasPassword,\n        hasMagicLink: true, // Magic link is available for all email users\n        magicLinkEnabled: magicLinkEnabled, // Whether user has enabled magic link login\n        googleLinked: googleLinked,\n        appleLinked: appleLinked,\n      });\n    } catch (error: any) {\n      console.error(\"[GET /api/auth/check-user] Error:\", error);\n      res.status(500).json({ error: \"Failed to check user\" });\n    }\n  });\n\n  // Auth routes - Supabase handles these client-side mostly,\n  // but we need profile endpoints\n  app.get(\"/api/auth/profile\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      \n      // Get profile from database\n      const profile = await storage.getUserProfile(userId);\n      if (!profile) {\n        return res.status(404).json({ error: \"Profile not found\" });\n      }\n\n      res.json(profile);\n    } catch (error) {\n      console.error(\"Error fetching profile:\", error);\n      res.status(500).json({ error: \"Failed to fetch profile\" });\n    }\n  });\n\n  app.patch(\"/api/auth/profile\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      console.log(\"PATCH /api/auth/profile body:\", req.body);\n\n      const userId = req.user.id;\n      const { firstName, lastName, email, region, postcode, acceptedTerms, adsConsent } = req.body;\n\n      const existing = await storage.getUserProfile(userId);\n      \n      // If no profile exists, create a new one (upsert behavior for new signups)\n      if (!existing) {\n        console.log(\"Profile not found, creating new profile for user:\", userId);\n        const now = new Date();\n        \n        // Get the region's default date format\n        const regions = await storage.getRegions();\n        const finalRegion = region || (regions.length > 0 ? regions[0].code : null);\n        const selectedRegion = regions.find(r => r.code === finalRegion);\n        const defaultDateFormat = selectedRegion?.defaultDateFormat ?? 'ddmmyy';\n        \n        // Look up the Standard tier ID for the user's region\n        const standardTierId = await storage.getStandardTierId(finalRegion || 'UK');\n        if (!standardTierId) {\n          console.error(`[PATCH /api/auth/profile] No Standard tier found for region: ${finalRegion}`);\n        } else {\n          console.log(`[PATCH /api/auth/profile] Using Standard tier ID: ${standardTierId} for region: ${finalRegion}`);\n        }\n        \n        const newProfile = await storage.upsertUserProfile({\n          id: userId,\n          email: email || req.user.email,\n          firstName: firstName || '',\n          lastName: lastName || '',\n          region: finalRegion,\n          postcode: postcode || null,\n          acceptedTerms: acceptedTerms ?? false,\n          adsConsent: adsConsent ?? false,\n          acceptedTermsAt: acceptedTerms ? now : null,\n          adsConsentUpdatedAt: adsConsent ? now : null,\n          emailVerified: false,\n          userTierId: standardTierId, // Set the Standard tier for the user's region\n          // postcodeLastChangedAt remains NULL - will be set by GeneratingQuestionsScreen after first question generation\n        });\n        \n        // Also create default user settings\n        await storage.upsertUserSettings({\n          userId,\n          dateFormatPreference: defaultDateFormat,\n          useRegionDefault: true,\n          digitPreference: '8',\n          soundsEnabled: true,\n          darkMode: false,\n          cluesEnabled: true,\n          categoryPreferences: null,\n        });\n        \n        return res.json(newProfile);\n      }\n\n      const now = new Date();\n      \n      // Check if postcode or region is being changed\n      const postcodeChanging = postcode !== undefined && postcode !== existing.postcode;\n      const regionChanging = region !== undefined && region !== existing.region;\n      const locationChanging = postcodeChanging || regionChanging;\n      \n      // If location is changing, check the restriction\n      if (locationChanging) {\n        // Fetch the restriction setting\n        const restrictionSetting = await storage.getAdminSetting('postcode_restriction_days');\n        const restrictionDays = restrictionSetting ? parseInt(restrictionSetting.value, 10) : 14;\n        \n        // Check if user can change (only if restriction > 0)\n        // Skip restriction if user has no postcode - allow them to add one without restriction\n        const hasExistingPostcode = existing.postcode && existing.postcode.trim() !== '';\n        if (restrictionDays > 0 && existing.postcodeLastChangedAt && hasExistingPostcode) {\n          const lastChanged = new Date(existing.postcodeLastChangedAt);\n          const allowedAfter = new Date(lastChanged);\n          allowedAfter.setDate(allowedAfter.getDate() + restrictionDays);\n          \n          if (now < allowedAfter) {\n            console.log(`[PATCH /api/auth/profile] Location change blocked - last changed: ${lastChanged}, allowed after: ${allowedAfter}`);\n            \n            // Still save name/email changes if provided\n            if (firstName !== undefined || lastName !== undefined || email !== undefined) {\n              const partialUpdate = await storage.upsertUserProfile({\n                id: userId,\n                email: email ?? existing.email,\n                firstName: firstName ?? existing.firstName,\n                lastName: lastName ?? existing.lastName,\n                region: existing.region, // Keep existing\n                postcode: existing.postcode, // Keep existing\n                acceptedTerms: acceptedTerms ?? existing.acceptedTerms ?? false,\n                adsConsent: adsConsent ?? existing.adsConsent ?? false,\n                acceptedTermsAt: existing.acceptedTermsAt ? new Date(existing.acceptedTermsAt) : null,\n                adsConsentUpdatedAt: existing.adsConsentUpdatedAt ? new Date(existing.adsConsentUpdatedAt) : null,\n                emailVerified: existing.emailVerified ?? false,\n              });\n              \n              // Return success with restriction notice\n              return res.status(200).json({\n                ...partialUpdate,\n                _restrictionBlocked: true,\n                _restrictionMessage: `You can update your postcode or region once every ${restrictionDays} days and Hammie will regenerate your questions`,\n                _restrictionDays: restrictionDays,\n              });\n            }\n            \n            // If only location changes were requested and blocked\n            return res.status(400).json({\n              error: `You can update your postcode or region once every ${restrictionDays} days and Hammie will regenerate your questions`,\n              code: \"LOCATION_COOLDOWN\",\n              restrictionDays,\n            });\n          }\n        }\n      }\n\n      // If user_tier_id is missing (e.g., profile created by Supabase trigger), set it now\n      let userTierId = existing.userTierId;\n      if (!userTierId) {\n        const finalRegion = region ?? existing.region ?? 'UK';\n        const standardTierId = await storage.getStandardTierId(finalRegion);\n        if (standardTierId) {\n          console.log(`[PATCH /api/auth/profile] Setting missing user_tier_id to Standard tier: ${standardTierId} for region: ${finalRegion}`);\n          userTierId = standardTierId;\n        } else {\n          console.error(`[PATCH /api/auth/profile] No Standard tier found for region: ${finalRegion}`);\n        }\n      }\n\n      // Build profile update with location change timestamp if needed\n      const profileUpdate: any = {\n        id: userId,\n        email: email ?? existing.email,\n        firstName: firstName ?? existing.firstName,\n        lastName: lastName ?? existing.lastName,\n        region: region ?? existing.region ?? null,\n        postcode: postcode !== undefined ? postcode : existing.postcode,\n        acceptedTerms: acceptedTerms ?? existing.acceptedTerms ?? false,\n        adsConsent: adsConsent ?? existing.adsConsent ?? false,\n        acceptedTermsAt:\n          acceptedTerms !== undefined && acceptedTerms !== existing.acceptedTerms\n            ? now\n            : existing.acceptedTermsAt ? new Date(existing.acceptedTermsAt) : null,\n        adsConsentUpdatedAt:\n          adsConsent !== undefined && adsConsent !== existing.adsConsent\n            ? now\n            : existing.adsConsentUpdatedAt ? new Date(existing.adsConsentUpdatedAt) : null,\n        emailVerified: existing.emailVerified ?? false,\n        userTierId: userTierId, // Ensure user_tier_id is set\n      };\n      \n      // Note: postcodeLastChangedAt is updated by GeneratingQuestionsScreen after question regeneration completes\n      // This ensures the timestamp reflects when questions were actually regenerated, not just when profile was saved\n\n      const updatedProfile = await storage.upsertUserProfile(profileUpdate);\n\n      res.json(updatedProfile);\n    } catch (error: any) {\n      console.error(\"Error updating profile:\", error);\n      \n      // Check for postcode guard trigger error (legacy 14-day restriction from Supabase)\n      if (error?.message?.includes('postcode once every')) {\n        const match = error.message.match(/postcode once every (\\d+) days/);\n        const days = match ? match[1] : '14';\n        return res.status(400).json({ \n          error: `You can update your postcode or region once every ${days} days and Hammie will regenerate your questions`,\n          code: \"LOCATION_COOLDOWN\"\n        });\n      }\n      \n      // Check for RLS policy violations\n      if (error?.code === '42501' || error?.message?.includes('permission denied') || error?.message?.includes('row-level security')) {\n        return res.status(403).json({ \n          error: \"You don't have permission to update this profile.\",\n          code: \"PERMISSION_DENIED\"\n        });\n      }\n      \n      res.status(500).json({ error: \"Failed to update profile\" });\n    }\n  });\n\n  // Set signup method and password_created on first login (only sets if not already set)\n  app.post(\"/api/auth/profile/signup-method\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { signupMethod, passwordCreated } = req.body;\n      \n      console.log(`[POST /api/auth/profile/signup-method] userId: ${userId}, signupMethod: ${signupMethod}, passwordCreated: ${passwordCreated}`);\n      \n      const existing = await storage.getUserProfile(userId);\n      if (!existing) {\n        return res.status(404).json({ error: \"Profile not found\" });\n      }\n      \n      // Only set signup_method if not already set (first time only)\n      if (existing.signupMethod) {\n        console.log(`[POST /api/auth/profile/signup-method] Signup method already set to: ${existing.signupMethod}, skipping`);\n        return res.json({ \n          signupMethod: existing.signupMethod, \n          passwordCreated: existing.passwordCreated,\n          alreadySet: true \n        });\n      }\n      \n      // Update profile with signup method and password_created\n      const updatedProfile = await storage.updateSignupMethod(userId, signupMethod, passwordCreated);\n      \n      res.json({ \n        signupMethod: updatedProfile.signupMethod, \n        passwordCreated: updatedProfile.passwordCreated,\n        alreadySet: false \n      });\n    } catch (error: any) {\n      console.error(\"Error setting signup method:\", error);\n      res.status(500).json({ error: \"Failed to set signup method\" });\n    }\n  });\n  \n  // Update password_created status (called when user creates a password)\n  app.post(\"/api/auth/profile/password-created\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { setSignupMethod } = req.body; // Optional: also set signup_method to 'password'\n      \n      console.log(`[POST /api/auth/profile/password-created] userId: ${userId}, setSignupMethod: ${setSignupMethod}`);\n      \n      const existing = await storage.getUserProfile(userId);\n      if (!existing) {\n        return res.status(404).json({ error: \"Profile not found\" });\n      }\n      \n      // If signup_method is not already set and setSignupMethod is true, set it to 'password'\n      if (setSignupMethod && !existing.signupMethod) {\n        await storage.updateSignupMethod(userId, 'password', true);\n        const finalProfile = await storage.getUserProfile(userId);\n        res.json({ passwordCreated: finalProfile?.passwordCreated, signupMethod: finalProfile?.signupMethod });\n      } else {\n        // Just update password_created to true\n        const updatedProfile = await storage.updatePasswordCreated(userId, true);\n        res.json({ passwordCreated: updatedProfile.passwordCreated });\n      }\n    } catch (error: any) {\n      console.error(\"Error updating password_created:\", error);\n      res.status(500).json({ error: \"Failed to update password status\" });\n    }\n  });\n\n  // Update OAuth provider linking status\n  app.post(\"/api/auth/profile/oauth-linked\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { provider, linked } = req.body;\n      \n      if (!provider || !['google', 'apple'].includes(provider)) {\n        return res.status(400).json({ error: \"Invalid provider. Must be 'google' or 'apple'\" });\n      }\n      \n      if (typeof linked !== 'boolean') {\n        return res.status(400).json({ error: \"linked must be a boolean\" });\n      }\n      \n      console.log(`[POST /api/auth/profile/oauth-linked] userId: ${userId}, provider: ${provider}, linked: ${linked}`);\n      \n      const existing = await storage.getUserProfile(userId);\n      if (!existing) {\n        return res.status(404).json({ error: \"Profile not found\" });\n      }\n      \n      // Also set signup_method if this is the first time and linked is true\n      if (linked && !existing.signupMethod) {\n        await storage.updateSignupMethod(userId, provider, false);\n      }\n      \n      const updatedProfile = await storage.updateOAuthLinked(userId, provider, linked);\n      \n      res.json({ \n        googleLinked: updatedProfile.googleLinked, \n        appleLinked: updatedProfile.appleLinked,\n        signupMethod: updatedProfile.signupMethod,\n      });\n    } catch (error: any) {\n      console.error(\"Error updating OAuth linked status:\", error);\n      res.status(500).json({ error: \"Failed to update OAuth status\" });\n    }\n  });\n\n  // Get magic link login enabled/disabled status\n  app.get(\"/api/auth/profile/magic-link-status\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      \n      // Fetch magic_link from user_profiles\n      const { data, error } = await supabaseAdmin\n        .from(\"user_profiles\")\n        .select(\"magic_link\")\n        .eq(\"id\", userId)\n        .single();\n      \n      if (error) {\n        // Column might not exist yet, default to true\n        console.log(\"[GET /api/auth/profile/magic-link-status] Error or column not found, defaulting to true\");\n        return res.json({ enabled: true });\n      }\n      \n      res.json({ enabled: data?.magic_link !== false });\n    } catch (error: any) {\n      console.error(\"Error fetching magic link status:\", error);\n      res.json({ enabled: true }); // Default to true on error\n    }\n  });\n\n  // Update magic link login enabled/disabled status\n  app.post(\"/api/auth/profile/magic-link\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { enabled } = req.body;\n      \n      if (typeof enabled !== 'boolean') {\n        return res.status(400).json({ error: \"enabled must be a boolean\" });\n      }\n      \n      console.log(`[POST /api/auth/profile/magic-link] userId: ${userId}, enabled: ${enabled}`);\n      \n      const existing = await storage.getUserProfile(userId);\n      if (!existing) {\n        return res.status(404).json({ error: \"Profile not found\" });\n      }\n      \n      // Update the magic_link field in user_profiles\n      const { data, error } = await supabaseAdmin\n        .from(\"user_profiles\")\n        .update({ magic_link: enabled })\n        .eq(\"id\", userId)\n        .select()\n        .single();\n      \n      if (error) {\n        console.error(\"[POST /api/auth/profile/magic-link] Error:\", error);\n        throw error;\n      }\n      \n      res.json({ magicLink: data.magic_link });\n    } catch (error: any) {\n      console.error(\"Error updating magic link status:\", error);\n      res.status(500).json({ error: \"Failed to update magic link status\" });\n    }\n  });\n\n  // Send password reset email for iOS PWA users who need to set a password\n  // This is a secure alternative to directly setting passwords\n  app.post(\"/api/auth/send-password-reset\", async (req, res) => {\n    try {\n      const { email } = req.body;\n      \n      if (!email) {\n        return res.status(400).json({ error: \"Email is required\" });\n      }\n      \n      console.log(`[POST /api/auth/send-password-reset] Sending reset email to: ${email}`);\n      \n      // Use Supabase's built-in password reset which sends a secure email\n      const { error } = await supabaseAdmin.auth.resetPasswordForEmail(email, {\n        redirectTo: `${process.env.REPL_SLUG ? `https://${process.env.REPL_SLUG}.replit.app` : 'http://localhost:5000'}/reset-password`,\n      });\n      \n      if (error) {\n        console.error(\"[POST /api/auth/send-password-reset] Error:\", error);\n        // Don't reveal if email exists or not for security\n        return res.json({ success: true, message: \"If an account exists, a password reset email has been sent.\" });\n      }\n      \n      console.log(`[POST /api/auth/send-password-reset] Reset email sent to: ${email}`);\n      res.json({ success: true, message: \"Password reset email sent. Check your inbox.\" });\n    } catch (error: any) {\n      console.error(\"[POST /api/auth/send-password-reset] Error:\", error);\n      res.status(500).json({ error: \"Failed to send reset email\" });\n    }\n  });\n  \n  // Set password for authenticated user only (requires valid session)\n  app.post(\"/api/auth/set-password\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { password } = req.body;\n      \n      if (!password) {\n        return res.status(400).json({ error: \"Password is required\" });\n      }\n      \n      console.log(`[POST /api/auth/set-password] Setting password for authenticated user: ${userId}`);\n      \n      // Update the user's password using admin API\n      const { error: updateError } = await supabaseAdmin.auth.admin.updateUserById(\n        userId,\n        { password }\n      );\n      \n      if (updateError) {\n        console.error(\"[POST /api/auth/set-password] Error updating password:\", updateError);\n        return res.status(500).json({ error: \"Failed to set password\" });\n      }\n      \n      // Update password_created in user_profiles\n      await storage.updatePasswordCreated(userId, true);\n      \n      console.log(`[POST /api/auth/set-password] Password set successfully for: ${userId}`);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"[POST /api/auth/set-password] Error:\", error);\n      res.status(500).json({ error: \"Failed to set password\" });\n    }\n  });\n\n  // Puzzle routes - REGION MODE (requires authentication for region context)\n  app.get(\"/api/puzzles\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const startTime = Date.now();\n      const userId = req.user.id;\n      const profile = await storage.getUserProfile(userId);\n      \n      // Default to 'UK' if no region set\n      const region = profile?.region || 'UK';\n      \n      console.log('[GET /api/puzzles] User profile region:', profile?.region, '| Using region:', region, '| userId:', userId);\n      \n      const allocatedQuestions = await storage.getAllocatedQuestionsByRegion(region);\n      \n      console.log('[GET /api/puzzles] Found allocated questions:', allocatedQuestions.length);\n      \n      // Batch load all categories upfront to avoid N+1 queries\n      // Collect all unique category IDs first\n      const categoryIds = new Set<number>();\n      for (const aq of allocatedQuestions) {\n        const categoriesArray = aq.masterQuestion.categories as number[] | null;\n        if (categoriesArray && categoriesArray.length > 0) {\n          categoryIds.add(categoriesArray[0]);\n        }\n      }\n      \n      // Fetch all categories in one batch\n      const allCategories = await storage.getAllCategories();\n      const categoryMap = new Map<number, string>();\n      for (const cat of allCategories) {\n        categoryMap.set(cat.id, cat.name);\n      }\n      \n      // Transform to frontend-compatible format using the category map\n      const puzzles = allocatedQuestions.map((aq) => {\n        const categoriesArray = aq.masterQuestion.categories as number[] | null;\n        let categoryName: string | null = null;\n        if (categoriesArray && categoriesArray.length > 0) {\n          categoryName = categoryMap.get(categoriesArray[0]) || null;\n        }\n        \n        return {\n          id: aq.id, // This is now allocatedRegionId\n          date: aq.puzzleDate,\n          answerDateCanonical: aq.masterQuestion.answerDateCanonical,\n          eventTitle: aq.masterQuestion.eventTitle,\n          eventDescription: aq.masterQuestion.eventDescription,\n          category: categoryName, // Add category name for IntroScreen\n          clue1: null, // Clues removed in new schema\n          clue2: null, // Clues removed in new schema\n          // Region-specific fields\n          region: aq.region,\n          allocatedRegionId: aq.id,\n          masterQuestionId: aq.questionId,\n        };\n      });\n      \n      console.log('[GET /api/puzzles] Completed in', Date.now() - startTime, 'ms');\n      res.json(puzzles);\n    } catch (error) {\n      console.error(\"Error fetching puzzles:\", error);\n      res.status(500).json({ error: \"Failed to fetch puzzles\" });\n    }\n  });\n\n  app.get(\"/api/puzzles/:date\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const profile = await storage.getUserProfile(userId);\n      \n      const region = profile?.region || 'UK';\n      const allocatedQuestion = await storage.getAllocatedQuestionByRegionAndDate(region, req.params.date);\n      \n      if (!allocatedQuestion) {\n        return res.status(404).json({ error: \"Puzzle not found\" });\n      }\n      \n      // Extract first category ID from categories jsonb array and look up the name\n      const categoriesArray = allocatedQuestion.masterQuestion.categories as number[] | null;\n      let categoryName: string | null = null;\n      if (categoriesArray && categoriesArray.length > 0) {\n        const category = await storage.getCategoryById(categoriesArray[0]);\n        categoryName = category?.name || null;\n      }\n      \n      // Transform to frontend-compatible format\n      const puzzle = {\n        id: allocatedQuestion.id,\n        date: allocatedQuestion.puzzleDate,\n        answerDateCanonical: allocatedQuestion.masterQuestion.answerDateCanonical,\n        eventTitle: allocatedQuestion.masterQuestion.eventTitle,\n        eventDescription: allocatedQuestion.masterQuestion.eventDescription,\n        category: categoryName, // Add category name for IntroScreen\n        clue1: null, // Clues removed in new schema\n        clue2: null, // Clues removed in new schema\n        region: allocatedQuestion.region,\n        allocatedRegionId: allocatedQuestion.id,\n        masterQuestionId: allocatedQuestion.questionId,\n      };\n      \n      res.json(puzzle);\n    } catch (error) {\n      console.error(\"Error fetching puzzle:\", error);\n      res.status(500).json({ error: \"Failed to fetch puzzle\" });\n    }\n  });\n\n  // User settings routes\napp.get(\"/api/settings\", verifySupabaseAuth, async (req: any, res) => {\n  try {\n    const userId = req.user.id;\n    const settings = await storage.getUserSettings(userId);\n    res.json(settings || {});\n  } catch (error) {\n    console.error(\"Error fetching settings:\", error);\n    res.status(500).json({ error: \"Failed to fetch settings\" });\n  }\n});\n\napp.post(\"/api/settings\", verifySupabaseAuth, async (req: any, res) => {\n  try {\n    const userId = req.user.id;\n    \n    // If dateFormatPreference is not provided, get it from user's region default\n    let dateFormatPreference = req.body.dateFormatPreference;\n    if (!dateFormatPreference && req.body.useRegionDefault !== false) {\n      const profile = await storage.getUserProfile(userId);\n      if (profile?.region) {\n        const regions = await storage.getRegions();\n        const userRegion = regions.find(r => r.code === profile.region);\n        if (userRegion) {\n          dateFormatPreference = userRegion.defaultDateFormat;\n        }\n      }\n    }\n    \n    const settings = await storage.upsertUserSettings({\n      userId,\n      ...req.body,\n      dateFormatPreference: dateFormatPreference || req.body.dateFormatPreference || 'ddmmyy',\n    });\n    res.json(settings);\n  } catch (error) {\n    console.error(\"Error saving settings:\", error);\n    res.status(500).json({ error: \"Failed to save settings\" });\n  }\n});\n\n// Game attempt routes - REGION MODE\napp.post(\"/api/game-attempts\", verifySupabaseAuth, async (req: any, res) => {\n  try {\n    const userId = req.user.id;\n    // Frontend now sends allocatedRegionId (but may still send puzzleId for compatibility)\n    const allocatedRegionId = req.body.allocatedRegionId || req.body.puzzleId;\n\n    console.log('[POST /api/game-attempts] Request:', { userId, allocatedRegionId, numGuesses: req.body.numGuesses, result: req.body.result });\n\n    if (!allocatedRegionId) {\n      return res.status(400).json({ error: \"Missing allocatedRegionId in body\" });\n    }\n\n    // Defensive normalization: convert legacy \"win\"/\"loss\" to \"won\"/\"lost\"\n    let result = req.body.result;\n    if (result === \"win\") result = \"won\";\n    if (result === \"loss\") result = \"lost\";\n\n    // Try to find an existing attempt\n    const existing = await storage.getGameAttemptByUserAndAllocated(userId, allocatedRegionId);\n\n    if (existing) {\n      console.log('[POST /api/game-attempts] Found existing attempt:', { id: existing.id, numGuesses: existing.numGuesses, result: existing.result });\n      \n      // If attempt is already completed, don't allow mutation\n      if (existing.result !== null) {\n        console.log('[POST /api/game-attempts] Attempt is completed, returning without mutation');\n        return res.json(existing);\n      }\n      \n      // Update in-progress attempt\n      const updates: any = {};\n      \n      if (result && result !== null) {\n        updates.result = result;\n        console.log('[POST /api/game-attempts] Client sent result in POST:', result);\n      }\n      \n      if (typeof req.body.numGuesses === \"number\" && req.body.numGuesses > (existing.numGuesses ?? 0)) {\n        updates.numGuesses = req.body.numGuesses;\n      }\n      \n      if (Object.keys(updates).length > 0) {\n        const updated = await storage.updateGameAttemptRegion(existing.id, updates);\n        console.log('[POST /api/game-attempts] Updated existing attempt:', { result: updated.result, numGuesses: updated.numGuesses });\n        return res.json(updated);\n      }\n      \n      return res.json(existing);\n    }\n    \n    // No attempt exists - create a fresh one\n    console.log('[POST /api/game-attempts] No attempt exists, creating fresh one');\n    const gameAttempt = await storage.createGameAttemptRegion({\n      userId,\n      allocatedRegionId,\n      result: result ?? null,\n      numGuesses: req.body.numGuesses ?? 0,\n    });\n\n    console.log('[POST /api/game-attempts] Created attempt:', { id: gameAttempt.id, numGuesses: gameAttempt.numGuesses });\n\n    res.json(gameAttempt);\n  } catch (error) {\n    console.error(\"[POST /api/game-attempts] Error:\", error);\n    res.status(500).json({ error: \"Failed to create/upsert game attempt\" });\n  }\n});\n\napp.get(\"/api/game-attempts/user\", verifySupabaseAuth, async (req: any, res) => {\n  try {\n    const userId = req.user.id;\n    const attempts = await storage.getGameAttemptsByUserRegion(userId);\n    \n    // Transform to include puzzle-like fields for backward compatibility\n    const transformedAttempts = attempts.map(attempt => ({\n      ...attempt,\n      puzzleId: attempt.allocatedRegionId, // Backward compat\n      puzzle: {\n        id: attempt.allocatedQuestion.id,\n        date: attempt.allocatedQuestion.puzzleDate,\n        answerDateCanonical: attempt.allocatedQuestion.masterQuestion.answerDateCanonical,\n        eventTitle: attempt.allocatedQuestion.masterQuestion.eventTitle,\n        eventDescription: attempt.allocatedQuestion.masterQuestion.eventDescription,\n      },\n    }));\n    \n    res.json(transformedAttempts);\n  } catch (error) {\n    console.error(\"Error fetching game attempts:\", error);\n    res.status(500).json({ error: \"Failed to fetch game attempts\" });\n  }\n});\n\napp.patch(\"/api/game-attempts/:id\", verifySupabaseAuth, async (req: any, res) => {\n  try {\n    const id = parseInt(req.params.id);\n    const userId = req.user.id;\n\n    console.log('[PATCH /api/game-attempts/:id] Request:', { id, userId, updates: req.body });\n\n    // Verify ownership\n    const allAttempts = await storage.getGameAttemptsByUserRegion(userId);\n    const ownedAttempt = allAttempts.find(a => a.id === id);\n\n    if (!ownedAttempt) {\n      console.error('[PATCH /api/game-attempts/:id] Attempt not owned by user:', id);\n      return res.status(403).json({ error: \"Forbidden: You do not own this game attempt\" });\n    }\n\n    console.log('[PATCH /api/game-attempts/:id] Current state:', {\n      result: ownedAttempt.result,\n      numGuesses: ownedAttempt.numGuesses,\n      completedAt: ownedAttempt.completedAt\n    });\n\n    // Defensive normalization\n    const updates: any = { ...req.body };\n    if (updates.result === \"win\") updates.result = \"won\";\n    if (updates.result === \"loss\") updates.result = \"lost\";\n\n    // Prevent mutating identity columns\n    delete updates.userId;\n    delete updates.user_id;\n    delete updates.puzzleId;\n    delete updates.puzzle_id;\n    delete updates.allocatedRegionId;\n    delete updates.allocated_region_id;\n\n    // Ensure numGuesses never decreases\n    if (typeof updates.numGuesses === \"number\") {\n      const previousNumGuesses = ownedAttempt.numGuesses ?? 0;\n      updates.numGuesses = Math.max(updates.numGuesses, previousNumGuesses);\n      console.log('[PATCH /api/game-attempts/:id] numGuesses:', { previous: previousNumGuesses, requested: req.body.numGuesses, final: updates.numGuesses });\n    }\n\n    // Handle streak_day_status for today's puzzle or streak saver (yesterday's puzzle)\n    // IMPORTANT: Only update streak_day_status for yesterday's puzzle if isStreakSaverPlay is true\n    // Archive plays should NOT update streak_day_status (preserve holiday protection, etc.)\n    const puzzleDate = ownedAttempt.allocatedQuestion?.puzzleDate;\n    const today = new Date().toISOString().split('T')[0];\n    const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];\n    const twoDaysAgo = new Date(Date.now() - 2 * 86400000).toISOString().split('T')[0];\n    const isTodaysPuzzle = puzzleDate === today;\n    const isYesterdaysPuzzle = puzzleDate === yesterday;\n    const isStreakSaverPlay = req.body.isStreakSaverPlay === true;\n    \n    // Server-side validation for streak saver: puzzle must be within last 2 days\n    // (yesterday or 2 days ago to account for timezone edge cases)\n    const isValidStreakSaverWindow = puzzleDate === yesterday || puzzleDate === twoDaysAgo;\n    const isValidatedStreakSaverPlay = isStreakSaverPlay && isValidStreakSaverWindow;\n    \n    // Remove isStreakSaverPlay from updates as it's not a database column\n    delete updates.isStreakSaverPlay;\n    \n    if (updates.result === \"won\" && isTodaysPuzzle) {\n      // Today's puzzle win - always set streak_day_status = 1\n      updates.streakDayStatus = 1;\n      console.log('[PATCH /api/game-attempts/:id] Setting streak_day_status = 1 (today)');\n    } else if (updates.result === \"won\" && isValidatedStreakSaverPlay) {\n      // Streak saver win - set streak_day_status = 1\n      // Validate: isStreakSaverPlay flag from frontend + puzzle date within last 2 days\n      updates.streakDayStatus = 1;\n      console.log('[PATCH /api/game-attempts/:id] Setting streak_day_status = 1 (streak saver)', { puzzleDate, today, yesterday, twoDaysAgo });\n    } else if (updates.result === \"lost\" && isValidatedStreakSaverPlay) {\n      // Streak saver loss: leave streak_day_status as NULL, reset streak to 0\n      // streak_day_status stays NULL (don't set to 0) so streak calculation breaks\n      console.log('[PATCH /api/game-attempts/:id] Streak saver lost - streak_day_status stays NULL, streak resets');\n    } else if (updates.result === \"lost\" && isTodaysPuzzle) {\n      // Today's puzzle loss: if streak_day_status was 0 (holiday day), set to NULL to break streak\n      // This handles the case where user exits holiday mode and loses today's puzzle\n      const currentStreakDayStatus = ownedAttempt.streakDayStatus;\n      if (currentStreakDayStatus === 0) {\n        updates.streakDayStatus = null;\n        console.log('[PATCH /api/game-attempts/:id] Today puzzle lost after holiday - setting streak_day_status = NULL to break streak');\n      }\n    } else if (isYesterdaysPuzzle && !isStreakSaverPlay) {\n      // Archive play of yesterday's puzzle - do NOT change streak_day_status\n      console.log('[PATCH /api/game-attempts/:id] Archive play of yesterday - streak_day_status preserved');\n    }\n\n    const gameAttempt = await storage.updateGameAttemptRegion(id, updates);\n    console.log('[PATCH /api/game-attempts/:id] Updated:', { result: gameAttempt.result, numGuesses: gameAttempt.numGuesses, completedAt: gameAttempt.completedAt });\n    \n    res.json(gameAttempt);\n  } catch (error) {\n    console.error(\"[PATCH /api/game-attempts/:id] Error:\", error);\n    res.status(500).json({ error: \"Failed to update game attempt\" });\n  }\n});\n\n// Guess routes - REGION MODE\napp.post(\"/api/guesses\", verifySupabaseAuth, async (req: any, res) => {\n  try {\n    const userId = req.user.id;\n    const gameAttemptId = req.body.gameAttemptId;\n\n    console.log('[POST /api/guesses] Request:', { userId, gameAttemptId, guessValue: req.body.guessValue });\n\n    if (!gameAttemptId) {\n      return res.status(400).json({ error: \"Missing gameAttemptId in body\" });\n    }\n\n    // Verify ownership\n    const allAttempts = await storage.getGameAttemptsByUserRegion(userId);\n    const ownedAttempt = allAttempts.find(a => a.id === gameAttemptId);\n\n    if (!ownedAttempt) {\n      console.error('[POST /api/guesses] Attempt not owned by user:', gameAttemptId);\n      return res.status(403).json({ error: \"Forbidden: You do not own this game attempt\" });\n    }\n\n    // Block guesses if attempt already completed\n    if (ownedAttempt.result !== null) {\n      console.error('[POST /api/guesses] Attempt already completed with result:', ownedAttempt.result);\n      return res.status(409).json({ error: \"Attempt already completed; no further guesses allowed\" });\n    }\n\n    console.log('[POST /api/guesses] Saving guess to database...');\n    \n    // Save the guess (feedback is calculated client-side, not stored)\n    const guess = await storage.createGuessRegion({\n      gameAttemptId: gameAttemptId,\n      guessValue: req.body.guessValue,\n    });\n\n    console.log('[POST /api/guesses] Guess saved:', guess.id);\n    \n    // Lock digit mode on first guess if not already locked\n    if (ownedAttempt.digits === null || ownedAttempt.digits === undefined) {\n      const userSettings = await storage.getUserSettings(userId);\n      const digitPreference = userSettings?.digitPreference || '8';\n      \n      await storage.updateGameAttemptRegion(gameAttemptId, {\n        digits: digitPreference\n      });\n      \n      console.log('[POST /api/guesses] Locked digit mode to:', digitPreference);\n    }\n    \n    // Increment num_guesses\n    await storage.incrementAttemptGuessesRegion(gameAttemptId);\n    \n    // Read back to verify\n    const updatedAttempt = await storage.getGameAttemptRegion(gameAttemptId);\n    console.log('[POST /api/guesses] After increment, numGuesses:', updatedAttempt?.numGuesses);\n\n    res.json(guess);\n  } catch (error) {\n    console.error(\"[POST /api/guesses] Error:\", error);\n    res.status(500).json({ error: \"Failed to create guess\" });\n  }\n});\n\n// Get recent guesses with allocated IDs for caching - REGION MODE\napp.get(\"/api/guesses/recent\", verifySupabaseAuth, async (req: any, res) => {\n  try {\n    const userId = req.user.id;\n    const since = req.query.since as string;\n\n    if (!since) {\n      return res.status(400).json({ error: \"Missing 'since' query parameter\" });\n    }\n\n    const guesses = await storage.getRecentGuessesWithAllocatedIdsRegion(userId, since);\n    \n    // Transform for backward compatibility\n    const transformedGuesses = guesses.map(g => ({\n      ...g,\n      puzzleId: g.allocatedRegionId, // Backward compat\n    }));\n    \n    res.json(transformedGuesses);\n  } catch (error) {\n    console.error(\"Error fetching recent guesses:\", error);\n    res.status(500).json({ error: \"Failed to fetch recent guesses\" });\n  }\n});\n\n  app.get(\"/api/guesses/all\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const guesses = await storage.getAllGuessesWithAllocatedIdsRegion(userId);\n      \n      // Transform for backward compatibility\n      const transformedGuesses = guesses.map(g => ({\n        ...g,\n        puzzleId: g.allocatedRegionId, // Backward compat\n      }));\n      \n      res.json(transformedGuesses);\n    } catch (error) {\n      console.error(\"Error fetching all guesses:\", error);\n      res.status(500).json({ error: \"Failed to fetch all guesses\" });\n    }\n  });\n\n\napp.get(\"/api/guesses/:gameAttemptId\", verifySupabaseAuth, async (req: any, res) => {\n  try {\n    const userId = req.user.id;\n    const gameAttemptId = parseInt(req.params.gameAttemptId);\n\n    // Verify ownership\n    const allAttempts = await storage.getGameAttemptsByUserRegion(userId);\n    const ownedAttempt = allAttempts.find(a => a.id === gameAttemptId);\n\n    if (!ownedAttempt) {\n      return res.status(403).json({ error: \"Forbidden: You do not own this game attempt\" });\n    }\n\n    const guesses = await storage.getGuessesByGameAttemptRegion(gameAttemptId);\n    res.json(guesses);\n  } catch (error) {\n    console.error(\"Error fetching guesses:\", error);\n    res.status(500).json({ error: \"Failed to fetch guesses\" });\n  }\n});\n\n// Stats routes - REGION MODE\n// Stats are now scoped by region (user_id, region) to preserve history when users change regions\napp.get(\"/api/stats\", verifySupabaseAuth, async (req: any, res) => {\n  try {\n    const userId = req.user.id;\n    // Get user's current region from profile\n    const profile = await storage.getUserProfile(userId);\n    const region = profile?.region || \"UK\";\n    \n    const stats = await storage.getUserStatsRegion(userId, region);\n    res.json(stats || {});\n  } catch (error) {\n    console.error(\"Error fetching stats:\", error);\n    res.status(500).json({ error: \"Failed to fetch stats\" });\n  }\n});\n\n  app.post(\"/api/stats\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      // Get user's current region from profile\n      const profile = await storage.getUserProfile(userId);\n      const region = profile?.region || \"UK\";\n      \n      const stats = await storage.upsertUserStatsRegion({\n        userId,\n        region, // Include region for composite unique constraint\n        ...req.body,\n      });\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error updating stats:\", error);\n      res.status(500).json({ error: \"Failed to update stats\" });\n    }\n  });\n\n  app.post(\"/api/stats/recalculate\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      // Get user's current region from profile\n      const profile = await storage.getUserProfile(userId);\n      const region = profile?.region || \"UK\";\n      \n      const stats = await storage.recalculateUserStatsRegion(userId, region);\n      res.json(stats);\n    } catch (error) {\n      console.error(\"[POST /api/stats/recalculate] Error:\", error);\n      res.status(500).json({ error: \"Failed to recalculate stats\" });\n    }\n  });\n\n  app.get(\"/api/stats/percentile\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      // Get user's current region from profile\n      const profile = await storage.getUserProfile(userId);\n      const region = profile?.region || \"UK\";\n      \n      const percentile = await storage.getUserPercentileRankingRegion(userId, region);\n      res.json({ percentile });\n    } catch (error) {\n      console.error(\"Error fetching percentile:\", error);\n      res.status(500).json({ error: \"Failed to fetch percentile\" });\n    }\n  });\n\n  // ========================================================================\n  // BADGE ROUTES - REGION GAME MODE\n  // ========================================================================\n\n  // Get all badges (for reference)\n  app.get(\"/api/badges\", async (req, res) => {\n    try {\n      const allBadges = await storage.getAllBadges();\n      res.json(allBadges);\n    } catch (error) {\n      console.error(\"[GET /api/badges] Error:\", error);\n      res.status(500).json({ error: \"Failed to fetch badges\" });\n    }\n  });\n\n  // Get user's earned badges for Region game mode (for Stats screen display)\n  app.get(\"/api/badges/earned\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const profile = await storage.getUserProfile(userId);\n      const region = profile?.region || \"UK\";\n      \n      console.log(`[GET /api/badges/earned] userId: ${userId}, region: ${region}, gameType: REGION`);\n      \n      const highestBadges = await storage.getHighestBadgePerCategory(userId, 'REGION', region);\n      res.json(highestBadges);\n    } catch (error) {\n      console.error(\"[GET /api/badges/earned] Error:\", error);\n      res.status(500).json({ error: \"Failed to fetch earned badges\" });\n    }\n  });\n\n  // Get ALL user's earned badges for Region game mode (for AllBadgesPopup - exact badge ID matching)\n  app.get(\"/api/badges/earned/all\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const profile = await storage.getUserProfile(userId);\n      const region = profile?.region || \"UK\";\n      \n      console.log(`[GET /api/badges/earned/all] userId: ${userId}, region: ${region}, gameType: REGION`);\n      \n      const allEarnedBadges = await storage.getUserBadges(userId, 'REGION', region, true);\n      res.json(allEarnedBadges);\n    } catch (error) {\n      console.error(\"[GET /api/badges/earned/all] Error:\", error);\n      res.status(500).json({ error: \"Failed to fetch all earned badges\" });\n    }\n  });\n\n  // Get pending badges for Region game mode (for popup animation)\n  app.get(\"/api/badges/pending\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const profile = await storage.getUserProfile(userId);\n      const region = profile?.region || \"UK\";\n      \n      console.log(`[GET /api/badges/pending] userId: ${userId}, region: ${region}, gameType: REGION`);\n      \n      const pendingBadges = await storage.getPendingBadges(userId, 'REGION', region);\n      \n      // For percentile badges, only return the highest (lowest threshold)\n      const categorized: Record<string, typeof pendingBadges[0] | null> = {};\n      const result: typeof pendingBadges = [];\n      \n      for (const badge of pendingBadges) {\n        const cat = badge.badge.category;\n        if (cat === 'percentile') {\n          if (!categorized[cat] || badge.badge.threshold < categorized[cat]!.badge.threshold) {\n            categorized[cat] = badge;\n          }\n        } else {\n          result.push(badge);\n        }\n      }\n      \n      if (categorized.percentile) {\n        result.push(categorized.percentile);\n      }\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"[GET /api/badges/pending] Error:\", error);\n      res.status(500).json({ error: \"Failed to fetch pending badges\" });\n    }\n  });\n\n  // Mark a badge as awarded (after popup shown)\n  app.post(\"/api/badges/:userBadgeId/award\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userBadgeId = parseInt(req.params.userBadgeId, 10);\n      if (isNaN(userBadgeId)) {\n        return res.status(400).json({ error: \"Invalid badge ID\" });\n      }\n      \n      await storage.markBadgeAwarded(userBadgeId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"[POST /api/badges/:userBadgeId/award] Error:\", error);\n      res.status(500).json({ error: \"Failed to mark badge as awarded\" });\n    }\n  });\n\n  // Check and award streak badge\n  app.post(\"/api/badges/check-streak\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { streak } = req.body;\n      const profile = await storage.getUserProfile(userId);\n      const region = profile?.region || \"UK\";\n      \n      if (typeof streak !== 'number') {\n        return res.status(400).json({ error: \"Streak must be a number\" });\n      }\n      \n      console.log(`[POST /api/badges/check-streak] userId: ${userId}, streak: ${streak}, gameType: REGION, region: ${region}`);\n      \n      const newBadge = await storage.checkAndAwardStreakBadge(userId, streak, 'REGION', region);\n      res.json({ badge: newBadge, awarded: !!newBadge });\n    } catch (error) {\n      console.error(\"[POST /api/badges/check-streak] Error:\", error);\n      res.status(500).json({ error: \"Failed to check streak badge\" });\n    }\n  });\n\n  // Check and award elementle badge\n  app.post(\"/api/badges/check-elementle\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { guessCount } = req.body;\n      const profile = await storage.getUserProfile(userId);\n      const region = profile?.region || \"UK\";\n      \n      if (typeof guessCount !== 'number') {\n        return res.status(400).json({ error: \"guessCount must be a number\" });\n      }\n      \n      console.log(`[POST /api/badges/check-elementle] userId: ${userId}, guessCount: ${guessCount}, gameType: REGION, region: ${region}`);\n      \n      const newBadge = await storage.checkAndAwardElementleBadge(userId, guessCount, 'REGION', region);\n      res.json({ badge: newBadge, awarded: !!newBadge });\n    } catch (error) {\n      console.error(\"[POST /api/badges/check-elementle] Error:\", error);\n      res.status(500).json({ error: \"Failed to check elementle badge\" });\n    }\n  });\n\n  // Check and award percentile badge (REGION mode)\n  app.post(\"/api/badges/check-percentile\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const profile = await storage.getUserProfile(userId);\n      const region = profile?.region || \"UK\";\n      \n      console.log(`[POST /api/badges/check-percentile] userId: ${userId}, gameType: REGION, region: ${region}`);\n      \n      const newBadge = await storage.checkAndAwardPercentileBadge(userId, 'REGION', region);\n      res.json({ badge: newBadge, awarded: !!newBadge });\n    } catch (error) {\n      console.error(\"[POST /api/badges/check-percentile] Error:\", error);\n      res.status(500).json({ error: \"Failed to check percentile badge\" });\n    }\n  });\n\n  // ========================================================================\n  // USER GAME MODE ROUTES\n  // ========================================================================\n\n  // Puzzle routes - USER MODE\n  app.get(\"/api/user/puzzles\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      \n      console.log('[GET /api/user/puzzles] userId:', userId);\n      \n      const allocatedQuestions = await storage.getAllocatedQuestionsByUser(userId);\n      \n      console.log('[GET /api/user/puzzles] Found allocated questions:', allocatedQuestions.length);\n      \n      // Transform to frontend-compatible format\n      const puzzles = allocatedQuestions.map(aq => {\n        // For Local History (category 999), append place name if available\n        let categoryDisplay = aq.categoryName;\n        if (aq.categoryId === 999 && aq.placeName) {\n          categoryDisplay = `${aq.categoryName}: ${aq.placeName}`;\n        }\n        \n        return {\n          id: aq.id, // This is now allocatedUserId\n          date: aq.puzzleDate,\n          answerDateCanonical: aq.masterQuestion.answerDateCanonical,\n          eventTitle: aq.masterQuestion.eventTitle,\n          eventDescription: aq.masterQuestion.eventDescription,\n          category: categoryDisplay, // Category name, with place for Local History\n          clue1: null, // Clues removed in new schema\n          clue2: null, // Clues removed in new schema\n          // User-specific fields\n          userId: aq.userId,\n          allocatedUserId: aq.id,\n          masterQuestionId: aq.questionId,\n        };\n      });\n      \n      res.json(puzzles);\n    } catch (error) {\n      console.error(\"Error fetching user puzzles:\", error);\n      res.status(500).json({ error: \"Failed to fetch user puzzles\" });\n    }\n  });\n\n  app.get(\"/api/user/puzzles/:date\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      \n      const allocatedQuestion = await storage.getAllocatedQuestionByUserAndDate(userId, req.params.date);\n      \n      if (!allocatedQuestion) {\n        return res.status(404).json({ error: \"Puzzle not found\" });\n      }\n      \n      // For Local History (category 999), append place name if available\n      let categoryDisplay = allocatedQuestion.categoryName;\n      if (allocatedQuestion.categoryId === 999 && allocatedQuestion.placeName) {\n        categoryDisplay = `${allocatedQuestion.categoryName}: ${allocatedQuestion.placeName}`;\n      }\n      \n      // Transform to frontend-compatible format\n      const puzzle = {\n        id: allocatedQuestion.id,\n        date: allocatedQuestion.puzzleDate,\n        answerDateCanonical: allocatedQuestion.masterQuestion.answerDateCanonical,\n        eventTitle: allocatedQuestion.masterQuestion.eventTitle,\n        eventDescription: allocatedQuestion.masterQuestion.eventDescription,\n        category: categoryDisplay, // Category name, with place for Local History\n        clue1: null, // Clues removed in new schema\n        clue2: null, // Clues removed in new schema\n        userId: allocatedQuestion.userId,\n        allocatedUserId: allocatedQuestion.id,\n        masterQuestionId: allocatedQuestion.questionId,\n      };\n      \n      res.json(puzzle);\n    } catch (error) {\n      console.error(\"Error fetching user puzzle:\", error);\n      res.status(500).json({ error: \"Failed to fetch user puzzle\" });\n    }\n  });\n\n  // Game attempt routes - USER MODE\n  app.post(\"/api/user/game-attempts\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      // Frontend sends allocatedUserId\n      const allocatedUserId = req.body.allocatedUserId || req.body.puzzleId;\n\n      console.log('[POST /api/user/game-attempts] Request:', { userId, allocatedUserId, numGuesses: req.body.numGuesses, result: req.body.result });\n\n      if (!allocatedUserId) {\n        return res.status(400).json({ error: \"Missing allocatedUserId in body\" });\n      }\n\n      // Defensive normalization: convert legacy \"win\"/\"loss\" to \"won\"/\"lost\"\n      let result = req.body.result;\n      if (result === \"win\") result = \"won\";\n      if (result === \"loss\") result = \"lost\";\n\n      // Try to find an existing attempt\n      const existing = await storage.getGameAttemptByUserAndAllocatedUser(userId, allocatedUserId);\n\n      if (existing) {\n        console.log('[POST /api/user/game-attempts] Found existing attempt:', { id: existing.id, numGuesses: existing.numGuesses, result: existing.result });\n        \n        // If attempt is already completed, don't allow mutation\n        if (existing.result !== null) {\n          console.log('[POST /api/user/game-attempts] Attempt is completed, returning without mutation');\n          return res.json(existing);\n        }\n        \n        // Update in-progress attempt\n        const updates: any = {};\n        \n        if (result && result !== null) {\n          updates.result = result;\n          console.log('[POST /api/user/game-attempts] Client sent result in POST:', result);\n        }\n        \n        if (typeof req.body.numGuesses === \"number\" && req.body.numGuesses > (existing.numGuesses ?? 0)) {\n          updates.numGuesses = req.body.numGuesses;\n        }\n        \n        if (Object.keys(updates).length > 0) {\n          const updated = await storage.updateGameAttemptUser(existing.id, updates);\n          console.log('[POST /api/user/game-attempts] Updated existing attempt:', { result: updated.result, numGuesses: updated.numGuesses });\n          return res.json(updated);\n        }\n        \n        return res.json(existing);\n      }\n      \n      // No attempt exists - create a fresh one\n      console.log('[POST /api/user/game-attempts] No attempt exists, creating fresh one');\n      const gameAttempt = await storage.createGameAttemptUser({\n        userId,\n        allocatedUserId,\n        result: result ?? null,\n        numGuesses: req.body.numGuesses ?? 0,\n      });\n\n      console.log('[POST /api/user/game-attempts] Created attempt:', { id: gameAttempt.id, numGuesses: gameAttempt.numGuesses });\n\n      res.json(gameAttempt);\n    } catch (error) {\n      console.error(\"[POST /api/user/game-attempts] Error:\", error);\n      res.status(500).json({ error: \"Failed to create/upsert user game attempt\" });\n    }\n  });\n\n  app.get(\"/api/user/game-attempts/user\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const attempts = await storage.getGameAttemptsByUserUser(userId);\n      \n      // Transform to include puzzle-like fields for backward compatibility\n      const transformedAttempts = attempts.map(attempt => ({\n        ...attempt,\n        puzzleId: attempt.allocatedUserId, // Backward compat\n        puzzle: {\n          id: attempt.allocatedQuestion.id,\n          date: attempt.allocatedQuestion.puzzleDate,\n          answerDateCanonical: attempt.allocatedQuestion.masterQuestion.answerDateCanonical,\n          eventTitle: attempt.allocatedQuestion.masterQuestion.eventTitle,\n          eventDescription: attempt.allocatedQuestion.masterQuestion.eventDescription,\n        },\n      }));\n      \n      res.json(transformedAttempts);\n    } catch (error) {\n      console.error(\"Error fetching user game attempts:\", error);\n      res.status(500).json({ error: \"Failed to fetch user game attempts\" });\n    }\n  });\n\n  app.patch(\"/api/user/game-attempts/:id\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const userId = req.user.id;\n\n      console.log('[PATCH /api/user/game-attempts/:id] Request:', { id, userId, updates: req.body });\n\n      // Verify ownership\n      const allAttempts = await storage.getGameAttemptsByUserUser(userId);\n      const ownedAttempt = allAttempts.find(a => a.id === id);\n\n      if (!ownedAttempt) {\n        console.error('[PATCH /api/user/game-attempts/:id] Attempt not owned by user:', id);\n        return res.status(403).json({ error: \"Forbidden: You do not own this game attempt\" });\n      }\n\n      console.log('[PATCH /api/user/game-attempts/:id] Current state:', {\n        result: ownedAttempt.result,\n        numGuesses: ownedAttempt.numGuesses,\n        completedAt: ownedAttempt.completedAt\n      });\n\n      // Defensive normalization\n      const updates: any = { ...req.body };\n      if (updates.result === \"win\") updates.result = \"won\";\n      if (updates.result === \"loss\") updates.result = \"lost\";\n\n      // Prevent mutating identity columns\n      delete updates.userId;\n      delete updates.user_id;\n      delete updates.puzzleId;\n      delete updates.puzzle_id;\n      delete updates.allocatedUserId;\n      delete updates.allocated_user_id;\n\n      // Ensure numGuesses never decreases\n      if (typeof updates.numGuesses === \"number\") {\n        const previousNumGuesses = ownedAttempt.numGuesses ?? 0;\n        updates.numGuesses = Math.max(updates.numGuesses, previousNumGuesses);\n        console.log('[PATCH /api/user/game-attempts/:id] numGuesses:', { previous: previousNumGuesses, requested: req.body.numGuesses, final: updates.numGuesses });\n      }\n\n      // Handle streak_day_status for today's puzzle or streak saver (yesterday's puzzle)\n      // IMPORTANT: Only update streak_day_status for yesterday's puzzle if isStreakSaverPlay is true\n      // Archive plays should NOT update streak_day_status (preserve holiday protection, etc.)\n      const puzzleDate = ownedAttempt.allocatedQuestion?.puzzleDate;\n      const today = new Date().toISOString().split('T')[0];\n      const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];\n      const twoDaysAgo = new Date(Date.now() - 2 * 86400000).toISOString().split('T')[0];\n      const isTodaysPuzzle = puzzleDate === today;\n      const isYesterdaysPuzzle = puzzleDate === yesterday;\n      const isStreakSaverPlay = req.body.isStreakSaverPlay === true;\n      \n      // Server-side validation for streak saver: puzzle must be within last 2 days\n      // (yesterday or 2 days ago to account for timezone edge cases)\n      const isValidStreakSaverWindow = puzzleDate === yesterday || puzzleDate === twoDaysAgo;\n      const isValidatedStreakSaverPlay = isStreakSaverPlay && isValidStreakSaverWindow;\n      \n      // Remove isStreakSaverPlay from updates as it's not a database column\n      delete updates.isStreakSaverPlay;\n      \n      if (updates.result === \"won\" && isTodaysPuzzle) {\n        // Check if holiday mode is active for today's puzzle\n        const streakStatus = await storage.getStreakSaverStatus(userId);\n        const holidayActive = streakStatus?.user?.holidayActive ?? false;\n        \n        if (!holidayActive) {\n          updates.streakDayStatus = 1;\n          console.log('[PATCH /api/user/game-attempts/:id] Setting streak_day_status = 1 (today)');\n        } else {\n          console.log('[PATCH /api/user/game-attempts/:id] Holiday active, streak_day_status remains as-is');\n        }\n      } else if (updates.result === \"won\" && isValidatedStreakSaverPlay) {\n        // Streak saver win - set streak_day_status = 1\n        // Validate: isStreakSaverPlay flag from frontend + puzzle date within last 2 days\n        updates.streakDayStatus = 1;\n        console.log('[PATCH /api/user/game-attempts/:id] Setting streak_day_status = 1 (streak saver)', { puzzleDate, today, yesterday, twoDaysAgo });\n      } else if (updates.result === \"lost\" && isValidatedStreakSaverPlay) {\n        // Streak saver loss: leave streak_day_status as NULL, reset streak to 0\n        // streak_day_status stays NULL (don't set to 0) so streak calculation breaks\n        console.log('[PATCH /api/user/game-attempts/:id] Streak saver lost - streak_day_status stays NULL, streak resets');\n      } else if (updates.result === \"lost\" && isTodaysPuzzle) {\n        // Today's puzzle loss: if streak_day_status was 0 (holiday day), set to NULL to break streak\n        // This handles the case where user exits holiday mode and loses today's puzzle\n        const currentStreakDayStatus = ownedAttempt.streakDayStatus;\n        if (currentStreakDayStatus === 0) {\n          updates.streakDayStatus = null;\n          console.log('[PATCH /api/user/game-attempts/:id] Today puzzle lost after holiday - setting streak_day_status = NULL to break streak');\n        }\n      } else if (isYesterdaysPuzzle && !isStreakSaverPlay) {\n        // Archive play of yesterday's puzzle - do NOT change streak_day_status\n        console.log('[PATCH /api/user/game-attempts/:id] Archive play of yesterday - streak_day_status preserved');\n      }\n\n      const gameAttempt = await storage.updateGameAttemptUser(id, updates);\n      console.log('[PATCH /api/user/game-attempts/:id] Updated:', { result: gameAttempt.result, numGuesses: gameAttempt.numGuesses, completedAt: gameAttempt.completedAt });\n      \n      res.json(gameAttempt);\n    } catch (error) {\n      console.error(\"[PATCH /api/user/game-attempts/:id] Error:\", error);\n      res.status(500).json({ error: \"Failed to update user game attempt\" });\n    }\n  });\n\n  // Guess routes - USER MODE\n  app.post(\"/api/user/guesses\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const gameAttemptId = req.body.gameAttemptId;\n\n      console.log('[POST /api/user/guesses] Request:', { userId, gameAttemptId, guessValue: req.body.guessValue });\n\n      if (!gameAttemptId) {\n        return res.status(400).json({ error: \"Missing gameAttemptId in body\" });\n      }\n\n      // Verify ownership\n      const allAttempts = await storage.getGameAttemptsByUserUser(userId);\n      const ownedAttempt = allAttempts.find(a => a.id === gameAttemptId);\n\n      if (!ownedAttempt) {\n        console.error('[POST /api/user/guesses] Attempt not owned by user:', gameAttemptId);\n        return res.status(403).json({ error: \"Forbidden: You do not own this game attempt\" });\n      }\n\n      // Block guesses if attempt already completed\n      if (ownedAttempt.result !== null) {\n        console.error('[POST /api/user/guesses] Attempt already completed with result:', ownedAttempt.result);\n        return res.status(409).json({ error: \"Attempt already completed; no further guesses allowed\" });\n      }\n\n      console.log('[POST /api/user/guesses] Saving guess to database...');\n      \n      // Save the guess (feedback is calculated client-side, not stored)\n      const guess = await storage.createGuessUser({\n        gameAttemptId: gameAttemptId,\n        guessValue: req.body.guessValue,\n      });\n\n      console.log('[POST /api/user/guesses] Guess saved:', guess.id);\n      \n      // Lock digit mode on first guess if not already locked\n      if (ownedAttempt.digits === null || ownedAttempt.digits === undefined) {\n        const userSettings = await storage.getUserSettings(userId);\n        const digitPreference = userSettings?.digitPreference || '8';\n        \n        await storage.updateGameAttemptUser(gameAttemptId, {\n          digits: digitPreference\n        });\n        \n        console.log('[POST /api/user/guesses] Locked digit mode to:', digitPreference);\n      }\n      \n      // Increment num_guesses\n      await storage.incrementAttemptGuessesUser(gameAttemptId);\n      \n      // Read back to verify\n      const updatedAttempt = await storage.getGameAttemptUser(gameAttemptId);\n      console.log('[POST /api/user/guesses] After increment, numGuesses:', updatedAttempt?.numGuesses);\n\n      res.json(guess);\n    } catch (error) {\n      console.error(\"[POST /api/user/guesses] Error:\", error);\n      res.status(500).json({ error: \"Failed to create user guess\" });\n    }\n  });\n\n  // Get recent guesses with allocated IDs for caching - USER MODE\n  app.get(\"/api/user/guesses/recent\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const since = req.query.since as string;\n\n      if (!since) {\n        return res.status(400).json({ error: \"Missing 'since' query parameter\" });\n      }\n\n      const guesses = await storage.getRecentGuessesWithAllocatedIdsUser(userId, since);\n      \n      // Transform for backward compatibility\n      const transformedGuesses = guesses.map(g => ({\n        ...g,\n        puzzleId: g.allocatedUserId, // Backward compat\n      }));\n      \n      res.json(transformedGuesses);\n    } catch (error) {\n      console.error(\"Error fetching recent user guesses:\", error);\n      res.status(500).json({ error: \"Failed to fetch recent user guesses\" });\n    }\n  });\n\n  app.get(\"/api/user/guesses/all\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const guesses = await storage.getAllGuessesWithAllocatedIdsUser(userId);\n      \n      // Transform for backward compatibility\n      const transformedGuesses = guesses.map(g => ({\n        ...g,\n        puzzleId: g.allocatedUserId, // Backward compat\n      }));\n      \n      res.json(transformedGuesses);\n    } catch (error) {\n      console.error(\"Error fetching all user guesses:\", error);\n      res.status(500).json({ error: \"Failed to fetch all user guesses\" });\n    }\n  });\n\n  app.get(\"/api/user/guesses/:gameAttemptId\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const gameAttemptId = parseInt(req.params.gameAttemptId);\n\n      // Verify ownership\n      const allAttempts = await storage.getGameAttemptsByUserUser(userId);\n      const ownedAttempt = allAttempts.find(a => a.id === gameAttemptId);\n\n      if (!ownedAttempt) {\n        return res.status(403).json({ error: \"Forbidden: You do not own this game attempt\" });\n      }\n\n      const guesses = await storage.getGuessesByGameAttemptUser(gameAttemptId);\n      res.json(guesses);\n    } catch (error) {\n      console.error(\"Error fetching user guesses:\", error);\n      res.status(500).json({ error: \"Failed to fetch user guesses\" });\n    }\n  });\n\n  // Stats routes - USER MODE\n  app.get(\"/api/user/stats\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const stats = await storage.getUserStatsUser(userId);\n      res.json(stats || {});\n    } catch (error) {\n      console.error(\"Error fetching user stats:\", error);\n      res.status(500).json({ error: \"Failed to fetch user stats\" });\n    }\n  });\n\n  app.post(\"/api/user/stats\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const stats = await storage.upsertUserStatsUser({\n        userId,\n        ...req.body,\n      });\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error updating user stats:\", error);\n      res.status(500).json({ error: \"Failed to update user stats\" });\n    }\n  });\n\n  app.post(\"/api/user/stats/recalculate\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const stats = await storage.recalculateUserStatsUser(userId);\n      res.json(stats);\n    } catch (error) {\n      console.error(\"[POST /api/user/stats/recalculate] Error:\", error);\n      res.status(500).json({ error: \"Failed to recalculate user stats\" });\n    }\n  });\n\n  app.get(\"/api/user/stats/percentile\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const percentile = await storage.getUserPercentileRankingUser(userId);\n      res.json({ percentile });\n    } catch (error) {\n      console.error(\"Error fetching user percentile:\", error);\n      res.status(500).json({ error: \"Failed to fetch user percentile\" });\n    }\n  });\n\n  // ========================================================================\n  // BADGE ROUTES - USER GAME MODE\n  // ========================================================================\n\n  // Get user's earned badges for User game mode (for Stats screen display)\n  app.get(\"/api/user/badges/earned\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      \n      console.log(`[GET /api/user/badges/earned] userId: ${userId}, gameType: USER, region: GLOBAL`);\n      \n      const highestBadges = await storage.getHighestBadgePerCategory(userId, 'USER', 'GLOBAL');\n      res.json(highestBadges);\n    } catch (error) {\n      console.error(\"[GET /api/user/badges/earned] Error:\", error);\n      res.status(500).json({ error: \"Failed to fetch earned badges\" });\n    }\n  });\n\n  // Get ALL user's earned badges for User game mode (for AllBadgesPopup - exact badge ID matching)\n  app.get(\"/api/user/badges/earned/all\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      \n      console.log(`[GET /api/user/badges/earned/all] userId: ${userId}, gameType: USER, region: GLOBAL`);\n      \n      const allEarnedBadges = await storage.getUserBadges(userId, 'USER', 'GLOBAL', true);\n      res.json(allEarnedBadges);\n    } catch (error) {\n      console.error(\"[GET /api/user/badges/earned/all] Error:\", error);\n      res.status(500).json({ error: \"Failed to fetch all earned badges\" });\n    }\n  });\n\n  // Get pending badges for User game mode (for popup animation)\n  app.get(\"/api/user/badges/pending\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      \n      console.log(`[GET /api/user/badges/pending] userId: ${userId}, gameType: USER, region: GLOBAL`);\n      \n      const pendingBadges = await storage.getPendingBadges(userId, 'USER', 'GLOBAL');\n      \n      // For percentile badges, only return the highest (lowest threshold)\n      const categorized: Record<string, typeof pendingBadges[0] | null> = {};\n      const result: typeof pendingBadges = [];\n      \n      for (const badge of pendingBadges) {\n        const cat = badge.badge.category;\n        if (cat === 'percentile') {\n          if (!categorized[cat] || badge.badge.threshold < categorized[cat]!.badge.threshold) {\n            categorized[cat] = badge;\n          }\n        } else {\n          result.push(badge);\n        }\n      }\n      \n      if (categorized.percentile) {\n        result.push(categorized.percentile);\n      }\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"[GET /api/user/badges/pending] Error:\", error);\n      res.status(500).json({ error: \"Failed to fetch pending badges\" });\n    }\n  });\n\n  // Check and award streak badge for User mode\n  app.post(\"/api/user/badges/check-streak\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { streak } = req.body;\n      \n      if (typeof streak !== 'number') {\n        return res.status(400).json({ error: \"Streak must be a number\" });\n      }\n      \n      console.log(`[POST /api/user/badges/check-streak] userId: ${userId}, streak: ${streak}, gameType: USER, region: GLOBAL`);\n      \n      const newBadge = await storage.checkAndAwardStreakBadge(userId, streak, 'USER', 'GLOBAL');\n      res.json({ badge: newBadge, awarded: !!newBadge });\n    } catch (error) {\n      console.error(\"[POST /api/user/badges/check-streak] Error:\", error);\n      res.status(500).json({ error: \"Failed to check streak badge\" });\n    }\n  });\n\n  // Check and award elementle badge for User mode\n  app.post(\"/api/user/badges/check-elementle\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { guessCount } = req.body;\n      \n      if (typeof guessCount !== 'number') {\n        return res.status(400).json({ error: \"guessCount must be a number\" });\n      }\n      \n      console.log(`[POST /api/user/badges/check-elementle] userId: ${userId}, guessCount: ${guessCount}, gameType: USER, region: GLOBAL`);\n      \n      const newBadge = await storage.checkAndAwardElementleBadge(userId, guessCount, 'USER', 'GLOBAL');\n      res.json({ badge: newBadge, awarded: !!newBadge });\n    } catch (error) {\n      console.error(\"[POST /api/user/badges/check-elementle] Error:\", error);\n      res.status(500).json({ error: \"Failed to check elementle badge\" });\n    }\n  });\n\n  // Check and award percentile badge for User mode\n  app.post(\"/api/user/badges/check-percentile\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      \n      console.log(`[POST /api/user/badges/check-percentile] userId: ${userId}, gameType: USER, region: GLOBAL`);\n      \n      const newBadge = await storage.checkAndAwardPercentileBadge(userId, 'USER', 'GLOBAL');\n      res.json({ badge: newBadge, awarded: !!newBadge });\n    } catch (error) {\n      console.error(\"[POST /api/user/badges/check-percentile] Error:\", error);\n      res.status(500).json({ error: \"Failed to check percentile badge\" });\n    }\n  });\n\n  // ============================================================================\n  // SUBSCRIPTION & PRO ROUTES\n  // ============================================================================\n\n  // Get user subscription - reads from user_profiles + user_tier (new workflow)\n  app.get(\"/api/subscription\", verifySupabaseAuth, async (req: any, res) => {\n    const userId = req.user.id;\n    console.log('[subscription] Checking subscription for userId:', userId);\n    \n    try {\n      const subscriptionData = await storage.getSubscriptionData(userId);\n      \n      if (subscriptionData) {\n        console.log('[subscription] Subscription data found:', {\n          tier: subscriptionData.tier,\n          tierName: subscriptionData.tierName,\n          tierType: subscriptionData.tierType,\n          isActive: subscriptionData.isActive,\n          isExpired: subscriptionData.isExpired,\n        });\n        \n        return res.json(subscriptionData);\n      }\n      \n      // No subscription data found - return default Standard tier response\n      console.log('[subscription] No subscription data found, returning Standard tier');\n      return res.json({\n        tier: 'free',\n        tierName: 'Standard',\n        tierType: 'default',\n        tierId: null,\n        userId: userId,\n        endDate: null,\n        autoRenew: false,\n        isActive: false,\n        isExpired: false,\n        metadata: {\n          streakSavers: 1,\n          holidaySavers: 0,\n          holidayDurationDays: 14,\n          subscriptionCost: 0,\n          currency: 'GBP',\n          subscriptionDurationMonths: null,\n          description: 'Free tier',\n          sortOrder: 0,\n        }\n      });\n      \n    } catch (error: any) {\n      console.error(\"[subscription] Error fetching subscription:\", error);\n      return res.status(500).json({ error: \"Failed to fetch subscription\" });\n    }\n  });\n\n  // Get purchasable tiers for a region (for subscription/renewal UI)\n  // Uses tier + tier_type from user_tier, excludes Standard tier\n  app.get(\"/api/tiers\", verifySupabaseAuth, async (req: any, res) => {\n    const userId = req.user.id;\n    \n    // Get user's region from profile (fallback to UK)\n    let region = 'UK';\n    try {\n      const profile = await storage.getUserProfile(userId);\n      region = profile?.region || 'UK';\n    } catch (profileError) {\n      console.log('[tiers] Could not fetch profile, using default region UK');\n    }\n    \n    console.log('[tiers] Fetching purchasable tiers for region:', region);\n    \n    try {\n      const tiers = await storage.getPurchasableTiers(region);\n      \n      console.log('[tiers] Found purchasable tiers:', tiers.length);\n      console.log('[tiers] Tier data:', tiers.map(t => ({ \n        tier: t.tier, \n        tierType: t.tierType,\n        subscriptionCost: t.subscriptionCost, \n        currency: t.currency \n      })));\n      \n      return res.json(tiers);\n    } catch (error: any) {\n      console.error(\"[tiers] Error fetching tiers:\", error);\n      return res.status(500).json({ error: \"Failed to fetch tiers\" });\n    }\n  });\n\n  // Create Stripe Checkout session via Supabase Edge Function\n  // Returns Stripe Checkout URL for frontend redirect\n  app.post(\"/api/subscription/create-checkout\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { tierId, promotionCode } = req.body;\n\n      console.log('[checkout] Creating Stripe checkout for userId:', userId, 'tierId:', tierId);\n\n      if (!tierId) {\n        return res.status(400).json({ error: \"tierId is required\" });\n      }\n\n      // Validate tier exists and is active\n      const result = await db.execute(sql`\n        SELECT id, tier, tier_type, stripe_price_id\n        FROM user_tier\n        WHERE id = ${tierId} AND active = true\n      `);\n      \n      const rows = Array.isArray(result) ? result : (result as any).rows || [];\n      if (!rows || rows.length === 0) {\n        return res.status(400).json({ error: \"Invalid tier\" });\n      }\n      \n      const tierData = rows[0];\n      \n      if (!tierData.stripe_price_id) {\n        console.error('[checkout] Tier missing stripe_price_id:', tierId);\n        return res.status(400).json({ error: \"This tier is not available for purchase\" });\n      }\n\n      // Call Supabase Edge Function to create Stripe Checkout session\n      const supabaseUrl = process.env.SUPABASE_URL;\n      if (!supabaseUrl) {\n        throw new Error(\"SUPABASE_URL not configured\");\n      }\n\n      const edgeFunctionUrl = `${supabaseUrl}/functions/v1/create_checkout_session`;\n      \n      console.log('[checkout] Calling Edge Function:', edgeFunctionUrl);\n      \n      const edgeResponse = await fetch(edgeFunctionUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${process.env.SUPABASE_SERVICE_ROLE_KEY}`,\n        },\n        body: JSON.stringify({\n          user_id: userId,\n          tier_id: tierId,\n          promotion_code: promotionCode || null,\n        }),\n      });\n\n      if (!edgeResponse.ok) {\n        const errorText = await edgeResponse.text();\n        console.error('[checkout] Edge Function error:', edgeResponse.status, errorText);\n        throw new Error(`Checkout session creation failed: ${errorText}`);\n      }\n\n      const checkoutData = await edgeResponse.json();\n      \n      if (!checkoutData.url) {\n        console.error('[checkout] No checkout URL returned:', checkoutData);\n        throw new Error(\"No checkout URL returned from payment provider\");\n      }\n\n      console.log('[checkout] Stripe checkout session created, redirecting to:', checkoutData.url);\n\n      // Note: Pending subscription is inserted by the Edge Function via insert_pending_subscription RPC\n      // Webhook will update the pending row to active status upon successful payment\n\n      res.json({ \n        success: true,\n        url: checkoutData.url,\n        sessionId: checkoutData.session_id,\n      });\n    } catch (error: any) {\n      console.error(\"[checkout] Error creating checkout session:\", error);\n      res.status(500).json({ error: \"Failed to create checkout session\", details: error.message });\n    }\n  });\n\n// Get current subscription status (for post-checkout polling)\napp.get(\"/api/subscription/status\", verifySupabaseAuth, async (req: any, res) => {\n  try {\n    const userId = req.user.id;\n    console.log('[subscription/status] Checking subscription status for userId:', userId);\n\n    // Check user_subscriptions table for active subscription\n    const result = await db.execute(sql`\n      SELECT \n        us.id,\n        us.user_tier_id,\n        us.status,\n        us.expires_at,\n        us.auto_renew,\n        us.stripe_subscription_id,\n        us.stripe_customer_id,\n        us.stripe_price_id,\n        ut.tier,\n        ut.tier_type\n      FROM user_subscriptions us\n      JOIN user_tier ut ON us.user_tier_id = ut.id\n      WHERE us.user_id = ${userId}\n        AND us.status = 'active'\n        AND (us.expires_at IS NULL OR us.expires_at > NOW())\n      ORDER BY us.created_at DESC\n      LIMIT 1\n    `);\n\n    const rows = Array.isArray(result) ? result : (result as any).rows || [];\n    \n    if (rows.length === 0) {\n      console.log('[subscription/status] No active subscription found for user:', userId);\n      return res.json({\n        hasActiveSubscription: false,\n      });\n    }\n\n    const subscription = rows[0];\n    console.log('[subscription/status] Found active subscription:', subscription);\n\n    res.json({\n      hasActiveSubscription: true,\n      subscription: {\n        id: subscription.id,\n        tierId: subscription.user_tier_id,\n        tierName: subscription.tier,\n        tierType: subscription.tier_type,\n        status: subscription.status,\n        expiresAt: subscription.expires_at,\n        autoRenew: subscription.auto_renew,\n        stripeSubscriptionId: subscription.stripe_subscription_id,\n        stripeCustomerId: subscription.stripe_customer_id,\n        stripePriceId: subscription.stripe_price_id,\n      },\n    });\n  } catch (error: any) {\n    console.error(\"[subscription/status] Error fetching subscription status:\", error);\n    res.status(500).json({ error: \"Failed to fetch subscription status\", details: error.message });\n  }\n});\n\n// Update auto-renewal setting for subscription\napp.post(\"/api/subscription/auto-renew\", verifySupabaseAuth, async (req: any, res) => {\n  try {\n    const userId = req.user.id;\n    const { autoRenew } = req.body;\n\n    console.log('[subscription/auto-renew] Updating for userId:', userId, 'autoRenew:', autoRenew);\n\n    if (typeof autoRenew !== 'boolean') {\n      return res.status(400).json({ error: \"autoRenew must be a boolean\" });\n    }\n\n    // Use storage method to update auto_renew on most recent subscription\n    await storage.updateAutoRenew(userId, autoRenew);\n\n    console.log('[subscription/auto-renew] Updated successfully');\n    res.json({ success: true, autoRenew });\n  } catch (error: any) {\n    console.error(\"[subscription/auto-renew] Error updating auto-renew:\", error);\n    res.status(500).json({ error: \"Failed to update auto-renewal\", details: error.message });\n  }\n});\n\n\n  // Downgrade subscription to Standard tier\n  app.post(\"/api/subscription/downgrade\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      console.log('[subscription/downgrade] Downgrading user:', userId);\n\n      // Get user's region from profile\n      const profile = await storage.getUserProfile(userId);\n      const region = profile?.region || 'UK';\n\n      // Downgrade user to Standard tier\n      await storage.downgradeToStandard(userId, region);\n\n      console.log('[subscription/downgrade] Successfully downgraded to Standard');\n      res.json({ \n        success: true, \n        message: 'Successfully downgraded to Standard tier',\n        tier: 'free',\n        tierName: 'Standard',\n        tierType: 'default',\n      });\n    } catch (error: any) {\n      console.error(\"[subscription/downgrade] Error downgrading subscription:\", error);\n      res.status(500).json({ error: \"Failed to downgrade subscription\", details: error.message });\n    }\n  });\n\n  // ============================================================================\n  // STREAK SAVER & HOLIDAY ROUTES\n  // ============================================================================\n\n  // Get streak saver status (missed flags, holiday state, allowances)\n  app.get(\"/api/streak-saver/status\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      console.log('[streak-saver/status] Checking status for userId:', userId);\n      \n      // Get streak saver status from database\n      const status = await storage.getStreakSaverStatus(userId);\n      \n      // Get subscription data to determine allowances\n      let subscriptionData = null;\n      try {\n        subscriptionData = await storage.getSubscriptionData(userId);\n      } catch (subError) {\n        console.log('[streak-saver/status] Could not fetch subscription, using defaults');\n      }\n      \n      // Determine if user is Pro\n      const isPro = subscriptionData?.tier === 'pro' && subscriptionData?.isActive;\n      \n      // Determine allowances from tier metadata\n      let streakSaverAllowance = 1;\n      let holidaySaverAllowance = 0;\n      let holidayDurationDays = 0;\n      \n      if (isPro && subscriptionData?.metadata) {\n        // Pro user with valid tier - use metadata or sensible Pro defaults\n        streakSaverAllowance = subscriptionData.metadata.streakSavers ?? 3;\n        holidaySaverAllowance = subscriptionData.metadata.holidaySavers ?? 2;\n        holidayDurationDays = subscriptionData.metadata.holidayDurationDays ?? 7;\n      } else if (subscriptionData?.metadata) {\n        // Standard tier with metadata\n        streakSaverAllowance = subscriptionData.metadata.streakSavers ?? 1;\n        holidaySaverAllowance = 0;\n        holidayDurationDays = 0;\n      }\n      \n      // Get holiday usage this year from the status (stored in user_stats_user.holidays_used_year)\n      const holidaysUsedThisYear = status?.user?.holidaysUsedYear ?? 0;\n      \n      console.log('[streak-saver/status] Status:', { status, isPro, streakSaverAllowance, holidaysUsedThisYear });\n      \n      // Return safe defaults if status is null (new user without stats)\n      const safeStatus = status || {\n        region: { currentStreak: 0, streakSaversUsedMonth: 0, missedYesterdayFlag: false },\n        user: { currentStreak: 0, streakSaversUsedMonth: 0, holidayActive: false, holidayStartDate: null, holidayEndDate: null, holidayDaysTakenCurrentPeriod: 0, holidayEnded: false, missedYesterdayFlag: false, holidaysUsedYear: 0 }\n      };\n      \n      res.json({\n        ...safeStatus,\n        allowances: {\n          streakSaversPerMonth: streakSaverAllowance,\n          holidaySaversPerYear: holidaySaverAllowance,\n          holidaysUsedThisYear,\n          holidayDurationDays,\n          isPro,\n        }\n      });\n    } catch (error: any) {\n      console.error(\"Error fetching streak saver status:\", error);\n      res.status(500).json({ error: \"Failed to fetch streak saver status\" });\n    }\n  });\n\n  // Use a streak saver\n  app.post(\"/api/streak-saver/use\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { gameType } = req.body; // 'region' or 'user'\n      \n      if (!gameType || !['region', 'user'].includes(gameType)) {\n        return res.status(400).json({ error: \"gameType must be 'region' or 'user'\" });\n      }\n      \n      console.log('[streak-saver/use] User:', userId, 'gameType:', gameType);\n      \n      // Get subscription data to determine allowance\n      let subscriptionData = null;\n      try {\n        subscriptionData = await storage.getSubscriptionData(userId);\n      } catch (subError) {\n        console.log('[streak-saver/use] Could not fetch subscription, using defaults');\n      }\n      \n      // Determine allowance based on subscription\n      const isPro = subscriptionData?.tier === 'pro' && subscriptionData?.isActive;\n      \n      let allowance = 1; // Default for Standard tier\n      if (isPro && subscriptionData?.metadata) {\n        allowance = subscriptionData.metadata.streakSavers ?? 3;\n      } else if (subscriptionData?.metadata) {\n        allowance = subscriptionData.metadata.streakSavers ?? 1;\n      }\n      \n      // Use the streak saver\n      const result = await storage.useStreakSaver(userId, gameType, allowance);\n      \n      if (!result.success) {\n        console.log('[streak-saver/use] Failed:', result.error);\n        return res.status(400).json({ error: result.error, needsSubscription: result.error?.includes('remaining') });\n      }\n      \n      console.log('[streak-saver/use] Success!');\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error using streak saver:\", error);\n      res.status(500).json({ error: \"Failed to use streak saver\" });\n    }\n  });\n\n  // Decline streak saver (reset streak to 0)\n  app.post(\"/api/streak-saver/decline\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { gameType } = req.body; // 'region' or 'user'\n      \n      if (!gameType || !['region', 'user'].includes(gameType)) {\n        return res.status(400).json({ error: \"gameType must be 'region' or 'user'\" });\n      }\n      \n      console.log('[streak-saver/decline] User:', userId, 'gameType:', gameType);\n      \n      // Reset streak to 0 and clear the missed flag\n      const table = gameType === 'region' ? 'user_stats_region' : 'user_stats_user';\n      const flagColumn = gameType === 'region' ? 'missed_yesterday_flag_region' : 'missed_yesterday_flag_user';\n      \n      await db.execute(sql.raw(`\n        UPDATE ${table}\n        SET \n          current_streak = 0,\n          ${flagColumn} = false,\n          updated_at = NOW()\n        WHERE user_id = '${userId}'\n      `));\n      \n      console.log('[streak-saver/decline] Streak reset to 0');\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error declining streak saver:\", error);\n      res.status(500).json({ error: \"Failed to decline streak saver\" });\n    }\n  });\n\n  // Clear missed_yesterday flags when user is in holiday mode (no streak reset)\n  app.post(\"/api/streak-saver/clear-holiday\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      console.log('[streak-saver/clear-holiday] User:', userId);\n      \n      // Clear both missed_yesterday flags without resetting streaks\n      await db.execute(sql.raw(`\n        UPDATE user_stats_region\n        SET missed_yesterday_flag_region = false, updated_at = NOW()\n        WHERE user_id = '${userId}'\n      `));\n      \n      await db.execute(sql.raw(`\n        UPDATE user_stats_user\n        SET missed_yesterday_flag_user = false, updated_at = NOW()\n        WHERE user_id = '${userId}'\n      `));\n      \n      console.log('[streak-saver/clear-holiday] Cleared missed flags for holiday user');\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error clearing holiday missed flags:\", error);\n      res.status(500).json({ error: \"Failed to clear missed flags\" });\n    }\n  });\n\n  // Start a holiday (Pro users only)\n  app.post(\"/api/holiday/start\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      console.log('[holiday/start] User:', userId);\n      \n      // Get subscription data to check tier and holiday allowance\n      let subscriptionData = null;\n      try {\n        subscriptionData = await storage.getSubscriptionData(userId);\n        console.log('[holiday/start] Subscription data:', JSON.stringify({\n          tier: subscriptionData?.tier,\n          isActive: subscriptionData?.isActive,\n          metadata: subscriptionData?.metadata\n        }));\n      } catch (subError) {\n        console.log('[holiday/start] Could not fetch subscription, denying access');\n        return res.status(403).json({ error: \"Holiday feature is Pro-only\", needsSubscription: true });\n      }\n      \n      // Determine if user is Pro\n      const isPro = subscriptionData?.tier === 'pro' && subscriptionData?.isActive;\n      \n      if (!isPro || !subscriptionData?.metadata) {\n        console.log('[holiday/start] Not Pro or no metadata. isPro:', isPro, 'hasMetadata:', !!subscriptionData?.metadata);\n        return res.status(403).json({ error: \"Holiday feature is Pro-only\", needsSubscription: true });\n      }\n      \n      // Get holiday allowances from tier metadata\n      const holidayAllowance = subscriptionData.metadata.holidaySavers ?? 2;\n      const holidayDurationDays = subscriptionData.metadata.holidayDurationDays ?? 7;\n      \n      console.log('[holiday/start] Allowances - savers:', holidayAllowance, 'durationDays:', holidayDurationDays);\n      \n      if (holidayAllowance === 0 || holidayDurationDays === 0) {\n        return res.status(403).json({ error: \"Your tier does not include holidays\" });\n      }\n      \n      // Check annual holiday usage from user_stats_user.holidays_used_year\n      const status = await storage.getStreakSaverStatus(userId);\n      const holidaysUsedThisYear = status?.user?.holidaysUsedYear ?? 0;\n      const holidayActive = status?.user?.holidayActive ?? false;\n      \n      console.log('[holiday/start] Status - usedThisYear:', holidaysUsedThisYear, 'allowance:', holidayAllowance, 'alreadyActive:', holidayActive);\n      \n      if (holidaysUsedThisYear >= holidayAllowance) {\n        return res.status(400).json({ error: \"No holidays remaining this year\" });\n      }\n      \n      // Start the holiday\n      const result = await storage.startHoliday(userId, holidayDurationDays);\n      \n      if (!result.success) {\n        console.log('[holiday/start] RPC failed:', result.error);\n        return res.status(400).json({ error: result.error });\n      }\n      \n      console.log('[holiday/start] Holiday started successfully');\n      res.json({ success: true, holidayDurationDays });\n    } catch (error: any) {\n      console.error(\"Error starting holiday:\", error);\n      res.status(500).json({ error: \"Failed to start holiday\" });\n    }\n  });\n\n  // End a holiday early (or acknowledge auto-ended holiday)\n  app.post(\"/api/holiday/end\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { acknowledge } = req.body || {};\n      console.log('[holiday/end] User:', userId, 'acknowledge:', acknowledge);\n      \n      const result = await storage.endHoliday(userId, acknowledge === true);\n      \n      if (!result.success) {\n        return res.status(400).json({ error: result.error });\n      }\n      \n      console.log('[holiday/end] Holiday ended');\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error ending holiday:\", error);\n      res.status(500).json({ error: \"Failed to end holiday\" });\n    }\n  });\n\n  // Get holiday animation data - determines which games should show the calendar animation\n  app.get(\"/api/holiday/animation-data\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      console.log('[holiday/animation-data] Fetching for user:', userId);\n      \n      const data = await storage.getHolidayAnimationData(userId);\n      res.json(data);\n    } catch (error: any) {\n      console.error(\"Error fetching holiday animation data:\", error);\n      res.status(500).json({ error: \"Failed to fetch holiday animation data\" });\n    }\n  });\n\n  // Get all categories (excluding Local History - id 999)\n  app.get(\"/api/categories\", async (req, res) => {\n    try {\n      const startTime = Date.now();\n      console.log(\"[GET /api/categories] Fetching categories...\");\n      const categories = await storage.getAllCategories();\n      const dbTime = Date.now() - startTime;\n      console.log(\"[GET /api/categories] Found categories:\", categories?.length, \"in\", dbTime, \"ms\");\n      const filtered = categories.filter(c => c.id !== 999);\n      console.log(\"[GET /api/categories] After filtering id 999:\", filtered?.length);\n      res.json(filtered);\n    } catch (error) {\n      console.error(\"Error fetching categories:\", error);\n      res.status(500).json({ error: \"Failed to fetch categories\" });\n    }\n  });\n\n  // Get user's Pro category selections\n  app.get(\"/api/user/pro-categories\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const startTime = Date.now();\n      const userId = req.user.id;\n      const categoryIds = await storage.getUserProCategories(userId);\n      const dbTime = Date.now() - startTime;\n      console.log(\"[getUserProCategories] Completed in\", dbTime, \"ms for user:\", userId);\n      res.json({ categoryIds });\n    } catch (error) {\n      console.error(\"Error fetching pro categories:\", error);\n      res.status(500).json({ error: \"Failed to fetch pro categories\" });\n    }\n  });\n\n  // Save user's Pro category selections\n  app.post(\"/api/user/pro-categories\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { categoryIds } = req.body;\n\n      if (!Array.isArray(categoryIds) || categoryIds.length < 3) {\n        return res.status(400).json({ error: \"Must select at least 3 categories\" });\n      }\n\n      // Save categories\n      await storage.saveUserProCategories(userId, categoryIds);\n      \n      // Note: categoriesLastChangedAt is updated by GeneratingQuestionsScreen after question regeneration completes\n      // This ensures the timestamp reflects when questions were actually regenerated, not just when categories were saved\n      \n      res.json({ success: true, categoryIds });\n    } catch (error) {\n      console.error(\"Error saving pro categories:\", error);\n      res.status(500).json({ error: \"Failed to save pro categories\" });\n    }\n  });\n\n  // Mark first login as completed\n  app.post(\"/api/user/first-login-completed\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      await storage.markFirstLoginCompleted(userId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error marking first login:\", error);\n      res.status(500).json({ error: \"Failed to mark first login\" });\n    }\n  });\n\n  // Admin export route\n  app.get(\"/api/admin/export\", verifySupabaseAuth, requireAdmin, async (req, res) => {\n    try {\n      const format = (req.query.format as string) || \"json\";\n      const data = await storage.getAllGameAttemptsForExport();\n\n      if (format === \"csv\") {\n        // Convert to CSV\n        const headers = [\"User Email\", \"Puzzle Date\", \"Answer Date (Canonical)\", \"Event Title\", \"Result\", \"Guesses\", \"Completed At\", \"Guess Details\"];\n        const rows = data.map((row: any) => [\n          row.userEmail || \"guest\",\n          row.puzzleDate,\n          row.answerDateCanonical || \"\",\n          row.eventTitle,\n          row.result,\n          row.numGuesses,\n          row.completedAt,\n          JSON.stringify(row.guesses),\n        ]);\n\n        const csv = [headers, ...rows].map((row) => row.join(\",\")).join(\"\\n\");\n        res.setHeader(\"Content-Type\", \"text/csv\");\n        res.setHeader(\"Content-Disposition\", `attachment; filename=\"elementle-export-${Date.now()}.csv\"`);\n        res.send(csv);\n      } else {\n        res.json(data);\n      }\n    } catch (error) {\n      console.error(\"Error exporting data:\", error);\n      res.status(500).json({ error: \"Failed to export data\" });\n    }\n  });\n\n  // Admin settings routes\n  app.get(\"/api/admin/settings\", verifySupabaseAuth, requireAdmin, async (req, res) => {\n    try {\n      const settings = await storage.getAdminSettings();\n      res.json(settings);\n    } catch (error) {\n      console.error(\"Error fetching admin settings:\", error);\n      res.status(500).json({ error: \"Failed to fetch admin settings\" });\n    }\n  });\n\n  app.put(\"/api/admin/settings\", verifySupabaseAuth, requireAdmin, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { key, value, description } = req.body;\n\n      if (!key || value === undefined) {\n        return res.status(400).json({ error: \"Key and value are required\" });\n      }\n\n      const setting = await storage.upsertAdminSetting({\n        key,\n        value: String(value),\n        description: description || null,\n        updatedBy: userId,\n      });\n\n      res.json(setting);\n    } catch (error) {\n      console.error(\"Error updating admin setting:\", error);\n      res.status(500).json({ error: \"Failed to update admin setting\" });\n    }\n  });\n\n  // Get postcode restriction days (public endpoint for validation)\n  app.get(\"/api/settings/postcode-restriction-days\", async (req, res) => {\n    try {\n      const setting = await storage.getAdminSetting('postcode_restriction_days');\n      const days = setting ? parseInt(setting.value, 10) : 14; // Default to 14 days\n      res.json({ days });\n    } catch (error) {\n      console.error(\"Error fetching postcode restriction:\", error);\n      res.json({ days: 14 }); // Default to 14 on error\n    }\n  });\n\n  // Get category restriction days (public endpoint for validation - Pro users)\n  app.get(\"/api/settings/category-restriction-days\", async (req, res) => {\n    try {\n      const setting = await storage.getAdminSetting('category_restriction_days');\n      const days = setting ? parseInt(setting.value, 10) : 14; // Default to 14 days\n      res.json({ days });\n    } catch (error) {\n      console.error(\"Error fetching category restriction:\", error);\n      res.json({ days: 14 }); // Default to 14 on error\n    }\n  });\n\n  // Get category restriction status for authenticated user (computed server-side)\n  // Returns: { status: 'allowed' | 'restricted', restrictionDays, lastChangedAt, message }\n  app.get(\"/api/category-restriction-status\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      \n      // Get the restriction days setting\n      const setting = await storage.getAdminSetting('category_restriction_days');\n      const restrictionDays = setting ? parseInt(setting.value, 10) : 14;\n      \n      // Get user profile to check categoriesLastChangedAt\n      const profile = await storage.getUserProfile(userId);\n      \n      if (!profile) {\n        // No profile found - allow access (new user)\n        return res.json({\n          status: 'allowed',\n          restrictionDays,\n          lastChangedAt: null,\n          message: null\n        });\n      }\n      \n      // If restriction is disabled (0 days), always allow\n      if (restrictionDays === 0) {\n        return res.json({\n          status: 'allowed',\n          restrictionDays: 0,\n          lastChangedAt: profile.categoriesLastChangedAt || null,\n          message: null\n        });\n      }\n      \n      // If no previous change, allow\n      const lastChangedAt = profile.categoriesLastChangedAt;\n      if (!lastChangedAt) {\n        return res.json({\n          status: 'allowed',\n          restrictionDays,\n          lastChangedAt: null,\n          message: null\n        });\n      }\n      \n      // Calculate if within restriction window\n      const lastChangedDate = new Date(lastChangedAt);\n      const allowedAfter = new Date(lastChangedDate);\n      allowedAfter.setDate(allowedAfter.getDate() + restrictionDays);\n      \n      const now = new Date();\n      const isRestricted = now < allowedAfter;\n      \n      if (isRestricted) {\n        return res.json({\n          status: 'restricted',\n          restrictionDays,\n          lastChangedAt: lastChangedAt,\n          message: `You can update your categories once every ${restrictionDays} days and Hammie will regenerate your questions.`\n        });\n      }\n      \n      return res.json({\n        status: 'allowed',\n        restrictionDays,\n        lastChangedAt: lastChangedAt,\n        message: null\n      });\n    } catch (error) {\n      console.error(\"Error checking category restriction status:\", error);\n      // On error, return restricted to be safe\n      res.status(500).json({ \n        status: 'error',\n        error: \"Failed to check restriction status\" \n      });\n    }\n  });\n\n  // Update restriction timestamps after question generation completes\n  // Called by GeneratingQuestionsScreen after generation finishes\n  app.post(\"/api/generation-complete\", verifySupabaseAuth, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { regenerationType } = req.body;\n      \n      console.log(`[POST /api/generation-complete] userId=${userId}, regenerationType=${regenerationType}`);\n      \n      if (!regenerationType || !['first_login', 'postcode_change', 'category_change'].includes(regenerationType)) {\n        return res.status(400).json({ error: \"Invalid regenerationType\" });\n      }\n      \n      const profile = await storage.getUserProfile(userId);\n      if (!profile) {\n        console.log(`[POST /api/generation-complete] No profile found for user ${userId}`);\n        return res.status(404).json({ error: \"User profile not found\" });\n      }\n      \n      const now = new Date();\n      let updated = false;\n      \n      if (regenerationType === 'first_login') {\n        // Initial signup flow: only set postcode_last_changed_at if user has a postcode\n        // If postcode is empty, leave it NULL so user can add one later without restriction\n        if (!profile.postcodeLastChangedAt && profile.postcode) {\n          await storage.upsertUserProfile({\n            id: userId,\n            email: profile.email,\n            postcodeLastChangedAt: now,\n          });\n          console.log(`[POST /api/generation-complete] Set postcodeLastChangedAt to ${now} for first_login (has postcode)`);\n          updated = true;\n        } else if (!profile.postcode) {\n          console.log(`[POST /api/generation-complete] No postcode set, leaving postcodeLastChangedAt NULL for first_login`);\n        } else {\n          console.log(`[POST /api/generation-complete] postcodeLastChangedAt already set, skipping for first_login`);\n        }\n      } else if (regenerationType === 'postcode_change') {\n        // Postcode/region change: always update postcodeLastChangedAt\n        await storage.upsertUserProfile({\n          id: userId,\n          email: profile.email,\n          postcodeLastChangedAt: now,\n        });\n        console.log(`[POST /api/generation-complete] Updated postcodeLastChangedAt to ${now} for postcode_change`);\n        updated = true;\n      } else if (regenerationType === 'category_change') {\n        // Category change: set categories_last_changed_at\n        // On first run (NULL), initialize it; on subsequent runs, update it\n        if (!profile.categoriesLastChangedAt) {\n          await storage.upsertUserProfile({\n            id: userId,\n            email: profile.email,\n            categoriesLastChangedAt: now,\n          });\n          console.log(`[POST /api/generation-complete] Set categoriesLastChangedAt to ${now} for category_change (was NULL)`);\n          updated = true;\n        } else {\n          // Subsequent category changes - also update the timestamp\n          await storage.upsertUserProfile({\n            id: userId,\n            email: profile.email,\n            categoriesLastChangedAt: now,\n          });\n          console.log(`[POST /api/generation-complete] Updated categoriesLastChangedAt to ${now} for category_change`);\n          updated = true;\n        }\n      }\n      \n      res.json({ success: true, updated, regenerationType });\n    } catch (error) {\n      console.error(\"Error in generation-complete:\", error);\n      res.status(500).json({ error: \"Failed to update timestamps\" });\n    }\n  });\n\n  // Demand scheduler config routes (admin only)\n  app.get(\"/api/admin/demand-scheduler\", verifySupabaseAuth, requireAdmin, async (req, res) => {\n    try {\n      const config = await storage.getDemandSchedulerConfig();\n      if (!config) {\n        // Return default values if no config exists\n        return res.json({ \n          start_time: \"01:00\", \n          frequency_hours: 24,\n          exists: false \n        });\n      }\n      res.json({ ...config, exists: true });\n    } catch (error) {\n      console.error(\"Error fetching demand scheduler config:\", error);\n      res.status(500).json({ error: \"Failed to fetch demand scheduler config\" });\n    }\n  });\n\n  app.put(\"/api/admin/demand-scheduler\", verifySupabaseAuth, requireAdmin, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const { start_time, frequency_hours } = req.body;\n\n      // Validate inputs\n      if (!start_time || !frequency_hours) {\n        return res.status(400).json({ error: \"start_time and frequency_hours are required\" });\n      }\n\n      // Validate start_time format (HH:mm)\n      const timeRegex = /^([01]\\d|2[0-3]):([0-5]\\d)$/;\n      if (!timeRegex.test(start_time)) {\n        return res.status(400).json({ error: \"start_time must be in HH:mm format (24-hour)\" });\n      }\n\n      // Validate frequency_hours (must be positive integer)\n      const freqHours = parseInt(frequency_hours, 10);\n      if (isNaN(freqHours) || freqHours <= 0 || freqHours > 24) {\n        return res.status(400).json({ error: \"frequency_hours must be a positive integer between 1 and 24\" });\n      }\n\n      // Validate that 24 is divisible by frequency_hours\n      if (24 % freqHours !== 0) {\n        return res.status(400).json({ error: \"frequency_hours must divide evenly into 24 (1, 2, 3, 4, 6, 8, 12, or 24)\" });\n      }\n\n      const config = await storage.upsertDemandSchedulerConfig({\n        start_time,\n        frequency_hours: freqHours,\n        updated_by: userId,\n      });\n\n      res.json(config);\n    } catch (error) {\n      console.error(\"Error updating demand scheduler config:\", error);\n      res.status(500).json({ error: \"Failed to update demand scheduler config\" });\n    }\n  });\n\n  // Trigger the update-demand-schedule Edge Function\n  app.post(\"/api/admin/demand-scheduler/apply\", verifySupabaseAuth, requireAdmin, async (req: any, res) => {\n    try {\n      const userAccessToken = req.headers.authorization?.replace('Bearer ', '');\n      const supabaseUrl = process.env.SUPABASE_URL;\n      const supabaseAnonKey = process.env.SUPABASE_ANON_KEY;\n\n      if (!supabaseUrl || !supabaseAnonKey) {\n        console.error(\"Missing SUPABASE_URL or SUPABASE_ANON_KEY environment variables\");\n        return res.status(500).json({ error: \"Server configuration error\" });\n      }\n\n      if (!userAccessToken) {\n        return res.status(401).json({ error: \"No access token available\" });\n      }\n\n      // Call the Edge Function using the anon key for auth, and pass user token for admin verification\n      const edgeFunctionUrl = `${supabaseUrl}/functions/v1/update-demand-schedule`;\n      \n      const response = await fetch(edgeFunctionUrl, {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${supabaseAnonKey}`,\n          'x-user-access-token': userAccessToken,\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({}),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(\"Edge Function error:\", errorText);\n        return res.status(response.status).json({ \n          error: \"Failed to apply schedule\", \n          details: errorText \n        });\n      }\n\n      const result = await response.json();\n      res.json({ success: true, ...result });\n    } catch (error: any) {\n      console.error(\"Error calling update-demand-schedule:\", error);\n      res.status(500).json({ error: \"Failed to apply schedule\", details: error.message });\n    }\n  });\n\n  // Admin endpoint to fix/drop the postcode guard trigger (if it exists)\n  // This trigger may be blocking postcode changes with hardcoded 14-day restriction\n  app.post(\"/api/admin/fix-postcode-trigger\", verifySupabaseAuth, requireAdmin, async (req, res) => {\n    try {\n      console.log(\"[POST /api/admin/fix-postcode-trigger] Attempting to drop postcode guard trigger...\");\n      \n      // First, get the current restriction setting\n      const setting = await storage.getAdminSetting('postcode_restriction_days');\n      const restrictionDays = setting ? parseInt(setting.value, 10) : 14;\n      \n      // Drop ALL triggers that might be using the postcode guard function\n      // There may be multiple trigger names pointing to the same function\n      await db.execute(sql`DROP TRIGGER IF EXISTS trg_postcode_guard ON public.user_profiles`);\n      console.log(\"[POST /api/admin/fix-postcode-trigger] Dropped trigger trg_postcode_guard (if existed)\");\n      \n      await db.execute(sql`DROP TRIGGER IF EXISTS user_profiles_postcode_guard ON public.user_profiles`);\n      console.log(\"[POST /api/admin/fix-postcode-trigger] Dropped trigger user_profiles_postcode_guard (if existed)\");\n      \n      // Also try other possible trigger names\n      await db.execute(sql`DROP TRIGGER IF EXISTS postcode_guard ON public.user_profiles`);\n      await db.execute(sql`DROP TRIGGER IF EXISTS postcode_change_guard ON public.user_profiles`);\n      console.log(\"[POST /api/admin/fix-postcode-trigger] Dropped all known postcode guard triggers\");\n      \n      // Now drop the function with CASCADE to remove any remaining dependencies\n      await db.execute(sql`DROP FUNCTION IF EXISTS trg_postcode_guard() CASCADE`);\n      console.log(\"[POST /api/admin/fix-postcode-trigger] Dropped function trg_postcode_guard() with CASCADE\");\n      \n      // If restriction is > 0, create a new trigger that reads from admin_settings\n      if (restrictionDays > 0) {\n        // Create a function that reads the restriction from admin_settings table\n        await db.execute(sql`\n          CREATE OR REPLACE FUNCTION trg_postcode_guard()\n          RETURNS TRIGGER AS $$\n          DECLARE\n            restriction_days INTEGER;\n            last_changed TIMESTAMP;\n            allowed_after TIMESTAMP;\n          BEGIN\n            -- Get the restriction setting, default to 14 if not found\n            SELECT COALESCE((value::INTEGER), 14) INTO restriction_days\n            FROM admin_settings WHERE key = 'postcode_restriction_days';\n            \n            -- If restriction is 0 (no restriction), allow the change\n            IF restriction_days = 0 THEN\n              RETURN NEW;\n            END IF;\n            \n            -- Check if postcode is actually changing\n            IF NEW.postcode IS DISTINCT FROM OLD.postcode THEN\n              -- Get the last changed timestamp\n              last_changed := OLD.postcode_last_changed_at;\n              \n              -- If never changed before, allow it\n              IF last_changed IS NULL THEN\n                RETURN NEW;\n              END IF;\n              \n              -- Calculate when change is allowed\n              allowed_after := last_changed + (restriction_days || ' days')::INTERVAL;\n              \n              -- Block if within restriction window\n              IF NOW() < allowed_after THEN\n                RAISE EXCEPTION 'You can only change your postcode once every % days', restriction_days;\n              END IF;\n            END IF;\n            \n            RETURN NEW;\n          END;\n          $$ LANGUAGE plpgsql\n        `);\n        \n        // Create the trigger\n        await db.execute(sql`\n          CREATE TRIGGER trg_postcode_guard\n          BEFORE UPDATE ON public.user_profiles\n          FOR EACH ROW\n          EXECUTE FUNCTION trg_postcode_guard()\n        `);\n        \n        console.log(\"[POST /api/admin/fix-postcode-trigger] Created new trigger with dynamic restriction setting\");\n        res.json({ \n          success: true, \n          message: `Trigger recreated with dynamic restriction (currently ${restrictionDays} days from admin settings)`,\n          restrictionDays\n        });\n      } else {\n        console.log(\"[POST /api/admin/fix-postcode-trigger] Restriction is 0, trigger removed completely\");\n        res.json({ \n          success: true, \n          message: \"Trigger removed (restriction is set to 'No restriction')\",\n          restrictionDays: 0\n        });\n      }\n    } catch (error: any) {\n      console.error(\"[POST /api/admin/fix-postcode-trigger] Error:\", error);\n      res.status(500).json({ \n        error: \"Failed to fix trigger\", \n        details: error.message,\n        hint: \"You may need to run this SQL directly in Supabase SQL Editor:\\n\" +\n              \"DROP TRIGGER IF EXISTS trg_postcode_guard ON public.user_profiles;\\n\" +\n              \"DROP TRIGGER IF EXISTS user_profiles_postcode_guard ON public.user_profiles;\\n\" +\n              \"DROP FUNCTION IF EXISTS trg_postcode_guard() CASCADE;\"\n      });\n    }\n  });\n\n  // Get all subscription tiers for admin visibility management\n  app.get(\"/api/admin/tiers\", verifySupabaseAuth, requireAdmin, async (req: any, res) => {\n    try {\n      const result = await db.execute(sql`\n        SELECT \n          id,\n          region,\n          tier,\n          tier_type as \"tierType\",\n          active\n        FROM user_tier\n        WHERE tier != 'Standard'\n        ORDER BY region, sort_order ASC\n      `);\n      \n      const rows = Array.isArray(result) ? result : (result as any).rows || [];\n      return res.json(rows);\n    } catch (error: any) {\n      console.error(\"[GET /api/admin/tiers] Error:\", error);\n      return res.status(500).json({ error: \"Failed to fetch tiers\" });\n    }\n  });\n\n  // Update tier visibility (active status)\n  app.put(\"/api/admin/tiers\", verifySupabaseAuth, requireAdmin, async (req: any, res) => {\n    try {\n      const { updates } = req.body;\n      \n      if (!updates || !Array.isArray(updates)) {\n        return res.status(400).json({ error: \"Invalid updates format\" });\n      }\n\n      // Update each tier's active status\n      const results = await Promise.all(\n        updates.map(({ tierId, active }: { tierId: string; active: boolean }) =>\n          db.execute(sql`\n            UPDATE user_tier \n            SET active = ${active}, updated_at = NOW()\n            WHERE id = ${tierId} AND tier != 'Standard'\n          `)\n        )\n      );\n\n      console.log(\"[PUT /api/admin/tiers] Updated tier visibility:\", updates.length, \"tiers\");\n      return res.json({ \n        success: true, \n        message: `Updated ${updates.length} tier visibility settings` \n      });\n    } catch (error: any) {\n      console.error(\"[PUT /api/admin/tiers] Error:\", error);\n      return res.status(500).json({ error: \"Failed to update tier visibility\" });\n    }\n  });\n\n  // Debug endpoint to check user data (admin only)\n  app.get(\"/api/admin/debug-user/:userId\", verifySupabaseAuth, requireAdmin, async (req, res) => {\n    try {\n      const { userId } = req.params;\n      console.log(\"[GET /api/admin/debug-user] Checking user:\", userId);\n      \n      // Get user profile from Supabase\n      const { data: profile, error: profileError } = await supabaseAdmin\n        .from(\"user_profiles\")\n        .select(\"*\")\n        .eq(\"id\", userId)\n        .single();\n      \n      if (profileError) {\n        console.error(\"[GET /api/admin/debug-user] Profile error:\", profileError);\n      }\n      \n      // Get location_allocation entries\n      const { data: locations, error: locError } = await supabaseAdmin\n        .from(\"location_allocation\")\n        .select(\"*\")\n        .eq(\"user_id\", userId);\n      \n      if (locError) {\n        console.error(\"[GET /api/admin/debug-user] Location allocation error:\", locError);\n      }\n      \n      // Get user_question_allocation entries (count only)\n      const { data: questions, error: questionsError, count } = await supabaseAdmin\n        .from(\"user_question_allocation\")\n        .select(\"id\", { count: 'exact' })\n        .eq(\"user_id\", userId);\n      \n      if (questionsError) {\n        console.error(\"[GET /api/admin/debug-user] Questions error:\", questionsError);\n      }\n      \n      res.json({\n        userId,\n        profile: profile || null,\n        profileError: profileError?.message || null,\n        locationAllocation: locations || [],\n        locationAllocationCount: locations?.length || 0,\n        locationError: locError?.message || null,\n        questionAllocationCount: count || 0,\n        questionsError: questionsError?.message || null,\n      });\n    } catch (error: any) {\n      console.error(\"[GET /api/admin/debug-user] Error:\", error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Debug endpoint to check streak data\n  app.get(\"/api/admin/debug-streak/:userId\", verifySupabaseAuth, requireAdmin, async (req, res) => {\n    try {\n      const { userId } = req.params;\n      console.log(\"[GET /api/admin/debug-streak] Checking streak for user:\", userId);\n      \n      // Get raw game attempts with streak_day_status for region mode\n      const regionAttempts = await db.execute(sql`\n        SELECT \n          ga.id,\n          ga.result,\n          ga.streak_day_status,\n          ga.completed_at,\n          qa.puzzle_date,\n          qa.region\n        FROM game_attempts_region ga\n        INNER JOIN questions_allocated_region qa ON ga.allocated_region_id = qa.id\n        WHERE ga.user_id = ${userId}\n        ORDER BY qa.puzzle_date DESC\n        LIMIT 20\n      `);\n      \n      // Get user stats region\n      const regionStats = await db.execute(sql`\n        SELECT * FROM user_stats_region WHERE user_id = ${userId}\n      `);\n      \n      const regionRows = Array.isArray(regionAttempts) ? regionAttempts : (regionAttempts as any).rows || [];\n      const regionStatsRows = Array.isArray(regionStats) ? regionStats : (regionStats as any).rows || [];\n      \n      res.json({\n        userId,\n        regionGameAttempts: regionRows,\n        regionStats: regionStatsRows[0] || null,\n      });\n    } catch (error: any) {\n      console.error(\"[GET /api/admin/debug-streak] Error:\", error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Debug endpoint to trigger stats recalculation for any user (admin only)\n  app.post(\"/api/admin/recalculate-stats/:userId\", verifySupabaseAuth, requireAdmin, async (req, res) => {\n    try {\n      const { userId } = req.params;\n      const { region } = req.query;\n      console.log(\"[POST /api/admin/recalculate-stats] Recalculating for user:\", userId, \"region:\", region);\n      \n      const stats = await storage.recalculateUserStatsRegion(userId, (region as string) || undefined);\n      res.json(stats);\n    } catch (error: any) {\n      console.error(\"[POST /api/admin/recalculate-stats] Error:\", error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Bulk recalculate stats for ALL users (admin only) - both Region and User modes\n  app.post(\"/api/admin/recalculate-all-stats\", verifySupabaseAuth, requireAdmin, async (req, res) => {\n    try {\n      console.log(\"[POST /api/admin/recalculate-all-stats] Starting bulk recalculation...\");\n      \n      // Get all unique user IDs from both game modes\n      const regionUsersResult = await db.execute(sql`\n        SELECT DISTINCT user_id FROM user_stats_region WHERE user_id IS NOT NULL\n      `);\n      const userModeUsersResult = await db.execute(sql`\n        SELECT DISTINCT user_id FROM user_stats_user WHERE user_id IS NOT NULL\n      `);\n      \n      const regionRows = Array.isArray(regionUsersResult) ? regionUsersResult : (regionUsersResult as any).rows || [];\n      const userRows = Array.isArray(userModeUsersResult) ? userModeUsersResult : (userModeUsersResult as any).rows || [];\n      \n      // Combine unique user IDs from both tables\n      const allUserIds = new Set<string>();\n      for (const row of regionRows) {\n        if (row.user_id) allUserIds.add(row.user_id);\n      }\n      for (const row of userRows) {\n        if (row.user_id) allUserIds.add(row.user_id);\n      }\n      \n      const userIdArray = Array.from(allUserIds);\n      console.log(`[POST /api/admin/recalculate-all-stats] Found ${userIdArray.length} unique users to recalculate`);\n      \n      const results: { userId: string; regionStats?: any; userStats?: any; error?: string }[] = [];\n      \n      for (const userId of userIdArray) {\n        try {\n          console.log(`[POST /api/admin/recalculate-all-stats] Recalculating for user: ${userId}`);\n          \n          // Recalculate Region mode stats\n          let regionStats = null;\n          try {\n            regionStats = await storage.recalculateUserStatsRegion(userId);\n          } catch (e) {\n            console.log(`[POST /api/admin/recalculate-all-stats] No region stats for user ${userId}`);\n          }\n          \n          // Recalculate User mode stats\n          let userStats = null;\n          try {\n            userStats = await storage.recalculateUserStatsUser(userId);\n          } catch (e) {\n            console.log(`[POST /api/admin/recalculate-all-stats] No user stats for user ${userId}`);\n          }\n          \n          results.push({ userId, regionStats, userStats });\n        } catch (error: any) {\n          console.error(`[POST /api/admin/recalculate-all-stats] Error for user ${userId}:`, error.message);\n          results.push({ userId, error: error.message });\n        }\n      }\n      \n      console.log(`[POST /api/admin/recalculate-all-stats] Completed. Processed ${results.length} users.`);\n      res.json({\n        success: true,\n        totalUsers: userIdArray.length,\n        results,\n      });\n    } catch (error: any) {\n      console.error(\"[POST /api/admin/recalculate-all-stats] Error:\", error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","path":null,"size_bytes":134046,"size_tokens":null},"client/src/components/NumericKeyboard.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Delete, RotateCcw } from \"lucide-react\";\nimport { soundManager } from \"@/lib/sounds\";\n\nexport type KeyState = \"default\" | \"correct\" | \"inSequence\" | \"ruledOut\";\n\ninterface NumericKeyboardProps {\n  onDigitPress: (digit: string) => void;\n  onDelete: () => void;\n  onClear: () => void;\n  onEnter: () => void;\n  keyStates: Record<string, KeyState>;\n  canSubmit: boolean;\n}\n\nexport function NumericKeyboard({\n  onDigitPress,\n  onDelete,\n  onClear,\n  onEnter,\n  keyStates,\n  canSubmit,\n}: NumericKeyboardProps) {\n  const getKeyClasses = (digit: string) => {\n    const state = keyStates[digit] || \"default\";\n    switch (state) {\n      case \"correct\":\n        return \"bg-game-correct text-white hover:bg-game-correct\";\n      case \"inSequence\":\n        return \"bg-game-inSequence text-white hover:bg-game-inSequence\";\n      case \"ruledOut\":\n        return \"bg-gray-500 text-white font-bold\";\n      default:\n        return \"\";\n    }\n  };\n\n  const handleClick = (callback: () => void) => {\n    soundManager.playClick();\n    callback();\n  };\n\n  return (\n    <div className=\"space-y-1.5 sm:space-y-2 w-full\" data-testid=\"numeric-keyboard\">\n      {/* Row 1 */}\n      <div className=\"flex gap-1.5 sm:gap-2 justify-center\">\n        {[\"1\", \"2\", \"3\", \"4\", \"5\"].map((digit) => (\n          <Button\n            key={digit}\n            className={`h-14 sm:h-16 [@media(max-height:600px)]:h-11 flex-1 text-lg sm:text-xl font-bold rounded-md active:scale-95 transition-transform ${\n              getKeyClasses(digit) || \"bg-gray-200 text-gray-800 hover:bg-gray-300\"\n            }`}\n            onClick={() => handleClick(() => onDigitPress(digit))}\n            data-testid={`key-${digit}`}\n          >\n            {digit}\n          </Button>\n        ))}\n      </div>\n\n      {/* Row 2 */}\n      <div className=\"flex gap-1.5 sm:gap-2 justify-center\">\n        {[\"6\", \"7\", \"8\", \"9\", \"0\"].map((digit) => (\n          <Button\n            key={digit}\n            className={`h-14 sm:h-16 [@media(max-height:600px)]:h-11 flex-1 text-lg sm:text-xl font-bold rounded-md active:scale-95 transition-transform ${\n              getKeyClasses(digit) || \"bg-gray-200 text-gray-800 hover:bg-gray-300\"\n            }`}\n            onClick={() => handleClick(() => onDigitPress(digit))}\n            data-testid={`key-${digit}`}\n          >\n            {digit}\n          </Button>\n        ))}\n      </div>\n\n      {/* Row 3 */}\n      <div className=\"flex gap-1.5 sm:gap-2 justify-center\">\n        {/* Enter key */}\n        <Button\n          className={`flex-1 h-14 sm:h-16 [@media(max-height:600px)]:h-11 text-base sm:text-lg font-bold rounded-md active:scale-95 transition-transform ${\n            canSubmit\n              ? \"bg-brand-blue/90 hover:bg-brand-blue/80 text-white\"\n              : \"bg-brand-blue/60 text-white cursor-not-allowed\"\n          }`}\n          onClick={() => handleClick(onEnter)}\n          disabled={!canSubmit}\n          data-testid=\"key-enter\"\n        >\n          Enter\n        </Button>\n\n        {/* Clear key */}\n        <Button\n          className=\"flex-1 h-14 sm:h-16 [@media(max-height:600px)]:h-11 bg-gray-200 text-gray-800 font-bold rounded-md hover:bg-gray-300 active:scale-95 transition-transform\"\n          onClick={() => handleClick(onClear)}\n          data-testid=\"key-clear\"\n        >\n          <RotateCcw className=\"h-6 w-6 sm:h-7 sm:w-7\" />\n        </Button>\n\n        {/* Delete key */}\n        <Button\n          className=\"flex-1 h-14 sm:h-16 [@media(max-height:600px)]:h-11 bg-gray-200 text-gray-800 font-bold rounded-md hover:bg-gray-300 active:scale-95 transition-transform\"\n          onClick={() => handleClick(onDelete)}\n          data-testid=\"key-delete\"\n        >\n          <Delete className=\"h-6 w-6 sm:h-7 sm:w-7\" />\n        </Button>\n      </div>\n    </div>\n\n  );\n}\n","path":null,"size_bytes":3829,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n        xl: \"1rem\", /* 16px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        game: {\n          correct: \"hsl(var(--chart-1) / <alpha-value>)\",\n          inSequence: \"hsl(var(--chart-2) / <alpha-value>)\",\n          notInSequence: \"hsl(0 0% 60% / <alpha-value>)\",\n          ruledOut: \"hsl(0 0% 80% / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n\n        brand: {\n          blue: \"#7DAAE8\",\n          yellow: \"#FFD429\",\n          green: \"#A4DB57\",\n          grey: \"#C4C9D4\",\n          purple: \"#8e57db\",\n          background: \"#FAFAFA\",\n        },\n      },\n      fontFamily: {\n        sans: [\"Nunito\", \"sans-serif\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":4544,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"server/storage.ts":{"content":"import {\n  userProfiles,\n  userSettings,\n  regions,\n  categories,\n  populatedPlaces,\n  questionsMasterRegion,\n  questionsAllocatedRegion,\n  gameAttemptsRegion,\n  guessesRegion,\n  userStatsRegion,\n  questionsMasterUser,\n  questionsAllocatedUser,\n  gameAttemptsUser,\n  guessesUser,\n  userStatsUser,\n  adminSettings,\n  userTier,\n  userHolidayEvents,\n  badges,\n  userBadges,\n  type UserProfile,\n  type InsertUserProfile,\n  type Puzzle,\n  type UserSettings,\n  type InsertUserSettings,\n  type Region,\n  type Category,\n  type PopulatedPlace,\n  type QuestionMasterRegion,\n  type InsertQuestionMasterRegion,\n  type QuestionAllocatedRegion,\n  type InsertQuestionAllocatedRegion,\n  type GameAttemptRegion,\n  type InsertGameAttemptRegion,\n  type GuessRegion,\n  type InsertGuessRegion,\n  type UserStatsRegion,\n  type InsertUserStatsRegion,\n  type QuestionMasterUser,\n  type InsertQuestionMasterUser,\n  type QuestionAllocatedUser,\n  type InsertQuestionAllocatedUser,\n  type GameAttemptUser,\n  type InsertGameAttemptUser,\n  type GuessUser,\n  type InsertGuessUser,\n  type UserStatsUser,\n  type InsertUserStatsUser,\n  type AdminSetting,\n  type InsertAdminSetting,\n  type DemandSchedulerConfig,\n  type InsertDemandSchedulerConfig,\n  type UserTier,\n  type UserActiveTier,\n  type SubscriptionResponse,\n  type UserHolidayEvent,\n  type InsertUserHolidayEvent,\n  type Badge,\n  type UserBadge,\n  type UserBadgeWithDetails,\n  type InsertUserBadge,\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, and, gte, desc, isNull, sql, notInArray } from \"drizzle-orm\";\n\n// Type for allocated question with master question data (Region mode)\nexport type AllocatedQuestionWithMaster = QuestionAllocatedRegion & {\n  masterQuestion: QuestionMasterRegion;\n};\n\n// Type for game attempt with allocated question data (Region mode)\nexport type GameAttemptWithAllocatedQuestion = GameAttemptRegion & {\n  allocatedQuestion: AllocatedQuestionWithMaster;\n};\n\n// Type for allocated question with master question data (User mode)\nexport type AllocatedUserQuestionWithMaster = QuestionAllocatedUser & {\n  categoryName: string; // Category name from categories table join\n  placeName: string | null; // Place name for Local History (category 999)\n  masterQuestion: QuestionMasterUser;\n};\n\n// Type for game attempt with allocated question data (User mode)\nexport type GameAttemptUserWithAllocatedQuestion = GameAttemptUser & {\n  allocatedQuestion: AllocatedUserQuestionWithMaster;\n};\n\n// Interface for storage operations\nexport interface IStorage {\n  // Region operations\n  getRegions(): Promise<Region[]>;\n  \n  // Category operations\n  getCategoryById(id: number): Promise<Category | undefined>;\n\n  // User profile operations\n  getUserProfile(id: string): Promise<UserProfile | undefined>;\n  upsertUserProfile(profile: InsertUserProfile): Promise<UserProfile>;\n  updateSignupMethod(userId: string, signupMethod: string, passwordCreated: boolean): Promise<UserProfile>;\n  updatePasswordCreated(userId: string, passwordCreated: boolean): Promise<UserProfile>;\n  updateOAuthLinked(userId: string, provider: 'google' | 'apple', linked: boolean): Promise<UserProfile>;\n\n  // User tier operations (new subscription system)\n  // LEGACY - kept for backward compatibility, use getSubscriptionData instead\n  getUserActiveTier(userId: string): Promise<UserActiveTier | undefined>;\n  \n  // New subscription system - reads from user_profiles + user_tier\n  getSubscriptionData(userId: string): Promise<SubscriptionResponse | null>;\n  getAvailableTiers(region: string): Promise<UserTier[]>;\n  getPurchasableTiers(region: string): Promise<UserTier[]>; // Excludes Standard\n  getStandardTierId(region: string): Promise<string | null>;\n  createUserSubscription(subscription: { userId: string; userTierId: string; amountPaid?: number; currency?: string; expiresAt?: Date; autoRenew?: boolean; source?: string }): Promise<void>;\n  createDefaultSubscription(userId: string, region: string): Promise<void>; // For signup\n  downgradeToStandard(userId: string, region: string): Promise<void>;\n  updateAutoRenew(userId: string, autoRenew: boolean): Promise<void>;\n\n  // Puzzle operations (LEGACY - will be deprecated)\n  getPuzzle(id: number): Promise<Puzzle | undefined>;\n  getPuzzleByDate(date: string): Promise<Puzzle | undefined>;\n  getAllPuzzles(): Promise<Puzzle[]>;\n  getPuzzlesSince(date: string): Promise<Puzzle[]>;\n  createPuzzle(puzzle: InsertPuzzle): Promise<Puzzle>;\n\n  // User settings operations\n  getUserSettings(userId: string): Promise<UserSettings | undefined>;\n  upsertUserSettings(settings: InsertUserSettings): Promise<UserSettings>;\n\n  // Game attempt operations (LEGACY - will be deprecated)\n  getGameAttempt(id: number): Promise<GameAttempt | undefined>;\n  getGameAttemptsByUser(userId: string): Promise<GameAttempt[]>;\n  getGameAttemptByUserAndPuzzle(userId: string | null, puzzleId: number): Promise<GameAttempt | undefined>;\n  getOpenAttemptByUserAndPuzzle(userId: string, puzzleId: number): Promise<GameAttempt | undefined>;\n  createGameAttempt(attempt: InsertGameAttempt): Promise<GameAttempt>;\n  upsertGameAttempt(attempt: InsertGameAttempt): Promise<GameAttempt>;\n  updateGameAttempt(id: number, updateData: Partial<Omit<GameAttempt, 'id' | 'userId' | 'puzzleId' | 'startedAt'>>): Promise<GameAttempt>;\n  incrementAttemptGuesses(gameAttemptId: number): Promise<void>;\n\n  // Guess operations (LEGACY - will be deprecated)\n  getGuessesByGameAttempt(gameAttemptId: number): Promise<Guess[]>;\n  createGuess(guess: InsertGuess): Promise<Guess>;\n  getRecentGuessesWithPuzzleIds(userId: string, since: string): Promise<Array<Guess & { puzzleId: number }>>;\n  getAllGuessesWithPuzzleIds(userId: string): Promise<Array<Guess & { puzzleId: number; result: string | null }>>;\n\n  // User stats operations (LEGACY - will be deprecated)\n  getUserStats(userId: string): Promise<UserStats | undefined>;\n  upsertUserStats(stats: InsertUserStats): Promise<UserStats>;\n  recalculateUserStats(userId: string): Promise<UserStats>;\n  getUserPercentileRanking(userId: string): Promise<number>;\n\n  // Admin export operations\n  getAllGameAttemptsForExport(): Promise<any[]>;\n\n  // Admin settings operations\n  getAdminSettings(): Promise<AdminSetting[]>;\n  getAdminSetting(key: string): Promise<AdminSetting | undefined>;\n  upsertAdminSetting(setting: InsertAdminSetting): Promise<AdminSetting>;\n\n  // Demand scheduler config operations\n  getDemandSchedulerConfig(): Promise<DemandSchedulerConfig | undefined>;\n  upsertDemandSchedulerConfig(config: InsertDemandSchedulerConfig & { updated_by?: string }): Promise<DemandSchedulerConfig>;\n\n  // ========================================================================\n  // REGION GAME MODE OPERATIONS\n  // ========================================================================\n\n  // Question master operations (region)\n  getQuestionMasterRegion(id: number): Promise<QuestionMasterRegion | undefined>;\n  createQuestionMasterRegion(question: InsertQuestionMasterRegion): Promise<QuestionMasterRegion>;\n\n  // Question allocated operations (region)\n  getAllocatedQuestionByRegionAndDate(region: string, date: string): Promise<AllocatedQuestionWithMaster | undefined>;\n  getAllocatedQuestionsByRegion(region: string): Promise<AllocatedQuestionWithMaster[]>;\n  getAllocatedQuestionsSinceByRegion(region: string, since: string): Promise<AllocatedQuestionWithMaster[]>;\n  createQuestionAllocatedRegion(allocation: InsertQuestionAllocatedRegion): Promise<QuestionAllocatedRegion>;\n\n  // Game attempt operations (region)\n  getGameAttemptRegion(id: number): Promise<GameAttemptRegion | undefined>;\n  getGameAttemptRegionWithQuestion(id: number): Promise<GameAttemptWithAllocatedQuestion | undefined>;\n  getGameAttemptsByUserRegion(userId: string): Promise<GameAttemptWithAllocatedQuestion[]>;\n  getGameAttemptByUserAndAllocated(userId: string | null, allocatedRegionId: number): Promise<GameAttemptRegion | undefined>;\n  createGameAttemptRegion(attempt: InsertGameAttemptRegion): Promise<GameAttemptRegion>;\n  updateGameAttemptRegion(id: number, updateData: Partial<Omit<GameAttemptRegion, 'id' | 'userId' | 'allocatedRegionId' | 'startedAt'>>): Promise<GameAttemptRegion>;\n  incrementAttemptGuessesRegion(gameAttemptId: number): Promise<void>;\n\n  // Guess operations (region)\n  getGuessesByGameAttemptRegion(gameAttemptId: number): Promise<GuessRegion[]>;\n  createGuessRegion(guess: InsertGuessRegion): Promise<GuessRegion>;\n  getRecentGuessesWithAllocatedIdsRegion(userId: string, since: string): Promise<Array<GuessRegion & { allocatedRegionId: number }>>;\n  getAllGuessesWithAllocatedIdsRegion(userId: string): Promise<Array<GuessRegion & { allocatedRegionId: number; result: string | null }>>;\n\n  // User stats operations (region)\n  getUserStatsRegion(userId: string): Promise<UserStatsRegion | undefined>;\n  upsertUserStatsRegion(stats: InsertUserStatsRegion): Promise<UserStatsRegion>;\n  recalculateUserStatsRegion(userId: string): Promise<UserStatsRegion>;\n  getUserPercentileRankingRegion(userId: string): Promise<number>;\n\n  // ========================================================================\n  // USER GAME MODE OPERATIONS\n  // ========================================================================\n\n  // Question master operations (user)\n  getQuestionMasterUser(id: number): Promise<QuestionMasterUser | undefined>;\n  createQuestionMasterUser(question: InsertQuestionMasterUser): Promise<QuestionMasterUser>;\n\n  // Question allocated operations (user)\n  getAllocatedQuestionByUserAndDate(userId: string, date: string): Promise<AllocatedUserQuestionWithMaster | undefined>;\n  getAllocatedQuestionsByUser(userId: string): Promise<AllocatedUserQuestionWithMaster[]>;\n  getAllocatedQuestionsSinceByUser(userId: string, since: string): Promise<AllocatedUserQuestionWithMaster[]>;\n  createQuestionAllocatedUser(allocation: InsertQuestionAllocatedUser): Promise<QuestionAllocatedUser>;\n  ensureUserAllocations(userId: string, minCount?: number): Promise<void>;\n\n  // Game attempt operations (user)\n  getGameAttemptUser(id: number): Promise<GameAttemptUser | undefined>;\n  getGameAttemptUserWithQuestion(id: number): Promise<GameAttemptUserWithAllocatedQuestion | undefined>;\n  getGameAttemptsByUserUser(userId: string): Promise<GameAttemptUserWithAllocatedQuestion[]>;\n  getGameAttemptByUserAndAllocatedUser(userId: string, allocatedUserId: number): Promise<GameAttemptUser | undefined>;\n  createGameAttemptUser(attempt: InsertGameAttemptUser): Promise<GameAttemptUser>;\n  updateGameAttemptUser(id: number, updateData: Partial<Omit<GameAttemptUser, 'id' | 'userId' | 'allocatedUserId' | 'startedAt'>>): Promise<GameAttemptUser>;\n  incrementAttemptGuessesUser(gameAttemptId: number): Promise<void>;\n\n  // Guess operations (user)\n  getGuessesByGameAttemptUser(gameAttemptId: number): Promise<GuessUser[]>;\n  createGuessUser(guess: InsertGuessUser): Promise<GuessUser>;\n  getRecentGuessesWithAllocatedIdsUser(userId: string, since: string): Promise<Array<GuessUser & { allocatedUserId: number }>>;\n  getAllGuessesWithAllocatedIdsUser(userId: string): Promise<Array<GuessUser & { allocatedUserId: number; result: string | null }>>;\n\n  // User stats operations (user)\n  getUserStatsUser(userId: string): Promise<UserStatsUser | undefined>;\n  upsertUserStatsUser(stats: InsertUserStatsUser): Promise<UserStatsUser>;\n  recalculateUserStatsUser(userId: string): Promise<UserStatsUser>;\n  getUserPercentileRankingUser(userId: string): Promise<number>;\n\n  // ========================================================================\n  // SUBSCRIPTION & PRO CATEGORY OPERATIONS\n  // ========================================================================\n  \n  // Subscription operations\n  getUserSubscription(userId: string): Promise<any | undefined>;\n  // Note: Use createUserSubscription() for new subscriptions (uses user_tier_id)\n  // The legacy upsertUserSubscription that used a 'tier' column has been removed\n  \n  // Category operations\n  getAllCategories(): Promise<Category[]>;\n  \n  // Pro category preferences\n  getUserProCategories(userId: string): Promise<number[]>;\n  saveUserProCategories(userId: string, categoryIds: number[]): Promise<void>;\n  \n  // First login tracking\n  markFirstLoginCompleted(userId: string): Promise<void>;\n\n  // ========================================================================\n  // STREAK SAVER & HOLIDAY OPERATIONS\n  // ========================================================================\n  \n  // Streak saver status - returns stats with flags for both game modes\n  getStreakSaverStatus(userId: string): Promise<{\n    region: {\n      currentStreak: number;\n      streakSaversUsedMonth: number;\n      missedYesterdayFlag: boolean;\n    };\n    user: {\n      currentStreak: number;\n      streakSaversUsedMonth: number;\n      holidayActive: boolean;\n      holidayStartDate: string | null;\n      holidayEndDate: string | null;\n      holidayDaysTakenCurrentPeriod: number;\n      holidayEnded: boolean;\n      missedYesterdayFlag: boolean;\n      holidaysUsedYear: number;\n    };\n  } | null>;\n  \n  // Use a streak saver for a game mode\n  useStreakSaver(userId: string, gameType: 'region' | 'user', allowance: number): Promise<{ success: boolean; error?: string }>;\n  \n  // Start a holiday (Pro users only)\n  startHoliday(userId: string, holidayDurationDays: number): Promise<{ success: boolean; error?: string }>;\n  \n  // End a holiday early (acknowledge=true when auto-ended and user dismisses popup)\n  endHoliday(userId: string, acknowledge?: boolean): Promise<{ success: boolean; error?: string }>;\n  \n  // Count holiday events used this year\n  countHolidayEventsThisYear(userId: string): Promise<number>;\n  \n  // Insert a holiday event record\n  insertHolidayEvent(userId: string, mode: 'region' | 'user', startedAt: Date, endedAt?: Date): Promise<void>;\n  \n  // Get holiday animation data - determines which games should show the animation\n  getHolidayAnimationData(userId: string): Promise<{\n    region: {\n      hasStreak: boolean;\n      todayStreakDayStatusZero: boolean;\n      holidayDates: string[]; // Consecutive dates backwards with streak_day_status=0\n    };\n    user: {\n      hasStreak: boolean;\n      todayStreakDayStatusZero: boolean;\n      holidayDates: string[]; // Consecutive dates backwards with streak_day_status=0\n    };\n  }>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // Region operations\n  async getRegions(): Promise<Region[]> {\n    return await db.select().from(regions).orderBy(regions.name);\n  }\n\n  // Category operations\n  async getCategoryById(id: number): Promise<Category | undefined> {\n    const [category] = await db.select().from(categories).where(eq(categories.id, id));\n    return category;\n  }\n\n  // User profile operations\n  async getUserProfile(id: string): Promise<UserProfile | undefined> {\n    const [profile] = await db.select().from(userProfiles).where(eq(userProfiles.id, id));\n    return profile;\n  }\n\n  async upsertUserProfile(profileData: InsertUserProfile): Promise<UserProfile> {\n    // Strip out undefined values so they dont clobber existing DB values\n    const cleanData = Object.fromEntries(\n      Object.entries(profileData).filter(([_, v]) => v !== undefined)\n    ) as Partial<InsertUserProfile>;\n\n    console.log('[upsertUserProfile] Input userTierId:', profileData.userTierId);\n    console.log('[upsertUserProfile] Clean data keys:', Object.keys(cleanData));\n    console.log('[upsertUserProfile] Clean data userTierId:', cleanData.userTierId);\n\n    const [profile] = await db\n      .insert(userProfiles)\n      .values(cleanData as InsertUserProfile)\n      .onConflictDoUpdate({\n        target: [userProfiles.id],\n        set: {\n          ...cleanData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n\n    console.log('[upsertUserProfile] Returned profile userTierId:', profile.userTierId);\n    return profile;\n  }\n  \n  async updateSignupMethod(userId: string, signupMethod: string, passwordCreated: boolean): Promise<UserProfile> {\n    console.log(`[updateSignupMethod] userId: ${userId}, signupMethod: ${signupMethod}, passwordCreated: ${passwordCreated}`);\n    \n    const [profile] = await db\n      .update(userProfiles)\n      .set({\n        signupMethod: signupMethod,\n        passwordCreated: passwordCreated,\n        updatedAt: new Date(),\n      })\n      .where(eq(userProfiles.id, userId))\n      .returning();\n    \n    return profile;\n  }\n  \n  async updatePasswordCreated(userId: string, passwordCreated: boolean): Promise<UserProfile> {\n    console.log(`[updatePasswordCreated] userId: ${userId}, passwordCreated: ${passwordCreated}`);\n    \n    const [profile] = await db\n      .update(userProfiles)\n      .set({\n        passwordCreated: passwordCreated,\n        updatedAt: new Date(),\n      })\n      .where(eq(userProfiles.id, userId))\n      .returning();\n    \n    return profile;\n  }\n\n  async updateOAuthLinked(userId: string, provider: 'google' | 'apple', linked: boolean): Promise<UserProfile> {\n    console.log(`[updateOAuthLinked] userId: ${userId}, provider: ${provider}, linked: ${linked}`);\n    \n    const setData: Record<string, any> = {\n      updatedAt: new Date(),\n    };\n    \n    if (provider === 'google') {\n      setData.googleLinked = linked;\n    } else if (provider === 'apple') {\n      setData.appleLinked = linked;\n    }\n    \n    const [profile] = await db\n      .update(userProfiles)\n      .set(setData)\n      .where(eq(userProfiles.id, userId))\n      .returning();\n    \n    return profile;\n  }\n\n  // User tier operations (new subscription system)\n  // LEGACY: Uses user_active_tier_view - kept for backward compatibility\n  async getUserActiveTier(userId: string): Promise<UserActiveTier | undefined> {\n    // Query the user_active_tier_view which resolves active subscription or falls back to standard tier\n    const result = await db.execute(sql`\n      SELECT \n        user_id as \"userId\",\n        tier_id as \"tierId\",\n        tier,\n        region,\n        subscription_cost as \"subscriptionCost\",\n        currency,\n        subscription_duration_months as \"subscriptionDurationMonths\",\n        streak_savers as \"streakSavers\",\n        holiday_savers as \"holidaySavers\",\n        holiday_duration_days as \"holidayDurationDays\",\n        description,\n        expires_at as \"expiresAt\",\n        auto_renew as \"autoRenew\",\n        is_active as \"isActive\"\n      FROM user_active_tier_view\n      WHERE user_id = ${userId}\n    `);\n    \n    const rows = Array.isArray(result) ? result : (result as any).rows || [];\n    if (!rows || rows.length === 0) {\n      return undefined;\n    }\n    \n    const row = rows[0];\n    return {\n      userId: row.userId,\n      tierId: row.tierId,\n      tier: row.tier,\n      region: row.region,\n      subscriptionCost: row.subscriptionCost,\n      currency: row.currency,\n      subscriptionDurationMonths: row.subscriptionDurationMonths,\n      streakSavers: row.streakSavers || 0,\n      holidaySavers: row.holidaySavers || 0,\n      holidayDurationDays: row.holidayDurationDays || 0,\n      description: row.description,\n      expiresAt: row.expiresAt?.toISOString?.() || row.expiresAt,\n      autoRenew: row.autoRenew || false,\n      isActive: row.isActive || false,\n    };\n  }\n\n  // NEW: Get subscription data from user_profiles + user_tier (replaces getUserActiveTier)\n  async getSubscriptionData(userId: string): Promise<SubscriptionResponse | null> {\n    // Query user_profiles joined with user_tier to get current tier and expiry\n    // Also fetch Stripe fields from the latest user_subscription record\n    const result = await db.execute(sql`\n      SELECT \n        up.id as \"userId\",\n        ut.id as \"tierId\",\n        ut.tier as \"tierName\",\n        ut.tier_type as \"tierType\",\n        ut.subscription_cost as \"subscriptionCost\",\n        ut.currency,\n        ut.subscription_duration_months as \"subscriptionDurationMonths\",\n        ut.streak_savers as \"streakSavers\",\n        ut.holiday_savers as \"holidaySavers\",\n        ut.holiday_duration_days as \"holidayDurationDays\",\n        ut.description,\n        ut.sort_order as \"sortOrder\",\n        up.subscription_end_date as \"endDate\",\n        up.user_tier_id as \"userTierId\",\n        (\n          SELECT us.auto_renew \n          FROM user_subscriptions us \n          WHERE us.user_id = up.id \n          ORDER BY us.created_at DESC \n          LIMIT 1\n        ) as \"autoRenew\",\n        (\n          SELECT us.stripe_subscription_id \n          FROM user_subscriptions us \n          WHERE us.user_id = up.id \n          ORDER BY us.created_at DESC \n          LIMIT 1\n        ) as \"stripeSubscriptionId\",\n        (\n          SELECT us.stripe_customer_id \n          FROM user_subscriptions us \n          WHERE us.user_id = up.id \n          ORDER BY us.created_at DESC \n          LIMIT 1\n        ) as \"stripeCustomerId\",\n        (\n          SELECT us.stripe_price_id \n          FROM user_subscriptions us \n          WHERE us.user_id = up.id \n          ORDER BY us.created_at DESC \n          LIMIT 1\n        ) as \"stripePriceId\"\n      FROM user_profiles up\n      LEFT JOIN user_tier ut ON ut.id = up.user_tier_id\n      WHERE up.id = ${userId}\n    `);\n    \n    const rows = Array.isArray(result) ? result : (result as any).rows || [];\n    if (!rows || rows.length === 0) {\n      return null;\n    }\n    \n    const row = rows[0];\n    const tierName = row.tierName || 'Standard';\n    const rawTierType = row.tierType || 'default';\n    \n    // Normalize tierType to valid union type - always clamp to 'default' for unknown values\n    const validTierTypes = new Set(['monthly', 'annual', 'lifetime', 'default']);\n    let tierType: 'monthly' | 'annual' | 'lifetime' | 'default' = 'default';\n    if (validTierTypes.has(rawTierType)) {\n      tierType = rawTierType as 'monthly' | 'annual' | 'lifetime' | 'default';\n    } else if (rawTierType) {\n      // Log unexpected tier_type for diagnostics\n      console.warn(`[getSubscriptionData] Unknown tier_type \"${rawTierType}\" for user ${userId}, defaulting to 'default'`);\n    }\n    \n    // Display tier: 'pro' if tier != 'Standard', else 'free'\n    const isPro = tierName.toLowerCase() !== 'standard';\n    const displayTier = isPro ? 'pro' : 'free';\n    \n    // Calculate isActive and isExpired based on tier type and end date\n    // For Standard tier: always active, never expired\n    // For lifetime Pro: always active, never expired\n    // For monthly/annual Pro: check end date\n    let isActive = false;\n    let isExpired = false;\n    \n    if (!isPro) {\n      // Standard tier is always active\n      isActive = true;\n      isExpired = false;\n    } else if (tierType === 'lifetime') {\n      // Lifetime Pro is always active\n      isActive = true;\n      isExpired = false;\n    } else if (row.endDate) {\n      // Monthly/annual Pro: check end date\n      const endDate = new Date(row.endDate);\n      const now = new Date();\n      isActive = endDate > now;\n      isExpired = endDate < now;\n    } else {\n      // Pro without end date - treat as active since they have a Pro tier assigned\n      // The end date will be set by Stripe webhook when subscription is created/renewed\n      // If they have a Pro tier, they should be treated as active until proven otherwise\n      isActive = true;\n      isExpired = false;\n    }\n    \n    return {\n      tier: displayTier as 'free' | 'pro',\n      tierName: tierName,\n      tierType: tierType as 'monthly' | 'annual' | 'lifetime' | 'default',\n      tierId: row.tierId || null,\n      userId: row.userId || null,\n      endDate: row.endDate ? new Date(row.endDate).toISOString() : null,\n      autoRenew: row.autoRenew ?? false,\n      isActive,\n      isExpired,\n      metadata: row.tierId ? {\n        streakSavers: row.streakSavers ?? 1,\n        holidaySavers: row.holidaySavers ?? 0,\n        holidayDurationDays: row.holidayDurationDays ?? 14,\n        subscriptionCost: row.subscriptionCost ? parseFloat(row.subscriptionCost) : null,\n        currency: row.currency || 'GBP',\n        subscriptionDurationMonths: row.subscriptionDurationMonths,\n        description: row.description,\n        sortOrder: row.sortOrder,\n      } : null,\n      // Stripe fields for managing subscription\n      stripeSubscriptionId: row.stripeSubscriptionId || null,\n      stripeCustomerId: row.stripeCustomerId || null,\n      stripePriceId: row.stripePriceId || null,\n    };\n  }\n\n  async getAvailableTiers(region: string): Promise<UserTier[]> {\n    // Query available tiers for the given region, ordered by sort_order\n    const tiers = await db\n      .select()\n      .from(userTier)\n      .where(and(eq(userTier.region, region), eq(userTier.active, true)))\n      .orderBy(userTier.sortOrder);\n    \n    return tiers;\n  }\n\n  // Get purchasable tiers (excludes Standard tier)\n  async getPurchasableTiers(region: string): Promise<UserTier[]> {\n    const result = await db.execute(sql`\n      SELECT \n        id,\n        region,\n        tier,\n        tier_type as \"tierType\",\n        subscription_cost as \"subscriptionCost\",\n        currency,\n        subscription_duration_months as \"subscriptionDurationMonths\",\n        streak_savers as \"streakSavers\",\n        holiday_savers as \"holidaySavers\",\n        holiday_duration_days as \"holidayDurationDays\",\n        created_at as \"createdAt\",\n        updated_at as \"updatedAt\",\n        active,\n        description,\n        sort_order as \"sortOrder\"\n      FROM user_tier\n      WHERE region = ${region}\n        AND active = true\n        AND tier != 'Standard'\n      ORDER BY sort_order ASC\n    `);\n    \n    const rows = Array.isArray(result) ? result : (result as any).rows || [];\n    return rows as UserTier[];\n  }\n\n  // Get the Standard tier ID for a region\n  async getStandardTierId(region: string): Promise<string | null> {\n    // Use ILIKE for case-insensitive matching (database stores 'standard' lowercase)\n    // Note: We don't filter on active here - the active field is for purchasable tiers shown in upgrade menus,\n    // not for whether the Standard tier should be assigned to new users\n    const result = await db.execute(sql`\n      SELECT id \n      FROM user_tier \n      WHERE LOWER(tier) = 'standard' \n        AND region = ${region}\n      LIMIT 1\n    `);\n    \n    const rows = Array.isArray(result) ? result : (result as any).rows || [];\n    if (!rows || rows.length === 0) {\n      console.log(`[getStandardTierId] No Standard tier found for region: ${region}`);\n      return null;\n    }\n    console.log(`[getStandardTierId] Found Standard tier ID: ${rows[0].id} for region: ${region}`);\n    return rows[0].id;\n  }\n\n  // Create default Standard subscription on signup\n  async createDefaultSubscription(userId: string, region: string): Promise<void> {\n    const standardTierId = await this.getStandardTierId(region);\n    if (!standardTierId) {\n      console.error(`[createDefaultSubscription] No Standard tier found for region: ${region}`);\n      return;\n    }\n    \n    await db.execute(sql`\n      INSERT INTO user_subscriptions (\n        user_id,\n        amount_paid,\n        currency,\n        expires_at,\n        source,\n        user_tier_id,\n        auto_renew,\n        effective_start_at\n      )\n      VALUES (\n        ${userId},\n        0.00,\n        'GBP',\n        NULL,\n        'signup',\n        ${standardTierId},\n        false,\n        NOW()\n      )\n    `);\n    \n    console.log(`[createDefaultSubscription] Created default subscription for user ${userId} with tier ${standardTierId}`);\n  }\n\n  // Downgrade user to Standard tier\n  async downgradeToStandard(userId: string, region: string): Promise<void> {\n    const standardTierId = await this.getStandardTierId(region);\n    if (!standardTierId) {\n      throw new Error(`No Standard tier found for region: ${region}`);\n    }\n    \n    // Update user_profiles to point to Standard tier with null end date\n    await db.execute(sql`\n      UPDATE user_profiles\n      SET \n        user_tier_id = ${standardTierId},\n        subscription_end_date = NULL,\n        updated_at = NOW()\n      WHERE id = ${userId}\n    `);\n    \n    // Insert audit record into user_subscriptions\n    await db.execute(sql`\n      INSERT INTO user_subscriptions (\n        user_id,\n        amount_paid,\n        currency,\n        expires_at,\n        source,\n        user_tier_id,\n        auto_renew,\n        effective_start_at\n      )\n      VALUES (\n        ${userId},\n        0.00,\n        'GBP',\n        NULL,\n        'downgrade',\n        ${standardTierId},\n        false,\n        NOW()\n      )\n    `);\n    \n    console.log(`[downgradeToStandard] Downgraded user ${userId} to Standard tier`);\n  }\n\n  // Update auto-renew setting on most recent subscription\n  async updateAutoRenew(userId: string, autoRenew: boolean): Promise<void> {\n    // Update the most recent subscription record for this user\n    await db.execute(sql`\n      UPDATE user_subscriptions\n      SET auto_renew = ${autoRenew}\n      WHERE id = (\n        SELECT id FROM user_subscriptions\n        WHERE user_id = ${userId}\n        ORDER BY created_at DESC\n        LIMIT 1\n      )\n    `);\n    \n    console.log(`[updateAutoRenew] Updated auto_renew to ${autoRenew} for user ${userId}`);\n  }\n\n  async createUserSubscription(subscription: { \n    userId: string; \n    userTierId: string; \n    amountPaid?: number; \n    currency?: string; \n    expiresAt?: Date; \n    autoRenew?: boolean; \n    source?: string;\n  }): Promise<void> {\n    // Insert new subscription - let database auto-generate the ID\n    // Note: Don't include 'validity' column - database uses tstzrange type as GENERATED ALWAYS\n    // Convert Date to ISO string for SQL compatibility\n    const expiresAtStr = subscription.expiresAt ? subscription.expiresAt.toISOString() : null;\n    // Format amount_paid as decimal string for numeric(10,2) column\n    const amountPaidStr = subscription.amountPaid !== undefined ? subscription.amountPaid.toFixed(2) : null;\n    \n    await db.execute(sql`\n      INSERT INTO user_subscriptions (\n        user_id, user_tier_id, amount_paid, currency, expires_at, auto_renew, source, effective_start_at\n      )\n      VALUES (\n        ${subscription.userId},\n        ${subscription.userTierId},\n        ${amountPaidStr},\n        ${subscription.currency || 'GBP'},\n        ${expiresAtStr},\n        ${subscription.autoRenew !== false},\n        ${subscription.source || 'web'},\n        NOW()\n      )\n    `);\n    \n    // Also update user_profiles directly to ensure sync (backup for Supabase trigger)\n    // This matches the approach used in downgradeToStandard for consistency\n    await db.execute(sql`\n      UPDATE user_profiles\n      SET \n        user_tier_id = ${subscription.userTierId},\n        subscription_end_date = ${expiresAtStr},\n        updated_at = NOW()\n      WHERE id = ${subscription.userId}\n    `);\n    \n    console.log(`[createUserSubscription] Created subscription for user ${subscription.userId} with tier ${subscription.userTierId}, expires: ${expiresAtStr}`);\n  }\n\n  // Puzzle operations\n  async getPuzzle(id: number): Promise<Puzzle | undefined> {\n    const [puzzle] = await db.select().from(puzzles).where(eq(puzzles.id, id));\n    return puzzle;\n  }\n\n  async getPuzzleByDate(date: string): Promise<Puzzle | undefined> {\n    const [puzzle] = await db.select().from(puzzles).where(eq(puzzles.date, date));\n    return puzzle;\n  }\n\n  async getAllPuzzles(): Promise<Puzzle[]> {\n    return await db.select().from(puzzles).orderBy(puzzles.date);\n  }\n\n  async getPuzzlesSince(date: string): Promise<Puzzle[]> {\n    return await db\n      .select()\n      .from(puzzles)\n      .where(gte(puzzles.date, date))\n      .orderBy(puzzles.date);\n  }\n\n  async createPuzzle(puzzleData: InsertPuzzle): Promise<Puzzle> {\n    const [puzzle] = await db.insert(puzzles).values(puzzleData).returning();\n    return puzzle;\n  }\n\n  // User settings operations\n  async getUserSettings(userId: string): Promise<UserSettings | undefined> {\n    const [settings] = await db\n      .select()\n      .from(userSettings)\n      .where(eq(userSettings.userId, userId));\n    return settings;\n  }\n\n  async upsertUserSettings(settingsData: InsertUserSettings): Promise<UserSettings> {\n    // Check if settings exist for this user\n    const existing = await this.getUserSettings(settingsData.userId);\n    \n    if (existing) {\n      // Update existing settings\n      const [settings] = await db\n        .update(userSettings)\n        .set({\n          ...settingsData,\n          updatedAt: new Date(),\n        })\n        .where(eq(userSettings.userId, settingsData.userId))\n        .returning();\n      return settings;\n    } else {\n      // Insert new settings\n      const [settings] = await db\n        .insert(userSettings)\n        .values(settingsData)\n        .returning();\n      return settings;\n    }\n  }\n\n  // Game attempt operations\n  async getGameAttempt(id: number): Promise<GameAttempt | undefined> {\n    const [attempt] = await db.select().from(gameAttempts).where(eq(gameAttempts.id, id));\n    return attempt;\n  }\n\n  async getGameAttemptsByUser(userId: string): Promise<GameAttempt[]> {\n    return await db\n      .select()\n      .from(gameAttempts)\n      .where(eq(gameAttempts.userId, userId))\n      .orderBy(desc(gameAttempts.completedAt));\n  }\n\n  async getGameAttemptByUserAndPuzzle(\n    userId: string | null,\n    puzzleId: number\n  ): Promise<GameAttempt | undefined> {\n    if (userId) {\n      const [attempt] = await db\n        .select()\n        .from(gameAttempts)\n        .where(\n          and(\n            eq(gameAttempts.userId, userId),\n            eq(gameAttempts.puzzleId, puzzleId)\n          )\n        );\n      return attempt;\n    } else {\n      const [attempt] = await db\n        .select()\n        .from(gameAttempts)\n        .where(eq(gameAttempts.puzzleId, puzzleId));\n      return attempt;\n    }\n  }\n\n  async createGameAttempt(attemptData: InsertGameAttempt): Promise<GameAttempt> {\n    const [attempt] = await db.insert(gameAttempts).values(attemptData).returning();\n    return attempt;\n  }\n\n  async upsertGameAttempt(attemptData: InsertGameAttempt): Promise<GameAttempt> {\n    const [attempt] = await db\n      .insert(gameAttempts)\n      .values(attemptData)\n      .onConflictDoUpdate({\n        target: [gameAttempts.userId, gameAttempts.puzzleId], // unique constraint\n        set: {\n          result: attemptData.result,\n          numGuesses: attemptData.numGuesses,\n        },\n      })\n      .returning();\n\n    return attempt;\n  }\n\n  async getOpenAttemptByUserAndPuzzle(userId: string, puzzleId: number): Promise<GameAttempt | undefined> {\n    const [attempt] = await db\n      .select()\n      .from(gameAttempts)\n      .where(\n        and(\n          eq(gameAttempts.userId, userId),\n          eq(gameAttempts.puzzleId, puzzleId),\n          isNull(gameAttempts.result) // still in progress\n        )\n      );\n    return attempt;\n  }\n\n  async incrementAttemptGuesses(gameAttemptId: number): Promise<void> {\n    // Fetch current value\n    const [current] = await db\n      .select({ numGuesses: gameAttempts.numGuesses })\n      .from(gameAttempts)\n      .where(eq(gameAttempts.id, gameAttemptId));\n\n    const next = (current?.numGuesses ?? 0) + 1;\n\n    await db\n      .update(gameAttempts)\n      .set({ numGuesses: next })\n      .where(eq(gameAttempts.id, gameAttemptId));\n  }\n\n  async updateGameAttempt(\n    id: number,\n    updateData: Partial<Omit<GameAttempt, 'id' | 'userId' | 'puzzleId' | 'startedAt'>>\n  ): Promise<GameAttempt> {\n    // Fetch current attempt to enforce numGuesses monotonicity\n    const [current] = await db.select().from(gameAttempts).where(eq(gameAttempts.id, id));\n\n    let safeUpdate = { ...updateData } as any;\n\n    // Ensure numGuesses never decreases\n    if (typeof safeUpdate.numGuesses === \"number\" && current) {\n      safeUpdate.numGuesses = Math.max(safeUpdate.numGuesses, current.numGuesses ?? 0);\n    }\n\n    // If result is being set, mark completedAt\n    if (safeUpdate.result && !current?.completedAt) {\n      safeUpdate.completedAt = new Date();\n    }\n\n    const [attempt] = await db\n      .update(gameAttempts)\n      .set(safeUpdate)\n      .where(eq(gameAttempts.id, id))\n      .returning();\n\n    return attempt;\n  }\n\n\n  // Guess operations\n  async getGuessesByGameAttempt(gameAttemptId: number): Promise<Guess[]> {\n    return await db\n      .select()\n      .from(guesses)\n      .where(eq(guesses.gameAttemptId, gameAttemptId))\n      .orderBy(guesses.guessedAt);\n  }\n\n  async createGuess(guessData: InsertGuess): Promise<Guess> {\n    const [guess] = await db.insert(guesses).values(guessData).returning();\n    return guess;\n  }\n\n  async getRecentGuessesWithPuzzleIds(userId: string, since: string): Promise<Array<Guess & { puzzleId: number }>> {\n    // Join guesses with game_attempts to get puzzle IDs\n    // Only return guesses for completed game attempts from the last N days\n    const results = await db\n      .select({\n        id: guesses.id,\n        gameAttemptId: guesses.gameAttemptId,\n        guessValue: guesses.guessValue,\n        guessedAt: guesses.guessedAt,\n        puzzleId: gameAttempts.puzzleId,\n      })\n      .from(guesses)\n      .innerJoin(gameAttempts, eq(guesses.gameAttemptId, gameAttempts.id))\n      .innerJoin(puzzles, eq(gameAttempts.puzzleId, puzzles.id))\n      .where(\n        and(\n          eq(gameAttempts.userId, userId),\n          gte(puzzles.date, since)\n        )\n      )\n      .orderBy(guesses.guessedAt);\n\n    return results;\n  }\n  \n  async getAllGuessesWithPuzzleIds(userId: string): Promise<Array<Guess & { puzzleId: number; result: string | null; categoryName?: string | null }>> {\n    const results = await db\n      .select({\n        id: guesses.id,\n        gameAttemptId: guesses.gameAttemptId,\n        guessValue: guesses.guessValue,\n        guessedAt: guesses.guessedAt,\n        puzzleId: gameAttempts.puzzleId,\n        result: gameAttempts.result,\n        categoryName: categories.name,   // <-- join category name\n      })\n      .from(guesses)\n      .innerJoin(gameAttempts, eq(guesses.gameAttemptId, gameAttempts.id))\n      .leftJoin(categories, eq(gameAttempts.categoryId, categories.id)) // safe for NULL\n      .where(eq(gameAttempts.userId, userId))\n      .orderBy(guesses.guessedAt);\n\n    return results;\n  }\n\n  // User stats operations\n  async getUserStats(userId: string): Promise<UserStats | undefined> {\n    const [stats] = await db.select().from(userStats).where(eq(userStats.userId, userId));\n    return stats;\n  }\n\n  async upsertUserStats(statsData: InsertUserStats): Promise<UserStats> {\n    const [stats] = await db\n      .insert(userStats)\n      .values(statsData)\n      .onConflictDoUpdate({\n        target: [userStats.userId],\n        set: {\n          ...statsData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return stats;\n  }\n\n  async recalculateUserStats(userId: string): Promise<UserStats> {\n    // Get all completed game attempts for this user (result !== null means completed)\n    const completedAttempts = await db\n      .select({\n        id: gameAttempts.id,\n        result: gameAttempts.result,\n        numGuesses: gameAttempts.numGuesses,\n        completedAt: gameAttempts.completedAt,\n        puzzleId: gameAttempts.puzzleId,\n        puzzleDate: puzzles.date,\n      })\n      .from(gameAttempts)\n      .innerJoin(puzzles, eq(gameAttempts.puzzleId, puzzles.id))\n      .where(\n        and(\n          eq(gameAttempts.userId, userId),\n          eq(gameAttempts.result, 'won') // Only count completed won games\n        )\n      )\n      .orderBy(puzzles.date);\n\n    // Also get lost games\n    const lostAttempts = await db\n      .select({\n        id: gameAttempts.id,\n        result: gameAttempts.result,\n        puzzleDate: puzzles.date,\n        completedAt: gameAttempts.completedAt,\n      })\n      .from(gameAttempts)\n      .innerJoin(puzzles, eq(gameAttempts.puzzleId, puzzles.id))\n      .where(\n        and(\n          eq(gameAttempts.userId, userId),\n          eq(gameAttempts.result, 'lost')\n        )\n      );\n\n    const gamesPlayed = completedAttempts.length + lostAttempts.length;\n    const gamesWon = completedAttempts.length;\n\n    // Calculate guess distribution (only for won games)\n    const guessDistribution: any = { \"1\": 0, \"2\": 0, \"3\": 0, \"4\": 0, \"5\": 0 };\n    for (const attempt of completedAttempts) {\n      const numGuesses = attempt.numGuesses || 0;\n      if (numGuesses >= 1 && numGuesses <= 5) {\n        guessDistribution[numGuesses.toString()] = (guessDistribution[numGuesses.toString()] || 0) + 1;\n      }\n    }\n\n    // Calculate current streak - check consecutive days ending at or before today\n    // IMPORTANT: Only count puzzles played on their actual date (not archive puzzles played later)\n    const allCompletedAttempts = [...completedAttempts, ...lostAttempts].sort((a, b) => \n      new Date(b.puzzleDate).getTime() - new Date(a.puzzleDate).getTime()\n    );\n\n    let currentStreak = 0;\n    let maxStreak = 0;\n    let tempStreak = 0;\n    \n    // Build map of dates to results, filtering for puzzles played on their actual day\n    const dateMap = new Map<string, string>();\n    for (const attempt of allCompletedAttempts) {\n      // Only count if puzzle was completed on the same day as its puzzle date\n      const completedDate = new Date(attempt.completedAt || '');\n      const puzzleDate = new Date(attempt.puzzleDate);\n      \n      // Normalize both dates to midnight for comparison\n      completedDate.setHours(0, 0, 0, 0);\n      puzzleDate.setHours(0, 0, 0, 0);\n      \n      // Only add to map if completed on the correct day (archive puzzles don't count)\n      if (completedDate.getTime() === puzzleDate.getTime()) {\n        dateMap.set(attempt.puzzleDate, attempt.result || '');\n      }\n    }\n\n    // Calculate current streak from today backwards\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    let checkDate = new Date(today);\n    \n    // Check if user played yesterday's puzzle - if not, streak is broken\n    const yesterday = new Date(today);\n    yesterday.setDate(yesterday.getDate() - 1);\n    const yesterdayStr = yesterday.toISOString().split('T')[0];\n    \n    // If today's puzzle isn't played yet, start checking from yesterday\n    const todayStr = today.toISOString().split('T')[0];\n    if (!dateMap.has(todayStr)) {\n      checkDate = new Date(yesterday);\n    }\n    \n    while (true) {\n      const dateStr = checkDate.toISOString().split('T')[0];\n      const result = dateMap.get(dateStr);\n      \n      if (!result) break; // No game played this day - streak broken\n      if (result === 'won') {\n        currentStreak++;\n      } else {\n        break; // Streak broken by a loss\n      }\n      \n      // Move back one day\n      checkDate.setDate(checkDate.getDate() - 1);\n    }\n\n    // Calculate max streak by going through all dates\n    const sortedDates = Array.from(dateMap.keys()).sort();\n    for (let i = 0; i < sortedDates.length; i++) {\n      const result = dateMap.get(sortedDates[i]);\n      if (result === 'won') {\n        tempStreak++;\n        maxStreak = Math.max(maxStreak, tempStreak);\n      } else {\n        tempStreak = 0;\n      }\n    }\n\n    // Upsert the calculated stats\n    return await this.upsertUserStats({\n      userId,\n      gamesPlayed,\n      gamesWon,\n      currentStreak,\n      maxStreak,\n      guessDistribution,\n    });\n  }\n\n  async getUserPercentileRanking(userId: string): Promise<number> {\n    // Get all users with their stats, ordered by games won (descending)\n    const allUserStats = await db\n      .select({\n        userId: userStats.userId,\n        gamesWon: userStats.gamesWon,\n      })\n      .from(userStats)\n      .orderBy(desc(userStats.gamesWon));\n\n    if (allUserStats.length === 0) {\n      return 100; // If no stats, user is in top 100%\n    }\n\n    // Find user's position (1-based)\n    const userPosition = allUserStats.findIndex(stat => stat.userId === userId);\n    \n    if (userPosition === -1) {\n      // User not found in rankings\n      return 100;\n    }\n\n    // Calculate percentile: (position / total) * 100\n    // Position is 0-based, so add 1 for 1-based ranking\n    const percentile = ((userPosition + 1) / allUserStats.length) * 100;\n    \n    // Round to 1 decimal place\n    return Math.round(percentile * 10) / 10;\n  }\n\n  // Admin export operations\n  async getAllGameAttemptsForExport(): Promise<any[]> {\n    return await db\n      .select({\n        userId: gameAttempts.userId,\n        puzzleId: gameAttempts.puzzleId,\n        result: gameAttempts.result,\n        numGuesses: gameAttempts.numGuesses,\n        completedAt: gameAttempts.completedAt,\n      })\n      .from(gameAttempts)\n      .orderBy(desc(gameAttempts.completedAt));\n  }\n\n  // Admin settings operations\n  async getAdminSettings(): Promise<AdminSetting[]> {\n    return await db\n      .select()\n      .from(adminSettings)\n      .orderBy(adminSettings.key);\n  }\n\n  async getAdminSetting(key: string): Promise<AdminSetting | undefined> {\n    const [setting] = await db\n      .select()\n      .from(adminSettings)\n      .where(eq(adminSettings.key, key));\n    return setting;\n  }\n\n  async upsertAdminSetting(setting: InsertAdminSetting): Promise<AdminSetting> {\n    const existing = await this.getAdminSetting(setting.key);\n    \n    if (existing) {\n      const [updated] = await db\n        .update(adminSettings)\n        .set({\n          value: setting.value,\n          description: setting.description,\n          updatedAt: new Date(),\n          updatedBy: setting.updatedBy,\n        })\n        .where(eq(adminSettings.key, setting.key))\n        .returning();\n      return updated;\n    } else {\n      const [created] = await db\n        .insert(adminSettings)\n        .values({\n          key: setting.key,\n          value: setting.value,\n          description: setting.description,\n          updatedBy: setting.updatedBy,\n        })\n        .returning();\n      return created;\n    }\n  }\n\n  // Demand scheduler config operations (uses raw SQL as table is in Supabase)\n  // Uses singleton pattern - only ONE row should exist with fixed ID\n  async getDemandSchedulerConfig(): Promise<DemandSchedulerConfig | undefined> {\n    const result = await db.execute(sql`\n      SELECT id, start_time, frequency_hours, updated_at, updated_by\n      FROM demand_scheduler_config\n      ORDER BY updated_at DESC\n      LIMIT 1\n    `);\n    \n    // Handle different result formats from drizzle execute\n    const rows = Array.isArray(result) ? result : (result as any).rows || [];\n    \n    if (!rows || rows.length === 0) {\n      return undefined;\n    }\n    \n    const row = rows[0];\n    return {\n      id: row.id,\n      start_time: row.start_time,\n      frequency_hours: row.frequency_hours,\n      updated_at: row.updated_at?.toISOString?.() || row.updated_at,\n      updated_by: row.updated_by,\n    };\n  }\n\n  async upsertDemandSchedulerConfig(config: InsertDemandSchedulerConfig & { updated_by?: string }): Promise<DemandSchedulerConfig> {\n    // Use a singleton pattern with a fixed ID to ensure only ONE row ever exists\n    const SINGLETON_ID = '00000000-0000-0000-0000-000000000001';\n    \n    // Use INSERT ... ON CONFLICT to ensure atomic upsert with single row\n    await db.execute(sql`\n      INSERT INTO demand_scheduler_config (id, start_time, frequency_hours, updated_at, updated_by)\n      VALUES (${SINGLETON_ID}, ${config.start_time}, ${config.frequency_hours}, NOW(), ${config.updated_by || null})\n      ON CONFLICT (id) DO UPDATE SET\n        start_time = EXCLUDED.start_time,\n        frequency_hours = EXCLUDED.frequency_hours,\n        updated_at = NOW(),\n        updated_by = EXCLUDED.updated_by\n    `);\n    \n    // Fetch and return the updated config\n    const result = await this.getDemandSchedulerConfig();\n    if (!result) {\n      throw new Error('Failed to upsert demand scheduler config');\n    }\n    return result;\n  }\n\n  // ========================================================================\n  // REGION GAME MODE OPERATIONS\n  // ========================================================================\n\n  // Question master operations (region)\n  async getQuestionMasterRegion(id: number): Promise<QuestionMasterRegion | undefined> {\n    const [question] = await db\n      .select()\n      .from(questionsMasterRegion)\n      .where(eq(questionsMasterRegion.id, id));\n    return question;\n  }\n\n  async createQuestionMasterRegion(questionData: InsertQuestionMasterRegion): Promise<QuestionMasterRegion> {\n    const [question] = await db\n      .insert(questionsMasterRegion)\n      .values(questionData)\n      .returning();\n    return question;\n  }\n\n  // Question allocated operations (region)\n  async getAllocatedQuestionByRegionAndDate(\n    region: string,\n    date: string\n  ): Promise<AllocatedQuestionWithMaster | undefined> {\n    const results = await db\n      .select({\n        id: questionsAllocatedRegion.id,\n        questionId: questionsAllocatedRegion.questionId,\n        region: questionsAllocatedRegion.region,\n        puzzleDate: questionsAllocatedRegion.puzzleDate,\n        masterQuestion_id: questionsMasterRegion.id,\n        masterQuestion_answerDateCanonical: questionsMasterRegion.answerDateCanonical,\n        masterQuestion_eventTitle: questionsMasterRegion.eventTitle,\n        masterQuestion_eventDescription: questionsMasterRegion.eventDescription,\n        masterQuestion_regions: questionsMasterRegion.regions,\n        masterQuestion_categories: questionsMasterRegion.categories,\n        masterQuestion_createdAt: questionsMasterRegion.createdAt,\n      })\n      .from(questionsAllocatedRegion)\n      .innerJoin(\n        questionsMasterRegion,\n        eq(questionsAllocatedRegion.questionId, questionsMasterRegion.id)\n      )\n      .where(\n        and(\n          eq(questionsAllocatedRegion.region, region),\n          eq(questionsAllocatedRegion.puzzleDate, date)\n        )\n      );\n\n    if (results.length === 0) return undefined;\n\n    const result = results[0];\n    return {\n      id: result.id,\n      questionId: result.questionId,\n      region: result.region,\n      puzzleDate: result.puzzleDate,\n      masterQuestion: {\n        id: result.masterQuestion_id,\n        answerDateCanonical: result.masterQuestion_answerDateCanonical,\n        eventTitle: result.masterQuestion_eventTitle,\n        eventDescription: result.masterQuestion_eventDescription,\n        regions: result.masterQuestion_regions,\n        categories: result.masterQuestion_categories,\n        createdAt: result.masterQuestion_createdAt,\n      },\n    };\n  }\n\n  async getAllocatedQuestionsByRegion(region: string): Promise<AllocatedQuestionWithMaster[]> {\n    const results = await db\n      .select({\n        id: questionsAllocatedRegion.id,\n        questionId: questionsAllocatedRegion.questionId,\n        region: questionsAllocatedRegion.region,\n        puzzleDate: questionsAllocatedRegion.puzzleDate,\n        masterQuestion_id: questionsMasterRegion.id,\n        masterQuestion_answerDateCanonical: questionsMasterRegion.answerDateCanonical,\n        masterQuestion_eventTitle: questionsMasterRegion.eventTitle,\n        masterQuestion_eventDescription: questionsMasterRegion.eventDescription,\n        masterQuestion_regions: questionsMasterRegion.regions,\n        masterQuestion_categories: questionsMasterRegion.categories,\n        masterQuestion_createdAt: questionsMasterRegion.createdAt,\n      })\n      .from(questionsAllocatedRegion)\n      .innerJoin(\n        questionsMasterRegion,\n        eq(questionsAllocatedRegion.questionId, questionsMasterRegion.id)\n      )\n      .where(eq(questionsAllocatedRegion.region, region))\n      .orderBy(questionsAllocatedRegion.puzzleDate);\n\n    return results.map(result => ({\n      id: result.id,\n      questionId: result.questionId,\n      region: result.region,\n      puzzleDate: result.puzzleDate,\n      masterQuestion: {\n        id: result.masterQuestion_id,\n        answerDateCanonical: result.masterQuestion_answerDateCanonical,\n        eventTitle: result.masterQuestion_eventTitle,\n        eventDescription: result.masterQuestion_eventDescription,\n        regions: result.masterQuestion_regions,\n        categories: result.masterQuestion_categories,\n        createdAt: result.masterQuestion_createdAt,\n      },\n    }));\n  }\n\n  async getAllocatedQuestionsSinceByRegion(\n    region: string,\n    since: string\n  ): Promise<AllocatedQuestionWithMaster[]> {\n    const results = await db\n      .select({\n        id: questionsAllocatedRegion.id,\n        questionId: questionsAllocatedRegion.questionId,\n        region: questionsAllocatedRegion.region,\n        puzzleDate: questionsAllocatedRegion.puzzleDate,\n        masterQuestion_id: questionsMasterRegion.id,\n        masterQuestion_answerDateCanonical: questionsMasterRegion.answerDateCanonical,\n        masterQuestion_eventTitle: questionsMasterRegion.eventTitle,\n        masterQuestion_eventDescription: questionsMasterRegion.eventDescription,\n        masterQuestion_regions: questionsMasterRegion.regions,\n        masterQuestion_categories: questionsMasterRegion.categories,\n        masterQuestion_createdAt: questionsMasterRegion.createdAt,\n      })\n      .from(questionsAllocatedRegion)\n      .innerJoin(\n        questionsMasterRegion,\n        eq(questionsAllocatedRegion.questionId, questionsMasterRegion.id)\n      )\n      .where(\n        and(\n          eq(questionsAllocatedRegion.region, region),\n          gte(questionsAllocatedRegion.puzzleDate, since)\n        )\n      )\n      .orderBy(questionsAllocatedRegion.puzzleDate);\n\n    return results.map(result => ({\n      id: result.id,\n      questionId: result.questionId,\n      region: result.region,\n      puzzleDate: result.puzzleDate,\n      masterQuestion: {\n        id: result.masterQuestion_id,\n        answerDateCanonical: result.masterQuestion_answerDateCanonical,\n        eventTitle: result.masterQuestion_eventTitle,\n        eventDescription: result.masterQuestion_eventDescription,\n        regions: result.masterQuestion_regions,\n        categories: result.masterQuestion_categories,\n        createdAt: result.masterQuestion_createdAt,\n      },\n    }));\n  }\n\n  async createQuestionAllocatedRegion(\n    allocationData: InsertQuestionAllocatedRegion\n  ): Promise<QuestionAllocatedRegion> {\n    const [allocation] = await db\n      .insert(questionsAllocatedRegion)\n      .values(allocationData)\n      .returning();\n    return allocation;\n  }\n\n  // Game attempt operations (region)\n  async getGameAttemptRegion(id: number): Promise<GameAttemptRegion | undefined> {\n    const [attempt] = await db\n      .select()\n      .from(gameAttemptsRegion)\n      .where(eq(gameAttemptsRegion.id, id));\n    return attempt;\n  }\n\n  async getGameAttemptRegionWithQuestion(\n    id: number\n  ): Promise<GameAttemptWithAllocatedQuestion | undefined> {\n    const results = await db\n      .select({\n        id: gameAttemptsRegion.id,\n        userId: gameAttemptsRegion.userId,\n        allocatedRegionId: gameAttemptsRegion.allocatedRegionId,\n        result: gameAttemptsRegion.result,\n        numGuesses: gameAttemptsRegion.numGuesses,\n        startedAt: gameAttemptsRegion.startedAt,\n        completedAt: gameAttemptsRegion.completedAt,\n        allocated_id: questionsAllocatedRegion.id,\n        allocated_questionId: questionsAllocatedRegion.questionId,\n        allocated_region: questionsAllocatedRegion.region,\n        allocated_puzzleDate: questionsAllocatedRegion.puzzleDate,\n        master_id: questionsMasterRegion.id,\n        master_answerDateCanonical: questionsMasterRegion.answerDateCanonical,\n        master_eventTitle: questionsMasterRegion.eventTitle,\n        master_eventDescription: questionsMasterRegion.eventDescription,\n        master_regions: questionsMasterRegion.regions,\n        master_categories: questionsMasterRegion.categories,\n        master_createdAt: questionsMasterRegion.createdAt,\n      })\n      .from(gameAttemptsRegion)\n      .innerJoin(\n        questionsAllocatedRegion,\n        eq(gameAttemptsRegion.allocatedRegionId, questionsAllocatedRegion.id)\n      )\n      .innerJoin(\n        questionsMasterRegion,\n        eq(questionsAllocatedRegion.questionId, questionsMasterRegion.id)\n      )\n      .where(eq(gameAttemptsRegion.id, id));\n\n    if (results.length === 0) return undefined;\n\n    const result = results[0];\n    return {\n      id: result.id,\n      userId: result.userId,\n      allocatedRegionId: result.allocatedRegionId,\n      result: result.result,\n      numGuesses: result.numGuesses,\n      startedAt: result.startedAt,\n      completedAt: result.completedAt,\n      allocatedQuestion: {\n        id: result.allocated_id,\n        masterQuestionId: result.allocated_questionId,\n        region: result.allocated_region,\n        allocatedDate: result.allocated_puzzleDate,\n        createdAt: result.allocated_createdAt,\n        masterQuestion: {\n          id: result.master_id,\n          answerDateCanonical: result.master_answerDateCanonical,\n          eventTitle: result.master_eventTitle,\n          eventDescription: result.master_eventDescription,\n          regions: result.master_clue1,\n          categories: result.master_clue2,\n          createdAt: result.master_createdAt,\n        },\n      },\n    };\n  }\n\n  async getGameAttemptsByUserRegion(userId: string): Promise<GameAttemptWithAllocatedQuestion[]> {\n    const results = await db\n      .select({\n        id: gameAttemptsRegion.id,\n        userId: gameAttemptsRegion.userId,\n        allocatedRegionId: gameAttemptsRegion.allocatedRegionId,\n        result: gameAttemptsRegion.result,\n        numGuesses: gameAttemptsRegion.numGuesses,\n        digits: gameAttemptsRegion.digits,\n        startedAt: gameAttemptsRegion.startedAt,\n        completedAt: gameAttemptsRegion.completedAt,\n        streakDayStatus: gameAttemptsRegion.streakDayStatus,\n        allocated_id: questionsAllocatedRegion.id,\n        allocated_questionId: questionsAllocatedRegion.questionId,\n        allocated_region: questionsAllocatedRegion.region,\n        allocated_puzzleDate: questionsAllocatedRegion.puzzleDate,\n        master_id: questionsMasterRegion.id,\n        master_answerDateCanonical: questionsMasterRegion.answerDateCanonical,\n        master_eventTitle: questionsMasterRegion.eventTitle,\n        master_eventDescription: questionsMasterRegion.eventDescription,\n        master_regions: questionsMasterRegion.regions,\n        master_categories: questionsMasterRegion.categories,\n        master_createdAt: questionsMasterRegion.createdAt,\n      })\n      .from(gameAttemptsRegion)\n      .innerJoin(\n        questionsAllocatedRegion,\n        eq(gameAttemptsRegion.allocatedRegionId, questionsAllocatedRegion.id)\n      )\n      .innerJoin(\n        questionsMasterRegion,\n        eq(questionsAllocatedRegion.questionId, questionsMasterRegion.id)\n      )\n      .where(eq(gameAttemptsRegion.userId, userId))\n      .orderBy(desc(questionsAllocatedRegion.puzzleDate));\n\n    return results.map(result => ({\n      id: result.id,\n      userId: result.userId,\n      allocatedRegionId: result.allocatedRegionId,\n      result: result.result,\n      numGuesses: result.numGuesses,\n      digits: result.digits,\n      startedAt: result.startedAt,\n      completedAt: result.completedAt,\n      streakDayStatus: result.streakDayStatus,\n      allocatedQuestion: {\n        id: result.allocated_id,\n        questionId: result.allocated_questionId,\n        region: result.allocated_region,\n        puzzleDate: result.allocated_puzzleDate,\n        masterQuestion: {\n          id: result.master_id,\n          answerDateCanonical: result.master_answerDateCanonical,\n          eventTitle: result.master_eventTitle,\n          eventDescription: result.master_eventDescription,\n          regions: result.master_regions,\n          categories: result.master_categories,\n          createdAt: result.master_createdAt,\n        },\n      },\n    }));\n  }\n\n  async getGameAttemptByUserAndAllocated(\n    userId: string | null,\n    allocatedRegionId: number\n  ): Promise<GameAttemptRegion | undefined> {\n    if (userId) {\n      const [attempt] = await db\n        .select()\n        .from(gameAttemptsRegion)\n        .where(\n          and(\n            eq(gameAttemptsRegion.userId, userId),\n            eq(gameAttemptsRegion.allocatedRegionId, allocatedRegionId)\n          )\n        );\n      return attempt;\n    } else {\n      const [attempt] = await db\n        .select()\n        .from(gameAttemptsRegion)\n        .where(eq(gameAttemptsRegion.allocatedRegionId, allocatedRegionId));\n      return attempt;\n    }\n  }\n\n  async createGameAttemptRegion(attemptData: InsertGameAttemptRegion): Promise<GameAttemptRegion> {\n    const [attempt] = await db\n      .insert(gameAttemptsRegion)\n      .values(attemptData)\n      .returning();\n    return attempt;\n  }\n\n  async updateGameAttemptRegion(\n    id: number,\n    updateData: Partial<Omit<GameAttemptRegion, 'id' | 'userId' | 'allocatedRegionId' | 'startedAt'>>\n  ): Promise<GameAttemptRegion> {\n    const [current] = await db\n      .select()\n      .from(gameAttemptsRegion)\n      .where(eq(gameAttemptsRegion.id, id));\n\n    let safeUpdate = { ...updateData } as any;\n\n    // Ensure numGuesses never decreases\n    if (typeof safeUpdate.numGuesses === \"number\" && current) {\n      safeUpdate.numGuesses = Math.max(safeUpdate.numGuesses, current.numGuesses ?? 0);\n    }\n\n    // If result is being set, mark completedAt\n    if (safeUpdate.result && !current?.completedAt) {\n      safeUpdate.completedAt = new Date();\n    }\n\n    const [attempt] = await db\n      .update(gameAttemptsRegion)\n      .set(safeUpdate)\n      .where(eq(gameAttemptsRegion.id, id))\n      .returning();\n\n    return attempt;\n  }\n\n  async incrementAttemptGuessesRegion(gameAttemptId: number): Promise<void> {\n    const [current] = await db\n      .select({ numGuesses: gameAttemptsRegion.numGuesses })\n      .from(gameAttemptsRegion)\n      .where(eq(gameAttemptsRegion.id, gameAttemptId));\n\n    const next = (current?.numGuesses ?? 0) + 1;\n\n    await db\n      .update(gameAttemptsRegion)\n      .set({ numGuesses: next })\n      .where(eq(gameAttemptsRegion.id, gameAttemptId));\n  }\n\n  // Guess operations (region)\n  async getGuessesByGameAttemptRegion(gameAttemptId: number): Promise<GuessRegion[]> {\n    return await db\n      .select()\n      .from(guessesRegion)\n      .where(eq(guessesRegion.gameAttemptId, gameAttemptId))\n      .orderBy(guessesRegion.guessedAt);\n  }\n\n  async createGuessRegion(guessData: InsertGuessRegion): Promise<GuessRegion> {\n    const [guess] = await db.insert(guessesRegion).values(guessData).returning();\n    return guess;\n  }\n\n  async getRecentGuessesWithAllocatedIdsRegion(\n    userId: string,\n    since: string\n  ): Promise<Array<GuessRegion & { allocatedRegionId: number }>> {\n    const results = await db\n      .select({\n        id: guessesRegion.id,\n        gameAttemptId: guessesRegion.gameAttemptId,\n        guessValue: guessesRegion.guessValue,\n        guessedAt: guessesRegion.guessedAt,\n        allocatedRegionId: gameAttemptsRegion.allocatedRegionId,\n      })\n      .from(guessesRegion)\n      .innerJoin(\n        gameAttemptsRegion,\n        eq(guessesRegion.gameAttemptId, gameAttemptsRegion.id)\n      )\n      .innerJoin(\n        questionsAllocatedRegion,\n        eq(gameAttemptsRegion.allocatedRegionId, questionsAllocatedRegion.id)\n      )\n      .where(\n        and(\n          eq(gameAttemptsRegion.userId, userId),\n          gte(questionsAllocatedRegion.puzzleDate, since)\n        )\n      )\n      .orderBy(guessesRegion.guessedAt);\n\n    return results;\n  }\n\n  async getAllGuessesWithAllocatedIdsRegion(\n    userId: string\n  ): Promise<Array<GuessRegion & { allocatedRegionId: number; result: string | null }>> {\n    const results = await db\n      .select({\n        id: guessesRegion.id,\n        gameAttemptId: guessesRegion.gameAttemptId,\n        guessValue: guessesRegion.guessValue,\n        guessedAt: guessesRegion.guessedAt,\n        allocatedRegionId: gameAttemptsRegion.allocatedRegionId,\n        result: gameAttemptsRegion.result,\n      })\n      .from(guessesRegion)\n      .innerJoin(\n        gameAttemptsRegion,\n        eq(guessesRegion.gameAttemptId, gameAttemptsRegion.id)\n      )\n      .where(eq(gameAttemptsRegion.userId, userId))\n      .orderBy(guessesRegion.guessedAt);\n\n    return results;\n  }\n\n  // User stats operations (region)\n  // Now filters by both userId AND region to support per-region stats\n  async getUserStatsRegion(userId: string, region?: string): Promise<UserStatsRegion | undefined> {\n    // If region is provided, filter by both userId and region\n    if (region) {\n      const [stats] = await db\n        .select()\n        .from(userStatsRegion)\n        .where(and(\n          eq(userStatsRegion.userId, userId),\n          eq(userStatsRegion.region, region)\n        ));\n      return stats;\n    }\n    \n    // Legacy: if no region provided, get user's current region from profile\n    const profile = await this.getUserProfile(userId);\n    const userRegion = profile?.region || \"UK\";\n    \n    const [stats] = await db\n      .select()\n      .from(userStatsRegion)\n      .where(and(\n        eq(userStatsRegion.userId, userId),\n        eq(userStatsRegion.region, userRegion)\n      ));\n    return stats;\n  }\n\n  async upsertUserStatsRegion(statsData: InsertUserStatsRegion): Promise<UserStatsRegion> {\n    // Ensure region is set - required for the composite unique constraint\n    const region = statsData.region || \"UK\";\n    const dataWithRegion = { ...statsData, region };\n    \n    const [stats] = await db\n      .insert(userStatsRegion)\n      .values(dataWithRegion)\n      .onConflictDoUpdate({\n        target: [userStatsRegion.userId, userStatsRegion.region],\n        set: {\n          ...dataWithRegion,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return stats;\n  }\n\n  async recalculateUserStatsRegion(userId: string, region?: string): Promise<UserStatsRegion> {\n    // Get user's current region if not provided\n    let targetRegion = region;\n    if (!targetRegion) {\n      const profile = await this.getUserProfile(userId);\n      targetRegion = profile?.region || \"UK\";\n    }\n    \n    // Get ALL game attempts for this user in this region in ONE query\n    // This ensures we capture all attempts regardless of result value\n    const allAttempts = await db\n      .select({\n        id: gameAttemptsRegion.id,\n        result: gameAttemptsRegion.result,\n        numGuesses: gameAttemptsRegion.numGuesses,\n        completedAt: gameAttemptsRegion.completedAt,\n        puzzleDate: questionsAllocatedRegion.puzzleDate,\n        streakDayStatus: gameAttemptsRegion.streakDayStatus,\n      })\n      .from(gameAttemptsRegion)\n      .innerJoin(\n        questionsAllocatedRegion,\n        eq(gameAttemptsRegion.allocatedRegionId, questionsAllocatedRegion.id)\n      )\n      .where(\n        and(\n          eq(gameAttemptsRegion.userId, userId),\n          eq(questionsAllocatedRegion.region, targetRegion)\n        )\n      )\n      .orderBy(questionsAllocatedRegion.puzzleDate);\n\n    // Categorize attempts by result for counting\n    const completedAttempts = allAttempts.filter(a => a.result === 'won');\n    const lostAttempts = allAttempts.filter(a => a.result === 'lost');\n\n    const gamesPlayed = completedAttempts.length + lostAttempts.length;\n    const gamesWon = completedAttempts.length;\n\n    // Calculate guess distribution (only for won games)\n    const guessDistribution: any = { \"1\": 0, \"2\": 0, \"3\": 0, \"4\": 0, \"5\": 0 };\n    for (const attempt of completedAttempts) {\n      const numGuesses = attempt.numGuesses || 0;\n      if (numGuesses >= 1 && numGuesses <= 5) {\n        guessDistribution[numGuesses.toString()] = (guessDistribution[numGuesses.toString()] || 0) + 1;\n      }\n    }\n\n    // Calculate current streak using streak_day_status\n    // streak_day_status: 0 = holiday (maintains continuity), 1 = played (increments), NULL = missed (breaks)\n    // Sort allAttempts by date descending for streak calculation\n    const sortedAttempts = [...allAttempts].sort((a, b) => \n      new Date(b.puzzleDate).getTime() - new Date(a.puzzleDate).getTime()\n    );\n\n    let currentStreak = 0;\n    let maxStreak = 0;\n    let tempStreak = 0;\n    \n    // Build a map of dates to { result, streakDayStatus } from ALL attempts\n    const dateMap = new Map<string, { result: string | null; streakDayStatus: number | null }>();\n    for (const attempt of sortedAttempts) {\n      // Always include attempts with valid streakDayStatus (0 for holiday, 1 for played)\n      // Don't filter by completedAt date - this broke streaks for late-night players\n      if (attempt.streakDayStatus !== null && attempt.streakDayStatus !== undefined) {\n        dateMap.set(attempt.puzzleDate, { \n          result: attempt.result, \n          streakDayStatus: attempt.streakDayStatus \n        });\n      } else if (attempt.result !== null) {\n        // Game was completed but streakDayStatus not set (legacy data)\n        // Include with NULL to properly break streak chain\n        dateMap.set(attempt.puzzleDate, { \n          result: attempt.result, \n          streakDayStatus: null \n        });\n      }\n    }\n    \n    // DEBUG: Log all attempts and dateMap for investigation\n    console.log(`[recalculateUserStatsRegion] userId: ${userId}, region: ${targetRegion}`);\n    console.log(`[recalculateUserStatsRegion] allAttempts count: ${allAttempts.length}`);\n    console.log(`[recalculateUserStatsRegion] completedAttempts (won) count: ${completedAttempts.length}`);\n    console.log(`[recalculateUserStatsRegion] lostAttempts count: ${lostAttempts.length}`);\n    console.log(`[recalculateUserStatsRegion] dateMap entries (last 10):`, \n      Array.from(dateMap.entries()).slice(-10).map(([date, data]) => ({ date, ...data })));\n\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    let checkDate = new Date(today);\n    \n    const todayStr = today.toISOString().split('T')[0];\n    console.log(`[recalculateUserStatsRegion] todayStr: ${todayStr}, has today entry: ${dateMap.has(todayStr)}`);\n    if (!dateMap.has(todayStr)) {\n      const yesterday = new Date(today);\n      yesterday.setDate(yesterday.getDate() - 1);\n      checkDate = new Date(yesterday);\n      console.log(`[recalculateUserStatsRegion] No today entry, starting from yesterday: ${checkDate.toISOString().split('T')[0]}`);\n    }\n    \n    // Sum consecutive streak_day_status values (1 for played, 0 for holiday)\n    // Break on NULL streakDayStatus or missing row\n    console.log(`[recalculateUserStatsRegion] Starting streak calculation from: ${checkDate.toISOString().split('T')[0]}`);\n    while (true) {\n      const dateStr = checkDate.toISOString().split('T')[0];\n      const dayData = dateMap.get(dateStr);\n      \n      console.log(`[recalculateUserStatsRegion] Checking ${dateStr}: dayData=${JSON.stringify(dayData)}, currentStreak=${currentStreak}`);\n      \n      if (!dayData) {\n        console.log(`[recalculateUserStatsRegion] Breaking: no row for ${dateStr}`);\n        break; // No row - streak broken\n      }\n      if (dayData.streakDayStatus === null || dayData.streakDayStatus === undefined) {\n        console.log(`[recalculateUserStatsRegion] Breaking: NULL streakDayStatus for ${dateStr}`);\n        break; // NULL breaks chain\n      }\n      \n      // Add the streakDayStatus value (1 for played/won, 0 for holiday)\n      currentStreak += dayData.streakDayStatus;\n      console.log(`[recalculateUserStatsRegion] Added ${dayData.streakDayStatus}, currentStreak now: ${currentStreak}`);\n      \n      checkDate.setDate(checkDate.getDate() - 1);\n    }\n    \n    console.log(`[recalculateUserStatsRegion] Final currentStreak: ${currentStreak}`);\n\n    // Calculate max streak - must also check for consecutive dates (gaps break streak)\n    const sortedDates = Array.from(dateMap.keys()).sort();\n    let prevDate: Date | null = null;\n    for (let i = 0; i < sortedDates.length; i++) {\n      const currentDateStr = sortedDates[i];\n      const currentDate = new Date(currentDateStr);\n      const dayData = dateMap.get(currentDateStr);\n      \n      if (!dayData) {\n        tempStreak = 0;\n        prevDate = null;\n        continue;\n      }\n      \n      // Check for date gap (more than 1 day between entries)\n      if (prevDate) {\n        const dayDiff = Math.round((currentDate.getTime() - prevDate.getTime()) / (1000 * 60 * 60 * 24));\n        if (dayDiff > 1) {\n          // Gap in dates - streak breaks\n          tempStreak = 0;\n        }\n      }\n      \n      if (dayData.streakDayStatus === null || dayData.streakDayStatus === undefined) {\n        // NULL breaks the streak\n        tempStreak = 0;\n      } else {\n        // Add the value (1 for played, 0 for holiday)\n        tempStreak += dayData.streakDayStatus;\n        maxStreak = Math.max(maxStreak, tempStreak);\n      }\n      \n      prevDate = currentDate;\n    }\n\n    return await this.upsertUserStatsRegion({\n      userId,\n      region: targetRegion,\n      gamesPlayed,\n      gamesWon,\n      currentStreak,\n      maxStreak,\n      guessDistribution,\n    });\n  }\n\n  async getUserPercentileRankingRegion(userId: string, region?: string): Promise<number> {\n    // Get user's current region if not provided\n    let targetRegion = region;\n    if (!targetRegion) {\n      const profile = await this.getUserProfile(userId);\n      targetRegion = profile?.region || \"UK\";\n    }\n    \n    // Get all stats for users IN THE SAME REGION only\n    const allUserStats = await db\n      .select({\n        userId: userStatsRegion.userId,\n        gamesWon: userStatsRegion.gamesWon,\n      })\n      .from(userStatsRegion)\n      .where(eq(userStatsRegion.region, targetRegion))\n      .orderBy(desc(userStatsRegion.gamesWon));\n\n    if (allUserStats.length === 0) {\n      return 100;\n    }\n\n    const userPosition = allUserStats.findIndex(stat => stat.userId === userId);\n    \n    if (userPosition === -1) {\n      return 100;\n    }\n\n    const percentile = ((userPosition + 1) / allUserStats.length) * 100;\n    return Math.round(percentile * 10) / 10;\n  }\n\n  // ========================================================================\n  // USER GAME MODE OPERATIONS\n  // ========================================================================\n\n  // Question master operations (user)\n  async getQuestionMasterUser(id: number): Promise<QuestionMasterUser | undefined> {\n    const [question] = await db\n      .select()\n      .from(questionsMasterUser)\n      .where(eq(questionsMasterUser.id, id));\n    return question;\n  }\n\n  async createQuestionMasterUser(questionData: InsertQuestionMasterUser): Promise<QuestionMasterUser> {\n    const [question] = await db\n      .insert(questionsMasterUser)\n      .values(questionData)\n      .returning();\n    return question;\n  }\n\n  // Question allocated operations (user)\n  async getAllocatedQuestionByUserAndDate(\n    userId: string,\n    date: string\n  ): Promise<AllocatedUserQuestionWithMaster | undefined> {\n    const results = await db\n      .select({\n        id: questionsAllocatedUser.id,\n        questionId: questionsAllocatedUser.questionId,\n        userId: questionsAllocatedUser.userId,\n        puzzleDate: questionsAllocatedUser.puzzleDate,\n        categoryId: questionsAllocatedUser.categoryId,\n        categoryName: categories.name,\n        placeName: populatedPlaces.name1,\n        masterQuestion_id: questionsMasterUser.id,\n        masterQuestion_answerDateCanonical: questionsMasterUser.answerDateCanonical,\n        masterQuestion_eventTitle: questionsMasterUser.eventTitle,\n        masterQuestion_eventDescription: questionsMasterUser.eventDescription,\n        masterQuestion_regions: questionsMasterUser.regions,\n        masterQuestion_categories: questionsMasterUser.categories,\n        masterQuestion_populatedPlaceId: questionsMasterUser.populatedPlaceId,\n        masterQuestion_createdAt: questionsMasterUser.createdAt,\n      })\n      .from(questionsAllocatedUser)\n      .innerJoin(\n        questionsMasterUser,\n        eq(questionsAllocatedUser.questionId, questionsMasterUser.id)\n      )\n      .innerJoin(\n        categories,\n        eq(questionsAllocatedUser.categoryId, categories.id)\n      )\n      .leftJoin(\n        populatedPlaces,\n        eq(questionsMasterUser.populatedPlaceId, populatedPlaces.id)\n      )\n      .where(\n        and(\n          eq(questionsAllocatedUser.userId, userId),\n          eq(questionsAllocatedUser.puzzleDate, date)\n        )\n      );\n\n    if (results.length === 0) return undefined;\n\n    const result = results[0];\n    return {\n      id: result.id,\n      questionId: result.questionId,\n      userId: result.userId,\n      puzzleDate: result.puzzleDate,\n      categoryId: result.categoryId,\n      categoryName: result.categoryName,\n      placeName: result.placeName,\n      masterQuestion: {\n        id: result.masterQuestion_id,\n        answerDateCanonical: result.masterQuestion_answerDateCanonical,\n        eventTitle: result.masterQuestion_eventTitle,\n        eventDescription: result.masterQuestion_eventDescription,\n        regions: result.masterQuestion_regions,\n        categories: result.masterQuestion_categories,\n        populatedPlaceId: result.masterQuestion_populatedPlaceId,\n        createdAt: result.masterQuestion_createdAt,\n      },\n    };\n  }\n\n  async getAllocatedQuestionsByUser(userId: string): Promise<AllocatedUserQuestionWithMaster[]> {\n    const results = await db\n      .select({\n        id: questionsAllocatedUser.id,\n        questionId: questionsAllocatedUser.questionId,\n        userId: questionsAllocatedUser.userId,\n        puzzleDate: questionsAllocatedUser.puzzleDate,\n        categoryId: questionsAllocatedUser.categoryId,\n        categoryName: categories.name,\n        placeName: populatedPlaces.name1,\n        masterQuestion_id: questionsMasterUser.id,\n        masterQuestion_answerDateCanonical: questionsMasterUser.answerDateCanonical,\n        masterQuestion_eventTitle: questionsMasterUser.eventTitle,\n        masterQuestion_eventDescription: questionsMasterUser.eventDescription,\n        masterQuestion_regions: questionsMasterUser.regions,\n        masterQuestion_categories: questionsMasterUser.categories,\n        masterQuestion_populatedPlaceId: questionsMasterUser.populatedPlaceId,\n        masterQuestion_createdAt: questionsMasterUser.createdAt,\n      })\n      .from(questionsAllocatedUser)\n      .innerJoin(\n        questionsMasterUser,\n        eq(questionsAllocatedUser.questionId, questionsMasterUser.id)\n      )\n      .innerJoin(\n        categories,\n        eq(questionsAllocatedUser.categoryId, categories.id)\n      )\n      .leftJoin(\n        populatedPlaces,\n        eq(questionsMasterUser.populatedPlaceId, populatedPlaces.id)\n      )\n      .where(eq(questionsAllocatedUser.userId, userId))\n      .orderBy(questionsAllocatedUser.puzzleDate);\n\n    return results.map(result => ({\n      id: result.id,\n      questionId: result.questionId,\n      userId: result.userId,\n      puzzleDate: result.puzzleDate,\n      categoryId: result.categoryId,\n      categoryName: result.categoryName,\n      placeName: result.placeName,\n      masterQuestion: {\n        id: result.masterQuestion_id,\n        answerDateCanonical: result.masterQuestion_answerDateCanonical,\n        eventTitle: result.masterQuestion_eventTitle,\n        eventDescription: result.masterQuestion_eventDescription,\n        regions: result.masterQuestion_regions,\n        categories: result.masterQuestion_categories,\n        populatedPlaceId: result.masterQuestion_populatedPlaceId,\n        createdAt: result.masterQuestion_createdAt,\n      },\n    }));\n  }\n\n  async getAllocatedQuestionsSinceByUser(\n    userId: string,\n    since: string\n  ): Promise<AllocatedUserQuestionWithMaster[]> {\n    const results = await db\n      .select({\n        id: questionsAllocatedUser.id,\n        questionId: questionsAllocatedUser.questionId,\n        userId: questionsAllocatedUser.userId,\n        puzzleDate: questionsAllocatedUser.puzzleDate,\n        categoryId: questionsAllocatedUser.categoryId,\n        categoryName: categories.name,\n        placeName: populatedPlaces.name1,\n        masterQuestion_id: questionsMasterUser.id,\n        masterQuestion_answerDateCanonical: questionsMasterUser.answerDateCanonical,\n        masterQuestion_eventTitle: questionsMasterUser.eventTitle,\n        masterQuestion_eventDescription: questionsMasterUser.eventDescription,\n        masterQuestion_regions: questionsMasterUser.regions,\n        masterQuestion_categories: questionsMasterUser.categories,\n        masterQuestion_populatedPlaceId: questionsMasterUser.populatedPlaceId,\n        masterQuestion_createdAt: questionsMasterUser.createdAt,\n      })\n      .from(questionsAllocatedUser)\n      .innerJoin(\n        questionsMasterUser,\n        eq(questionsAllocatedUser.questionId, questionsMasterUser.id)\n      )\n      .innerJoin(\n        categories,\n        eq(questionsAllocatedUser.categoryId, categories.id)\n      )\n      .leftJoin(\n        populatedPlaces,\n        eq(questionsMasterUser.populatedPlaceId, populatedPlaces.id)\n      )\n      .where(\n        and(\n          eq(questionsAllocatedUser.userId, userId),\n          gte(questionsAllocatedUser.puzzleDate, since)\n        )\n      )\n      .orderBy(questionsAllocatedUser.puzzleDate);\n\n    return results.map(result => ({\n      id: result.id,\n      questionId: result.questionId,\n      userId: result.userId,\n      puzzleDate: result.puzzleDate,\n      categoryId: result.categoryId,\n      categoryName: result.categoryName,\n      placeName: result.placeName,\n      masterQuestion: {\n        id: result.masterQuestion_id,\n        answerDateCanonical: result.masterQuestion_answerDateCanonical,\n        eventTitle: result.masterQuestion_eventTitle,\n        eventDescription: result.masterQuestion_eventDescription,\n        regions: result.masterQuestion_regions,\n        categories: result.masterQuestion_categories,\n        populatedPlaceId: result.masterQuestion_populatedPlaceId,\n        createdAt: result.masterQuestion_createdAt,\n      },\n    }));\n  }\n\n  async createQuestionAllocatedUser(\n    allocationData: InsertQuestionAllocatedUser\n  ): Promise<QuestionAllocatedUser> {\n    const [allocation] = await db\n      .insert(questionsAllocatedUser)\n      .values(allocationData)\n      .returning();\n    return allocation;\n  }\n\n  async ensureUserAllocations(userId: string, minCount: number = 30): Promise<void> {\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    const todayStr = today.toISOString().split('T')[0];\n\n    // Get all existing allocations for this user\n    const allAllocations = await db\n      .select()\n      .from(questionsAllocatedUser)\n      .where(eq(questionsAllocatedUser.userId, userId))\n      .orderBy(questionsAllocatedUser.puzzleDate);\n\n    // Count only FUTURE allocations (today or later)\n    const futureAllocations = allAllocations.filter(a => a.puzzleDate >= todayStr);\n    const futureCount = futureAllocations.length;\n\n    console.log(`[ensureUserAllocations] User ${userId} has ${futureCount} future allocations (${allAllocations.length} total), target: ${minCount}`);\n\n    if (futureCount >= minCount) {\n      console.log(`[ensureUserAllocations] User already has enough future allocations`);\n      return;\n    }\n\n    const needed = minCount - futureCount;\n    console.log(`[ensureUserAllocations] Need to allocate ${needed} more questions`);\n\n    // Get IDs of already-allocated questions to avoid duplicates\n    const allocatedQuestionIds = allAllocations.map(a => a.questionId);\n\n    // Fetch available master questions (excluding already allocated ones)\n    const availableQuestions = await db\n      .select()\n      .from(questionsMasterUser)\n      .where(\n        allocatedQuestionIds.length > 0 \n          ? notInArray(questionsMasterUser.id, allocatedQuestionIds)\n          : sql`true`\n      )\n      .limit(needed);\n\n    if (availableQuestions.length === 0) {\n      console.log(`[ensureUserAllocations] No available questions to allocate`);\n      return;\n    }\n\n    console.log(`[ensureUserAllocations] Found ${availableQuestions.length} available questions`);\n\n    // Find the latest existing puzzle date, or use today if none exist\n    let startDate: Date;\n    if (allAllocations.length > 0) {\n      const latestAllocation = allAllocations[allAllocations.length - 1];\n      startDate = new Date(latestAllocation.puzzleDate);\n      startDate.setDate(startDate.getDate() + 1); // Start from next day after latest\n    } else {\n      startDate = new Date(today);\n    }\n\n    const allocations = availableQuestions.map((question, index) => {\n      const puzzleDate = new Date(startDate);\n      puzzleDate.setDate(puzzleDate.getDate() + index);\n      const puzzleDateStr = puzzleDate.toISOString().split('T')[0];\n\n      // Pick a random category ID from the question's categories\n      // categories is a JSONB array of category IDs\n      const categoryId = question.categories && Array.isArray(question.categories) && question.categories.length > 0 \n        ? question.categories[Math.floor(Math.random() * question.categories.length)]\n        : 1; // Default to category ID 1 if no categories\n\n      return {\n        userId,\n        questionId: question.id,\n        puzzleDate: puzzleDateStr,\n        categoryId,\n      };\n    });\n\n    // Bulk insert allocations\n    if (allocations.length > 0) {\n      await db.insert(questionsAllocatedUser).values(allocations);\n      console.log(`[ensureUserAllocations] Created ${allocations.length} new allocations starting from ${allocations[0].puzzleDate}`);\n    }\n  }\n\n  // Game attempt operations (user)\n  async getGameAttemptUser(id: number): Promise<GameAttemptUser | undefined> {\n    const [attempt] = await db\n      .select()\n      .from(gameAttemptsUser)\n      .where(eq(gameAttemptsUser.id, id));\n    return attempt;\n  }\n\n  async getGameAttemptUserWithQuestion(\n    id: number\n  ): Promise<GameAttemptUserWithAllocatedQuestion | undefined> {\n    const results = await db\n      .select({\n        id: gameAttemptsUser.id,\n        userId: gameAttemptsUser.userId,\n        allocatedUserId: gameAttemptsUser.allocatedUserId,\n        result: gameAttemptsUser.result,\n        numGuesses: gameAttemptsUser.numGuesses,\n        digits: gameAttemptsUser.digits,\n        startedAt: gameAttemptsUser.startedAt,\n        completedAt: gameAttemptsUser.completedAt,\n        allocated_id: questionsAllocatedUser.id,\n        allocated_questionId: questionsAllocatedUser.questionId,\n        allocated_userId: questionsAllocatedUser.userId,\n        allocated_puzzleDate: questionsAllocatedUser.puzzleDate,\n        allocated_categoryId: questionsAllocatedUser.categoryId,\n        categoryName: categories.name,\n        placeName: populatedPlaces.name1,\n        master_id: questionsMasterUser.id,\n        master_answerDateCanonical: questionsMasterUser.answerDateCanonical,\n        master_eventTitle: questionsMasterUser.eventTitle,\n        master_eventDescription: questionsMasterUser.eventDescription,\n        master_regions: questionsMasterUser.regions,\n        master_categories: questionsMasterUser.categories,\n        master_populatedPlaceId: questionsMasterUser.populatedPlaceId,\n        master_createdAt: questionsMasterUser.createdAt,\n      })\n      .from(gameAttemptsUser)\n      .innerJoin(\n        questionsAllocatedUser,\n        eq(gameAttemptsUser.allocatedUserId, questionsAllocatedUser.id)\n      )\n      .innerJoin(\n        questionsMasterUser,\n        eq(questionsAllocatedUser.questionId, questionsMasterUser.id)\n      )\n      .innerJoin(\n        categories,\n        eq(questionsAllocatedUser.categoryId, categories.id)\n      )\n      .leftJoin(\n        populatedPlaces,\n        eq(questionsMasterUser.populatedPlaceId, populatedPlaces.id)\n      )\n      .where(eq(gameAttemptsUser.id, id));\n\n    if (results.length === 0) return undefined;\n\n    const result = results[0];\n    return {\n      id: result.id,\n      userId: result.userId,\n      allocatedUserId: result.allocatedUserId,\n      result: result.result,\n      numGuesses: result.numGuesses,\n      digits: result.digits,\n      startedAt: result.startedAt,\n      completedAt: result.completedAt,\n      allocatedQuestion: {\n        id: result.allocated_id,\n        questionId: result.allocated_questionId,\n        userId: result.allocated_userId,\n        puzzleDate: result.allocated_puzzleDate,\n        categoryId: result.allocated_categoryId,\n        categoryName: result.categoryName,\n        placeName: result.placeName,\n        masterQuestion: {\n          id: result.master_id,\n          answerDateCanonical: result.master_answerDateCanonical,\n          eventTitle: result.master_eventTitle,\n          eventDescription: result.master_eventDescription,\n          regions: result.master_regions,\n          categories: result.master_categories,\n          populatedPlaceId: result.master_populatedPlaceId,\n          createdAt: result.master_createdAt,\n        },\n      },\n    };\n  }\n\n  async getGameAttemptsByUserUser(userId: string): Promise<GameAttemptUserWithAllocatedQuestion[]> {\n    const results = await db\n      .select({\n        id: gameAttemptsUser.id,\n        userId: gameAttemptsUser.userId,\n        allocatedUserId: gameAttemptsUser.allocatedUserId,\n        result: gameAttemptsUser.result,\n        numGuesses: gameAttemptsUser.numGuesses,\n        digits: gameAttemptsUser.digits,\n        startedAt: gameAttemptsUser.startedAt,\n        completedAt: gameAttemptsUser.completedAt,\n        streakDayStatus: gameAttemptsUser.streakDayStatus,\n        allocated_id: questionsAllocatedUser.id,\n        allocated_questionId: questionsAllocatedUser.questionId,\n        allocated_userId: questionsAllocatedUser.userId,\n        allocated_puzzleDate: questionsAllocatedUser.puzzleDate,\n        allocated_categoryId: questionsAllocatedUser.categoryId,\n        categoryName: categories.name,\n        placeName: populatedPlaces.name1,\n        master_id: questionsMasterUser.id,\n        master_answerDateCanonical: questionsMasterUser.answerDateCanonical,\n        master_eventTitle: questionsMasterUser.eventTitle,\n        master_eventDescription: questionsMasterUser.eventDescription,\n        master_regions: questionsMasterUser.regions,\n        master_categories: questionsMasterUser.categories,\n        master_populatedPlaceId: questionsMasterUser.populatedPlaceId,\n        master_createdAt: questionsMasterUser.createdAt,\n      })\n      .from(gameAttemptsUser)\n      .innerJoin(\n        questionsAllocatedUser,\n        eq(gameAttemptsUser.allocatedUserId, questionsAllocatedUser.id)\n      )\n      .innerJoin(\n        questionsMasterUser,\n        eq(questionsAllocatedUser.questionId, questionsMasterUser.id)\n      )\n      .innerJoin(\n        categories,\n        eq(questionsAllocatedUser.categoryId, categories.id)\n      )\n      .leftJoin(\n        populatedPlaces,\n        eq(questionsMasterUser.populatedPlaceId, populatedPlaces.id)\n      )\n      .where(eq(gameAttemptsUser.userId, userId))\n      .orderBy(desc(questionsAllocatedUser.puzzleDate));\n\n    return results.map(result => ({\n      id: result.id,\n      userId: result.userId,\n      allocatedUserId: result.allocatedUserId,\n      result: result.result,\n      numGuesses: result.numGuesses,\n      digits: result.digits,\n      startedAt: result.startedAt,\n      completedAt: result.completedAt,\n      streakDayStatus: result.streakDayStatus,\n      allocatedQuestion: {\n        id: result.allocated_id,\n        questionId: result.allocated_questionId,\n        userId: result.allocated_userId,\n        puzzleDate: result.allocated_puzzleDate,\n        categoryId: result.allocated_categoryId,\n        categoryName: result.categoryName,\n        placeName: result.placeName,\n        masterQuestion: {\n          id: result.master_id,\n          answerDateCanonical: result.master_answerDateCanonical,\n          eventTitle: result.master_eventTitle,\n          eventDescription: result.master_eventDescription,\n          regions: result.master_regions,\n          categories: result.master_categories,\n          populatedPlaceId: result.master_populatedPlaceId,\n          createdAt: result.master_createdAt,\n        },\n      },\n    }));\n  }\n\n  async getGameAttemptByUserAndAllocatedUser(\n    userId: string,\n    allocatedUserId: number\n  ): Promise<GameAttemptUser | undefined> {\n    const [attempt] = await db\n      .select()\n      .from(gameAttemptsUser)\n      .where(\n        and(\n          eq(gameAttemptsUser.userId, userId),\n          eq(gameAttemptsUser.allocatedUserId, allocatedUserId)\n        )\n      );\n    return attempt;\n  }\n\n  async createGameAttemptUser(attemptData: InsertGameAttemptUser): Promise<GameAttemptUser> {\n    const [attempt] = await db\n      .insert(gameAttemptsUser)\n      .values(attemptData)\n      .returning();\n    return attempt;\n  }\n\n  async updateGameAttemptUser(\n    id: number,\n    updateData: Partial<Omit<GameAttemptUser, 'id' | 'userId' | 'allocatedUserId' | 'startedAt'>>\n  ): Promise<GameAttemptUser> {\n    const [current] = await db\n      .select()\n      .from(gameAttemptsUser)\n      .where(eq(gameAttemptsUser.id, id));\n\n    let safeUpdate = { ...updateData } as any;\n\n    // Ensure numGuesses never decreases\n    if (typeof safeUpdate.numGuesses === \"number\" && current) {\n      safeUpdate.numGuesses = Math.max(safeUpdate.numGuesses, current.numGuesses ?? 0);\n    }\n\n    // If result is being set, mark completedAt\n    if (safeUpdate.result && !current?.completedAt) {\n      safeUpdate.completedAt = new Date();\n    }\n\n    const [attempt] = await db\n      .update(gameAttemptsUser)\n      .set(safeUpdate)\n      .where(eq(gameAttemptsUser.id, id))\n      .returning();\n\n    return attempt;\n  }\n\n  async incrementAttemptGuessesUser(gameAttemptId: number): Promise<void> {\n    const [current] = await db\n      .select({ numGuesses: gameAttemptsUser.numGuesses })\n      .from(gameAttemptsUser)\n      .where(eq(gameAttemptsUser.id, gameAttemptId));\n\n    const next = (current?.numGuesses ?? 0) + 1;\n\n    await db\n      .update(gameAttemptsUser)\n      .set({ numGuesses: next })\n      .where(eq(gameAttemptsUser.id, gameAttemptId));\n  }\n\n  // Guess operations (user)\n  async getGuessesByGameAttemptUser(gameAttemptId: number): Promise<GuessUser[]> {\n    return await db\n      .select()\n      .from(guessesUser)\n      .where(eq(guessesUser.gameAttemptId, gameAttemptId))\n      .orderBy(guessesUser.guessedAt);\n  }\n\n  async createGuessUser(guessData: InsertGuessUser): Promise<GuessUser> {\n    const [guess] = await db.insert(guessesUser).values(guessData).returning();\n    return guess;\n  }\n\n  async getRecentGuessesWithAllocatedIdsUser(\n    userId: string,\n    since: string\n  ): Promise<Array<GuessUser & { allocatedUserId: number }>> {\n    const results = await db\n      .select({\n        id: guessesUser.id,\n        gameAttemptId: guessesUser.gameAttemptId,\n        guessValue: guessesUser.guessValue,\n        guessedAt: guessesUser.guessedAt,\n        allocatedUserId: gameAttemptsUser.allocatedUserId,\n      })\n      .from(guessesUser)\n      .innerJoin(\n        gameAttemptsUser,\n        eq(guessesUser.gameAttemptId, gameAttemptsUser.id)\n      )\n      .innerJoin(\n        questionsAllocatedUser,\n        eq(gameAttemptsUser.allocatedUserId, questionsAllocatedUser.id)\n      )\n      .where(\n        and(\n          eq(gameAttemptsUser.userId, userId),\n          gte(questionsAllocatedUser.puzzleDate, since)\n        )\n      )\n      .orderBy(guessesUser.guessedAt);\n\n    return results;\n  }\n\n  async getAllGuessesWithAllocatedIdsUser(\n    userId: string\n  ): Promise<Array<GuessUser & { allocatedUserId: number; result: string | null }>> {\n    const results = await db\n      .select({\n        id: guessesUser.id,\n        gameAttemptId: guessesUser.gameAttemptId,\n        guessValue: guessesUser.guessValue,\n        guessedAt: guessesUser.guessedAt,\n        allocatedUserId: gameAttemptsUser.allocatedUserId,\n        result: gameAttemptsUser.result,\n      })\n      .from(guessesUser)\n      .innerJoin(\n        gameAttemptsUser,\n        eq(guessesUser.gameAttemptId, gameAttemptsUser.id)\n      )\n      .where(eq(gameAttemptsUser.userId, userId))\n      .orderBy(guessesUser.guessedAt);\n\n    return results;\n  }\n\n  // User stats operations (user)\n  async getUserStatsUser(userId: string): Promise<UserStatsUser | undefined> {\n    const [stats] = await db\n      .select()\n      .from(userStatsUser)\n      .where(eq(userStatsUser.userId, userId));\n    return stats;\n  }\n\n  async upsertUserStatsUser(statsData: InsertUserStatsUser): Promise<UserStatsUser> {\n    // Check if stats already exist for this user\n    const existing = await this.getUserStatsUser(statsData.userId);\n    \n    if (existing) {\n      // Update existing stats\n      const [updated] = await db\n        .update(userStatsUser)\n        .set({\n          ...statsData,\n          updatedAt: new Date(),\n        })\n        .where(eq(userStatsUser.userId, statsData.userId))\n        .returning();\n      return updated;\n    } else {\n      // Insert new stats\n      const [inserted] = await db\n        .insert(userStatsUser)\n        .values(statsData)\n        .returning();\n      return inserted;\n    }\n  }\n\n  async recalculateUserStatsUser(userId: string): Promise<UserStatsUser> {\n    // Get ALL game attempts for this user in user mode in ONE query\n    // This ensures we capture all attempts regardless of result value\n    const allAttempts = await db\n      .select({\n        id: gameAttemptsUser.id,\n        result: gameAttemptsUser.result,\n        numGuesses: gameAttemptsUser.numGuesses,\n        completedAt: gameAttemptsUser.completedAt,\n        puzzleDate: questionsAllocatedUser.puzzleDate,\n        streakDayStatus: gameAttemptsUser.streakDayStatus,\n      })\n      .from(gameAttemptsUser)\n      .innerJoin(\n        questionsAllocatedUser,\n        eq(gameAttemptsUser.allocatedUserId, questionsAllocatedUser.id)\n      )\n      .where(eq(gameAttemptsUser.userId, userId))\n      .orderBy(questionsAllocatedUser.puzzleDate);\n\n    // Categorize attempts by result for counting\n    const completedAttempts = allAttempts.filter(a => a.result === 'won');\n    const lostAttempts = allAttempts.filter(a => a.result === 'lost');\n\n    const gamesPlayed = completedAttempts.length + lostAttempts.length;\n    const gamesWon = completedAttempts.length;\n\n    // Calculate guess distribution (only for won games)\n    const guessDistribution: any = { \"1\": 0, \"2\": 0, \"3\": 0, \"4\": 0, \"5\": 0 };\n    for (const attempt of completedAttempts) {\n      const numGuesses = attempt.numGuesses || 0;\n      if (numGuesses >= 1 && numGuesses <= 5) {\n        guessDistribution[numGuesses.toString()] = (guessDistribution[numGuesses.toString()] || 0) + 1;\n      }\n    }\n\n    // Calculate current streak using streak_day_status\n    // streak_day_status: 0 = holiday (maintains continuity), 1 = played (increments), NULL = missed (breaks)\n    // Sort allAttempts by date descending for streak calculation\n    const sortedAttempts = [...allAttempts].sort((a, b) => \n      new Date(b.puzzleDate).getTime() - new Date(a.puzzleDate).getTime()\n    );\n\n    let currentStreak = 0;\n    let maxStreak = 0;\n    let tempStreak = 0;\n    \n    // Build a map of dates to { result, streakDayStatus } from ALL attempts\n    const dateMap = new Map<string, { result: string | null; streakDayStatus: number | null }>();\n    for (const attempt of sortedAttempts) {\n      // Always include attempts with valid streakDayStatus (0 for holiday, 1 for played)\n      // Don't filter by completedAt date - this broke streaks for late-night players\n      if (attempt.streakDayStatus !== null && attempt.streakDayStatus !== undefined) {\n        dateMap.set(attempt.puzzleDate, { \n          result: attempt.result, \n          streakDayStatus: attempt.streakDayStatus \n        });\n      } else if (attempt.result !== null) {\n        // Game was completed but streakDayStatus not set (legacy data)\n        // Include with NULL to properly break streak chain\n        dateMap.set(attempt.puzzleDate, { \n          result: attempt.result, \n          streakDayStatus: null \n        });\n      }\n    }\n    \n    // DEBUG: Log for investigation\n    console.log(`[recalculateUserStatsUser] userId: ${userId}`);\n    console.log(`[recalculateUserStatsUser] allAttempts count: ${allAttempts.length}`);\n    console.log(`[recalculateUserStatsUser] dateMap entries (last 10):`, \n      Array.from(dateMap.entries()).slice(-10).map(([date, data]) => ({ date, ...data })));\n\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    let checkDate = new Date(today);\n    \n    const todayStr = today.toISOString().split('T')[0];\n    if (!dateMap.has(todayStr)) {\n      const yesterday = new Date(today);\n      yesterday.setDate(yesterday.getDate() - 1);\n      checkDate = new Date(yesterday);\n    }\n    \n    // New algorithm: sum of consecutive streak_day_status values (1 for played, 0 for holiday)\n    // Break on NULL streakDayStatus or missing row\n    while (true) {\n      const dateStr = checkDate.toISOString().split('T')[0];\n      const dayData = dateMap.get(dateStr);\n      \n      if (!dayData) break; // No row - streak broken\n      if (dayData.streakDayStatus === null || dayData.streakDayStatus === undefined) break; // NULL breaks chain\n      \n      // Add the streakDayStatus value (1 for played/won, 0 for holiday)\n      currentStreak += dayData.streakDayStatus;\n      \n      checkDate.setDate(checkDate.getDate() - 1);\n    }\n\n    // Calculate max streak - must also check for consecutive dates (gaps break streak)\n    const sortedDates = Array.from(dateMap.keys()).sort();\n    let prevDate: Date | null = null;\n    for (let i = 0; i < sortedDates.length; i++) {\n      const currentDateStr = sortedDates[i];\n      const currentDate = new Date(currentDateStr);\n      const dayData = dateMap.get(currentDateStr);\n      \n      if (!dayData) {\n        tempStreak = 0;\n        prevDate = null;\n        continue;\n      }\n      \n      // Check for date gap (more than 1 day between entries)\n      if (prevDate) {\n        const dayDiff = Math.round((currentDate.getTime() - prevDate.getTime()) / (1000 * 60 * 60 * 24));\n        if (dayDiff > 1) {\n          // Gap in dates - streak breaks\n          tempStreak = 0;\n        }\n      }\n      \n      if (dayData.streakDayStatus === null || dayData.streakDayStatus === undefined) {\n        // NULL breaks the streak\n        tempStreak = 0;\n      } else {\n        // Add the value (1 for played, 0 for holiday)\n        tempStreak += dayData.streakDayStatus;\n        maxStreak = Math.max(maxStreak, tempStreak);\n      }\n      \n      prevDate = currentDate;\n    }\n\n    return await this.upsertUserStatsUser({\n      userId,\n      gamesPlayed,\n      gamesWon,\n      currentStreak,\n      maxStreak,\n      guessDistribution,\n    });\n  }\n\n  async getUserPercentileRankingUser(userId: string): Promise<number> {\n    const allUserStats = await db\n      .select({\n        userId: userStatsUser.userId,\n        gamesWon: userStatsUser.gamesWon,\n      })\n      .from(userStatsUser)\n      .orderBy(desc(userStatsUser.gamesWon));\n\n    if (allUserStats.length === 0) {\n      return 100;\n    }\n\n    const userPosition = allUserStats.findIndex(stat => stat.userId === userId);\n    \n    if (userPosition === -1) {\n      return 100;\n    }\n\n    const percentile = ((userPosition + 1) / allUserStats.length) * 100;\n    return Math.round(percentile * 10) / 10;\n  }\n\n  // ========================================================================\n  // SUBSCRIPTION & PRO CATEGORY OPERATIONS\n  // ========================================================================\n\n  async getUserSubscription(userId: string): Promise<any | undefined> {\n    try {\n      // Query the user_subscriptions table directly via SQL\n      const result = await db.execute(\n        sql`SELECT * FROM user_subscriptions WHERE user_id = ${userId} LIMIT 1`\n      );\n      return result.rows?.[0] || undefined;\n    } catch (error: any) {\n      // Table might not exist yet\n      if (error?.code === '42P01') {\n        console.log('Note: user_subscriptions table not available yet');\n        return undefined;\n      }\n      throw error;\n    }\n  }\n\n  // Note: Legacy upsertUserSubscription removed - use createUserSubscription() instead\n  // which properly uses user_tier_id FK to user_tier table\n\n  async getAllCategories(): Promise<Category[]> {\n    return await db.select().from(categories).orderBy(categories.name);\n  }\n\n  async getUserProCategories(userId: string): Promise<number[]> {\n    try {\n      // Read from user_category_preferences table (existing Supabase table)\n      const result: any = await db.execute(\n        sql`SELECT category_id FROM user_category_preferences WHERE user_id = ${userId}::uuid`\n      );\n      \n      // Drizzle with Neon can return rows directly or in result.rows\n      const rows = Array.isArray(result) ? result : (result.rows || []);\n      console.log('[getUserProCategories] Found', rows.length, 'categories for user:', userId);\n      return rows.map((row: any) => row.category_id);\n    } catch (error: any) {\n      console.error('[getUserProCategories] Error:', error);\n      // Table might not exist yet\n      if (error?.code === '42P01') {\n        console.log('Note: user_category_preferences table not available yet');\n        return [];\n      }\n      throw error;\n    }\n  }\n\n  async saveUserProCategories(userId: string, categoryIds: number[]): Promise<void> {\n    try {\n      // Save to user_category_preferences table (existing Supabase table)\n      // Delete existing categories\n      await db.execute(sql`DELETE FROM user_category_preferences WHERE user_id = ${userId}::uuid`);\n      \n      // Insert new categories\n      for (const categoryId of categoryIds) {\n        await db.execute(\n          sql`INSERT INTO user_category_preferences (user_id, category_id) VALUES (${userId}::uuid, ${categoryId})`\n        );\n      }\n      console.log('[saveUserProCategories] Saved', categoryIds.length, 'categories for user:', userId);\n    } catch (error: any) {\n      console.error('[saveUserProCategories] Error:', error);\n      // Table might not exist yet\n      if (error?.code === '42P01') {\n        console.log('Note: user_category_preferences table not available yet');\n        return;\n      }\n      throw error;\n    }\n  }\n\n  async markFirstLoginCompleted(userId: string): Promise<void> {\n    // Note: first_login_completed column not yet in database\n    // This is a no-op until Supabase migration is applied\n    console.log(`First login completed flag would be set for user ${userId}`);\n  }\n\n  // ========================================================================\n  // STREAK SAVER & HOLIDAY OPERATIONS\n  // ========================================================================\n\n  async getStreakSaverStatus(userId: string): Promise<{\n    region: {\n      currentStreak: number;\n      streakSaversUsedMonth: number;\n      missedYesterdayFlag: boolean;\n      canUseStreakSaver: boolean; // true if missed only yesterday (played day before)\n      hasValidStreakForHoliday: boolean; // true if current_streak > 0 AND recent streak activity within 7 days\n    };\n    user: {\n      currentStreak: number;\n      streakSaversUsedMonth: number;\n      holidayActive: boolean;\n      holidayStartDate: string | null;\n      holidayEndDate: string | null;\n      holidayDaysTakenCurrentPeriod: number;\n      holidayEnded: boolean;\n      missedYesterdayFlag: boolean;\n      holidaysUsedYear: number;\n      canUseStreakSaver: boolean; // true if missed only yesterday (played day before)\n      hasValidStreakForHoliday: boolean; // true if current_streak > 0 AND recent streak activity within 7 days\n    };\n  } | null> {\n    try {\n      // Calculate today's, yesterday's, and day before yesterday's dates (in YYYY-MM-DD format)\n      const today = new Date();\n      const todayStr = today.toISOString().split('T')[0];\n      const yesterday = new Date(today);\n      yesterday.setDate(yesterday.getDate() - 1);\n      const yesterdayStr = yesterday.toISOString().split('T')[0];\n      const dayBeforeYesterday = new Date(today);\n      dayBeforeYesterday.setDate(dayBeforeYesterday.getDate() - 2);\n      const dayBeforeYesterdayStr = dayBeforeYesterday.toISOString().split('T')[0];\n      \n      // Get region stats\n      const regionResult = await db.execute(sql`\n        SELECT \n          current_streak,\n          streak_savers_used_month,\n          missed_yesterday_flag_region\n        FROM user_stats_region\n        WHERE user_id = ${userId}\n      `);\n      \n      // Get user stats\n      const userResult = await db.execute(sql`\n        SELECT \n          current_streak,\n          streak_savers_used_month,\n          holiday_active,\n          holiday_start_date,\n          holiday_end_date,\n          holiday_days_taken_current_period,\n          holiday_ended,\n          missed_yesterday_flag_user,\n          holidays_used_year\n        FROM user_stats_user\n        WHERE user_id = ${userId}\n      `);\n      \n      const regionRows = Array.isArray(regionResult) ? regionResult : (regionResult as any).rows || [];\n      const userRows = Array.isArray(userResult) ? userResult : (userResult as any).rows || [];\n      \n      // Return null if user doesn't have any stats yet\n      if (regionRows.length === 0 && userRows.length === 0) {\n        console.log('[getStreakSaverStatus] No stats found for user');\n        return null;\n      }\n      \n      const regionRow = regionRows[0] || {};\n      const userRow = userRows[0] || {};\n      \n      // Get current values\n      let regionCurrentStreak = regionRow.current_streak || 0;\n      let regionMissedFlag = regionRow.missed_yesterday_flag_region || false;\n      let userCurrentStreak = userRow.current_streak || 0;\n      let userMissedFlag = userRow.missed_yesterday_flag_user || false;\n      const holidayActive = userRow.holiday_active || false;\n      \n      // ========================================================================\n      // CHECK AND MANAGE MISSED_YESTERDAY_FLAG FOR REGION MODE\n      // ========================================================================\n      // Check if yesterday's REGION puzzle was played OR protected by holiday (streak_day_status = 0 or 1)\n      const regionYesterdayStatusResult = await db.execute(sql`\n        SELECT ga.id, ga.streak_day_status, ga.result\n        FROM game_attempts_region ga\n        INNER JOIN questions_allocated_region qar ON ga.allocated_region_id = qar.id\n        WHERE ga.user_id = ${userId}\n          AND qar.puzzle_date = ${yesterdayStr}\n        LIMIT 1\n      `);\n      \n      const regionYesterdayStatusRows = Array.isArray(regionYesterdayStatusResult) ? regionYesterdayStatusResult : (regionYesterdayStatusResult as any).rows || [];\n      const regionYesterdayAttempt = regionYesterdayStatusRows[0];\n      // Consider \"played\" if result IS NOT NULL OR streak_day_status is 0 (holiday) or 1 (played)\n      const didPlayRegionYesterday = regionYesterdayAttempt?.result !== null && regionYesterdayAttempt?.result !== undefined;\n      const regionYesterdayProtected = regionYesterdayAttempt?.streak_day_status === 0 || regionYesterdayAttempt?.streak_day_status === 1;\n      \n      // Check if TODAY's REGION puzzle was played\n      const regionPlayedTodayResult = await db.execute(sql`\n        SELECT ga.id \n        FROM game_attempts_region ga\n        INNER JOIN questions_allocated_region qar ON ga.allocated_region_id = qar.id\n        WHERE ga.user_id = ${userId}\n          AND qar.puzzle_date = ${todayStr}\n          AND ga.result IS NOT NULL\n        LIMIT 1\n      `);\n      \n      const regionPlayedTodayRows = Array.isArray(regionPlayedTodayResult) ? regionPlayedTodayResult : (regionPlayedTodayResult as any).rows || [];\n      const didPlayRegionToday = regionPlayedTodayRows.length > 0;\n      \n      // Check if day before yesterday's REGION puzzle was played and WON (result = 'won')\n      const regionDayBeforeYesterdayResult = await db.execute(sql`\n        SELECT ga.id, ga.result\n        FROM game_attempts_region ga\n        INNER JOIN questions_allocated_region qar ON ga.allocated_region_id = qar.id\n        WHERE ga.user_id = ${userId}\n          AND qar.puzzle_date = ${dayBeforeYesterdayStr}\n          AND ga.result = 'won'\n        LIMIT 1\n      `);\n      \n      const regionDayBeforeYesterdayRows = Array.isArray(regionDayBeforeYesterdayResult) ? regionDayBeforeYesterdayResult : (regionDayBeforeYesterdayResult as any).rows || [];\n      const didWinRegionDayBeforeYesterday = regionDayBeforeYesterdayRows.length > 0;\n      \n      if (regionCurrentStreak === 0 && regionMissedFlag) {\n        // No streak to protect - CLEAR the flag!\n        await db.execute(sql`\n          UPDATE user_stats_region \n          SET missed_yesterday_flag_region = false, updated_at = NOW()\n          WHERE user_id = ${userId}\n        `);\n        regionMissedFlag = false;\n      } else if ((didPlayRegionYesterday || regionYesterdayProtected) && regionMissedFlag) {\n        // User has played yesterday OR yesterday was protected by holiday - CLEAR the flag!\n        await db.execute(sql`\n          UPDATE user_stats_region \n          SET missed_yesterday_flag_region = false, updated_at = NOW()\n          WHERE user_id = ${userId}\n        `);\n        regionMissedFlag = false;\n      } else if (didPlayRegionToday && regionMissedFlag) {\n        // User has already played TODAY - if they completed today's puzzle already,\n        // the streak saver window has passed. Clear the flag.\n        await db.execute(sql`\n          UPDATE user_stats_region \n          SET missed_yesterday_flag_region = false, updated_at = NOW()\n          WHERE user_id = ${userId}\n        `);\n        regionMissedFlag = false;\n      } else if (!didPlayRegionYesterday && !regionYesterdayProtected && !didPlayRegionToday && regionCurrentStreak > 0 && !regionMissedFlag) {\n        // User had a streak, missed yesterday (and not protected by holiday), and hasn't played today yet - SET the flag!\n        // This is the only case where we should show the streak saver popup\n        await db.execute(sql`\n          UPDATE user_stats_region \n          SET missed_yesterday_flag_region = true, updated_at = NOW()\n          WHERE user_id = ${userId}\n        `);\n        regionMissedFlag = true;\n      }\n      \n      // ========================================================================\n      // CHECK AND MANAGE MISSED_YESTERDAY_FLAG FOR USER MODE\n      // ========================================================================\n      // Check if yesterday's USER puzzle was played OR protected by holiday (streak_day_status = 0 or 1)\n      const userYesterdayStatusResult = await db.execute(sql`\n        SELECT ga.id, ga.streak_day_status, ga.result\n        FROM game_attempts_user ga\n        INNER JOIN questions_allocated_user qau ON ga.allocated_user_id = qau.id\n        WHERE ga.user_id = ${userId}\n          AND qau.puzzle_date = ${yesterdayStr}\n        LIMIT 1\n      `);\n      \n      const userYesterdayStatusRows = Array.isArray(userYesterdayStatusResult) ? userYesterdayStatusResult : (userYesterdayStatusResult as any).rows || [];\n      const userYesterdayAttempt = userYesterdayStatusRows[0];\n      // Consider \"played\" if result IS NOT NULL OR streak_day_status is 0 (holiday) or 1 (played)\n      const didPlayUserYesterday = userYesterdayAttempt?.result !== null && userYesterdayAttempt?.result !== undefined;\n      const userYesterdayProtected = userYesterdayAttempt?.streak_day_status === 0 || userYesterdayAttempt?.streak_day_status === 1;\n      \n      // Check if TODAY's USER puzzle was played\n      const userPlayedTodayResult = await db.execute(sql`\n        SELECT ga.id \n        FROM game_attempts_user ga\n        INNER JOIN questions_allocated_user qau ON ga.allocated_user_id = qau.id\n        WHERE ga.user_id = ${userId}\n          AND qau.puzzle_date = ${todayStr}\n          AND ga.result IS NOT NULL\n        LIMIT 1\n      `);\n      \n      const userPlayedTodayRows = Array.isArray(userPlayedTodayResult) ? userPlayedTodayResult : (userPlayedTodayResult as any).rows || [];\n      const didPlayUserToday = userPlayedTodayRows.length > 0;\n      \n      // Check if day before yesterday's USER puzzle was played and WON (result = 'won')\n      const userDayBeforeYesterdayResult = await db.execute(sql`\n        SELECT ga.id, ga.result\n        FROM game_attempts_user ga\n        INNER JOIN questions_allocated_user qau ON ga.allocated_user_id = qau.id\n        WHERE ga.user_id = ${userId}\n          AND qau.puzzle_date = ${dayBeforeYesterdayStr}\n          AND ga.result = 'won'\n        LIMIT 1\n      `);\n      \n      const userDayBeforeYesterdayRows = Array.isArray(userDayBeforeYesterdayResult) ? userDayBeforeYesterdayResult : (userDayBeforeYesterdayResult as any).rows || [];\n      const didWinUserDayBeforeYesterday = userDayBeforeYesterdayRows.length > 0;\n      \n      if (userCurrentStreak === 0 && userMissedFlag) {\n        // No streak to protect - CLEAR the flag!\n        await db.execute(sql`\n          UPDATE user_stats_user \n          SET missed_yesterday_flag_user = false, updated_at = NOW()\n          WHERE user_id = ${userId}\n        `);\n        userMissedFlag = false;\n      } else if ((didPlayUserYesterday || userYesterdayProtected) && userMissedFlag) {\n        // User has played yesterday OR yesterday was protected by holiday - CLEAR the flag!\n        await db.execute(sql`\n          UPDATE user_stats_user \n          SET missed_yesterday_flag_user = false, updated_at = NOW()\n          WHERE user_id = ${userId}\n        `);\n        userMissedFlag = false;\n      } else if (didPlayUserToday && userMissedFlag) {\n        // User has already played TODAY - the streak saver window has passed. Clear the flag.\n        await db.execute(sql`\n          UPDATE user_stats_user \n          SET missed_yesterday_flag_user = false, updated_at = NOW()\n          WHERE user_id = ${userId}\n        `);\n        userMissedFlag = false;\n      } else if (!didPlayUserYesterday && !userYesterdayProtected && !didPlayUserToday && userCurrentStreak > 0 && !userMissedFlag && !holidayActive) {\n        // User had a streak, missed yesterday (and not protected by holiday), hasn't played today yet, and not on holiday - SET the flag!\n        await db.execute(sql`\n          UPDATE user_stats_user \n          SET missed_yesterday_flag_user = true, updated_at = NOW()\n          WHERE user_id = ${userId}\n        `);\n        userMissedFlag = true;\n      }\n      \n      // Determine if user can use streak saver (missed only yesterday, not multiple days)\n      // Can use streak saver if: missed yesterday flag is set AND won day before yesterday\n      const regionCanUseStreakSaver = regionMissedFlag && didWinRegionDayBeforeYesterday;\n      const userCanUseStreakSaver = userMissedFlag && didWinUserDayBeforeYesterday;\n      \n      // ========================================================================\n      // HOLIDAY VALIDATION: Check if streak is valid for holiday protection\n      // A streak is valid for holiday if: current_streak > 0 AND there's a puzzle\n      // with streak_day_status = 1 or 0 within the last 7 days\n      // ========================================================================\n      const sevenDaysAgo = new Date(today);\n      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);\n      const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];\n      \n      // Check for REGION mode: last puzzle with streak_day_status=1 or 0 within 7 days\n      const regionRecentStreakResult = await db.execute(sql`\n        SELECT qar.puzzle_date\n        FROM game_attempts_region ga\n        INNER JOIN questions_allocated_region qar ON ga.allocated_region_id = qar.id\n        WHERE ga.user_id = ${userId}\n          AND (ga.streak_day_status = 1 OR ga.streak_day_status = 0)\n          AND qar.puzzle_date >= ${sevenDaysAgoStr}\n        ORDER BY qar.puzzle_date DESC\n        LIMIT 1\n      `);\n      \n      const regionRecentStreakRows = Array.isArray(regionRecentStreakResult) ? regionRecentStreakResult : (regionRecentStreakResult as any).rows || [];\n      const hasRegionRecentStreakActivity = regionRecentStreakRows.length > 0;\n      \n      // Check for USER mode: last puzzle with streak_day_status=1 or 0 within 7 days\n      const userRecentStreakResult = await db.execute(sql`\n        SELECT qau.puzzle_date\n        FROM game_attempts_user ga\n        INNER JOIN questions_allocated_user qau ON ga.allocated_user_id = qau.id\n        WHERE ga.user_id = ${userId}\n          AND (ga.streak_day_status = 1 OR ga.streak_day_status = 0)\n          AND qau.puzzle_date >= ${sevenDaysAgoStr}\n        ORDER BY qau.puzzle_date DESC\n        LIMIT 1\n      `);\n      \n      const userRecentStreakRows = Array.isArray(userRecentStreakResult) ? userRecentStreakResult : (userRecentStreakResult as any).rows || [];\n      const hasUserRecentStreakActivity = userRecentStreakRows.length > 0;\n      \n      // Determine if each mode has a valid streak for holiday protection\n      let regionHasValidStreakForHoliday = regionCurrentStreak > 0 && hasRegionRecentStreakActivity;\n      let userHasValidStreakForHoliday = userCurrentStreak > 0 && hasUserRecentStreakActivity;\n      \n      // If a mode has current_streak > 0 but NO recent activity, reset the streak only\n      // Note: Keep missed_yesterday_flag intact to preserve streak-saver eligibility logic\n      if (regionCurrentStreak > 0 && !hasRegionRecentStreakActivity) {\n        console.log(`[getStreakSaverStatus] Region streak invalid (no activity in 7 days) - resetting to 0`);\n        await db.execute(sql`\n          UPDATE user_stats_region \n          SET current_streak = 0, updated_at = NOW()\n          WHERE user_id = ${userId}\n        `);\n        regionCurrentStreak = 0;\n        regionHasValidStreakForHoliday = false;\n      }\n      \n      if (userCurrentStreak > 0 && !hasUserRecentStreakActivity) {\n        console.log(`[getStreakSaverStatus] User streak invalid (no activity in 7 days) - resetting to 0`);\n        await db.execute(sql`\n          UPDATE user_stats_user \n          SET current_streak = 0, updated_at = NOW()\n          WHERE user_id = ${userId}\n        `);\n        userCurrentStreak = 0;\n        userHasValidStreakForHoliday = false;\n      }\n      \n      return {\n        region: {\n          currentStreak: regionCurrentStreak,\n          streakSaversUsedMonth: regionRow.streak_savers_used_month || 0,\n          missedYesterdayFlag: regionMissedFlag,\n          canUseStreakSaver: regionCanUseStreakSaver, // true only if missed just yesterday\n          hasValidStreakForHoliday: regionHasValidStreakForHoliday,\n        },\n        user: {\n          currentStreak: userCurrentStreak,\n          streakSaversUsedMonth: userRow.streak_savers_used_month || 0,\n          holidayActive: holidayActive,\n          holidayStartDate: userRow.holiday_start_date || null,\n          holidayEndDate: userRow.holiday_end_date || null,\n          holidayDaysTakenCurrentPeriod: userRow.holiday_days_taken_current_period || 0,\n          holidayEnded: userRow.holiday_ended || false,\n          missedYesterdayFlag: userMissedFlag,\n          holidaysUsedYear: userRow.holidays_used_year || 0,\n          canUseStreakSaver: userCanUseStreakSaver, // true only if missed just yesterday\n          hasValidStreakForHoliday: userHasValidStreakForHoliday,\n        }\n      };\n    } catch (error: any) {\n      console.error('[getStreakSaverStatus] Error:', error);\n      // Columns might not exist yet\n      if (error?.code === '42703' || error?.message?.includes('does not exist')) {\n        console.log('Note: Streak saver columns not available yet');\n        return null;\n      }\n      throw error;\n    }\n  }\n\n  async useStreakSaver(userId: string, gameType: 'region' | 'user', allowance: number): Promise<{ success: boolean; error?: string }> {\n    try {\n      const table = gameType === 'region' ? 'user_stats_region' : 'user_stats_user';\n      const flagColumn = gameType === 'region' ? 'missed_yesterday_flag_region' : 'missed_yesterday_flag_user';\n      \n      // Check current usage\n      const result = await db.execute(sql.raw(`\n        SELECT streak_savers_used_month, ${flagColumn}\n        FROM ${table}\n        WHERE user_id = '${userId}'\n      `));\n      \n      const rows = Array.isArray(result) ? result : (result as any).rows || [];\n      if (rows.length === 0) {\n        return { success: false, error: 'Stats not found for user' };\n      }\n      \n      const currentUsage = rows[0].streak_savers_used_month || 0;\n      const hasMissedFlag = rows[0][flagColumn] || false;\n      \n      if (!hasMissedFlag) {\n        return { success: false, error: 'No missed day to save' };\n      }\n      \n      if (currentUsage >= allowance) {\n        return { success: false, error: 'No streak savers remaining this month' };\n      }\n      \n      // Use the streak saver: increment usage and clear flag\n      await db.execute(sql.raw(`\n        UPDATE ${table}\n        SET \n          streak_savers_used_month = streak_savers_used_month + 1,\n          ${flagColumn} = false,\n          updated_at = NOW()\n        WHERE user_id = '${userId}'\n      `));\n      \n      console.log(`[useStreakSaver] User ${userId} used streak saver for ${gameType}`);\n      return { success: true };\n    } catch (error: any) {\n      console.error('[useStreakSaver] Error:', error);\n      return { success: false, error: error?.message || 'Failed to use streak saver' };\n    }\n  }\n\n  async startHoliday(userId: string, holidayDurationDays: number): Promise<{ success: boolean; error?: string }> {\n    try {\n      // Call Supabase RPC to activate holiday mode\n      // The RPC handles all validation, updates, and holiday event creation\n      const startDate = new Date().toISOString().split('T')[0];\n      \n      const result = await db.execute(sql`\n        SELECT activate_holiday_mode(${userId}::uuid, ${startDate}::date) as success\n      `);\n      \n      const rows = Array.isArray(result) ? result : (result as any).rows || [];\n      const success = rows[0]?.success ?? false;\n      \n      if (!success) {\n        console.log(`[startHoliday] RPC returned false for user ${userId}`);\n        return { success: false, error: 'Could not activate holiday mode' };\n      }\n      \n      console.log(`[startHoliday] User ${userId} started holiday via RPC`);\n      return { success: true };\n    } catch (error: any) {\n      console.error('[startHoliday] Error:', error);\n      return { success: false, error: error?.message || 'Failed to start holiday' };\n    }\n  }\n\n  async endHoliday(userId: string, acknowledge?: boolean): Promise<{ success: boolean; error?: string }> {\n    try {\n      // Call Supabase RPC to end holiday mode\n      // acknowledge=true is used when auto-ended by cron and user dismisses the popup\n      const ack = acknowledge ?? false;\n      \n      const result = await db.execute(sql`\n        SELECT end_holiday_mode(${userId}::uuid, ${ack}::boolean) as success\n      `);\n      \n      const rows = Array.isArray(result) ? result : (result as any).rows || [];\n      const success = rows[0]?.success ?? false;\n      \n      if (!success) {\n        console.log(`[endHoliday] RPC returned false for user ${userId}`);\n        return { success: false, error: 'Could not end holiday mode' };\n      }\n      \n      console.log(`[endHoliday] User ${userId} ended holiday via RPC (acknowledge=${ack})`);\n      return { success: true };\n    } catch (error: any) {\n      console.error('[endHoliday] Error:', error);\n      return { success: false, error: error?.message || 'Failed to end holiday' };\n    }\n  }\n\n  async countHolidayEventsThisYear(userId: string): Promise<number> {\n    try {\n      const startOfYear = new Date();\n      startOfYear.setMonth(0, 1);\n      startOfYear.setHours(0, 0, 0, 0);\n      \n      const result = await db.execute(sql`\n        SELECT COUNT(*) as count\n        FROM user_holiday_events\n        WHERE user_id = ${userId}\n          AND created_at >= ${startOfYear}\n      `);\n      \n      const rows = Array.isArray(result) ? result : (result as any).rows || [];\n      return parseInt(rows[0]?.count || '0', 10);\n    } catch (error: any) {\n      // Table might not exist yet - gracefully return 0\n      if (error?.code === '42P01') {\n        // Note: user_holiday_events table needs to be created in Supabase\n        return 0;\n      }\n      console.error('[countHolidayEventsThisYear] Error:', error);\n      throw error;\n    }\n  }\n\n  async insertHolidayEvent(userId: string, mode: 'region' | 'user', startedAt: Date, endedAt?: Date): Promise<void> {\n    try {\n      await db.execute(sql`\n        INSERT INTO user_holiday_events (user_id, mode, started_at, ended_at)\n        VALUES (${userId}, ${mode}, ${startedAt}, ${endedAt || null})\n      `);\n      console.log(`[insertHolidayEvent] Recorded holiday event for user ${userId}`);\n    } catch (error: any) {\n      console.error('[insertHolidayEvent] Error:', error);\n      // Table might not exist yet - that's okay\n      if (error?.code === '42P01') {\n        console.log('Note: user_holiday_events table not available yet');\n        return;\n      }\n      throw error;\n    }\n  }\n\n  async getHolidayAnimationData(userId: string): Promise<{\n    region: {\n      hasStreak: boolean;\n      todayStreakDayStatusZero: boolean;\n      holidayDates: string[];\n    };\n    user: {\n      hasStreak: boolean;\n      todayStreakDayStatusZero: boolean;\n      holidayDates: string[];\n    };\n  }> {\n    try {\n      const today = new Date();\n      const todayStr = today.toISOString().split('T')[0];\n      \n      // Get region streak\n      const regionStatsResult = await db.execute(sql`\n        SELECT current_streak FROM user_stats_region WHERE user_id = ${userId}\n      `);\n      const regionRows = Array.isArray(regionStatsResult) ? regionStatsResult : (regionStatsResult as any).rows || [];\n      const regionStreak = regionRows[0]?.current_streak || 0;\n      \n      // Get user streak\n      const userStatsResult = await db.execute(sql`\n        SELECT current_streak FROM user_stats_user WHERE user_id = ${userId}\n      `);\n      const userRows = Array.isArray(userStatsResult) ? userStatsResult : (userStatsResult as any).rows || [];\n      const userStreak = userRows[0]?.current_streak || 0;\n      \n      // Check if today's region puzzle has streak_day_status = 0\n      const regionTodayResult = await db.execute(sql`\n        SELECT ga.streak_day_status, qar.puzzle_date\n        FROM game_attempts_region ga\n        INNER JOIN questions_allocated_region qar ON ga.allocated_region_id = qar.id\n        WHERE ga.user_id = ${userId} AND qar.puzzle_date = ${todayStr}\n        LIMIT 1\n      `);\n      const regionTodayRows = Array.isArray(regionTodayResult) ? regionTodayResult : (regionTodayResult as any).rows || [];\n      const regionTodayStatus = regionTodayRows[0]?.streak_day_status;\n      const regionTodayZero = regionTodayStatus === 0;\n      \n      // Check if today's user puzzle has streak_day_status = 0\n      const userTodayResult = await db.execute(sql`\n        SELECT ga.streak_day_status, qau.puzzle_date\n        FROM game_attempts_user ga\n        INNER JOIN questions_allocated_user qau ON ga.allocated_user_id = qau.id\n        WHERE ga.user_id = ${userId} AND qau.puzzle_date = ${todayStr}\n        LIMIT 1\n      `);\n      const userTodayRows = Array.isArray(userTodayResult) ? userTodayResult : (userTodayResult as any).rows || [];\n      const userTodayStatus = userTodayRows[0]?.streak_day_status;\n      const userTodayZero = userTodayStatus === 0;\n      \n      // Get consecutive dates backwards with streak_day_status = 0 for region\n      // This gets all dates with streak_day_status = 0, ordered by date descending\n      const regionHolidayDatesResult = await db.execute(sql`\n        SELECT DISTINCT qar.puzzle_date::text AS puzzle_date\n        FROM game_attempts_region ga\n        INNER JOIN questions_allocated_region qar ON ga.allocated_region_id = qar.id\n        WHERE ga.user_id = ${userId} \n          AND ga.streak_day_status = 0\n          AND qar.puzzle_date <= ${todayStr}\n        ORDER BY puzzle_date DESC\n      `);\n      const regionHolidayRows = Array.isArray(regionHolidayDatesResult) ? regionHolidayDatesResult : (regionHolidayDatesResult as any).rows || [];\n      \n      // Filter to only consecutive dates starting from today\n      const regionHolidayDates: string[] = [];\n      let expectedDate = new Date(today);\n      for (const row of regionHolidayRows) {\n        const puzzleDate = row.puzzle_date;\n        const expectedStr = expectedDate.toISOString().split('T')[0];\n        if (puzzleDate === expectedStr) {\n          regionHolidayDates.push(puzzleDate);\n          expectedDate.setDate(expectedDate.getDate() - 1);\n        } else {\n          break; // Not consecutive, stop\n        }\n      }\n      \n      // Get consecutive dates backwards with streak_day_status = 0 for user\n      const userHolidayDatesResult = await db.execute(sql`\n        SELECT DISTINCT qau.puzzle_date::text AS puzzle_date\n        FROM game_attempts_user ga\n        INNER JOIN questions_allocated_user qau ON ga.allocated_user_id = qau.id\n        WHERE ga.user_id = ${userId} \n          AND ga.streak_day_status = 0\n          AND qau.puzzle_date <= ${todayStr}\n        ORDER BY puzzle_date DESC\n      `);\n      const userHolidayRows = Array.isArray(userHolidayDatesResult) ? userHolidayDatesResult : (userHolidayDatesResult as any).rows || [];\n      \n      // Filter to only consecutive dates starting from today\n      const userHolidayDates: string[] = [];\n      expectedDate = new Date(today);\n      for (const row of userHolidayRows) {\n        const puzzleDate = row.puzzle_date;\n        const expectedStr = expectedDate.toISOString().split('T')[0];\n        if (puzzleDate === expectedStr) {\n          userHolidayDates.push(puzzleDate);\n          expectedDate.setDate(expectedDate.getDate() - 1);\n        } else {\n          break; // Not consecutive, stop\n        }\n      }\n      \n      console.log('[getHolidayAnimationData] Result:', {\n        region: { hasStreak: regionStreak > 0, todayStreakDayStatusZero: regionTodayZero, holidayDates: regionHolidayDates },\n        user: { hasStreak: userStreak > 0, todayStreakDayStatusZero: userTodayZero, holidayDates: userHolidayDates }\n      });\n      \n      return {\n        region: {\n          hasStreak: regionStreak > 0,\n          todayStreakDayStatusZero: regionTodayZero,\n          holidayDates: regionHolidayDates,\n        },\n        user: {\n          hasStreak: userStreak > 0,\n          todayStreakDayStatusZero: userTodayZero,\n          holidayDates: userHolidayDates,\n        },\n      };\n    } catch (error: any) {\n      console.error('[getHolidayAnimationData] Error:', error);\n      // Return safe defaults on error\n      return {\n        region: { hasStreak: false, todayStreakDayStatusZero: false, holidayDates: [] },\n        user: { hasStreak: false, todayStreakDayStatusZero: false, holidayDates: [] },\n      };\n    }\n  }\n\n  // ========================================================================\n  // BADGE OPERATIONS\n  // ========================================================================\n\n  async getAllBadges(): Promise<Badge[]> {\n    try {\n      return await db.select().from(badges).orderBy(badges.category, badges.threshold);\n    } catch (error: any) {\n      console.error('[getAllBadges] Error:', error);\n      if (error?.code === '42P01') {\n        return [];\n      }\n      throw error;\n    }\n  }\n\n  async getBadgeById(badgeId: number): Promise<Badge | undefined> {\n    try {\n      const [badge] = await db.select().from(badges).where(eq(badges.id, badgeId));\n      return badge;\n    } catch (error: any) {\n      console.error('[getBadgeById] Error:', error);\n      return undefined;\n    }\n  }\n\n  async getBadgeByThreshold(category: string, threshold: number): Promise<Badge | undefined> {\n    try {\n      // Use case-insensitive comparison for category to handle variations in database\n      const [badge] = await db\n        .select()\n        .from(badges)\n        .where(and(\n          sql`LOWER(${badges.category}) = LOWER(${category})`,\n          eq(badges.threshold, threshold)\n        ));\n      return badge;\n    } catch (error: any) {\n      console.error('[getBadgeByThreshold] Error:', error);\n      return undefined;\n    }\n  }\n\n  async getUserBadges(\n    userId: string, \n    gameType: 'USER' | 'REGION', \n    region: string,\n    onlyAwarded: boolean = true\n  ): Promise<UserBadgeWithDetails[]> {\n    try {\n      const whereConditions = onlyAwarded\n        ? and(\n            eq(userBadges.userId, userId),\n            eq(userBadges.gameType, gameType),\n            eq(userBadges.region, region),\n            eq(userBadges.isAwarded, true)\n          )\n        : and(\n            eq(userBadges.userId, userId),\n            eq(userBadges.gameType, gameType),\n            eq(userBadges.region, region)\n          );\n\n      const results = await db\n        .select({\n          id: userBadges.id,\n          userId: userBadges.userId,\n          badgeId: userBadges.badgeId,\n          isAwarded: userBadges.isAwarded,\n          region: userBadges.region,\n          gameType: userBadges.gameType,\n          awardedAt: userBadges.awardedAt,\n          badge: {\n            id: badges.id,\n            name: badges.name,\n            category: badges.category,\n            threshold: badges.threshold,\n            iconUrl: badges.iconUrl,\n            createdAt: badges.createdAt,\n          },\n        })\n        .from(userBadges)\n        .innerJoin(badges, eq(userBadges.badgeId, badges.id))\n        .where(whereConditions)\n        .orderBy(badges.category, desc(badges.threshold));\n\n      return results as UserBadgeWithDetails[];\n    } catch (error: any) {\n      console.error('[getUserBadges] Error:', error);\n      if (error?.code === '42P01') {\n        return [];\n      }\n      throw error;\n    }\n  }\n\n  async getPendingBadges(\n    userId: string, \n    gameType: 'USER' | 'REGION', \n    region: string\n  ): Promise<UserBadgeWithDetails[]> {\n    try {\n      const results = await db\n        .select({\n          id: userBadges.id,\n          userId: userBadges.userId,\n          badgeId: userBadges.badgeId,\n          isAwarded: userBadges.isAwarded,\n          region: userBadges.region,\n          gameType: userBadges.gameType,\n          awardedAt: userBadges.awardedAt,\n          badge: {\n            id: badges.id,\n            name: badges.name,\n            category: badges.category,\n            threshold: badges.threshold,\n            iconUrl: badges.iconUrl,\n            createdAt: badges.createdAt,\n          },\n        })\n        .from(userBadges)\n        .innerJoin(badges, eq(userBadges.badgeId, badges.id))\n        .where(\n          and(\n            eq(userBadges.userId, userId),\n            eq(userBadges.gameType, gameType),\n            eq(userBadges.region, region),\n            eq(userBadges.isAwarded, false)\n          )\n        )\n        .orderBy(userBadges.awardedAt);\n\n      return results as UserBadgeWithDetails[];\n    } catch (error: any) {\n      console.error('[getPendingBadges] Error:', error);\n      if (error?.code === '42P01') {\n        return [];\n      }\n      throw error;\n    }\n  }\n\n  async markBadgeAwarded(userBadgeId: number): Promise<void> {\n    try {\n      await db\n        .update(userBadges)\n        .set({ isAwarded: true })\n        .where(eq(userBadges.id, userBadgeId));\n      console.log(`[markBadgeAwarded] Marked user badge ${userBadgeId} as awarded`);\n    } catch (error: any) {\n      console.error('[markBadgeAwarded] Error:', error);\n      throw error;\n    }\n  }\n\n  async awardBadge(\n    userId: string,\n    badgeId: number,\n    gameType: 'USER' | 'REGION',\n    region: string\n  ): Promise<UserBadge | null> {\n    try {\n      // Check if badge already exists for this user/gameType/region combination\n      // The unique constraint is on (user_id, badge_id, gameType, region)\n      // A user CAN have the same badge for different game types (USER vs REGION)\n      // A user CAN have the same badge for different regions in REGION game type\n      const existing = await db\n        .select()\n        .from(userBadges)\n        .where(\n          and(\n            eq(userBadges.userId, userId),\n            eq(userBadges.badgeId, badgeId),\n            eq(userBadges.gameType, gameType),\n            eq(userBadges.region, region)\n          )\n        );\n\n      if (existing.length > 0) {\n        console.log(`[awardBadge] Badge ${badgeId} already exists for user ${userId} in ${gameType}/${region}`);\n        return existing[0];\n      }\n\n      const [newBadge] = await db\n        .insert(userBadges)\n        .values({\n          userId,\n          badgeId,\n          gameType,\n          region,\n          isAwarded: false, // Will be marked true after popup shown\n        })\n        .returning();\n\n      console.log(`[awardBadge] Created new badge ${badgeId} for user ${userId} in ${gameType}/${region}`);\n      return newBadge;\n    } catch (error: any) {\n      // Handle duplicate key constraint violation gracefully\n      if (error?.code === '23505') {\n        console.log(`[awardBadge] Badge ${badgeId} already exists for user ${userId} in ${gameType}/${region} (duplicate key)`);\n        // Return existing badge with full constraint check\n        const existing = await db\n          .select()\n          .from(userBadges)\n          .where(\n            and(\n              eq(userBadges.userId, userId),\n              eq(userBadges.badgeId, badgeId),\n              eq(userBadges.gameType, gameType),\n              eq(userBadges.region, region)\n            )\n          );\n        return existing.length > 0 ? existing[0] : null;\n      }\n      console.error('[awardBadge] Error:', error);\n      if (error?.code === '42P01') {\n        return null;\n      }\n      throw error;\n    }\n  }\n\n  async getHighestBadgePerCategory(\n    userId: string,\n    gameType: 'USER' | 'REGION',\n    region: string\n  ): Promise<Record<string, UserBadgeWithDetails | null>> {\n    try {\n      const allBadges = await this.getUserBadges(userId, gameType, region, true);\n      \n      // Map database category names to result keys (case-insensitive)\n      const getCategoryKey = (category: string): string | null => {\n        const lower = category.toLowerCase();\n        if (lower === 'elementle in' || lower === 'elementle') return 'elementle';\n        if (lower === 'streak') return 'streak';\n        if (lower === 'percentile') return 'percentile';\n        return null;\n      };\n      \n      const result: Record<string, UserBadgeWithDetails | null> = {\n        elementle: null,\n        streak: null,\n        percentile: null,\n      };\n\n      for (const badge of allBadges) {\n        const dbCategory = badge.badge.category;\n        const resultKey = getCategoryKey(dbCategory);\n        \n        if (resultKey && resultKey in result) {\n          const current = result[resultKey];\n          if (!current) {\n            result[resultKey] = badge;\n          } else {\n            // For percentile, lower threshold is better (1% is better than 50%)\n            // For streak and elementle, higher threshold is better (30 streak > 7 streak)\n            if (resultKey === 'percentile') {\n              if (badge.badge.threshold < current.badge.threshold) {\n                result[resultKey] = badge;\n              }\n            } else {\n              if (badge.badge.threshold > current.badge.threshold) {\n                result[resultKey] = badge;\n              }\n            }\n          }\n        }\n      }\n\n      return result;\n    } catch (error: any) {\n      console.error('[getHighestBadgePerCategory] Error:', error);\n      return {\n        elementle: null,\n        streak: null,\n        percentile: null,\n      };\n    }\n  }\n\n  async checkAndAwardStreakBadge(\n    userId: string,\n    streak: number,\n    gameType: 'USER' | 'REGION',\n    region: string\n  ): Promise<UserBadgeWithDetails | null> {\n    try {\n      // Streak thresholds: 7, 14, 30, 50, 100, 150, 250, 365, 500, 750, 1000\n      const streakThresholds = [7, 14, 30, 50, 100, 150, 250, 365, 500, 750, 1000];\n      \n      // Find the highest threshold the user qualifies for\n      const qualifiedThreshold = streakThresholds.filter(t => streak >= t).pop();\n      \n      if (!qualifiedThreshold) {\n        return null; // No badge threshold reached\n      }\n\n      // Get the badge for this threshold (use exact category name from database)\n      const badge = await this.getBadgeByThreshold('Streak', qualifiedThreshold);\n      if (!badge) {\n        console.log(`[checkAndAwardStreakBadge] No Streak badge found for threshold ${qualifiedThreshold}`);\n        return null;\n      }\n\n      // Check if user already has this badge\n      const existingBadges = await this.getUserBadges(userId, gameType, region, false);\n      const hasBadge = existingBadges.some(ub => ub.badge.id === badge.id);\n      \n      if (hasBadge) {\n        return null; // Already has this badge\n      }\n\n      // Award the badge\n      const newBadge = await this.awardBadge(userId, badge.id, gameType, region);\n      if (newBadge) {\n        return {\n          ...newBadge,\n          badge,\n        };\n      }\n      return null;\n    } catch (error: any) {\n      console.error('[checkAndAwardStreakBadge] Error:', error);\n      return null;\n    }\n  }\n\n  async checkAndAwardElementleBadge(\n    userId: string,\n    guessCount: number,\n    gameType: 'USER' | 'REGION',\n    region: string\n  ): Promise<UserBadgeWithDetails | null> {\n    try {\n      // Elementle In thresholds: 1 or 2 guesses\n      if (guessCount !== 1 && guessCount !== 2) {\n        return null;\n      }\n\n      // Get the badge for this threshold (use exact category name from database)\n      const badge = await this.getBadgeByThreshold('Elementle In', guessCount);\n      if (!badge) {\n        console.log(`[checkAndAwardElementleBadge] No Elementle In badge found for threshold ${guessCount}`);\n        return null;\n      }\n\n      // Check if user already has this badge\n      const existingBadges = await this.getUserBadges(userId, gameType, region, false);\n      const hasBadge = existingBadges.some(ub => ub.badge.id === badge.id);\n      \n      if (hasBadge) {\n        return null; // Already has this badge\n      }\n\n      // Award the badge\n      const newBadge = await this.awardBadge(userId, badge.id, gameType, region);\n      if (newBadge) {\n        return {\n          ...newBadge,\n          badge,\n        };\n      }\n      return null;\n    } catch (error: any) {\n      console.error('[checkAndAwardElementleBadge] Error:', error);\n      return null;\n    }\n  }\n\n  async checkAndAwardPercentileBadge(\n    userId: string,\n    gameType: 'USER' | 'REGION',\n    region: string\n  ): Promise<UserBadgeWithDetails | null> {\n    try {\n      // Percentile badges are allocated by a monthly Supabase cron RPC.\n      // This function only checks for pending (is_awarded=FALSE) percentile badges\n      // that have already been allocated to the user, and returns them for display.\n      // It does NOT calculate or allocate new percentile badges.\n      \n      // Get pending (unawarded) badges for this user\n      const pendingBadges = await this.getUserBadges(userId, gameType, region, true);\n      \n      // Find any pending percentile badge\n      const pendingPercentileBadge = pendingBadges.find(\n        ub => ub.badge.category.toLowerCase() === 'percentile' && !ub.isAwarded\n      );\n      \n      if (!pendingPercentileBadge) {\n        return null; // No pending percentile badges\n      }\n      \n      return pendingPercentileBadge;\n    } catch (error: any) {\n      console.error('[checkAndAwardPercentileBadge] Error:', error);\n      return null;\n    }\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":146896,"size_tokens":null},"client/src/pages/Home.tsx":{"content":"import { useState, useEffect, useRef, useCallback } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { pageVariants, pageTransition } from \"@/lib/pageAnimations\";\nimport { WelcomePage } from \"@/components/WelcomePage\";\nimport { GameSelectionPage } from \"@/components/GameSelectionPage\";\nimport { PlayPage } from \"@/components/PlayPage\";\nimport { StatsPage } from \"@/components/StatsPage\";\nimport { ArchivePage } from \"@/components/ArchivePage\";\nimport { SettingsPage } from \"@/components/SettingsPage\";\nimport { OptionsPage } from \"@/components/OptionsPage\";\nimport { SplashScreen } from \"@/components/SplashScreen\";\nimport { OnboardingScreen } from \"@/components/OnboardingScreen\";\nimport AuthPage from \"@/components/AuthPage\";\nimport LoginPage from \"@/components/LoginPage\";\nimport ForgotPasswordPage from \"@/components/ForgotPasswordPage\";\nimport AccountInfoPage from \"@/components/AccountInfoPage\";\nimport { PrivacyPage } from \"@/components/PrivacyPage\";\nimport { TermsPage } from \"@/components/TermsPage\";\nimport { AboutPage } from \"@/components/AboutPage\";\nimport { BugReportForm } from \"@/components/BugReportForm\";\nimport { FeedbackForm } from \"@/components/FeedbackForm\";\nimport { GeneratingQuestionsScreen } from \"@/components/GeneratingQuestionsScreen\";\nimport PasswordResetScreen from \"@/components/PasswordResetScreen\";\nimport { usePasswordRecovery } from \"@/lib/SupabaseProvider\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useProfile } from \"@/hooks/useProfile\";\nimport { useGameData } from \"@/hooks/useGameData\";\nimport { useUserDateFormat } from \"@/hooks/useUserDateFormat\";\nimport { useGameMode } from \"@/contexts/GameModeContext\";\nimport { useSpinnerWithTimeout } from \"@/lib/SpinnerProvider\";\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient as sharedQueryClient } from \"@/lib/queryClient\";\nimport { clearUserCache } from \"@/lib/localCache\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { AdBanner, AdBannerContext } from \"@/components/AdBanner\";\nimport { useInterstitialAd } from \"@/components/InterstitialAd\";\nimport type { UserBadgeWithDetails } from \"@shared/schema\";\n\ntype Screen = \"splash\" | \"welcome\" | \"onboarding\" | \"login\" | \"signup\" | \"forgot-password\" | \"selection\" | \"play\" | \"stats\" | \"archive\" | \"settings\" | \"options\" | \"account-info\" | \"privacy\" | \"terms\" | \"about\" | \"bug-report\" | \"feedback\" | \"generating-questions\" | \"personalise\" | \"signing-out\";\n\ninterface Puzzle {\n  id: number;\n  date: string;\n  answerDateCanonical: string; // YYYY-MM-DD format - the canonical historical date\n  eventTitle: string;\n  eventDescription: string;\n  clue1?: string;\n  clue2?: string;\n  category?: string; // Only present in Local mode (user-specific puzzles)\n}\n\nexport default function Home() {\n  const { isAuthenticated, isLoading, user, hasCompletedFirstLogin, markFirstLoginCompleted, signOut } = useAuth();\n  const { isPasswordRecovery, clearPasswordRecovery } = usePasswordRecovery();\n  const { profile } = useProfile();\n  // Fetch BOTH global and local game attempts to avoid race conditions when switching modes\n  const { gameAttempts: globalGameAttempts, loadingAttempts: loadingGlobalAttempts } = useGameData({ modeOverride: 'global' });\n  const { gameAttempts: localGameAttempts, loadingAttempts: loadingLocalAttempts } = useGameData({ modeOverride: 'local' });\n  const { formatCanonicalDate } = useUserDateFormat();\n  const { isLocalMode, setGameMode } = useGameMode();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [currentScreen, setCurrentScreen] = useState<Screen>(\"splash\");\n  const [selectedPuzzleId, setSelectedPuzzleId] = useState<string | null>(null);\n  const [showSplash, setShowSplash] = useState(true);\n  const [previousScreen, setPreviousScreen] = useState<Screen>(\"selection\");\n  const [statsReturnScreen, setStatsReturnScreen] = useState<Screen>(\"selection\");\n  const [archiveReturnScreen, setArchiveReturnScreen] = useState<Screen>(\"selection\");\n  // Track if we're returning to PlayPage from Stats/Archive (to skip intro and show EndGameModal)\n  const [returningToPlay, setReturningToPlay] = useState(false);\n  const [statsGameType, setStatsGameType] = useState<'REGION' | 'USER'>('REGION');\n  const [showCelebrationFirst, setShowCelebrationFirst] = useState(false);\n  const [hasOpenedCelebration, setHasOpenedCelebration] = useState(false);\n  const [archiveMonthContext, setArchiveMonthContext] = useState<Date | null>(null);\n  const [hasExistingProgress, setHasExistingProgress] = useState(false);\n  const [needsFirstLoginSetup, setNeedsFirstLoginSetup] = useState(false);\n  const [showAuthButtons, setShowAuthButtons] = useState(false);\n  const [hasShownGeneratingScreen, setHasShownGeneratingScreen] = useState(false);\n  // Track which mode the puzzle was selected in (to prevent mode mismatch issues)\n  const [puzzleSourceMode, setPuzzleSourceMode] = useState<'global' | 'local'>('global');\n  // Track newly awarded badge for animation on stats page\n  const [newlyAwardedBadge, setNewlyAwardedBadge] = useState<UserBadgeWithDetails | null>(null);\n  // Track pending play navigation (waiting for data to load)\n  const [pendingPlayMode, setPendingPlayMode] = useState<'global' | 'local' | null>(null);\n  // Track pending yesterday puzzle navigation (for streak saver)\n  // NOTE: pendingYesterdayPuzzle state has been removed - streak saver now fetches directly from API\n  // Track directly-fetched streak saver puzzle (for yesterday's puzzle navigation)\n  const [streakSaverPuzzle, setStreakSaverPuzzle] = useState<Puzzle | null>(null);\n  // Track if we're loading the streak saver puzzle\n  const [loadingStreakSaverPuzzle, setLoadingStreakSaverPuzzle] = useState(false);\n  // Track if we should skip the intro screen (e.g., when coming from OnboardingScreen)\n  const [skipIntroForGuest, setSkipIntroForGuest] = useState(false);\n  // Track if guest is coming from EndGameModal (to show login subtitle)\n  const [showLoginSubtitle, setShowLoginSubtitle] = useState(false);\n  // Interstitial ad hook for guest play\n  const { showAd: showGuestAd, triggerAd: triggerGuestAd, handleClose: closeGuestAd, InterstitialAdComponent: GuestInterstitialAd } = useInterstitialAd();\n  // Track email used for signup from LoginPage (for personalise flow)\n  const [personaliseEmail, setPersonaliseEmail] = useState<string | null>(null);\n  // Track postcode and region from personalise step (for GeneratingQuestionsScreen)\n  const [personaliseData, setPersonaliseData] = useState<{ postcode?: string; region?: string } | null>(null);\n  // Track prefilled email for login screen (when returning from personalise)\n  const [loginPrefilledEmail, setLoginPrefilledEmail] = useState<string | null>(null);\n  // Track if we should show ProSubscriptionDialog due to canceled checkout\n  const [showProDialogFromCancel, setShowProDialogFromCancel] = useState(false);\n  \n  // Handle canceled subscription checkout from URL params\n  useEffect(() => {\n    const urlParams = new URLSearchParams(window.location.search);\n    const isCanceled = urlParams.get(\"canceled\") === \"true\";\n    \n    if (isCanceled) {\n      // Remove only the canceled param, preserve others\n      urlParams.delete(\"canceled\");\n      const newSearch = urlParams.toString();\n      const newUrl = \"/\" + (newSearch ? \"?\" + newSearch : \"\") + window.location.hash;\n      window.history.replaceState({}, document.title, newUrl);\n      \n      // Show failure toast\n      toast({\n        title: \"Subscription attempt failed\",\n        description: \"Please try again when you're ready.\",\n        variant: \"destructive\",\n      });\n      \n      // Trigger ProSubscriptionDialog when we reach selection screen\n      setShowProDialogFromCancel(true);\n    }\n  }, [toast]);\n  \n  // Fetch BOTH global and local puzzles to avoid race conditions when switching modes\n  const globalPuzzlesEndpoint = isAuthenticated ? '/api/puzzles' : '/api/puzzles/guest';\n  const localPuzzlesEndpoint = '/api/user/puzzles';\n  \n  const { data: globalPuzzles = [], isLoading: globalPuzzlesLoading, refetch: refetchGlobalPuzzles } = useQuery<Puzzle[]>({\n    queryKey: [globalPuzzlesEndpoint],\n  });\n  \n  const { data: localPuzzles = [], isLoading: localPuzzlesLoading, refetch: refetchLocalPuzzles } = useQuery<Puzzle[]>({\n    queryKey: [localPuzzlesEndpoint],\n    enabled: isAuthenticated, // Only fetch local puzzles for authenticated users\n  });\n  \n  // Use the current mode's puzzles for display (backward compatible)\n  const puzzles = isLocalMode ? localPuzzles : globalPuzzles;\n  const puzzlesLoading = isLocalMode ? localPuzzlesLoading : globalPuzzlesLoading;\n  const refetchPuzzles = isLocalMode ? refetchLocalPuzzles : refetchGlobalPuzzles;\n  \n  // Retry mechanism for missing puzzle data - handles case where realtime events were missed\n  const puzzleRetryCountRef = useRef(0);\n  const maxPuzzleRetries = 5;\n  const puzzleRetryDelayMs = 2000;\n  \n  useEffect(() => {\n    // Only retry for authenticated users when puzzle data is missing\n    if (!isAuthenticated) {\n      puzzleRetryCountRef.current = 0;\n      return;\n    }\n\n    const hasMissingData = puzzles.length === 0;\n    \n    if (hasMissingData && puzzleRetryCountRef.current < maxPuzzleRetries && !puzzlesLoading) {\n      const timer = setTimeout(() => {\n        console.log('[Home] Retrying puzzles fetch, attempt:', puzzleRetryCountRef.current + 1);\n        puzzleRetryCountRef.current++;\n        refetchPuzzles();\n      }, puzzleRetryDelayMs);\n      \n      return () => clearTimeout(timer);\n    }\n    \n    // Reset retry count when we have data\n    if (!hasMissingData) {\n      puzzleRetryCountRef.current = 0;\n    }\n  }, [isAuthenticated, puzzles.length, puzzlesLoading, refetchPuzzles]);\n\n  // Track if we've shown welcome page and auto-navigated to selection\n  const [hasAutoNavigated, setHasAutoNavigated] = useState(false);\n  \n  // Handle splash screen completion - route based on authentication status\n  const handleSplashComplete = useCallback(() => {\n    setShowSplash(false);\n    if (isAuthenticated) {\n      // Check if user has completed first login setup\n      if (!hasCompletedFirstLogin()) {\n        // User hasn't completed personalise screen - send them there\n        setNeedsFirstLoginSetup(true);\n        setHasShownGeneratingScreen(true);\n        setCurrentScreen(\"personalise\");\n      } else {\n        // Authenticated users with completed setup go to welcome page, then auto-navigate to selection\n        setCurrentScreen(\"welcome\");\n      }\n    } else {\n      // Non-authenticated users go to onboarding screen\n      setCurrentScreen(\"onboarding\");\n    }\n  }, [isAuthenticated, hasCompletedFirstLogin]);\n  \n  // Auto-navigate from welcome to selection after a brief display (2 seconds)\n  // Only auto-navigate if we're not showing auth buttons (after sign-out, we show buttons)\n  useEffect(() => {\n    if (currentScreen === \"welcome\" && !hasAutoNavigated && !showAuthButtons) {\n      const timer = setTimeout(() => {\n        setCurrentScreen(\"selection\");\n        setHasAutoNavigated(true);\n      }, 2000);\n      return () => clearTimeout(timer);\n    }\n  }, [currentScreen, hasAutoNavigated, showAuthButtons]);\n  \n  // Guard: Redirect authenticated users without first login to personalise screen\n  // This catches ALL navigation attempts and ensures users can't bypass personalise\n  // Protected screens include: selection, stats, archive, settings, options, account-info\n  // NOTE: \"play\" is NOT protected because guests can access it after watching an ad\n  // Skip guard if needsFirstLoginSetup is false (means user just completed setup in this session)\n  const protectedScreens: Screen[] = [\"selection\", \"stats\", \"archive\", \"settings\", \"options\", \"account-info\"];\n  useEffect(() => {\n    // Don't redirect if we're in the middle of setup or just completed it this session\n    // needsFirstLoginSetup=false after handleGeneratingQuestionsComplete runs means user finished setup\n    if (needsFirstLoginSetup === false && hasShownGeneratingScreen) {\n      // User completed setup this session - don't redirect even if metadata update is pending\n      return;\n    }\n    if (isAuthenticated && user && protectedScreens.includes(currentScreen)) {\n      if (!hasCompletedFirstLogin()) {\n        console.log('[Home] Guard: Redirecting to personalise - first login not completed');\n        setNeedsFirstLoginSetup(true);\n        setHasShownGeneratingScreen(true);\n        setCurrentScreen(\"personalise\");\n      }\n    }\n  }, [currentScreen, isAuthenticated, user, hasCompletedFirstLogin, needsFirstLoginSetup, hasShownGeneratingScreen]);\n  \n  // Guard: Redirect unauthenticated users on protected screens to OnboardingScreen\n  // This catches cases where the user is signed out while viewing a protected screen\n  // (e.g., session expired, signed out in another tab, etc.)\n  // Uses a debounce to avoid reacting to brief auth state changes during session refresh\n  const authGuardTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  \n  useEffect(() => {\n    // Always clear any pending timeout when effect re-runs or unmounts\n    // This MUST happen before any early returns to prevent stale timers\n    const clearPendingTimeout = () => {\n      if (authGuardTimeoutRef.current) {\n        console.log('[Home] Guard: Clearing pending timeout due to auth state change');\n        clearTimeout(authGuardTimeoutRef.current);\n        authGuardTimeoutRef.current = null;\n      }\n    };\n    \n    // Clear any pending timeout first\n    clearPendingTimeout();\n    \n    // Only check after initial loading is complete\n    if (isLoading) {\n      return clearPendingTimeout;\n    }\n    \n    // If user is authenticated, no action needed - just return cleanup\n    if (isAuthenticated) {\n      return clearPendingTimeout;\n    }\n    \n    // If user is not authenticated but is on a protected screen, wait a moment\n    // before redirecting to allow session refresh to complete\n    if (protectedScreens.includes(currentScreen)) {\n      console.log('[Home] Guard: User appears signed out on protected screen, waiting to confirm...');\n      \n      authGuardTimeoutRef.current = setTimeout(() => {\n        // Double-check auth state hasn't changed during the delay\n        // We can't access the latest isAuthenticated here due to closure,\n        // so we check if there's a session token in localStorage as a backup\n        const hasSessionToken = Object.keys(localStorage).some(key => \n          key.startsWith('sb-') && key.includes('-auth-token')\n        );\n        \n        if (hasSessionToken) {\n          console.log('[Home] Guard: Found session token, not redirecting');\n          return;\n        }\n        \n        console.log('[Home] Guard: User confirmed signed out, redirecting to onboarding');\n        // Clear any local state that might cause issues\n        clearUserCache();\n        sharedQueryClient.clear();\n        setCurrentScreen(\"onboarding\");\n      }, 2000); // Wait 2 seconds before redirecting\n    }\n    \n    return clearPendingTimeout;\n  }, [isAuthenticated, isLoading, currentScreen]);\n\n  // Scroll to top when screen changes\n  useEffect(() => {\n    window.scrollTo(0, 0);\n  }, [currentScreen]);\n\n  // Handle pending play navigation - waits for BOTH puzzles AND attempts to load before navigating\n  // This fixes the race condition where navigation happens before data is ready\n  useEffect(() => {\n    if (!pendingPlayMode) return;\n    \n    const modePuzzlesLoading = pendingPlayMode === 'local' ? localPuzzlesLoading : globalPuzzlesLoading;\n    const modeAttemptsLoading = pendingPlayMode === 'local' ? loadingLocalAttempts : loadingGlobalAttempts;\n    \n    // Derive \"data ready\" flags from loading states\n    // When loading is false, the query has completed and data is available (even if empty)\n    const puzzlesReady = !modePuzzlesLoading;\n    const attemptsReady = !isAuthenticated || !modeAttemptsLoading; // Guests don't need attempts\n    \n    // Wait for both puzzles AND attempts to finish loading\n    if (!puzzlesReady || !attemptsReady) {\n      console.log('[pendingPlayMode] Still waiting for data to load for mode:', pendingPlayMode, \n        '- puzzlesReady:', puzzlesReady, 'attemptsReady:', attemptsReady);\n      return;\n    }\n    \n    // Data is ready - compute completion status and navigate\n    console.log('[pendingPlayMode] Data loaded, proceeding with navigation for mode:', pendingPlayMode);\n    const mode = pendingPlayMode;\n    setPendingPlayMode(null); // Clear pending state\n    \n    // Get today's puzzle from the correct mode's puzzle list\n    const modePuzzles = mode === 'local' ? localPuzzles : globalPuzzles;\n    const todayDate = getTodayDateString();\n    const todayPuzzle = modePuzzles.find(p => p.date === todayDate);\n    \n    let isCompleted = false;\n    let hasProgress = false;\n    \n    if (todayPuzzle) {\n      const modeGameAttempts = mode === 'local' ? localGameAttempts : globalGameAttempts;\n      \n      if (isAuthenticated && modeGameAttempts) {\n        const existingAttempt = modeGameAttempts.find(\n          attempt => attempt.puzzleId === todayPuzzle.id\n        );\n        if (existingAttempt) {\n          isCompleted = existingAttempt.result !== null && existingAttempt.result !== undefined;\n          hasProgress = isCompleted || (existingAttempt.numGuesses ?? 0) > 0;\n        }\n      } else if (!isAuthenticated) {\n        const storedStats = localStorage.getItem(\"elementle-stats\");\n        if (storedStats) {\n          const stats = JSON.parse(storedStats);\n          const formattedAnswer = formatCanonicalDate(todayPuzzle.answerDateCanonical);\n          const completion = stats.puzzleCompletions?.[formattedAnswer];\n          isCompleted = !!(completion && completion.completed);\n          hasProgress = isCompleted;\n        }\n        const inProgressKey = `puzzle-progress-${formatCanonicalDate(todayPuzzle.answerDateCanonical)}`;\n        const savedProgress = localStorage.getItem(inProgressKey);\n        if (savedProgress) {\n          const progress = JSON.parse(savedProgress);\n          if (progress.guessRecords && progress.guessRecords.length > 0) {\n            hasProgress = true;\n          }\n        }\n      }\n    }\n    \n    if (isCompleted) {\n      setShowCelebrationFirst(true);\n      setHasOpenedCelebration(false);\n    } else {\n      setShowCelebrationFirst(false);\n      setHasOpenedCelebration(false);\n    }\n    \n    setHasExistingProgress(hasProgress);\n    setSelectedPuzzleId(null);\n    setPreviousScreen(\"selection\");\n    setCurrentScreen(\"play\");\n  }, [pendingPlayMode, localPuzzlesLoading, globalPuzzlesLoading, loadingLocalAttempts, loadingGlobalAttempts, localPuzzles, globalPuzzles, localGameAttempts, globalGameAttempts, isAuthenticated]);\n\n  // NOTE: The old pendingYesterdayPuzzle useEffect has been removed.\n  // Streak saver navigation now fetches yesterday's puzzle directly from the API\n  // in handlePlayYesterdaysPuzzle, which is more reliable than finding it in the cached list.\n\n  // Helper to get today's date string\n  const getTodayDateString = () => {\n    const today = new Date();\n    const year = today.getFullYear();\n    const month = String(today.getMonth() + 1).padStart(2, '0');\n    const day = String(today.getDate()).padStart(2, '0');\n    return `${year}-${month}-${day}`;\n  };\n\n  // Get daily puzzle - uses context mode for display, explicit mode for game logic\n  const getDailyPuzzle = (mode?: 'global' | 'local'): Puzzle | undefined => {\n    // Use explicit mode if provided, otherwise fall back to context mode\n    const puzzleList = mode \n      ? (mode === 'local' ? localPuzzles : globalPuzzles)\n      : puzzles;\n    \n    if (puzzleList.length === 0) return undefined;\n    \n    const todayDate = getTodayDateString();\n    \n    // Try to find today's puzzle - return undefined if no puzzle for today\n    // This ensures the Play button is disabled when there's no puzzle available\n    return puzzleList.find(p => p.date === todayDate);\n  };\n\n  // Get puzzle by ID from the appropriate mode's puzzle list\n  const getPuzzleById = (puzzleId: string, mode: 'global' | 'local'): Puzzle | undefined => {\n    const puzzleList = mode === 'local' ? localPuzzles : globalPuzzles;\n    return puzzleList.find(p => p.id.toString() === puzzleId);\n  };\n\n  // Current puzzle for PlayPage - uses puzzleSourceMode to ensure correct mode's data\n  // Priority: 1. Streak saver puzzle (fetched directly), 2. Puzzle from list by ID, 3. Daily puzzle\n  const currentPuzzle = selectedPuzzleId \n    ? (streakSaverPuzzle && streakSaverPuzzle.id.toString() === selectedPuzzleId \n        ? streakSaverPuzzle \n        : getPuzzleById(selectedPuzzleId, puzzleSourceMode)) || getDailyPuzzle(puzzleSourceMode)\n    : getDailyPuzzle(puzzleSourceMode);\n\n  const handlePlayPuzzle = (puzzleId: string) => {\n    // Capture the current mode when the puzzle is selected\n    // This ensures PlayPage uses the correct mode for data fetching\n    const mode = isLocalMode ? 'local' : 'global';\n    \n    // Use the explicit mode's puzzle list (not context mode - avoids race condition)\n    const puzzle = getPuzzleById(puzzleId, mode);\n    if (!puzzle) return;\n    \n    console.log('[handlePlayPuzzle] Setting puzzleSourceMode:', mode, 'for puzzleId:', puzzleId);\n    setPuzzleSourceMode(mode);\n    \n    // Check if this puzzle has any existing progress (completed or in-progress)\n    let isCompleted = false;\n    let hasProgress = false;\n    \n    // Use the explicit mode's game attempts (based on captured mode)\n    const modeGameAttempts = mode === 'local' ? localGameAttempts : globalGameAttempts;\n    const modeLoadingAttempts = mode === 'local' ? loadingLocalAttempts : loadingGlobalAttempts;\n    \n    if (isAuthenticated && !modeLoadingAttempts && modeGameAttempts) {\n      // For authenticated users, check Supabase data\n      const numericPuzzleId = parseInt(puzzleId);\n      const existingAttempt = modeGameAttempts.find(\n        attempt => attempt.puzzleId === numericPuzzleId\n      );\n      if (existingAttempt) {\n        isCompleted = existingAttempt.result !== null && existingAttempt.result !== undefined;\n        hasProgress = isCompleted || (existingAttempt.numGuesses ?? 0) > 0;\n      }\n    } else if (!isAuthenticated) {\n      // For guest users, check localStorage\n      const storedStats = localStorage.getItem(\"elementle-stats\");\n      if (storedStats) {\n        const stats = JSON.parse(storedStats);\n        // Format the canonical date to match the key format used in localStorage\n        const formattedAnswer = formatCanonicalDate(puzzle.answerDateCanonical);\n        const completion = stats.puzzleCompletions?.[formattedAnswer];\n        isCompleted = !!(completion && completion.completed);\n        hasProgress = isCompleted;\n      }\n      // Also check for in-progress games in localStorage\n      const inProgressKey = `puzzle-progress-${formatCanonicalDate(puzzle.answerDateCanonical)}`;\n      const savedProgress = localStorage.getItem(inProgressKey);\n      if (savedProgress) {\n        const progress = JSON.parse(savedProgress);\n        if (progress.guessRecords && progress.guessRecords.length > 0) {\n          hasProgress = true;\n        }\n      }\n    }\n    \n    if (isCompleted) {\n      // Show game screen first, then celebration\n      setShowCelebrationFirst(true);\n      setHasOpenedCelebration(false);\n    } else {\n      setShowCelebrationFirst(false);\n      setHasOpenedCelebration(false);\n    }\n    \n    setHasExistingProgress(hasProgress);\n    setSelectedPuzzleId(puzzleId);\n    setPreviousScreen(\"archive\");\n    setCurrentScreen(\"play\");\n  };\n  \n  // Version of handlePlayToday that takes explicit mode to avoid race conditions\n  // This is called by handlePlayGlobal/handlePlayLocal where mode is already set\n  const handlePlayTodayWithMode = (mode: 'global' | 'local') => {\n    // Always set puzzleSourceMode explicitly\n    setPuzzleSourceMode(mode);\n    \n    // Check if the mode's data is still loading\n    const modePuzzlesLoading = mode === 'local' ? localPuzzlesLoading : globalPuzzlesLoading;\n    const modeAttemptsLoading = mode === 'local' ? loadingLocalAttempts : loadingGlobalAttempts;\n    const dataLoading = modePuzzlesLoading || modeAttemptsLoading;\n    \n    if (dataLoading) {\n      // Data still loading - set pending state and let useEffect handle navigation when ready\n      console.log('[handlePlayTodayWithMode] Data still loading, setting pending mode:', mode);\n      setPendingPlayMode(mode);\n      return;\n    }\n    \n    // Data is ready - compute completion status and navigate immediately\n    console.log('[handlePlayTodayWithMode] Data ready, computing completion for mode:', mode);\n    \n    // Get today's puzzle from the correct mode's puzzle list (using explicit mode)\n    const todayPuzzle = getDailyPuzzle(mode);\n    \n    let isCompleted = false;\n    let hasProgress = false;\n    \n    if (todayPuzzle) {\n      // Use the explicit mode's game attempts (not context mode - avoids race condition)\n      const modeGameAttempts = mode === 'local' ? localGameAttempts : globalGameAttempts;\n      \n      if (isAuthenticated && modeGameAttempts) {\n        // For authenticated users, check Supabase data\n        const existingAttempt = modeGameAttempts.find(\n          attempt => attempt.puzzleId === todayPuzzle.id\n        );\n        if (existingAttempt) {\n          isCompleted = existingAttempt.result !== null && existingAttempt.result !== undefined;\n          hasProgress = isCompleted || (existingAttempt.numGuesses ?? 0) > 0;\n        }\n      } else if (!isAuthenticated) {\n        // For guest users, check localStorage\n        const storedStats = localStorage.getItem(\"elementle-stats\");\n        if (storedStats) {\n          const stats = JSON.parse(storedStats);\n          // Format canonical date to match the key format used in localStorage\n          const formattedAnswer = formatCanonicalDate(todayPuzzle.answerDateCanonical);\n          const completion = stats.puzzleCompletions?.[formattedAnswer];\n          isCompleted = !!(completion && completion.completed);\n          hasProgress = isCompleted;\n        }\n        // Also check for in-progress games in localStorage\n        const inProgressKey = `puzzle-progress-${formatCanonicalDate(todayPuzzle.answerDateCanonical)}`;\n        const savedProgress = localStorage.getItem(inProgressKey);\n        if (savedProgress) {\n          const progress = JSON.parse(savedProgress);\n          if (progress.guessRecords && progress.guessRecords.length > 0) {\n            hasProgress = true;\n          }\n        }\n      }\n    }\n    \n    if (isCompleted) {\n      setShowCelebrationFirst(true);\n      setHasOpenedCelebration(false);\n    } else {\n      setShowCelebrationFirst(false);\n      setHasOpenedCelebration(false);\n    }\n    \n    setHasExistingProgress(hasProgress);\n    setSelectedPuzzleId(null);\n    setPreviousScreen(\"selection\");\n    setCurrentScreen(\"play\");\n  };\n  \n  // Global mode handlers (always use region data)\n  const handlePlayGlobal = (skipIntroFromOnboarding?: boolean) => {\n    console.log('[handlePlayGlobal] Setting mode to global explicitly');\n    setGameMode('global');\n    // CRITICAL: Explicitly set puzzleSourceMode to 'global' BEFORE calling handlePlayToday\n    // This avoids race condition where isLocalMode still has old value from context\n    setPuzzleSourceMode('global');\n    // Only set skipIntro if explicitly requested (from onboarding)\n    // Reset to false for normal plays from GameSelectionPage\n    if (!skipIntroFromOnboarding) {\n      setSkipIntroForGuest(false);\n    }\n    handlePlayTodayWithMode('global');\n  };\n\n  const handleStatsGlobal = () => {\n    setGameMode('global');\n    setStatsGameType('REGION');\n    setStatsReturnScreen(\"selection\");\n    setCurrentScreen(\"stats\");\n  };\n\n  const handleArchiveGlobal = () => {\n    setGameMode('global');\n    setArchiveReturnScreen(\"selection\");\n    setCurrentScreen(\"archive\");\n  };\n\n  const handleOptionsGlobal = () => {\n    setGameMode('global');\n    setPreviousScreen(\"selection\");\n    setCurrentScreen(\"options\");\n  };\n\n  // Local mode handlers (always use user data)\n  const handlePlayLocal = () => {\n    console.log('[handlePlayLocal] Setting mode to local explicitly');\n    setGameMode('local');\n    // CRITICAL: Explicitly set puzzleSourceMode to 'local' BEFORE calling handlePlayToday\n    // This avoids race condition where isLocalMode still has old value from context\n    setPuzzleSourceMode('local');\n    // Reset skipIntro flag for local mode plays (onboarding only supports global)\n    setSkipIntroForGuest(false);\n    handlePlayTodayWithMode('local');\n  };\n\n  const handleStatsLocal = () => {\n    setGameMode('local');\n    setStatsGameType('USER');\n    setStatsReturnScreen(\"selection\");\n    setCurrentScreen(\"stats\");\n  };\n\n  const handleArchiveLocal = () => {\n    setGameMode('local');\n    setArchiveReturnScreen(\"selection\");\n    setCurrentScreen(\"archive\");\n  };\n\n  const handleOptionsLocal = () => {\n    setGameMode('local');\n    setPreviousScreen(\"selection\");\n    setCurrentScreen(\"options\");\n  };\n  \n  // Handle playing yesterday's puzzle for streak saver flow\n  const handlePlayYesterdaysPuzzle = async (gameType: \"region\" | \"user\", puzzleDate: string) => {\n    // Determine the explicit mode from game type\n    const mode = gameType === 'region' ? 'global' : 'local';\n    \n    // Set the appropriate game mode\n    setGameMode(mode);\n    setPuzzleSourceMode(mode);\n    \n    console.log('[handlePlayYesterdaysPuzzle] Fetching puzzle for date:', puzzleDate, 'mode:', mode);\n    \n    // Show loading state\n    setLoadingStreakSaverPuzzle(true);\n    \n    try {\n      // Fetch yesterday's puzzle directly from the API (it may not be in the normal puzzle list)\n      const endpoint = mode === 'local' \n        ? `/api/user/puzzles/${puzzleDate}` \n        : `/api/puzzles/${puzzleDate}`;\n      \n      const response = await apiRequest(\"GET\", endpoint);\n      \n      if (!response.ok) {\n        throw new Error(\"Puzzle not found\");\n      }\n      \n      const yesterdayPuzzle = await response.json() as Puzzle;\n      \n      console.log('[handlePlayYesterdaysPuzzle] Fetched puzzle:', yesterdayPuzzle.id, yesterdayPuzzle.eventTitle);\n      \n      // Store the fetched puzzle and navigate\n      setStreakSaverPuzzle(yesterdayPuzzle);\n      setSelectedPuzzleId(yesterdayPuzzle.id.toString());\n      setShowCelebrationFirst(false);\n      setHasOpenedCelebration(false);\n      setHasExistingProgress(false);\n      setPreviousScreen(\"selection\");\n      setCurrentScreen(\"play\");\n    } catch (error) {\n      console.error('[handlePlayYesterdaysPuzzle] Error fetching puzzle:', error);\n      toast({\n        title: \"Puzzle not available\",\n        description: \"Yesterday's puzzle could not be loaded. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoadingStreakSaverPuzzle(false);\n    }\n  };\n  \n  // Handle login success - check if user needs first login setup\n  const handleLoginSuccess = () => {\n    // Reset skip intro flag when logging in\n    setSkipIntroForGuest(false);\n    if (isAuthenticated && !hasCompletedFirstLogin()) {\n      // User hasn't completed first login - redirect to personalise screen\n      // They must complete the personalise flow before accessing the app\n      console.log('[handleLoginSuccess] Redirecting to personalise - first login not completed');\n      setNeedsFirstLoginSetup(true);\n      setHasShownGeneratingScreen(true);\n      setCurrentScreen(\"personalise\");\n    } else {\n      setCurrentScreen(\"selection\");\n    }\n  };\n  \n  // Handle completion of GeneratingQuestionsScreen (from first login)\n  const handleGeneratingQuestionsComplete = async () => {\n    await markFirstLoginCompleted();\n    setNeedsFirstLoginSetup(false);\n    setCurrentScreen(\"selection\");\n  };\n  \n  // Track spinner state for auth loading\n  const authSpinnerShownRef = useRef(false);\n  \n  // Auth loading spinner timeout callbacks\n  const handleAuthRetry = useCallback(() => {\n    console.log('[Home] Auth spinner timeout - page will reload for retry');\n  }, []);\n  \n  const handleAuthTimeout = useCallback(() => {\n    console.log('[Home] Auth spinner timeout - failed to load');\n    toast({\n      title: 'Failed to load',\n      description: 'Please try again in a bit.',\n      variant: 'destructive',\n    });\n    window.location.reload();\n  }, [toast]);\n  \n  // Spinner with timeout for auth loading\n  const authSpinner = useSpinnerWithTimeout({\n    retryDelayMs: 4000,\n    timeoutMs: 8000,\n    onRetry: handleAuthRetry,\n    onTimeout: handleAuthTimeout,\n  });\n  \n  // Puzzle loading spinner timeout callbacks\n  const handlePuzzleRetry = useCallback(() => {\n    console.log('[Home] Puzzle spinner timeout - triggering retry');\n    refetchPuzzles();\n  }, [refetchPuzzles]);\n  \n  const handlePuzzleTimeout = useCallback(() => {\n    console.log('[Home] Puzzle spinner timeout - failed to load');\n    toast({\n      title: 'Failed to load',\n      description: 'Please try again in a bit.',\n      variant: 'destructive',\n    });\n    setCurrentScreen(\"selection\");\n  }, [toast]);\n  \n  // Spinner with timeout for puzzle loading\n  const puzzleSpinner = useSpinnerWithTimeout({\n    retryDelayMs: 4000,\n    timeoutMs: 8000,\n    onRetry: handlePuzzleRetry,\n    onTimeout: handlePuzzleTimeout,\n  });\n  \n  // Sign out spinner callbacks - must be stable across renders\n  const handleSignOutComplete = useCallback(() => {\n    console.log('[Home] Sign out complete - navigating to onboarding');\n    // Reset first login tracking flags on sign out to prevent bypass\n    setNeedsFirstLoginSetup(false);\n    setHasShownGeneratingScreen(false);\n    setShowAuthButtons(true);\n    setCurrentScreen(\"onboarding\");\n  }, []);\n  \n  const handleSignOutTimeout = useCallback(() => {\n    console.log('[Home] Sign out timeout - forcing navigation to splash');\n    setShowAuthButtons(true);\n    setCurrentScreen(\"splash\");\n  }, []);\n  \n  // Sign out spinner - shows hamster animation during sign out\n  // Use refs to store the spinner methods to avoid effect dependency issues\n  const signOutSpinnerRef = useRef<{ start: (delay?: number) => void; complete: () => void; cancel: () => void } | null>(null);\n  \n  const signOutSpinner = useSpinnerWithTimeout({\n    retryDelayMs: 10000, // Long retry since we don't need retries\n    timeoutMs: 8000, // Timeout after 8 seconds as safety net\n    onFadeOutComplete: handleSignOutComplete,\n    onTimeout: handleSignOutTimeout,\n  });\n  \n  // Keep ref updated with latest spinner methods\n  signOutSpinnerRef.current = signOutSpinner;\n  \n  // Track sign out spinner state\n  const signOutSpinnerShownRef = useRef(false);\n  \n  // Manage sign out spinner - use ref to avoid dependency on signOutSpinner object\n  useEffect(() => {\n    if (currentScreen === \"signing-out\" && !signOutSpinnerShownRef.current) {\n      signOutSpinnerShownRef.current = true;\n      signOutSpinnerRef.current?.start(0); // No delay, show immediately\n      \n      // After minimum display time, complete the spinner\n      const timer = setTimeout(() => {\n        signOutSpinnerRef.current?.complete();\n        signOutSpinnerShownRef.current = false;\n      }, 1500); // Show spinner for 1.5 seconds\n      \n      return () => clearTimeout(timer);\n    }\n  }, [currentScreen]);\n  \n  // Show spinner during auth loading - with 150ms delay to avoid flash on fast loads\n  useEffect(() => {\n    if (isLoading && !authSpinnerShownRef.current) {\n      authSpinner.start(150);\n      authSpinnerShownRef.current = true;\n    } else if (!isLoading && authSpinnerShownRef.current) {\n      authSpinner.complete();\n      authSpinnerShownRef.current = false;\n    }\n  }, [isLoading, authSpinner]);\n  \n  // Track puzzle spinner state\n  const puzzleSpinnerShownRef = useRef(false);\n  \n  // Manage puzzle loading spinner when on play screen without puzzle\n  useEffect(() => {\n    const isPuzzleLoading = currentScreen === \"play\" && !currentPuzzle;\n    \n    if (isPuzzleLoading && !puzzleSpinnerShownRef.current) {\n      puzzleSpinner.start(150);\n      puzzleSpinnerShownRef.current = true;\n    } else if (!isPuzzleLoading && puzzleSpinnerShownRef.current) {\n      puzzleSpinner.complete();\n      puzzleSpinnerShownRef.current = false;\n    }\n  }, [currentScreen, currentPuzzle, puzzleSpinner]);\n\n  // While auth is loading, show minimal loading state (spinner overlay handles the visual)\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen\" data-testid=\"auth-loading\" />\n    );\n  }\n\n  // Show password reset screen if user came from a recovery link\n  if (isPasswordRecovery) {\n    return (\n      <AdBannerContext.Provider value={false}>\n        <PasswordResetScreen \n          onSuccess={() => {\n            // After password reset, clear recovery state and go to selection\n            clearPasswordRecovery();\n            setCurrentScreen(\"selection\");\n          }} \n        />\n      </AdBannerContext.Provider>\n    );\n  }\n\n  if (showSplash) {\n    return (\n      <AdBannerContext.Provider value={false}>\n        <SplashScreen onComplete={handleSplashComplete} />\n      </AdBannerContext.Provider>\n    );\n  }\n\n  // Screens where ad banner should never appear (splash, welcome, onboarding, play/intro, login, signup, forgot-password, generating-questions)\n  const hideAdOnScreens: Screen[] = [\"splash\", \"welcome\", \"onboarding\", \"play\", \"login\", \"signup\", \"forgot-password\", \"generating-questions\", \"signing-out\", \"personalise\"];\n  const shouldShowAd = !hideAdOnScreens.includes(currentScreen);\n\n  return (\n    <AdBannerContext.Provider value={shouldShowAd}>\n      <div className=\"relative w-full min-h-screen bg-background\">\n        <AnimatePresence mode=\"popLayout\">\n        {currentScreen === \"welcome\" && (\n          <motion.div key=\"welcome\" className=\"w-full\" {...pageVariants.fadeIn} transition={pageTransition}>\n            <WelcomePage \n              onLogin={() => {\n                setShowAuthButtons(false);\n                setCurrentScreen(\"login\");\n              }}\n              onSignup={() => {\n                setShowAuthButtons(false);\n                setCurrentScreen(\"signup\");\n              }}\n              onContinueAsGuest={() => {\n                setShowAuthButtons(false);\n                setCurrentScreen(\"selection\");\n              }}\n              showAuthButtons={showAuthButtons}\n            />\n          </motion.div>\n        )}\n\n        {currentScreen === \"onboarding\" && (\n          <motion.div key=\"onboarding\" className=\"w-full\" {...pageVariants.fadeIn} transition={pageTransition}>\n            <OnboardingScreen\n              eventTitle={getDailyPuzzle('global')?.eventTitle || \"Loading...\"}\n              puzzleDateCanonical={getDailyPuzzle('global')?.date || getTodayDateString()}\n              onPlay={async () => {\n                // Guest user wants to play - clear any cached account creation data first\n                setPersonaliseEmail(null);\n                setLoginPrefilledEmail(null);\n                setPersonaliseData(null);\n                \n                // If user is authenticated (started account creation but wants to play as guest),\n                // sign them out first to play as a true guest\n                if (isAuthenticated) {\n                  try {\n                    await signOut();\n                    clearUserCache();\n                    queryClient.clear();\n                    console.log('[Home] Signed out user to play as guest from onboarding');\n                  } catch (error) {\n                    console.error('[Home] Error signing out for guest play:', error);\n                  }\n                }\n                \n                // Show interstitial ad first, then proceed\n                // Also skip the intro screen since they just saw puzzle info on onboarding\n                triggerGuestAd(() => {\n                  setSkipIntroForGuest(true);\n                  handlePlayGlobal(true); // Pass true to indicate skipIntro from onboarding\n                });\n              }}\n              onLogin={() => {\n                setSkipIntroForGuest(false); // Reset skip flag when not going to play\n                setShowLoginSubtitle(false);\n                setCurrentScreen(\"login\");\n              }}\n              onSubscribe={() => {\n                setSkipIntroForGuest(false); // Reset skip flag when not going to play\n                setCurrentScreen(\"signup\");\n              }}\n            />\n          </motion.div>\n        )}\n\n        {currentScreen === \"login\" && (\n          <motion.div key=\"login\" className=\"w-full\" {...pageVariants.fadeIn} transition={pageTransition}>\n            <LoginPage \n              onSuccess={() => {\n                setShowLoginSubtitle(false);\n                setLoginPrefilledEmail(null);\n                handleLoginSuccess();\n              }}\n              onBack={() => {\n                setShowLoginSubtitle(false);\n                setLoginPrefilledEmail(null);\n                setPersonaliseEmail(null);\n                setPersonaliseData(null);\n                setCurrentScreen(\"onboarding\");\n              }}\n              onSignup={() => {\n                setShowLoginSubtitle(false);\n                setLoginPrefilledEmail(null);\n                setCurrentScreen(\"signup\");\n              }}\n              onForgotPassword={() => {\n                setShowLoginSubtitle(false);\n                setCurrentScreen(\"forgot-password\");\n              }}\n              onPersonalise={(email) => {\n                setShowLoginSubtitle(false);\n                setLoginPrefilledEmail(null);\n                setPersonaliseEmail(email);\n                setCurrentScreen(\"personalise\");\n              }}\n              subtitle={showLoginSubtitle ? \"Sign up to track your stats, play personalised games and discover endless history in the archives.\" : undefined}\n              prefilledEmail={loginPrefilledEmail || undefined}\n            />\n          </motion.div>\n        )}\n\n        {currentScreen === \"signup\" && (\n          <motion.div key=\"signup\" className=\"w-full\" {...pageVariants.fadeIn} transition={pageTransition}>\n            <AuthPage \n              mode=\"signup\"\n              onSuccess={() => setCurrentScreen(\"selection\")}\n              onSwitchMode={() => setCurrentScreen(\"login\")}\n              onBack={() => setCurrentScreen(\"onboarding\")}\n              onContinueAsGuest={() => setCurrentScreen(\"selection\")}\n            />\n          </motion.div>\n        )}\n\n        {currentScreen === \"personalise\" && (\n          <motion.div key=\"personalise\" className=\"w-full\" {...pageVariants.fadeIn} transition={pageTransition}>\n            <AuthPage \n              mode=\"personalise\"\n              prefilledEmail={personaliseEmail || undefined}\n              onSuccess={(data) => {\n                setPersonaliseEmail(null);\n                if (data) {\n                  setPersonaliseData(data);\n                }\n                setCurrentScreen(\"generating-questions\");\n              }}\n              onSwitchMode={() => setCurrentScreen(\"login\")}\n              onBack={() => setCurrentScreen(\"login\")}\n              onReturnToLogin={() => {\n                // Keep the email for login screen prefill\n                setLoginPrefilledEmail(personaliseEmail);\n                setCurrentScreen(\"login\");\n              }}\n            />\n          </motion.div>\n        )}\n\n        {currentScreen === \"forgot-password\" && (\n          <motion.div key=\"forgot-password\" className=\"absolute w-full top-0 left-0\" {...pageVariants.slideRight} transition={pageTransition}>\n            <ForgotPasswordPage \n              onBack={() => setCurrentScreen(\"login\")}\n            />\n          </motion.div>\n        )}\n\n        {currentScreen === \"generating-questions\" && user && (\n          <motion.div key=\"generating-questions\" className=\"w-full\" {...pageVariants.fadeIn} transition={pageTransition}>\n            <GeneratingQuestionsScreen\n              userId={user.id}\n              region={personaliseData?.region || profile?.region || \"GB\"}\n              postcode={personaliseData?.postcode || profile?.postcode || \"\"}\n              onComplete={() => {\n                setPersonaliseData(null);\n                handleGeneratingQuestionsComplete();\n              }}\n              regenerationType=\"first_login\"\n            />\n          </motion.div>\n        )}\n\n        {currentScreen === \"signing-out\" && (\n          <div key=\"signing-out\" className=\"min-h-screen\" data-testid=\"signing-out-screen\" />\n        )}\n\n        {currentScreen === \"selection\" && (\n          <motion.div key=\"selection\" className=\"w-full\" {...pageVariants.fadeIn} transition={pageTransition}>\n            <GameSelectionPage \n              onPlayGame={handlePlayGlobal}\n              onViewStats={handleStatsGlobal}\n              onViewArchive={handleArchiveGlobal}\n              onOpenSettings={() => setCurrentScreen(\"settings\")}\n              onOpenOptions={handleOptionsGlobal}\n              onLogin={() => setCurrentScreen(\"login\")}\n              onRegister={() => setCurrentScreen(\"signup\")}\n              todayPuzzleId={getDailyPuzzle()?.id}\n              todayPuzzleAnswerDateCanonical={getDailyPuzzle()?.answerDateCanonical}\n              onPlayGameLocal={handlePlayLocal}\n              onViewStatsLocal={handleStatsLocal}\n              onViewArchiveLocal={handleArchiveLocal}\n              onOpenOptionsLocal={handleOptionsLocal}\n              onPlayYesterdaysPuzzle={handlePlayYesterdaysPuzzle}\n              onViewStatsWithBadge={(badge, gameType) => {\n                setNewlyAwardedBadge(badge);\n                setStatsGameType(gameType);\n                setStatsReturnScreen(\"selection\");\n                setCurrentScreen(\"stats\");\n              }}\n              initialShowProDialog={showProDialogFromCancel}\n              onProDialogShown={() => setShowProDialogFromCancel(false)}\n            />\n          </motion.div>\n        )}\n\n        {currentScreen === \"play\" && currentPuzzle && (\n          <motion.div key=\"play\" className=\"absolute w-full top-0 left-0\" {...pageVariants.slideLeft} transition={pageTransition}>\n            <PlayPage\n              puzzleId={currentPuzzle.id}\n              puzzleDate={currentPuzzle.date}\n              answerDateCanonical={currentPuzzle.answerDateCanonical}\n              eventTitle={currentPuzzle.eventTitle}\n              eventDescription={currentPuzzle.eventDescription}\n              category={currentPuzzle.category}\n              clue1={currentPuzzle.clue1}\n              clue2={currentPuzzle.clue2}\n              maxGuesses={5}\n              fromArchive={previousScreen === \"archive\"}\n              hasExistingProgress={hasExistingProgress}\n              skipIntro={skipIntroForGuest || returningToPlay}\n              showCelebrationFirst={showCelebrationFirst}\n              hasOpenedCelebration={hasOpenedCelebration}\n              puzzleSourceMode={puzzleSourceMode}\n              onSetHasOpenedCelebration={setHasOpenedCelebration}\n              onBack={() => {\n                // Clear streak saver puzzle state to prevent stale navigation\n                setStreakSaverPuzzle(null);\n                // Reset skipIntro flag when leaving play screen\n                setSkipIntroForGuest(false);\n                // Reset returning to play flag\n                setReturningToPlay(false);\n                // Guests should return to onboarding screen, authenticated users to selection/archive\n                if (!isAuthenticated) {\n                  setCurrentScreen(\"onboarding\");\n                } else {\n                  setCurrentScreen(previousScreen === \"archive\" ? \"archive\" : \"selection\");\n                }\n              }}\n              onHomeFromCelebration={() => {\n                setShowCelebrationFirst(false);\n                setReturningToPlay(false);\n                setCurrentScreen(\"selection\");\n              }}\n              onViewStats={() => {\n                setStatsReturnScreen(\"play\");\n                setReturningToPlay(true); // Mark that we'll return to play\n                setCurrentScreen(\"stats\");\n              }}\n              onViewArchive={() => {\n                setArchiveReturnScreen(\"play\");\n                setReturningToPlay(true); // Mark that we'll return to play\n                setCurrentScreen(\"archive\");\n              }}\n              onContinueToLogin={() => {\n                // Guest completed game - go to login with subtitle\n                setShowLoginSubtitle(true);\n                setReturningToPlay(false);\n                setCurrentScreen(\"login\");\n              }}\n            />\n          </motion.div>\n        )}\n\n        {currentScreen === \"play\" && !currentPuzzle && (\n          <div className=\"min-h-screen\" data-testid=\"puzzle-loading\" />\n        )}\n\n        {currentScreen === \"stats\" && (\n          <motion.div key=\"stats\" className=\"absolute w-full top-0 left-0\" {...pageVariants.slideLeft} transition={pageTransition}>\n            <StatsPage \n              onBack={() => {\n                setNewlyAwardedBadge(null);\n                setCurrentScreen(statsReturnScreen);\n              }}\n              gameType={statsGameType}\n              newlyAwardedBadge={newlyAwardedBadge}\n              onBadgeAnimationComplete={() => setNewlyAwardedBadge(null)}\n            />\n          </motion.div>\n        )}\n\n        {currentScreen === \"archive\" && (\n          <motion.div key=\"archive\" className=\"absolute w-full top-0 left-0\" {...pageVariants.slideLeft} transition={pageTransition}>\n            <ArchivePage \n              onBack={() => {\n                setArchiveMonthContext(null);\n                setCurrentScreen(archiveReturnScreen);\n              }}\n              onPlayPuzzle={handlePlayPuzzle}\n              puzzles={puzzles as any[]}\n              initialMonth={archiveMonthContext}\n              onMonthChange={setArchiveMonthContext}\n            />\n          </motion.div>\n        )}\n\n        {currentScreen === \"settings\" && (\n          <motion.div key=\"settings\" className=\"absolute w-full top-0 left-0\" {...pageVariants.slideDown} transition={pageTransition}>\n            <SettingsPage \n              onBack={() => setCurrentScreen(\"selection\")}\n              onOpenOptions={() => {\n                setPreviousScreen(\"settings\");\n                setCurrentScreen(\"options\");\n              }}\n              onAccountInfo={() => setCurrentScreen(\"account-info\")}\n              onBugReport={() => setCurrentScreen(\"bug-report\")}\n              onFeedback={() => setCurrentScreen(\"feedback\")}\n              onPrivacy={() => setCurrentScreen(\"privacy\")}\n              onTerms={() => setCurrentScreen(\"terms\")}\n              onAbout={() => setCurrentScreen(\"about\")}\n              onSignOut={() => {\n                // Show hamster spinner during sign out\n                setCurrentScreen(\"signing-out\");\n              }}\n              onLogin={() => setCurrentScreen(\"login\")}\n              onRegister={() => setCurrentScreen(\"signup\")}\n            />\n          </motion.div>\n        )}\n\n        {currentScreen === \"options\" && (\n          <motion.div key=\"options\" className=\"absolute w-full top-0 left-0\" {...pageVariants.slideLeft} transition={pageTransition}>\n            <OptionsPage \n              onBack={() => setCurrentScreen(previousScreen)}\n            />\n          </motion.div>\n        )}\n\n        {currentScreen === \"account-info\" && (\n          <motion.div key=\"account-info\" className=\"absolute w-full top-0 left-0\" {...pageVariants.slideLeft} transition={pageTransition}>\n            <AccountInfoPage \n              onBack={() => setCurrentScreen(\"settings\")}\n            />\n          </motion.div>\n        )}\n\n        {currentScreen === \"bug-report\" && (\n          <motion.div key=\"bug-report\" className=\"absolute w-full top-0 left-0\" {...pageVariants.slideLeft} transition={pageTransition}>\n            <BugReportForm onBack={() => setCurrentScreen(\"settings\")} />\n          </motion.div>\n        )}\n\n        {currentScreen === \"feedback\" && (\n          <motion.div key=\"feedback\" className=\"absolute w-full top-0 left-0\" {...pageVariants.slideLeft} transition={pageTransition}>\n            <FeedbackForm onBack={() => setCurrentScreen(\"settings\")} />\n          </motion.div>\n        )}\n\n        {currentScreen === \"privacy\" && (\n          <motion.div key=\"privacy\" className=\"absolute w-full top-0 left-0\" {...pageVariants.slideLeft} transition={pageTransition}>\n            <PrivacyPage onBack={() => setCurrentScreen(\"settings\")} />\n          </motion.div>\n        )}\n\n        {currentScreen === \"terms\" && (\n          <motion.div key=\"terms\" className=\"absolute w-full top-0 left-0\" {...pageVariants.slideLeft} transition={pageTransition}>\n            <TermsPage onBack={() => setCurrentScreen(\"settings\")} />\n          </motion.div>\n        )}\n\n        {currentScreen === \"about\" && (\n          <motion.div key=\"about\" className=\"absolute w-full top-0 left-0\" {...pageVariants.slideLeft} transition={pageTransition}>\n            <AboutPage onBack={() => setCurrentScreen(\"settings\")} />\n          </motion.div>\n        )}\n      </AnimatePresence>\n      </div>\n      <AdBanner />\n      <GuestInterstitialAd />\n    </AdBannerContext.Provider>\n  );\n}\n","path":null,"size_bytes":53010,"size_tokens":null},"client/src/components/HelpDialog.tsx":{"content":"import {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { ArrowUp, ArrowDown } from \"lucide-react\";\n\ninterface HelpDialogProps {\n  isOpen: boolean;\n  onClose: () => void;\n}\n\nexport function HelpDialog({ isOpen, onClose }: HelpDialogProps) {\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"sm:max-w-lg top-4 translate-y-0 max-h-[calc(100vh-2rem)] overflow-y-auto pb-24\" data-testid=\"help-dialog\">\n        <DialogHeader>\n          <DialogTitle className=\"text-4xl\">How to Play</DialogTitle>\n        </DialogHeader>\n\n        <div className=\"space-y-6 text-sm\">\n          <div>\n            <div className=\"mb-4\">\n              <p className=\"font-bold\">Guess the historical date</p>\n              <p className=\"text-muted-foreground\">Format: DDMMYY - 6 digit mode</p>\n              <p className=\"text-muted-foreground\">Format: DDMMYYYY - 8 digit mode</p>\n              <p className=\"mb-4\">You have 5 attempts to find the correct date.</p>\n            </div>\n            <p className=\"mb-4 text-muted-foreground\">\n              <span className=\"font-semibold text-foreground\">Note:</span> The Enter button will only activate once you've entered a complete and valid date. If the date you type doesn't exist (like 31/02/2020), you won't be able to submit it.\n            </p>\n            <p className=\"font-semibold mb-2\">After each guess, the boxes will change color:</p>\n          </div>\n\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"w-12 h-12 bg-game-correct text-white flex items-center justify-center rounded-md border-2 border-game-correct font-semibold text-xl\">\n                2\n              </div>\n              <div className=\"flex-1\">\n                <p className=\"font-bold\">Green</p>\n                <p className=\"text-muted-foreground\">Digit correct and in right position</p>\n              </div>\n            </div>\n\n            <div className=\"flex items-center gap-3\">\n              <div className=\"relative w-12 h-12 bg-game-inSequence text-white flex items-center justify-center rounded-md border-2 border-game-inSequence font-semibold text-xl\">\n                5\n                <ArrowUp className=\"absolute top-0.5 right-0.5 h-4 w-4\" />\n              </div>\n              <div className=\"flex-1\">\n                <p className=\"font-bold\">Amber with Arrow</p>\n                <p className=\"text-muted-foreground\">Digit correct, but in different position. Actual digit is higher  or lower </p>\n              </div>\n            </div>\n\n            <div className=\"flex items-center gap-3\">\n              <div className=\"relative w-12 h-12 bg-game-notInSequence text-white flex items-center justify-center rounded-md border-2 border-game-notInSequence font-semibold text-xl\">\n                8\n                <ArrowDown className=\"absolute top-0.5 right-0.5 h-4 w-4\" />\n              </div>\n              <div className=\"flex-1\">\n                <p className=\"font-bold\">Grey with Arrow</p>\n                <p className=\"text-muted-foreground\">Digit doesn't appear in answer. Actual digit is higher  or lower </p>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"bg-muted p-4 rounded-lg\">\n            <p className=\"font-semibold mb-2\">Example:</p>\n            <p className=\"text-muted-foreground\">\n              Moon Landing - 20th July 1969: answer in DDMMYY format is <span className=\"font-bold\">200769</span>\n            </p>\n            <p className=\"text-muted-foreground mt-1\">\n              Guess <span className=\"font-bold\">270769</span> would show the second digit \"7\" in amber (in the date but wrong position), all others in green\n            </p>\n          </div>\n\n          <div>\n            <p className=\"font-semibold mb-2\">Tips:</p>\n            <ul className=\"list-disc list-inside space-y-1 text-muted-foreground\">\n              <li>Arrows narrow down the possible digits</li>\n              <li>Amber digits are in at least one other place in the answer</li>\n              <li>Green digits are correct, but could still pop up somewhere else too!</li>\n              <li>Each puzzle reveals a fascinating historical event</li>\n            </ul>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":4367,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { SupabaseProvider } from \"@/lib/SupabaseProvider\";\nimport { PreloadProvider } from \"@/lib/PreloadProvider\";\nimport { SettingsProvider } from \"@/lib/SettingsProvider\";\nimport { SpinnerProvider } from \"@/lib/SpinnerProvider\";\nimport { GuessCacheProvider } from \"@/contexts/GuessCacheContext\";\nimport { GameModeProvider } from \"@/contexts/GameModeContext\";\nimport { StreakSaverProvider } from \"@/contexts/StreakSaverContext\";\nimport Home from \"@/pages/Home\";\nimport Subscriptions from \"@/pages/Subscriptions\";\nimport ManageSubscriptionRoute from \"@/pages/ManageSubscriptionRoute\";\nimport SubscriptionSuccessRoute from \"@/pages/SubscriptionSuccessRoute\";\nimport NotFound from \"@/pages/not-found\";\n\nimport { OptionsPage } from \"@/components/OptionsPage\";\nimport { SettingsPage } from \"@/components/SettingsPage\";\nimport { PlayPage } from \"@/components/PlayPage\";\nimport { StatsPage } from \"@/components/StatsPage\";\nimport { ArchivePage } from \"@/components/ArchivePage\";\nimport { StreakCelebrationPopup } from \"@/components/StreakCelebrationPopup\";\nimport { RoutePersistence } from \"./lib/RoutePersistence\";\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/\" component={Home} />\n      <Route path=\"/subscriptions\" component={Subscriptions} />\n      <Route path=\"/manage-subscription\" component={ManageSubscriptionRoute} />\n      <Route path=\"/subscription-success\" component={SubscriptionSuccessRoute} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <SupabaseProvider>\n      <QueryClientProvider client={queryClient}>\n        <SpinnerProvider>\n          <PreloadProvider>\n            <SettingsProvider>\n              <GameModeProvider>\n                <StreakSaverProvider>\n                  <GuessCacheProvider>\n                    <TooltipProvider>\n                      <Toaster />\n                      <RoutePersistence />\n                      <Router />\n                    </TooltipProvider>\n                  </GuessCacheProvider>\n                </StreakSaverProvider>\n              </GameModeProvider>\n            </SettingsProvider>\n          </PreloadProvider>\n        </SpinnerProvider>\n      </QueryClientProvider>\n    </SupabaseProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":2507,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] rounded-2xl\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4435,"size_tokens":null},"client/src/components/StatsPage.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { ChevronLeft, BarChart3, TrendingUp, Award, Info } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useUserStats } from \"@/hooks/useUserStats\";\nimport { useGameData } from \"@/hooks/useGameData\";\nimport { useProfile } from \"@/hooks/useProfile\";\nimport { readLocal, writeLocal, CACHE_KEYS } from \"@/lib/localCache\";\nimport type { UserProfile, UserBadgeWithDetails } from \"@shared/schema\";\nimport { motion } from \"framer-motion\";\nimport { pageVariants, pageTransition } from \"@/lib/pageAnimations\";\nimport { useAdBannerActive } from \"@/components/AdBanner\";\nimport { BadgesRow } from \"@/components/badges\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\ninterface StatsPageProps {\n  onBack: () => void;\n  gameType?: 'USER' | 'REGION';\n  newlyAwardedBadge?: UserBadgeWithDetails | null;\n  onBadgeAnimationComplete?: () => void;\n}\n\ninterface GameStats {\n  played: number;\n  won: number;\n  currentStreak: number;\n  maxStreak: number;\n  guessDistribution: Record<number, number>;\n  puzzleCompletions?: Record<string, {\n    completed: boolean;\n    won: boolean;\n    guessCount: number;\n    date: string;\n  }>;\n}\n\nexport function StatsPage({ onBack, gameType = 'REGION', newlyAwardedBadge, onBadgeAnimationComplete }: StatsPageProps) {\n  const { isAuthenticated } = useAuth();\n  const { stats: supabaseStats, isLoading: loadingStats } = useUserStats();\n  const { gameAttempts, loadingAttempts } = useGameData();\n  const { profile } = useProfile();\n  const adBannerActive = useAdBannerActive();\n\n  // Get cached profile for instant display\n  const cachedProfile = readLocal<UserProfile>(CACHE_KEYS.PROFILE);\n  \n  // Determine the title based on gameType\n  const title = gameType === 'USER' \n    ? 'Personal Edition'\n    : (profile?.region || cachedProfile?.region || 'UK') + ' Edition';\n  \n  const [stats, setStats] = useState<GameStats>({\n    played: 0,\n    won: 0,\n    currentStreak: 0,\n    maxStreak: 0,\n    guessDistribution: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },\n    puzzleCompletions: {}\n  });\n\n  // Load from cache first for instant rendering\n  useEffect(() => {\n    const cachedStats = readLocal<any>(CACHE_KEYS.STATS);\n    if (cachedStats) {\n      const dist = cachedStats.guessDistribution as any || {};\n      setStats({\n        played: cachedStats.gamesPlayed ?? cachedStats.played ?? 0,\n        won: cachedStats.gamesWon ?? cachedStats.won ?? 0,\n        currentStreak: cachedStats.currentStreak ?? 0,\n        maxStreak: cachedStats.maxStreak ?? 0,\n        guessDistribution: {\n          1: dist[\"1\"] || dist[1] || 0,\n          2: dist[\"2\"] || dist[2] || 0,\n          3: dist[\"3\"] || dist[3] || 0,\n          4: dist[\"4\"] || dist[4] || 0,\n          5: dist[\"5\"] || dist[5] || 0,\n        },\n        puzzleCompletions: cachedStats.puzzleCompletions || {},\n      });\n    }\n  }, []); // Run once on mount\n\n  // Background reconciliation with Supabase/localStorage\n  useEffect(() => {\n    if (isAuthenticated && supabaseStats) {\n      // Use Supabase stats for authenticated users - always show user_stats data\n      const dist = supabaseStats.guessDistribution as any || {};\n      const newStats = {\n        played: supabaseStats.gamesPlayed ?? 0,\n        won: supabaseStats.gamesWon ?? 0,\n        currentStreak: supabaseStats.currentStreak ?? 0,\n        maxStreak: supabaseStats.maxStreak ?? 0,\n        guessDistribution: {\n          1: dist[\"1\"] || 0,\n          2: dist[\"2\"] || 0,\n          3: dist[\"3\"] || 0,\n          4: dist[\"4\"] || 0,\n          5: dist[\"5\"] || 0,\n        },\n        // Build puzzle completions from game attempts if available\n        puzzleCompletions: gameAttempts ? gameAttempts.reduce((acc, attempt) => {\n          if (attempt.result) {\n            acc[attempt.puzzleId.toString()] = {\n              completed: true,\n              // Defensive normalization: handle both \"won\"/\"win\"\n              won: attempt.result === 'won' || attempt.result === 'win',\n              guessCount: attempt.numGuesses ?? 0,\n              date: attempt.completedAt?.toString() || attempt.startedAt?.toString() || new Date().toISOString(),\n            };\n          }\n          return acc;\n        }, {} as any) : {},\n      };\n      setStats(newStats);\n      \n      // Update cache\n      writeLocal(CACHE_KEYS.STATS, { ...supabaseStats, puzzleCompletions: newStats.puzzleCompletions });\n    } else if (!isAuthenticated) {\n      // Use localStorage for guest users\n      const storedStats = localStorage.getItem(\"elementle-stats\");\n      if (storedStats) {\n        setStats(JSON.parse(storedStats));\n      }\n    }\n  }, [isAuthenticated, supabaseStats, gameAttempts]);\n\n  const winPercentage = stats.played > 0 ? Math.round((stats.won / stats.played) * 100) : 0;\n  const maxGuesses = Math.max(...Object.values(stats.guessDistribution || {}), 1);\n  \n  // Average guesses calculation includes lost games (counted as 6 guesses each)\n  // Formula: (sum of guesses from wins + 6 * losses) / total games played\n  const averageGuesses = stats.played > 0 && stats.guessDistribution\n    ? (() => {\n        const guessesFromWins = Object.entries(stats.guessDistribution).reduce((sum, [guesses, count]) => \n          sum + (parseInt(guesses) * count), 0);\n        const losses = stats.played - stats.won;\n        const guessesFromLosses = losses * 6;\n        return ((guessesFromWins + guessesFromLosses) / stats.played).toFixed(1);\n      })()\n    : \"0\";\n\n  const getLast30DaysData = () => {\n    const completions = stats.puzzleCompletions || {};\n    const today = new Date();\n    const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);\n    \n    const recentCompletions = Object.entries(completions)\n      .map(([key, value]) => ({ ...value, key, date: new Date(value.date) }))\n      .filter(c => c.date >= thirtyDaysAgo)\n      .sort((a, b) => a.date.getTime() - b.date.getTime())\n      .slice(-30);\n    \n    return recentCompletions;\n  };\n\n  const last30Days = getLast30DaysData();\n  const last30DaysWins = last30Days.filter(d => d.won).length;\n  const last30DaysPlayed = last30Days.length;\n  const last30DaysWinRate = last30DaysPlayed > 0 \n    ? Math.round((last30DaysWins / last30DaysPlayed) * 100) \n    : 0;\n\n  return (\n    <motion.div \n      className={`min-h-screen flex flex-col p-4 bg-background ${adBannerActive ? 'pb-[50px]' : ''}`}\n      initial={pageVariants.slideLeft.initial}\n      animate={pageVariants.slideLeft.animate}\n      exit={pageVariants.slideLeft.exit}\n      transition={pageTransition}\n    >\n      <div className=\"flex items-center justify-between mb-8\">\n        <button\n          onClick={onBack}\n          data-testid=\"button-back\"\n          className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n        >\n          <ChevronLeft className=\"h-10 w-10 text-gray-700\" />\n        </button>\n\n        <h2 className=\"text-4xl font-bold\">Statistics</h2>\n\n        <div className=\"w-14\" />\n      </div>\n      <div className=\"flex-1 flex items-start justify-center pb-8\">\n        <div className=\"w-full max-w-md space-y-6\">\n          <div className=\"grid grid-cols-2 gap-3\">\n            {/* Left Box - Full height with Played, Win %, Average Guesses */}\n            <Card className=\"p-4 flex flex-col\">\n              <div className=\"font-bold text-sm mb-4\">{title}</div>\n              <div className=\"flex-1 flex flex-col justify-between\">\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"text-sm text-muted-foreground\">Played</span>\n                  <span className=\"text-xl font-bold\" data-testid=\"stat-played\">{stats.played}</span>\n                </div>\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"text-sm text-muted-foreground\">Win %</span>\n                  <span className=\"text-xl font-bold\" data-testid=\"stat-win-percentage\">{winPercentage}%</span>\n                </div>\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"text-sm text-muted-foreground max-w-[70px]\">Average Guesses</span>\n                  <span className=\"text-xl font-bold\" data-testid=\"stat-avg-guesses\">{averageGuesses}</span>\n                </div>\n              </div>\n            </Card>\n\n            {/* Right Column - Two stacked boxes */}\n            <div className=\"flex flex-col gap-3\">\n              {/* Top Right Box - Streak */}\n              <Card className=\"p-4 flex-1\">\n                <div className=\"font-bold text-sm mb-2\">Streak</div>\n                <div className=\"flex justify-between items-center mb-1 pr-2\">\n                  <span className=\"text-sm text-muted-foreground\">Current</span>\n                  <span className=\"text-xl font-bold\" data-testid=\"stat-current-streak\">{stats.currentStreak}</span>\n                </div>\n                <div className=\"flex justify-between items-center pr-2\">\n                  <span className=\"text-sm text-muted-foreground\">Best</span>\n                  <span className=\"text-xl font-bold\" data-testid=\"stat-max-streak\">{stats.maxStreak}</span>\n                </div>\n              </Card>\n\n              {/* Bottom Right Box - Percentile Month to Date */}\n              <Card className=\"p-4 flex-1\">\n                <div className=\"flex items-start justify-between gap-2 mb-2\">\n                  <span className=\"font-bold text-sm\">Percentile</span>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <button className=\"p-1.5 -m-1.5 hover:bg-muted rounded transition-colors flex-shrink-0\">\n                        <Info className=\"h-4 w-4 text-muted-foreground cursor-help\" data-testid=\"info-percentile\" />\n                      </button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\" sideOffset={8} className=\"max-w-[160px] text-center\">\n                      <p>You must have played at least 5 days this month for a percentile to be calculated</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"text-sm text-muted-foreground max-w-[50%]\">Month to Date</span>\n                  <span className=\"text-lg font-bold text-right\" data-testid=\"stat-percentile-mtd\">\n                    {(() => {\n                      const dayOfMonth = new Date().getDate();\n                      const percentile = (supabaseStats as any)?.cumulativeMonthlyPercentile;\n                      if (dayOfMonth < 5 || percentile === null || percentile === undefined || percentile <= 0) {\n                        return \"NA\";\n                      }\n                      // Tiered percentile display logic\n                      if (percentile <= 1) return \"Top 1%\";\n                      if (percentile <= 2) return \"Top 2%\";\n                      if (percentile <= 5) return \"Top 5%\";\n                      if (percentile <= 10) return \"Top 10%\";\n                      if (percentile <= 15) return \"Top 20%\";\n                      // Above 15%: round up to nearest 10%\n                      const rounded = Math.ceil(percentile / 10) * 10;\n                      return `Top ${rounded}%`;\n                    })()}\n                  </span>\n                </div>\n              </Card>\n            </div>\n          </div>\n\n          <BadgesRow \n            gameType={gameType} \n            newlyAwardedBadge={newlyAwardedBadge}\n            onAnimationComplete={onBadgeAnimationComplete}\n          />\n\n          {last30DaysPlayed > 0 && (\n            <Card className=\"p-4 space-y-3\">\n              <div className=\"font-bold text-sm mb-2 flex items-center gap-2\">\n                <TrendingUp className=\"h-5 w-5\" />\n                Last 30 Days\n              </div>\n              <div className=\"flex justify-between items-center\">\n                <span className=\"text-sm text-muted-foreground pl-2\">Played</span>\n                <span className=\"text-xl font-bold pr-2\" data-testid=\"stat-30day-played\">{last30DaysPlayed}</span>\n              </div>\n              <div className=\"flex justify-between items-center\">\n                <span className=\"text-sm text-muted-foreground pl-2\">Wins</span>\n                <span className=\"text-xl font-bold pr-2\" data-testid=\"stat-30day-wins\">{last30DaysWins}</span>\n              </div>\n              <div className=\"flex justify-between items-center\">\n                <span className=\"text-sm text-muted-foreground pl-2\">Win %</span>\n                <span className=\"text-xl font-bold pr-2\" data-testid=\"stat-30day-winrate\">{last30DaysWinRate}%</span>\n              </div>\n              \n              <div className=\"pt-3\">\n                <div className=\"flex gap-1 h-16 items-end\">\n                  {last30Days.map((day, i) => (\n                    <div\n                      key={i}\n                      className=\"flex-1 rounded-sm transition-all\"\n                      style={{ \n                        height: `${(day.guessCount / 5) * 100}%`,\n                        backgroundColor: day.won \n                          ? (gameType === 'USER' ? '#93cd78' : '#A4DB57')\n                          : (gameType === 'USER' ? '#fdab58' : '#8e57db')\n                      }}\n                      title={`${day.won ? 'Won' : 'Lost'} in ${day.guessCount} guesses`}\n                      data-testid={`chart-bar-${i}`}\n                    />\n                  ))}\n                </div>\n                <div className=\"text-xs text-center text-muted-foreground mt-2\">\n                  Last 30 days - bar height = guesses\n                </div>\n              </div>\n            </Card>\n          )}\n\n          <Card className=\"p-4 space-y-3\">\n            <div className=\"font-bold text-sm mb-2 flex items-center gap-2\">\n              <BarChart3 className=\"h-5 w-5\" />\n              Guess Distribution\n            </div>\n            <div className=\"space-y-2\">\n              {[1, 2, 3, 4, 5].map((guessNum) => {\n                const count = (stats.guessDistribution && stats.guessDistribution[guessNum]) || 0;\n                const percentage = maxGuesses > 0 ? (count / maxGuesses) * 100 : 0;\n                const barColor = gameType === 'USER' ? '#93cd78' : '#A4DB57';\n                \n                return (\n                  <div key={guessNum} className=\"flex items-center gap-2\">\n                    <div className=\"w-4 text-sm font-medium\">{guessNum}</div>\n                    <div \n                      className=\"flex-1 mx-1 rounded-sm h-8 relative overflow-hidden\"\n                      style={{ backgroundColor: `${barColor}4D` }}\n                    >\n                      {count > 0 && (\n                        <div\n                          className=\"h-full transition-all duration-300 flex items-center justify-end pr-2\"\n                          style={{ \n                            width: `${Math.max(percentage, 10)}%`,\n                            backgroundColor: barColor\n                          }}\n                          data-testid={`dist-bar-${guessNum}`}\n                        >\n                          <span className=\"text-sm font-medium text-white\">{count}</span>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                );\n              })}\n              <div className=\"flex items-center gap-2\">\n                <div className=\"w-4 text-sm font-medium relative\">\n                  <span aria-hidden=\"true\" className=\"invisible\">6</span>\n                  <span className=\"absolute right-[-4px] whitespace-nowrap pointer-events-none\">Lost</span>\n                </div>\n                <div \n                  className=\"flex-1 mx-1 rounded-sm h-8 relative overflow-hidden\"\n                  style={{ backgroundColor: gameType === 'USER' ? '#fdab584D' : '#FFD4294D' }}\n                >\n                  {(stats.played - stats.won) > 0 && (\n                    <div\n                      className=\"h-full transition-all duration-300 flex items-center justify-end pr-2\"\n                      style={{ \n                        width: `${Math.max(((stats.played - stats.won) / maxGuesses) * 100, 10)}%`,\n                        backgroundColor: gameType === 'USER' ? '#fdab58' : '#FFD429'\n                      }}\n                      data-testid=\"dist-bar-lost\"\n                    >\n                      <span className=\"text-sm font-medium text-white\">{stats.played - stats.won}</span>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n          </Card>\n\n          {stats.played === 0 && (\n            <Card className=\"p-6 text-center\">\n              <p className=\"text-muted-foreground\">\n                No games played yet. Start playing to see your statistics!\n              </p>\n            </Card>\n          )}\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":17150,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"client/src/components/ThemeToggle.tsx":{"content":"import { Moon, Sun } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useEffect, useState } from \"react\";\n\nexport function ThemeToggle() {\n  const [theme, setTheme] = useState<\"light\" | \"dark\">(\"light\");\n\n  useEffect(() => {\n    const stored = localStorage.getItem(\"theme\") as \"light\" | \"dark\" | null;\n    const initial = stored || \"light\";\n    setTheme(initial);\n    document.documentElement.classList.toggle(\"dark\", initial === \"dark\");\n  }, []);\n\n  const toggleTheme = () => {\n    const newTheme = theme === \"light\" ? \"dark\" : \"light\";\n    setTheme(newTheme);\n    localStorage.setItem(\"theme\", newTheme);\n    document.documentElement.classList.toggle(\"dark\", newTheme === \"dark\");\n  };\n\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"icon\"\n      onClick={toggleTheme}\n      data-testid=\"button-theme-toggle\"\n    >\n      {theme === \"light\" ? (\n        <Moon className=\"h-5 w-5\" />\n      ) : (\n        <Sun className=\"h-5 w-5\" />\n      )}\n    </Button>\n  );\n}\n","path":null,"size_bytes":1001,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"client/src/components/WelcomePage.tsx":{"content":"import { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport hamsterLogo from \"@assets/Login-Hamster-White.svg\";\n\ninterface WelcomePageProps {\n  onLogin?: () => void;\n  onSignup?: () => void;\n  onContinueAsGuest?: () => void;\n  showAuthButtons?: boolean;\n}\n\nexport function WelcomePage({ onLogin, onSignup, onContinueAsGuest, showAuthButtons = false }: WelcomePageProps) {\n  return (\n    <div className=\"min-h-screen flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-lg p-8\">\n        <div className=\"text-center space-y-4\">\n          <img\n            src={hamsterLogo}\n            alt=\"Elementle Logo\"\n            className=\"w-24 h-24 mx-auto\"\n          />\n          <h1 className=\"text-4xl md:text-5xl font-bold\">Elementle</h1>\n          <p className=\"text-muted-foreground\">\n            Guess the historical date.<br />\n            A new puzzle every day!\n          </p>\n          \n          {showAuthButtons && (\n            <div className=\"space-y-3 pt-4\">\n              <Button \n                onClick={onSignup} \n                className=\"w-full h-14 text-lg font-bold rounded-full\"\n                style={{ backgroundColor: '#7DAAE8' }}\n                data-testid=\"button-register\"\n              >\n                Register\n              </Button>\n              <Button \n                onClick={onLogin} \n                variant=\"outline\"\n                className=\"w-full h-14 text-lg font-bold rounded-full border-2 border-gray-300\"\n                data-testid=\"button-login\"\n              >\n                Login\n              </Button>\n              <button\n                onClick={onContinueAsGuest}\n                className=\"text-sm text-muted-foreground hover:text-foreground transition-colors cursor-pointer\"\n                data-testid=\"button-continue-guest\"\n              >\n                Continue without logging in\n              </button>\n            </div>\n          )}\n        </div>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":2009,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":2263,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\nconst initializeAppSettings = () => {\n  const storedTextSize = localStorage.getItem(\"textSize\") as \"small\" | \"medium\" | \"large\" | null;\n  if (storedTextSize) {\n    document.documentElement.style.setProperty(\n      \"--text-scale\",\n      storedTextSize === \"small\" ? \"0.875\" : storedTextSize === \"large\" ? \"1.125\" : \"1\"\n    );\n  }\n  \n  const storedTheme = localStorage.getItem(\"theme\");\n  if (storedTheme === \"dark\") {\n    document.documentElement.classList.add(\"dark\");\n  }\n  \n  // Apply text classes to body element (background handled by CSS and app-loaded class)\n  document.body.classList.add(\"text-foreground\", \"font-sans\", \"antialiased\");\n};\n\ninitializeAppSettings();\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":830,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] rounded-2xl\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      {/* <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>*/}\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3870,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport path from \"path\";\nimport { fileURLToPath } from \"url\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\n\nconst __dirname = path.dirname(fileURLToPath(import.meta.url));\nconst app = express();\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\n\n// Middleware to log API requests and responses\napp.use((req, res, next) => {\n  const start = Date.now();\n  const pathName = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (pathName.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${pathName} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"\";\n      }\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  // Error handler\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  if (app.get(\"env\") === \"development\") {\n    // Only setup Vite in development\n    await setupVite(app, server);\n  } else {\n    // Serve static files from the built React app\n    serveStatic(app);\n\n    // Explicit SPA fallback: any unknown route  index.html\n    const distPath = path.join(__dirname, \"../dist/public\");\n    app.get(\"*\", (req, res) => {\n      res.sendFile(path.join(distPath, \"index.html\"));\n    });\n  }\n\n  // Serve on the configured port\n  const port = parseInt(process.env.PORT || \"5000\", 10);\n  server.listen(port, \"0.0.0.0\", (err?: Error) => {\n    if (err) {\n      console.error(\"Failed to start server:\", err);\n      process.exit(1);\n    }\n    log(`serving on port ${port}`);\n  });\n})();\n","path":null,"size_bytes":2272,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* Apply text scaling globally */\n* {\n  font-size: calc(1rem * var(--text-scale));\n}\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n\n  /* Automatic computation of border around primary / danger buttons */\n  --opaque-button-border-intensity: -8; /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n\n  --background: 0 0% 98%;\n\n  --foreground: 0 0% 25%;\n\n  --border: 220 13% 91%;\n\n  --card: 0 0% 100%;\n\n  --card-foreground: 222 47% 11%;\n\n  --card-border: 220 13% 91%;\n\n  --sidebar: 0 0% 96%;\n\n  --sidebar-foreground: 222 47% 11%;\n\n  --sidebar-border: 220 13% 88%;\n\n  --sidebar-primary: 220 90% 56%;\n\n  --sidebar-primary-foreground: 0 0% 100%;\n\n  --sidebar-accent: 220 14% 92%;\n\n  --sidebar-accent-foreground: 222 47% 11%;\n\n  --sidebar-ring: 220 90% 56%;\n\n  --popover: 0 0% 100%;\n\n  --popover-foreground: 222 47% 11%;\n\n  --popover-border: 220 13% 88%;\n\n  --primary: 220 90% 56%;\n\n  --primary-foreground: 0 0% 100%;\n\n  --secondary: 220 13% 94%;\n\n  --secondary-foreground: 222 47% 11%;\n\n  --muted: 220 13% 95%;\n\n  --muted-foreground: 215 16% 47%;\n\n  --accent: 220 14% 96%;\n\n  --accent-foreground: 222 47% 11%;\n\n  --destructive: 0 84% 60%;\n\n  --destructive-foreground: 0 0% 100%;\n\n  --input: 220 13% 85%;\n  --ring: 220 90% 56%;\n  --chart-1: 142 71% 45%;\n  --chart-2: 38 92% 50%;\n  --chart-3: 220 90% 56%;\n  --chart-4: 280 65% 60%;\n  --chart-5: 340 75% 55%;\n\n  --font-sans: Nunito, -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, Monaco, \"Courier New\", monospace;\n  --radius: .375rem; /* 6px */\n  --shadow-2xs: 0px 1px 2px 0px hsl(220 13% 11% / 0.05);\n  --shadow-xs: 0px 1px 3px 0px hsl(220 13% 11% / 0.1);\n  --shadow-sm: 0px 2px 4px -1px hsl(220 13% 11% / 0.06), 0px 1px 2px -1px hsl(220 13% 11% / 0.1);\n  --shadow: 0px 4px 6px -1px hsl(220 13% 11% / 0.1), 0px 2px 4px -1px hsl(220 13% 11% / 0.06);\n  --shadow-md: 0px 6px 12px -2px hsl(220 13% 11% / 0.12), 0px 3px 7px -3px hsl(220 13% 11% / 0.1);\n  --shadow-lg: 0px 10px 20px -5px hsl(220 13% 11% / 0.15), 0px 6px 10px -5px hsl(220 13% 11% / 0.1);\n  --shadow-xl: 0px 20px 30px -10px hsl(220 13% 11% / 0.2), 0px 10px 15px -5px hsl(220 13% 11% / 0.15);\n  --shadow-2xl: 0px 25px 50px -12px hsl(220 13% 11% / 0.25);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n  --text-scale: 1;\n\n  /* Automatically computed borders - intensity can be controlled by the user by the --opaque-button-border-intensity setting */\n\n  /* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n\n  --opaque-button-border-intensity: 9;  /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n\n  --background: 222 47% 11%;\n\n  --foreground: 210 40% 98%;\n\n  --border: 215 25% 27%;\n\n  --card: 217 33% 17%;\n\n  --card-foreground: 210 40% 98%;\n\n  --card-border: 215 25% 27%;\n\n  --sidebar: 217 33% 15%;\n\n  --sidebar-foreground: 210 40% 98%;\n\n  --sidebar-border: 215 25% 22%;\n\n  --sidebar-primary: 220 90% 66%;\n\n  --sidebar-primary-foreground: 222 47% 11%;\n\n  --sidebar-accent: 217 33% 20%;\n\n  --sidebar-accent-foreground: 210 40% 98%;\n\n  --sidebar-ring: 220 90% 66%;\n\n  --popover: 217 33% 19%;\n\n  --popover-foreground: 210 40% 98%;\n\n  --popover-border: 215 25% 28%;\n\n  --primary: 220 90% 56%;\n\n  --primary-foreground: 0 0% 100%;\n\n  --secondary: 217 33% 22%;\n\n  --secondary-foreground: 210 40% 98%;\n\n  --muted: 215 14% 28%;\n\n  --muted-foreground: 215 20% 65%;\n\n  --accent: 217 33% 20%;\n\n  --accent-foreground: 210 40% 98%;\n\n  --destructive: 0 84% 50%;\n\n  --destructive-foreground: 0 0% 100%;\n\n  --input: 215 25% 35%;\n  --ring: 220 90% 66%;\n  --chart-1: 142 71% 45%;\n  --chart-2: 38 92% 55%;\n  --chart-3: 220 90% 66%;\n  --chart-4: 280 65% 70%;\n  --chart-5: 340 75% 65%;\n\n  --shadow-2xs: 0px 1px 2px 0px hsl(0 0% 0% / 0.3);\n  --shadow-xs: 0px 1px 3px 0px hsl(0 0% 0% / 0.4);\n  --shadow-sm: 0px 2px 4px -1px hsl(0 0% 0% / 0.35), 0px 1px 2px -1px hsl(0 0% 0% / 0.4);\n  --shadow: 0px 4px 6px -1px hsl(0 0% 0% / 0.4), 0px 2px 4px -1px hsl(0 0% 0% / 0.35);\n  --shadow-md: 0px 6px 12px -2px hsl(0 0% 0% / 0.45), 0px 3px 7px -3px hsl(0 0% 0% / 0.4);\n  --shadow-lg: 0px 10px 20px -5px hsl(0 0% 0% / 0.5), 0px 6px 10px -5px hsl(0 0% 0% / 0.45);\n  --shadow-xl: 0px 20px 30px -10px hsl(0 0% 0% / 0.55), 0px 10px 15px -5px hsl(0 0% 0% / 0.5);\n  --shadow-2xl: 0px 25px 50px -12px hsl(0 0% 0% / 0.6);\n\n  /* Automatically computed borders - intensity can be controlled by the user by the --opaque-button-border-intensity setting */\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply bg-background text-foreground font-sans antialiased;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    border-radius: inherit;\n    z-index: -1;\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    border-radius: inherit;\n    z-index: 999;\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}","path":null,"size_bytes":10748,"size_tokens":null},"client/src/components/SplashScreen.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport welcomeHamster from \"@assets/Welcome-Hamster-Cutout.png\";\nimport historianHamsterBlue from \"@assets/Historian-Hamster-Blue.svg\";\nimport librarianHamsterYellow from \"@assets/Librarian-Hamster-Yellow.svg\";\nimport mathsHamsterGreen from \"@assets/Maths-Hamster-Green.svg\";\nimport mechanicHamsterGrey from \"@assets/Mechanic-Hamster-Grey.svg\";\nimport whiteTickBlue from \"@assets/Win-Hamster-Blue.svg\";\nimport questionHamsterBlue from \"@assets/Question-Hamster-Blue.svg\";\n\ninterface SplashScreenProps {\n  onComplete: () => void;\n}\n\nexport function SplashScreen({ onComplete }: SplashScreenProps) {\n  const [fadeIn, setFadeIn] = useState(false);\n  const [imageReady, setImageReady] = useState(false);\n\n  // Preload the welcome hamster image before showing anything\n  useEffect(() => {\n    const img = new Image();\n    img.onload = () => {\n      setImageReady(true);\n    };\n    img.src = welcomeHamster;\n\n    // Preload other GameSelection screen images in background\n    const imagesToPreload = [\n      historianHamsterBlue,\n      librarianHamsterYellow,\n      mathsHamsterGreen,\n      mechanicHamsterGrey,\n      whiteTickBlue,\n      questionHamsterBlue\n    ];\n\n    imagesToPreload.forEach(src => {\n      const preloadImg = new Image();\n      preloadImg.src = src;\n    });\n  }, []);\n\n  // Only trigger fade-in and timer after image is ready\n  useEffect(() => {\n    if (!imageReady) return;\n\n    // Trigger fade-in animation\n    requestAnimationFrame(() => {\n      setFadeIn(true);\n    });\n\n    // Show splash screen for 3 seconds after image loads, then notify parent\n    const timer = setTimeout(() => {\n      onComplete();\n    }, 3000);\n\n    return () => clearTimeout(timer);\n  }, [imageReady, onComplete]);\n\n  // Add app-loaded class to html after fade-in completes to switch from splash blue to app background\n  useEffect(() => {\n    if (fadeIn) {\n      const timer = setTimeout(() => {\n        document.documentElement.classList.add('app-loaded');\n      }, 1100);\n      return () => clearTimeout(timer);\n    }\n  }, [fadeIn]);\n\n  return (\n    <div\n      className=\"fixed inset-0 flex flex-col items-center justify-center p-4\"\n      style={{ backgroundColor: '#7DAAE8' }}\n    >\n      <div \n        className=\"flex flex-col items-center gap-8 transition-opacity duration-1000\"\n        style={{ opacity: fadeIn ? 1 : 0 }}\n      >\n        <h1 className=\"text-5xl font-bold text-white\">\n          Elementle\n        </h1>\n\n        <img \n          src={welcomeHamster} \n          alt=\"Welcome Hamster\" \n          className=\"w-4/5 max-w-xs\"\n        />\n\n        <p className=\"text-3xl text-white\">\n          Welcome back\n        </p>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":2704,"size_tokens":null},"client/src/lib/authUtils.ts":{"content":"// Utility functions for handling auth errors\nexport function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}\n","path":null,"size_bytes":162,"size_tokens":null},"client/src/hooks/useAuth.ts":{"content":"import { useState, useEffect, useCallback } from 'react';\nimport { useSupabase } from '@/lib/SupabaseProvider';\nimport type { User } from '@supabase/supabase-js';\nimport { clearUserCache } from '@/lib/localCache';\nimport { queryClient } from '@/lib/queryClient';\n\nexport function useAuth() {\n  const supabase = useSupabase();\n  const [user, setUser] = useState<User | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    // Get initial session\n    supabase.auth.getSession()\n      .then(({ data: { session } }) => {\n        setUser(session?.user ?? null);\n        setIsLoading(false);\n\n        // Debug: log the current user ID\n        if (session?.user) {\n          console.log(\"Current logged-in user ID:\", session.user.id);\n        } else {\n          console.log(\"No active user session\");\n        }\n      })\n      .catch((error) => {\n        console.warn(\"Failed to get initial session:\", error);\n        setIsLoading(false);\n        setUser(null);\n      });\n\n    // Listen for auth changes\n    const {\n      data: { subscription },\n    } = supabase.auth.onAuthStateChange((_event, session) => {\n      console.log(\"[useAuth] Auth state changed:\", _event);\n      setUser(session?.user ?? null);\n      setIsLoading(false);\n    });\n    \n    // Handle visibility change to refresh session when tab resumes focus\n    // This helps restore sessions that may have expired while tab was inactive\n    const handleVisibilityChange = async () => {\n      if (document.visibilityState === 'visible') {\n        console.log(\"[useAuth] Tab visible - checking session...\");\n        try {\n          // First try to get the current session\n          const { data: { session }, error } = await supabase.auth.getSession();\n          \n          if (error) {\n            console.warn(\"[useAuth] Error getting session on visibility change:\", error);\n            return;\n          }\n          \n          if (session) {\n            // Session exists and is valid - only refresh if token is close to expiry\n            // Check if token expires within next 5 minutes\n            const expiresAt = session.expires_at;\n            const fiveMinutesFromNow = Math.floor(Date.now() / 1000) + 300;\n            \n            if (expiresAt && expiresAt < fiveMinutesFromNow) {\n              // Token expires soon - refresh it\n              console.log(\"[useAuth] Token expiring soon, refreshing...\");\n              const { data: refreshData, error: refreshError } = await supabase.auth.refreshSession();\n              if (refreshError) {\n                console.warn(\"[useAuth] Error refreshing session:\", refreshError);\n                // Don't set user to null on refresh error - keep existing session\n                // The onAuthStateChange will handle actual sign-outs\n              } else if (refreshData.session) {\n                console.log(\"[useAuth] Session refreshed successfully\");\n                setUser(refreshData.session.user);\n              }\n            } else {\n              // Token is still valid - no need to refresh\n              console.log(\"[useAuth] Session still valid, no refresh needed\");\n            }\n          } else {\n            // No session found - but don't immediately set null\n            // Check localStorage for session tokens before declaring signed out\n            const hasLocalTokens = Object.keys(localStorage).some(key => \n              key.startsWith('sb-') && key.includes('-auth-token')\n            );\n            \n            if (!hasLocalTokens) {\n              console.log(\"[useAuth] No session found on visibility change\");\n              setUser(null);\n            } else {\n              console.log(\"[useAuth] No session but local tokens exist - waiting for auth state change\");\n            }\n          }\n        } catch (err) {\n          console.warn(\"[useAuth] Error in visibility change handler:\", err);\n          // Don't set user to null on errors - keep existing state\n        }\n      }\n    };\n    \n    document.addEventListener('visibilitychange', handleVisibilityChange);\n\n    return () => {\n      subscription.unsubscribe();\n      document.removeEventListener('visibilitychange', handleVisibilityChange);\n    };\n  }, [supabase]);\n  \n  // Check if user has completed first login (from user_metadata)\n  const hasCompletedFirstLogin = useCallback((): boolean => {\n    if (!user) return false;\n    return user.user_metadata?.first_login_completed === true;\n  }, [user]);\n  \n  // Detect signup method from session AMR (Authentication Methods Reference)\n  const detectSignupMethod = useCallback(async (): Promise<{ signupMethod: string; passwordCreated: boolean }> => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession();\n      if (session) {\n        // Check the AMR claim to see what auth methods were used\n        const amr = (session as any).user?.amr || [];\n        const hasPasswordAuth = amr.some((method: any) => method.method === 'password');\n        const hasOtpAuth = amr.some((method: any) => method.method === 'otp');\n        \n        // Also check identities for OAuth providers\n        const identities = session.user?.identities || [];\n        const hasGoogleIdentity = identities.some((id: any) => id.provider === 'google');\n        const hasAppleIdentity = identities.some((id: any) => id.provider === 'apple');\n        \n        if (hasGoogleIdentity) {\n          return { signupMethod: 'google', passwordCreated: hasPasswordAuth };\n        } else if (hasAppleIdentity) {\n          return { signupMethod: 'apple', passwordCreated: hasPasswordAuth };\n        } else if (hasPasswordAuth) {\n          return { signupMethod: 'password', passwordCreated: true };\n        } else if (hasOtpAuth) {\n          return { signupMethod: 'magic_link', passwordCreated: false };\n        }\n      }\n      return { signupMethod: 'magic_link', passwordCreated: false };\n    } catch (error) {\n      console.error('Error detecting signup method:', error);\n      return { signupMethod: 'magic_link', passwordCreated: false };\n    }\n  }, [supabase]);\n  \n  // Mark first login as completed (stores in user_metadata and updates profile)\n  const markFirstLoginCompleted = useCallback(async (): Promise<boolean> => {\n    try {\n      // Detect and record signup method\n      const { signupMethod, passwordCreated } = await detectSignupMethod();\n      console.log('[useAuth] Detected signup method:', signupMethod, 'passwordCreated:', passwordCreated);\n      \n      // Update user metadata\n      const { error } = await supabase.auth.updateUser({\n        data: { first_login_completed: true }\n      });\n      if (error) {\n        console.error(\"Failed to mark first login completed:\", error);\n        return false;\n      }\n      \n      // Update profile with signup method (only if not already set)\n      try {\n        const { data: { session } } = await supabase.auth.getSession();\n        if (session) {\n          await fetch('/api/auth/profile/signup-method', {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n              'Authorization': `Bearer ${session.access_token}`,\n            },\n            body: JSON.stringify({ signupMethod, passwordCreated }),\n          });\n          \n          // If Google or Apple OAuth was used, also set google_linked/apple_linked\n          if (signupMethod === 'google') {\n            await fetch('/api/auth/profile/oauth-linked', {\n              method: 'POST',\n              headers: {\n                'Content-Type': 'application/json',\n                'Authorization': `Bearer ${session.access_token}`,\n              },\n              body: JSON.stringify({ provider: 'google', linked: true }),\n            });\n          } else if (signupMethod === 'apple') {\n            await fetch('/api/auth/profile/oauth-linked', {\n              method: 'POST',\n              headers: {\n                'Content-Type': 'application/json',\n                'Authorization': `Bearer ${session.access_token}`,\n              },\n              body: JSON.stringify({ provider: 'apple', linked: true }),\n            });\n          }\n        }\n      } catch (profileError) {\n        console.error(\"Failed to update profile signup method:\", profileError);\n        // Don't fail the overall operation if profile update fails\n      }\n      \n      // Refresh the user to get updated metadata\n      const { data } = await supabase.auth.getUser();\n      if (data.user) {\n        setUser(data.user);\n      }\n      return true;\n    } catch (error) {\n      console.error(\"Error marking first login completed:\", error);\n      return false;\n    }\n  }, [supabase, detectSignupMethod]);\n\n  const signUp = async (email: string, password: string, firstName: string, lastName: string) => {\n    // Clear any guest game data before signing up to prevent conflicts\n    clearUserCache();\n    // Also clear React Query cache to ensure fresh data fetch\n    queryClient.clear();\n    \n    // Call server-side signup endpoint which creates both auth user and profile\n    const response = await fetch('/api/auth/signup', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ email, password, firstName, lastName }),\n    });\n\n    if (!response.ok) {\n      const error = await response.json();\n      throw new Error(error.error || 'Signup failed');\n    }\n\n    const { user } = await response.json();\n\n    // Now sign in with the created credentials\n    const { data, error } = await supabase.auth.signInWithPassword({\n      email,\n      password,\n    });\n\n    if (error) throw error;\n    return data;\n  };\n\n  const signIn = async (email: string, password: string) => {\n    // Clear any guest game data before signing in to prevent conflicts\n    clearUserCache();\n    // Also clear React Query cache to ensure fresh data fetch\n    queryClient.clear();\n    \n    const { data, error} = await supabase.auth.signInWithPassword({\n      email,\n      password,\n    });\n\n    if (error) throw error;\n    return data;\n  };\n\n  const signOut = async () => {\n    const { error } = await supabase.auth.signOut();\n    if (error) throw error;\n  };\n\n  return {\n    user,\n    isLoading,\n    isAuthenticated: !!user,\n    signUp,\n    signIn,\n    signOut,\n    hasCompletedFirstLogin,\n    markFirstLoginCompleted,\n  };\n}\n","path":null,"size_bytes":10284,"size_tokens":null},"server/db.ts":{"content":"import { drizzle } from \"drizzle-orm/postgres-js\";\nimport postgres from \"postgres\";\n\n// Use SUPABASE_DATABASE_URL if available, otherwise DATABASE_URL\nlet databaseUrl = process.env.SUPABASE_DATABASE_URL || process.env.DATABASE_URL;\n\nif (!databaseUrl) {\n  throw new Error(\"SUPABASE_DATABASE_URL or DATABASE_URL must be set\");\n}\n\n// Convert direct connection to session pooler for better compatibility with Replit\n// Direct: postgresql://postgres:pwd@db.xxx.supabase.co:5432/postgres\n// Pooler: postgresql://postgres.xxx:pwd@aws-0-xx.pooler.supabase.com:6543/postgres?pgbouncer=true\nif (databaseUrl.includes('db.') && databaseUrl.includes('.supabase.co:5432')) {\n  // Extract project ref from db.{project-ref}.supabase.co\n  const match = databaseUrl.match(/db\\.([^.]+)\\.supabase\\.co/);\n  if (match) {\n    const projectRef = match[1];\n    const [protocol, rest] = databaseUrl.split('://');\n    const [credentials, hostAndDb] = rest.split('@');\n    const [username, password] = credentials.split(':');\n    const dbName = hostAndDb.split('/')[1];\n    \n    // For pgbouncer, username must be postgres.{project-ref}\n    const poolerUsername = `postgres.${projectRef}`;\n    const poolerHost = `aws-1-eu-west-2.pooler.supabase.com`;\n    \n    databaseUrl = `${protocol}://${poolerUsername}:${password}@${poolerHost}:6543/${dbName}?pgbouncer=true`;\n    console.log(\"Converted direct connection to session pooler with proper username format\");\n  }\n}\n\n// Log connection info (hide password)\nconst safeUrl = databaseUrl.replace(/:([^:@]+)@/, ':****@');\nconsole.log(\"Connecting to DB:\", safeUrl);\n\nconst client = postgres(databaseUrl, { ssl: 'require', prepare: false });\nexport const db = drizzle(client);\n\n","path":null,"size_bytes":1693,"size_tokens":null},"client/src/components/OptionsPage.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { ChevronLeft, Flame, Palmtree } from \"lucide-react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useUserSettings } from \"@/hooks/useUserSettings\";\nimport { useSubscription } from \"@/hooks/useSubscription\";\nimport { readLocal, writeLocal, CACHE_KEYS } from \"@/lib/localCache\";\nimport { soundManager } from \"@/lib/sounds\";\nimport { motion } from \"framer-motion\";\nimport { pageVariants, pageTransition } from \"@/lib/pageAnimations\";\nimport { useAdBannerActive } from \"@/components/AdBanner\";\n\ninterface OptionsPageProps {\n  onBack: () => void;\n}\n\nexport function OptionsPage({ onBack }: OptionsPageProps) {\n  const { isAuthenticated } = useAuth();\n  const { settings, updateSettings } = useUserSettings();\n  const { isPro, tierName } = useSubscription();\n  const adBannerActive = useAdBannerActive();\n\n  const [textSize, setTextSize] = useState<\"small\" | \"medium\" | \"large\">(\"medium\");\n  const [soundsEnabled, setSoundsEnabled] = useState(true);\n  const [darkMode, setDarkMode] = useState(false);\n  const [cluesEnabled, setCluesEnabled] = useState(true);\n  const [digitPreference, setDigitPreference] = useState<\"6\" | \"8\">(\"8\");\n  const [dateFormatOrder, setDateFormatOrder] = useState<\"ddmm\" | \"mmdd\">(\"ddmm\");\n  const [useRegionDefault, setUseRegionDefault] = useState(true);\n  const [streakSaverActive, setStreakSaverActive] = useState(true);\n  const [holidaySaverActive, setHolidaySaverActive] = useState(true);\n  \n  // Check if user has Pro or Education tier (for holiday saver access)\n  const hasHolidaySaverAccess = isPro || tierName?.toLowerCase() === 'education';\n\n\n  // Load settings from cache first for instant rendering\n  useEffect(() => {\n    const cachedSettings = readLocal<any>(CACHE_KEYS.SETTINGS);\n    if (cachedSettings) {\n      const size = (cachedSettings.textSize as \"small\" | \"medium\" | \"large\") || \"medium\";\n      setTextSize(size);\n      const soundsEnabledValue = cachedSettings.soundsEnabled ?? true;\n      setSoundsEnabled(soundsEnabledValue);\n      soundManager.setEnabled(soundsEnabledValue);\n      setDarkMode(cachedSettings.darkMode ?? false);\n      setCluesEnabled(cachedSettings.cluesEnabled ?? true);\n      setDigitPreference(cachedSettings.digitPreference || \"8\");\n\n      // Extract date format order from dateFormatPreference\n      const dateFormatPref = cachedSettings.dateFormatPreference || \"ddmmyy\";\n      const order = dateFormatPref.startsWith(\"dd\") ? \"ddmm\" : \"mmdd\";\n      setDateFormatOrder(order);\n\n      setUseRegionDefault(cachedSettings.useRegionDefault ?? true);\n      \n      // Streak saver settings\n      setStreakSaverActive(cachedSettings.streakSaverActive ?? true);\n      setHolidaySaverActive(cachedSettings.holidaySaverActive ?? true);\n\n      // Apply settings to DOM\n      document.documentElement.style.setProperty(\n        \"--text-scale\",\n        size === \"small\" ? \"0.875\" : size === \"large\" ? \"1.125\" : \"1\"\n      );\n      document.documentElement.classList.toggle(\"dark\", cachedSettings.darkMode ?? false);\n    } else {\n      // Minimal sane defaults if no cache yet\n      document.documentElement.style.setProperty(\"--text-scale\", \"1\");\n      document.documentElement.classList.toggle(\"dark\", false);\n    }\n  }, []); // Run once on mount\n\n  // Background reconciliation: prefer Supabase settings when available; otherwise fall back to localStorage\n  useEffect(() => {\n    if (settings) {\n      // Apply from Supabase-provided settings\n      const size = (settings.textSize as \"small\" | \"medium\" | \"large\") || \"medium\";\n      setTextSize(size);\n      document.documentElement.style.setProperty(\n        \"--text-scale\",\n        size === \"small\" ? \"0.875\" : size === \"large\" ? \"1.125\" : \"1\"\n      );\n\n      const soundsVal = settings.soundsEnabled ?? true;\n      setSoundsEnabled(soundsVal);\n      soundManager.setEnabled(soundsVal);\n\n      const isDark = settings.darkMode ?? false;\n      setDarkMode(isDark);\n      document.documentElement.classList.toggle(\"dark\", isDark);\n\n      setCluesEnabled(settings.cluesEnabled ?? true);\n      setDigitPreference((settings.digitPreference as \"6\" | \"8\") || \"8\");\n\n      const datePref = settings.dateFormatPreference || \"ddmmyy\";\n      const order = datePref.startsWith(\"dd\") ? \"ddmm\" : \"mmdd\";\n      setDateFormatOrder(order);\n\n      setUseRegionDefault(settings.useRegionDefault ?? true);\n      \n      // Streak saver settings\n      setStreakSaverActive((settings as any).streakSaverActive ?? true);\n      setHolidaySaverActive((settings as any).holidaySaverActive ?? true);\n\n      // Update cache so future loads render instantly\n      writeLocal(CACHE_KEYS.SETTINGS, settings);\n      return; // stop; we prefer server settings when present\n    }\n\n    // Fallback to localStorage when settings are not yet loaded\n    const storedTheme = localStorage.getItem(\"theme\");\n    const isDark = storedTheme === \"dark\";\n    setDarkMode(isDark);\n    document.documentElement.classList.toggle(\"dark\", isDark);\n\n    const storedTextSize = localStorage.getItem(\"textSize\") as \"small\" | \"medium\" | \"large\" | null;\n    const size = storedTextSize || \"medium\";\n    setTextSize(size);\n    document.documentElement.style.setProperty(\n      \"--text-scale\",\n      size === \"small\" ? \"0.875\" : size === \"large\" ? \"1.125\" : \"1\"\n    );\n\n    const storedSounds = localStorage.getItem(\"soundsEnabled\");\n    const soundsEnabledValue = storedSounds !== null ? storedSounds === \"true\" : true;\n    setSoundsEnabled(soundsEnabledValue);\n    soundManager.setEnabled(soundsEnabledValue);\n\n    const storedClues = localStorage.getItem(\"cluesEnabled\");\n    if (storedClues !== null) setCluesEnabled(storedClues === \"true\");\n\n    const storedDigitPref = localStorage.getItem(\"digitPreference\");\n    if (storedDigitPref) setDigitPreference(storedDigitPref as \"6\" | \"8\");\n\n    const storedDateFormatOrder = localStorage.getItem(\"dateFormatOrder\");\n    if (storedDateFormatOrder) setDateFormatOrder(storedDateFormatOrder as \"ddmm\" | \"mmdd\");\n\n    const storedUseRegionDefault = localStorage.getItem(\"useRegionDefault\");\n    if (storedUseRegionDefault !== null) setUseRegionDefault(storedUseRegionDefault === \"true\");\n    \n    // Streak saver settings from localStorage for guests\n    const storedStreakSaverActive = localStorage.getItem(\"streakSaverActive\");\n    if (storedStreakSaverActive !== null) setStreakSaverActive(storedStreakSaverActive === \"true\");\n    \n    const storedHolidaySaverActive = localStorage.getItem(\"holidaySaverActive\");\n    if (storedHolidaySaverActive !== null) setHolidaySaverActive(storedHolidaySaverActive === \"true\");\n  }, [settings]);\n\n  const handleTextSizeChange = async (size: \"small\" | \"medium\" | \"large\") => {\n    setTextSize(size);\n    document.documentElement.style.setProperty(\n      \"--text-scale\",\n      size === \"small\" ? \"0.875\" : size === \"large\" ? \"1.125\" : \"1\"\n    );\n\n    // If we have settings (authenticated flow), persist via updateSettings and cache\n    if (settings && isAuthenticated) {\n      try {\n        await updateSettings({ textSize: size });\n      } catch (e) {\n        console.warn(\"Failed to update settings in Supabase; will still update cache/localStorage.\");\n      }\n      const cachedSettings = readLocal<any>(CACHE_KEYS.SETTINGS) || {};\n      writeLocal(CACHE_KEYS.SETTINGS, { ...cachedSettings, textSize: size });\n    } else {\n      // Guest/local-only\n      localStorage.setItem(\"textSize\", size);\n    }\n  };\n\n\n  const handleDarkModeToggle = async (checked: boolean) => {\n  setDarkMode(checked);\n  document.documentElement.classList.toggle(\"dark\", checked);\n  const newTheme = checked ? \"dark\" : \"light\";\n\n  if (settings && isAuthenticated) {\n    try {\n      await updateSettings({ darkMode: checked });\n    } catch (e) {\n      console.warn(\"Failed to update darkMode in Supabase; falling back to cache/localStorage.\");\n    }\n    const cachedSettings = readLocal<any>(CACHE_KEYS.SETTINGS) || {};\n    writeLocal(CACHE_KEYS.SETTINGS, { ...cachedSettings, darkMode: checked });\n  } else {\n    localStorage.setItem(\"theme\", newTheme);\n  }\n};\n\nconst handleSoundsToggle = async (checked: boolean) => {\n  setSoundsEnabled(checked);\n  soundManager.setEnabled(checked);\n\n  if (settings && isAuthenticated) {\n    try {\n      await updateSettings({ soundsEnabled: checked });\n    } catch (e) {\n      console.warn(\"Failed to update soundsEnabled in Supabase; falling back to cache/localStorage.\");\n    }\n    const cachedSettings = readLocal<any>(CACHE_KEYS.SETTINGS) || {};\n    writeLocal(CACHE_KEYS.SETTINGS, { ...cachedSettings, soundsEnabled: checked });\n  } else {\n    localStorage.setItem(\"soundsEnabled\", String(checked));\n  }\n};\n\nconst handleCluesToggle = async (checked: boolean) => {\n  setCluesEnabled(checked);\n\n  if (settings && isAuthenticated) {\n    try {\n      await updateSettings({ cluesEnabled: checked });\n    } catch (e) {\n      console.warn(\"Failed to update cluesEnabled in Supabase; falling back to cache/localStorage.\");\n    }\n    const cachedSettings = readLocal<any>(CACHE_KEYS.SETTINGS) || {};\n    writeLocal(CACHE_KEYS.SETTINGS, { ...cachedSettings, cluesEnabled: checked });\n  } else {\n    localStorage.setItem(\"cluesEnabled\", String(checked));\n  }\n};\n\nconst handleDigitPreferenceChange = async (value: \"6\" | \"8\") => {\n  setDigitPreference(value);\n\n  // Build the full dateFormatPreference based on order and digit count\n  const suffix = value === \"6\" ? \"yy\" : \"yyyy\";\n  const fullFormat = dateFormatOrder === \"ddmm\" ? `dd/mm/${suffix}` : `mm/dd/${suffix}`;\n  const dbFormat = fullFormat.replace(/\\//g, \"\"); // ddmmyy, mmddyy, ddmmyyyy, mmddyyyy\n\n  // When user explicitly changes digit preference, disable region default\n  setUseRegionDefault(false);\n\n  if (settings && isAuthenticated) {\n    try {\n      await updateSettings({\n        digitPreference: value,\n        dateFormatPreference: dbFormat,\n        useRegionDefault: false,\n      });\n    } catch (e) {\n      console.warn(\"Failed to update digit/date prefs in Supabase; falling back to cache/localStorage.\");\n    }\n    const cachedSettings = readLocal<any>(CACHE_KEYS.SETTINGS) || {};\n    writeLocal(CACHE_KEYS.SETTINGS, {\n      ...cachedSettings,\n      digitPreference: value,\n      dateFormatPreference: dbFormat,\n      useRegionDefault: false,\n    });\n  } else {\n    localStorage.setItem(\"digitPreference\", value);\n    localStorage.setItem(\"dateFormatOrder\", dateFormatOrder);\n    localStorage.setItem(\"useRegionDefault\", \"false\");\n  }\n};\n\nconst handleDateFormatOrderChange = async (value: \"ddmm\" | \"mmdd\") => {\n  setDateFormatOrder(value);\n\n  // Build the full dateFormatPreference based on order and digit count\n  const suffix = digitPreference === \"6\" ? \"yy\" : \"yyyy\";\n  const fullFormat = value === \"ddmm\" ? `dd/mm/${suffix}` : `mm/dd/${suffix}`;\n  const dbFormat = fullFormat.replace(/\\//g, \"\"); // ddmmyy, mmddyy, ddmmyyyy, mmddyyyy\n\n  // When user explicitly changes date format order, disable region default\n  setUseRegionDefault(false);\n\n  if (settings && isAuthenticated) {\n    try {\n      await updateSettings({\n        dateFormatPreference: dbFormat,\n        useRegionDefault: false,\n      });\n    } catch (e) {\n      console.warn(\"Failed to update date format in Supabase; falling back to cache/localStorage.\");\n    }\n    const cachedSettings = readLocal<any>(CACHE_KEYS.SETTINGS) || {};\n    writeLocal(CACHE_KEYS.SETTINGS, {\n      ...cachedSettings,\n      dateFormatPreference: dbFormat,\n      useRegionDefault: false,\n    });\n  } else {\n    localStorage.setItem(\"dateFormatOrder\", value);\n    localStorage.setItem(\"useRegionDefault\", \"false\");\n  }\n};\n\nconst handleUseRegionDefaultToggle = async (checked: boolean) => {\n  setUseRegionDefault(checked);\n\n  if (settings && isAuthenticated) {\n    try {\n      await updateSettings({ useRegionDefault: checked });\n    } catch (e) {\n      console.warn(\"Failed to update useRegionDefault in Supabase; falling back to cache/localStorage.\");\n    }\n    const cachedSettings = readLocal<any>(CACHE_KEYS.SETTINGS) || {};\n    writeLocal(CACHE_KEYS.SETTINGS, { ...cachedSettings, useRegionDefault: checked });\n  } else {\n    localStorage.setItem(\"useRegionDefault\", String(checked));\n  }\n};\n\nconst handleStreakSaverToggle = async (checked: boolean) => {\n  setStreakSaverActive(checked);\n\n  if (settings && isAuthenticated) {\n    try {\n      await updateSettings({ streakSaverActive: checked } as any);\n    } catch (e) {\n      console.warn(\"Failed to update streakSaverActive in Supabase; falling back to cache/localStorage.\");\n    }\n    const cachedSettings = readLocal<any>(CACHE_KEYS.SETTINGS) || {};\n    writeLocal(CACHE_KEYS.SETTINGS, { ...cachedSettings, streakSaverActive: checked });\n  } else {\n    localStorage.setItem(\"streakSaverActive\", String(checked));\n  }\n};\n\nconst handleHolidaySaverToggle = async (checked: boolean) => {\n  setHolidaySaverActive(checked);\n\n  if (settings && isAuthenticated) {\n    try {\n      await updateSettings({ holidaySaverActive: checked } as any);\n    } catch (e) {\n      console.warn(\"Failed to update holidaySaverActive in Supabase; falling back to cache/localStorage.\");\n    }\n    const cachedSettings = readLocal<any>(CACHE_KEYS.SETTINGS) || {};\n    writeLocal(CACHE_KEYS.SETTINGS, { ...cachedSettings, holidaySaverActive: checked });\n  } else {\n    localStorage.setItem(\"holidaySaverActive\", String(checked));\n  }\n};\n\nreturn (\n  <div\n    className={`min-h-screen flex flex-col p-4 bg-background ${adBannerActive ? 'pb-24' : ''}`}\n  >\n      <div className=\"w-full max-w-md mx-auto space-y-4\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <button\n            onClick={onBack}\n            data-testid=\"button-back-from-options\"\n            className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n          >\n            <ChevronLeft className=\"h-9 w-9 text-gray-700\" />\n          </button>\n\n          <h1 className=\"text-4xl font-bold\">Options</h1>\n\n          <div className=\"w-14\" />\n        </div>\n\n        <Card className=\"p-6 space-y-6\">\n          <div className=\"space-y-4\">\n            <Label className=\"text-base font-semibold\">Text Size</Label>\n            <div className=\"flex gap-2\">\n              {([\"small\", \"medium\", \"large\"] as const).map((size) => (\n                <Button\n                  key={size}\n                  variant={textSize === size ? \"default\" : \"outline\"}\n                  onClick={() => handleTextSizeChange(size)}\n                  className=\"flex-1\"\n                  data-testid={`button-text-size-${size}`}\n                >\n                  {size.charAt(0).toUpperCase() + size.slice(1)}\n                </Button>\n              ))}\n            </div>\n          </div>\n\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <Label htmlFor=\"sounds\" className=\"text-base\">\n                Sounds\n              </Label>\n              <p className=\"text-sm text-muted-foreground\">Play sound effects</p>\n            </div>\n            <Switch\n              id=\"sounds\"\n              checked={soundsEnabled}\n              onCheckedChange={handleSoundsToggle}\n              data-testid=\"switch-sounds\"\n            />\n          </div>\n\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <Label htmlFor=\"darkMode\" className=\"text-base\">\n                Dark Mode\n              </Label>\n              <p className=\"text-sm text-muted-foreground\">Toggle dark theme</p>\n            </div>\n            <Switch\n              id=\"darkMode\"\n              checked={darkMode}\n              onCheckedChange={handleDarkModeToggle}\n              data-testid=\"switch-dark-mode\"\n            />\n          </div>\n\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <Label htmlFor=\"clues\" className=\"text-base\">\n                Clues\n              </Label>\n              <p className=\"text-sm text-muted-foreground\">\n                Show the event title when guessing\n              </p>\n            </div>\n            <Switch\n              id=\"clues\"\n              checked={cluesEnabled}\n              onCheckedChange={handleCluesToggle}\n              data-testid=\"switch-clues\"\n            />\n          </div>\n\n          <div className=\"space-y-4\">\n            <Label className=\"text-base font-semibold\">Date Format</Label>\n            <div className=\"flex gap-2\">\n              {([\"6\", \"8\"] as const).map((digits) => (\n                <Button\n                  key={digits}\n                  variant={digitPreference === digits ? \"default\" : \"outline\"}\n                  onClick={() => handleDigitPreferenceChange(digits)}\n                  className=\"flex-1\"\n                  data-testid={`button-digit-${digits}`}\n                >\n                  {digits} Digits\n                </Button>\n              ))}\n            </div>\n            <p className=\"text-sm text-muted-foreground\">\n              Choose between 6-digit or 8-digit date format\n            </p>\n\n            <div className=\"flex gap-2 mt-4\">\n              {([\"ddmm\", \"mmdd\"] as const).map((order) => (\n                <Button\n                  key={order}\n                  variant={dateFormatOrder === order ? \"default\" : \"outline\"}\n                  onClick={() => handleDateFormatOrderChange(order)}\n                  className=\"flex-1\"\n                  data-testid={`button-date-order-${order}`}\n                >\n                  {order === \"ddmm\" ? \"DD/MM/YY\" : \"MM/DD/YY\"}\n                </Button>\n              ))}\n            </div>\n            <p className=\"text-sm text-muted-foreground\">Choose date format order</p>\n          </div>\n\n        </Card>\n\n        {/* Streak Saver Section */}\n        <Card className=\"p-6 space-y-6\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <Flame className=\"h-5 w-5 text-orange-500\" />\n            <Label className=\"text-base font-semibold\">Streak Saver</Label>\n          </div>\n          \n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <Label htmlFor=\"streakSaver\" className=\"text-base\">\n                Streak Saver Reminders\n              </Label>\n              <p className=\"text-sm text-muted-foreground\">\n                Show popup to save your streak when you miss a day\n              </p>\n            </div>\n            <Switch\n              id=\"streakSaver\"\n              checked={streakSaverActive}\n              onCheckedChange={handleStreakSaverToggle}\n              data-testid=\"switch-streak-saver\"\n            />\n          </div>\n\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <div className=\"flex items-center gap-2\">\n                <Label htmlFor=\"holidaySaver\" className={`text-base ${!hasHolidaySaverAccess ? 'text-muted-foreground' : ''}`}>\n                  Holiday Protection\n                </Label>\n                {!hasHolidaySaverAccess && (\n                  <span className=\"text-xs bg-primary/10 text-primary px-2 py-0.5 rounded-full font-medium\">\n                    Pro\n                  </span>\n                )}\n              </div>\n              <p className=\"text-sm text-muted-foreground\">\n                {hasHolidaySaverAccess \n                  ? \"Enable holiday mode option in streak saver popup\"\n                  : \"Upgrade to Pro to protect your streak during holidays\"\n                }\n              </p>\n            </div>\n            <Switch\n              id=\"holidaySaver\"\n              checked={holidaySaverActive}\n              onCheckedChange={handleHolidaySaverToggle}\n              disabled={!hasHolidaySaverAccess}\n              data-testid=\"switch-holiday-saver\"\n            />\n          </div>\n        </Card>\n\n        {!isAuthenticated && (\n          <p className=\"text-sm text-muted-foreground text-center\">\n            Sign in to sync your settings across devices\n          </p>\n        )}\n      </div>\n    </div>\n);\n}\n\n","path":null,"size_bytes":20342,"size_tokens":null},"client/src/components/SettingsPage.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { ChevronLeft, ChevronRight, User, Settings as SettingsIcon, Bug, MessageSquare, Info, Lock, FileText, LogOut, Crown, Grid, Shield, Flame } from \"lucide-react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useProfile } from \"@/hooks/useProfile\";\nimport { useLocation } from \"wouter\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport { clearUserCache } from \"@/lib/localCache\";\nimport { motion } from \"framer-motion\";\nimport { pageVariants, pageTransition } from \"@/lib/pageAnimations\";\nimport { useSubscription } from \"@/hooks/useSubscription\";\nimport { useCategoryRestriction } from \"@/hooks/useCategoryRestriction\";\nimport { ProSubscriptionDialog } from \"@/components/ProSubscriptionDialog\";\nimport { CategorySelectionScreen } from \"@/components/CategorySelectionScreen\";\nimport { GuestRestrictionPopup } from \"@/components/GuestRestrictionPopup\";\nimport { useAdBannerActive } from \"@/components/AdBanner\";\nimport { AdminPage } from \"@/components/AdminPage\";\nimport { ManageSubscriptionPage } from \"@/components/ManageSubscriptionPage\";\nimport { AlertDialog, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogAction } from \"@/components/ui/alert-dialog\";\n\ninterface SettingsPageProps {\n  onBack: () => void;\n  onOpenOptions: () => void;\n  onAccountInfo: () => void;\n  onBugReport?: () => void;\n  onFeedback?: () => void;\n  onPrivacy?: () => void;\n  onTerms?: () => void;\n  onAbout?: () => void;\n  onSignOut?: () => void;\n  onLogin?: () => void;\n  onRegister?: () => void;\n}\n\nexport function SettingsPage({ onBack, onOpenOptions, onAccountInfo, onBugReport, onFeedback, onPrivacy, onTerms, onAbout, onSignOut, onLogin, onRegister }: SettingsPageProps) {\n  const { user, isAuthenticated, signOut } = useAuth();\n  const { profile } = useProfile();\n  const [, setLocation] = useLocation();\n  const queryClient = useQueryClient();\n  const { subscription, isPro, isLoading: subscriptionLoading } = useSubscription();\n  const { isLoading: categoryRestrictionLoading, isAllowed: categoryAllowed, isRestricted: categoryRestricted, message: categoryRestrictionMessage } = useCategoryRestriction();\n  const adBannerActive = useAdBannerActive();\n  const [showProDialog, setShowProDialog] = useState(false);\n  const [showCategorySelection, setShowCategorySelection] = useState(false);\n  const [showGuestRestriction, setShowGuestRestriction] = useState(false);\n  const [showGuestRestrictionPro, setShowGuestRestrictionPro] = useState(false);\n  const [showAdminPage, setShowAdminPage] = useState(false);\n  const [showManageSubscription, setShowManageSubscription] = useState(false);\n  const [showCategoryRestrictionPopup, setShowCategoryRestrictionPopup] = useState(false);\n  \n  const isAdmin = profile?.isAdmin === true;\n  \n  const handleCategorySelectionClick = () => {\n    if (categoryRestrictionLoading) {\n      return;\n    }\n    if (!categoryAllowed) {\n      setShowCategoryRestrictionPopup(true);\n    } else {\n      setShowCategorySelection(true);\n    }\n  };\n  \n  const handleProButtonClick = () => {\n    if (!isAuthenticated || !user) {\n      setShowGuestRestrictionPro(true);\n      return;\n    }\n    \n    if (isPro) {\n      setShowManageSubscription(true);\n    } else {\n      setShowProDialog(true);\n    }\n  };\n  \n  // Subscription-related items - show Go Pro for all users (including guests)\n  const subscriptionItems = [\n    {\n      icon: Crown,\n      label: isPro ? \"Pro\" : \"Go Pro\",\n      inlineLabel: isPro ? \"Manage your subscription\" : null,\n      sublabel: !isPro ? \"Remove ads & customize categories\" : null,\n      onClick: handleProButtonClick,\n      testId: \"button-subscription\",\n      highlight: !isPro,\n      proItem: isPro,\n      disabled: false,\n    },\n    ...(isPro ? [{\n      icon: Grid,\n      label: \"Select Categories\",\n      inlineLabel: null,\n      sublabel: null,\n      onClick: handleCategorySelectionClick,\n      testId: \"button-select-categories\",\n      highlight: false,\n      proItem: true,\n      disabled: categoryRestrictionLoading,\n    }] : []),\n    ...(!isPro && isAuthenticated ? [{\n      icon: Flame,\n      label: \"Streak Saver\",\n      inlineLabel: null,\n      sublabel: null,\n      onClick: () => setShowManageSubscription(true),\n      testId: \"button-streak-saver\",\n      highlight: false,\n      proItem: false,\n      disabled: false,\n    }] : []),\n  ];\n  \n  // Admin menu item - only visible for admin users\n  const adminItems = isAdmin ? [{\n    icon: Shield,\n    label: \"Admin\",\n    onClick: () => setShowAdminPage(true),\n    testId: \"button-admin\",\n    adminItem: true,\n  }] : [];\n\n  const menuItems = [\n    {\n      icon: User,\n      label: \"Account Info\",\n      onClick: () => {\n        if (isAuthenticated && user) {\n          onAccountInfo();\n        } else {\n          setShowGuestRestriction(true);\n        }\n      },\n      testId: \"button-account-info\",\n    },\n    ...subscriptionItems,\n    ...adminItems,\n    {\n      icon: SettingsIcon,\n      label: \"Options\",\n      onClick: onOpenOptions,\n      testId: \"button-options-from-settings\",\n    },\n    {\n      icon: Bug,\n      label: \"Report a Bug\",\n      onClick: onBugReport || (() => alert(\"Bug report coming soon\")),\n      testId: \"button-bug-report\",\n    },\n    {\n      icon: MessageSquare,\n      label: \"Feedback\",\n      onClick: onFeedback || (() => alert(\"Feedback form coming soon\")),\n      testId: \"button-feedback\",\n    },\n    {\n      icon: Info,\n      label: \"About\",\n      onClick: onAbout || (() => alert(\"About page coming soon\")),\n      testId: \"button-about\",\n    },\n    {\n      icon: Lock,\n      label: \"Privacy\",\n      onClick: onPrivacy || (() => alert(\"Privacy page coming soon\")),\n      testId: \"button-privacy\",\n    },\n    {\n      icon: FileText,\n      label: \"Terms\",\n      onClick: onTerms || (() => alert(\"Terms page coming soon\")),\n      testId: \"button-terms\",\n    },\n  ];\n\n  const handleSignOut = async () => {\n    try {\n      // Clear user-specific cached data from localStorage\n      clearUserCache();\n      \n      // Clear ALL React Query caches to prevent data leaks between users\n      // Using clear() removes all cached data, not just invalidating it\n      queryClient.clear();\n      \n      // Sign out from Supabase\n      await signOut();\n      \n      // Navigate to login screen using callback (if provided) or fallback to reload\n      if (onSignOut) {\n        onSignOut();\n      } else {\n        window.location.href = \"/\";\n      }\n    } catch (error) {\n      console.error(\"Error signing out:\", error);\n      alert(\"Failed to sign out. Please try again.\");\n    }\n  };\n\n  // Show AdminPage if selected\n  if (showAdminPage) {\n    return <AdminPage onBack={() => setShowAdminPage(false)} />;\n  }\n\n  // Show ManageSubscriptionPage if selected\n  if (showManageSubscription) {\n    return (\n      <ManageSubscriptionPage \n        onBack={() => setShowManageSubscription(false)}\n        onGoProClick={() => {\n          setShowManageSubscription(false);\n          setShowProDialog(true);\n        }}\n      />\n    );\n  }\n\n  return (\n    <div \n      className={`min-h-screen flex flex-col p-4 bg-background ${adBannerActive ? 'pb-[50px]' : ''}`}\n    >\n      <div className=\"w-full max-w-md mx-auto space-y-4\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <button\n            onClick={onBack}\n            data-testid=\"button-back-from-settings\"\n            className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n          >\n            <ChevronLeft className=\"h-9 w-9 text-gray-700\" />\n          </button>\n\n          <div className=\"flex flex-col items-center\">\n            <h1 className=\"text-4xl font-bold\">Settings</h1>\n          </div>\n\n          {/* Spacer to balance layout */}\n          <div className=\"w-14\" />\n        </div>\n\n        <Card className=\"p-4 space-y-2\">\n          {menuItems.map((item) => {\n            const isProItem = (item as any).proItem;\n            const isAdminItem = (item as any).adminItem;\n            const inlineLabel = (item as any).inlineLabel;\n            const sublabel = (item as any).sublabel;\n            const highlight = (item as any).highlight;\n            const isDisabled = (item as any).disabled;\n            \n            return (\n              <button\n                key={item.label}\n                onClick={item.onClick}\n                disabled={isDisabled}\n                className={`w-full flex items-center justify-between p-3 rounded-md transition-colors ${\n                  isDisabled \n                    ? \"opacity-50 cursor-not-allowed\" \n                    : \"\"\n                } ${\n                  isAdminItem\n                    ? \"bg-gradient-to-r from-red-500 to-red-600 text-white hover:from-red-600 hover:to-red-700\"\n                    : isProItem \n                      ? \"bg-gradient-to-r from-orange-400 to-orange-500 text-white hover:from-orange-500 hover:to-orange-600\" \n                      : highlight \n                        ? \"bg-amber-50 dark:bg-amber-950/30 hover-elevate active-elevate-2\" \n                        : \"hover-elevate active-elevate-2\"\n                }`}\n                data-testid={item.testId}\n              >\n                <div className=\"flex items-center gap-3 flex-1\">\n                  <item.icon className={`h-5 w-5 flex-shrink-0 ${\n                    isAdminItem ? \"text-white\" : isProItem ? \"text-white\" : highlight ? \"text-amber-500\" : \"text-muted-foreground\"\n                  }`} />\n                  <span className={`font-medium whitespace-nowrap ${isAdminItem || isProItem ? \"text-white\" : \"\"}`}>{item.label}</span>\n                  {inlineLabel && (\n                    <span className={`text-sm ${isAdminItem || isProItem ? \"text-white/90\" : \"text-muted-foreground\"}`}>{inlineLabel}</span>\n                  )}\n                  {sublabel && (\n                    <div className={`flex-1 flex justify-center`}>\n                      <div className={`text-sm max-w-[150px] text-center ${isAdminItem || isProItem ? \"text-white/90\" : \"text-muted-foreground\"}`}>{sublabel}</div>\n                    </div>\n                  )}\n                </div>\n                <ChevronRight className={`h-5 w-5 flex-shrink-0 ${isAdminItem || isProItem ? \"text-white\" : \"text-muted-foreground\"}`} />\n              </button>\n            );\n          })}\n        </Card>\n\n        {isAuthenticated && (\n          <Button\n            variant=\"destructive\"\n            className=\"w-full\"\n            onClick={handleSignOut}\n            data-testid=\"button-sign-out\"\n          >\n            <LogOut className=\"h-4 w-4 mr-2\" />\n            Sign Out\n          </Button>\n        )}\n      </div>\n      \n      {/* Pro Subscription Dialog */}\n      <ProSubscriptionDialog\n        isOpen={showProDialog}\n        onClose={() => setShowProDialog(false)}\n        onSuccess={() => {\n          setShowProDialog(false);\n          // After successful Pro subscription, show CategorySelectionScreen\n          setShowCategorySelection(true);\n        }}\n      />\n      \n      {/* Category Selection Screen (for Pro users) */}\n      <CategorySelectionScreen\n        isOpen={showCategorySelection}\n        onClose={() => setShowCategorySelection(false)}\n        onGenerate={() => setShowCategorySelection(false)}\n        isRegeneration={true}\n      />\n      \n      {/* Guest Restriction Popup for Account Info */}\n      <GuestRestrictionPopup\n        isOpen={showGuestRestriction}\n        type=\"personal\"\n        onClose={() => setShowGuestRestriction(false)}\n        onRegister={() => {\n          setShowGuestRestriction(false);\n          if (onRegister) onRegister();\n        }}\n        onLogin={() => {\n          setShowGuestRestriction(false);\n          if (onLogin) onLogin();\n        }}\n      />\n      \n      {/* Guest Restriction Popup for Go Pro */}\n      <GuestRestrictionPopup\n        isOpen={showGuestRestrictionPro}\n        type=\"pro\"\n        onClose={() => setShowGuestRestrictionPro(false)}\n        onRegister={() => {\n          setShowGuestRestrictionPro(false);\n          if (onRegister) onRegister();\n        }}\n        onLogin={() => {\n          setShowGuestRestrictionPro(false);\n          if (onLogin) onLogin();\n        }}\n      />\n      \n      {/* Category Restriction Popup */}\n      <AlertDialog open={showCategoryRestrictionPopup} onOpenChange={setShowCategoryRestrictionPopup}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Categories Recently Updated</AlertDialogTitle>\n            <AlertDialogDescription>\n              {categoryRestrictionMessage || \"You cannot update your categories at this time.\"}\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogAction onClick={() => setShowCategoryRestrictionPopup(false)}>\n              OK\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":13125,"size_tokens":null},"SUPABASE_SETUP.md":{"content":"# Supabase Setup Instructions\n\n## Prerequisites\n- Supabase project created at [supabase.com](https://supabase.com)\n- Environment variables set in Replit Secrets:\n  - `SUPABASE_URL`\n  - `SUPABASE_ANON_KEY`\n  - `SUPABASE_SERVICE_ROLE_KEY`\n\n## Database Schema Setup\n\n### 1. Enable UUID Extension\nRun this in your Supabase SQL Editor:\n```sql\nCREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";\n```\n\n### 2. Create Tables\nThe following tables will be created automatically via Drizzle push:\n\n- **user_profiles** - Extends Supabase Auth users\n- **puzzles** - Historical date puzzles\n- **user_settings** - User preferences\n- **game_attempts** - Game session tracking\n- **guesses** - Individual guess records (governance)\n- **user_stats** - Aggregated user statistics\n\n### 3. Push Schema to Supabase\n\nRun from your project root:\n```bash\nnpm run db:push\n```\n\nIf you encounter conflicts, use:\n```bash\nnpm run db:push --force\n```\n\n### 4. Seed Puzzle Data\n\nRun the seed script:\n```bash\ntsx server/supabase-seed.ts\n```\n\nThis will populate the `puzzles` table with 31 October 2025 historical events.\n\n## Row Level Security (RLS)\n\n### Enable RLS on all tables:\n```sql\nALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;\nALTER TABLE user_settings ENABLE ROW LEVEL SECURITY;\nALTER TABLE game_attempts ENABLE ROW LEVEL SECURITY;\nALTER TABLE guesses ENABLE ROW LEVEL SECURITY;\nALTER TABLE user_stats ENABLE ROW LEVEL SECURITY;\n```\n\n### Create RLS Policies:\n\n**user_profiles:**\n```sql\n-- Users can read their own profile\nCREATE POLICY \"Users can view own profile\"\n  ON user_profiles FOR SELECT\n  USING (auth.uid() = id);\n\n-- Users can update their own profile\nCREATE POLICY \"Users can update own profile\"\n  ON user_profiles FOR UPDATE\n  USING (auth.uid() = id);\n\n-- Service role can insert profiles (for signup)\nCREATE POLICY \"Service role can insert profiles\"\n  ON user_profiles FOR INSERT\n  WITH CHECK (true);\n```\n\n**user_settings:**\n```sql\nCREATE POLICY \"Users can manage own settings\"\n  ON user_settings FOR ALL\n  USING (auth.uid() = user_id);\n```\n\n**game_attempts:**\n```sql\n-- Users can view their own attempts\nCREATE POLICY \"Users can view own attempts\"\n  ON game_attempts FOR SELECT\n  USING (auth.uid() = user_id);\n\n-- Users can insert their own attempts\nCREATE POLICY \"Users can insert own attempts\"\n  ON game_attempts FOR INSERT\n  WITH CHECK (auth.uid() = user_id);\n\n-- Admins can view all attempts\nCREATE POLICY \"Admins can view all attempts\"\n  ON game_attempts FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM user_profiles\n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n```\n\n**guesses:**\n```sql\n-- Users can view their own guesses\nCREATE POLICY \"Users can view own guesses\"\n  ON guesses FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM game_attempts\n      WHERE game_attempts.id = guesses.game_attempt_id\n      AND game_attempts.user_id = auth.uid()\n    )\n  );\n\n-- Users can insert guesses for their own attempts\nCREATE POLICY \"Users can insert own guesses\"\n  ON guesses FOR INSERT\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM game_attempts\n      WHERE game_attempts.id = guesses.game_attempt_id\n      AND game_attempts.user_id = auth.uid()\n    )\n  );\n\n-- Admins can view all guesses\nCREATE POLICY \"Admins can view all guesses\"\n  ON guesses FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM user_profiles\n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n```\n\n**user_stats:**\n```sql\nCREATE POLICY \"Users can manage own stats\"\n  ON user_stats FOR ALL\n  USING (auth.uid() = user_id);\n```\n\n**puzzles (public read):**\n```sql\nALTER TABLE puzzles ENABLE ROW LEVEL SECURITY;\n\n-- Everyone can read puzzles\nCREATE POLICY \"Puzzles are publicly readable\"\n  ON puzzles FOR SELECT\n  TO authenticated, anon\n  USING (true);\n\n-- Only admins can modify puzzles\nCREATE POLICY \"Only admins can modify puzzles\"\n  ON puzzles FOR ALL\n  USING (\n    EXISTS (\n      SELECT 1 FROM user_profiles\n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n```\n\n## Supabase Auth Configuration\n\n1. In Supabase Dashboard  Authentication  Providers:\n   - Enable Email provider\n   - Configure email templates (optional)\n\n2. In Supabase Dashboard  Authentication  URL Configuration:\n   - Set Site URL to your Replit app URL\n   - Add redirect URLs as needed\n\n## Edge Functions\n\n### Deploy global-stats Function\n\n1. Install Supabase CLI:\n```bash\nnpm install -g supabase\n```\n\n2. Login to Supabase:\n```bash\nsupabase login\n```\n\n3. Link your project:\n```bash\nsupabase link --project-ref your-project-ref\n```\n\n4. Deploy the function:\n```bash\nsupabase functions deploy global-stats\n```\n\nThe Edge Function code is in `supabase/functions/global-stats/index.ts`\n\n## Verification\n\n1. Check that all tables exist in Supabase Dashboard  Table Editor\n2. Verify RLS policies are active\n3. Test authentication signup/login\n4. Run a test game to ensure data persists correctly\n","path":null,"size_bytes":4862,"size_tokens":null},"server/supabase.ts":{"content":"import { createClient } from '@supabase/supabase-js';\n\nconst supabaseUrl = process.env.SUPABASE_URL;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  throw new Error('Missing Supabase service role environment variables');\n}\n\n// Server-side client with service role key for admin operations\nexport const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {\n  auth: {\n    autoRefreshToken: false,\n    persistSession: false\n  }\n});\n","path":null,"size_bytes":503,"size_tokens":null},"client/src/lib/SupabaseProvider.tsx":{"content":"import { createContext, useContext, useEffect, useState, ReactNode, useCallback } from 'react';\nimport { SupabaseClient } from '@supabase/supabase-js';\nimport { getSupabaseClient } from './supabaseClient';\nimport { isPwaContext, markPwaInstalled } from './pwaContext';\n\ninterface SupabaseContextValue {\n  client: SupabaseClient;\n  isPasswordRecovery: boolean;\n  clearPasswordRecovery: () => void;\n}\n\nconst SupabaseContext = createContext<SupabaseContextValue | null>(null);\n\nexport function SupabaseProvider({ children }: { children: ReactNode }) {\n  const [supabase, setSupabase] = useState<SupabaseClient | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [isPasswordRecovery, setIsPasswordRecovery] = useState(false);\n  \n  const clearPasswordRecovery = useCallback(() => {\n    setIsPasswordRecovery(false);\n    // Clean up the URL\n    window.history.replaceState(null, '', window.location.pathname);\n  }, []);\n\n  useEffect(() => {\n    // Mark PWA as installed when running in PWA context\n    if (isPwaContext()) {\n      console.log('[SupabaseProvider] Running in PWA context - marking as installed');\n      markPwaInstalled();\n    }\n\n    async function initSupabase() {\n      try {\n        // Use the unified singleton client\n        const client = await getSupabaseClient();\n        setSupabase(client);\n        \n        const hash = window.location.hash;\n        const searchParams = new URLSearchParams(window.location.search);\n        \n        // Check for token_hash in URL query params (PKCE flow)\n        let tokenHash = searchParams.get('token_hash');\n        let type = searchParams.get('type');\n        \n        if (tokenHash && type) {\n          console.log('[SupabaseProvider] Verifying token_hash, type:', type);\n          \n          const { data, error: verifyError } = await client.auth.verifyOtp({\n            token_hash: tokenHash,\n            type: type as 'email' | 'magiclink' | 'signup' | 'recovery' | 'invite' | 'email_change',\n          });\n          \n          if (verifyError) {\n            console.error('[SupabaseProvider] Error verifying token_hash:', verifyError);\n          } else if (data.session) {\n            console.log('[SupabaseProvider] Successfully verified token_hash for user:', data.session.user.email);\n            \n            // Check if this is a password recovery flow\n            if (type === 'recovery') {\n              console.log('[SupabaseProvider] Password recovery flow detected - showing reset screen');\n              setIsPasswordRecovery(true);\n              // Don't clear URL yet - let the password reset screen handle it\n            } else {\n              // Clear the query params from the URL\n              window.history.replaceState(null, '', window.location.pathname);\n            }\n          }\n        }\n        // Check for access_token in hash (implicit flow - for backwards compatibility)\n        else if (hash && hash.includes('access_token')) {\n          console.log('[SupabaseProvider] Detected access_token in URL hash');\n          \n          // Parse tokens from hash\n          const hashParams = new URLSearchParams(hash.substring(1));\n          const accessToken = hashParams.get('access_token');\n          const refreshToken = hashParams.get('refresh_token');\n          \n          // First try getSession - detectSessionInUrl should handle this\n          const { data, error: sessionError } = await client.auth.getSession();\n          \n          if (sessionError) {\n            console.error('[SupabaseProvider] Error getting session:', sessionError);\n          } else if (data.session) {\n            console.log('[SupabaseProvider] Successfully got session for user:', data.session.user.email);\n            window.history.replaceState(null, '', window.location.pathname);\n          } else if (accessToken && refreshToken) {\n            // Fallback: manually set the session\n            console.log('[SupabaseProvider] No session from getSession - trying manual setSession');\n            \n            const { data: sessionData, error: setError } = await client.auth.setSession({\n              access_token: accessToken,\n              refresh_token: refreshToken,\n            });\n            \n            if (setError) {\n              console.error('[SupabaseProvider] Error setting session manually:', setError);\n            } else if (sessionData.session) {\n              console.log('[SupabaseProvider] Successfully set session manually for user:', sessionData.session.user.email);\n              window.history.replaceState(null, '', window.location.pathname);\n            }\n          }\n        }\n        // Also check hash for token_hash (some email templates put it there)\n        else if (hash && hash.includes('token_hash')) {\n          console.log('[SupabaseProvider] Detected token_hash in URL hash');\n          \n          const hashParams = new URLSearchParams(hash.substring(1));\n          const hashTokenHash = hashParams.get('token_hash');\n          const hashType = hashParams.get('type');\n          \n          if (hashTokenHash && hashType) {\n            const { data, error: verifyError } = await client.auth.verifyOtp({\n              token_hash: hashTokenHash,\n              type: hashType as 'email' | 'magiclink' | 'signup' | 'recovery' | 'invite' | 'email_change',\n            });\n            \n            if (verifyError) {\n              console.error('[SupabaseProvider] Error verifying token_hash from hash:', verifyError);\n            } else if (data.session) {\n              console.log('[SupabaseProvider] Successfully verified token_hash from hash for user:', data.session.user.email);\n              \n              // Check if this is a password recovery flow\n              if (hashType === 'recovery') {\n                console.log('[SupabaseProvider] Password recovery flow detected from hash - showing reset screen');\n                setIsPasswordRecovery(true);\n              } else {\n                window.history.replaceState(null, '', window.location.pathname);\n              }\n            }\n          }\n        }\n        \n        // Note: Auth state change listener is handled in useAuth hook\n        // Google OAuth signup_method updates are handled server-side during profile creation\n        // to avoid redundant database calls on every SIGNED_IN event (which fires on token refresh, etc.)\n        \n        setLoading(false);\n      } catch (err) {\n        console.error('Supabase initialization error:', err);\n        setError(err instanceof Error ? err.message : 'Unknown error');\n        setLoading(false);\n      }\n    }\n\n    initSupabase();\n    \n    return () => {\n      // No auth subscription cleanup needed - useAuth hook manages auth state\n    };\n  }, []);\n\n  if (loading) {\n    return (\n      <div \n        className=\"fixed inset-0\"\n        style={{ backgroundColor: '#7DAAE8' }} \n      />\n    );\n  }\n\n  if (error || !supabase) {\n    return <div>Error initializing app: {error || 'Supabase client not available'}</div>;\n  }\n\n  const contextValue: SupabaseContextValue = {\n    client: supabase,\n    isPasswordRecovery,\n    clearPasswordRecovery,\n  };\n\n  return (\n    <SupabaseContext.Provider value={contextValue}>\n      {children}\n    </SupabaseContext.Provider>\n  );\n}\n\nexport function useSupabase() {\n  const context = useContext(SupabaseContext);\n  if (!context) {\n    throw new Error('useSupabase must be used within SupabaseProvider');\n  }\n  return context.client;\n}\n\nexport function usePasswordRecovery() {\n  const context = useContext(SupabaseContext);\n  if (!context) {\n    throw new Error('usePasswordRecovery must be used within SupabaseProvider');\n  }\n  return {\n    isPasswordRecovery: context.isPasswordRecovery,\n    clearPasswordRecovery: context.clearPasswordRecovery,\n  };\n}\n","path":null,"size_bytes":7797,"size_tokens":null},"server/supabaseAuth.ts":{"content":"import type { Request, Response, NextFunction } from 'express';\nimport { supabaseAdmin } from './supabase';\n\n// Middleware to verify Supabase JWT token\nexport async function verifySupabaseAuth(req: Request, res: Response, next: NextFunction) {\n  const authHeader = req.headers.authorization;\n  \n  if (!authHeader || !authHeader.startsWith('Bearer ')) {\n    return res.status(401).json({ error: 'Unauthorized' });\n  }\n\n  const token = authHeader.substring(7); // Remove 'Bearer ' prefix\n\n  try {\n    const { data: { user }, error } = await supabaseAdmin.auth.getUser(token);\n    \n    if (error || !user) {\n      return res.status(401).json({ error: 'Invalid token' });\n    }\n\n    // Attach user to request object\n    (req as any).user = user;\n    next();\n  } catch (error) {\n    console.error('Auth verification error:', error);\n    return res.status(401).json({ error: 'Authentication failed' });\n  }\n}\n\n// Middleware to check if user is admin\nexport async function requireAdmin(req: Request, res: Response, next: NextFunction) {\n  const user = (req as any).user;\n  \n  if (!user) {\n    return res.status(401).json({ error: 'Unauthorized' });\n  }\n\n  try {\n    const { data: profile, error } = await supabaseAdmin\n      .from('user_profiles')\n      .select('is_admin')\n      .eq('id', user.id)\n      .single();\n\n    if (error || !profile || !profile.is_admin) {\n      return res.status(403).json({ error: 'Forbidden: Admin access required' });\n    }\n\n    next();\n  } catch (error) {\n    console.error('Admin check error:', error);\n    return res.status(500).json({ error: 'Server error' });\n  }\n}\n","path":null,"size_bytes":1595,"size_tokens":null},"client/src/components/AuthPage.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { PasswordInput } from \"@/components/ui/password-input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { InlineHelp } from \"@/components/ui/inline-help\";\nimport { PostcodeAutocomplete } from \"@/components/PostcodeAutocomplete\";\nimport { ChevronLeft } from \"lucide-react\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useGameMode } from \"@/contexts/GameModeContext\";\nimport { validatePassword, getPasswordRequirementsText } from \"@/lib/passwordValidation\";\nimport { useSupabase } from \"@/lib/SupabaseProvider\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { Region } from \"@shared/schema\";\nimport { useAdBannerActive } from \"@/components/AdBanner\";\n\ninterface AuthPageProps {\n  mode: \"login\" | \"signup\" | \"forgot-password\" | \"personalise\";\n  onSuccess: (data?: { postcode?: string; region?: string }) => void;\n  onSwitchMode: () => void;\n  onBack: () => void;\n  onForgotPassword?: () => void;\n  onContinueAsGuest?: () => void;\n  prefilledEmail?: string;\n  onReturnToLogin?: () => void;\n}\n\nexport default function AuthPage({ mode, onSuccess, onSwitchMode, onBack, onForgotPassword, onContinueAsGuest, prefilledEmail, onReturnToLogin }: AuthPageProps) {\n  const { signIn } = useAuth();\n  const supabase = useSupabase();\n  const { toast } = useToast();\n  const { setGameMode } = useGameMode();\n  const [loading, setLoading] = useState(false);\n  const adBannerActive = useAdBannerActive();\n  const [showPostcodeWarning, setShowPostcodeWarning] = useState(false);\n  const [showPostcodeInvalidDialog, setShowPostcodeInvalidDialog] = useState(false);\n  const [fadeIn, setFadeIn] = useState(false);\n\n  // Fetch available regions\n  const { data: regions, isLoading: regionsLoading } = useQuery<Region[]>({\n    queryKey: ['/api/regions'],\n    enabled: mode === 'signup' || mode === 'personalise',\n  });\n\n  const [formData, setFormData] = useState({\n    email: \"\",\n    password: \"\",\n    confirmPassword: \"\",\n    firstName: \"\",\n    lastName: \"\",\n    region: \"\", // Will be set from fetched regions\n    postcode: \"\",\n    acceptedTerms: false,\n    adsConsent: false,\n  });\n\n  // Refs for automatic field progression\n  const firstNameRef = useRef<HTMLInputElement>(null);\n  const lastNameRef = useRef<HTMLInputElement>(null);\n  const postcodeRef = useRef<HTMLInputElement>(null);\n  const emailRef = useRef<HTMLInputElement>(null);\n  const passwordRef = useRef<HTMLInputElement>(null);\n  const confirmPasswordRef = useRef<HTMLInputElement>(null);\n\n  // Set default region from fetched regions\n  useEffect(() => {\n    if (regions && regions.length > 0 && !formData.region) {\n      setFormData(prev => ({ ...prev, region: regions[0].code }));\n    }\n  }, [regions]);\n\n  // Load saved adsConsent from localStorage on mount\n  useEffect(() => {\n    const savedAdsConsent = localStorage.getItem(\"adsConsent\");\n    if (savedAdsConsent !== null) {\n      setFormData((prev) => ({\n        ...prev,\n        adsConsent: savedAdsConsent === \"true\",\n      }));\n    }\n  }, []);\n\n  // Trigger fade-in animation\n  useEffect(() => {\n    requestAnimationFrame(() => {\n      setFadeIn(true);\n    });\n  }, []);\n\n  // Persist adsConsent to localStorage whenever it changes\n  useEffect(() => {\n    localStorage.setItem(\"adsConsent\", String(formData.adsConsent));\n  }, [formData.adsConsent]);\n\n  // Reset form when mode changes to prevent stale data\n  useEffect(() => {\n    setFormData((prev) => ({\n      email: \"\",\n      password: \"\",\n      confirmPassword: \"\",\n      firstName: \"\",\n      lastName: \"\",\n      region: regions && regions.length > 0 ? regions[0].code : \"\", // Use first region from database\n      postcode: \"\",\n      acceptedTerms: false,   // always reset\n      adsConsent: prev.adsConsent, // preserve previous choice\n    }));\n  }, [mode, regions]);\n\nconst handleSubmit = async (e: React.FormEvent) => {\n  e.preventDefault();\n\n  // Handle personalise mode - user is already authenticated, just need to save profile\n  if (mode === \"personalise\") {\n    // Check if postcode is blank and show warning\n    if (!formData.postcode.trim()) {\n      setShowPostcodeWarning(true);\n      return;\n    }\n\n    setLoading(true);\n\n    // Validate postcode exists in the location-based postcode database\n    try {\n      const validateResponse = await fetch(`/api/postcodes/validate?postcode=${encodeURIComponent(formData.postcode.trim())}`);\n      const validateResult = await validateResponse.json();\n      \n      if (!validateResult.valid) {\n        setLoading(false);\n        setShowPostcodeInvalidDialog(true);\n        return;\n      }\n\n      // Get current session\n      const { data: { session } } = await supabase.auth.getSession();\n      if (!session) {\n        toast({\n          title: \"Session expired\",\n          description: \"Please log in again.\",\n          variant: \"destructive\",\n        });\n        setLoading(false);\n        return;\n      }\n\n      // Create user profile - acceptedTerms is true since they agreed when creating account in LoginPage\n      const profileResponse = await fetch(\"/api/auth/profile\", {\n        method: \"PATCH\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Authorization\": `Bearer ${session.access_token}`,\n        },\n        body: JSON.stringify({\n          firstName: formData.firstName,\n          lastName: formData.lastName,\n          email: prefilledEmail || session.user.email,\n          region: formData.region,\n          postcode: formData.postcode || null,\n          acceptedTerms: true, // Already accepted when creating account\n          adsConsent: formData.adsConsent,\n          tier: \"standard\",\n        }),\n      });\n\n      if (!profileResponse.ok) {\n        throw new Error(\"Failed to create profile\");\n      }\n\n      // Create initial user settings\n      const settingsResponse = await fetch(\"/api/settings\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Authorization\": `Bearer ${session.access_token}`,\n        },\n        body: JSON.stringify({\n          useRegionDefault: true,\n          digitPreference: \"8\",\n        }),\n      });\n\n      setGameMode('global');\n      onSuccess({ postcode: formData.postcode, region: formData.region });\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save profile\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoading(false);\n    }\n    return;\n  }\n\n  // Validate password for signup\n  if (mode === \"signup\") {\n    // Check if passwords match first for clearer feedback\n    if (formData.password !== formData.confirmPassword) {\n      toast({\n        title: \"Passwords don't match\",\n        description: \"Please make sure both passwords are the same.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Then check password strength\n    const validation = validatePassword(formData.password);\n    if (!validation.valid) {\n      toast({\n        title: \"Invalid Password\",\n        description: validation.errors.join(\", \"),\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Check if postcode is blank and show warning\n    if (!formData.postcode.trim()) {\n      setShowPostcodeWarning(true);\n      return;\n    }\n\n    // Show loading state immediately before async postcode validation\n    setLoading(true);\n\n    // Validate postcode exists in the location-based postcode database\n    try {\n      const validateResponse = await fetch(`/api/postcodes/validate?postcode=${encodeURIComponent(formData.postcode.trim())}`);\n      const validateResult = await validateResponse.json();\n      \n      if (!validateResult.valid) {\n        setLoading(false);\n        setShowPostcodeInvalidDialog(true);\n        return;\n      }\n    } catch (error) {\n      console.error(\"[AUTH] Postcode validation error:\", error);\n      // On validation error, still show the dialog to be safe\n      setLoading(false);\n      setShowPostcodeInvalidDialog(true);\n      return;\n    }\n  } else {\n    // For login/forgot-password, set loading here\n    setLoading(true);\n  }\n\n  try {\n    if (mode === \"signup\") {\n      // Direct email/password signup (no OTP verification)\n      console.log(\"[AUTH] Calling signUp for direct email/password signup\");\n      \n      const { data, error } = await supabase.auth.signUp({\n        email: formData.email,\n        password: formData.password,\n        options: {\n          data: {\n            first_name: formData.firstName,\n            last_name: formData.lastName,\n            acceptedTerms: formData.acceptedTerms,\n            adsConsent: formData.adsConsent,\n            first_login_completed: false, // Ensure onboarding screen runs for new users\n          },\n        },\n      });\n\n      console.log(\"[AUTH] signUp result:\", error ? `Error: ${error.message}` : \"Success\");\n      if (error) throw error;\n\n      if (data.user) {\n        // Try to get session - if email confirmation is disabled, we get a session immediately\n        // If email confirmation is enabled, session will be null and user needs to confirm email first\n        let session = data.session;\n        \n        if (!session) {\n          // Session not immediately available - try signing in with the credentials\n          console.log(\"[AUTH] No immediate session, attempting sign in...\");\n          const signInResult = await supabase.auth.signInWithPassword({\n            email: formData.email,\n            password: formData.password,\n          });\n          \n          if (signInResult.error) {\n            // If sign-in fails, it might mean email confirmation is required\n            console.log(\"[AUTH] Sign in after signup failed:\", signInResult.error.message);\n            toast({\n              title: \"Account created!\",\n              description: \"Please check your email to confirm your account, then log in.\",\n            });\n            onSwitchMode(); // Switch to login mode\n            setLoading(false);\n            return;\n          }\n          \n          session = signInResult.data.session;\n        }\n\n        if (!session) {\n          toast({\n            title: \"Account created!\",\n            description: \"Please log in with your new credentials.\",\n          });\n          onSwitchMode(); // Switch to login mode\n          return;\n        }\n\n        // Create user profile in database\n        console.log(\"[Auth] Sending PATCH /api/auth/profile...\");\n        const profileResponse = await fetch(\"/api/auth/profile\", {\n          method: \"PATCH\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n            \"Authorization\": `Bearer ${session.access_token}`,\n          },\n          body: JSON.stringify({\n            firstName: formData.firstName,\n            lastName: formData.lastName,\n            email: formData.email,\n            region: formData.region,\n            postcode: formData.postcode || null,\n            acceptedTerms: formData.acceptedTerms,\n            adsConsent: formData.adsConsent,\n            tier: \"standard\",\n          }),\n        });\n        console.log(\"[Auth] Profile response status:\", profileResponse.status);\n        if (!profileResponse.ok) {\n          throw new Error(\"Failed to create profile\");\n        }\n\n        // Create initial user settings\n        console.log(\"[Auth] Sending POST /api/settings...\");\n        const settingsResponse = await fetch(\"/api/settings\", {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n            \"Authorization\": `Bearer ${session.access_token}`,\n          },\n          body: JSON.stringify({\n            useRegionDefault: true,\n            digitPreference: \"8\",\n          }),\n        });\n        console.log(\"[Auth] Settings response status:\", settingsResponse.status);\n\n        // Navigate to Home.tsx which will handle the GeneratingQuestionsScreen for first login\n        setGameMode('global');\n        onSuccess();\n      }\n    } else {\n      await signIn(formData.email, formData.password);\n      onSuccess();\n    }\n  } catch (error: any) {\n    toast({\n      title: \"Error\",\n      description: error.message || \"Authentication failed\",\n      variant: \"destructive\",\n    });\n  } finally {\n    setLoading(false);\n  }\n};\n\n  const getHeaderTitle = () => {\n    switch (mode) {\n      case \"personalise\": return \"Personalise your game\";\n      case \"signup\": return \"Create an account\";\n      case \"forgot-password\": return \"Reset password\";\n      default: return \"Welcome back\";\n    }\n  };\n\n  return (\n    <div className={`fixed inset-0 flex flex-col ${adBannerActive ? 'pb-[50px]' : ''} bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800`}>\n      {/* Header - matching AccountInfoPage style */}\n      <div className=\"flex items-center justify-between p-4 mb-2\">\n        <button\n          onClick={onBack}\n          data-testid=\"button-back\"\n          className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100/50 dark:hover:bg-gray-700/50 transition-colors\"\n        >\n          <ChevronLeft className=\"h-9 w-9 text-gray-700 dark:text-gray-300\" />\n        </button>\n\n        <div className=\"flex flex-col items-center\">\n          <h1 \n            className=\"text-4xl font-bold text-gray-900 dark:text-white\"\n            data-testid=\"text-title\"\n          >\n            {getHeaderTitle()}\n          </h1>\n        </div>\n\n        {/* Spacer to balance layout */}\n        <div className=\"w-14\" />\n      </div>\n\n      <div className=\"flex-1 overflow-y-auto flex items-start justify-center px-4 pb-8\">\n        <Card className=\"w-full max-w-md\">\n          <CardHeader className=\"space-y-1\">\n            <CardDescription className=\"text-center\">\n              {mode === \"personalise\"\n                ? \"Set up your profile to get personalised puzzles\"\n                : mode === \"signup\" \n                  ? \"Enter your details to create your account\" \n                  : \"Enter your email and password to sign in\"}\n            </CardDescription>\n          </CardHeader>\n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            {mode === \"personalise\" && prefilledEmail && (\n              <div className=\"mb-4\">\n                <p className=\"text-sm text-muted-foreground\" data-testid=\"text-personalise-email\">\n                  {prefilledEmail}\n                </p>\n              </div>\n            )}\n            \n            {(mode === \"signup\" || mode === \"personalise\") && (\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"firstName\" data-testid=\"label-firstname\">First Name</Label>\n                  <Input\n                    ref={firstNameRef}\n                    id=\"firstName\"\n                    data-testid=\"input-firstname\"\n                    value={formData.firstName}\n                    onChange={(e) => setFormData({ ...formData, firstName: e.target.value })}\n                    onKeyDown={(e) => {\n                      if (e.key === 'Enter' && formData.firstName) {\n                        e.preventDefault();\n                        lastNameRef.current?.focus();\n                      }\n                    }}\n                    required\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"lastName\" data-testid=\"label-lastname\">Last Name</Label>\n                  <Input\n                    ref={lastNameRef}\n                    id=\"lastName\"\n                    data-testid=\"input-lastname\"\n                    value={formData.lastName}\n                    onChange={(e) => setFormData({ ...formData, lastName: e.target.value })}\n                    onKeyDown={(e) => {\n                      if (e.key === 'Enter') {\n                        e.preventDefault();\n                        if (mode === \"personalise\") {\n                          postcodeRef.current?.focus();\n                        } else {\n                          emailRef.current?.focus();\n                        }\n                      }\n                    }}\n                    required={mode !== \"personalise\"}\n                  />\n                </div>\n              </div>\n            )}\n            \n            {(mode === \"signup\" || mode === \"personalise\") && (\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center gap-1.5\">\n                  <Label htmlFor=\"region\" data-testid=\"label-region\">Region</Label>\n                  <InlineHelp data-testid=\"button-region-info\">\n                    <p>Puzzle questions are based on your geographical region</p>\n                  </InlineHelp>\n                </div>\n                <Select\n                  value={formData.region}\n                  onValueChange={(value) => setFormData({ ...formData, region: value })}\n                  disabled={regionsLoading}\n                >\n                  <SelectTrigger id=\"region\" data-testid=\"select-region\">\n                    <SelectValue placeholder={regionsLoading ? \"Loading regions...\" : \"Select your region\"} />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {regions?.map((region) => (\n                        <SelectItem \n                          key={region.code} \n                          value={region.code} \n                          data-testid={`option-region-${region.code.toLowerCase()}`}\n                        >\n                          {region.name}\n                        </SelectItem>\n                      )\n                    )}\n                  </SelectContent>\n                </Select>\n                <p className=\"text-xs text-muted-foreground\" data-testid=\"text-region-help\">\n                  This determines which region version of the the game you play\n                </p>\n              </div>\n            )}\n\n            {(mode === \"signup\" || mode === \"personalise\") && (\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center gap-1.5\">\n                  <Label htmlFor=\"postcode\" data-testid=\"label-postcode\">Postcode</Label>\n                  <InlineHelp data-testid=\"button-postcode-info\">\n                    <p>Your postcode helps us provide local puzzles tailored to your area</p>\n                  </InlineHelp>\n                </div>\n                <PostcodeAutocomplete\n                  value={formData.postcode}\n                  onChange={(value) => setFormData({ ...formData, postcode: value })}\n                  placeholder=\"Enter your postcode\"\n                  className=\"w-full\"\n                  required={false}   // we handle the blank postcode case with the warning dialog\n                  data-testid=\"input-postcode\"\n                />\n              </div>\n            )}\n            \n            {mode !== \"personalise\" && (\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\" data-testid=\"label-email\">Email</Label>\n              <Input\n                ref={emailRef}\n                id=\"email\"\n                type=\"email\"\n                data-testid=\"input-email\"\n                value={formData.email}\n                onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                onKeyDown={(e) => {\n                  if (e.key === 'Enter' && formData.email) {\n                    e.preventDefault();\n                    passwordRef.current?.focus();\n                  }\n                }}\n                required\n              />\n            </div>\n            )}\n            \n            {mode !== \"personalise\" && (\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"password\" data-testid=\"label-password\">Password</Label>\n              <PasswordInput\n                ref={passwordRef}\n                id=\"password\"\n                data-testid=\"input-password\"\n                value={formData.password}\n                onChange={(e) => setFormData({ ...formData, password: e.target.value })}\n                onKeyDown={(e) => {\n                  if (e.key === 'Enter' && formData.password && mode === 'signup') {\n                    e.preventDefault();\n                    confirmPasswordRef.current?.focus();\n                  }\n                }}\n                autoComplete=\"new-password\"\n                required\n              />\n              {mode === \"signup\" && (\n                <p className=\"text-xs text-muted-foreground\" data-testid=\"text-password-requirements\">\n                  {getPasswordRequirementsText()}\n                </p>\n              )}\n              {mode === \"login\" && onForgotPassword && (\n                <button\n                  type=\"button\"\n                  onClick={onForgotPassword}\n                  className=\"text-xs text-primary hover:underline\"\n                  data-testid=\"button-forgot-password\"\n                >\n                  Forgot password?\n                </button>\n              )}\n            </div>\n            )}\n\n            {mode === \"signup\" && (\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"confirmPassword\" data-testid=\"label-confirm-password\">Confirm Password</Label>\n                <PasswordInput\n                  ref={confirmPasswordRef}\n                  id=\"confirmPassword\"\n                  data-testid=\"input-confirm-password\"\n                  value={formData.confirmPassword}\n                  onChange={(e) => setFormData({ ...formData, confirmPassword: e.target.value })}\n                  autoComplete=\"new-password\"\n                  required\n                />\n              </div>\n            )}\n\n            {mode === \"signup\" && (\n              <div className=\"space-y-4\">\n                <div className=\"flex items-start space-x-2\">\n                  <input\n                    id=\"acceptedTerms\"\n                    type=\"checkbox\"\n                    checked={formData.acceptedTerms}\n                    onChange={(e) =>\n                      setFormData({ ...formData, acceptedTerms: e.target.checked })\n                    }\n                    required\n                    className=\"mt-1\"\n                  />\n                  <label htmlFor=\"acceptedTerms\" className=\"text-sm\">\n                    I accept the{\" \"}\n                    <a href=\"/terms\" className=\"text-primary underline\">Terms of Service</a> and{\" \"}\n                    <a href=\"/privacy\" className=\"text-primary underline\">Privacy Policy</a>.\n                  </label>\n                </div>\n\n                <div className=\"flex items-start space-x-2\">\n                  <input\n                    id=\"adsConsent\"\n                    type=\"checkbox\"\n                    checked={formData.adsConsent}\n                    onChange={(e) =>\n                      setFormData({ ...formData, adsConsent: e.target.checked })\n                    }\n                    className=\"mt-1\"\n                  />\n                  <label htmlFor=\"adsConsent\" className=\"text-sm\">\n                    I agree to receive tailored ads and promotional content (optional).\n                  </label>\n                </div>\n              </div>\n            )}\n            \n            {mode === \"personalise\" && (\n              <div className=\"flex items-start space-x-2\">\n                <input\n                  id=\"adsConsent\"\n                  type=\"checkbox\"\n                  checked={formData.adsConsent}\n                  onChange={(e) =>\n                    setFormData({ ...formData, adsConsent: e.target.checked })\n                  }\n                  className=\"mt-1\"\n                />\n                <label htmlFor=\"adsConsent\" className=\"text-sm\">\n                  I agree to receive tailored ads and promotional content (optional).\n                </label>\n              </div>\n            )}\n            \n            <Button \n              type=\"submit\" \n              className={`w-full ${\n                (mode === \"signup\" || mode === \"personalise\") && \n                !loading && \n                formData.firstName.trim() && \n                (mode === \"personalise\" || formData.email.trim()) && \n                (mode === \"personalise\" || formData.password) && \n                (mode === \"personalise\" || formData.acceptedTerms)\n                  ? \"bg-blue-700 hover:bg-blue-800\"\n                  : \"\"\n              }`}\n              disabled={\n                loading || (\n                  (mode === \"signup\" || mode === \"personalise\") && (\n                    !formData.firstName.trim() ||\n                    (mode !== \"personalise\" && !formData.email.trim()) ||\n                    (mode !== \"personalise\" && !formData.password) ||\n                    (mode !== \"personalise\" && !formData.acceptedTerms)\n                  )\n                )\n              }\n              data-testid=\"button-submit\"\n            >\n              {loading ? \"Please wait...\" : mode === \"personalise\" ? \"Generate Questions\" : mode === \"signup\" ? \"Sign Up\" : \"Sign In\"}\n            </Button>\n          </form>\n\n          {mode !== \"personalise\" && (\n          <div className=\"mt-4 text-center text-sm\">\n            <button\n              type=\"button\"\n              onClick={onSwitchMode}\n              className=\"text-primary hover:underline\"\n              data-testid=\"button-switch-mode\"\n            >\n              {mode === \"signup\" \n                ? \"Already have an account? Sign in\" \n                : \"Don't have an account? Sign up\"}\n            </button>\n          </div>\n          )}\n\n          {onContinueAsGuest && mode !== \"personalise\" && (\n            <div className=\"mt-4 text-center\">\n              <button\n                type=\"button\"\n                onClick={onContinueAsGuest}\n                className=\"text-sm text-[#7DAAE8] hover:underline\"\n                data-testid=\"button-continue-guest\"\n              >\n                Continue without logging in\n              </button>\n            </div>\n          )}\n          \n          {mode === \"personalise\" && onReturnToLogin && (\n            <div className=\"mt-4 text-center\">\n              <button\n                type=\"button\"\n                onClick={onReturnToLogin}\n                className=\"text-sm text-primary hover:underline\"\n                data-testid=\"button-return-to-login\"\n              >\n                Return to log in\n              </button>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n      </div>\n\n      {/* Postcode Warning Dialog */}\n      <AlertDialog open={showPostcodeWarning} onOpenChange={setShowPostcodeWarning}>\n        <AlertDialogContent data-testid=\"alert-postcode-warning\">\n          <AlertDialogHeader>\n            <AlertDialogTitle>No postcode provided</AlertDialogTitle>\n            <AlertDialogDescription>\n              Without a postcode, we can't provide local puzzles. You'll only have access to general region-based puzzles. Are you sure you want to continue without entering a postcode?\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel \n              onClick={() => {\n                setShowPostcodeWarning(false);\n                postcodeRef.current?.focus();\n              }}\n              data-testid=\"button-cancel-postcode-warning\"\n            >\n              Go Back\n            </AlertDialogCancel>\n            <AlertDialogAction \n              onClick={async () => {\n                setShowPostcodeWarning(false);\n                setLoading(true);\n                try {\n                  // Handle personalise mode - user already authenticated\n                  if (mode === \"personalise\") {\n                    const { data: { session } } = await supabase.auth.getSession();\n                    if (!session) {\n                      toast({\n                        title: \"Session expired\",\n                        description: \"Please log in again.\",\n                        variant: \"destructive\",\n                      });\n                      setLoading(false);\n                      return;\n                    }\n\n                    // Save profile without postcode\n                    const profileResponse = await fetch(\"/api/auth/profile\", {\n                      method: \"PATCH\",\n                      headers: {\n                        \"Content-Type\": \"application/json\",\n                        \"Authorization\": `Bearer ${session.access_token}`,\n                      },\n                      body: JSON.stringify({\n                        firstName: formData.firstName,\n                        lastName: formData.lastName,\n                        email: prefilledEmail || session.user.email,\n                        region: formData.region,\n                        postcode: null,\n                        acceptedTerms: true,\n                        adsConsent: formData.adsConsent,\n                        tier: \"standard\",\n                      }),\n                    });\n                    if (!profileResponse.ok) throw new Error(\"Failed to create profile\");\n\n                    // Create initial settings\n                    await fetch(\"/api/settings\", {\n                      method: \"POST\",\n                      headers: {\n                        \"Content-Type\": \"application/json\",\n                        \"Authorization\": `Bearer ${session.access_token}`,\n                      },\n                      body: JSON.stringify({ useRegionDefault: true, digitPreference: \"8\" }),\n                    });\n\n                    setGameMode('global');\n                    onSuccess({ postcode: \"\", region: formData.region });\n                    return;\n                  }\n\n                  // Handle signup mode - create new account without postcode\n                  const { data, error } = await supabase.auth.signUp({\n                    email: formData.email,\n                    password: formData.password,\n                    options: {\n                      data: {\n                        first_name: formData.firstName,\n                        last_name: formData.lastName,\n                        acceptedTerms: formData.acceptedTerms,\n                        adsConsent: formData.adsConsent,\n                      },\n                    },\n                  });\n\n                  if (error) throw error;\n\n                  if (data.user) {\n                    let session = data.session;\n                    \n                    if (!session) {\n                      // Try signing in with the credentials\n                      const signInResult = await supabase.auth.signInWithPassword({\n                        email: formData.email,\n                        password: formData.password,\n                      });\n                      \n                      if (signInResult.error) {\n                        toast({\n                          title: \"Account created!\",\n                          description: \"Please check your email to confirm your account, then log in.\",\n                        });\n                        onSwitchMode();\n                        setLoading(false);\n                        return;\n                      }\n                      session = signInResult.data.session;\n                    }\n\n                    if (!session) {\n                      toast({\n                        title: \"Account created!\",\n                        description: \"Please log in with your new credentials.\",\n                      });\n                      onSwitchMode();\n                      return;\n                    }\n\n                    // Create user profile\n                    const profileResponse = await fetch(\"/api/auth/profile\", {\n                      method: \"PATCH\",\n                      headers: {\n                        \"Content-Type\": \"application/json\",\n                        \"Authorization\": `Bearer ${session.access_token}`,\n                      },\n                      body: JSON.stringify({\n                        firstName: formData.firstName,\n                        lastName: formData.lastName,\n                        email: formData.email,\n                        region: formData.region,\n                        postcode: null, // No postcode\n                        acceptedTerms: formData.acceptedTerms,\n                        adsConsent: formData.adsConsent,\n                        tier: \"standard\",\n                      }),\n                    });\n                    if (!profileResponse.ok) throw new Error(\"Failed to create profile\");\n\n                    // Create initial settings\n                    await fetch(\"/api/settings\", {\n                      method: \"POST\",\n                      headers: {\n                        \"Content-Type\": \"application/json\",\n                        \"Authorization\": `Bearer ${session.access_token}`,\n                      },\n                      body: JSON.stringify({ useRegionDefault: true, digitPreference: \"8\" }),\n                    });\n\n                    // Navigate to Home.tsx which will handle the GeneratingQuestionsScreen for first login\n                    setGameMode('global');\n                    onSuccess();\n                  }\n                } catch (error: any) {\n                  toast({\n                    title: \"Error\",\n                    description: error.message || \"Authentication failed\",\n                    variant: \"destructive\",\n                  });\n                } finally {\n                  setLoading(false);\n                }\n              }}\n              data-testid=\"button-confirm-postcode-warning\"\n            >\n              Continue Without Postcode\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Postcode not supported dialog */}\n      <AlertDialog open={showPostcodeInvalidDialog} onOpenChange={setShowPostcodeInvalidDialog}>\n        <AlertDialogContent data-testid=\"alert-postcode-invalid\">\n          <AlertDialogHeader>\n            <AlertDialogTitle>Postcode Not Supported</AlertDialogTitle>\n            <AlertDialogDescription>\n              Unfortunately this postcode is not currently supported for location based questions. Please try another postcode or leave the postcode blank to have Hammie generate your personalised questions for you.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogAction \n              onClick={() => {\n                setShowPostcodeInvalidDialog(false);\n                setFormData(prev => ({ ...prev, postcode: \"\" }));\n                // Focus the postcode field after a short delay\n                setTimeout(() => {\n                  postcodeRef.current?.focus();\n                }, 100);\n              }}\n              data-testid=\"button-ok-postcode-invalid\"\n            >\n              OK\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":35495,"size_tokens":null},"client/src/components/ForgotPasswordPage.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { useSupabase } from \"@/lib/SupabaseProvider\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ArrowLeft } from \"lucide-react\";\n\ninterface ForgotPasswordPageProps {\n  onBack: () => void;\n}\n\nexport default function ForgotPasswordPage({ onBack }: ForgotPasswordPageProps) {\n  const supabase = useSupabase();\n  const { toast } = useToast();\n  const [loading, setLoading] = useState(false);\n  const [email, setEmail] = useState(\"\");\n  const [sent, setSent] = useState(false);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setLoading(true);\n\n    try {\n      const { error } = await supabase.auth.resetPasswordForEmail(email, {\n        redirectTo: `${window.location.origin}/reset-password`,\n      });\n\n      if (error) throw error;\n\n      setSent(true);\n      toast({\n        title: \"Email sent!\",\n        description: \"Check your inbox for a password reset link.\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to send reset email\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"space-y-1\">\n          <div className=\"flex items-center gap-2\">\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={onBack}\n              data-testid=\"button-back\"\n            >\n              <ArrowLeft className=\"h-5 w-5\" />\n            </Button>\n            <CardTitle className=\"text-2xl\">Reset Password</CardTitle>\n          </div>\n          <CardDescription>\n            {sent\n              ? \"We've sent you a password reset link\"\n              : \"Enter your email to receive a password reset link\"}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {!sent ? (\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"email\" data-testid=\"label-email\">\n                  Email\n                </Label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  data-testid=\"input-email\"\n                  value={email}\n                  onChange={(e) => setEmail(e.target.value)}\n                  required\n                />\n              </div>\n\n              <Button\n                type=\"submit\"\n                className=\"w-full\"\n                disabled={loading}\n                data-testid=\"button-submit\"\n              >\n                {loading ? \"Sending...\" : \"Send Reset Link\"}\n              </Button>\n            </form>\n          ) : (\n            <div className=\"space-y-4\">\n              <p className=\"text-sm text-muted-foreground\">\n                Check your email for a password reset link. If you don't see it,\n                check your spam folder.\n              </p>\n              <Button onClick={onBack} className=\"w-full\" data-testid=\"button-back-to-login\">\n                Back to Sign In\n              </Button>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":3599,"size_tokens":null},"client/src/components/TermsPage.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { ArrowLeft, ChevronLeft } from \"lucide-react\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { useAdBannerActive } from \"@/components/AdBanner\";\n\ninterface TermsPageProps {\n  onBack: () => void;\n}\n\nexport function TermsPage({ onBack }: TermsPageProps) {\n  const adBannerActive = useAdBannerActive();\n  \n  return (\n    <div className={`min-h-screen flex flex-col p-4 bg-background ${adBannerActive ? 'pb-[50px]' : ''}`}>\n      <div className=\"flex items-center justify-between mb-6\">\n        <button\n          onClick={onBack}\n          data-testid=\"button-back-from-terms\"\n          className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n        >\n          <ChevronLeft className=\"h-9 w-9 text-gray-700\" />\n        </button>\n\n        <div className=\"flex flex-col items-center\">\n          <h1 className=\"text-4xl font-bold\">Terms of Use</h1>\n        </div>\n\n        {/* Spacer to balance layout */}\n        <div className=\"w-14\" />\n      </div>\n\n\n      <ScrollArea className=\"flex-1\">\n        <Card className=\"max-w-4xl mx-auto\">\n          <CardHeader>\n            <CardTitle>Terms of Use for Elementle</CardTitle>\n            <p className=\"text-sm text-muted-foreground\">Last updated: October 2025</p>\n          </CardHeader>\n          <CardContent className=\"space-y-6 prose dark:prose-invert max-w-none\">\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">1. Acceptance of Terms</h2>\n              <p>\n                By accessing and using Elementle, you accept and agree to be bound by these Terms of Use. \n                If you do not agree to these terms, please do not use the service.\n              </p>\n            </section>\n\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">2. Use of Service</h2>\n              <p>Elementle is a daily historical date-guessing puzzle game. You may:</p>\n              <ul className=\"list-disc pl-6 space-y-1\">\n                <li>Play as a guest with local storage only</li>\n                <li>Create an account to save progress permanently</li>\n                <li>Access daily puzzles and archived puzzles</li>\n              </ul>\n            </section>\n\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">3. User Accounts</h2>\n              <p>\n                When creating an account, you agree to provide accurate information and maintain the \n                security of your password. You are responsible for all activities under your account.\n              </p>\n            </section>\n\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">4. Intellectual Property</h2>\n              <p>\n                All content, including puzzles, design, and code, is owned by the service provider. \n                You may not reproduce, distribute, or create derivative works without permission.\n              </p>\n            </section>\n\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">5. User Conduct</h2>\n              <p>You agree not to:</p>\n              <ul className=\"list-disc pl-6 space-y-1\">\n                <li>Use automated tools or bots to play the game</li>\n                <li>Attempt to hack or disrupt the service</li>\n                <li>Share solutions publicly before the daily puzzle expires</li>\n              </ul>\n            </section>\n\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">6. Limitation of Liability</h2>\n              <p>\n                The service is provided \"as is\" without warranties of any kind. We are not liable for \n                any damages arising from your use of the service.\n              </p>\n            </section>\n\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">7. Changes to Terms</h2>\n              <p>\n                We reserve the right to modify these terms at any time. Continued use of the service \n                constitutes acceptance of any changes.\n              </p>\n            </section>\n\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">8. Contact</h2>\n              <p>\n                For questions about these Terms of Use, please contact us through the Support section in Settings.\n              </p>\n            </section>\n          </CardContent>\n        </Card>\n      </ScrollArea>\n    </div>\n  );\n}\n","path":null,"size_bytes":4593,"size_tokens":null},"client/src/lib/dateFormat.ts":{"content":"/**\n * Centralized date formatting utilities for Elementle\n * Handles region-based formatting with 6-digit and 8-digit date support\n */\n\nexport type DateFormatPreference = 'ddmmyy' | 'mmddyy' | 'ddmmyyyy' | 'mmddyyyy';\nexport type RegionCode = 'GB' | 'US' | string;\n\n/**\n * Get the default date format for a given region\n */\nexport function getRegionDefaultFormat(region: RegionCode | null | undefined): DateFormatPreference {\n  if (region === 'US') {\n    return 'mmddyy';\n  }\n  // Default to UK format (DD/MM/YY) for all other regions including GB\n  return 'ddmmyy';\n}\n\n/**\n * Get the effective date format based on user settings\n */\nexport function getEffectiveDateFormat(\n  dateFormatPreference: DateFormatPreference | null | undefined,\n  useRegionDefault: boolean | null | undefined,\n  region: RegionCode | null | undefined,\n  digitPreference: '6' | '8' | null | undefined\n): DateFormatPreference {\n  let baseFormat: 'ddmm' | 'mmdd';\n  \n  if (useRegionDefault) {\n    // Use region default\n    const regionFormat = getRegionDefaultFormat(region);\n    baseFormat = regionFormat.startsWith('dd') ? 'ddmm' : 'mmdd';\n  } else {\n    // Use explicit preference\n    baseFormat = (dateFormatPreference || 'ddmmyy').startsWith('dd') ? 'ddmm' : 'mmdd';\n  }\n  \n  // Apply digit preference - default to 8 digits if not specified\n  const digits = digitPreference === '6' ? 'yy' : 'yyyy';\n  return `${baseFormat}${digits}` as DateFormatPreference;\n}\n\n/**\n * Format a canonical date (YYYY-MM-DD) to the user's preferred format\n * Returns a string like \"010125\" or \"01011925\" depending on settings\n */\nexport function formatCanonicalDate(\n  canonicalDate: string,\n  format: DateFormatPreference\n): string {\n  const [year, month, day] = canonicalDate.split('-');\n  \n  // Determine year format\n  const yearStr = format.endsWith('yyyy') ? year : year.slice(2);\n  \n  // Determine day/month order\n  if (format.startsWith('dd')) {\n    // DD/MM format\n    return `${day}${month}${yearStr}`;\n  } else {\n    // MM/DD format\n    return `${month}${day}${yearStr}`;\n  }\n}\n\n/**\n * Helper function to validate that a date actually exists on the calendar\n * Checks for invalid dates like Feb 31, leap years, etc.\n */\nfunction isCalendarDateValid(day: number, month: number, year: number): boolean {\n  // Month must be 1-12\n  if (month < 1 || month > 12) {\n    return false;\n  }\n  \n  // Year must be positive (1 AD or later)\n  if (year < 1) {\n    return false;\n  }\n  \n  // Create a Date object (month is 0-indexed in JavaScript Date)\n  // Use setFullYear to avoid the JS quirk where years 0-99 are treated as 1900-1999\n  const date = new Date(0);\n  date.setFullYear(year, month - 1, day);\n  \n  // Check if the date round-trips correctly\n  // If you set Feb 31, JavaScript will roll it to Mar 3\n  return (\n    date.getFullYear() === year &&\n    date.getMonth() === month - 1 &&\n    date.getDate() === day\n  );\n}\n\n/**\n * Parse a user-entered date string based on format with answer context\n * Uses the actual answer's century for 2-digit years instead of hardcoded logic\n * Returns canonical format (YYYY-MM-DD) or null if invalid\n */\nexport function parseUserDateWithContext(\n  input: string,\n  format: DateFormatPreference,\n  answerCanonical: string\n): string | null {\n  const expectedLength = format.endsWith('yyyy') ? 8 : 6;\n  if (input.length !== expectedLength) {\n    return null;\n  }\n  \n  let day: string, month: string, year: string;\n  \n  if (format.startsWith('dd')) {\n    // DD/MM format\n    day = input.slice(0, 2);\n    month = input.slice(2, 4);\n    year = input.slice(4);\n  } else {\n    // MM/DD format\n    month = input.slice(0, 2);\n    day = input.slice(2, 4);\n    year = input.slice(4);\n  }\n  \n  // Expand 2-digit year to 4-digit using answer's century\n  if (year.length === 2) {\n    // Extract century from answer (e.g., \"1925-01-01\" -> \"19\")\n    const answerYear = answerCanonical.split('-')[0];\n    const century = answerYear.slice(0, 2);\n    year = `${century}${year}`;\n  }\n  \n  // Parse to integers\n  const dayNum = parseInt(day, 10);\n  const monthNum = parseInt(month, 10);\n  const yearNum = parseInt(year, 10);\n  \n  // Validate that this is a real calendar date\n  if (!isCalendarDateValid(dayNum, monthNum, yearNum)) {\n    return null;\n  }\n  \n  // Return in canonical format\n  return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;\n}\n\n/**\n * Parse a user-entered date string based on format\n * Returns canonical format (YYYY-MM-DD) or null if invalid\n */\nexport function parseUserDate(\n  input: string,\n  format: DateFormatPreference\n): string | null {\n  const expectedLength = format.endsWith('yyyy') ? 8 : 6;\n  if (input.length !== expectedLength) {\n    return null;\n  }\n  \n  let day: string, month: string, year: string;\n  \n  if (format.startsWith('dd')) {\n    // DD/MM format\n    day = input.slice(0, 2);\n    month = input.slice(2, 4);\n    year = input.slice(4);\n  } else {\n    // MM/DD format\n    month = input.slice(0, 2);\n    day = input.slice(2, 4);\n    year = input.slice(4);\n  }\n  \n  // Expand 2-digit year to 4-digit\n  if (year.length === 2) {\n    const yearNum = parseInt(year, 10);\n    // Assume 20th century for years >= 50, 21st otherwise\n    year = yearNum >= 50 ? `19${year}` : `20${year}`;\n  }\n  \n  // Parse to integers\n  const dayNum = parseInt(day, 10);\n  const monthNum = parseInt(month, 10);\n  const yearNum = parseInt(year, 10);\n  \n  // Validate that this is a real calendar date\n  if (!isCalendarDateValid(dayNum, monthNum, yearNum)) {\n    return null;\n  }\n  \n  // Return in canonical format\n  return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;\n}\n\n/**\n * Get placeholder text for input grid based on format\n * Returns array like ['D', 'D', 'M', 'M', 'Y', 'Y'] or ['M', 'M', 'D', 'D', 'Y', 'Y', 'Y', 'Y']\n */\nexport function getPlaceholders(format: DateFormatPreference): string[] {\n  const digits = format.endsWith('yyyy') ? 4 : 2;\n  const yearPlaceholders = Array(digits).fill('Y');\n  \n  if (format.startsWith('dd')) {\n    return ['D', 'D', 'M', 'M', ...yearPlaceholders];\n  } else {\n    return ['M', 'M', 'D', 'D', ...yearPlaceholders];\n  }\n}\n\n/**\n * Get display format string for UI (e.g., \"DD/MM/YY\" or \"MM/DD/YYYY\")\n */\nexport function getFormatDisplay(format: DateFormatPreference): string {\n  if (format === 'ddmmyy') return 'DD/MM/YY';\n  if (format === 'ddmmyyyy') return 'DD/MM/YYYY';\n  if (format === 'mmddyy') return 'MM/DD/YY';\n  if (format === 'mmddyyyy') return 'MM/DD/YYYY';\n  return 'DD/MM/YY'; // fallback\n}\n\n/**\n * Format canonical date for display with ordinal (e.g., \"1st January 1925\")\n */\nexport function formatCanonicalDateWithOrdinal(canonicalDate: string): string {\n  const [year, month, day] = canonicalDate.split('-');\n  const d = parseInt(day, 10);\n  const m = parseInt(month, 10) - 1;\n  const y = parseInt(year, 10);\n\n  const monthNames = [\n    \"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n    \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"\n  ];\n\n  const getOrdinalSuffix = (n: number): string => {\n    if (n > 3 && n < 21) return \"th\";\n    switch (n % 10) {\n      case 1: return \"st\";\n      case 2: return \"nd\";\n      case 3: return \"rd\";\n      default: return \"th\";\n    }\n  };\n\n  return `${d}${getOrdinalSuffix(d)} ${monthNames[m]} ${y}`;\n}\n\n/**\n * Validate a guess against the canonical answer\n */\nexport function validateGuess(\n  guess: string,\n  canonicalAnswer: string,\n  format: DateFormatPreference\n): boolean {\n  const parsedGuess = parseUserDate(guess, format);\n  return parsedGuess === canonicalAnswer;\n}\n\n// Legacy functions for backward compatibility (to be removed after migration)\nexport function formatDateWithOrdinal(dateString: string): string {\n  // Parse date in DDMMYY format\n  const day = parseInt(dateString.slice(0, 2), 10);\n  const month = parseInt(dateString.slice(2, 4), 10) - 1;\n  const year = parseInt(dateString.slice(4, 6), 10);\n  \n  const fullYear = year >= 50 ? 1900 + year : 2000 + year;\n  \n  const monthNames = [\n    \"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n    \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"\n  ];\n  \n  const getOrdinalSuffix = (day: number): string => {\n    if (day > 3 && day < 21) return \"th\";\n    switch (day % 10) {\n      case 1: return \"st\";\n      case 2: return \"nd\";\n      case 3: return \"rd\";\n      default: return \"th\";\n    }\n  };\n  \n  const ordinalDay = `${day}${getOrdinalSuffix(day)}`;\n  const monthName = monthNames[month];\n  \n  return `${ordinalDay} ${monthName} ${fullYear}`;\n}\n\nexport function formatFullDateWithOrdinal(dateString: string): string {\n  // Parse date in DD/MM/YYYY format\n  const parts = dateString.split('/');\n  const day = parseInt(parts[0], 10);\n  const month = parseInt(parts[1], 10) - 1;\n  const year = parseInt(parts[2], 10);\n  \n  const monthNames = [\n    \"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n    \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"\n  ];\n  \n  const getOrdinalSuffix = (day: number): string => {\n    if (day > 3 && day < 21) return \"th\";\n    switch (day % 10) {\n      case 1: return \"st\";\n      case 2: return \"nd\";\n      case 3: return \"rd\";\n      default: return \"th\";\n    }\n  };\n  \n  const ordinalDay = `${day}${getOrdinalSuffix(day)}`;\n  const monthName = monthNames[month];\n  \n  return `${ordinalDay} ${monthName} ${year}`;\n}\n\nexport function isoToDisplayDate(isoString: string): string {\n  const [year, month, day] = isoString.split(\"-\");\n  return `${day}/${month}/${year}`;\n}\n\nexport function formatIsoDateWithOrdinal(isoString: string): string {\n  return formatCanonicalDateWithOrdinal(isoString);\n}\n","path":null,"size_bytes":9581,"size_tokens":null},"client/src/lib/passwordValidation.ts":{"content":"export const PASSWORD_REQUIREMENTS = {\n  minLength: 8,\n  requireLetter: true,\n  requireNumber: true,\n  requireSpecialChar: true,\n};\n\nexport function validatePassword(password: string): { valid: boolean; errors: string[] } {\n  const errors: string[] = [];\n\n  if (password.length < PASSWORD_REQUIREMENTS.minLength) {\n    errors.push(`At least ${PASSWORD_REQUIREMENTS.minLength} characters`);\n  }\n\n  if (PASSWORD_REQUIREMENTS.requireLetter && !/[a-zA-Z]/.test(password)) {\n    errors.push('At least one letter');\n  }\n\n  if (PASSWORD_REQUIREMENTS.requireNumber && !/[0-9]/.test(password)) {\n    errors.push('At least one number');\n  }\n\n  if (PASSWORD_REQUIREMENTS.requireSpecialChar && !/[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/.test(password)) {\n    errors.push('At least one special character');\n  }\n\n  return {\n    valid: errors.length === 0,\n    errors,\n  };\n}\n\nexport function getPasswordRequirementsText(): string {\n  return 'Password must be at least 8 characters and include at least one letter, number, and special character.';\n}\n","path":null,"size_bytes":1033,"size_tokens":null},"client/src/components/AccountInfoPage.tsx":{"content":"import { useState, useEffect, useRef, useCallback } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { PasswordInput } from \"@/components/ui/password-input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { InlineHelp } from \"@/components/ui/inline-help\";\nimport { PostcodeAutocomplete } from \"@/components/PostcodeAutocomplete\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { ChevronLeft, Key, Mail, Link2, Check, Plus, Loader2 } from \"lucide-react\";\nimport { SiGoogle, SiApple } from \"react-icons/si\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useProfile } from \"@/hooks/useProfile\";\nimport { useSubscription } from \"@/hooks/useSubscription\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useSupabase } from \"@/lib/SupabaseProvider\";\nimport { useSpinnerWithTimeout } from \"@/lib/SpinnerProvider\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { validatePassword, getPasswordRequirementsText } from \"@/lib/passwordValidation\";\nimport { OTPVerificationScreen } from \"./OTPVerificationScreen\";\nimport { GeneratingQuestionsScreen } from \"./GeneratingQuestionsScreen\";\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport type { Region, UserProfile } from \"@shared/schema\";\nimport { useAdBannerActive } from \"@/components/AdBanner\";\nimport { readLocal, writeLocal, CACHE_KEYS } from \"@/lib/localCache\";\n\ninterface AccountInfoPageProps {\n  onBack: () => void;\n}\n\nexport default function AccountInfoPage({ onBack }: AccountInfoPageProps) {\n  const supabase = useSupabase();\n  const { user } = useAuth();\n  const { profile, updateProfile, isLoading: profileLoading } = useProfile();\n  const { isPro } = useSubscription();\n  const { toast } = useToast();\n  const qc = useQueryClient();\n  const [loading, setLoading] = useState(false);\n  const adBannerActive = useAdBannerActive();\n  const [showOTPVerification, setShowOTPVerification] = useState(false);\n  const [originalEmail, setOriginalEmail] = useState(\"\");\n  const [originalPostcode, setOriginalPostcode] = useState(\"\");\n  const [originalRegion, setOriginalRegion] = useState(\"\");\n  const [showRegionConfirm, setShowRegionConfirm] = useState(false);\n  const [pendingRegion, setPendingRegion] = useState<string | null>(null);\n  const [showGeneratingQuestions, setShowGeneratingQuestions] = useState(false);\n  const [showRestrictionPopup, setShowRestrictionPopup] = useState(false);\n  const [restrictionMessage, setRestrictionMessage] = useState(\"\");\n  const [showPostcodeInvalidDialog, setShowPostcodeInvalidDialog] = useState(false);\n  \n  // Track if spinner was actually shown (not just managed)\n  const spinnerShownRef = useRef(false);\n  \n  // Check if data is already in cache on mount - check React Query cache first, then localStorage\n  const rqCachedProfile = qc.getQueryData<UserProfile>(['/api/auth/profile']);\n  const rqCachedRegions = qc.getQueryData<Region[]>(['/api/regions']);\n  \n  // Fallback to localStorage cache if React Query cache is empty\n  const localCachedProfile = !rqCachedProfile ? readLocal<UserProfile>(CACHE_KEYS.PROFILE) : null;\n  const localCachedRegions = !rqCachedRegions ? readLocal<Region[]>(CACHE_KEYS.REGIONS) : null;\n  \n  // Use either React Query cache or localStorage cache\n  const cachedProfile = rqCachedProfile || localCachedProfile;\n  const cachedRegions = rqCachedRegions || localCachedRegions;\n  \n  // Helper functions to validate cached data - defined inline to avoid hook dependency issues\n  const isValidProfile = (p: UserProfile | null | undefined): boolean => {\n    if (!p) return false;\n    return !!(p.id || p.email);\n  };\n  const isValidRegions = (r: Region[] | null | undefined): boolean => {\n    if (!r) return false;\n    return Array.isArray(r) && r.length > 0;\n  };\n  \n  // hasCachedData only true if data is actually valid/usable\n  const hasCachedData = isValidProfile(cachedProfile) && isValidRegions(cachedRegions);\n  \n  // Fetch available regions\n  const { data: regions, isLoading: regionsLoading, refetch: refetchRegions } = useQuery<Region[]>({\n    queryKey: ['/api/regions'],\n  });\n  \n  // Callbacks for spinner timeout handling\n  const handleRetry = useCallback(() => {\n    console.log('[AccountInfoPage] Spinner timeout - triggering retry');\n    qc.invalidateQueries({ queryKey: ['/api/auth/profile'] });\n    refetchRegions?.();\n  }, [qc, refetchRegions]);\n  \n  const handleTimeout = useCallback(() => {\n    console.log('[AccountInfoPage] Spinner timeout - failed to load');\n    toast({\n      title: 'Failed to load',\n      description: 'Please try again in a bit.',\n      variant: 'destructive',\n    });\n    onBack();\n  }, [toast, onBack]);\n  \n  // Use spinner with timeout for automatic retry and failure handling\n  const spinner = useSpinnerWithTimeout({\n    retryDelayMs: 4000,\n    timeoutMs: 8000,\n    onRetry: handleRetry,\n    onTimeout: handleTimeout,\n  });\n  \n  // Helper to check if profile has meaningful data (not just truthy)\n  const hasValidProfileData = useCallback((p: UserProfile | null | undefined): boolean => {\n    if (!p) return false;\n    // Profile must have at least an ID or email to be considered valid\n    return !!(p.id || p.email);\n  }, []);\n  \n  // Helper to check if regions has meaningful data\n  const hasValidRegionsData = useCallback((r: Region[] | null | undefined): boolean => {\n    if (!r) return false;\n    return Array.isArray(r) && r.length > 0;\n  }, []);\n  \n  // Manage spinner: only show if data is NOT already cached with valid content\n  useEffect(() => {\n    // Check if cached data is actually valid/usable\n    const cachedProfileValid = hasValidProfileData(cachedProfile);\n    const cachedRegionsValid = hasValidRegionsData(cachedRegions);\n    const hasValidCachedData = cachedProfileValid && cachedRegionsValid;\n    \n    // If we already have valid cached data, never show spinner\n    if (hasValidCachedData) {\n      console.log('[AccountInfoPage] Valid cached data found, skipping spinner');\n      return;\n    }\n    \n    // Check if fresh data is valid\n    const profileValid = hasValidProfileData(profile);\n    const regionsValid = hasValidRegionsData(regions);\n    const isDataReady = profileValid && regionsValid;\n    const isDataLoading = profileLoading || regionsLoading;\n    \n    // Start spinner if loading and no valid data yet\n    if (!isDataReady && !spinnerShownRef.current) {\n      console.log('[AccountInfoPage] Showing spinner with timeout - waiting for valid profile/regions data');\n      spinner.start(0);\n      spinnerShownRef.current = true;\n    }\n    \n    // Complete spinner when valid data is ready\n    if (isDataReady && spinnerShownRef.current) {\n      console.log('[AccountInfoPage] Valid data loaded - completing spinner');\n      spinner.complete();\n      spinnerShownRef.current = false;\n    }\n    \n    // Cleanup on unmount - only cancel if we actually showed the spinner\n    return () => {\n      if (spinnerShownRef.current) {\n        spinner.cancel();\n        spinnerShownRef.current = false;\n      }\n    };\n  }, [profileLoading, regionsLoading, profile, regions, spinner, cachedProfile, cachedRegions, hasValidProfileData, hasValidRegionsData]);\n\n  // Initialize profile data from cache immediately if available\n  const initialProfile = cachedProfile || profile;\n  const initialRegions = cachedRegions || regions;\n  \n  const [profileData, setProfileData] = useState(() => ({\n    firstName: initialProfile?.firstName || \"\",\n    lastName: initialProfile?.lastName || \"\",\n    email: initialProfile?.email || \"\",\n    region: initialProfile?.region || (initialRegions && initialRegions.length > 0 ? initialRegions[0].code : \"\"),\n    postcode: initialProfile?.postcode || \"\",\n  }));\n  \n  // Track if we've already initialized from profile\n  const initializedRef = useRef(!!initialProfile);\n\n  // Update profile data when fresh data loads (but only if not already initialized from cache)\n  useEffect(() => {\n    if (profile && !initializedRef.current) {\n      setProfileData({\n        firstName: profile.firstName || \"\",\n        lastName: profile.lastName || \"\",\n        email: profile.email || \"\",\n        region: profile.region || (regions && regions.length > 0 ? regions[0].code : \"\"),\n        postcode: profile.postcode || \"\",\n      });\n      setOriginalEmail(profile.email || \"\");\n      setOriginalPostcode(profile.postcode || \"\");\n      setOriginalRegion(profile.region || \"\");\n      initializedRef.current = true;\n    }\n  }, [profile, regions]);\n  \n  // Set original values from initial data\n  useEffect(() => {\n    if (initialProfile && !originalEmail) {\n      setOriginalEmail(initialProfile.email || \"\");\n    }\n    if (initialProfile && !originalPostcode) {\n      setOriginalPostcode(initialProfile.postcode || \"\");\n    }\n  }, [initialProfile, originalEmail, originalPostcode]);\n\n  const [passwordData, setPasswordData] = useState({\n    currentPassword: \"\",\n    newPassword: \"\",\n    confirmPassword: \"\",\n  });\n  \n  // Track if user has a password (authenticated with password vs magic link only)\n  const [hasPassword, setHasPassword] = useState<boolean | null>(null);\n  \n  // Connected accounts state\n  const [showPasswordSection, setShowPasswordSection] = useState(false);\n  const [isGoogleConnected, setIsGoogleConnected] = useState(false);\n  const [isAppleConnected, setIsAppleConnected] = useState(false);\n  const [unlinkingGoogle, setUnlinkingGoogle] = useState(false);\n  const [unlinkingApple, setUnlinkingApple] = useState(false);\n  const [googleIdentity, setGoogleIdentity] = useState<any>(null);\n  const [appleIdentity, setAppleIdentity] = useState<any>(null);\n  const [magicLinkEnabled, setMagicLinkEnabled] = useState(true);\n  const [togglingMagicLink, setTogglingMagicLink] = useState(false);\n  \n  // Initialize magic link enabled state from Supabase (column not in Drizzle schema)\n  useEffect(() => {\n    const fetchMagicLinkSetting = async () => {\n      if (!user?.id) return;\n      try {\n        const session = await supabase.auth.getSession();\n        if (session.data.session) {\n          const response = await fetch(`/api/auth/profile/magic-link-status`, {\n            headers: {\n              'Authorization': `Bearer ${session.data.session.access_token}`,\n            },\n          });\n          if (response.ok) {\n            const data = await response.json();\n            setMagicLinkEnabled(data.enabled !== false);\n          }\n        }\n      } catch (e) {\n        // Default to enabled if we can't fetch\n        console.log('[AccountInfoPage] Could not fetch magic link status, defaulting to enabled');\n      }\n    };\n    fetchMagicLinkSetting();\n  }, [user?.id, supabase]);\n  \n  // Check if user has a password - prefer profile.passwordCreated, fallback to AMR check\n  useEffect(() => {\n    const checkHasPassword = async () => {\n      try {\n        // First check if profile has passwordCreated field\n        if (profile?.passwordCreated !== undefined && profile.passwordCreated !== null) {\n          setHasPassword(profile.passwordCreated);\n          return;\n        }\n        \n        // Fallback: Check AMR (Authentication Methods Reference) from session\n        const { data: { session } } = await supabase.auth.getSession();\n        if (session) {\n          const amr = (session as any).user?.amr || [];\n          const hasPasswordAuth = amr.some((method: any) => method.method === 'password');\n          setHasPassword(hasPasswordAuth);\n        } else {\n          setHasPassword(false);\n        }\n      } catch (error) {\n        console.error('Error checking password status:', error);\n        setHasPassword(false);\n      }\n    };\n    checkHasPassword();\n  }, [supabase, profile?.passwordCreated]);\n  \n  // Check if Google/Apple is connected - based on profile.googleLinked/appleLinked, not Supabase identity\n  // This allows \"unlinking\" without revoking OAuth, so re-linking doesn't require re-authorization\n  useEffect(() => {\n    const checkOAuthConnections = async () => {\n      try {\n        const { data: { user } } = await supabase.auth.getUser();\n        if (user) {\n          // Find Google identity in Supabase (for re-linking without re-auth)\n          const googleId = user.identities?.find(\n            (identity) => identity.provider === 'google'\n          );\n          const providers = user.app_metadata?.providers || [];\n          const hasGoogleProvider = providers.includes('google') || \n                                   user.app_metadata?.provider === 'google';\n          \n          setGoogleIdentity(googleId || null);\n          \n          // Find Apple identity in Supabase\n          const appleId = user.identities?.find(\n            (identity) => identity.provider === 'apple'\n          );\n          const hasAppleProvider = providers.includes('apple') || \n                                  user.app_metadata?.provider === 'apple';\n          \n          setAppleIdentity(appleId || null);\n          \n          // UI \"connected\" state is based on profile.googleLinked/appleLinked\n          // Not on whether identity exists in Supabase\n          setIsGoogleConnected(profile?.googleLinked === true);\n          setIsAppleConnected(profile?.appleLinked === true);\n          \n          // Sync database if we just authorized OAuth (first time or after redirect from linkIdentity)\n          // Only sync if identity exists in Supabase but profile says NOT linked\n          const googleHasIdentity = !!googleId || hasGoogleProvider;\n          const appleHasIdentity = !!appleId || hasAppleProvider;\n          \n          const session = await supabase.auth.getSession();\n          if (session.data.session) {\n            const accessToken = session.data.session.access_token;\n            \n            // If Google identity exists but never tracked (null) in profile, set linked=true\n            // Don't sync if googleLinked=false (user explicitly unlinked)\n            if (googleHasIdentity && profile?.googleLinked === null) {\n              console.log('[AccountInfoPage] Syncing Google linked status to database (first auth)');\n              fetch('/api/auth/profile/oauth-linked', {\n                method: 'POST',\n                headers: {\n                  'Content-Type': 'application/json',\n                  'Authorization': `Bearer ${accessToken}`,\n                },\n                body: JSON.stringify({ provider: 'google', linked: true }),\n              }).then(() => {\n                queryClient.invalidateQueries({ queryKey: ['/api/auth/profile'] });\n              }).catch(err => console.error('Failed to sync Google linked status:', err));\n            }\n            \n            // Same for Apple\n            if (appleHasIdentity && profile?.appleLinked === null) {\n              console.log('[AccountInfoPage] Syncing Apple linked status to database (first auth)');\n              fetch('/api/auth/profile/oauth-linked', {\n                method: 'POST',\n                headers: {\n                  'Content-Type': 'application/json',\n                  'Authorization': `Bearer ${accessToken}`,\n                },\n                body: JSON.stringify({ provider: 'apple', linked: true }),\n              }).then(() => {\n                queryClient.invalidateQueries({ queryKey: ['/api/auth/profile'] });\n              }).catch(err => console.error('Failed to sync Apple linked status:', err));\n            }\n          }\n        }\n      } catch (error) {\n        console.error('Error checking OAuth connections:', error);\n        setIsGoogleConnected(false);\n        setIsAppleConnected(false);\n      }\n    };\n    checkOAuthConnections();\n  }, [supabase, profile?.googleLinked, profile?.appleLinked]);\n\n  const handleRegionChange = (newRegion: string) => {\n    // Only show confirmation if region actually changed from profile's current region\n    if (profile && newRegion !== profile.region) {\n      setPendingRegion(newRegion);\n      setShowRegionConfirm(true);\n    } else {\n      // Just update the local state without showing dialog\n      setProfileData({ ...profileData, region: newRegion });\n    }\n  };\n\n  const handleConfirmRegionChange = async () => {\n    if (!pendingRegion) return;\n\n    setLoading(true);\n    setShowRegionConfirm(false);\n\n    try {\n      // Call API directly to check for restriction response\n      const session = (await supabase.auth.getSession()).data.session;\n      const accessToken = session?.access_token;\n      \n      const response = await fetch('/api/auth/profile', {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${accessToken}`,\n        },\n        body: JSON.stringify({\n          region: pendingRegion,\n        }),\n      });\n      \n      const data = await response.json();\n      \n      // Check for restriction response\n      if (data._restrictionBlocked) {\n        // Restriction triggered - region change was blocked\n        setRestrictionMessage(data._restrictionMessage || \"You can only update your region once every few days.\");\n        setShowRestrictionPopup(true);\n        setPendingRegion(null);\n        return;\n      }\n      \n      if (!response.ok) {\n        // Check for cooldown error\n        if (data.code === 'LOCATION_COOLDOWN') {\n          setRestrictionMessage(data.error || \"You can only update your region once every few days.\");\n          setShowRestrictionPopup(true);\n          setPendingRegion(null);\n          return;\n        }\n        throw new Error(data.error || 'Failed to update region');\n      }\n      \n      // Update caches\n      qc.setQueryData([\"/api/auth/profile\"], data);\n      writeLocal(CACHE_KEYS.PROFILE, data);\n\n      setProfileData({ ...profileData, region: pendingRegion });\n      setOriginalRegion(pendingRegion);\n      setPendingRegion(null);\n\n      toast({\n        title: \"Region updated!\",\n        description: \"Your region preference has been saved.\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update region\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleCancelRegionChange = () => {\n    setPendingRegion(null);\n    setShowRegionConfirm(false);\n  };\n\n  const handleUpdateProfile = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    const emailChanged = profileData.email !== originalEmail;\n    const postcodeChanged = profileData.postcode !== originalPostcode;\n    \n    // If postcode is changing to a non-empty value, validate it first\n    if (postcodeChanged && profileData.postcode && profileData.postcode.trim()) {\n      try {\n        const validateResponse = await fetch(`/api/postcodes/validate?postcode=${encodeURIComponent(profileData.postcode.trim())}`);\n        const validateResult = await validateResponse.json();\n        \n        if (!validateResult.valid) {\n          // Postcode not supported - show dialog and revert to original\n          setShowPostcodeInvalidDialog(true);\n          setProfileData(prev => ({ ...prev, postcode: originalPostcode }));\n          return;\n        }\n      } catch (error) {\n        console.error(\"[AccountInfo] Postcode validation error:\", error);\n        // On validation error, show the dialog to be safe\n        setShowPostcodeInvalidDialog(true);\n        setProfileData(prev => ({ ...prev, postcode: originalPostcode }));\n        return;\n      }\n    }\n    \n    setLoading(true);\n\n    try {\n\n      if (emailChanged) {\n        // Initiate email change - Supabase will send OTP to new email\n        const { error } = await supabase.auth.updateUser({\n          email: profileData.email,\n        });\n\n        if (error) throw error;\n\n        // Show OTP verification screen\n        setShowOTPVerification(true);\n        toast({\n          title: \"Verification code sent!\",\n          description: `Please check ${profileData.email} for your verification code`,\n        });\n      } else {\n        // No email change, just update name fields\n        const { error } = await supabase.auth.updateUser({\n          data: {\n            first_name: profileData.firstName,\n            last_name: profileData.lastName,\n          },\n        });\n\n        if (error) throw error;\n\n        // Update user profile in database via API\n        const session = (await supabase.auth.getSession()).data.session;\n        const accessToken = session?.access_token;\n        \n        const response = await fetch('/api/auth/profile', {\n          method: 'PATCH',\n          headers: {\n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${accessToken}`,\n          },\n          body: JSON.stringify({\n            firstName: profileData.firstName,\n            lastName: profileData.lastName,\n            email: profileData.email,\n            postcode: profileData.postcode || null,\n          }),\n        });\n\n        const responseData = await response.json().catch(() => ({}));\n\n        // Check for restriction response (postcode change was blocked but name/email saved)\n        if (responseData._restrictionBlocked) {\n          // Name/email changes were saved, but postcode change was blocked\n          // Reset postcode to original since it wasn't changed\n          setProfileData({ ...profileData, postcode: originalPostcode });\n          \n          // Update caches with the partial update (excluding blocked postcode change)\n          qc.setQueryData([\"/api/auth/profile\"], responseData);\n          writeLocal(CACHE_KEYS.PROFILE, responseData);\n          \n          // Show restriction popup\n          setRestrictionMessage(responseData._restrictionMessage || \"You can only update your postcode once every few days.\");\n          setShowRestrictionPopup(true);\n          \n          // Still show success for name/email if they were changed\n          if (profileData.firstName !== originalEmail || profileData.lastName !== originalEmail) {\n            toast({\n              title: \"Profile partially updated\",\n              description: \"Name changes saved, but postcode change was blocked.\",\n            });\n          }\n          return;\n        }\n\n        if (!response.ok) {\n          // Check for cooldown error when only postcode was submitted\n          if (responseData.code === 'LOCATION_COOLDOWN') {\n            setRestrictionMessage(responseData.error || \"You can only update your postcode once every few days.\");\n            setShowRestrictionPopup(true);\n            setProfileData({ ...profileData, postcode: originalPostcode });\n            return;\n          }\n          throw new Error(responseData.error || 'Failed to update profile in database');\n        }\n\n        // Get the updated profile from response and update caches immediately\n        const updatedProfile = responseData;\n        \n        // Update React Query cache immediately with new data\n        qc.setQueryData([\"/api/auth/profile\"], updatedProfile);\n        \n        // Update localStorage cache immediately\n        writeLocal(CACHE_KEYS.PROFILE, updatedProfile);\n\n        // If postcode changed, call reset-and-reallocate-user then show GeneratingQuestionsScreen\n        if (postcodeChanged && user?.id && profileData.postcode) {\n          console.log('[AccountInfoPage] Postcode changed - calling reset-and-reallocate-user');\n          \n          // Validate that we have an access token\n          if (!accessToken) {\n            throw new Error(\"No access token found\");\n          }\n          \n          // Call the reset-and-reallocate-user Edge Function\n          const supabaseUrl = import.meta.env.VITE_SUPABASE_URL || (supabase as any).supabaseUrl;\n          if (!supabaseUrl) {\n            console.warn('[AccountInfoPage] Supabase URL not available; skipping reset-and-reallocate-user');\n          } else {\n            const functionBaseUrl = supabaseUrl.replace('.supabase.co', '.functions.supabase.co');\n            console.log('[AccountInfoPage] Function base URL:', functionBaseUrl);\n            \n            try {\n              const resetPayload = { user_id: user.id };\n              const resetResponse = await fetch(`${functionBaseUrl}/reset-and-reallocate-user`, {\n                method: 'POST',\n                headers: {\n                  'Content-Type': 'application/json',\n                  'Authorization': `Bearer ${accessToken}`,\n                },\n                body: JSON.stringify(resetPayload),\n              });\n              \n              const resetBody = await resetResponse.text();\n              console.log('[AccountInfoPage] reset-and-reallocate-user status:', resetResponse.status, resetBody);\n              \n              if (!resetResponse.ok) {\n                throw new Error(`reset-and-reallocate-user returned error: ${resetResponse.status}`);\n              }\n            } catch (err) {\n              console.error('[AccountInfoPage] reset-and-reallocate-user failed:', err);\n              throw err;\n            }\n          }\n          \n          // Update original postcode reference\n          setOriginalPostcode(profileData.postcode);\n          \n          // Show GeneratingQuestionsScreen to repopulate locations and allocate questions\n          setShowGeneratingQuestions(true);\n          return; // Don't show toast - GeneratingQuestionsScreen will handle completion\n        }\n\n        toast({\n          title: \"Profile updated!\",\n          description: \"Your profile information has been saved.\",\n        });\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update profile\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleOTPVerified = async () => {\n    // After OTP verification, email is already updated in Supabase Auth\n    // Just need to update the profile in our database\n    setLoading(true);\n    try {\n      // Update user profile in database with new email\n      const response = await fetch('/api/auth/profile', {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${(await supabase.auth.getSession()).data.session?.access_token}`,\n        },\n        body: JSON.stringify({\n          firstName: profileData.firstName,\n          lastName: profileData.lastName,\n          email: profileData.email,\n          postcode: profileData.postcode || null,\n        }),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(errorData.error || 'Failed to update profile in database');\n      }\n\n      // Get the updated profile from response and update caches immediately\n      const updatedProfile = await response.json();\n      \n      // Update React Query cache immediately with new data\n      qc.setQueryData([\"/api/auth/profile\"], updatedProfile);\n      \n      // Update localStorage cache immediately\n      writeLocal(CACHE_KEYS.PROFILE, updatedProfile);\n\n      setShowOTPVerification(false);\n      setOriginalEmail(profileData.email); // Update the original email reference\n      toast({\n        title: \"Email updated!\",\n        description: \"Your email address has been successfully changed.\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Error updating email\",\n        description: error.message || \"Failed to update email\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleCancelEmailChange = () => {\n    // Reset email to original value\n    setProfileData({\n      ...profileData,\n      email: originalEmail,\n    });\n    setShowOTPVerification(false);\n    toast({\n      title: \"Email change cancelled\",\n      description: \"Your email has not been changed\",\n    });\n  };\n\n  // Toggle magic link login enabled/disabled\n  const handleToggleMagicLink = async (enabled: boolean) => {\n    if (togglingMagicLink) return;\n    \n    // Check if user has another way to log in before disabling\n    if (!enabled && !hasPassword && !isGoogleConnected && !isAppleConnected) {\n      toast({\n        title: \"Cannot disable magic link\",\n        description: \"You need at least one login method. Please set up a password or connect a social account first.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    setTogglingMagicLink(true);\n    \n    try {\n      const session = await supabase.auth.getSession();\n      if (session.data.session) {\n        const response = await fetch('/api/auth/profile/magic-link', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${session.data.session.access_token}`,\n          },\n          body: JSON.stringify({ enabled }),\n        });\n        \n        if (!response.ok) {\n          throw new Error('Failed to update magic link setting');\n        }\n        \n        setMagicLinkEnabled(enabled);\n        \n        // Invalidate profile cache\n        queryClient.invalidateQueries({ queryKey: ['/api/auth/profile'] });\n        \n        toast({\n          title: enabled ? \"Magic link enabled\" : \"Magic link disabled\",\n          description: enabled \n            ? \"You can now sign in with email links\" \n            : \"Magic link sign-in has been disabled\",\n        });\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Failed to update setting\",\n        description: error.message || \"Please try again later\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setTogglingMagicLink(false);\n    }\n  };\n\n  // Unlink Google account - just updates database, keeps Supabase identity so re-auth isn't needed\n  const handleUnlinkGoogle = async () => {\n    if (unlinkingGoogle) return;\n    \n    // Check if user has another way to log in (password or Apple)\n    if (!hasPassword && !isAppleConnected) {\n      toast({\n        title: \"Cannot unlink Google\",\n        description: \"You need at least one login method. Please set up a password first.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    setUnlinkingGoogle(true);\n    \n    try {\n      // Only update the database - don't revoke from Supabase\n      // This allows re-linking without re-authorization\n      const session = await supabase.auth.getSession();\n      if (session.data.session) {\n        const response = await fetch('/api/auth/profile/oauth-linked', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${session.data.session.access_token}`,\n          },\n          body: JSON.stringify({ provider: 'google', linked: false }),\n        });\n        \n        if (!response.ok) throw new Error('Failed to update profile');\n      }\n      \n      setIsGoogleConnected(false);\n      // Keep googleIdentity set - we still have it in Supabase\n      \n      // Invalidate profile query to refresh data\n      queryClient.invalidateQueries({ queryKey: ['/api/auth/profile'] });\n      \n      toast({\n        title: \"Google disconnected\",\n        description: \"Google sign-in has been disabled for your account.\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Failed to unlink Google\",\n        description: error.message || \"Please try again later\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setUnlinkingGoogle(false);\n    }\n  };\n\n  // Unlink Apple account - just updates database, keeps Supabase identity so re-auth isn't needed\n  const handleUnlinkApple = async () => {\n    if (unlinkingApple) return;\n    \n    // Check if user has another way to log in (password or Google)\n    if (!hasPassword && !isGoogleConnected) {\n      toast({\n        title: \"Cannot unlink Apple\",\n        description: \"You need at least one login method. Please set up a password first.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    setUnlinkingApple(true);\n    \n    try {\n      // Only update the database - don't revoke from Supabase\n      // This allows re-linking without re-authorization\n      const session = await supabase.auth.getSession();\n      if (session.data.session) {\n        const response = await fetch('/api/auth/profile/oauth-linked', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${session.data.session.access_token}`,\n          },\n          body: JSON.stringify({ provider: 'apple', linked: false }),\n        });\n        \n        if (!response.ok) throw new Error('Failed to update profile');\n      }\n      \n      setIsAppleConnected(false);\n      // Keep appleIdentity set - we still have it in Supabase\n      \n      // Invalidate profile query to refresh data\n      queryClient.invalidateQueries({ queryKey: ['/api/auth/profile'] });\n      \n      toast({\n        title: \"Apple disconnected\",\n        description: \"Apple sign-in has been disabled for your account.\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Failed to unlink Apple\",\n        description: error.message || \"Please try again later\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setUnlinkingApple(false);\n    }\n  };\n\n  const handleChangePassword = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    // Validate new password\n    const validation = validatePassword(passwordData.newPassword);\n    if (!validation.valid) {\n      toast({\n        title: \"Invalid Password\",\n        description: validation.errors.join(', '),\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Check passwords match\n    if (passwordData.newPassword !== passwordData.confirmPassword) {\n      toast({\n        title: \"Passwords don't match\",\n        description: \"New password and confirmation must match\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setLoading(true);\n\n    try {\n      // If user has a password, verify current password first\n      if (hasPassword) {\n        const { error: signInError } = await supabase.auth.signInWithPassword({\n          email: user?.email || \"\",\n          password: passwordData.currentPassword,\n        });\n\n        if (signInError) {\n          throw new Error(\"Current password is incorrect\");\n        }\n      }\n\n      // Update/create password\n      const { error: updateError } = await supabase.auth.updateUser({\n        password: passwordData.newPassword,\n      });\n\n      if (updateError) throw updateError;\n\n      // Update hasPassword state since they now have a password\n      setHasPassword(true);\n      \n      // Update passwordCreated in database\n      try {\n        const session = (await supabase.auth.getSession()).data.session;\n        if (session?.access_token) {\n          await fetch('/api/auth/profile/password-created', {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n              'Authorization': `Bearer ${session.access_token}`,\n            },\n          });\n          // Invalidate profile cache to reflect the change\n          qc.invalidateQueries({ queryKey: ['/api/auth/profile'] });\n        }\n      } catch (dbError) {\n        console.error('Failed to update passwordCreated in database:', dbError);\n        // Non-critical error - password was still updated in Supabase Auth\n      }\n      \n      // Hide password section after successful creation\n      setShowPasswordSection(false);\n\n      toast({\n        title: hasPassword ? \"Password changed!\" : \"Password created!\",\n        description: hasPassword \n          ? \"Your password has been updated successfully.\"\n          : \"Your password has been created. You can now log in with email and password.\",\n      });\n\n      // Clear password fields\n      setPasswordData({\n        currentPassword: \"\",\n        newPassword: \"\",\n        confirmPassword: \"\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to change password\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // Handler for when GeneratingQuestionsScreen completes\n  const handleGeneratingQuestionsComplete = () => {\n    console.log('[AccountInfoPage] GeneratingQuestionsScreen complete - navigating back');\n    setShowGeneratingQuestions(false);\n    setLoading(false);\n    // Invalidate queries to refresh data\n    queryClient.invalidateQueries({ queryKey: ['/api/user/puzzles'] });\n    queryClient.invalidateQueries({ queryKey: ['/api/puzzles'] });\n    queryClient.invalidateQueries({ queryKey: ['/api/user/game-attempts/user'] });\n    queryClient.invalidateQueries({ queryKey: ['/api/game-attempts/user'] });\n    toast({\n      title: \"Profile updated!\",\n      description: \"Your postcode and puzzles have been updated.\",\n    });\n    onBack(); // Navigate back to GameSelectionPage\n  };\n\n  // Show GeneratingQuestionsScreen after postcode change\n  if (showGeneratingQuestions && user?.id && profile?.region && profileData.postcode) {\n    return (\n      <GeneratingQuestionsScreen\n        userId={user.id}\n        region={profile.region}\n        postcode={profileData.postcode}\n        onComplete={handleGeneratingQuestionsComplete}\n        regenerationType=\"postcode_change\"\n        isPro={isPro}\n      />\n    );\n  }\n\n  // Show OTP verification screen for email change\n  if (showOTPVerification) {\n    return (\n      <OTPVerificationScreen\n        email={profileData.email}\n        type=\"email_change\"\n        onVerified={handleOTPVerified}\n        onCancel={handleCancelEmailChange}\n      />\n    );\n  }\n\n  return (\n    <div className={`min-h-screen flex flex-col p-4 bg-background ${adBannerActive ? 'pb-[50px]' : ''}`}>\n      <div className=\"w-full max-w-md mx-auto space-y-6\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <button\n            onClick={onBack}\n            data-testid=\"button-back-from-account\"\n            className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n          >\n            <ChevronLeft className=\"h-9 w-9 text-gray-700\" />\n          </button>\n\n          <div className=\"flex flex-col items-center\">\n            <h1 className=\"text-4xl font-bold\">Account Info</h1>\n          </div>\n\n          {/* Spacer to balance layout */}\n          <div className=\"w-14\" />\n        </div>\n          {/* Profile Information */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Profile Information</CardTitle>\n              <CardDescription>Update your name and email</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <form onSubmit={handleUpdateProfile} className=\"space-y-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"firstName\" data-testid=\"label-firstname\">\n                      First Name\n                    </Label>\n                    <Input\n                      id=\"firstName\"\n                      data-testid=\"input-firstname\"\n                      value={profileData.firstName}\n                      onChange={(e) =>\n                        setProfileData({ ...profileData, firstName: e.target.value })\n                      }\n                      required\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"lastName\" data-testid=\"label-lastname\">\n                      Last Name\n                    </Label>\n                    <Input\n                      id=\"lastName\"\n                      data-testid=\"input-lastname\"\n                      value={profileData.lastName}\n                      onChange={(e) =>\n                        setProfileData({ ...profileData, lastName: e.target.value })\n                      }\n                    />\n                  </div>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"email\" data-testid=\"label-email\">\n                    Email\n                  </Label>\n                  <Input\n                    id=\"email\"\n                    type=\"email\"\n                    data-testid=\"input-email\"\n                    value={profileData.email}\n                    onChange={(e) =>\n                      setProfileData({ ...profileData, email: e.target.value })\n                    }\n                    required\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-1.5\">\n                    <Label htmlFor=\"postcode\" data-testid=\"label-postcode-account\">\n                      Postcode\n                    </Label>\n                    <InlineHelp data-testid=\"button-postcode-info-account\">\n                      <p>Your postcode helps us provide local puzzles. Changing this may affect your local puzzle availability.</p>\n                    </InlineHelp>\n                  </div>\n                  <PostcodeAutocomplete\n                    value={profileData.postcode}\n                    onChange={(value) =>\n                      setProfileData({ ...profileData, postcode: value })\n                    }\n                    placeholder=\"Enter your postcode\"\n                    data-testid=\"input-postcode-account\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"region\" data-testid=\"label-region-account\">\n                    Region\n                  </Label>\n                  <Select\n                    value={profileData.region}\n                    onValueChange={handleRegionChange}\n                    disabled={regionsLoading}\n                  >\n                    <SelectTrigger id=\"region\" data-testid=\"select-region-account\">\n                      <SelectValue placeholder={regionsLoading ? \"Loading regions...\" : \"Select your region\"} />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {regions?.map((region) => (\n                          <SelectItem \n                            key={region.code} \n                            value={region.code} \n                            data-testid={`option-region-${region.code.toLowerCase()}-account`}\n                          >\n                            {region.name}\n                          </SelectItem>\n                        )\n                      )}\n                    </SelectContent>\n                  </Select>\n                  {profile?.postcodeLastChangedAt && (\n                    <p className=\"text-xs text-muted-foreground\" data-testid=\"text-region-last-updated-account\">\n                      Last updated: {new Date(profile.postcodeLastChangedAt).toLocaleDateString()}\n                    </p>\n                  )}\n                </div>\n\n                <Button\n                  type=\"submit\"\n                  className=\"w-full\"\n                  disabled={loading}\n                  data-testid=\"button-update-profile\"\n                >\n                  {loading ? \"Saving...\" : \"Save Changes\"}\n                </Button>\n              </form>\n            </CardContent>\n          </Card>\n\n          {/* Connected Accounts */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Connected Accounts</CardTitle>\n              <CardDescription>Manage your login methods</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {/* Password Login Method */}\n              <div className=\"flex items-center justify-between p-3 rounded-lg border\" data-testid=\"connected-account-password\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                    <Key className=\"w-5 h-5 text-primary\" />\n                  </div>\n                  <div>\n                    <p className=\"font-medium\">Password</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {hasPassword ? \"Password set\" : \"No password set\"}\n                    </p>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  {hasPassword && (\n                    <Check className=\"w-5 h-5 text-green-500\" />\n                  )}\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => setShowPasswordSection(!showPasswordSection)}\n                    data-testid=\"button-toggle-password-section\"\n                  >\n                    {hasPassword ? \"Change\" : \"Create\"}\n                  </Button>\n                </div>\n              </div>\n              \n              {/* Password Form (collapsible) */}\n              {showPasswordSection && (\n                <div className=\"border rounded-lg p-4 bg-muted/30\">\n                  <form onSubmit={handleChangePassword} className=\"space-y-4\">\n                    {hasPassword && (\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"currentPassword\" data-testid=\"label-current-password\">\n                          Current Password\n                        </Label>\n                        <PasswordInput\n                          id=\"currentPassword\"\n                          data-testid=\"input-current-password\"\n                          value={passwordData.currentPassword}\n                          onChange={(e) =>\n                            setPasswordData({ ...passwordData, currentPassword: e.target.value })\n                          }\n                          required\n                        />\n                      </div>\n                    )}\n                    \n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"newPassword\" data-testid=\"label-new-password\">\n                        {hasPassword ? \"New Password\" : \"Password\"}\n                      </Label>\n                      <PasswordInput\n                        id=\"newPassword\"\n                        data-testid=\"input-new-password\"\n                        value={passwordData.newPassword}\n                        onChange={(e) =>\n                          setPasswordData({ ...passwordData, newPassword: e.target.value })\n                        }\n                        required\n                      />\n                      <p className=\"text-xs text-muted-foreground\">\n                        {getPasswordRequirementsText()}\n                      </p>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"confirmPassword\" data-testid=\"label-confirm-password\">\n                        {hasPassword ? \"Confirm New Password\" : \"Confirm Password\"}\n                      </Label>\n                      <PasswordInput\n                        id=\"confirmPassword\"\n                        data-testid=\"input-confirm-password\"\n                        value={passwordData.confirmPassword}\n                        onChange={(e) =>\n                          setPasswordData({ ...passwordData, confirmPassword: e.target.value })\n                        }\n                        required\n                      />\n                    </div>\n\n                    <div className=\"flex gap-2\">\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        onClick={() => {\n                          setShowPasswordSection(false);\n                          setPasswordData({ currentPassword: \"\", newPassword: \"\", confirmPassword: \"\" });\n                        }}\n                        data-testid=\"button-cancel-password\"\n                      >\n                        Cancel\n                      </Button>\n                      <Button\n                        type=\"submit\"\n                        disabled={loading || hasPassword === null}\n                        data-testid=\"button-save-password\"\n                      >\n                        {loading \n                          ? (hasPassword ? \"Saving...\" : \"Creating...\") \n                          : (hasPassword ? \"Save Password\" : \"Create Password\")}\n                      </Button>\n                    </div>\n                  </form>\n                </div>\n              )}\n\n              {/* Magic Link Login Method */}\n              <div className=\"flex items-center justify-between p-3 rounded-lg border\" data-testid=\"connected-account-magic-link\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center\">\n                    <Mail className=\"w-5 h-5 text-blue-500\" />\n                  </div>\n                  <div>\n                    <p className=\"font-medium\">Magic Link</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {magicLinkEnabled ? \"Sign in with email link enabled\" : \"Sign in with email link disabled\"}\n                    </p>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  {togglingMagicLink ? (\n                    <Loader2 className=\"w-4 h-4 animate-spin\" />\n                  ) : (\n                    <Switch\n                      checked={magicLinkEnabled}\n                      onCheckedChange={handleToggleMagicLink}\n                      className=\"data-[state=checked]:bg-blue-500\"\n                      data-testid=\"switch-magic-link\"\n                    />\n                  )}\n                </div>\n              </div>\n\n              {/* Google Login Method */}\n              <div className={`flex items-center justify-between p-3 rounded-lg border ${!isGoogleConnected ? 'opacity-80' : ''}`} data-testid=\"connected-account-google\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center\">\n                    <SiGoogle className=\"w-5 h-5 text-red-500\" />\n                  </div>\n                  <div>\n                    <p className=\"font-medium\">Google</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {isGoogleConnected ? \"Connected\" : \"Not connected\"}\n                    </p>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  {isGoogleConnected ? (\n                    <>\n                      <Check className=\"w-5 h-5 text-green-500\" />\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={handleUnlinkGoogle}\n                        disabled={unlinkingGoogle}\n                        data-testid=\"button-unlink-google\"\n                      >\n                        {unlinkingGoogle ? (\n                          <Loader2 className=\"w-4 h-4 animate-spin\" />\n                        ) : (\n                          \"Unlink\"\n                        )}\n                      </Button>\n                    </>\n                  ) : (\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={async () => {\n                        try {\n                          // If identity already exists in Supabase (user unlinked previously),\n                          // just update the database - no need to re-authorize\n                          if (googleIdentity) {\n                            const session = await supabase.auth.getSession();\n                            if (session.data.session) {\n                              const response = await fetch('/api/auth/profile/oauth-linked', {\n                                method: 'POST',\n                                headers: {\n                                  'Content-Type': 'application/json',\n                                  'Authorization': `Bearer ${session.data.session.access_token}`,\n                                },\n                                body: JSON.stringify({ provider: 'google', linked: true }),\n                              });\n                              \n                              if (response.ok) {\n                                setIsGoogleConnected(true);\n                                queryClient.invalidateQueries({ queryKey: ['/api/auth/profile'] });\n                                toast({\n                                  title: \"Google connected\",\n                                  description: \"Google sign-in is now enabled for your account.\",\n                                });\n                              } else {\n                                throw new Error('Failed to update profile');\n                              }\n                            }\n                          } else {\n                            // No identity exists - need to authorize with Google\n                            const { error } = await supabase.auth.linkIdentity({\n                              provider: \"google\",\n                              options: {\n                                redirectTo: window.location.origin,\n                              },\n                            });\n                            if (error) {\n                              toast({\n                                title: \"Error\",\n                                description: error.message,\n                                variant: \"destructive\",\n                              });\n                            }\n                          }\n                        } catch (error: any) {\n                          toast({\n                            title: \"Error\",\n                            description: error.message || \"Failed to connect Google\",\n                            variant: \"destructive\",\n                          });\n                        }\n                      }}\n                      data-testid=\"button-connect-google\"\n                    >\n                      <Plus className=\"w-4 h-4 mr-1\" />\n                      Connect\n                    </Button>\n                  )}\n                </div>\n              </div>\n\n              {/* Apple Login Method */}\n              <div className={`flex items-center justify-between p-3 rounded-lg border ${!isAppleConnected ? 'opacity-60' : ''}`} data-testid=\"connected-account-apple\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"w-10 h-10 rounded-full bg-gray-800/10 dark:bg-gray-200/10 flex items-center justify-center\">\n                    <SiApple className=\"w-5 h-5 text-gray-800 dark:text-gray-200\" />\n                  </div>\n                  <div>\n                    <p className=\"font-medium\">Apple</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {isAppleConnected ? \"Connected\" : \"Coming soon\"}\n                    </p>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  {isAppleConnected ? (\n                    <>\n                      <Check className=\"w-5 h-5 text-green-500\" />\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={handleUnlinkApple}\n                        disabled={unlinkingApple}\n                        data-testid=\"button-unlink-apple\"\n                      >\n                        {unlinkingApple ? (\n                          <Loader2 className=\"w-4 h-4 animate-spin\" />\n                        ) : (\n                          \"Unlink\"\n                        )}\n                      </Button>\n                    </>\n                  ) : (\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      disabled\n                      data-testid=\"button-connect-apple\"\n                    >\n                      <Plus className=\"w-4 h-4 mr-1\" />\n                      Connect\n                    </Button>\n                  )}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n      </div>\n\n      {/* Region Change Confirmation Dialog */}\n      <AlertDialog open={showRegionConfirm} onOpenChange={setShowRegionConfirm}>\n        <AlertDialogContent data-testid=\"alert-region-confirm\">\n          <AlertDialogHeader>\n            <AlertDialogTitle>Change Region?</AlertDialogTitle>\n            <AlertDialogDescription>\n              Changing your region will change the puzzles you see going forward. Your past game history will not be affected.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel onClick={handleCancelRegionChange} data-testid=\"button-cancel-region-change\">\n              Cancel\n            </AlertDialogCancel>\n            <AlertDialogAction onClick={handleConfirmRegionChange} data-testid=\"button-confirm-region-change\">\n              Confirm\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Location Restriction Popup */}\n      <AlertDialog open={showRestrictionPopup} onOpenChange={setShowRestrictionPopup}>\n        <AlertDialogContent data-testid=\"alert-location-restriction\">\n          <AlertDialogHeader>\n            <AlertDialogTitle>Change Not Allowed</AlertDialogTitle>\n            <AlertDialogDescription>\n              {restrictionMessage}\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogAction \n              onClick={() => setShowRestrictionPopup(false)} \n              data-testid=\"button-dismiss-restriction\"\n            >\n              OK\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Postcode not supported dialog */}\n      <AlertDialog open={showPostcodeInvalidDialog} onOpenChange={setShowPostcodeInvalidDialog}>\n        <AlertDialogContent data-testid=\"alert-postcode-invalid\">\n          <AlertDialogHeader>\n            <AlertDialogTitle>Postcode Not Supported</AlertDialogTitle>\n            <AlertDialogDescription>\n              Unfortunately this postcode is not currently supported for location based questions. Please try another postcode or leave the postcode blank to have Hammie generate your personalised questions for you.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogAction \n              onClick={() => setShowPostcodeInvalidDialog(false)}\n              data-testid=\"button-ok-postcode-invalid\"\n            >\n              OK\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":59322,"size_tokens":null},"client/src/components/StreakCelebrationPopup.tsx":{"content":"import { useEffect } from \"react\";\nimport streakHamster from \"@assets/Streak-Hamster-Black.svg\";\nimport streakHamsterLocal from \"@assets/Streak-Hamster-Local.svg\";\nimport { soundManager } from \"@/lib/sounds\";\nimport { motion } from \"framer-motion\";\nimport { pageVariants, pageTransition } from \"@/lib/pageAnimations\";\n\ninterface StreakCelebrationPopupProps {\n  streak: number;\n  onDismiss: () => void;\n}\n\nexport function StreakCelebrationPopup({ streak, onDismiss }: StreakCelebrationPopupProps) {\n  useEffect(() => {\n    // Play streak sound when popup appears\n    soundManager.playStreak();\n    \n    const timer = setTimeout(() => {\n      onDismiss();\n    }, 5000);\n\n    return () => clearTimeout(timer);\n  }, [onDismiss]);\n\n  return (\n    <motion.div\n      className=\"fixed inset-0 z-50 flex items-center justify-center bg-black backdrop-blur-sm\"\n      onClick={onDismiss}\n      data-testid=\"streak-celebration-overlay\"\n      initial={pageVariants.fadeIn.initial}\n      animate={pageVariants.fadeIn.animate}\n      exit={pageVariants.fadeIn.exit}\n      transition={pageTransition}\n    >\n      <div\n        className=\"cursor-pointer p-8 max-w-sm w-full mx-4 text-center\"\n        onClick={onDismiss}\n        data-testid=\"streak-celebration-card\"\n      >\n        <div className=\"flex flex-col items-center gap-6\">\n          <div className=\"relative w-64 h-64 flex items-center justify-center\">\n            <img\n              src={streakHamster}\n              alt=\"Streak hamster\"\n              className=\"w-full h-full object-contain\"\n            />\n            <div\n              className=\"absolute inset-0 flex items-center justify-center\"\n              style={{ top: \"50%\" }}\n            >\n              <span\n                className={`font-bold text-red-600 drop-shadow-lg leading-none ${\n                  String(streak).length === 1\n                    ? \"text-6xl\"\n                    : String(streak).length === 2\n                    ? \"text-5xl\"\n                    : \"text-4xl\"\n                }`}\n                data-testid=\"text-streak-number\"\n              >\n                {streak}\n              </span>\n            </div>\n\n          </div>\n          \n          <div className=\"text-white\">\n            <h3 className=\"text-2xl font-bold mb-2\" data-testid=\"text-streak-title\">\n              {streak === 1 ? \"Streak Started!\" : \"Streak Continues!\"}\n            </h3>\n            <p className=\"text-lg text-white/80\" data-testid=\"text-streak-message\">\n              {streak === 1 \n                ? \"Keep playing to build your streak!\" \n                : `${streak} days in a row! Keep it up!`}\n            </p>\n          </div>\n\n          <p className=\"text-sm text-white/60 mt-2\">\n            Click anywhere to dismiss\n          </p>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":2804,"size_tokens":null},"client/src/components/PrivacyPage.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { ChevronLeft } from \"lucide-react\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { useProfile } from \"@/hooks/useProfile\";\nimport { useState } from \"react\";\nimport { useAdBannerActive } from \"@/components/AdBanner\";\n\ninterface PrivacyPageProps {\n  onBack: () => void;\n}\n\nexport function PrivacyPage({ onBack }: PrivacyPageProps) {\n  const { profile, isLoading, updateProfile } = useProfile();\n  const [saving, setSaving] = useState(false);\n  const adBannerActive = useAdBannerActive();\n\n  const handleAdsConsentChange = async (\n    e: React.ChangeEvent<HTMLInputElement>\n  ) => {\n    setSaving(true);\n    try {\n      await updateProfile({ adsConsent: e.target.checked });\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  return (\n    <div className={`min-h-screen flex flex-col p-4 bg-background ${adBannerActive ? 'pb-[50px]' : ''}`}>\n      <div className=\"flex items-center justify-between mb-6\">\n        <button\n          onClick={onBack}\n          data-testid=\"button-back-from-privacy\"\n          className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n        >\n          <ChevronLeft className=\"h-9 w-9 text-gray-700\" />\n        </button>\n\n        <div className=\"flex flex-col items-center\">\n          <h1 className=\"text-4xl font-bold\">Privacy Policy</h1>\n        </div>\n\n        {/* Spacer to balance layout */}\n        <div className=\"w-14\" />\n      </div>\n\n      <ScrollArea className=\"flex-1\">\n        <Card className=\"max-w-4xl mx-auto\">\n          <CardHeader>\n            <CardTitle>Privacy Policy for Elementle</CardTitle>\n            <p className=\"text-sm text-muted-foreground\">\n              Last updated: October 2025\n            </p>\n          </CardHeader>\n          <CardContent className=\"space-y-6 prose dark:prose-invert max-w-none\">\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">\n                1. Information We Collect\n              </h2>\n              <p>\n                When you create an account, we collect the following information\n                as part of providing the game service:\n              </p>\n              <ul className=\"list-disc pl-6 space-y-1\">\n                <li>Email address</li>\n                <li>First and last name</li>\n                <li>\n                  Game progress and guess data (including your daily guesses,\n                  streaks, and statistics)\n                </li>\n              </ul>\n              <p>\n                We may also collect optional information if you provide consent\n                (see Section 4).\n              </p>\n            </section>\n\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">\n                2. How We Use Your Information\n              </h2>\n              <p>We use your information to:</p>\n              <ul className=\"list-disc pl-6 space-y-1\">\n                <li>Provide and maintain the Elementle game service</li>\n                <li>\n                  Track your game progress, guesses, and statistics to power\n                  features such as streaks and leaderboards\n                </li>\n                <li>\n                  Send important service updates (e.g. account or security\n                  notifications)\n                </li>\n              </ul>\n            </section>\n\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">3. Data Storage</h2>\n              <p>\n                Your data is securely stored using Supabase, a trusted database\n                platform. We retain your data only as long as necessary to\n                provide the service or comply with legal obligations.\n              </p>\n            </section>\n\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">\n                4. Optional Data Use (Consent-Based)\n              </h2>\n              <p>\n                With your explicit consent, we may also use your data to tailor\n                advertising and promotional content to your interests. This\n                consent is optional and not required to play the game. You can\n                withdraw consent at any time in the apps Settings.\n              </p>\n            </section>\n\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">5. Data Sharing</h2>\n              <p>\n                We do not sell, trade, or otherwise transfer your personal\n                information to third parties. Your game statistics may be\n                aggregated and anonymised for global leaderboards. Advertising\n                partners will only receive data if you have explicitly opted in\n                under Section 4.\n              </p>\n            </section>\n\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">6. Your Rights</h2>\n              <p>Under GDPR and UK GDPR, you have the right to:</p>\n              <ul className=\"list-disc pl-6 space-y-1\">\n                <li>Access your personal data</li>\n                <li>Request correction of inaccurate data</li>\n                <li>Request deletion of your account and associated data</li>\n                <li>Withdraw consent for optional data uses at any time</li>\n              </ul>\n            </section>\n\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">7. Contact Us</h2>\n              <p>\n                If you have questions about this Privacy Policy or your data\n                rights, please contact us through the Feedback section in\n                Settings.\n              </p>\n            </section>\n\n            {/*  Ads consent toggle */}\n            <section className=\"mt-8 border-t pt-4\">\n              <label className=\"flex items-center gap-2\">\n                <input\n                  type=\"checkbox\"\n                  checked={profile?.adsConsent ?? false}\n                  onChange={handleAdsConsentChange}\n                  disabled={saving}\n                />\n                <span>\n                  I consent to my data being used to tailor ads.{\" \"}\n                  <strong>\n                    If you do not consent, your ads will not be tailored.\n                  </strong>\n                </span>\n              </label>\n            </section>\n          </CardContent>\n        </Card>\n      </ScrollArea>\n    </div>\n  );\n}\n","path":null,"size_bytes":6482,"size_tokens":null},"client/src/hooks/useGameData.ts":{"content":"import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useAuth } from \"./useAuth\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useSupabase } from \"@/lib/SupabaseProvider\";\nimport { useGameMode } from \"@/contexts/GameModeContext\";\nimport type { GameAttempt, Guess } from \"@shared/schema\";\n\ninterface CreateGameAttemptData {\n  puzzleId: number;\n  result?: string;\n  numGuesses?: number;\n}\n\ninterface CreateGuessData {\n  gameAttemptId: number;\n  guessValue: string;\n  feedbackResult: any;\n}\n\ninterface UpdateGameAttemptData {\n  id: number;\n  result: string;\n  numGuesses: number;\n}\n\ninterface UseGameDataOptions {\n  modeOverride?: 'global' | 'local'; // Override context mode when specified\n}\n\nexport function useGameData(options?: UseGameDataOptions) {\n  const { user, isAuthenticated } = useAuth();\n  const queryClient = useQueryClient();\n  const supabase = useSupabase();\n  const { isLocalMode: contextIsLocalMode } = useGameMode();\n  \n  // Use mode override if provided, otherwise fall back to context mode\n  const isLocalMode = options?.modeOverride \n    ? options.modeOverride === 'local' \n    : contextIsLocalMode;\n\n  // Get all game attempts for the current user (mode-aware)\n  const endpoint = isLocalMode ? \"/api/user/game-attempts/user\" : \"/api/game-attempts/user\";\n  const { data: gameAttempts, isLoading: loadingAttempts } = useQuery<GameAttempt[]>({\n    queryKey: [endpoint],\n    enabled: isAuthenticated,\n    staleTime: 30000, // Consider data stale after 30 seconds\n    refetchOnMount: true, // Refetch when Archive mounts but respect staleTime\n  });\n\n  // Create a new game attempt (mode-aware)\n  const createGameAttempt = useMutation({\n    mutationFn: async (data: CreateGameAttemptData) => {\n      const createEndpoint = isLocalMode ? \"/api/user/game-attempts\" : \"/api/game-attempts\";\n      const response = await apiRequest(\"POST\", createEndpoint, data);\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [endpoint] });\n    },\n  });\n\n  // Update an existing game attempt (when completing, mode-aware)\n  const updateGameAttempt = useMutation({\n    mutationFn: async (data: UpdateGameAttemptData) => {\n      const updateEndpoint = isLocalMode ? `/api/user/game-attempts/${data.id}` : `/api/game-attempts/${data.id}`;\n      const response = await apiRequest(\"PATCH\", updateEndpoint, {\n        result: data.result,\n        numGuesses: data.numGuesses,\n      });\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [endpoint] });\n    },\n  });\n\n  // Create a guess (mode-aware)\n  const createGuess = useMutation({\n    mutationFn: async (data: CreateGuessData) => {\n      const guessEndpoint = isLocalMode ? \"/api/user/guesses\" : \"/api/guesses\";\n      const response = await apiRequest(\"POST\", guessEndpoint, data);\n      return await response.json();\n    },\n    onSuccess: () => {\n      // Invalidate both caches:\n      // - game attempts cache (for updated numGuesses count)\n      // - all guesses cache (for updated guess data)\n      // This ensures Archive page shows updated status and guess counts\n      const allGuessesEndpoint = isLocalMode ? \"/api/user/guesses/all\" : \"/api/guesses/all\";\n      queryClient.invalidateQueries({ queryKey: [endpoint] });\n      queryClient.invalidateQueries({ queryKey: [allGuessesEndpoint] });\n    },\n  });\n\n  // Get guesses for a specific game attempt (mode-aware)\n  const getGuessesByAttempt = async (gameAttemptId: number): Promise<Guess[]> => {\n    if (!isAuthenticated) {\n      return [];\n    }\n    try {\n      // Always refresh the session to get a fresh token\n      const { data: { session }, error: sessionError } = await supabase.auth.refreshSession();\n      if (sessionError || !session?.access_token) {\n        console.error(\"[getGuessesByAttempt] No valid session:\", sessionError);\n        return [];\n      }\n\n      const guessesEndpoint = isLocalMode ? `/api/user/guesses/${gameAttemptId}` : `/api/guesses/${gameAttemptId}`;\n      const response = await fetch(guessesEndpoint, {\n        headers: {\n          \"Authorization\": `Bearer ${session.access_token}`,\n        },\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(\"[getGuessesByAttempt] Request failed:\", response.status, errorText);\n        return [];\n      }\n\n      const data = await response.json();\n      console.log(\"[getGuessesByAttempt] Loaded guesses:\", data.length);\n      return data;\n    } catch (error) {\n      console.error(\"[getGuessesByAttempt] Error fetching guesses:\", error);\n      return [];\n    }\n  };\n\n  const getAllGuesses = async (): Promise<Array<Guess & { puzzleId: number; result: string | null; categoryName?: string | null }>> => {\n    console.log(\"[getAllGuesses] Called, isAuthenticated:\", isAuthenticated, \"isLocalMode:\", isLocalMode);\n    try {\n      const allGuessesEndpoint = isLocalMode ? \"/api/user/guesses/all\" : \"/api/guesses/all\";\n      console.log(\"[getAllGuesses] Fetching from\", allGuessesEndpoint);\n      const response = await apiRequest(\"GET\", allGuessesEndpoint);\n      console.log(\"[getAllGuesses] Response status:\", response.status);\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(\"[getAllGuesses] Request failed:\", response.status, errorText);\n        return [];\n      }\n      const data = await response.json();\n      console.log(\"[getAllGuesses] Fetched\", data.length, \"guesses\");\n      // Backend now includes categoryName when available\n      return data as Array<Guess & { puzzleId: number; result: string | null; categoryName?: string | null }>;\n    } catch (error) {\n      console.error(\"[getAllGuesses] Error fetching guesses:\", error);\n      return [];\n    }\n  };\n\n\n  // Check if a puzzle is completed by the user\n  const isPuzzleCompleted = (puzzleId: number): GameAttempt | undefined => {\n    if (!gameAttempts) return undefined;\n    return gameAttempts.find(\n      (attempt) => attempt.puzzleId === puzzleId && attempt.result !== null\n    );\n  };\n\n  // Get in-progress attempt for a puzzle\n  const getInProgressAttempt = (puzzleId: number): GameAttempt | undefined => {\n    if (!gameAttempts) return undefined;\n    return gameAttempts.find(\n      (attempt) => attempt.puzzleId === puzzleId && attempt.result === null\n    );\n  };\n\n  return {\n    gameAttempts,\n    loadingAttempts,\n    createGameAttempt: createGameAttempt.mutateAsync,\n    updateGameAttempt: updateGameAttempt.mutateAsync,\n    createGuess: createGuess.mutateAsync,\n    getGuessesByAttempt,\n    getAllGuesses,\n    isPuzzleCompleted,\n    getInProgressAttempt,\n    isCreatingAttempt: createGameAttempt.isPending,\n    isCreatingGuess: createGuess.isPending,\n  };\n}\n","path":null,"size_bytes":6786,"size_tokens":null},"client/src/hooks/useUserSettings.ts":{"content":"import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useEffect } from \"react\";\nimport { useAuth } from \"./useAuth\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport type { UserSettings } from \"@shared/schema\";\nimport { setCachedDigitPreference, setCachedUseRegionDefault, setCachedDateFormatPreference } from \"@/lib/formatCache\";\n\ninterface UpdateUserSettingsData {\n  textSize?: string;\n  soundsEnabled?: boolean;\n  darkMode?: boolean;\n  cluesEnabled?: boolean;\n  dateFormatPreference?: string;\n  useRegionDefault?: boolean;\n  digitPreference?: string;\n  categoryPreferences?: any;\n}\n\nexport function useUserSettings() {\n  const { isAuthenticated } = useAuth();\n  const queryClient = useQueryClient();\n\n  // Get user settings\n  const { data: settings, isLoading } = useQuery<UserSettings>({\n    queryKey: [\"/api/settings\"],\n    enabled: isAuthenticated,\n  });\n\n  // Sync settings to localStorage cache when they load/change\n  useEffect(() => {\n    if (settings) {\n      if (settings.digitPreference) {\n        setCachedDigitPreference(settings.digitPreference as '6' | '8');\n      }\n      if (settings.useRegionDefault !== null && settings.useRegionDefault !== undefined) {\n        setCachedUseRegionDefault(settings.useRegionDefault);\n      }\n      if (settings.dateFormatPreference) {\n        setCachedDateFormatPreference(settings.dateFormatPreference);\n      }\n    }\n  }, [settings?.digitPreference, settings?.useRegionDefault, settings?.dateFormatPreference]);\n\n  // Update user settings\n  const updateSettings = useMutation({\n    mutationFn: async (data: UpdateUserSettingsData) => {\n      const response = await apiRequest(\"POST\", \"/api/settings\", data);\n      return await response.json();\n    },\n    onSuccess: (data) => {\n      // Update cache immediately with new settings\n      if (data.digitPreference) {\n        setCachedDigitPreference(data.digitPreference as '6' | '8');\n      }\n      if (data.useRegionDefault !== null && data.useRegionDefault !== undefined) {\n        setCachedUseRegionDefault(data.useRegionDefault);\n      }\n      if (data.dateFormatPreference) {\n        setCachedDateFormatPreference(data.dateFormatPreference);\n      }\n      queryClient.invalidateQueries({ queryKey: [\"/api/settings\"] });\n    },\n  });\n\n  return {\n    settings,\n    isLoading,\n    updateSettings: updateSettings.mutateAsync,\n    isUpdating: updateSettings.isPending,\n  };\n}\n","path":null,"size_bytes":2419,"size_tokens":null},"client/src/hooks/useUserStats.ts":{"content":"import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useAuth } from \"./useAuth\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useGameMode } from \"@/contexts/GameModeContext\";\nimport type { UserStats } from \"@shared/schema\";\n\ninterface UpdateUserStatsData {\n  gamesPlayed?: number;\n  gamesWon?: number;\n  currentStreak?: number;\n  maxStreak?: number;\n  guessDistribution?: Record<string, number>;\n}\n\nexport function useUserStats() {\n  const { isAuthenticated } = useAuth();\n  const queryClient = useQueryClient();\n  const { isLocalMode } = useGameMode();\n\n  // Get user stats (mode-aware)\n  const endpoint = isLocalMode ? \"/api/user/stats\" : \"/api/stats\";\n  const { data: stats, isLoading } = useQuery<UserStats>({\n    queryKey: [endpoint],\n    enabled: isAuthenticated,\n  });\n\n  // Update user stats (mode-aware)\n  const updateStats = useMutation({\n    mutationFn: async (data: UpdateUserStatsData) => {\n      const response = await apiRequest(\"POST\", endpoint, data);\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [endpoint] });\n    },\n  });\n\n  // Increment stats after a game completion\n  const incrementStats = async (won: boolean, numGuesses: number) => {\n    if (!isAuthenticated || !stats) return;\n\n    const currentDist = stats.guessDistribution as Record<string, number> || {\n      \"1\": 0,\n      \"2\": 0,\n      \"3\": 0,\n      \"4\": 0,\n      \"5\": 0,\n    };\n\n    const newStats: UpdateUserStatsData = {\n      gamesPlayed: (stats.gamesPlayed ?? 0) + 1,\n      gamesWon: won ? (stats.gamesWon ?? 0) + 1 : (stats.gamesWon ?? 0),\n      currentStreak: won ? (stats.currentStreak ?? 0) + 1 : 0,\n      maxStreak: won\n        ? Math.max(stats.maxStreak ?? 0, (stats.currentStreak ?? 0) + 1)\n        : (stats.maxStreak ?? 0),\n      guessDistribution: won\n        ? {\n            ...currentDist,\n            [numGuesses.toString()]: (currentDist[numGuesses.toString()] || 0) + 1,\n          }\n        : currentDist,\n    };\n\n    await updateStats.mutateAsync(newStats);\n    return newStats.currentStreak;\n  };\n\n  return {\n    stats,\n    isLoading,\n    updateStats: updateStats.mutateAsync,\n    incrementStats,\n    isUpdating: updateStats.isPending,\n  };\n}\n","path":null,"size_bytes":2261,"size_tokens":null},"client/src/lib/supabaseClient.ts":{"content":"import { createClient, SupabaseClient } from '@supabase/supabase-js';\n\nlet supabaseInstance: SupabaseClient | null = null;\nlet initPromise: Promise<SupabaseClient> | null = null;\n\nexport async function getSupabaseClient(): Promise<SupabaseClient> {\n  // Return existing instance if already initialized\n  if (supabaseInstance) {\n    return supabaseInstance;\n  }\n\n  // Return the same promise if initialization is in progress\n  if (initPromise) {\n    return initPromise;\n  }\n\n  // Start initialization and memoize the promise\n  initPromise = (async () => {\n    const response = await fetch('/api/supabase-config');\n    if (!response.ok) {\n      throw new Error('Failed to fetch Supabase configuration');\n    }\n\n    const config = await response.json();\n    supabaseInstance = createClient(config.url, config.anonKey, {\n      auth: {\n        persistSession: true,\n        autoRefreshToken: true,\n        detectSessionInUrl: true, // Critical for consuming magic link tokens from URL fragment\n      },\n    });\n\n    //  TEMP: log the current session's access token for testing\n    try {\n      const { data: { session }, error } = await supabaseInstance.auth.getSession();\n      if (error) {\n        console.warn('Error fetching session:', error.message);\n      } else if (session?.access_token) {\n        console.log('User access token:', session.access_token);\n      } else {\n        console.log('No active session found');\n      }\n    } catch (e) {\n      console.warn('Failed to get session:', e);\n    }\n\n    return supabaseInstance;\n  })();\n\n  return initPromise;\n}\n","path":null,"size_bytes":1568,"size_tokens":null},"client/src/hooks/useProfile.ts":{"content":"import { useQuery, useQueryClient, useMutation } from \"@tanstack/react-query\";\nimport { useEffect } from \"react\";\nimport { useAuth } from \"./useAuth\";\nimport { getSupabaseClient } from \"@/lib/supabaseClient\";\nimport type { UserProfile } from \"@shared/schema\";\nimport { setCachedRegion } from \"@/lib/formatCache\";\nimport { writeLocal, readLocal, CACHE_KEYS } from \"@/lib/localCache\";\n\n// Helper to PATCH profile\nasync function patchProfile(updates: Partial<UserProfile>): Promise<UserProfile> {\n  const supabase = await getSupabaseClient();\n  const { data: { session } } = await supabase.auth.getSession();\n  \n  if (!session?.access_token) {\n    console.error(\"[patchProfile] No valid session\");\n    throw new Error(\"Not authenticated\");\n  }\n\n  console.log(\"[patchProfile] Sending PATCH with body:\", updates);\n  \n  const res = await fetch(\"/api/auth/profile\", {\n    method: \"PATCH\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"Authorization\": `Bearer ${session.access_token}`,\n    },\n    body: JSON.stringify(updates),\n  });\n  \n  console.log(\"[patchProfile] Response status:\", res.status);\n  \n  if (!res.ok) {\n    const errorText = await res.text();\n    console.error(\"[patchProfile] Request failed:\", res.status, errorText);\n    throw new Error(\"Failed to update profile\");\n  }\n  \n  const data = await res.json();\n  console.log(\"[patchProfile] Response body:\", data);\n  return data;\n}\n\nexport function useProfile() {\n  const { isAuthenticated } = useAuth();\n  const queryClient = useQueryClient();\n\n  // Invalidate profile query when auth state changes\n  useEffect(() => {\n    if (!isAuthenticated) {\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/profile\"] });\n      queryClient.removeQueries({ queryKey: [\"/api/auth/profile\"] });\n    }\n  }, [isAuthenticated, queryClient]);\n\n  // Read cached profile for instant availability of isAdmin and region\n  const cachedProfile = readLocal<UserProfile>(CACHE_KEYS.PROFILE);\n\n  const { data: profile, isLoading } = useQuery<UserProfile>({\n    queryKey: [\"/api/auth/profile\"],\n    enabled: isAuthenticated,\n    initialData: isAuthenticated ? cachedProfile ?? undefined : undefined,\n    staleTime: 5 * 60 * 1000, // Consider data fresh for 5 minutes\n  });\n\n  // Sync profile to localStorage cache when it loads/changes\n  useEffect(() => {\n    if (profile) {\n      // Cache full profile for instant access on next page load\n      writeLocal(CACHE_KEYS.PROFILE, profile);\n      // Also update region in format cache\n      if (profile.region) {\n        setCachedRegion(profile.region);\n      }\n    }\n  }, [profile]);\n\n  // Mutation for updates\n  const mutation = useMutation({\n    mutationFn: patchProfile,\n    onSuccess: (data) => {\n      // Update localStorage cache immediately with updated profile\n      writeLocal(CACHE_KEYS.PROFILE, data);\n      // Also update region in format cache\n      if (data.region) {\n        setCachedRegion(data.region);\n      }\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/profile\"] });\n    },\n  });\n\n  return {\n    profile,\n    isLoading,\n    updateProfile: mutation.mutateAsync, //  now available\n  };\n}\n","path":null,"size_bytes":3127,"size_tokens":null},"client/src/contexts/GuessCacheContext.tsx":{"content":"import { createContext, useContext, useState, useEffect, useCallback } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useSupabase } from \"@/lib/SupabaseProvider\";\nimport type { Guess } from \"@shared/schema\";\n\n// Cache keys now include mode prefix to prevent cross-contamination\n// Format: \"global:123\" or \"local:456\"\ninterface GuessCache {\n  [modeAndPuzzleId: string]: Guess[];\n}\n\ninterface GuessCacheContextValue {\n  getGuessesForPuzzle: (puzzleId: number, mode: 'global' | 'local') => Guess[] | null;\n  setGuessesForPuzzle: (puzzleId: number, mode: 'global' | 'local', guesses: Guess[]) => void;\n  refreshRecentGuesses: (mode: 'global' | 'local') => Promise<void>;\n  isLoading: boolean;\n  addGuessToCache: (puzzleId: number, mode: 'global' | 'local', guess: Guess) => void;\n}\n\nconst GuessCacheContext = createContext<GuessCacheContextValue | undefined>(undefined);\n\n// Helper to create mode-prefixed cache key\nconst makeCacheKey = (mode: 'global' | 'local', puzzleId: number): string => `${mode}:${puzzleId}`;\n\nexport function GuessCacheProvider({ children }: { children: React.ReactNode }) {\n  const { user, isAuthenticated } = useAuth();\n  const supabase = useSupabase();\n  const [cache, setCache] = useState<GuessCache>({});\n  const [isLoading, setIsLoading] = useState(false);\n\n  // Fetch recent guesses (last 30 days) from Supabase - MODE AWARE\n  const fetchRecentGuesses = useCallback(async (mode: 'global' | 'local' = 'global') => {\n    if (!isAuthenticated || !user?.id) return;\n\n    setIsLoading(true);\n    try {\n      const thirtyDaysAgo = new Date();\n      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\n      const dateString = thirtyDaysAgo.toISOString().split(\"T\")[0];\n\n      // Get Supabase session token\n      const { data: { session } } = await supabase.auth.getSession();\n      \n      if (!session?.access_token) {\n        console.error(\"No access token available\");\n        setIsLoading(false);\n        return;\n      }\n\n      // Use mode-specific endpoint\n      const endpoint = mode === 'local' \n        ? `/api/user/guesses/recent?since=${dateString}`\n        : `/api/guesses/recent?since=${dateString}`;\n        \n      console.log(`[GuessCacheContext] Fetching from ${endpoint} for mode: ${mode}`);\n\n      const response = await fetch(endpoint, {\n        credentials: \"include\",\n        headers: {\n          \"Authorization\": `Bearer ${session.access_token}`,\n        },\n      });\n\n      if (!response.ok) {\n        if (response.status !== 401) {\n          console.error(\"Failed to fetch recent guesses:\", response.status);\n        }\n        return;\n      }\n\n      const guesses: Guess[] = await response.json();\n      console.log(`[GuessCacheContext] Fetched ${guesses.length} guesses for ${mode} mode`);\n\n      // Update cache with mode-prefixed keys (merge with existing, don't replace all)\n      setCache((prev) => {\n        const newCache = { ...prev };\n        for (const guess of guesses) {\n          const puzzleId = (guess as any).puzzleId;\n          if (!puzzleId) {\n            console.warn(\"Guess missing puzzleId:\", guess);\n            continue;\n          }\n          const key = makeCacheKey(mode, puzzleId);\n          if (!newCache[key]) newCache[key] = [];\n          // Check if this guess is already in the cache (by id)\n          if (!newCache[key].some(g => g.id === guess.id)) {\n            newCache[key].push(guess);\n          }\n        }\n        \n        // Persist to localStorage\n        if (user) {\n          try {\n            localStorage.setItem(`guess-cache-${user.id}`, JSON.stringify(newCache));\n          } catch (e) {\n            console.warn(\"Failed to persist cache to localStorage\", e);\n          }\n        }\n        \n        return newCache;\n      });\n    } catch (error) {\n      console.error(\"Error fetching recent guesses:\", error);\n    } finally {\n      setIsLoading(false);\n    }\n  }, [isAuthenticated, user, supabase]);\n\n  // On login: clear cache first, then load from localStorage, then fetch fresh for both modes\n  useEffect(() => {\n    if (isAuthenticated && user?.id) {\n      setCache({}); // clear stale data immediately\n\n      try {\n        const stored = localStorage.getItem(`guess-cache-${user.id}`);\n        if (stored) {\n          setCache(JSON.parse(stored));\n        }\n      } catch (e) {\n        console.warn(\"Failed to load cache from localStorage\", e);\n      }\n\n      // Fetch for both modes on login\n      fetchRecentGuesses('global');\n      fetchRecentGuesses('local');\n    }\n  }, [isAuthenticated, user, fetchRecentGuesses]);\n\n  // On logout: clear cache and localStorage\n  useEffect(() => {\n    if (!isAuthenticated) {\n      setCache({});\n      try {\n        Object.keys(localStorage).forEach((key) => {\n          if (key.startsWith(\"guess-cache-\")) {\n            localStorage.removeItem(key);\n          }\n        });\n      } catch (e) {\n        console.warn(\"Failed to clear cache from localStorage\", e);\n      }\n    }\n  }, [isAuthenticated]);\n\n  // Mode-aware getGuessesForPuzzle\n  const getGuessesForPuzzle = useCallback(\n    (puzzleId: number, mode: 'global' | 'local'): Guess[] | null => {\n      const key = makeCacheKey(mode, puzzleId);\n      return cache[key] || null;\n    },\n    [cache]\n  );\n\n  // Mode-aware setGuessesForPuzzle\n  const setGuessesForPuzzle = useCallback(\n    (puzzleId: number, mode: 'global' | 'local', guesses: Guess[]) => {\n      const key = makeCacheKey(mode, puzzleId);\n      setCache((prev) => {\n        const newCache = { ...prev, [key]: guesses };\n        if (user) {\n          try {\n            localStorage.setItem(`guess-cache-${user.id}`, JSON.stringify(newCache));\n          } catch (e) {\n            console.warn(\"Failed to persist cache to localStorage\", e);\n          }\n        }\n        return newCache;\n      });\n    },\n    [user]\n  );\n\n  // Mode-aware addGuessToCache\n  const addGuessToCache = useCallback(\n    (puzzleId: number, mode: 'global' | 'local', guess: Guess) => {\n      const key = makeCacheKey(mode, puzzleId);\n      setCache((prev) => {\n        const existing = prev[key] || [];\n        const newCache = { ...prev, [key]: [...existing, guess] };\n        if (user) {\n          try {\n            localStorage.setItem(`guess-cache-${user.id}`, JSON.stringify(newCache));\n          } catch (e) {\n            console.warn(\"Failed to persist cache to localStorage\", e);\n          }\n        }\n        return newCache;\n      });\n    },\n    [user]\n  );\n\n  // Mode-aware refreshRecentGuesses\n  const refreshRecentGuesses = useCallback(async (mode: 'global' | 'local') => {\n    await fetchRecentGuesses(mode);\n  }, [fetchRecentGuesses]);\n\n  return (\n    <GuessCacheContext.Provider\n      value={{\n        getGuessesForPuzzle,\n        setGuessesForPuzzle,\n        refreshRecentGuesses,\n        isLoading,\n        addGuessToCache,\n      }}\n    >\n      {children}\n    </GuessCacheContext.Provider>\n  );\n}\n\nexport function useGuessCache() {\n  const context = useContext(GuessCacheContext);\n  if (!context) {\n    throw new Error(\"useGuessCache must be used within a GuessCacheProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":7064,"size_tokens":null},"client/src/components/AboutPage.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { ArrowLeft, ChevronLeft } from \"lucide-react\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { useAdBannerActive } from \"@/components/AdBanner\";\n\ninterface AboutPageProps {\n  onBack: () => void;\n}\n\nexport function AboutPage({ onBack }: AboutPageProps) {\n  const adBannerActive = useAdBannerActive();\n  \n  return (\n    <div className={`min-h-screen flex flex-col p-4 bg-background ${adBannerActive ? 'pb-[50px]' : ''}`}>\n      <div className=\"flex items-center justify-between mb-6\">\n        <button\n          onClick={onBack}\n          data-testid=\"button-back-from-about\"\n          className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n        >\n          <ChevronLeft className=\"h-9 w-9 text-gray-700\" />\n        </button>\n\n        <div className=\"flex flex-col items-center\">\n          <h1 className=\"text-4xl font-bold\">About</h1>\n        </div>\n\n        {/* Spacer to balance layout */}\n        <div className=\"w-14\" />\n      </div>\n\n\n      <ScrollArea className=\"flex-1\">\n        <Card className=\"max-w-4xl mx-auto\">\n          <CardHeader>\n            <CardTitle>About Elementle</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6 prose dark:prose-invert max-w-none\">\n            <section>\n              <p>\n                Elementle is a daily historical date puzzle game. Each day, you're challenged to pin down the exact date of a key event from history. You'll make guesses, get feedback, and refine your answer until you land on the correct date  or run out of tries.\n              </p>\n            </section>\n\n            <section>\n              <p>The game blends learning with play:</p>\n              <ul className=\"list-none pl-0 space-y-2\">\n                <li> <strong>Daily Challenge</strong>  A new puzzle every day, tied to a real historical event.</li>\n                <li> <strong>Learn as you play</strong>  Each puzzle comes with event details, so you walk away knowing more than when you started.</li>\n                <li> <strong>Track your progress</strong>  Stats and streaks let you see how your knowledge (and intuition) grows over time.</li>\n                <li> <strong>Celebrate wins</strong>  Animated hamster companions cheer you on when you succeed.</li>\n              </ul>\n            </section>\n\n            <section>\n              <p>\n                Elementle is built to be fun, fair, and educational  whether you're a history buff, a casual player, or just love a good daily challenge.\n              </p>\n            </section>\n\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">Credits</h2>\n              <p>\n                Elementle was created by <strong>dobl Ltd</strong>, a team dedicated to helping people get the very best from technology in ways that feel simple, engaging, and enjoyable. The game reflects that mission  blending thoughtful design, playful interaction, and a touch of curiosity to make learning history both accessible and fun.\n              </p>\n            </section>\n\n            <section>\n              <h2 className=\"text-xl font-semibold mb-2\">Privacy</h2>\n              <p>\n                Elementle uses Supabase authentication and stores puzzle attempts to track your progress. For details on how your data is handled, please see{\" \"}\n                <a \n                  href=\"https://www.microsoft.com/en-us/privacy/privacystatement\" \n                  target=\"_blank\" \n                  rel=\"noopener noreferrer\"\n                  className=\"text-primary hover:underline\"\n                  data-testid=\"link-privacy\"\n                >\n                  Microsoft's privacy statement\n                </a>.\n              </p>\n            </section>\n          </CardContent>\n        </Card>\n      </ScrollArea>\n    </div>\n  );\n}\n","path":null,"size_bytes":4032,"size_tokens":null},"client/src/lib/localCache.ts":{"content":"/**\n * Local cache utility for storing and retrieving data from localStorage\n * with type safety and error handling\n */\n\nexport function readLocal<T>(key: string): T | null {\n  try {\n    const item = localStorage.getItem(key);\n    if (!item) return null;\n    return JSON.parse(item) as T;\n  } catch (error) {\n    console.error(`Error reading from localStorage key \"${key}\":`, error);\n    return null;\n  }\n}\n\nexport function writeLocal(key: string, value: unknown): void {\n  try {\n    localStorage.setItem(key, JSON.stringify(value));\n  } catch (error) {\n    console.error(`Error writing to localStorage key \"${key}\":`, error);\n  }\n}\n\nexport function removeLocal(key: string): void {\n  try {\n    localStorage.removeItem(key);\n  } catch (error) {\n    console.error(`Error removing from localStorage key \"${key}\":`, error);\n  }\n}\n\nexport function clearUserCache(): void {\n  // Clear all user-specific cached data on logout/login\n  // This must include ALL cache keys to prevent data leakage between users\n  const userKeys = [\n    'cached-profile',\n    'cached-settings',\n    'cached-stats',\n    'cached-attempts',\n    'cached-today-outcome',\n    'cached-percentile',\n    'cached-pro-categories',\n    'cached-categories-list',\n    'cached-subscription',\n    'cached-regions',\n    'elementle-stats',\n    'cluesEnabled',\n  ];\n  \n  userKeys.forEach(key => removeLocal(key));\n  \n  // Clear dynamic keys: archive caches, puzzle progress, guess cache, format cache, and any other cached- prefixed keys\n  try {\n    const allKeys = Object.keys(localStorage);\n    allKeys.forEach(key => {\n      // Clear cached archive data\n      if (key.startsWith('cached-archive-')) {\n        removeLocal(key);\n      }\n      // Clear in-progress puzzle data (critical for multi-user scenarios)\n      if (key.startsWith('puzzle-progress-')) {\n        removeLocal(key);\n      }\n      // Clear guess cache data\n      if (key.startsWith('guess-cache-')) {\n        removeLocal(key);\n      }\n      // Clear format cache (region/digit preferences)\n      if (key.startsWith('elementle-format-')) {\n        removeLocal(key);\n      }\n      // Clear any other cached- prefixed data that might have been missed\n      if (key.startsWith('cached-') && !userKeys.includes(key)) {\n        removeLocal(key);\n      }\n      // Clear Supabase session tokens to ensure full sign out\n      if (key.startsWith('sb-') && key.includes('-auth-token')) {\n        removeLocal(key);\n      }\n      // Clear first login tracking\n      if (key === 'elementle-first-login-completed') {\n        removeLocal(key);\n      }\n      // Clear demand call idempotency keys\n      if (key.startsWith('elementle_demand_call_')) {\n        removeLocal(key);\n      }\n    });\n  } catch (error) {\n    console.error('Error clearing user caches:', error);\n  }\n}\n\n/**\n * Clear all archive-related caches\n * Call this after holiday mode activation/deactivation to ensure\n * fresh data displays with correct holiday styling\n */\nexport function clearArchiveCache(): void {\n  try {\n    const allKeys = Object.keys(localStorage);\n    allKeys.forEach(key => {\n      if (key.startsWith('cached-archive-')) {\n        removeLocal(key);\n      }\n    });\n  } catch (error) {\n    console.error('Error clearing archive cache:', error);\n  }\n}\n\n// Cache key constants for consistency\nexport const CACHE_KEYS = {\n  SETTINGS: 'cached-settings',\n  PROFILE: 'cached-profile',\n  STATS: 'cached-stats',\n  ATTEMPTS: 'cached-attempts',\n  TODAY_OUTCOME: 'cached-today-outcome',\n  ARCHIVE_PREFIX: 'cached-archive-',\n  PERCENTILE: 'cached-percentile',\n  PRO_CATEGORIES: 'cached-pro-categories',\n  CATEGORIES_LIST: 'cached-categories-list',\n  SUBSCRIPTION: 'cached-subscription',\n  REGIONS: 'cached-regions',\n} as const;\n","path":null,"size_bytes":3713,"size_tokens":null},"client/src/lib/sounds.ts":{"content":"// Sound effects utility using Web Audio API\n\nclass SoundManager {\n  private audioContext: AudioContext | null = null;\n  private enabled: boolean = true;\n\n  constructor() {\n    if (typeof window !== 'undefined') {\n      try {\n        this.audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\n      } catch (e) {\n        console.warn('Web Audio API not supported');\n      }\n    }\n  }\n\n  private getContext(): AudioContext | null {\n    if (!this.audioContext) return null;\n    \n    // Resume context if suspended (required for some browsers)\n    if (this.audioContext.state === 'suspended') {\n      this.audioContext.resume();\n    }\n    \n    return this.audioContext;\n  }\n\n  // Subtle click sound for button presses\n  playClick() {\n    if (!this.enabled) return;\n    const ctx = this.getContext();\n    if (!ctx) return;\n\n    const oscillator = ctx.createOscillator();\n    const gainNode = ctx.createGain();\n\n    oscillator.connect(gainNode);\n    gainNode.connect(ctx.destination);\n\n    oscillator.frequency.value = 800;\n    oscillator.type = 'sine';\n\n    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);\n    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);\n\n    oscillator.start(ctx.currentTime);\n    oscillator.stop(ctx.currentTime + 0.05);\n  }\n\n  // Celebration sound for winning\n  playCelebration() {\n    if (!this.enabled) return;\n    const ctx = this.getContext();\n    if (!ctx) return;\n\n    // Play a cheerful ascending arpeggio\n    const notes = [523.25, 659.25, 783.99]; // C, E, G\n    \n    notes.forEach((freq, index) => {\n      const oscillator = ctx.createOscillator();\n      const gainNode = ctx.createGain();\n\n      oscillator.connect(gainNode);\n      gainNode.connect(ctx.destination);\n\n      oscillator.frequency.value = freq;\n      oscillator.type = 'sine';\n\n      const startTime = ctx.currentTime + (index * 0.1);\n      gainNode.gain.setValueAtTime(0.15, startTime);\n      gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);\n\n      oscillator.start(startTime);\n      oscillator.stop(startTime + 0.3);\n    });\n  }\n\n  // Commiseration sound for losing\n  playCommiseration() {\n    if (!this.enabled) return;\n    const ctx = this.getContext();\n    if (!ctx) return;\n\n    // Play a gentle descending tone\n    const oscillator = ctx.createOscillator();\n    const gainNode = ctx.createGain();\n\n    oscillator.connect(gainNode);\n    gainNode.connect(ctx.destination);\n\n    oscillator.frequency.setValueAtTime(400, ctx.currentTime);\n    oscillator.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.5);\n    oscillator.type = 'sine';\n\n    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);\n    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);\n\n    oscillator.start(ctx.currentTime);\n    oscillator.stop(ctx.currentTime + 0.5);\n  }\n\n  // Streak celebration sound\n  playStreak() {\n    if (!this.enabled) return;\n    const ctx = this.getContext();\n    if (!ctx) return;\n\n    // Play an exciting rising tone\n    const oscillator = ctx.createOscillator();\n    const gainNode = ctx.createGain();\n\n    oscillator.connect(gainNode);\n    gainNode.connect(ctx.destination);\n\n    oscillator.frequency.setValueAtTime(300, ctx.currentTime);\n    oscillator.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.3);\n    oscillator.type = 'triangle';\n\n    gainNode.gain.setValueAtTime(0.15, ctx.currentTime);\n    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);\n\n    oscillator.start(ctx.currentTime);\n    oscillator.stop(ctx.currentTime + 0.3);\n  }\n\n  setEnabled(enabled: boolean) {\n    this.enabled = enabled;\n  }\n\n  isEnabled(): boolean {\n    return this.enabled;\n  }\n}\n\n// Export a singleton instance\nexport const soundManager = new SoundManager();\n","path":null,"size_bytes":3787,"size_tokens":null},"client/src/lib/PreloadProvider.tsx":{"content":"import { createContext, useContext, useEffect, useState, ReactNode } from 'react';\nimport { useAuth } from '@/hooks/useAuth';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\nimport { writeLocal, readLocal, CACHE_KEYS } from '@/lib/localCache';\nimport { getSupabaseClient } from '@/lib/supabaseClient';\n\n// Import images to preload\nimport historianHamsterBlue from '@assets/Historian-Hamster-Blue.svg';\nimport librarianHamsterYellow from '@assets/Librarian-Hamster-Yellow.svg';\nimport mathsHamsterGreen from '@assets/Maths-Hamster-Green.svg';\nimport mechanicHamsterGrey from '@assets/Mechanic-Hamster-Grey.svg';\nimport whiteTickBlue from '@assets/Win-Hamster-Blue.svg';\nimport whiteCrossBlue from '@assets/Lost-Hamster-Blue.svg';\n\ninterface PreloadContextValue {\n  isPreloaded: boolean;\n}\n\nconst PreloadContext = createContext<PreloadContextValue>({ isPreloaded: false });\n\nexport function usePreload() {\n  return useContext(PreloadContext);\n}\n\ninterface PreloadProviderProps {\n  children: ReactNode;\n}\n\nexport function PreloadProvider({ children }: PreloadProviderProps) {\n  const [isPreloaded, setIsPreloaded] = useState(false);\n  const { user, isAuthenticated } = useAuth();\n\n  // Hydrate query cache from localStorage immediately on mount (synchronous)\n  // This ensures isAdmin and region are available instantly before network requests\n  useEffect(() => {\n    if (isAuthenticated) {\n      const cachedProfile = readLocal<any>(CACHE_KEYS.PROFILE);\n      if (cachedProfile) {\n        queryClient.setQueryData(['/api/auth/profile'], cachedProfile);\n        console.log('[PreloadProvider] Hydrated profile from cache with isAdmin:', cachedProfile.isAdmin, 'region:', cachedProfile.region);\n      }\n    }\n  }, [isAuthenticated]);\n\n  useEffect(() => {\n    const preloadAssets = async () => {\n      // Preload images\n      const imagesToPreload = [\n        historianHamsterBlue,\n        librarianHamsterYellow,\n        mathsHamsterGreen,\n        mechanicHamsterGrey,\n        whiteTickBlue,\n        whiteCrossBlue,\n      ];\n\n      const imagePromises = imagesToPreload.map(src => {\n        return new Promise((resolve, reject) => {\n          const img = new Image();\n          img.onload = resolve;\n          img.onerror = reject;\n          img.src = src;\n        });\n      });\n\n      // Wait for all images to load (but don't block on errors)\n      await Promise.allSettled(imagePromises);\n\n      // Prefetch data if authenticated - handle each independently\n      if (isAuthenticated && user) {\n        // Get auth token once for authenticated requests\n        let authToken: string | null = null;\n        try {\n          const supabase = await getSupabaseClient();\n          const { data: { session } } = await supabase.auth.getSession();\n          authToken = session?.access_token || null;\n        } catch {\n          console.warn('[PreloadProvider] Failed to get auth session');\n        }\n\n        const prefetchTasks = [\n          // Prefetch settings\n          queryClient.fetchQuery({\n            queryKey: ['/api/settings'],\n            queryFn: async () => {\n              const response = await fetch('/api/settings', {\n                credentials: 'include',\n              });\n              if (!response.ok) throw new Error('Failed to fetch settings');\n              return response.json();\n            },\n            staleTime: 5 * 60 * 1000,\n          }).then(data => ({ key: 'settings', data })).catch(() => ({ key: 'settings', data: null })),\n\n          // Prefetch profile with auth token for faster Account Info page load\n          queryClient.fetchQuery({\n            queryKey: ['/api/auth/profile'],\n            queryFn: async () => {\n              const headers: Record<string, string> = {};\n              if (authToken) {\n                headers['Authorization'] = `Bearer ${authToken}`;\n              }\n              const response = await fetch('/api/auth/profile', {\n                credentials: 'include',\n                headers,\n              });\n              if (!response.ok) throw new Error('Failed to fetch profile');\n              return response.json();\n            },\n            staleTime: 5 * 60 * 1000,\n          }).then(data => ({ key: 'profile', data })).catch(() => ({ key: 'profile', data: null })),\n\n          // Prefetch regions for Account Info page (public data, no auth needed)\n          queryClient.fetchQuery({\n            queryKey: ['/api/regions'],\n            queryFn: async () => {\n              const response = await fetch('/api/regions', {\n                credentials: 'include',\n              });\n              if (!response.ok) throw new Error('Failed to fetch regions');\n              return response.json();\n            },\n            staleTime: 30 * 60 * 1000, // Cache for 30 mins since regions rarely change\n          }).then(data => ({ key: 'regions', data })).catch(() => ({ key: 'regions', data: null })),\n\n          // Prefetch stats (requires auth)\n          authToken ? queryClient.fetchQuery({\n            queryKey: ['/api/stats'],\n            queryFn: async () => {\n              const response = await fetch('/api/stats', {\n                credentials: 'include',\n                headers: {\n                  'Authorization': `Bearer ${authToken}`,\n                },\n              });\n              if (!response.ok) throw new Error('Failed to fetch stats');\n              return response.json();\n            },\n            staleTime: 5 * 60 * 1000,\n          }).then(data => ({ key: 'stats', data })).catch(() => ({ key: 'stats', data: null }))\n          : Promise.resolve({ key: 'stats', data: null }),\n\n          // Prefetch game attempts (requires auth)\n          authToken ? queryClient.fetchQuery({\n            queryKey: ['/api/game-attempts/user'],\n            queryFn: async () => {\n              const response = await fetch('/api/game-attempts/user', {\n                credentials: 'include',\n                headers: {\n                  'Authorization': `Bearer ${authToken}`,\n                },\n              });\n              if (!response.ok) throw new Error('Failed to fetch attempts');\n              return response.json();\n            },\n            staleTime: 5 * 60 * 1000,\n          }).then(data => ({ key: 'attempts', data })).catch(() => ({ key: 'attempts', data: null }))\n          : Promise.resolve({ key: 'attempts', data: null }),\n\n          // Prefetch user pro-categories (requires auth)\n          authToken ? queryClient.fetchQuery({\n            queryKey: ['/api/user/pro-categories'],\n            queryFn: async () => {\n              const response = await fetch('/api/user/pro-categories', {\n                credentials: 'include',\n                headers: {\n                  'Authorization': `Bearer ${authToken}`,\n                },\n              });\n              if (!response.ok) throw new Error('Failed to fetch user categories');\n              return response.json();\n            },\n            staleTime: 30 * 60 * 1000, // Cache for 30 mins since categories rarely change\n          }).then(data => ({ key: 'userCategories', data })).catch(() => ({ key: 'userCategories', data: null }))\n          : Promise.resolve({ key: 'userCategories', data: null }),\n          \n          // Prefetch categories list (public, no auth needed)\n          queryClient.fetchQuery({\n            queryKey: ['/api/categories'],\n            queryFn: async () => {\n              const response = await fetch('/api/categories', {\n                credentials: 'include',\n              });\n              if (!response.ok) throw new Error('Failed to fetch categories list');\n              return response.json();\n            },\n            staleTime: 60 * 60 * 1000, // Cache for 60 mins since categories list rarely changes\n          }).then(data => ({ key: 'categoriesList', data })).catch(() => ({ key: 'categoriesList', data: null })),\n\n          // Prefetch subscription data (includes autoRenew state) - uses shared auth token\n          authToken ? queryClient.fetchQuery({\n            queryKey: ['/api/subscription', user.id],\n            queryFn: async () => {\n              const response = await fetch('/api/subscription', {\n                credentials: 'include',\n                headers: {\n                  'Authorization': `Bearer ${authToken}`,\n                },\n              });\n              if (!response.ok) throw new Error('Failed to fetch subscription');\n              return response.json();\n            },\n            staleTime: 5 * 60 * 1000,\n          }).then(data => ({ key: 'subscription', data })).catch(() => ({ key: 'subscription', data: null }))\n          : Promise.resolve({ key: 'subscription', data: null }),\n\n          // Prefetch puzzles (requires auth for user's region)\n          authToken ? queryClient.fetchQuery({\n            queryKey: ['/api/puzzles'],\n            queryFn: async () => {\n              const response = await fetch('/api/puzzles', {\n                credentials: 'include',\n                headers: {\n                  'Authorization': `Bearer ${authToken}`,\n                },\n              });\n              if (!response.ok) throw new Error('Failed to fetch puzzles');\n              return response.json();\n            },\n            staleTime: 10 * 60 * 1000,\n          }).then(data => ({ key: 'puzzles', data })).catch(() => ({ key: 'puzzles', data: null }))\n          : Promise.resolve({ key: 'puzzles', data: null }),\n          \n          // Preload badge images\n          (async () => {\n            try {\n              const response = await fetch('/api/badges', {\n                credentials: 'include',\n              });\n              if (!response.ok) throw new Error('Failed to fetch badges');\n              const badges = await response.json();\n              \n              // Preload all badge images\n              const badgeImagePromises = badges.map((badge: any) => {\n                return new Promise((resolve) => {\n                  if (!badge.iconUrl) {\n                    resolve(null);\n                    return;\n                  }\n                  const img = new Image();\n                  img.onload = resolve;\n                  img.onerror = resolve; // Don't fail on image load errors\n                  img.src = badge.iconUrl;\n                });\n              });\n              \n              await Promise.allSettled(badgeImagePromises);\n              console.log('[PreloadProvider] Preloaded', badges.length, 'badge images');\n              return { key: 'badgeImages', data: null };\n            } catch {\n              return { key: 'badgeImages', data: null };\n            }\n          })(),\n          \n          // Check for pending percentile badges (REGION mode) - silent check on app load\n          authToken ? (async () => {\n            try {\n              const response = await fetch('/api/badges/check-percentile', {\n                method: 'POST',\n                credentials: 'include',\n                headers: {\n                  'Authorization': `Bearer ${authToken}`,\n                  'Content-Type': 'application/json',\n                },\n              });\n              if (response.ok) {\n                const data = await response.json();\n                if (data.awarded && data.badge) {\n                  console.log('[PreloadProvider] Awarded percentile badge (REGION):', data.badge);\n                }\n              }\n              return { key: 'regionBadgeCheck', data: null };\n            } catch {\n              return { key: 'regionBadgeCheck', data: null };\n            }\n          })() : Promise.resolve({ key: 'regionBadgeCheck', data: null }),\n          \n          // Check for pending percentile badges (USER mode) - silent check on app load\n          authToken ? (async () => {\n            try {\n              const response = await fetch('/api/user/badges/check-percentile', {\n                method: 'POST',\n                credentials: 'include',\n                headers: {\n                  'Authorization': `Bearer ${authToken}`,\n                  'Content-Type': 'application/json',\n                },\n              });\n              if (response.ok) {\n                const data = await response.json();\n                if (data.awarded && data.badge) {\n                  console.log('[PreloadProvider] Awarded percentile badge (USER):', data.badge);\n                }\n              }\n              return { key: 'userBadgeCheck', data: null };\n            } catch {\n              return { key: 'userBadgeCheck', data: null };\n            }\n          })() : Promise.resolve({ key: 'userBadgeCheck', data: null }),\n        ];\n\n        // Execute all prefetch tasks in parallel\n        const results = await Promise.allSettled(prefetchTasks);\n\n        // Process results and update caches independently\n        const dataMap: Record<string, any> = {};\n        results.forEach((result) => {\n          if (result.status === 'fulfilled' && result.value.data) {\n            dataMap[result.value.key] = result.value.data;\n          }\n        });\n\n        // Cache each piece of data if available\n        if (dataMap.settings) {\n          writeLocal(CACHE_KEYS.SETTINGS, dataMap.settings);\n        }\n\n        if (dataMap.profile) {\n          writeLocal(CACHE_KEYS.PROFILE, dataMap.profile);\n          console.log('[PreloadProvider] Cached profile with isAdmin:', dataMap.profile.isAdmin, 'region:', dataMap.profile.region);\n        }\n\n        if (dataMap.stats) {\n          writeLocal(CACHE_KEYS.STATS, dataMap.stats);\n        }\n\n        if (dataMap.attempts) {\n          writeLocal(CACHE_KEYS.ATTEMPTS, dataMap.attempts);\n        }\n\n        if (dataMap.userCategories?.categoryIds && Array.isArray(dataMap.userCategories.categoryIds)) {\n          writeLocal(CACHE_KEYS.PRO_CATEGORIES, dataMap.userCategories.categoryIds);\n          console.log('[PreloadProvider] Cached user pro-categories:', dataMap.userCategories.categoryIds);\n        }\n        \n        if (dataMap.categoriesList && Array.isArray(dataMap.categoriesList)) {\n          writeLocal(CACHE_KEYS.CATEGORIES_LIST, dataMap.categoriesList);\n          console.log('[PreloadProvider] Cached categories list:', dataMap.categoriesList.length);\n        }\n\n        if (dataMap.subscription) {\n          writeLocal(CACHE_KEYS.SUBSCRIPTION, dataMap.subscription);\n          console.log('[PreloadProvider] Cached subscription with autoRenew:', dataMap.subscription.autoRenew);\n        }\n\n        if (dataMap.regions && Array.isArray(dataMap.regions)) {\n          writeLocal(CACHE_KEYS.REGIONS, dataMap.regions);\n          console.log('[PreloadProvider] Cached regions:', dataMap.regions.length);\n        }\n\n        // Cache current month's archive if we have puzzles\n        if (dataMap.puzzles && Array.isArray(dataMap.puzzles)) {\n          const now = new Date();\n          const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;\n          \n          const currentMonthPuzzles = dataMap.puzzles.filter((puzzle: any) => {\n            const puzzleDate = new Date(puzzle.date);\n            const puzzleMonth = `${puzzleDate.getFullYear()}-${String(puzzleDate.getMonth() + 1).padStart(2, '0')}`;\n            return puzzleMonth === currentMonth;\n          });\n          \n          writeLocal(`${CACHE_KEYS.ARCHIVE_PREFIX}${currentMonth}`, currentMonthPuzzles);\n        }\n      }\n\n      setIsPreloaded(true);\n    };\n\n    preloadAssets();\n  }, [isAuthenticated, user]);\n\n  return (\n    <PreloadContext.Provider value={{ isPreloaded }}>\n      {children}\n    </PreloadContext.Provider>\n  );\n}\n","path":null,"size_bytes":15502,"size_tokens":null},"client/src/lib/RoutePersistence.tsx":{"content":"// src/lib/RoutePersistence.tsx\nimport { useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\n\nexport function RoutePersistence() {\n  const [location, setLocation] = useLocation();\n\n  // Save route whenever it changes\n  useEffect(() => {\n    localStorage.setItem(\"last-route\", location);\n  }, [location]);\n\n  // On first mount, restore last route if different\n  useEffect(() => {\n    const last = localStorage.getItem(\"last-route\");\n    if (last && last !== location) {\n      setLocation(last);\n    }\n  }, []); // run once on mount\n\n  return null;\n}\n","path":null,"size_bytes":561,"size_tokens":null},"client/src/components/ui/password-input.tsx":{"content":"import * as React from \"react\";\nimport { Eye, EyeOff } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\nexport interface PasswordInputProps\n  extends Omit<React.ComponentProps<\"input\">, \"type\"> {\n  onKeyDown?: (e: React.KeyboardEvent<HTMLInputElement>) => void;\n}\n\nconst PasswordInput = React.forwardRef<HTMLInputElement, PasswordInputProps>(\n  ({ className, onKeyDown, ...props }, ref) => {\n    const [showPassword, setShowPassword] = React.useState(false);\n\n    return (\n      <div className=\"relative\">\n        <input\n          type={showPassword ? \"text\" : \"password\"}\n          className={cn(\n            \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm pr-10\",\n            className\n          )}\n          ref={ref}\n          onKeyDown={onKeyDown}\n          {...props}\n        />\n        <button\n          type=\"button\"\n          onClick={() => setShowPassword(!showPassword)}\n          className=\"absolute right-0 top-0 h-9 w-10 flex items-center justify-center text-muted-foreground hover:text-foreground transition-colors\"\n          tabIndex={-1}\n          data-testid=\"button-toggle-password-visibility\"\n        >\n          {showPassword ? (\n            <EyeOff className=\"h-4 w-4\" />\n          ) : (\n            <Eye className=\"h-4 w-4\" />\n          )}\n        </button>\n      </div>\n    );\n  }\n);\nPasswordInput.displayName = \"PasswordInput\";\n\nexport { PasswordInput };\n","path":null,"size_bytes":1722,"size_tokens":null},"client/src/components/OTPVerificationScreen.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { ChevronLeft, Mail, Smartphone } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useSupabase } from \"@/lib/SupabaseProvider\";\n\n// Common country codes for phone numbers\nconst COUNTRY_CODES = [\n  { code: \"+44\", name: \"United Kingdom\", flag: \"\" },\n  { code: \"+1\", name: \"United States/Canada\", flag: \"\" },\n  { code: \"+33\", name: \"France\", flag: \"\" },\n  { code: \"+49\", name: \"Germany\", flag: \"\" },\n  { code: \"+34\", name: \"Spain\", flag: \"\" },\n  { code: \"+39\", name: \"Italy\", flag: \"\" },\n  { code: \"+61\", name: \"Australia\", flag: \"\" },\n  { code: \"+91\", name: \"India\", flag: \"\" },\n  { code: \"+86\", name: \"China\", flag: \"\" },\n  { code: \"+81\", name: \"Japan\", flag: \"\" },\n];\n\ninterface OTPVerificationScreenProps {\n  email: string;\n  phone?: string;\n  type: \"signup\" | \"email_change\";\n  onVerified: () => void;\n  onCancel: () => void;\n}\n\nexport function OTPVerificationScreen({\n  email,\n  phone,\n  type,\n  onVerified,\n  onCancel,\n}: OTPVerificationScreenProps) {\n  const supabase = useSupabase();\n  const { toast } = useToast();\n  const [code, setCode] = useState(\"\");\n  \n  // Parse existing phone number if provided (E.164 format: +CountryCode LocalNumber)\n  const parsePhoneNumber = (fullPhone: string) => {\n    if (!fullPhone) return { code: \"+44\", local: \"\" };\n    \n    // If already in E.164 format (starts with +)\n    if (fullPhone.startsWith(\"+\")) {\n      // Try to match against known country codes\n      for (const country of COUNTRY_CODES) {\n        if (fullPhone.startsWith(country.code)) {\n          return {\n            code: country.code,\n            local: fullPhone.slice(country.code.length),\n          };\n        }\n      }\n      \n      // If no match found in known codes, extract country code dynamically\n      // Country codes are 1-3 digits after the +\n      const match = fullPhone.match(/^(\\+\\d{1,3})(\\d+)$/);\n      if (match) {\n        return {\n          code: match[1], // Extracted country code (e.g., \"+353\")\n          local: match[2], // Remaining digits\n        };\n      }\n      \n      // Fallback: treat entire number as local (shouldn't happen with valid E.164)\n      return { code: \"+44\", local: fullPhone.slice(1) };\n    }\n    \n    // Otherwise, treat as local number with UK default\n    return { code: \"+44\", local: fullPhone };\n  };\n  \n  const { code: initialCode, local: initialLocal } = parsePhoneNumber(phone || \"\");\n  const [phoneNumber, setPhoneNumber] = useState(initialLocal);\n  const [countryCode, setCountryCode] = useState(initialCode);\n  const [showPhoneInput, setShowPhoneInput] = useState(false);\n  const [resendCooldown, setResendCooldown] = useState(15);\n  const [loading, setLoading] = useState(false);\n  const [deliveryMethod, setDeliveryMethod] = useState<\"email\" | \"sms\">(\"email\");\n\n  // Countdown timer for resend button\n  useEffect(() => {\n    if (resendCooldown > 0) {\n      const timer = setTimeout(() => {\n        setResendCooldown(resendCooldown - 1);\n      }, 1000);\n      return () => clearTimeout(timer);\n    }\n  }, [resendCooldown]);\n\n  const handleVerifyCode = async () => {\n    if (code.length !== 6) {\n      toast({\n        title: \"Invalid code\",\n        description: \"Please enter a 6-digit code\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setLoading(true);\n    try {\n      // For signInWithOtp-based signup, use 'email' type instead of 'signup'\n      const verifyType = type === \"signup\" ? \"email\" : \"email_change\";\n      console.log('[OTP] Verifying OTP with type:', verifyType);\n      \n      const { data, error} = await supabase.auth.verifyOtp({\n        email,\n        token: code,\n        type: \"email\",\n      });\n\n      console.log('[OTP] verifyOtp data:', data);\n      console.log('[OTP] verifyOtp result:', error ? `Error: ${error.message}` : 'Success');\n      if (error) throw error;\n\n      if (data.session) {\n        console.log(\"[OTP] Verification successful with valid session, calling onVerified()\");\n        toast({\n          title: \"Verification successful!\",\n          description: type === \"signup\" ? \"Your account has been created.\" : \"Your email has been updated.\",\n        });\n        onVerified();\n      } else {\n        console.warn(\"[OTP] verifyOtp succeeded but no session returned\");\n        throw new Error(\"Verification failed: No valid session was created. Please try again.\");\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Verification failed\",\n        description: error.message || \"The code you entered is incorrect or expired\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleResendCode = async () => {\n    if (resendCooldown > 0) return;\n\n    setLoading(true);\n    try {\n      if (deliveryMethod === \"sms\") {\n        if (!phoneNumber) {\n          toast({\n            title: \"Phone number required\",\n            description: \"Please enter your phone number to receive SMS codes\",\n            variant: \"destructive\",\n          });\n          setLoading(false);\n          return;\n        }\n\n        // Combine country code with phone number (remove any leading zeros from local number)\n        const cleanNumber = phoneNumber.replace(/^0+/, ''); // Remove leading zeros\n        const fullPhoneNumber = `${countryCode}${cleanNumber}`;\n\n        // Send OTP via SMS\n        const { error } = await supabase.auth.signInWithOtp({\n          phone: fullPhoneNumber,\n        });\n\n        if (error) throw error;\n\n        toast({\n          title: \"Code sent!\",\n          description: `A new verification code has been sent to ${fullPhoneNumber}`,\n        });\n      } else {\n        // Resend OTP via email\n        console.log('[OTP] Resending OTP via email, shouldCreateUser:', type === \"signup\");\n        \n        const { error } = await supabase.auth.signInWithOtp({\n          email,\n          options: {\n            shouldCreateUser: type === \"signup\",\n          },\n        });\n\n        console.log('[OTP] Resend result:', error ? `Error: ${error.message}` : 'Success');\n        if (error) throw error;\n\n        toast({\n          title: \"Code sent!\",\n          description: `A new verification code has been sent to ${email}`,\n        });\n      }\n\n      setResendCooldown(15);\n    } catch (error: any) {\n      toast({\n        title: \"Failed to resend code\",\n        description: error.message || \"Please try again later\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleSwitchToSMS = () => {\n    setShowPhoneInput(!showPhoneInput);\n    if (!showPhoneInput) {\n      setDeliveryMethod(\"sms\");\n    } else {\n      setDeliveryMethod(\"email\");\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex flex-col p-4 pt-8\">\n      <div className=\"w-full max-w-md mx-auto space-y-4\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <button\n            onClick={onCancel}\n            data-testid=\"button-back-from-verification\"\n            className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n          >\n            <ChevronLeft className=\"h-9 w-9 text-gray-700\" />\n          </button>\n\n          <h1 className=\"text-4xl font-bold text-gray-700\">Verify Code</h1>\n\n          <div className=\"w-14\" />\n        </div>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Enter Verification Code</CardTitle>\n            <CardDescription>\n              {deliveryMethod === \"email\"\n                ? `We've sent a 6-digit code to ${email}. Please check your inbox and enter the code below.`\n                : `We've sent a 6-digit code to ${countryCode}${phoneNumber.replace(/^0+/, '')}. Please check your messages and enter the code below.`}\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"code\" data-testid=\"label-verification-code\">\n                Verification Code\n              </Label>\n              <Input\n                id=\"code\"\n                type=\"text\"\n                inputMode=\"numeric\"\n                maxLength={6}\n                data-testid=\"input-verification-code\"\n                value={code}\n                onChange={(e) => setCode(e.target.value.replace(/\\D/g, \"\"))}\n                placeholder=\"000000\"\n                className=\"text-center text-2xl tracking-widest\"\n              />\n            </div>\n\n            {showPhoneInput && (\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"country-code\" data-testid=\"label-country-code\">\n                  Country\n                </Label>\n                <Select\n                  value={countryCode}\n                  onValueChange={setCountryCode}\n                >\n                  <SelectTrigger\n                    id=\"country-code\"\n                    data-testid=\"select-country-code\"\n                    className=\"w-full\"\n                  >\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {COUNTRY_CODES.map((country) => (\n                      <SelectItem\n                        key={country.code}\n                        value={country.code}\n                        data-testid={`option-country-${country.code}`}\n                      >\n                        {country.flag} {country.name} ({country.code})\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n\n                <Label htmlFor=\"phone\" data-testid=\"label-phone-number\">\n                  Phone Number\n                </Label>\n                <div className=\"flex gap-2\">\n                  <div className=\"flex items-center justify-center px-3 border rounded-md bg-muted text-muted-foreground\">\n                    {countryCode}\n                  </div>\n                  <Input\n                    id=\"phone\"\n                    type=\"tel\"\n                    inputMode=\"numeric\"\n                    data-testid=\"input-phone-number\"\n                    value={phoneNumber}\n                    onChange={(e) => setPhoneNumber(e.target.value.replace(/\\D/g, \"\"))}\n                    placeholder=\"7700900000\"\n                    className=\"flex-1\"\n                  />\n                </div>\n                <p className=\"text-xs text-muted-foreground\">\n                  Enter your local number without the country code. For UK numbers, omit the leading 0.\n                </p>\n              </div>\n            )}\n\n            <div className=\"flex flex-col gap-2\">\n              <Button\n                onClick={handleVerifyCode}\n                disabled={loading || code.length !== 6}\n                className={`w-full ${code.length === 6 && !loading ? \"bg-blue-700 hover:bg-blue-800\" : \"\"}`}\n                data-testid=\"button-verify-code\"\n              >\n                {loading ? \"Verifying...\" : \"Verify Code\"}\n              </Button>\n\n              <Button\n                variant=\"outline\"\n                onClick={handleSwitchToSMS}\n                className=\"w-full\"\n                data-testid=\"button-switch-delivery-method\"\n              >\n                {showPhoneInput ? (\n                  <>\n                    <Mail className=\"h-4 w-4 mr-2\" />\n                    Use Email Instead\n                  </>\n                ) : (\n                  <>\n                    <Smartphone className=\"h-4 w-4 mr-2\" />\n                    Use SMS Instead\n                  </>\n                )}\n              </Button>\n\n              <Button\n                variant=\"ghost\"\n                onClick={handleResendCode}\n                disabled={resendCooldown > 0 || loading}\n                className=\"w-full\"\n                data-testid=\"button-resend-code\"\n              >\n                {resendCooldown > 0\n                  ? `Resend code in ${resendCooldown}s`\n                  : \"Resend code\"}\n              </Button>\n\n              <Button\n                variant=\"outline\"\n                onClick={onCancel}\n                className=\"w-full\"\n                data-testid=\"button-cancel-verification\"\n              >\n                Cancel\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":12770,"size_tokens":null},"SUPABASE_OTP_SETUP.md":{"content":"# Supabase OTP Configuration Guide\n\n##  Root Cause: Why You're Getting Magic Links Instead of OTP Codes\n\nWhen using `signInWithOtp()` with `shouldCreateUser: true`, Supabase sends emails using the **\"Magic Link\"** template, **NOT** the \"Confirm Signup\" template.\n\nYou configured the \"Confirm Signup\" template with `{{ .Token }}`, but that template is only used by the old `signUp()` method, which we're no longer using.\n\n##  Solution: Configure the Magic Link Template\n\n### Step 1: Update Magic Link Template in Supabase Dashboard\n\n1. Go to your Supabase Dashboard\n2. Navigate to **Authentication**  **Email Templates**\n3. Select the **\"Magic Link\"** template\n4. Replace `{{ .ConfirmationURL }}` with `{{ .Token }}`\n5. Click **Save**\n\n**Example OTP Email Template:**\n\n```html\n<h2>Your Verification Code</h2>\n<p>Welcome to Elementle! Enter this code to verify your email:</p>\n<h1 style=\"font-size: 32px; letter-spacing: 8px; font-family: monospace;\">{{ .Token }}</h1>\n<p>This code expires in 24 hours.</p>\n<p>If you didn't request this code, you can safely ignore this email.</p>\n```\n\n### Step 2: Verify Your Code Implementation\n\nOur code is **already correct**:\n\n####  AuthPage.tsx (Line 85)\n```typescript\nawait supabase.auth.signInWithOtp({\n  email: formData.email,\n  options: {\n    shouldCreateUser: true,  //  Creates user if doesn't exist\n    //  NO emailRedirectTo (would trigger magic link)\n    data: {\n      first_name: formData.firstName,\n      last_name: formData.lastName,\n    },\n  },\n});\n```\n\n####  OTPVerificationScreen.tsx (Line 115)\n```typescript\nawait supabase.auth.verifyOtp({\n  email,\n  token: code,\n  type: \"email\",  //  Correct type for signInWithOtp\n});\n```\n\n####  Resend Email (Line 177)\n```typescript\nawait supabase.auth.signInWithOtp({\n  email,\n  options: {\n    shouldCreateUser: type === \"signup\",\n    //  NO emailRedirectTo parameter\n  },\n});\n```\n\n### Step 3: Test the Flow\n\n1. Open your browser's **Developer Console** (F12)\n2. Go to the **Console** tab\n3. Try signing up with a new email\n4. Look for these log messages:\n\n```\n[AUTH] Calling signInWithOtp for signup\n[AUTH] Parameters: { shouldCreateUser: true, emailRedirectTo: undefined }\n[AUTH] signInWithOtp result: Success - OTP sent\n```\n\n5. Check your email - you should now receive a **6-digit OTP code** instead of a magic link\n6. Enter the code and look for:\n\n```\n[OTP] Verifying OTP with type: email\n[OTP] verifyOtp result: Success\n```\n\n### Step 4: Verify Environment Variables\n\nMake sure your Replit environment is using the correct Supabase project:\n\n1. Check that `SUPABASE_URL` and `SUPABASE_ANON_KEY` in your Replit Secrets match the Supabase project where you configured the Magic Link template\n2. You can verify by checking the URL in the Supabase dashboard\n\n##  Checklist\n\n- [ ] Updated **\"Magic Link\"** template (not \"Confirm Signup\") to use `{{ .Token }}`\n- [ ] Saved the template changes in Supabase Dashboard\n- [ ] Verified environment variables point to correct Supabase project\n- [ ] Tested signup flow and checked browser console for debug logs\n- [ ] Received OTP code (6 digits) instead of magic link in email\n- [ ] Successfully verified OTP code\n\n##  Debugging\n\nIf you're still receiving magic links after updating the template:\n\n1. **Clear your browser cache** - Old email templates may be cached\n2. **Wait 1-2 minutes** - Template changes may take a moment to propagate\n3. **Check the correct project** - Verify your environment variables point to the project where you made the changes\n4. **Inspect the email** - Look at the raw HTML source to confirm it contains `{{ .Token }}` not `{{ .ConfirmationURL }}`\n5. **Check browser console** - The debug logs will show exactly what Supabase method is being called\n\n##  Official Documentation\n\n- [Supabase signInWithOtp() Reference](https://supabase.com/docs/reference/javascript/auth-signinwithotp)\n- [Supabase Email OTP Guide](https://supabase.com/docs/guides/auth/passwordless-login/auth-email-otp)\n- [Email Templates Configuration](https://supabase.com/docs/guides/auth/auth-email-templates)\n\n##  What's Implemented\n\n### Email OTP Flow\n1. User fills signup form\n2. `signInWithOtp({ email, shouldCreateUser: true })` sends OTP code\n3. User receives **6-digit code** in email (via Magic Link template with `{{ .Token }}`)\n4. User enters code in OTPVerificationScreen\n5. `verifyOtp({ email, token, type: 'email' })` verifies the code\n6. Password set via `updateUser({ password })`\n7. User profile created in database\n\n### SMS OTP Flow\n1. User switches to SMS delivery\n2. Enters phone number with country code\n3. `signInWithOtp({ phone })` sends SMS OTP\n4. User receives 6-digit code via SMS\n5. Verification works the same way\n\n### Security Features\n-  Password NEVER stored in user metadata\n-  Password only in local component state\n-  OTP codes expire after 24 hours\n-  Proper E.164 phone number formatting\n-  No magic link fallback\n\n##  Next Steps\n\nAfter configuring the Magic Link template:\n\n1. Test the complete signup flow\n2. Verify OTP codes are received via email\n3. Test SMS OTP if needed\n4. Remove debug console.log statements (optional - they don't affect production)\n","path":null,"size_bytes":5195,"size_tokens":null},"client/src/components/FeedbackForm.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { ChevronLeft, Star } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useProfile } from \"@/hooks/useProfile\";\nimport { useAdBannerActive } from \"@/components/AdBanner\";\n\ninterface FeedbackFormProps {\n  onBack: () => void;\n}\n\nexport function FeedbackForm({ onBack }: FeedbackFormProps) {\n  const { profile } = useProfile();\n  const { toast } = useToast();\n  const [feedback, setFeedback] = useState(\"\");\n  const [rating, setRating] = useState(0);\n  const [loading, setLoading] = useState(false);\n  const adBannerActive = useAdBannerActive();\n\n  const userEmail = profile?.email || \"\";\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!feedback.trim()) {\n      toast({\n        title: \"Feedback required\",\n        description: \"Please share your thoughts with us\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setLoading(true);\n    \n    // Fallback to mailto: link since email service is not configured\n    const subject = `Feedback - Elementle`;\n    const ratingText = rating > 0 ? `Rating: ${rating}/5 stars\\n\\n` : '';\n    const body = `Feedback from: ${userEmail}\\n\\n${ratingText}Feedback:\\n${feedback}`;\n    const mailtoLink = `mailto:no-reply@dobl.uk?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;\n    \n    try {\n      // Open mailto link\n      window.location.href = mailtoLink;\n      \n      toast({\n        title: \"Opening email client\",\n        description: \"Your default email client will open to send your feedback\",\n      });\n      \n      // Clear form and return after a delay\n      setTimeout(() => {\n        setFeedback(\"\");\n        setRating(0);\n        onBack();\n      }, 2000);\n    } catch (error) {\n      toast({\n        title: \"Could not open email\",\n        description: \"Please email us directly at no-reply@dobl.uk\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className={`min-h-screen flex flex-col p-4 bg-background pt-8 ${adBannerActive ? 'pb-[50px]' : ''}`}>\n      <div className=\"w-full max-w-md mx-auto space-y-4\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <button\n            onClick={onBack}\n            data-testid=\"button-back-from-feedback\"\n            className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n          >\n            <ChevronLeft className=\"h-9 w-9 text-gray-700\" />\n          </button>\n\n          <h1 className=\"text-4xl font-bold\">Feedback</h1>\n\n          <div className=\"w-14\" />\n        </div>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>How are we doing?</CardTitle>\n            <CardDescription>\n              Tell us what you enjoy and how we can make Elementle even better\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"email\" data-testid=\"label-email\">Your Email</Label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  value={userEmail}\n                  disabled\n                  data-testid=\"input-email\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"feedback\" data-testid=\"label-feedback\">Your Feedback</Label>\n                <Textarea\n                  id=\"feedback\"\n                  placeholder=\"What do you think about Elementle?\"\n                  value={feedback}\n                  onChange={(e) => setFeedback(e.target.value)}\n                  className=\"min-h-[150px]\"\n                  data-testid=\"textarea-feedback\"\n                  required\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label data-testid=\"label-rating\">Do you like playing Elementle?</Label>\n                <div className=\"flex gap-2 justify-center py-2\">\n                  {[1, 2, 3, 4, 5].map((star) => (\n                    <button\n                      key={star}\n                      type=\"button\"\n                      onClick={() => setRating(star)}\n                      className=\"transition-all hover:scale-110\"\n                      data-testid={`button-star-${star}`}\n                    >\n                      <Star\n                        className={`h-10 w-10 ${\n                          star <= rating\n                            ? \"fill-yellow-400 text-yellow-400\"\n                            : \"text-gray-300\"\n                        }`}\n                      />\n                    </button>\n                  ))}\n                </div>\n              </div>\n\n              <Button\n                type=\"submit\"\n                className=\"w-full\"\n                disabled={loading}\n                data-testid=\"button-send\"\n              >\n                {loading ? \"Sending...\" : \"Send Feedback\"}\n              </Button>\n            </form>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":5474,"size_tokens":null},"client/src/components/BugReportForm.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { ChevronLeft } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useProfile } from \"@/hooks/useProfile\";\nimport { useAdBannerActive } from \"@/components/AdBanner\";\n\ninterface BugReportFormProps {\n  onBack: () => void;\n}\n\nexport function BugReportForm({ onBack }: BugReportFormProps) {\n  const { profile } = useProfile();\n  const { toast } = useToast();\n  const [description, setDescription] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  const adBannerActive = useAdBannerActive();\n\n  const userEmail = profile?.email || \"\";\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!description.trim()) {\n      toast({\n        title: \"Description required\",\n        description: \"Please describe the bug you encountered\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setLoading(true);\n    \n    // Fallback to mailto: link since email service is not configured\n    const subject = `Bug Report - Elementle`;\n    const body = `Bug Report from: ${userEmail}\\n\\nDescription:\\n${description}`;\n    const mailtoLink = `mailto:no-reply@dobl.uk?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;\n    \n    try {\n      // Open mailto link\n      window.location.href = mailtoLink;\n      \n      toast({\n        title: \"Opening email client\",\n        description: \"Your default email client will open to send the bug report\",\n      });\n      \n      // Clear form and return after a delay\n      setTimeout(() => {\n        setDescription(\"\");\n        onBack();\n      }, 2000);\n    } catch (error) {\n      toast({\n        title: \"Could not open email\",\n        description: \"Please email us directly at no-reply@dobl.uk\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className={`min-h-screen flex flex-col p-4 bg-background pt-8 ${adBannerActive ? 'pb-[50px]' : ''}`}>\n      <div className=\"w-full max-w-md mx-auto space-y-4\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <button\n            onClick={onBack}\n            data-testid=\"button-back-from-bug-report\"\n            className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n          >\n            <ChevronLeft className=\"h-9 w-9 text-gray-700\" />\n          </button>\n\n          <h1 className=\"text-4xl font-bold\">Report a Bug</h1>\n\n          <div className=\"w-14\" />\n        </div>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Thank you!</CardTitle>\n            <CardDescription>\n              Your feedback helps us quickly fix issues  please describe what happened\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"email\" data-testid=\"label-email\">Your Email</Label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  value={userEmail}\n                  disabled\n                  data-testid=\"input-email\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"description\" data-testid=\"label-description\">Describe the bug</Label>\n                <Textarea\n                  id=\"description\"\n                  placeholder=\"What happened? What did you expect to happen? What device and browser are you using?\"\n                  value={description}\n                  onChange={(e) => setDescription(e.target.value)}\n                  className=\"min-h-[150px]\"\n                  data-testid=\"textarea-description\"\n                  required\n                />\n              </div>\n\n              <Button\n                type=\"submit\"\n                className=\"w-full\"\n                disabled={loading}\n                data-testid=\"button-send\"\n              >\n                {loading ? \"Sending...\" : \"Send Bug Report\"}\n              </Button>\n            </form>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":4512,"size_tokens":null},"CONSENT_FIELDS_FIX_SUMMARY.md":{"content":"# Consent Fields Fix Summary\n\n## Problem Statement\nWhen users signed up with consent checkboxes ticked, the consent flags (`accepted_terms`, `ads_consent`) and their timestamps (`accepted_terms_at`, `ads_consent_updated_at`) were not being persisted to the database. The PATCH `/api/auth/profile` endpoint was failing with the error:\n\n```\nTypeError: value.toISOString is not a function\nat PgTimestamp.mapToDriverValue\n```\n\n## Root Causes Identified\n\n### 1. Timestamp Type Mismatch\nWhen existing timestamps were retrieved from the database, they came back as ISO timestamp strings (e.g., `\"2025-10-23T21:00:00.000Z\"`). However, when these values were passed back to Drizzle ORM's upsert operation, Drizzle expected Date objects, not strings.\n\nWhen Drizzle tried to call `.toISOString()` on these string values, it threw the error.\n\n### 2. Missing Consent Fields in Signup\nThe signup route was only creating user profiles with `firstName` and `lastName`, completely ignoring the `accepted_terms` and `ads_consent` values that were being sent from the frontend.\n\n## Solutions Implemented\n\n### Fix 1: Updated PATCH `/api/auth/profile` Route (`server/routes.ts`)\n\n**Changes:**\n- Build profile data conditionally instead of using inline ternary operators\n- Only set timestamp fields when values actually change\n- **Convert existing timestamp strings to Date objects** before passing to Drizzle\n- This prevents the \"toISOString is not a function\" error\n\n**Code Changes:**\n```typescript\n// Build profile data conditionally\nconst profileData: any = {\n  id: userId,\n  email,\n  firstName,\n  lastName,\n  acceptedTerms: accepted_terms ?? existing?.acceptedTerms ?? false,\n  adsConsent: ads_consent ?? existing?.adsConsent ?? false,\n  emailVerified: existing?.emailVerified ?? false,\n};\n\n// Only set acceptedTermsAt when the value actually changes\nif (accepted_terms !== undefined && accepted_terms !== existing?.acceptedTerms) {\n  profileData.acceptedTermsAt = now;\n} else if (existing?.acceptedTermsAt) {\n  // Convert existing timestamp string to Date object\n  profileData.acceptedTermsAt = new Date(existing.acceptedTermsAt);\n}\n\n// Only set adsConsentUpdatedAt when the value actually changes\nif (ads_consent !== undefined && ads_consent !== existing?.adsConsent) {\n  profileData.adsConsentUpdatedAt = now;\n} else if (existing?.adsConsentUpdatedAt) {\n  // Convert existing timestamp string to Date object\n  profileData.adsConsentUpdatedAt = new Date(existing.adsConsentUpdatedAt);\n}\n```\n\n### Fix 2: Updated POST `/api/auth/signup` Route (`server/routes.ts`)\n\n**Changes:**\n- Extract `accepted_terms` and `ads_consent` from `req.body`\n- Include consent fields in the initial profile creation\n- Set timestamps immediately when consents are accepted during signup\n\n**Code Changes:**\n```typescript\nconst { email, password, firstName, lastName, accepted_terms, ads_consent } = req.body;\n\nconst now = new Date();\n\n// Create user profile with consent fields\nconst profileData: any = {\n  id: authData.user.id,\n  email: authData.user.email!,\n  firstName,\n  lastName,\n  acceptedTerms: accepted_terms ?? false,\n  adsConsent: ads_consent ?? false,\n};\n\n// Set timestamps for consents that were accepted\nif (accepted_terms) {\n  profileData.acceptedTermsAt = now;\n}\nif (ads_consent) {\n  profileData.adsConsentUpdatedAt = now;\n}\n\nawait storage.upsertUserProfile(profileData);\n```\n\n## Testing Instructions\n\n### End-to-End Test for Signup with Consents\n\n1. **Sign up a new user:**\n   - Navigate to the signup page\n   - Fill in all required fields (email, password, firstName, lastName)\n   - **Check both consent boxes:**\n     -  \"I accept the Terms of Service and Privacy Policy\" (required)\n     -  \"I agree to receive tailored ads...\" (optional)\n   - Submit the form\n\n2. **Verify in Supabase:**\n   ```sql\n   SELECT id, email, first_name, last_name, \n          accepted_terms, ads_consent,\n          accepted_terms_at, ads_consent_updated_at\n   FROM user_profiles\n   WHERE email = 'your-test-email@example.com';\n   ```\n\n   **Expected Results:**\n   - `accepted_terms` = `true`\n   - `ads_consent` = `true`\n   - `accepted_terms_at` = timestamp (not NULL)\n   - `ads_consent_updated_at` = timestamp (not NULL)\n\n### Test for Updating Consents\n\n1. **Log in as an existing user**\n2. **Go to Account Settings**\n3. **Update consent preferences:**\n   - Change ad consent from unchecked to checked (or vice versa)\n   - Submit the update\n\n4. **Verify in Supabase:**\n   ```sql\n   SELECT ads_consent, ads_consent_updated_at\n   FROM user_profiles\n   WHERE id = 'user-id';\n   ```\n\n   **Expected Results:**\n   - `ads_consent` reflects the new value\n   - `ads_consent_updated_at` has been updated to the current timestamp\n\n## Database Schema\n\nThe `user_profiles` table includes these consent-related columns:\n\n```typescript\n// Current consent flags\nacceptedTerms: boolean(\"accepted_terms\").notNull().default(false),\nadsConsent: boolean(\"ads_consent\").notNull().default(false),\n\n// Audit timestamps\nacceptedTermsAt: timestamp(\"accepted_terms_at\", { withTimezone: true }),\nadsConsentUpdatedAt: timestamp(\"ads_consent_updated_at\", { withTimezone: true }),\n```\n\n## Key Takeaways\n\n1. **Always convert database timestamp strings to Date objects** before passing them to Drizzle ORM\n2. **Extract and persist all user consent data** during signup, not just in subsequent updates\n3. **Set audit timestamps** (`_at` fields) whenever the corresponding boolean values change\n4. **Use conditional object building** instead of inline ternary operators for cleaner, more maintainable code\n\n## Additional Fix: CamelCase/Snake_case Alignment (October 23, 2025)\n\n### Problem\nAfter fixing the timestamp conversion issue, a new issue was discovered: the PrivacyPage toggle was failing with \"Failed to update profile\" because of naming convention mismatch:\n- Frontend sent: `{ adsConsent: true }` (camelCase)\n- Backend expected: `{ ads_consent: true }` (snake_case)\n\n### Solution\nStandardized on camelCase throughout the TypeScript/React layer:\n\n**Backend Changes (`server/routes.ts`):**\n- POST `/api/auth/signup`: Changed destructuring from `{ accepted_terms, ads_consent }` to `{ acceptedTerms, adsConsent }`\n- PATCH `/api/auth/profile`: \n  - Changed destructuring from `{ accepted_terms, ads_consent }` to `{ acceptedTerms, adsConsent }`\n  - Added request body logging for debugging: `console.log(\"PATCH /api/auth/profile body:\", req.body)`\n  - Improved timestamp handling with explicit null fallback (instead of leaving undefined)\n  - Streamlined code with inline ternary operators for cleaner structure\n- Internal logic maps camelCase to snake_case DB columns via Drizzle ORM\n\n**Frontend Changes (`client/src/components/AuthPage.tsx`):**\n- Updated `signInWithOtp` metadata to send `acceptedTerms` and `adsConsent` (instead of `accepted_terms` and `ads_consent`)\n- Updated profile PATCH request body to send `acceptedTerms` and `adsConsent`\n\nThis ensures consistent camelCase naming in TypeScript/React while Drizzle ORM handles the mapping to snake_case database columns.\n\n### Final PATCH Route Implementation\n\n```typescript\napp.patch(\"/api/auth/profile\", verifySupabaseAuth, async (req: any, res) => {\n  try {\n    console.log(\"PATCH /api/auth/profile body:\", req.body);\n\n    const userId = req.user.id;\n    const { firstName, lastName, email, acceptedTerms, adsConsent } = req.body;\n\n    const existing = await storage.getUserProfile(userId);\n    const now = new Date();\n\n    const updatedProfile = await storage.upsertUserProfile({\n      id: userId,\n      email,\n      firstName,\n      lastName,\n      acceptedTerms:\n        acceptedTerms ?? existing?.acceptedTerms ?? false,\n      adsConsent:\n        adsConsent ?? existing?.adsConsent ?? false,\n      acceptedTermsAt:\n        acceptedTerms !== undefined &&\n        acceptedTerms !== existing?.acceptedTerms\n          ? now\n          : existing?.acceptedTermsAt\n          ? new Date(existing.acceptedTermsAt)\n          : null,\n      adsConsentUpdatedAt:\n        adsConsent !== undefined &&\n        adsConsent !== existing?.adsConsent\n          ? now\n          : existing?.adsConsentUpdatedAt\n          ? new Date(existing.adsConsentUpdatedAt)\n          : null,\n      emailVerified: existing?.emailVerified ?? false,\n    });\n\n    res.json(updatedProfile);\n  } catch (error) {\n    console.error(\"Error updating profile:\", error);\n    res.status(500).json({ error: \"Failed to update profile\" });\n  }\n});\n```\n\n## Files Modified\n\n- `server/routes.ts` - Updated both POST `/api/auth/signup` and PATCH `/api/auth/profile` routes to accept camelCase\n- `client/src/components/AuthPage.tsx` - Updated to send camelCase in both signup and profile creation flows\n- No changes needed to `server/storage.ts` - the upsertUserProfile method was already correct\n- No changes needed to `shared/schema.ts` - schema was already correct\n- No changes needed to `client/src/hooks/useProfile.ts` - already sending camelCase\n","path":null,"size_bytes":8894,"size_tokens":null},"NOTE_EMAIL_CONFIGURATION.md":{"content":"# Email Configuration Note\n\n## Bug Report & Feedback Forms\n\nThe bug report and feedback forms have been created and integrated into the Settings page.\n\n### Current Implementation\n- Forms collect user feedback and bug reports\n- User email is pre-filled from their profile\n- Forms include validation and loading states\n- **Currently using mailto: links** - opens user's default email client with pre-filled content\n- This works immediately without any backend configuration\n\n### Upgrade to Automated Email Sending (Optional)\n\nIf you want to replace the mailto: fallback with automated email sending, you can:\n\n1. **Choose an Email Service Provider:**\n   - Sendgrid\n   - Mailgun\n   - AWS SES\n   - Postmark\n   - etc.\n\n2. **Add API Keys to Secrets:**\n   ```\n   EMAIL_API_KEY=your_api_key_here\n   EMAIL_FROM=noreply@dobl.uk\n   EMAIL_TO=no-reply@dobl.uk\n   ```\n\n3. **Implement `/api/send-email` Endpoint:**\n   Add this route to `server/routes.ts`:\n\n   Example with SendGrid:\n   ```typescript\n   app.post('/api/send-email', async (req, res) => {\n     const { to, subject, body } = req.body;\n     \n     // Use your chosen email service here\n     // await emailService.send({ to, subject, body });\n     \n     res.json({ success: true });\n   });\n   ```\n\n4. **Update Form Submission Logic:**\n   Replace the mailto: link code in both forms with the API call (the old code is commented in the file for reference).\n\n### Forms Created\n- **BugReportForm** (`client/src/components/BugReportForm.tsx`)\n  - Uses mailto: link to open email client\n  - Pre-fills recipient, subject, and body\n  \n- **FeedbackForm** (`client/src/components/FeedbackForm.tsx`)\n  - Includes 5-star rating system\n  - Uses mailto: link to open email client\n  - Pre-fills recipient, subject, rating, and feedback\n\nBoth forms include proper validation, loading states, and toast notifications.\n","path":null,"size_bytes":1846,"size_tokens":null},"CLIENT_SIDE_AUTH_FIX.md":{"content":"# Client-Side Authentication Fix for Profile Updates\n\n## Problem Diagnosis (October 23, 2025)\n\n### Symptoms\n- PrivacyPage ads consent toggle showed \"Failed to update profile\" error\n- Backend PATCH route was correctly returning 200 status in some cases\n- Client still throwing errors even with successful backend responses\n\n### Root Cause\nThe `patchProfile` function in `client/src/hooks/useProfile.ts` was missing the Supabase Authorization header when making PATCH requests to `/api/auth/profile`.\n\n**Server logs showed:**\n```\nPATCH /api/auth/profile 401 in 0ms :: {\"error\":\"Unauthorized\"}\n```\n\n**Original broken code:**\n```typescript\nasync function patchProfile(updates: Partial<UserProfile>): Promise<UserProfile> {\n  const res = await fetch(\"/api/auth/profile\", {\n    method: \"PATCH\",\n    headers: { \"Content-Type\": \"application/json\" },  //  Missing Authorization header!\n    body: JSON.stringify(updates),\n  });\n  if (!res.ok) {\n    throw new Error(\"Failed to update profile\");\n  }\n  return res.json();\n}\n```\n\nThe backend route requires authentication via `verifySupabaseAuth` middleware:\n```typescript\napp.patch(\"/api/auth/profile\", verifySupabaseAuth, async (req: any, res) => {\n  // This middleware checks for Authorization: Bearer <token>\n  // Without it, request returns 401 Unauthorized\n})\n```\n\n## Solution Implemented\n\n### Updated `client/src/hooks/useProfile.ts`\n\n**Key changes:**\n1. Import Supabase client: `import { getSupabaseClient } from \"@/lib/supabaseClient\"`\n2. Get session token before making request\n3. Include Authorization header with bearer token\n4. Add comprehensive logging for debugging\n\n**Fixed code:**\n```typescript\nasync function patchProfile(updates: Partial<UserProfile>): Promise<UserProfile> {\n  const supabase = await getSupabaseClient();\n  const { data: { session } } = await supabase.auth.getSession();\n  \n  if (!session?.access_token) {\n    console.error(\"[patchProfile] No valid session\");\n    throw new Error(\"Not authenticated\");\n  }\n\n  console.log(\"[patchProfile] Sending PATCH with body:\", updates);\n  \n  const res = await fetch(\"/api/auth/profile\", {\n    method: \"PATCH\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"Authorization\": `Bearer ${session.access_token}`,  //  Now included!\n    },\n    body: JSON.stringify(updates),\n  });\n  \n  console.log(\"[patchProfile] Response status:\", res.status);\n  \n  if (!res.ok) {\n    const errorText = await res.text();\n    console.error(\"[patchProfile] Request failed:\", res.status, errorText);\n    throw new Error(\"Failed to update profile\");\n  }\n  \n  const data = await res.json();\n  console.log(\"[patchProfile] Response body:\", data);\n  return data;\n}\n```\n\n## Testing Instructions\n\n### 1. Manual Testing\n1. Log in to your account\n2. Navigate to Options  Privacy page\n3. Toggle the \"Ads Consent\" checkbox on/off\n4. **Expected behavior:**\n   - No \"Failed to update profile\" error\n   - Toggle updates smoothly\n   - Supabase `ads_consent` and `ads_consent_updated_at` fields update correctly\n\n### 2. Browser DevTools Verification\nOpen Browser Console and check for:\n```\n[patchProfile] Sending PATCH with body: { adsConsent: true }\n[patchProfile] Response status: 200\n[patchProfile] Response body: { id: \"...\", adsConsent: true, ... }\n```\n\n### 3. Server Logs Verification\nCheck application logs for:\n```\nPATCH /api/auth/profile body: { adsConsent: true }\nPATCH /api/auth/profile 200 in XXXms :: {\"id\":\"...\",\"adsConsent\":true,...}\n```\n\n### 4. Database Verification\nQuery Supabase users table:\n```sql\nSELECT id, ads_consent, ads_consent_updated_at FROM users WHERE id = '<your-user-id>';\n```\n\nExpected result:\n- `ads_consent` toggles between true/false\n- `ads_consent_updated_at` timestamp updates only when value changes\n\n## Acceptance Criteria\n\n Browser Network tab shows PATCH `/api/auth/profile` returns **200 status**  \n Response includes full UserProfile JSON with updated fields  \n `useProfile.ts` successfully parses and returns the updated profile  \n No \"Failed to update profile\" error in client  \n Toggling adsConsent updates Supabase database  \n UI reflects the change immediately  \n Console logs show successful request/response flow  \n\n## Pattern for Future Authenticated Requests\n\nAll authenticated fetch requests in this codebase should follow this pattern:\n\n```typescript\nimport { getSupabaseClient } from \"@/lib/supabaseClient\";\n\nasync function makeAuthenticatedRequest() {\n  const supabase = await getSupabaseClient();\n  const { data: { session } } = await supabase.auth.getSession();\n  \n  if (!session?.access_token) {\n    throw new Error(\"Not authenticated\");\n  }\n\n  const response = await fetch(\"/api/your-endpoint\", {\n    method: \"POST\", // or GET, PATCH, DELETE\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"Authorization\": `Bearer ${session.access_token}`,\n    },\n    body: JSON.stringify(yourData),\n  });\n  \n  if (!response.ok) {\n    throw new Error(\"Request failed\");\n  }\n  \n  return response.json();\n}\n```\n\n## Files Modified\n\n- `client/src/hooks/useProfile.ts` - Added Supabase auth header and logging to `patchProfile` function\n\n## Related Documentation\n\n- See `CONSENT_FIELDS_FIX_SUMMARY.md` for backend camelCase/snake_case alignment\n- See `replit.md` for full authentication flow documentation\n","path":null,"size_bytes":5276,"size_tokens":null},"client/src/lib/SettingsProvider.tsx":{"content":"import { createContext, useContext, useEffect, ReactNode } from 'react';\nimport { useAuth } from '@/hooks/useAuth';\nimport { useUserSettings } from '@/hooks/useUserSettings';\nimport { readLocal, writeLocal, CACHE_KEYS } from '@/lib/localCache';\nimport { soundManager } from '@/lib/sounds';\n\ninterface SettingsContextValue {\n  // Context value can be extended in the future if needed\n}\n\nconst SettingsContext = createContext<SettingsContextValue>({});\n\nexport function useSettings() {\n  return useContext(SettingsContext);\n}\n\ninterface SettingsProviderProps {\n  children: ReactNode;\n}\n\ninterface CachedSettings {\n  textSize?: 'small' | 'medium' | 'large';\n  soundsEnabled?: boolean;\n  darkMode?: boolean;\n  cluesEnabled?: boolean;\n}\n\nfunction applySettingsToDOM(settings: CachedSettings) {\n  // Apply text size\n  const textSize = settings.textSize || 'medium';\n  document.documentElement.style.setProperty(\n    '--text-scale',\n    textSize === 'small' ? '0.875' : textSize === 'large' ? '1.125' : '1'\n  );\n\n  // Apply dark mode\n  const darkMode = settings.darkMode ?? false;\n  document.documentElement.classList.toggle('dark', darkMode);\n\n  // Apply sound setting (default to OFF for new users)\n  const soundsEnabled = settings.soundsEnabled ?? false;\n  soundManager.setEnabled(soundsEnabled);\n}\n\nexport function SettingsProvider({ children }: SettingsProviderProps) {\n  const { isAuthenticated } = useAuth();\n  const { settings } = useUserSettings();\n\n  // Load and apply settings from cache immediately on mount (instant, no flicker)\n  useEffect(() => {\n    const cachedSettings = readLocal<CachedSettings>(CACHE_KEYS.SETTINGS);\n    \n    if (cachedSettings) {\n      console.log('[SettingsProvider] Applying cached settings:', cachedSettings);\n      applySettingsToDOM(cachedSettings);\n    } else if (!isAuthenticated) {\n      // For guest users, load from localStorage\n      const guestSettings: CachedSettings = {\n        textSize: (localStorage.getItem('textSize') as 'small' | 'medium' | 'large') || 'medium',\n        soundsEnabled: localStorage.getItem('soundsEnabled') !== null \n          ? localStorage.getItem('soundsEnabled') === 'true' \n          : false,\n        darkMode: localStorage.getItem('theme') === 'dark',\n        cluesEnabled: localStorage.getItem('cluesEnabled') !== null\n          ? localStorage.getItem('cluesEnabled') === 'true'\n          : true,\n      };\n      console.log('[SettingsProvider] Applying guest settings from localStorage:', guestSettings);\n      applySettingsToDOM(guestSettings);\n    }\n  }, []); // Run once on mount\n\n  // Background reconciliation: Apply fresh settings from Supabase when they arrive\n  useEffect(() => {\n    if (isAuthenticated && settings) {\n      console.log('[SettingsProvider] Applying fresh Supabase settings:', settings);\n      \n      const freshSettings: CachedSettings = {\n        textSize: (settings.textSize as 'small' | 'medium' | 'large') || 'medium',\n        soundsEnabled: settings.soundsEnabled ?? false,\n        darkMode: settings.darkMode ?? false,\n        cluesEnabled: settings.cluesEnabled ?? true,\n      };\n      \n      applySettingsToDOM(freshSettings);\n      \n      // Update cache with fresh data\n      writeLocal(CACHE_KEYS.SETTINGS, freshSettings);\n    }\n  }, [isAuthenticated, settings]);\n\n  return (\n    <SettingsContext.Provider value={{}}>\n      {children}\n    </SettingsContext.Provider>\n  );\n}\n","path":null,"size_bytes":3385,"size_tokens":null},"client/src/hooks/useUserDateFormat.ts":{"content":"/**\n * Custom hook to access user's date format preferences\n * Returns the effective date format based on user settings and region\n */\n\nimport { useMemo } from \"react\";\nimport { useUserSettings } from \"./useUserSettings\";\nimport { useProfile } from \"./useProfile\";\nimport {\n  getEffectiveDateFormat,\n  type DateFormatPreference,\n  getPlaceholders,\n  getFormatDisplay,\n  formatCanonicalDate,\n  parseUserDate,\n  validateGuess,\n  formatCanonicalDateWithOrdinal\n} from \"@/lib/dateFormat\";\nimport { getCachedFormatSettings } from \"@/lib/formatCache\";\n\nexport function useUserDateFormat() {\n  const { settings, isLoading: settingsLoading } = useUserSettings();\n  const { profile, isLoading: profileLoading } = useProfile();\n\n  // Get cached values for instant initialization\n  const cachedSettings = useMemo(() => getCachedFormatSettings(), []);\n\n  // Get effective date format based on user preferences\n  // Use cached values if server data isn't loaded yet\n  const dateFormat: DateFormatPreference = getEffectiveDateFormat(\n    (settings?.dateFormatPreference || cachedSettings.dateFormatPreference) as DateFormatPreference | undefined,\n    settings?.useRegionDefault ?? cachedSettings.useRegionDefault,\n    profile?.region || cachedSettings.region,\n    (settings?.digitPreference || cachedSettings.digitPreference) as '6' | '8' | undefined\n  );\n\n  // Only consider it loading if we have no data at all (not even cached)\n  // If we have cached data, we can render immediately even if server data is loading\n  const hasAnyData = settings || profile || cachedSettings.region;\n  const isLoading = (settingsLoading || profileLoading) && !hasAnyData;\n\n  const placeholders = getPlaceholders(dateFormat);\n  const formatDisplay = getFormatDisplay(dateFormat);\n  const numDigits = dateFormat.endsWith('yyyy') ? 8 : 6;\n  const isUK = dateFormat.startsWith('dd');\n  const isUS = dateFormat.startsWith('mm');\n\n  return {\n    // Core format info\n    dateFormat,\n    numDigits,\n    isUK,\n    isUS,\n    isLoading,\n    \n    // Display helpers\n    placeholders,\n    formatDisplay,\n    \n    // Formatting functions\n    formatCanonicalDate: (canonicalDate: string) => formatCanonicalDate(canonicalDate, dateFormat),\n    parseUserDate: (input: string) => parseUserDate(input, dateFormat),\n    validateGuess: (guess: string, canonicalAnswer: string) => validateGuess(guess, canonicalAnswer, dateFormat),\n    formatWithOrdinal: formatCanonicalDateWithOrdinal,\n    \n    // Settings for reference\n    settings,\n    profile\n  };\n}\n","path":null,"size_bytes":2503,"size_tokens":null},"client/src/lib/formatCache.ts":{"content":"/**\n * LocalStorage caching for date format settings\n * Provides instant format initialization before async data loads\n */\n\nconst CACHE_KEY_REGION = 'cached-region';\nconst CACHE_KEY_DIGIT_PREF = 'cached-digit-preference';\nconst CACHE_KEY_USE_REGION_DEFAULT = 'cached-use-region-default';\nconst CACHE_KEY_DATE_FORMAT_PREF = 'cached-date-format-preference';\n\nexport interface CachedFormatSettings {\n  region?: string | null;\n  digitPreference?: '6' | '8' | null;\n  useRegionDefault?: boolean | null;\n  dateFormatPreference?: string | null;\n}\n\n/**\n * Get cached format settings from localStorage\n */\nexport function getCachedFormatSettings(): CachedFormatSettings {\n  try {\n    const region = localStorage.getItem(CACHE_KEY_REGION);\n    const digitPreference = localStorage.getItem(CACHE_KEY_DIGIT_PREF) as '6' | '8' | null;\n    const useRegionDefault = localStorage.getItem(CACHE_KEY_USE_REGION_DEFAULT);\n    const dateFormatPreference = localStorage.getItem(CACHE_KEY_DATE_FORMAT_PREF);\n\n    return {\n      region: region || null,\n      digitPreference: digitPreference || null,\n      useRegionDefault: useRegionDefault ? JSON.parse(useRegionDefault) : null,\n      dateFormatPreference: dateFormatPreference || null,\n    };\n  } catch (error) {\n    console.error('[formatCache] Error reading cache:', error);\n    return {};\n  }\n}\n\n/**\n * Update cached region in localStorage\n */\nexport function setCachedRegion(region: string | null | undefined) {\n  try {\n    if (region) {\n      localStorage.setItem(CACHE_KEY_REGION, region);\n    } else {\n      localStorage.removeItem(CACHE_KEY_REGION);\n    }\n  } catch (error) {\n    console.error('[formatCache] Error setting region:', error);\n  }\n}\n\n/**\n * Update cached digit preference in localStorage\n */\nexport function setCachedDigitPreference(digitPreference: '6' | '8' | null | undefined) {\n  try {\n    if (digitPreference) {\n      localStorage.setItem(CACHE_KEY_DIGIT_PREF, digitPreference);\n    } else {\n      localStorage.removeItem(CACHE_KEY_DIGIT_PREF);\n    }\n  } catch (error) {\n    console.error('[formatCache] Error setting digit preference:', error);\n  }\n}\n\n/**\n * Update cached useRegionDefault setting in localStorage\n */\nexport function setCachedUseRegionDefault(useRegionDefault: boolean | null | undefined) {\n  try {\n    if (useRegionDefault !== null && useRegionDefault !== undefined) {\n      localStorage.setItem(CACHE_KEY_USE_REGION_DEFAULT, JSON.stringify(useRegionDefault));\n    } else {\n      localStorage.removeItem(CACHE_KEY_USE_REGION_DEFAULT);\n    }\n  } catch (error) {\n    console.error('[formatCache] Error setting useRegionDefault:', error);\n  }\n}\n\n/**\n * Update cached date format preference in localStorage\n */\nexport function setCachedDateFormatPreference(dateFormatPreference: string | null | undefined) {\n  try {\n    if (dateFormatPreference) {\n      localStorage.setItem(CACHE_KEY_DATE_FORMAT_PREF, dateFormatPreference);\n    } else {\n      localStorage.removeItem(CACHE_KEY_DATE_FORMAT_PREF);\n    }\n  } catch (error) {\n    console.error('[formatCache] Error setting date format preference:', error);\n  }\n}\n\n/**\n * Update all cached format settings at once\n */\nexport function setCachedFormatSettings(settings: CachedFormatSettings) {\n  setCachedRegion(settings.region);\n  setCachedDigitPreference(settings.digitPreference);\n  setCachedUseRegionDefault(settings.useRegionDefault);\n  setCachedDateFormatPreference(settings.dateFormatPreference);\n}\n\n/**\n * Clear all cached format settings\n */\nexport function clearCachedFormatSettings() {\n  try {\n    localStorage.removeItem(CACHE_KEY_REGION);\n    localStorage.removeItem(CACHE_KEY_DIGIT_PREF);\n    localStorage.removeItem(CACHE_KEY_USE_REGION_DEFAULT);\n    localStorage.removeItem(CACHE_KEY_DATE_FORMAT_PREF);\n  } catch (error) {\n    console.error('[formatCache] Error clearing cache:', error);\n  }\n}\n","path":null,"size_bytes":3827,"size_tokens":null},"client/src/lib/pageAnimations.ts":{"content":"/**\n * Centralized page animation variants for framer-motion\n */\n\nexport const pageVariants = {\n  fadeIn: {\n    initial: { opacity: 0 },\n    animate: { opacity: 1 },\n    exit: { opacity: 0 },\n  },\n  slideLeft: {\n    initial: { x: '100%', opacity: 0 },\n    animate: { x: 0, opacity: 1 },\n    exit: { x: '-100%', opacity: 0 },\n  },\n  slideRight: {\n    initial: { x: '-100%', opacity: 0 },\n    animate: { x: 0, opacity: 1 },\n    exit: { x: '100%', opacity: 0 },\n  },\n  slideDown: {\n    initial: { y: '-100%', opacity: 0 },\n    animate: { y: 0, opacity: 1 },\n    exit: { y: '100%', opacity: 0 },\n  },\n  slideUp: {\n    initial: { y: '100%', opacity: 0 },\n    animate: { y: 0, opacity: 1 },\n    exit: { y: '-100%', opacity: 0 },\n  },\n};\n\nexport const pageTransition = {\n  type: 'tween',\n  ease: 'easeInOut',\n  duration: 0.3,\n};\n","path":null,"size_bytes":822,"size_tokens":null},"client/src/contexts/GameModeContext.tsx":{"content":"import { createContext, useContext, useState, useEffect, ReactNode } from 'react';\n\nexport type GameMode = 'global' | 'local';\n\ninterface GameModeContextType {\n  gameMode: GameMode;\n  setGameMode: (mode: GameMode) => void;\n  isGlobalMode: boolean;\n  isLocalMode: boolean;\n  forceGlobalMode: () => void;\n}\n\nconst GameModeContext = createContext<GameModeContextType | undefined>(undefined);\n\nconst GAME_MODE_STORAGE_KEY = 'elementle_game_mode';\n\ninterface GameModeProviderProps {\n  children: ReactNode;\n}\n\nexport function GameModeProvider({ children }: GameModeProviderProps) {\n  const [gameMode, setGameModeState] = useState<GameMode>(() => {\n    // Always initialize to 'global' - guests should see Global mode\n    // Authenticated users will have their preference applied after auth check\n    return 'global';\n  });\n\n  const setGameMode = (mode: GameMode) => {\n    setGameModeState(mode);\n    localStorage.setItem(GAME_MODE_STORAGE_KEY, mode);\n  };\n\n  // Force global mode (used when user logs out or for guests)\n  const forceGlobalMode = () => {\n    setGameModeState('global');\n    localStorage.setItem(GAME_MODE_STORAGE_KEY, 'global');\n  };\n\n  const value: GameModeContextType = {\n    gameMode,\n    setGameMode,\n    isGlobalMode: gameMode === 'global',\n    isLocalMode: gameMode === 'local',\n    forceGlobalMode,\n  };\n\n  return (\n    <GameModeContext.Provider value={value}>\n      {children}\n    </GameModeContext.Provider>\n  );\n}\n\nexport function useGameMode() {\n  const context = useContext(GameModeContext);\n  if (context === undefined) {\n    throw new Error('useGameMode must be used within a GameModeProvider');\n  }\n  return context;\n}\n","path":null,"size_bytes":1644,"size_tokens":null},"client/src/components/ModeToggle.tsx":{"content":"import { useEffect, useRef, useMemo } from 'react';\nimport { motion } from 'framer-motion';\nimport { useGameMode, type GameMode } from '@/contexts/GameModeContext';\nimport { useAuth } from '@/hooks/useAuth';\nimport { useProfile } from '@/hooks/useProfile';\nimport { readLocal, CACHE_KEYS } from '@/lib/localCache';\nimport type { UserProfile } from \"@shared/schema\";\n\ninterface ModeToggleProps {\n  onModeChange?: (mode: GameMode) => void;\n  onLocalClickGuest?: () => void;\n  globalLabel?: string;\n  localLabel?: string;\n}\n\nexport function ModeToggle({ onModeChange, onLocalClickGuest, globalLabel, localLabel: externalLocalLabel }: ModeToggleProps) {\n  const { gameMode, setGameMode, isGlobalMode } = useGameMode();\n  const { isAuthenticated } = useAuth();\n  const { profile } = useProfile();\n  const toggleRef = useRef<HTMLDivElement>(null);\n\n  // Get cached profile for instant display\n  const cachedProfile = useMemo(() => readLocal<UserProfile>(CACHE_KEYS.PROFILE), []);\n\n  // Determine local label with name length check\n  const localLabel = useMemo(() => {\n    if (externalLocalLabel) return externalLocalLabel;\n    \n    const firstName = profile?.firstName || cachedProfile?.firstName;\n    if (isAuthenticated && firstName) {\n      // If name is 12+ characters, use \"Personal\" instead\n      return firstName.length >= 12 ? 'Personal' : firstName;\n    }\n    return 'Personal';\n  }, [isAuthenticated, profile?.firstName, cachedProfile?.firstName, externalLocalLabel]);\n\n  // Calculate if we need a wider toggle (for longer names)\n  const needsWiderToggle = useMemo(() => {\n    const globalLen = (globalLabel || 'UK Edition').length;\n    const localLen = localLabel.length;\n    return globalLen > 10 || localLen > 8;\n  }, [globalLabel, localLabel]);\n\n  // Calculate if we need smaller text (to prevent overflow)\n  const needsSmallerText = useMemo(() => {\n    const globalLen = (globalLabel || 'UK Edition').length;\n    const localLen = localLabel.length;\n    return globalLen > 12 || localLen > 10;\n  }, [globalLabel, localLabel]);\n\n  const handleToggle = (mode: GameMode) => {\n    if (mode === 'local' && !isAuthenticated && onLocalClickGuest) {\n      onLocalClickGuest();\n      return;\n    }\n    setGameMode(mode);\n    onModeChange?.(mode);\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent, mode: GameMode) => {\n    if (e.key === 'Enter' || e.key === ' ') {\n      e.preventDefault();\n      handleToggle(mode);\n    } else if (e.key === 'ArrowLeft' && mode === 'local') {\n      e.preventDefault();\n      handleToggle('global');\n    } else if (e.key === 'ArrowRight' && mode === 'global') {\n      e.preventDefault();\n      handleToggle('local');\n    }\n  };\n\n  useEffect(() => {\n    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;\n    if (prefersReducedMotion && toggleRef.current) {\n      toggleRef.current.style.transition = 'none';\n    }\n  }, []);\n\n  const toggleWidth = needsWiderToggle ? 'w-56' : 'w-48';\n  const textSize = needsSmallerText ? 'text-xs' : 'text-sm';\n\n  return (\n    <div \n      ref={toggleRef}\n      className={`relative inline-flex items-center rounded-full bg-muted p-1 ${toggleWidth} h-10`}\n      data-testid=\"toggle-mode\"\n      role=\"tablist\"\n      aria-label=\"Game mode selection\"\n    >\n      {/* Animated slider background */}\n      <motion.div\n        className=\"absolute top-1 bottom-1 w-[calc(50%-4px)] rounded-full bg-background shadow-sm\"\n        initial={false}\n        animate={{\n          left: isGlobalMode ? '4px' : 'calc(50% + 0px)',\n        }}\n        transition={{\n          type: 'spring',\n          stiffness: 300,\n          damping: 30,\n        }}\n        data-testid=\"toggle-slider\"\n      />\n\n      {/* Global button */}\n      <button\n        onClick={() => handleToggle('global')}\n        onKeyDown={(e) => handleKeyDown(e, 'global')}\n        className={`\n          relative z-10 flex-1 ${textSize} font-medium transition-colors duration-200 truncate px-1\n          ${isGlobalMode ? 'text-foreground' : 'text-muted-foreground'}\n        `}\n        data-testid=\"button-mode-global\"\n        role=\"tab\"\n        aria-selected={isGlobalMode}\n        aria-controls=\"global-pane\"\n        tabIndex={isGlobalMode ? 0 : -1}\n      >\n        {globalLabel || 'UK Edition'}\n      </button>\n\n      {/* Local/Personal button */}\n      <button\n        onClick={() => handleToggle('local')}\n        onKeyDown={(e) => handleKeyDown(e, 'local')}\n        className={`\n          relative z-10 flex-1 ${textSize} font-medium transition-colors duration-200 truncate px-1\n          ${!isGlobalMode ? 'text-foreground' : 'text-muted-foreground'}\n        `}\n        data-testid=\"button-mode-local\"\n        role=\"tab\"\n        aria-selected={!isGlobalMode}\n        aria-controls=\"local-pane\"\n        tabIndex={!isGlobalMode ? 0 : -1}\n      >\n        {localLabel}\n      </button>\n    </div>\n  );\n}\n","path":null,"size_bytes":4862,"size_tokens":null},"client/src/hooks/useModeController.ts":{"content":"import { useState, useEffect, useRef, useCallback } from 'react';\nimport { useMotionValue, animate } from 'framer-motion';\nimport { useGameMode } from '@/contexts/GameModeContext';\nimport { useAuth } from '@/hooks/useAuth';\n\nexport function useModeController(onGuestRestriction?: () => void) {\n  const { gameMode, setGameMode } = useGameMode();\n  const { isAuthenticated } = useAuth();\n  const [containerWidth, setContainerWidth] = useState(0);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const [isDesktop, setIsDesktop] = useState(false);\n  const swipeStartX = useRef<number>(0);\n  \n  const x = useMotionValue(0);\n\n  useEffect(() => {\n    const checkDesktop = () => {\n      setIsDesktop(window.innerWidth >= 1024);\n    };\n    \n    checkDesktop();\n    window.addEventListener('resize', checkDesktop);\n    return () => window.removeEventListener('resize', checkDesktop);\n  }, []);\n\n  useEffect(() => {\n    const updateWidth = () => {\n      if (containerRef.current) {\n        setContainerWidth(containerRef.current.offsetWidth);\n      }\n    };\n\n    updateWidth();\n    \n    const resizeObserver = new ResizeObserver(updateWidth);\n    if (containerRef.current) {\n      resizeObserver.observe(containerRef.current);\n    }\n\n    return () => {\n      resizeObserver.disconnect();\n    };\n  }, []);\n\n  const snapTo = useCallback((mode: 'global' | 'local') => {\n    // Prevent guests from accessing Local mode\n    if (mode === 'local' && !isAuthenticated) {\n      if (onGuestRestriction) {\n        onGuestRestriction();\n      }\n      // Snap back to global\n      if (!isDesktop && containerWidth > 0) {\n        animate(x, 0, {\n          type: 'spring',\n          stiffness: 300,\n          damping: 30,\n          mass: 1,\n        });\n      }\n      return;\n    }\n\n    if (isDesktop) {\n      setGameMode(mode);\n      return;\n    }\n\n    const targetX = mode === 'global' ? 0 : -containerWidth;\n    \n    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;\n    \n    if (prefersReducedMotion) {\n      x.set(targetX);\n    } else {\n      animate(x, targetX, {\n        type: 'spring',\n        stiffness: 300,\n        damping: 30,\n        mass: 1,\n      });\n    }\n    \n    setGameMode(mode);\n  }, [containerWidth, setGameMode, x, isDesktop, isAuthenticated, onGuestRestriction]);\n\n  useEffect(() => {\n    if (!isDesktop && containerWidth > 0) {\n      const targetX = gameMode === 'global' ? 0 : -containerWidth;\n      x.set(targetX);\n    }\n  }, [gameMode, containerWidth, x, isDesktop]);\n\n  const handleSwipeStart = useCallback(() => {\n    if (isDesktop || containerWidth === 0) return;\n    // Capture the current X position when swipe starts\n    swipeStartX.current = x.get();\n  }, [x, isDesktop, containerWidth]);\n\n  const handleSwiping = useCallback((deltaX: number) => {\n    if (isDesktop || containerWidth === 0) return;\n    \n    // Apply deltaX directly to the starting position for smooth 1:1 tracking\n    const newX = Math.min(0, Math.max(-containerWidth, swipeStartX.current + deltaX));\n    x.set(newX);\n  }, [x, containerWidth, isDesktop]);\n\n  const handleSwiped = useCallback((velocity: number, direction: 'Left' | 'Right') => {\n    if (isDesktop || containerWidth === 0) return;\n    \n    const currentX = x.get();\n    const threshold = containerWidth / 2;\n    const velocityThreshold = 0.5; // Minimum velocity to trigger momentum-based snap\n    \n    // If high velocity, use direction for snap decision\n    if (Math.abs(velocity) > velocityThreshold) {\n      if (direction === 'Left') {\n        snapTo('local');\n      } else {\n        snapTo('global');\n      }\n    } else {\n      // Otherwise use position threshold\n      if (Math.abs(currentX) < threshold) {\n        snapTo('global');\n      } else {\n        snapTo('local');\n      }\n    }\n  }, [containerWidth, snapTo, x, isDesktop]);\n\n  return {\n    containerRef,\n    x,\n    gameMode,\n    snapTo,\n    handleSwipeStart,\n    handleSwiping,\n    handleSwiped,\n    isDesktop,\n  };\n}\n","path":null,"size_bytes":3973,"size_tokens":null},"client/src/components/ui/inline-help.tsx":{"content":"import { Info } from \"lucide-react\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { cn } from \"@/lib/utils\";\n\ninterface InlineHelpProps {\n  children: React.ReactNode;\n  maxWidth?: string;\n  className?: string;\n  \"data-testid\"?: string;\n}\n\nexport function InlineHelp({ \n  children, \n  maxWidth = \"max-w-xs\",\n  className,\n  \"data-testid\": testId\n}: InlineHelpProps) {\n  return (\n    <Popover>\n      <PopoverTrigger asChild>\n        <button \n          type=\"button\" \n          className=\"inline-flex items-center justify-center w-4 h-4 text-xs rounded-full border border-muted-foreground/30 text-muted-foreground hover:bg-muted transition-colors\"\n          data-testid={testId}\n        >\n          <Info className=\"w-3 h-3\" />\n        </button>\n      </PopoverTrigger>\n      <PopoverContent \n        className={cn(\"text-sm\", maxWidth, className)}\n        side=\"top\"\n        align=\"start\"\n      >\n        {children}\n      </PopoverContent>\n    </Popover>\n  );\n}\n","path":null,"size_bytes":1003,"size_tokens":null},"client/src/components/PostcodeAutocomplete.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { Input } from \"@/components/ui/input\";\nimport { cn } from \"@/lib/utils\";\nimport { Loader2 } from \"lucide-react\";\n\ninterface PostcodeAutocompleteProps {\n  value: string;\n  onChange: (value: string) => void;\n  placeholder?: string;\n  className?: string;\n  required?: boolean;\n  \"data-testid\"?: string;\n}\n\n// Helper: Normalize postcode format (uppercase, canonical spacing)\nfunction normalizePostcode(input: string, canonicalFormat?: string): string {\n  const clean = input.replace(/\\s/g, \"\").toUpperCase();\n  if (canonicalFormat) {\n    const cleanCanonical = canonicalFormat.replace(/\\s/g, \"\").toUpperCase();\n    if (clean === cleanCanonical) {\n      return canonicalFormat;\n    }\n  }\n  return clean;\n}\n\nexport function PostcodeAutocomplete({\n  value,\n  onChange,\n  placeholder = \"Enter postcode\",\n  className,\n  required = false,\n  \"data-testid\": testId,\n}: PostcodeAutocompleteProps) {\n  const [suggestions, setSuggestions] = useState<string[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [showSuggestions, setShowSuggestions] = useState(false);\n  const [selectedIndex, setSelectedIndex] = useState(-1);\n  const [validPostcodes, setValidPostcodes] = useState<Set<string>>(new Set());\n  const [isValid, setIsValid] = useState(true);\n  const [previewText, setPreviewText] = useState(\"\");\n  const [errorMessage, setErrorMessage] = useState(\"\");\n  const debounceTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const blurTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const suggestionsRef = useRef<HTMLUListElement>(null);\n  const isFocusedRef = useRef(false);\n\n  // Compute ONLY the remaining characters for grey preview\n  const updatePreview = (currentValue: string, suggestionsList: string[]) => {\n    if (!currentValue || suggestionsList.length === 0) {\n      setPreviewText(\"\");\n      return;\n    }\n    const firstMatch = suggestionsList[0];\n    const cleanValue = currentValue.replace(/\\s/g, \"\").toUpperCase();\n    const cleanMatch = firstMatch.replace(/\\s/g, \"\").toUpperCase();\n    if (cleanMatch.startsWith(cleanValue)) {\n      setPreviewText(firstMatch);\n    } else {\n      setPreviewText(\"\");\n    }\n  };\n\n  // Fetch suggestions from Postcodes.io\n  const fetchSuggestions = async (input: string) => {\n    const cleanInput = input.replace(/\\s/g, \"\").toUpperCase();\n    if (!cleanInput || cleanInput.length < 1) {\n      setSuggestions([]);\n      setShowSuggestions(false);\n      setValidPostcodes(new Set());\n      return;\n    }\n\n    setLoading(true);\n    try {\n      const res = await fetch(\n        `https://api.postcodes.io/postcodes?q=${encodeURIComponent(cleanInput)}`\n      );\n      const data = await res.json();\n\n      if (data.result) {\n        const postcodes = data.result.slice(0, 20).map((r: any) => r.postcode);\n        setSuggestions(postcodes);\n        setValidPostcodes(new Set(postcodes));\n        setShowSuggestions(isFocusedRef.current && postcodes.length > 0);\n        updatePreview(input, postcodes);\n      } else {\n        setSuggestions([]);\n        setValidPostcodes(new Set());\n        setShowSuggestions(false);\n        setPreviewText(\"\");\n      }\n    } catch (error) {\n      console.error(\"Error fetching postcodes:\", error);\n      setSuggestions([]);\n      setValidPostcodes(new Set());\n      setShowSuggestions(false);\n      setPreviewText(\"\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n\n  // Validate a specific postcode value (space-insensitive) using Postcodes.io\n  const validatePostcode = async (postcodeValue: string): Promise<boolean> => {\n    if (!postcodeValue || postcodeValue.length < 2) {\n      return true; // Empty or too short is acceptable (not invalid)\n    }\n\n    try {\n      const cleanValue = postcodeValue.replace(/\\s/g, \"\").toUpperCase();\n\n      // Call Postcodes.io to validate\n      const res = await fetch(\n        `https://api.postcodes.io/postcodes/${encodeURIComponent(cleanValue)}`\n      );\n      const data = await res.json();\n\n      // Postcodes.io returns { status: 200, result: {...} } if valid\n      return data && data.status === 200 && !!data.result;\n    } catch (error) {\n      console.error(\"Error validating postcode:\", error);\n      return false;\n    }\n  };\n\n  // Debounced search\n  const handleInputChange = (newValue: string) => {\n    onChange(newValue);\n    setSelectedIndex(-1);\n    setPreviewText(\"\"); // Clear preview while typing\n\n    // Reset validation state while typing (user is still editing)\n    if (newValue) {\n      setIsValid(true);\n      setErrorMessage(\"\");\n    } else {\n      // Empty is valid\n      setIsValid(true);\n      setErrorMessage(\"\");\n      setPreviewText(\"\");\n    }\n\n    // Clear existing timer\n    if (debounceTimerRef.current) {\n      clearTimeout(debounceTimerRef.current);\n    }\n\n    // Set new timer (300ms debounce)\n    debounceTimerRef.current = setTimeout(() => {\n      fetchSuggestions(newValue);\n    }, 300);\n  };\n\n  // Handle suggestion selection\n  const selectSuggestion = (suggestion: string) => {\n    // Cancel any pending blur validation since we're selecting a valid value\n    if (blurTimerRef.current) {\n      clearTimeout(blurTimerRef.current);\n      blurTimerRef.current = null;\n    }\n\n    onChange(suggestion);\n    setSuggestions([]);\n    setShowSuggestions(false);\n    setSelectedIndex(-1);\n    setIsValid(true);\n    setErrorMessage(\"\");\n    setPreviewText(\"\");\n  };\n\n  // Auto-complete with preview or validate on blur\n  const handleBlur = () => {\n    isFocusedRef.current = false;\n\n    // Clear any existing blur timer\n    if (blurTimerRef.current) {\n      clearTimeout(blurTimerRef.current);\n    }\n\n    blurTimerRef.current = setTimeout(async () => {\n      if (isFocusedRef.current) {\n        return;\n      }\n\n      setShowSuggestions(false);\n      setSelectedIndex(-1);\n\n      const currentValue = inputRef.current?.value || \"\";\n\n      // If blank, allow blur (empty is valid)\n      if (!currentValue) {\n        setIsValid(true);\n        setErrorMessage(\"\");\n        setPreviewText(\"\");\n        return;\n      }\n\n      // If there's a preview, auto-commit it\n      if (previewText && currentValue) {\n        const cleanValue = currentValue.replace(/\\s/g, \"\").toUpperCase();\n        const cleanPreview = previewText.replace(/\\s/g, \"\").toUpperCase();\n\n        if (cleanPreview.startsWith(cleanValue)) {\n          onChange(previewText);\n          setIsValid(true);\n          setErrorMessage(\"\");\n          setPreviewText(\"\");\n          return;\n        }\n      }\n\n      // Check against cached valid postcodes first (EXACT MATCH required)\n      const cleanCurrent = currentValue.replace(/\\s/g, \"\").toUpperCase();\n      const matchedPostcode = Array.from(validPostcodes).find(\n        (pc) => pc.replace(/\\s/g, \"\").toUpperCase() === cleanCurrent\n      );\n\n      if (matchedPostcode) {\n        onChange(matchedPostcode);\n        setIsValid(true);\n        setErrorMessage(\"\");\n        setPreviewText(\"\");\n        return;\n      }\n\n      // Postcode does NOT match any suggestion - PREVENT BLUR by refocusing\n      setIsValid(false);\n      setErrorMessage(\"Please select a postcode from the dropdown list or clear the field.\");\n      setPreviewText(\"\");\n      \n      // Refocus input to prevent blur and keep field active\n      inputRef.current?.focus();\n    }, 200);\n  };\n\n\n  const handleFocus = () => {\n    isFocusedRef.current = true;\n\n    // Cancel any pending blur validation since input regained focus\n    if (blurTimerRef.current) {\n      clearTimeout(blurTimerRef.current);\n      blurTimerRef.current = null;\n    }\n\n    if (suggestions.length > 0) {\n      setShowSuggestions(true);\n    }\n  };\n\n  // Validate when value prop changes (e.g., prefilled data)\n  useEffect(() => {\n    if (value && value.length >= 2 && validPostcodes.size === 0) {\n      // Validate prefilled values using Postcodes.io\n      validatePostcode(value).then((isValid) => {\n        setIsValid(isValid);\n      });\n    }\n  }, [value]);\n\n  // Handle keyboard navigation and Tab completion\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\n    // Tab key: auto-complete with preview\n    if (e.key === \"Tab\" && previewText && value) {\n      e.preventDefault();\n      selectSuggestion(previewText);\n      return;\n    }\n\n    if (!showSuggestions || suggestions.length === 0) return;\n\n    if (e.key === \"ArrowDown\") {\n      e.preventDefault();\n      setSelectedIndex((prev) =>\n        prev < suggestions.length - 1 ? prev + 1 : prev\n      );\n    } else if (e.key === \"ArrowUp\") {\n      e.preventDefault();\n      setSelectedIndex((prev) => (prev > 0 ? prev - 1 : 0));\n    } else if (e.key === \"Enter\" && selectedIndex >= 0) {\n      e.preventDefault();\n      selectSuggestion(suggestions[selectedIndex]);\n    } else if (e.key === \"Escape\") {\n      setShowSuggestions(false);\n      setSelectedIndex(-1);\n      setPreviewText(\"\");\n    }\n  };\n\n  // Scroll selected item into view\n  useEffect(() => {\n    if (selectedIndex >= 0 && suggestionsRef.current) {\n      const selectedItem = suggestionsRef.current.children[selectedIndex] as HTMLElement;\n      selectedItem?.scrollIntoView({ block: \"nearest\" });\n    }\n  }, [selectedIndex]);\n\n  // Click outside to close suggestions\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (\n        inputRef.current &&\n        suggestionsRef.current &&\n        !inputRef.current.contains(event.target as Node) &&\n        !suggestionsRef.current.contains(event.target as Node)\n      ) {\n        setShowSuggestions(false);\n        setSelectedIndex(-1);\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => {\n      document.removeEventListener(\"mousedown\", handleClickOutside);\n    };\n  }, []);\n\n  // Clean up timers on unmount\n  useEffect(() => {\n    return () => {\n      if (debounceTimerRef.current) {\n        clearTimeout(debounceTimerRef.current);\n      }\n      if (blurTimerRef.current) {\n        clearTimeout(blurTimerRef.current);\n      }\n    };\n  }, []);\n\n\n  return (\n    <div className=\"relative\">\n      <div className=\"relative\">\n        <Input\n          ref={inputRef}\n          type=\"text\"\n          value={value}\n          onChange={(e) => handleInputChange(e.target.value.toUpperCase())}\n          onKeyDown={handleKeyDown}\n          onBlur={handleBlur}\n          onFocus={handleFocus}\n          placeholder={placeholder}\n          className={cn(\n            className,\n            !isValid && \"border-destructive focus-visible:ring-destructive\"\n          )}\n          required={required}\n          data-testid={testId}\n          autoComplete=\"off\"\n        />\n\n        {/* Grey preview text overlay */}\n        {previewText && value && (() => {\n          const cleanValue = value.replace(/\\s/g, \"\").toUpperCase();\n          const cleanPreview = previewText.replace(/\\s/g, \"\").toUpperCase();\n\n          if (cleanPreview.startsWith(cleanValue)) {\n            // Find where user's input ends in the preview (with spaces)\n            let charCount = 0;\n            let previewIndex = 0;\n            while (charCount < cleanValue.length && previewIndex < previewText.length) {\n              if (previewText[previewIndex] !== \" \") {\n                charCount++;\n              }\n              previewIndex++;\n            }\n\n            const remaining = previewText.slice(previewIndex);\n\n            return (\n              <div className=\"absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none flex text-sm\">\n                <span className=\"opacity-0\">{value}</span>\n                <span className=\"text-muted-foreground/40\">{remaining}</span>\n              </div>\n            );\n          }\n          return null;\n        })()}\n\n        {loading && (\n          <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n            <Loader2 className=\"h-4 w-4 animate-spin text-muted-foreground\" />\n          </div>\n        )}\n      </div>\n\n      {errorMessage && (\n        <p\n          className=\"text-xs text-destructive mt-1\"\n          data-testid={`${testId}-error`}\n        >\n          {errorMessage}\n        </p>\n      )}\n\n      {showSuggestions && suggestions.length > 0 && (\n        <ul\n          ref={suggestionsRef}\n          className=\"absolute z-50 w-full mt-1 max-h-60 overflow-auto rounded-md border bg-popover text-popover-foreground shadow-md\"\n          data-testid={`${testId}-suggestions`}\n        >\n          {suggestions.map((suggestion, index) => (\n            <li\n              key={suggestion}\n              onClick={() => selectSuggestion(suggestion)}\n              className={cn(\n                \"px-3 py-2 cursor-pointer text-sm hover-elevate\",\n                selectedIndex === index && \"bg-accent text-accent-foreground\"\n              )}\n              data-testid={`${testId}-suggestion-${index}`}\n            >\n              {suggestion}\n            </li>\n          ))}\n        </ul>\n      )}\n    </div>\n  );\n}\n\n","path":null,"size_bytes":12921,"size_tokens":null},"client/src/components/GeneratingQuestionsScreen.tsx":{"content":"    import { useState, useEffect, useRef } from \"react\";\n    import { useSupabase } from \"@/lib/SupabaseProvider\";\n    import { useToast } from \"@/hooks/use-toast\";\n    import HamsterImageUrl from \"@assets/Question-Hamster-Blue.svg\";\n\n    type RegenerationType = 'first_login' | 'postcode_change' | 'category_change';\n\n    interface GeneratingQuestionsScreenProps {\n      userId: string;\n      region: string;\n      postcode: string;\n      onComplete: () => void;\n      regenerationType?: RegenerationType;\n      selectedCategoryIds?: number[]; // For category_change: filter event_titles to match selected categories\n      isPro?: boolean; // For postcode_change: if Pro, fetch and filter by user's saved categories\n    }\n\n    interface TextBlock {\n      id: string;\n      text: string;\n      top: number;   // percent relative to the animated container\n      left: number;  // percent relative to the animated container\n      opacity: number;\n      spawnTime: number; // ms timestamp\n    }\n\n    // Idempotency guard: prevents duplicate calculate-demand calls within a short time window\n    // Uses sessionStorage to persist across React StrictMode double-mounts\n    const DEMAND_CALL_COOLDOWN_MS = 30000; // 30 second window\n    const DEMAND_CALL_KEY_PREFIX = 'elementle_demand_call_';\n\n    function getDemandCallKey(userId: string, regenerationType: string): string {\n      return `${DEMAND_CALL_KEY_PREFIX}${userId}_${regenerationType}`;\n    }\n\n    function canCallDemand(userId: string, regenerationType: string): boolean {\n      const key = getDemandCallKey(userId, regenerationType);\n      const lastCallTime = sessionStorage.getItem(key);\n      if (!lastCallTime) return true;\n      \n      const elapsed = Date.now() - parseInt(lastCallTime, 10);\n      return elapsed >= DEMAND_CALL_COOLDOWN_MS;\n    }\n\n    function markDemandCalled(userId: string, regenerationType: string): void {\n      const key = getDemandCallKey(userId, regenerationType);\n      sessionStorage.setItem(key, Date.now().toString());\n    }\n\n    function clearDemandMark(userId: string, regenerationType: string): void {\n      const key = getDemandCallKey(userId, regenerationType);\n      sessionStorage.removeItem(key);\n    }\n\n    export function GeneratingQuestionsScreen({\n      userId,\n      region,\n      postcode,\n      onComplete,\n      regenerationType = 'first_login',\n      selectedCategoryIds,\n      isPro = false,\n    }: GeneratingQuestionsScreenProps) {\n      const supabase = useSupabase();\n      const { toast } = useToast();\n      const [textBlocks, setTextBlocks] = useState<TextBlock[]>([]);\n      const [fadeIn, setFadeIn] = useState(false);\n\n      // Animated area ref (between hamster and footer)\n      const containerRef = useRef<HTMLDivElement>(null);\n      \n      // Ref to track if sequence has started - prevents duplicate runs across re-renders\n      const sequenceStartedRef = useRef(false);\n\n      // Trigger fade-in animation\n      useEffect(() => {\n        requestAnimationFrame(() => {\n          setFadeIn(true);\n        });\n      }, []);\n\n    useEffect(() => {\n      // If we've already started the sequence, do nothing (prevents duplicate starts)\n      if (sequenceStartedRef.current) {\n        console.log(\"[GeneratingQuestions] Sequence already started, skipping effect re-run\");\n        return;\n      }\n      sequenceStartedRef.current = true;\n      \n      // Use refs to avoid effect re-run issues and to keep flags stable across renders\n      const mountedRef = { current: true };\n      const finishedRef = { current: false };\n\n      // Timing and grid constants\n      const SCREEN_DURATION = 10000; // total screen time (ms)\n      const TEXT_LIFETIME = 2500; // 2.5s visible\n      const FADE_DURATION = 1200; // fade in/out (ms)\n      const INTERVAL_MS = 1000; // new event every 1s\n      const MAX_CELLS = 6;\n\n      // Helpers\n      const rowOf = (i: number) => Math.floor(i / 2);\n\n      // Timer handles for cleanup\n      const spawnTimeouts: number[] = [];\n      let spawnInterval: number | null = null;\n      let animInterval: number | null = null;\n      let finishTimeout: number | null = null;\n\n      // Start animation loop immediately so opacity updates run while backend work proceeds\n      const startAnimationLoop = () => {\n        console.log(\"[GeneratingQuestions] startAnimationLoop()\");\n        const tickStart = Date.now();\n        animInterval = window.setInterval(() => {\n          if (!mountedRef.current) return;\n          const now = Date.now();\n          setTextBlocks((prev) =>\n            prev\n              .map((block) => {\n                const blockElapsed = now - block.spawnTime;\n                if (blockElapsed < 0) return block;\n                if (blockElapsed < FADE_DURATION) {\n                  return { ...block, opacity: Math.min(1, blockElapsed / FADE_DURATION) };\n                } else if (blockElapsed < TEXT_LIFETIME - FADE_DURATION) {\n                  return { ...block, opacity: 1 };\n                } else if (blockElapsed < TEXT_LIFETIME) {\n                  const out = (blockElapsed - (TEXT_LIFETIME - FADE_DURATION)) / FADE_DURATION;\n                  return { ...block, opacity: Math.max(0, 1 - out) };\n                }\n                return null;\n              })\n              .filter((b): b is TextBlock => b !== null)\n          );\n        }, 100);\n      };\n\n      // Main async runner\n      (async () => {\n        try {\n          console.log(\"[GeneratingQuestions] runSequence() start\");\n          startAnimationLoop();\n\n          // Step 0: session\n          const {\n            data: { session },\n          } = await supabase.auth.getSession();\n          const accessToken = session?.access_token;\n          if (!accessToken) throw new Error(\"No access token found\");\n          console.log(\"[GeneratingQuestions] got access token\");\n\n          // Step 1: fetch titles\n          // For category_change with selectedCategoryIds, filter to matching categories only\n          // For postcode_change with isPro, fetch user's saved categories and filter by them\n          // For first_login or non-Pro postcode_change, show all questions\n          console.log(\"[GeneratingQuestions] Step 1: fetching titles...\", {\n            regenerationType,\n            selectedCategoryIds: selectedCategoryIds?.length ?? 0,\n            isPro,\n          });\n          let eventTitles: string[] = [];\n          try {\n            // Determine which category IDs to use for filtering\n            let categoryIdsToFilter: number[] | undefined = selectedCategoryIds;\n            \n            // For Pro users doing postcode_change, fetch their saved categories\n            if (regenerationType === 'postcode_change' && isPro && !selectedCategoryIds) {\n              console.log(\"[GeneratingQuestions] Pro user postcode change - fetching saved categories\");\n              try {\n                const categoriesResponse = await fetch('/api/user/pro-categories', {\n                  credentials: 'include',\n                  headers: {\n                    'Authorization': `Bearer ${accessToken}`,\n                  },\n                });\n                if (categoriesResponse.ok) {\n                  const categoriesData = await categoriesResponse.json();\n                  if (categoriesData.categoryIds && Array.isArray(categoriesData.categoryIds) && categoriesData.categoryIds.length > 0) {\n                    categoryIdsToFilter = categoriesData.categoryIds;\n                    console.log(\"[GeneratingQuestions] Pro user's saved categories:\", categoryIdsToFilter);\n                  }\n                }\n              } catch (catErr) {\n                console.error(\"[GeneratingQuestions] Failed to fetch user's saved categories:\", catErr);\n              }\n            }\n            \n            // Filter by categories if we have any (category_change OR Pro postcode_change)\n            const shouldFilterByCategories = \n              (regenerationType === 'category_change' && selectedCategoryIds && selectedCategoryIds.length > 0) ||\n              (regenerationType === 'postcode_change' && isPro && categoryIdsToFilter && categoryIdsToFilter.length > 0);\n            \n            if (shouldFilterByCategories && categoryIdsToFilter && categoryIdsToFilter.length > 0) {\n              console.log(\"[GeneratingQuestions] Filtering by categories:\", categoryIdsToFilter);\n              \n              // Fetch more questions and filter client-side to ensure we get matching results\n              const { data: eventData, error: eventErr } = await supabase\n                .from(\"questions_master_region\")\n                .select(\"event_title, categories\")\n                .limit(100);\n              \n              if (eventErr) console.error(\"[GeneratingQuestions] fetch titles error\", eventErr);\n              \n              if (eventData && eventData.length) {\n                // Filter questions that have at least one matching category\n                const categorySet = new Set(categoryIdsToFilter);\n                const filteredEvents = eventData.filter((e: any) => {\n                  const questionCategories = e.categories as number[] | null;\n                  if (!questionCategories || !Array.isArray(questionCategories)) return false;\n                  return questionCategories.some(cat => categorySet.has(cat));\n                });\n                \n                console.log(\"[GeneratingQuestions] Filtered from\", eventData.length, \"to\", filteredEvents.length, \"questions\");\n                \n                if (filteredEvents.length > 0) {\n                  // Deduplicate and shuffle, then take first 30\n                  const uniqueTitles = Array.from(new Set(filteredEvents.map((e: any) => e.event_title)));\n                  const shuffled = uniqueTitles.sort(() => Math.random() - 0.5);\n                  eventTitles = shuffled.slice(0, 30).map((title: string) => title + \"...\");\n                  console.log(\"[GeneratingQuestions] fetched titles count:\", eventTitles.length, \"(filtered by selected categories, deduped)\");\n                } else {\n                  console.log(\"[GeneratingQuestions] No titles found for selected categories, using unfiltered\");\n                  // Deduplicate unfiltered as well\n                  const uniqueTitles = Array.from(new Set(eventData.map((e: any) => e.event_title)));\n                  eventTitles = uniqueTitles.slice(0, 30).map((title: string) => title + \"...\");\n                }\n              }\n            } else {\n              // For first_login or non-Pro postcode_change, fetch all questions\n              const { data: eventData, error: eventErr } = await supabase\n                .from(\"questions_master_region\")\n                .select(\"event_title\")\n                .limit(50); // Fetch more to account for duplicates\n              \n              if (eventErr) console.error(\"[GeneratingQuestions] fetch titles error\", eventErr);\n              if (eventData && eventData.length) {\n                // Deduplicate event titles to avoid showing same title twice\n                const uniqueTitles = Array.from(new Set(eventData.map((e: any) => e.event_title)));\n                // Shuffle to ensure random order (prevents same first title showing twice at start)\n                const shuffled = uniqueTitles.sort(() => Math.random() - 0.5);\n                eventTitles = shuffled.slice(0, 30).map((title: string) => title + \"...\");\n                console.log(\"[GeneratingQuestions] fetched titles count:\", eventTitles.length, \"(all categories, deduped, shuffled)\");\n              }\n            }\n          } catch (err) {\n            console.error(\"[GeneratingQuestions] fetch titles failed\", err);\n          }\n\n    // Queue + selection helpers (declare together so nothing is referenced before it exists)\n    const INITIAL_TITLES = 4;\n    const eventTitlesAll = [...eventTitles]; // keep original list if needed\n\n    // Core queue: initial reserved titles at the front, rest follow\n    const streamQueue: string[] = eventTitlesAll.slice(0, INITIAL_TITLES).concat(eventTitlesAll.slice(INITIAL_TITLES));\n\n    // Selection state and scheduling counters\n    let initialConsumed = 0; // how many of the initial reserved titles we've shown\n    const occupiedCells = new Set<number>();\n    const lastPicks: number[] = [];\n    const rowBlockCounts: Record<number, number> = { 0: 0, 1: 0, 2: 0 };\n    const baseTime = Date.now(); // used for scheduling future spawns\n    let scheduledSpawns = 0; // explicit count of how many spawns we've scheduled/used\n\n          // Helper: pick and remove a random item from the queue (for non-initial items)\n          const popRandomFromQueue = (q: string[]) => {\n            if (!q || q.length === 0) return undefined;\n            const idx = Math.floor(Math.random() * q.length);\n            const [item] = q.splice(idx, 1);\n            return item;\n          };\n\n          // Helper: get the next text to show\n          // - If we still have reserved initial titles, return them in FIFO order (shift).\n          // - Otherwise return a random item from the remaining queue.\n          const popNextText = (q: string[]) => {\n            if (!q || q.length === 0) return undefined;\n\n            // If there are still initial titles not yet consumed, return them FIFO\n            if (initialConsumed < INITIAL_TITLES && q.length > 0) {\n              const val = q.shift();\n              if (val !== undefined) {\n                initialConsumed++;\n                return val;\n              }\n              return undefined;\n            }\n\n            // Otherwise pick randomly from the rest\n            return popRandomFromQueue(q);\n          };\n\n\n    // Helper: clamp a percentage to a safe 0100 range\n    const clampPct = (v: number) => Math.max(0, Math.min(100, Number.isFinite(v) ? v : 0));\n\n    // Helper: decrement row block counters (keeps rowBlockCounts in sync)\n    const decrementRowBlocks = () => {\n      for (const r of [0, 1, 2]) {\n        if (rowBlockCounts[r] > 0) rowBlockCounts[r] = Math.max(0, rowBlockCounts[r] - 1);\n      }\n    };\n\n\n          // Helper: compute random position inside a cell, clamped so the block never overflows\n          const computePositionInCell = (cellIndex: number) => {\n            // Try to get container bounds; fall back to window size if not available\n            const bounds = containerRef.current?.getBoundingClientRect();\n            const width = bounds?.width ?? window.innerWidth;\n            const height = bounds?.height ?? window.innerHeight;\n\n            const cols = 2;\n            const rows = 3;\n            const col = cellIndex % cols;\n            const row = Math.floor(cellIndex / cols);\n\n            const cellWidth = width / cols;\n            const cellHeight = height / rows;\n\n            // Estimated rendered block size (px). Tune if you change maxWidth or font-size.\n            const EST_BLOCK_W = 160;\n            const EST_BLOCK_H = 48;\n\n            const padX = Math.min(24, cellWidth * 0.12);\n            const padY = Math.min(20, cellHeight * 0.12);\n\n            const leftPxMin = col * cellWidth + padX + EST_BLOCK_W / 2;\n            const leftPxMax = (col + 1) * cellWidth - padX - EST_BLOCK_W / 2;\n            const topPxMin = row * cellHeight + padY + EST_BLOCK_H / 2;\n            const topPxMax = (row + 1) * cellHeight - padY - EST_BLOCK_H / 2;\n\n            const safeLeftPx =\n              leftPxMax > leftPxMin ? leftPxMin + Math.random() * (leftPxMax - leftPxMin) : col * cellWidth + cellWidth / 2;\n            const safeTopPx =\n              topPxMax > topPxMin ? topPxMin + Math.random() * (topPxMax - topPxMin) : row * cellHeight + cellHeight / 2;\n\n            const leftPct = (safeLeftPx / width) * 100;\n            const topPct = (safeTopPx / height) * 100;\n\n            return { topPct, leftPct };\n          };\n\n\n\n          const pickNextCell = (): number | null => {\n            decrementRowBlocks();\n            const all = Array.from({ length: MAX_CELLS }, (_, i) => i);\n            let candidates = all.filter((i) => !occupiedCells.has(i) && !lastPicks.includes(i) && rowBlockCounts[rowOf(i)] === 0);\n            if (candidates.length === 0) candidates = all.filter((i) => !occupiedCells.has(i) && rowBlockCounts[rowOf(i)] === 0);\n            if (candidates.length === 0) candidates = all.filter((i) => !occupiedCells.has(i) && !lastPicks.includes(i));\n            if (candidates.length === 0) candidates = all.filter((i) => !occupiedCells.has(i));\n            if (candidates.length === 0) return null;\n            const choice = candidates[Math.floor(Math.random() * candidates.length)];\n            lastPicks.push(choice);\n            if (lastPicks.length > 3) lastPicks.shift();\n            rowBlockCounts[rowOf(choice)] = 3;\n            return choice;\n          };\n\n          const spawnIntoCell = (cellIndex: number, text: string) => {\n            const pos = computePositionInCell(cellIndex);\n            if (!pos) {\n              console.warn(\"[GeneratingQuestions] spawnIntoCell: no position available for cell\", cellIndex, \"text:\", text);\n              return false;\n            }\n\n            const id = `${Date.now()}-${cellIndex}`;\n            occupiedCells.add(cellIndex);\n            const spawnTime = Date.now();\n\n            console.log(\"[GeneratingQuestions] spawnIntoCell\", cellIndex, id, text);\n\n            setTextBlocks((prev) => [\n              ...prev,\n              { id, text, top: clampPct(pos.topPct), left: clampPct(pos.leftPct), opacity: 0, spawnTime },\n            ]);\n\n            const removeId = window.setTimeout(() => {\n              if (!mountedRef.current) return;\n              setTextBlocks((prev) => prev.filter((b) => b.id !== id));\n              occupiedCells.delete(cellIndex);\n              // Free up a scheduled spawn slot when a block is removed\n              scheduledSpawns = Math.max(0, scheduledSpawns - 1);\n              console.log(\"[GeneratingQuestions] removed block\", id, \"freed cell\", cellIndex, \"scheduledSpawns =\", scheduledSpawns);\n            }, TEXT_LIFETIME);\n\n\n            spawnTimeouts.push(removeId);\n            return true;\n          };\n\n\n          // Immediate first pick then interval\n          const immediatePick = () => {\n            const first = pickNextCell();\n            if (first !== null && streamQueue.length > 0) {\n              const text = popNextText(streamQueue) ?? (eventTitles.length ? eventTitles[Math.floor(Math.random() * eventTitles.length)] : \"...\");\n\n              const ok = spawnIntoCell(first, text);\n              if (!ok) streamQueue.unshift(text);\n              if (ok) {\n                console.log(\"[GeneratingQuestions] immediate spawn ok; streamQueue.length =\", streamQueue.length);\n              }\n            }\n          };\n\n          // Do an immediate pick to fill one free cell now\n          immediatePick();\n\n          // Delay starting the regular interval by one INTERVAL_MS so the immediate pick(s)\n          // don't race with the first interval tick and cause a burst at startup.\n          const startSpawnInterval = () => {\n            spawnInterval = window.setInterval(() => {\n              if (!mountedRef.current) return;\n\n              const next = pickNextCell();\n              if (next === null) return;\n\n              const text = popNextText(streamQueue) ?? (eventTitlesAll.length ? eventTitlesAll[Math.floor(Math.random() * eventTitlesAll.length)] : \"...\");\n              if (!text) return;\n\n              const ok = spawnIntoCell(next, text);\n              if (!ok) {\n                // put it back if spawn failed\n                streamQueue.unshift(text);\n              }\n            }, INTERVAL_MS);\n          };\n\n          // Start the interval after one INTERVAL_MS (push the timeout id into spawnTimeouts so cleanup clears it)\n          const initialIntervalTimeout = window.setTimeout(() => {\n            if (!mountedRef.current) return;\n            startSpawnInterval();\n          }, INTERVAL_MS);\n          spawnTimeouts.push(initialIntervalTimeout);\n\n\n\n          // ---------- Insert here (after initial spawn scheduling, before finishTimeout) ----------\n          try {\n            console.log(\"[GeneratingQuestions] Step 1c: Populating user locations...\");\n            await supabase.rpc(\"populate_user_locations\", {\n              p_user_id: userId,\n              p_postcode: postcode,\n            });\n            console.log(\"[GeneratingQuestions] populate_user_locations complete\");\n          } catch (err) {\n            console.error(\"[GeneratingQuestions] populate_user_locations failed:\", err);\n            // continue  animation should not be blocked\n          }\n\n          // Step 2: Poll location_allocation until rows exist\n          console.log(\"[GeneratingQuestions] Step 2: Polling for location allocation with user_id:\", userId);\n          let locations: Array<{ location_id: string; score: number }> = [];\n          for (let i = 0; i < 20; i++) {\n            try {\n              const { data, error } = await supabase\n                .from(\"location_allocation\")\n                .select(\"location_id, score\")\n                .eq(\"user_id\", userId)\n                .order(\"score\", { ascending: false });\n\n              if (error) {\n                console.error(\"[GeneratingQuestions] Step 2 Poll query error:\", error);\n              }\n\n              if (data && data.length > 0) {\n                locations = data as Array<{ location_id: string; score: number }>;\n                console.log(\"[GeneratingQuestions] Step 2 Poll SUCCESS - found\", locations.length, \"locations\");\n                break;\n              } else {\n                console.log(`[GeneratingQuestions] Step 2 Poll attempt ${i + 1} - no data yet`);\n              }\n            } catch (pollErr) {\n              console.error(\"[GeneratingQuestions] Step 2 Poll attempt failed:\", pollErr);\n            }\n            await new Promise((r) => setTimeout(r, 500));\n          }\n\n// Step 3: Fetch location names and insert into queue (interleaved, Option B)\nconsole.log(\"[GeneratingQuestions] Step 3: Fetching location names...\");\n\nif (Array.isArray(locations) && locations.length > 0) {\n  try {\n    const locationIds = (locations as Array<{ location_id: string; score: number }>).map((l) => l.location_id);\n    console.log(\"[GeneratingQuestions] Step 3: locationIds to fetch:\", locationIds);\n\n    const { data: locData, error: locErr } = await supabase\n      .from(\"populated_places\")\n      .select(\"id, name1\")\n      .in(\"id\", locationIds);\n\n    if (locErr) {\n      console.error(\"[GeneratingQuestions] Step 3 Fetch location names error:\", locErr);\n    }\n\n    if (locData && locData.length > 0) {\n      const locationRows = locData as Array<{ id: string; name1?: string }>;\n      const locationNames = locationRows.map((row) => (row.name1 ?? row.id) + \"...\");\n      console.log(\"[GeneratingQuestions] Step 3 Location names fetched:\", locationNames);\n\n      // Shuffle place names\n      const shuffled = locationNames.sort(() => Math.random() - 0.5);\n\n      // Compute insertion index so we don't replace the reserved opening titles\n      const insertIndex = Math.min(Math.max(0, INITIAL_TITLES - initialConsumed), streamQueue.length);\n\n      // Build a new queue that interleaves place names with existing items\n      const front = streamQueue.slice(0, insertIndex);\n      const tail = streamQueue.slice(insertIndex);\n\n      const interleaved: string[] = [];\n      const maxTakeFromTail = Math.max(0, Math.min(tail.length, Math.floor((shuffled.length + tail.length) / 2)));\n      let iPlace = 0;\n      let iTail = 0;\n\n      while (iPlace < shuffled.length || iTail < maxTakeFromTail) {\n        if (iPlace < shuffled.length) {\n          interleaved.push(shuffled[iPlace++]);\n        }\n        if (iTail < maxTakeFromTail) {\n          interleaved.push(tail[iTail++]);\n        }\n      }\n\n      const remainingTail = tail.slice(iTail);\n      const newQueue = front.concat(interleaved, remainingTail);\n\n      // Replace streamQueue contents in-place\n      streamQueue.length = 0;\n      streamQueue.push(...newQueue);\n\n      console.log(\"[GeneratingQuestions] inserted and interleaved locationNames at index\", insertIndex, \"streamQueue length:\", streamQueue.length);\n      console.log(\"[GeneratingQuestions] streamQueue sample (first 12):\", streamQueue.slice(0, 12));\n\n      // Do not fill free cells immediately here. The interval producer will consume streamQueue at a steady INTERVAL_MS pace.\n    } else {\n      console.log(\"[GeneratingQuestions] Step 3 Query returned no populated_places rows\", locData);\n    }\n  } catch (err) {\n    console.error(\"[GeneratingQuestions] Step 3 Fetch location names failed:\", err);\n  }\n} else {\n  console.log(\"[GeneratingQuestions] Step 3 Skipped - no locations\");\n}\n\n\n\n// Derive function base URL for edge functions\nconst supabaseUrl = import.meta.env.VITE_SUPABASE_URL || (supabase as any).supabaseUrl;\nif (!supabaseUrl) {\n  console.warn(\"[GeneratingQuestions] Supabase URL not available; skipping function calls\");\n} else {\n  const functionBaseUrl = supabaseUrl.replace(\".supabase.co\", \".functions.supabase.co\");\n  console.log(\"[GeneratingQuestions] Function base URL:\", functionBaseUrl);\n\n  // Step 5: calculate-demand only (allocate-questions is triggered automatically server-side)\n  // Use idempotency guard to prevent duplicate calls in React StrictMode\n  if (!canCallDemand(userId, regenerationType)) {\n    console.log(\"[GeneratingQuestions] Step 5: SKIPPED calculate-demand - idempotency guard active (already called within cooldown window)\");\n  } else {\n    try {\n      console.log(\"[GeneratingQuestions] Step 5: Calling calculate-demand\");\n      markDemandCalled(userId, regenerationType); // Mark before call to prevent race conditions\n      const demandPayload = { user_id: userId, region, today: new Date().toISOString().slice(0, 10) };\n      const demandResponse = await fetch(`${functionBaseUrl}/calculate-demand`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\", Authorization: `Bearer ${accessToken}` },\n        body: JSON.stringify(demandPayload),\n      });\n      const demandBody = await demandResponse.text();\n      console.log(\"[GeneratingQuestions] calculate-demand status:\", demandResponse.status, demandBody);\n      if (!demandResponse.ok) {\n        // Clear the mark on failure so retries are allowed\n        clearDemandMark(userId, regenerationType);\n        throw new Error(`calculate-demand returned error: ${demandResponse.status}`);\n      }\n    } catch (err) {\n      // Clear the mark on any error so retries are allowed\n      clearDemandMark(userId, regenerationType);\n      console.error(\"[GeneratingQuestions] Step 5 failed:\", err);\n    }\n  }\n}\n  // Step 6 removed and is now called within calculate-demand\n\n// Step 7: Archive sync check (best-effort)\n(async () => {\n  try {\n    const { data: allocated } = await supabase\n      .from(\"questions_allocated_user\")\n      .select(\"puzzle_date\")\n      .eq(\"user_id\", userId);\n\n    const allocatedCount = allocated?.length ?? 0;\n    const { data: profile } = await supabase\n      .from(\"user_profiles\")\n      .select(\"archive_synced_count\")\n      .eq(\"id\", userId)\n      .single();\n\n    if (allocatedCount > (profile?.archive_synced_count ?? 0)) {\n      console.log(\"[GeneratingQuestions] Updating archive_synced_count to\", allocatedCount);\n      await supabase\n        .from(\"user_profiles\")\n        .update({ archive_synced_count: allocatedCount })\n        .eq(\"id\", userId);\n    }\n    console.log(\"[GeneratingQuestions] Archive sync check complete\");\n  } catch (err) {\n    console.error(\"[GeneratingQuestions] Archive sync check failed:\", err);\n  }\n})();\n // ---------- end insert ----------\n\n            // Ensure the screen transitions after SCREEN_DURATION exactly once\n            finishTimeout = window.setTimeout(async () => {\n              if (!mountedRef.current) return;\n              if (finishedRef.current) return;\n              finishedRef.current = true;\n              console.log(\"[GeneratingQuestions] finishTimeout fired - cleaning up and calling onComplete\");\n\n              if (spawnInterval !== null) {\n                window.clearInterval(spawnInterval);\n                spawnInterval = null;\n              }\n              if (animInterval !== null) {\n                window.clearInterval(animInterval);\n                animInterval = null;\n              }\n\n              spawnTimeouts.forEach((id) => window.clearTimeout(id));\n\n              // Update restriction timestamps after generation completes\n              try {\n                console.log(\"[GeneratingQuestions] Calling /api/generation-complete with regenerationType:\", regenerationType);\n                const response = await fetch('/api/generation-complete', {\n                  method: 'POST',\n                  credentials: 'include',\n                  headers: {\n                    'Content-Type': 'application/json',\n                    'Authorization': `Bearer ${accessToken}`,\n                  },\n                  body: JSON.stringify({ regenerationType }),\n                });\n                const result = await response.json();\n                console.log(\"[GeneratingQuestions] /api/generation-complete result:\", result);\n              } catch (err) {\n                console.error(\"[GeneratingQuestions] Failed to update restriction timestamps:\", err);\n                // Don't block completion - this is best-effort\n              }\n\n              // small delay to allow last fade-out to complete visually before transition\n              setTimeout(() => {\n                if (!mountedRef.current) return;\n                onComplete();\n              }, 100);\n            }, SCREEN_DURATION);\n\n            // Continue backend steps (populate locations, demand, allocate, archive sync) in parallel\n            // They do not block the animation or the finishTimeout above.\n        } catch (err) {\n          console.error(\"[GeneratingQuestions] runSequence error:\", err);\n          if (mountedRef.current) {\n            toast({\n              title: \"Setup error\",\n              description: \"There was an issue preparing your questions\",\n              variant: \"destructive\",\n            });\n            setTimeout(() => {\n              if (!mountedRef.current) return;\n              onComplete();\n            }, 3000);\n          }\n        }\n      })(); // end of async IIFE\n\n      // Cleanup on unmount\n      return () => {\n        mountedRef.current = false;\n        // Reset sequenceStartedRef to allow animations to restart on remount (for React StrictMode).\n        // The sessionStorage-based idempotency guard (canCallDemand/markDemandCalled) prevents\n        // duplicate calculate-demand calls even if the sequence runs twice.\n        sequenceStartedRef.current = false;\n        console.log(\"[GeneratingQuestions] cleanup: clearing timers and resetting sequence flag\");\n        if (spawnInterval !== null) {\n          window.clearInterval(spawnInterval);\n          spawnInterval = null;\n        }\n        if (animInterval !== null) {\n          window.clearInterval(animInterval);\n          animInterval = null;\n        }\n        if (finishTimeout !== null) {\n          window.clearTimeout(finishTimeout);\n          finishTimeout = null;\n        }\n        spawnTimeouts.forEach((id) => window.clearTimeout(id));\n      };\n      // Intentionally minimal dependency list: do not include sequenceStarted state here\n    }, [userId, region, postcode, supabase, toast, onComplete, regenerationType]);\n\n\n\n      return (\n        <div\n          className=\"h-screen flex flex-col p-4\"\n          style={{ backgroundColor: \"#7DAAE8\" }}\n        >\n          {/* Hamster Image */}\n          <div className=\"mb-4 sm:mb-8 flex justify-center flex-shrink-0\">\n            <img\n              src={HamsterImageUrl}\n              alt=\"Hammie\"\n              className=\"w-44 h-44 sm:w-64 sm:h-64 object-contain\"\n            />\n          </div>\n\n          {/* Animated Text Blocks - flex-1 ensures it fills remaining space but shrinks if needed */}\n          <div ref={containerRef} className=\"relative w-full flex-1 min-h-0 overflow-hidden\">\n            {textBlocks.map((block) => (\n              <div\n                key={block.id}\n                className=\"absolute text-white font-bold text-sm pointer-events-none\"\n                style={{\n                  top: `${block.top}%`,\n                  left: `${block.left}%`,\n                  opacity: block.opacity,\n                  transform: \"translate(-50%, -50%)\",\n                  maxWidth: \"160px\",\n                  textAlign: \"center\",\n                  whiteSpace: \"normal\",\n                  wordBreak: \"break-word\",\n                  overflow: \"hidden\",\n                  display: \"-webkit-box\",\n                  WebkitLineClamp: 2,\n                  WebkitBoxOrient: \"vertical\",\n                  lineHeight: \"1.15rem\",\n                  transition: \"opacity 200ms linear\",\n                }}\n              >\n                {block.text}\n              </div>\n            ))}\n          </div>\n\n          {/* Footer Text - always pinned at bottom */}\n          <div className=\"flex-shrink-0 py-4 text-center max-w-md mx-auto\">\n            <p className=\"text-white font-medium text-lg sm:text-xl leading-snug\">\n              Hold tight, Hammie is cooking up your personalised questions...\n            </p>\n          </div>\n        </div>\n\n      );\n    }\n\n\n\n\n\n\n","path":null,"size_bytes":33344,"size_tokens":null},"client/src/components/IntroScreen.tsx":{"content":"import { motion, usePresence } from \"framer-motion\";\nimport { ChevronLeft, X } from \"lucide-react\";\nimport { useState, useEffect, useRef, useCallback, useMemo } from \"react\";\nimport { useSpinnerWithTimeout } from \"@/lib/SpinnerProvider\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  AlertDialog,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogDescription,\n} from \"@/components/ui/alert-dialog\";\nimport welcomeHamsterGrey from \"@assets/Welcome-Hamster-Grey.svg\";\nimport streakHamsterBlack from \"@assets/Streak-Hamster-Black.svg\";\n\ninterface IntroScreenProps {\n  puzzleDateCanonical: string; // YYYY-MM-DD format\n  eventTitle: string;\n  hasCluesEnabled: boolean;\n  isLocalMode: boolean;\n  categoryName?: string;\n  locationName?: string;\n  onPlayClick: () => void;\n  onBack: () => void;\n  onExitStart?: () => void; // Called immediately when back is pressed, before animation starts\n  formatDateForDisplay: (date: string) => string;\n  currentStreak?: number; // Current streak for this game mode\n  isStreakGame?: boolean; // Whether this game can continue/add to the streak\n  isStreakSaverGame?: boolean; // Whether this is a streak saver game (playing yesterday's puzzle)\n}\n\nexport function IntroScreen({\n  puzzleDateCanonical,\n  eventTitle,\n  hasCluesEnabled,\n  isLocalMode,\n  categoryName,\n  locationName,\n  onPlayClick,\n  onBack,\n  onExitStart,\n  formatDateForDisplay,\n  currentStreak = 0,\n  isStreakGame = false,\n  isStreakSaverGame = false,\n}: IntroScreenProps) {\n  const [shouldRender, setShouldRender] = useState(false);\n  const [isReady, setIsReady] = useState(false);\n  const [isExiting, setIsExiting] = useState(false);\n  const [showStreakSaverInfo, setShowStreakSaverInfo] = useState(false);\n  const streakSaverInfoShown = useRef(false);\n  const spinnerManagedRef = useRef(false);\n  const hasStartedLoading = useRef(false);\n  const exitCallbackRef = useRef<(() => void) | null>(null);\n  const [isPresent, safeToRemove] = usePresence();\n  \n  const displayDate = formatDateForDisplay(puzzleDateCanonical);\n  \n  const buttonColor = isLocalMode ? \"#66becb\" : \"#7DAAE8\";\n  \n  const isCategoryQuestion = !!categoryName && !locationName;\n  const isLocationQuestion = !!locationName && !categoryName;\n  const isLocalHistoryCategory = categoryName?.startsWith(\"Local History\") ?? false;\n  const isLocalHistoryWithLocation = isLocalHistoryCategory && !!locationName;\n  \n  const promptText = hasCluesEnabled \n    ? (isLocalHistoryCategory ? \"On what date did this local event occur?\" : \"On what date did this historical event occur?\")\n    : \"Take on the challenge of guessing a date in history!\";\n    \n  let categoryOrLocationLabel: string | null = null;\n  if (isCategoryQuestion) {\n    categoryOrLocationLabel = categoryName || null;\n  } else if (isLocalHistoryWithLocation) {\n    categoryOrLocationLabel = `Local History - ${locationName}:`;\n  } else if (isLocationQuestion) {\n    categoryOrLocationLabel = locationName || null;\n  }\n\n  // Track dark mode state\n  const [isDarkMode, setIsDarkMode] = useState(() => \n    document.documentElement.classList.contains('dark')\n  );\n  \n  // Listen for dark mode changes\n  useEffect(() => {\n    const observer = new MutationObserver((mutations) => {\n      mutations.forEach((mutation) => {\n        if (mutation.attributeName === 'class') {\n          setIsDarkMode(document.documentElement.classList.contains('dark'));\n        }\n      });\n    });\n    \n    observer.observe(document.documentElement, { attributes: true });\n    return () => observer.disconnect();\n  }, []);\n  \n  // Determine background color based on streak game status and dark mode\n  // Light mode: #FAFAFA (near white), Dark mode: hsl(222, 47%, 11%) = #0f172a (dark blue)\n  const backgroundColor = useMemo(() => {\n    if (isStreakGame) return '#000000';\n    return isDarkMode ? 'hsl(222, 47%, 11%)' : '#FAFAFA';\n  }, [isStreakGame, isDarkMode]);\n  \n  // Use the global hamster spinner with onFadeOutComplete to sequence animations\n  const spinner = useSpinnerWithTimeout({\n    retryDelayMs: 4000,\n    timeoutMs: 8000,\n    onRetry: () => {\n      console.log('[IntroScreen] Spinner timeout - retrying asset load');\n    },\n    onTimeout: () => {\n      console.log('[IntroScreen] Spinner timeout - proceeding anyway');\n      setIsReady(true);\n    },\n    onFadeOutComplete: () => {\n      // Only show content AFTER hamster has fully faded out\n      console.log('[IntroScreen] Hamster fade complete - showing content');\n      setIsReady(true);\n    },\n  });\n  \n  // Spinner always uses default background - don't pass streak's black background\n  // For streak games, spinner uses default light bg, then IntroScreen fades in with black\n  const spinnerBackgroundColor = isStreakGame ? undefined : backgroundColor;\n\n  // Handle exit animation completion\n  const handleExitComplete = useCallback(() => {\n    if (exitCallbackRef.current) {\n      exitCallbackRef.current();\n      exitCallbackRef.current = null;\n    }\n  }, []);\n\n  // Unified exit handler - used by both Play and Back buttons\n  const triggerExit = useCallback((callback: () => void) => {\n    exitCallbackRef.current = callback;\n    setIsExiting(true);\n  }, []);\n\n  const handlePlayClick = useCallback(() => {\n    triggerExit(onPlayClick);\n  }, [onPlayClick, triggerExit]);\n  \n  const handleBack = useCallback(() => {\n    // Call onExitStart immediately so parent can start fading its content\n    onExitStart?.();\n    // Small delay before starting slide animation - lets parent content fade first\n    setTimeout(() => {\n      triggerExit(onBack);\n    }, 50);\n  }, [onBack, onExitStart, triggerExit]);\n\n  // Delay initial render by 150ms to let spinner fully paint first\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setShouldRender(true);\n    }, 150);\n    return () => clearTimeout(timer);\n  }, []);\n\n  // Start spinner and preload assets on mount\n  useEffect(() => {\n    if (hasStartedLoading.current) return;\n    hasStartedLoading.current = true;\n    \n    // Show hamster spinner immediately with matching background color\n    if (!spinnerManagedRef.current) {\n      console.log('[IntroScreen] Starting hamster spinner');\n      spinner.start(0, spinnerBackgroundColor);\n      spinnerManagedRef.current = true;\n    }\n\n    // Preload image and wait for fonts\n    const img = new Image();\n    img.src = welcomeHamsterGrey;\n    \n    Promise.all([\n      img.decode().catch(() => {}),\n      document.fonts?.ready || Promise.resolve(),\n    ]).then(() => {\n      // Use double requestAnimationFrame to ensure layout is committed\n      requestAnimationFrame(() => {\n        requestAnimationFrame(() => {\n          console.log('[IntroScreen] Assets ready, completing spinner (waiting for fade out)');\n          spinner.complete();\n          // Note: isReady is now set via onFadeOutComplete callback\n        });\n      });\n    });\n  }, [spinner]);\n\n  // Only cancel spinner AFTER exit animation completes (when no longer present)\n  useEffect(() => {\n    if (!isPresent && spinnerManagedRef.current) {\n      const timer = setTimeout(() => {\n        if (spinnerManagedRef.current) {\n          spinner.cancel();\n          spinnerManagedRef.current = false;\n        }\n        safeToRemove?.();\n      }, 300);\n      \n      return () => clearTimeout(timer);\n    }\n  }, [isPresent, spinner, safeToRemove]);\n\n  // Text colors that adapt to dark mode\n  const textColor = useMemo(() => {\n    if (isStreakGame) return '#FFFFFF';\n    return isDarkMode ? '#FAFAFA' : '#54524F';\n  }, [isStreakGame, isDarkMode]);\n  \n  const categoryTextColor = useMemo(() => {\n    if (isStreakGame) return '#FFD700';\n    return isDarkMode ? '#7DAAE8' : '#1e3a8a'; // Lighter blue in dark mode\n  }, [isStreakGame, isDarkMode]);\n  \n  const streakRedColor = '#DC2626'; // Same red as streak celebration popup (text-red-600)\n  \n  // Show streak saver info popup when entering a streak saver game\n  useEffect(() => {\n    if (isStreakSaverGame && isReady && !streakSaverInfoShown.current) {\n      streakSaverInfoShown.current = true;\n      setShowStreakSaverInfo(true);\n    }\n  }, [isStreakSaverGame, isReady]);\n  \n  return (\n    <motion.div\n      initial={{ opacity: 0 }}\n      animate={isExiting ? { x: \"-100%\", opacity: 0 } : { opacity: 1 }}\n      exit={{ x: \"-100%\", opacity: 0 }}\n      transition={{ duration: 0.25, ease: \"easeInOut\" }}\n      onAnimationComplete={() => {\n        if (isExiting) {\n          handleExitComplete();\n        }\n      }}\n      className=\"fixed z-50 flex flex-col items-center justify-center\"\n      style={{ \n        backgroundColor,\n        top: 0,\n        left: 0,\n        right: 0,\n        bottom: 0,\n        width: '100%',\n        height: '100%',\n      }}\n    >\n      {/* Only render content after 150ms delay to avoid flash behind spinner */}\n      {shouldRender && (\n        <>\n          {/* Back button - fixed position, not affected by content layout */}\n          <motion.button\n            initial={{ opacity: 0 }}\n            animate={{ opacity: isReady && !isExiting ? 1 : 0 }}\n            transition={{ duration: 0.2 }}\n            onClick={handleBack}\n            className=\"absolute top-4 left-4 w-14 h-14 flex items-center justify-center rounded-full transition-colors\"\n            style={{\n              pointerEvents: isReady && !isExiting ? 'auto' : 'none',\n              backgroundColor: isStreakGame ? 'rgba(255, 255, 255, 0.1)' : 'transparent',\n              ...(isStreakGame && { borderRadius: '50%' })\n            }}\n            data-testid=\"button-intro-back\"\n          >\n            <ChevronLeft className=\"h-9 w-9\" style={{ color: isStreakGame ? '#FFFFFF' : (isDarkMode ? '#FAFAFA' : '#54524F') }} />\n          </motion.button>\n\n          {/* Content - opacity controlled, layout always maintained */}\n          <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: isReady && !isExiting ? 1 : 0 }}\n            transition={{ duration: 0.3, ease: \"easeOut\" }}\n            className=\"flex flex-col items-center justify-center max-w-md w-full p-4\"\n            style={{ pointerEvents: isReady && !isExiting ? 'auto' : 'none' }}\n          >\n            <div className=\"flex flex-col items-center justify-center w-full space-y-6 h-full\">\n              {isStreakGame && (\n                <div className=\"relative w-48 h-48 flex items-center justify-center\">\n                  <img\n                    src={streakHamsterBlack}\n                    alt=\"Streak\"\n                    className=\"w-full h-full object-contain\"\n                    data-testid=\"img-hamster-intro\"\n                  />\n                  <div \n                    className=\"absolute inset-0 flex items-center justify-center\"\n                    style={{ top: \"50%\" }}\n                  >\n                    <span\n                      className={`font-bold drop-shadow-lg leading-none ${\n                        String(currentStreak).length === 1\n                          ? \"text-5xl\"\n                          : String(currentStreak).length === 2\n                          ? \"text-4xl\"\n                          : \"text-3xl\"\n                      }`}\n                      style={{ color: streakRedColor }}\n                      data-testid=\"text-intro-streak-number\"\n                    >\n                      {currentStreak}\n                    </span>\n                  </div>\n                </div>\n              )}\n              \n              {!isStreakGame && (\n                <div className=\"h-32 w-32 flex items-center justify-center\">\n                  <img\n                    src={welcomeHamsterGrey}\n                    alt=\"Welcome\"\n                    className=\"h-32 w-auto object-contain\"\n                    data-testid=\"img-hamster-intro\"\n                  />\n                </div>\n              )}\n\n              <div className=\"text-center space-y-4 flex-grow flex flex-col justify-center\">\n                <p className=\"font-bold text-lg\" data-testid=\"text-intro-clue-prompt\" style={{ maxWidth: isLocalHistoryCategory ? '240px' : '280px', margin: '0 auto', color: isStreakGame ? streakRedColor : textColor }}>\n                  {isStreakGame ? \"Continue your streak!\" : (hasCluesEnabled ? promptText : \"Take on the challenge of guessing a date in history!\")}\n                </p>\n                \n                <div className=\"space-y-0\">\n                  {hasCluesEnabled && categoryOrLocationLabel && (\n                    <p className=\"text-xl font-bold\" data-testid=\"text-intro-category-location\" style={{ color: categoryTextColor }}>\n                      {categoryOrLocationLabel}\n                    </p>\n                  )}\n                  \n                  {hasCluesEnabled && (\n                    <p className=\"text-xl font-bold\" data-testid=\"text-intro-event-title\" style={{ color: textColor }}>\n                      {eventTitle}\n                    </p>\n                  )}\n                </div>\n              </div>\n\n              <button\n                onClick={handlePlayClick}\n                className=\"w-1/2 text-white font-bold text-xl py-4 rounded-full hover:opacity-90 transition-opacity\"\n                style={{ backgroundColor: buttonColor }}\n                data-testid=\"button-intro-play\"\n              >\n                Play\n              </button>\n\n              <p className=\"text-sm\" data-testid=\"text-intro-puzzle-date\" style={{ color: isStreakGame ? 'rgba(255, 255, 255, 0.7)' : (isDarkMode ? 'rgba(255, 255, 255, 0.6)' : '#999') }}>\n                Puzzle date: {displayDate}\n              </p>\n            </div>\n          </motion.div>\n        </>\n      )}\n      \n      {/* Streak Saver Info Popup */}\n      <AlertDialog open={showStreakSaverInfo} onOpenChange={setShowStreakSaverInfo}>\n        <AlertDialogContent data-testid=\"streak-saver-info-dialog\">\n          <AlertDialogHeader className=\"text-center\">\n            <AlertDialogTitle className=\"text-xl font-bold text-gray-800 dark:text-gray-100\">\n              Streak Saver\n            </AlertDialogTitle>\n            <AlertDialogDescription className=\"text-sm mt-2 text-gray-600 dark:text-gray-300\">\n              To keep your streak going you must win this puzzle from yesterday.\n              Exiting will reset your streak, without using your streak saver.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n\n          <div className=\"flex flex-col items-center gap-4 py-4\">\n            <Button\n              onClick={() => setShowStreakSaverInfo(false)}\n              className=\"w-full bg-[#7DAAE8] text-white text-[16px] border-blue-400 hover:bg-blue-400\"\n              variant=\"outline\"\n              data-testid=\"button-ok-streak-saver-info\"\n            >\n              Ok\n            </Button>\n          </div>\n        </AlertDialogContent>\n      </AlertDialog>\n\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":14775,"size_tokens":null},"client/src/components/CategorySelectionScreen.tsx":{"content":"import { useState, useEffect, useMemo, useRef, useCallback } from 'react';\nimport { createPortal } from 'react-dom';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { ChevronLeft, Loader2 } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { useToast } from '@/hooks/use-toast';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { useSupabase } from '@/lib/SupabaseProvider';\nimport { useAuth } from '@/hooks/useAuth';\nimport { useProfile } from '@/hooks/useProfile';\nimport { useAdBannerActive } from '@/components/AdBanner';\nimport { useSpinnerWithTimeout } from '@/lib/SpinnerProvider';\nimport { readLocal, writeLocal, CACHE_KEYS } from '@/lib/localCache';\nimport { GeneratingQuestionsScreen } from './GeneratingQuestionsScreen';\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from '@/components/ui/alert-dialog';\nimport hamsterImage from '@assets/Question-Hamster-Cutout.png';\n\ninterface Category {\n  id: number;\n  name: string;\n  description?: string;\n}\n\ninterface CategorySelectionScreenProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onGenerate: () => void;\n  initialSelectedIds?: number[];\n  isRegeneration?: boolean;\n}\n\nexport function CategorySelectionScreen({\n  isOpen,\n  onClose,\n  onGenerate,\n  initialSelectedIds = [],\n  isRegeneration = false,\n}: CategorySelectionScreenProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { isAuthenticated, user } = useAuth();\n  const { profile } = useProfile();\n  const adBannerActive = useAdBannerActive();\n  const supabase = useSupabase();\n  const [showGeneratingQuestions, setShowGeneratingQuestions] = useState(false);\n  \n  // Cache user data for GeneratingQuestionsScreen to prevent remounting on re-renders\n  // Includes selectedCategoryIds for filtering event_titles during category regeneration\n  const generatingDataRef = useRef<{ userId: string; region: string; postcode: string; selectedCategoryIds: number[] } | null>(null);\n  \n  // Track if spinner has been managed for this open cycle\n  const spinnerManagedRef = useRef(false);\n  \n  // Ref for retry callback\n  const refetchRef = useRef<(() => void) | null>(null);\n\n  // Track if we've synced from API to avoid re-initializing\n  const [hasSyncedFromApi, setHasSyncedFromApi] = useState(false);\n  \n  // Content visibility state - only show content after spinner fades out\n  const [isReady, setIsReady] = useState(false);\n  \n  // Delayed render to prevent flash behind spinner\n  const [shouldRender, setShouldRender] = useState(false);\n  \n  // Read cached data immediately for instant display\n  const cachedCategoryIds = useMemo(() => {\n    const cached = readLocal<number[]>(CACHE_KEYS.PRO_CATEGORIES);\n    return cached || [];\n  }, []);\n  \n  const cachedCategoriesList = useMemo(() => {\n    const cached = readLocal<Category[]>(CACHE_KEYS.CATEGORIES_LIST);\n    return cached || [];\n  }, []);\n\n  // Initialize with cached categories for instant display\n  const [selectedCategories, setSelectedCategories] = useState<Set<number>>(\n    () => new Set(cachedCategoryIds.length > 0 ? cachedCategoryIds : initialSelectedIds)\n  );\n\n  // Fetch categories list - use cache as initial data for instant display\n  const { data: categories = cachedCategoriesList, isLoading: loadingCategories } = useQuery<Category[]>({\n    queryKey: ['/api/categories'],\n    queryFn: async () => {\n      console.log('[CategorySelectionScreen] Fetching categories list from API...');\n      const response = await fetch('/api/categories');\n      if (!response.ok) {\n        throw new Error('Failed to fetch categories');\n      }\n      const data = await response.json() || [];\n      // Cache the list for future instant display\n      writeLocal(CACHE_KEYS.CATEGORIES_LIST, data);\n      console.log('[CategorySelectionScreen] Categories list fetched:', data.length);\n      return data;\n    },\n    enabled: isOpen,\n    initialData: cachedCategoriesList.length > 0 ? cachedCategoriesList : undefined,\n    staleTime: 60 * 60 * 1000, // Consider data fresh for 1 hour\n  });\n\n  // Fetch user's selected categories - requires auth\n  const { data: userCategories, isLoading: loadingUserCategories, refetch, isFetched, isError } = useQuery<number[]>({\n    queryKey: ['/api/user/pro-categories'],\n    queryFn: async () => {\n      console.log('[CategorySelectionScreen] Fetching user categories from API...');\n      const { data: { session } } = await supabase.auth.getSession();\n      if (!session) {\n        console.log('[CategorySelectionScreen] No session available');\n        throw new Error('No session');\n      }\n\n      const response = await fetch('/api/user/pro-categories', {\n        credentials: 'include',\n        headers: {\n          'Authorization': `Bearer ${session.access_token}`,\n        },\n      });\n      \n      if (!response.ok) {\n        console.log('[CategorySelectionScreen] Failed to fetch user categories:', response.status);\n        throw new Error('Failed to fetch');\n      }\n      const data = await response.json();\n      console.log('[CategorySelectionScreen] API returned categories:', data.categoryIds);\n      // Cache the user's selection\n      if (data.categoryIds && Array.isArray(data.categoryIds)) {\n        writeLocal(CACHE_KEYS.PRO_CATEGORIES, data.categoryIds);\n      }\n      return data.categoryIds || [];\n    },\n    enabled: isOpen && isAuthenticated,\n    initialData: cachedCategoryIds.length > 0 ? cachedCategoryIds : undefined,\n    staleTime: 0, // Always refetch to get latest from server\n    retry: 2, // Retry twice on failure\n    retryDelay: 500, // Wait 500ms between retries\n  });\n  \n  // Update refetch ref when refetch function changes\n  useEffect(() => {\n    refetchRef.current = refetch;\n  }, [refetch]);\n  \n  // Callbacks for spinner timeout handling\n  const handleRetry = useCallback(() => {\n    console.log('[CategorySelectionScreen] Spinner timeout - triggering retry');\n    refetchRef.current?.();\n    queryClient.invalidateQueries({ queryKey: ['/api/categories'] });\n  }, [queryClient]);\n  \n  const handleTimeout = useCallback(() => {\n    console.log('[CategorySelectionScreen] Spinner timeout - failed to load');\n    toast({\n      title: 'Failed to load',\n      description: 'Please try again in a bit.',\n      variant: 'destructive',\n    });\n    onClose();\n  }, [toast, onClose]);\n  \n  const handleFadeOutComplete = useCallback(() => {\n    // Only show content AFTER hamster has fully faded out\n    console.log('[CategorySelectionScreen] Hamster fade complete - showing content');\n    setIsReady(true);\n  }, []);\n  \n  // Use spinner with timeout for automatic retry and failure handling\n  const spinner = useSpinnerWithTimeout({\n    retryDelayMs: 4000,\n    timeoutMs: 8000,\n    onRetry: handleRetry,\n    onTimeout: handleTimeout,\n    onFadeOutComplete: handleFadeOutComplete,\n  });\n  \n  // Handle shouldRender delay to prevent flash behind spinner\n  useEffect(() => {\n    if (isOpen) {\n      // Delay rendering content to allow spinner to appear first\n      const timer = setTimeout(() => {\n        setShouldRender(true);\n      }, 150);\n      return () => clearTimeout(timer);\n    } else {\n      setShouldRender(false);\n      setIsReady(false);\n    }\n  }, [isOpen]);\n  \n  // Force refetch when screen opens with authenticated user\n  useEffect(() => {\n    if (isOpen && isAuthenticated) {\n      console.log('[CategorySelectionScreen] Screen opened - forcing refetch');\n      setHasSyncedFromApi(false); // Reset sync flag when screen opens\n      setIsReady(false); // Reset content visibility\n      spinnerManagedRef.current = false; // Reset spinner management for new open cycle\n      refetch();\n    }\n  }, [isOpen, isAuthenticated, refetch]);\n  \n  // Manage spinner: show when opening until data is fully synced\n  useEffect(() => {\n    if (!isOpen) {\n      // Screen closed - ensure spinner is hidden and reset ref\n      if (spinnerManagedRef.current) {\n        spinner.cancel();\n        spinnerManagedRef.current = false;\n      }\n      return;\n    }\n    \n    // Screen is open - show spinner until data is synced\n    if (!hasSyncedFromApi && !spinnerManagedRef.current) {\n      // Data not yet synced - show spinner immediately with timeout\n      console.log('[CategorySelectionScreen] Showing spinner with timeout - waiting for data sync');\n      spinner.start(0); // Show immediately, no delay\n      spinnerManagedRef.current = true;\n    }\n    \n    // Hide spinner once data is synced\n    if (hasSyncedFromApi && spinnerManagedRef.current) {\n      console.log('[CategorySelectionScreen] Data synced - completing spinner');\n      spinner.complete();\n      spinnerManagedRef.current = false;\n    }\n  }, [isOpen, hasSyncedFromApi, spinner]);\n\n  // Sync UI state from API/cache when data becomes available\n  useEffect(() => {\n    if (!isOpen || hasSyncedFromApi) return;\n    \n    // If not authenticated, use cache immediately (query is disabled)\n    if (!isAuthenticated) {\n      if (cachedCategoryIds.length > 0) {\n        console.log('[CategorySelectionScreen] Using cached categories (not authenticated):', cachedCategoryIds);\n        setSelectedCategories(new Set(cachedCategoryIds));\n      } else {\n        console.log('[CategorySelectionScreen] No cached categories (not authenticated)');\n      }\n      setHasSyncedFromApi(true);\n      return;\n    }\n    \n    // Wait for the query to complete (not loading, either fetched or errored)\n    if (loadingUserCategories) return;\n    \n    const apiCategories = userCategories || [];\n    \n    // If API fetch succeeded with data, use it\n    if (isFetched && !isError && apiCategories.length > 0) {\n      console.log('[CategorySelectionScreen] Syncing from API:', apiCategories);\n      setSelectedCategories(new Set(apiCategories));\n      setHasSyncedFromApi(true);\n      return;\n    }\n    \n    // If API failed or returned empty, fall back to cache\n    if ((isError || (isFetched && apiCategories.length === 0)) && cachedCategoryIds.length > 0) {\n      console.log('[CategorySelectionScreen] Using cached categories (API empty/failed):', cachedCategoryIds);\n      setSelectedCategories(new Set(cachedCategoryIds));\n      setHasSyncedFromApi(true);\n      return;\n    }\n    \n    // If both API and cache are empty, mark as synced so button can enable for first-time users\n    if (isFetched && apiCategories.length === 0 && cachedCategoryIds.length === 0) {\n      console.log('[CategorySelectionScreen] No existing categories (first-time user)');\n      setHasSyncedFromApi(true);\n    }\n  }, [userCategories, isOpen, isFetched, isError, loadingUserCategories, hasSyncedFromApi, cachedCategoryIds, isAuthenticated]);\n\n  const saveCategoriesMutation = useMutation({\n    mutationFn: async (categoryIds: number[]) => {\n      console.log('[CategorySelectionScreen] Mutation started with categoryIds:', categoryIds);\n      \n      const { data: { session } } = await supabase.auth.getSession();\n      if (!session) {\n        console.error('[CategorySelectionScreen] Mutation failed: No session');\n        throw new Error('Not authenticated');\n      }\n      const accessToken = session.access_token;\n      console.log('[CategorySelectionScreen] Got session, proceeding to save categories');\n\n      // Step 1: Save categories\n      const response = await fetch('/api/user/pro-categories', {\n        method: 'POST',\n        credentials: 'include',\n        headers: {\n          'Authorization': `Bearer ${accessToken}`,\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ categoryIds }),\n      });\n\n      if (!response.ok) {\n        console.error('[CategorySelectionScreen] Failed to save categories:', response.status);\n        throw new Error('Failed to save categories');\n      }\n      \n      console.log('[CategorySelectionScreen] Categories saved successfully to API');\n\n      // Step 2: Call reset-and-reallocate-user Edge Function\n      console.log('[CategorySelectionScreen] Calling reset-and-reallocate-user Edge Function');\n      \n      if (!accessToken) {\n        throw new Error('No access token found');\n      }\n\n      const supabaseUrl = import.meta.env.VITE_SUPABASE_URL || (supabase as any).supabaseUrl;\n      if (!supabaseUrl) {\n        console.warn('[CategorySelectionScreen] Supabase URL not available; skipping reset-and-reallocate-user');\n      } else {\n        const functionBaseUrl = supabaseUrl.replace('.supabase.co', '.functions.supabase.co');\n        console.log('[CategorySelectionScreen] Function base URL:', functionBaseUrl);\n        \n        if (user?.id) {\n          try {\n            const resetPayload = { user_id: user.id };\n            const resetResponse = await fetch(`${functionBaseUrl}/reset-and-reallocate-user`, {\n              method: 'POST',\n              headers: {\n                'Content-Type': 'application/json',\n                'Authorization': `Bearer ${accessToken}`,\n              },\n              body: JSON.stringify(resetPayload),\n            });\n            \n            const resetBody = await resetResponse.text();\n            console.log('[CategorySelectionScreen] reset-and-reallocate-user status:', resetResponse.status, resetBody);\n            \n            if (!resetResponse.ok) {\n              console.error('[CategorySelectionScreen] reset-and-reallocate-user error:', resetResponse.status, resetBody);\n              throw new Error(`reset-and-reallocate-user returned error: ${resetResponse.status}`);\n            }\n            \n            console.log('[CategorySelectionScreen] reset-and-reallocate-user completed successfully');\n          } catch (err) {\n            console.error('[CategorySelectionScreen] reset-and-reallocate-user failed:', err);\n            throw err;\n          }\n        }\n      }\n\n      console.log('[CategorySelectionScreen] Mutation mutationFn completed, returning response');\n      return response.json();\n    },\n    onSuccess: (_, categoryIds) => {\n      console.log('[CategorySelectionScreen] onSuccess handler called with categoryIds:', categoryIds);\n      // Update cache with newly saved categories\n      writeLocal(CACHE_KEYS.PRO_CATEGORIES, categoryIds);\n      queryClient.invalidateQueries({ queryKey: ['/api/user/pro-categories'] });\n      \n      // Cache user data before showing GeneratingQuestionsScreen to prevent remounting on re-renders\n      // Include the selected category IDs so event_titles can be filtered during category regeneration\n      if (user?.id && profile?.region) {\n        generatingDataRef.current = {\n          userId: user.id,\n          region: profile.region,\n          postcode: profile.postcode || '',\n          selectedCategoryIds: categoryIds,\n        };\n        console.log('[CategorySelectionScreen] Cached generating data:', generatingDataRef.current);\n      }\n      \n      // Show GeneratingQuestionsScreen instead of immediately calling onGenerate\n      console.log('[CategorySelectionScreen] Setting showGeneratingQuestions to true');\n      setShowGeneratingQuestions(true);\n    },\n    onError: (error) => {\n      toast({\n        title: 'Error',\n        description: error instanceof Error ? error.message : 'Failed to save your category preferences.',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const toggleCategory = (categoryId: number) => {\n    setSelectedCategories((prev) => {\n      const next = new Set(prev);\n      if (next.has(categoryId)) {\n        next.delete(categoryId);\n      } else {\n        next.add(categoryId);\n      }\n      return next;\n    });\n  };\n\n  // Check if selected categories differ from saved categories\n  const categoriesHaveChanged = useMemo(() => {\n    // Don't enable button until we've synced from API/cache\n    // This prevents false positives during initial load\n    if (!hasSyncedFromApi) return false;\n    \n    // If we're still loading saved categories, don't allow regeneration yet\n    if (loadingUserCategories) return false;\n    \n    const savedCategories = userCategories || [];\n    \n    // For first-time category selection (no saved categories yet), allow generation\n    if (savedCategories.length === 0) return true;\n    \n    // Check if the sets are different\n    if (selectedCategories.size !== savedCategories.length) return true;\n    \n    // Check if all saved categories are still selected\n    for (const catId of savedCategories) {\n      if (!selectedCategories.has(catId)) return true;\n    }\n    \n    return false;\n  }, [selectedCategories, userCategories, loadingUserCategories, hasSyncedFromApi]);\n\n  const handleGenerate = () => {\n    console.log('[CategorySelectionScreen] handleGenerate called', {\n      selectedCount: selectedCategories.size,\n      canGenerate,\n      categoriesHaveChanged,\n      hasSyncedFromApi,\n      userId: user?.id,\n      profileRegion: profile?.region,\n      profilePostcode: profile?.postcode,\n    });\n    \n    if (selectedCategories.size < 3) {\n      toast({\n        title: 'Select More Categories',\n        description: 'Please select at least 3 categories to continue.',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    console.log('[CategorySelectionScreen] Starting mutation with categories:', Array.from(selectedCategories));\n    saveCategoriesMutation.mutate(Array.from(selectedCategories));\n  };\n\n  // Handler for when GeneratingQuestionsScreen completes\n  // Wrapped in useCallback to ensure stable reference for portal rendering\n  const handleGeneratingQuestionsComplete = useCallback(() => {\n    console.log('[CategorySelectionScreen] GeneratingQuestionsScreen complete');\n    setShowGeneratingQuestions(false);\n    generatingDataRef.current = null; // Clear cached data\n    // Invalidate queries to refresh data\n    queryClient.invalidateQueries({ queryKey: ['/api/user/puzzles'] });\n    queryClient.invalidateQueries({ queryKey: ['/api/puzzles'] });\n    queryClient.invalidateQueries({ queryKey: ['/api/user/game-attempts/user'] });\n    queryClient.invalidateQueries({ queryKey: ['/api/game-attempts/user'] });\n    toast({\n      title: 'Categories Updated!',\n      description: 'Your puzzles are being refreshed with your new preferences.',\n    });\n    onGenerate(); // Close and return to GameSelectionPage\n  }, [queryClient, toast, onGenerate]);\n\n  // Button only enabled when 3+ categories selected AND they differ from saved categories\n  const canGenerate = selectedCategories.size >= 3 && categoriesHaveChanged;\n\n  // Show GeneratingQuestionsScreen after categories are saved\n  // Render as a portal at the document body level to prevent unmounting when parent unmounts\n  // This fixes the issue where navigation changes cause CategorySelectionScreen to unmount\n  const generatingScreenPortal = useMemo(() => {\n    if (!showGeneratingQuestions || !generatingDataRef.current) return null;\n    \n    const { userId, region, postcode, selectedCategoryIds } = generatingDataRef.current;\n    console.log('[CategorySelectionScreen] Rendering GeneratingQuestionsScreen portal with cached data:', {\n      userId,\n      region,\n      postcode,\n      selectedCategoryIds,\n    });\n    \n    return createPortal(\n      <div style={{ position: 'fixed', inset: 0, zIndex: 9999 }}>\n        <GeneratingQuestionsScreen\n          userId={userId}\n          region={region}\n          postcode={postcode}\n          onComplete={handleGeneratingQuestionsComplete}\n          regenerationType=\"category_change\"\n          selectedCategoryIds={selectedCategoryIds}\n        />\n      </div>,\n      document.body\n    );\n  }, [showGeneratingQuestions, handleGeneratingQuestionsComplete]);\n  \n  // Log if we're trying to show GeneratingQuestionsScreen but can't\n  if (showGeneratingQuestions && !generatingDataRef.current) {\n    console.error('[CategorySelectionScreen] Cannot show GeneratingQuestionsScreen - missing cached data:', {\n      showGeneratingQuestions,\n      generatingDataRef: generatingDataRef.current,\n      userId: user?.id,\n      profileRegion: profile?.region,\n    });\n  }\n  \n  // Render the portal if showing generating screen\n  if (generatingScreenPortal) {\n    return generatingScreenPortal;\n  }\n\n  return (\n    <AnimatePresence>\n      {isOpen && (\n        <motion.div\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          exit={{ opacity: 0 }}\n          transition={{ duration: 0.3 }}\n          className={`fixed inset-0 z-[100] bg-background flex flex-col ${adBannerActive ? 'pb-[50px]' : ''}`}\n          data-testid=\"category-selection-screen\"\n        >\n          {/* Only render content after delay to avoid flash behind spinner */}\n          {shouldRender && (\n            <>\n              {/* Back button - fixed position, visibility controlled by isReady */}\n              <motion.button\n                initial={{ opacity: 0 }}\n                animate={{ opacity: isReady ? 1 : 0 }}\n                transition={{ duration: 0.2 }}\n                onClick={onClose}\n                className=\"absolute left-4 top-4 w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors z-10\"\n                style={{ pointerEvents: isReady ? 'auto' : 'none' }}\n                data-testid=\"button-close-categories\"\n              >\n                <ChevronLeft className=\"h-9 w-9 text-gray-700 dark:text-gray-300\" />\n              </motion.button>\n\n              {/* Content - opacity controlled by isReady */}\n              <motion.div\n                initial={{ opacity: 0 }}\n                animate={{ opacity: isReady ? 1 : 0 }}\n                transition={{ duration: 0.3, ease: \"easeOut\" }}\n                className=\"flex flex-col flex-1 overflow-hidden\"\n                style={{ pointerEvents: isReady ? 'auto' : 'none' }}\n              >\n                {/* Fixed Header - title centered on full screen */}\n                <div className=\"p-4 flex-shrink-0 relative\">\n                  <h1 className=\"text-3xl font-bold text-foreground text-center\" data-testid=\"text-categories-title\">\n                    Select Your<br />Categories\n                  </h1>\n                </div>\n\n                {/* Fixed Hamster and Text Description */}\n                <div className=\"px-4 pb-4 flex-shrink-0\">\n                  <div className=\"max-w-md mx-auto w-full\">\n                    <div className=\"flex items-start gap-4\">\n                      {/* Hamster image with natural aspect ratio */}\n                      <img\n                        src={hamsterImage}\n                        alt=\"Hammie\"\n                        className=\"w-16 h-auto flex-shrink-0\"\n                      />\n                      {/* Text boxes - centered text, centered in the remaining space */}\n                      <div className=\"flex-1 flex flex-col items-center justify-center text-center space-y-1\">\n                        <p className=\"text-base text-muted-foreground\">\n                          Choose your favourite subjects so Hammie can personalise your puzzles\n                        </p>\n                        <p className=\"text-base font-medium text-foreground\">\n                          {selectedCategories.size} selected (min 3)\n                        </p>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Scrollable Categories Area */}\n                <div className=\"flex-1 overflow-y-auto px-4 scrollbar-hide\" style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}>\n                  <div className=\"max-w-md mx-auto w-full\">\n                    {/* Categories Grid */}\n                    {loadingCategories ? (\n                      <div className=\"flex items-center justify-center py-8\">\n                        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n                      </div>\n                    ) : (\n                      <div className=\"grid grid-cols-2 gap-2 pb-4\">\n                        {categories.map((category) => {\n                          const isSelected = selectedCategories.has(category.id);\n                          \n                          return (\n                            <button\n                              key={category.id}\n                              onClick={() => toggleCategory(category.id)}\n                              className={`\n                                px-4 py-3 rounded-xl text-sm font-medium transition-all\n                                ${isSelected \n                                  ? 'bg-blue-500 text-white font-bold' \n                                  : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'\n                                }\n                              `}\n                              data-testid={`button-category-${category.id}`}\n                            >\n                              {category.name}\n                            </button>\n                          );\n                        })}\n                      </div>\n                    )}\n                  </div>\n                </div>\n\n                {/* Fixed Footer Button */}\n                <div className=\"px-4 py-4 flex-shrink-0\">\n                  <div className=\"max-w-md mx-auto w-full\">\n                    <Button\n                      onClick={handleGenerate}\n                      disabled={!canGenerate || saveCategoriesMutation.isPending}\n                      className={`\n                        w-full h-14 text-lg font-bold rounded-full transition-all\n                        ${canGenerate \n                          ? 'bg-blue-500 hover:bg-blue-600 text-white' \n                          : 'bg-gray-300 dark:bg-gray-700 text-gray-500 cursor-not-allowed'\n                        }\n                      `}\n                      data-testid=\"button-generate\"\n                    >\n                      {saveCategoriesMutation.isPending ? (\n                        <>\n                          <Loader2 className=\"h-5 w-5 animate-spin mr-2\" />\n                          Saving...\n                        </>\n                      ) : (\n                        isRegeneration ? 'Re-Generate' : 'Generate'\n                      )}\n                    </Button>\n                  </div>\n                </div>\n              </motion.div>\n            </>\n          )}\n        </motion.div>\n      )}\n    </AnimatePresence>\n  );\n}\n","path":null,"size_bytes":26307,"size_tokens":null},"client/src/components/GuestRestrictionPopup.tsx":{"content":"import { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { ChevronLeft } from \"lucide-react\";\nimport welcomeHamsterGrey from \"@assets/Welcome-Hamster-Grey.svg\";\n\ninterface GuestRestrictionPopupProps {\n  isOpen: boolean;\n  type: 'archive' | 'personal' | 'pro';\n  onClose: () => void;\n  onRegister: () => void;\n  onLogin: () => void;\n  customTitle?: string;\n  customText?: string;\n}\n\nexport function GuestRestrictionPopup({\n  isOpen,\n  type,\n  onClose,\n  onRegister,\n  onLogin,\n  customTitle,\n  customText,\n}: GuestRestrictionPopupProps) {\n  const content = customTitle && customText \n    ? {\n        title: customTitle,\n        text: customText\n      }\n    : type === 'archive' \n    ? {\n        title: \"Access the Elementle Archives\",\n        text: \"Unlock years of history and track your progress as you uncover events you never knew happened.\"\n      }\n    : type === 'pro'\n    ? {\n        title: \"Register your details to Go Pro!\",\n        text: \"Register first and Hammie the hamster will generate personalised questions based on your location. You can then Go Pro to get rid of those pesky ads and personalise your questions!\"\n      }\n    : {\n        title: \"Access your personalised games\",\n        text: \"Hammie the hamster will generate personalised questions based on your location, mixed up with other interesting events he thinks you'll enjoy.\"\n      };\n\n  return (\n    <AnimatePresence>\n      {isOpen && (\n        <motion.div\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          exit={{ opacity: 0 }}\n          transition={{ duration: 0.3 }}\n          className=\"fixed inset-0 flex flex-col items-center justify-center p-4 z-[100]\"\n          style={{ backgroundColor: '#FAFAFA' }}\n        >\n          <div className=\"absolute top-4 left-4\">\n            <button\n              onClick={onClose}\n              className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-200 transition-colors\"\n              data-testid=\"button-close-restriction-popup\"\n            >\n              <ChevronLeft className=\"h-9 w-9 text-gray-700\" />\n            </button>\n          </div>\n\n          <div className=\"flex flex-col items-center justify-center max-w-md w-full space-y-8\">\n            <img\n              src={welcomeHamsterGrey}\n              alt=\"Hammie\"\n              className=\"h-40 w-auto object-contain\"\n              data-testid=\"img-restriction-hamster\"\n            />\n\n            <div className=\"text-center space-y-4\">\n              <h2 className=\"text-2xl font-bold text-gray-800\" data-testid=\"text-restriction-title\">\n                {content.title}\n              </h2>\n              <p className=\"text-base text-gray-600\" data-testid=\"text-restriction-description\">\n                {content.text}\n              </p>\n            </div>\n\n            <div className=\"flex flex-col w-full space-y-3 px-4\">\n              <Button\n                onClick={onRegister}\n                className=\"w-full h-14 text-lg font-bold rounded-full\"\n                style={{ backgroundColor: '#7DAAE8' }}\n                data-testid=\"button-restriction-register\"\n              >\n                Register\n              </Button>\n              <Button\n                onClick={onLogin}\n                variant=\"outline\"\n                className=\"w-full h-14 text-lg font-bold rounded-full border-2 border-gray-300\"\n                data-testid=\"button-restriction-login\"\n              >\n                Login\n              </Button>\n            </div>\n          </div>\n        </motion.div>\n      )}\n    </AnimatePresence>\n  );\n}\n","path":null,"size_bytes":3627,"size_tokens":null},"client/src/components/ProSubscriptionDialog.tsx":{"content":"import { useState, useEffect, useCallback, type MouseEvent } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { ChevronLeft, Check, Crown, Sparkles, Star, Loader2, AlertTriangle } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { useToast } from '@/hooks/use-toast';\nimport { useAuth } from '@/hooks/useAuth';\nimport { getSupabaseClient } from '@/lib/supabaseClient';\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\nimport signupHamsterGrey from '@assets/Signup-Hamster-Cutout.png';\n\ninterface ProSubscriptionDialogProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onSuccess: (tierName: string) => void;\n  onLoginRequired?: () => void;\n  // Props for streak saver flow\n  fromStreakSaver?: boolean;\n  currentStreak?: number;\n  gameType?: \"region\" | \"user\";\n  onStreakLost?: () => void;\n  onStayOnPage?: () => void;\n}\n\n// Tier data from user_tier table\ninterface TierData {\n  id: string;\n  region: string;\n  tier: string;\n  tierType: string; // 'monthly', 'annual', 'lifetime', 'default'\n  subscriptionCost: number | null;\n  currency: string | null;\n  subscriptionDurationMonths: number | null;\n  streakSavers: number;\n  holidaySavers: number;\n  holidayDurationDays: number;\n  description: string | null;\n  sortOrder: number;\n}\n\n// Helper to format price\nfunction formatPrice(amount: number | null, currency: string | null): string {\n  if (amount === null) return 'Free';\n  const symbol = currency === 'GBP' ? '' : currency === 'USD' ? '$' : currency || '';\n  return `${symbol}${parseFloat(String(amount)).toFixed(2)}`;\n}\n\n// Get icon and styling based on tier type\nfunction getTierStyle(tierType: string) {\n  switch (tierType) {\n    case 'monthly':\n      return { \n        icon: Star, \n        color: 'text-amber-700', \n        bgColor: 'bg-amber-100 dark:bg-amber-900/30',\n        displayName: 'Monthly'\n      };\n    case 'annual':\n      return { \n        icon: Sparkles, \n        color: 'text-gray-500', \n        bgColor: 'bg-gray-100 dark:bg-gray-800',\n        displayName: 'Annual'\n      };\n    case 'lifetime':\n      return { \n        icon: Crown, \n        color: 'text-yellow-600', \n        bgColor: 'bg-yellow-100 dark:bg-yellow-900/30',\n        displayName: 'Lifetime*'\n      };\n    default:\n      return { \n        icon: Star, \n        color: 'text-gray-500', \n        bgColor: 'bg-gray-100 dark:bg-gray-800',\n        displayName: tierType\n      };\n  }\n}\n\nexport function ProSubscriptionDialog({\n  isOpen,\n  onClose,\n  onSuccess,\n  onLoginRequired,\n  fromStreakSaver = false,\n  currentStreak = 0,\n  gameType,\n  onStreakLost,\n  onStayOnPage,\n}: ProSubscriptionDialogProps) {\n  const [selectedTier, setSelectedTier] = useState<TierData | null>(null);\n  const [showConfirmDialog, setShowConfirmDialog] = useState(false);\n  const [showExitWarning, setShowExitWarning] = useState(false);\n  const [isProcessing, setIsProcessing] = useState(false);\n  const { toast } = useToast();\n  const { isAuthenticated } = useAuth();\n  const queryClient = useQueryClient();\n\n  // Handle ESC key - show exit warning instead of closing directly when in streak saver flow\n  useEffect(() => {\n    if (!isOpen) return;\n    \n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.key === 'Escape') {\n        e.preventDefault();\n        e.stopPropagation();\n        \n        if (showConfirmDialog) {\n          setShowConfirmDialog(false);\n          setSelectedTier(null);\n        } else if (showExitWarning) {\n          // Do nothing - they need to make a choice\n        } else if (fromStreakSaver && currentStreak > 0) {\n          setShowExitWarning(true);\n        } else {\n          onClose();\n        }\n      }\n    };\n    \n    window.addEventListener('keydown', handleKeyDown, true);\n    return () => window.removeEventListener('keydown', handleKeyDown, true);\n  }, [isOpen, showConfirmDialog, showExitWarning, fromStreakSaver, currentStreak, onClose]);\n\n  // Fetch available tiers from API\n  const { data: tiers, isLoading: tiersLoading } = useQuery<TierData[]>({\n    queryKey: ['/api/tiers'],\n    queryFn: async () => {\n      const supabase = await getSupabaseClient();\n      const { data: { session } } = await supabase.auth.getSession();\n      if (!session) return [];\n\n      const response = await fetch('/api/tiers', {\n        credentials: 'include',\n        headers: {\n          'Authorization': `Bearer ${session.access_token}`,\n        },\n      });\n      \n      if (!response.ok) throw new Error('Failed to fetch tiers');\n      return response.json();\n    },\n    enabled: isOpen && isAuthenticated,\n    staleTime: 5 * 60 * 1000,\n  });\n\n  const handleBackClick = () => {\n    if (fromStreakSaver && currentStreak > 0) {\n      // Show warning that they'll lose their streak\n      setShowExitWarning(true);\n    } else {\n      onClose();\n    }\n  };\n\n  const handleConfirmExit = () => {\n    setShowExitWarning(false);\n    if (onStreakLost) {\n      onStreakLost();\n    } else {\n      onClose();\n    }\n  };\n\n  const handleCancelExit = () => {\n    setShowExitWarning(false);\n    if (onStayOnPage) {\n      onStayOnPage();\n    }\n  };\n\n  const handleTierClick = (tier: TierData) => {\n    console.log('[ProSubscriptionDialog] Tier clicked:', tier.tier, tier.tierType, 'id:', tier.id);\n    \n    if (!isAuthenticated) {\n      console.log('[ProSubscriptionDialog] User not authenticated, redirecting to login');\n      if (onLoginRequired) {\n        onLoginRequired();\n      } else {\n        toast({\n          title: 'Login Required',\n          description: 'Please log in to purchase a Pro subscription.',\n          variant: 'destructive',\n        });\n      }\n      return;\n    }\n\n    console.log('[ProSubscriptionDialog] User authenticated, showing confirm dialog for tier:', tier.id);\n    setSelectedTier(tier);\n    setShowConfirmDialog(true);\n  };\n\n  const handleConfirmSubscription = async () => {\n    if (!selectedTier) {\n      console.log('[ProSubscriptionDialog] No selected tier, aborting');\n      return;\n    }\n    \n    console.log('[ProSubscriptionDialog] Confirming subscription for tier:', selectedTier.id, selectedTier.tier, selectedTier.tierType);\n    setIsProcessing(true);\n    setShowConfirmDialog(false);\n\n    try {\n      const supabase = await getSupabaseClient();\n      const { data: { session } } = await supabase.auth.getSession();\n      \n      if (!session) {\n        console.log('[ProSubscriptionDialog] No session found');\n        throw new Error('No active session');\n      }\n\n      console.log('[ProSubscriptionDialog] Calling create-checkout API with tierId:', selectedTier.id);\n      const response = await fetch('/api/subscription/create-checkout', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session.access_token}`,\n        },\n        credentials: 'include',\n        body: JSON.stringify({ tierId: selectedTier.id }),\n      });\n\n      console.log('[ProSubscriptionDialog] API response status:', response.status);\n      \n      if (!response.ok) {\n        const errorData = await response.json();\n        console.log('[ProSubscriptionDialog] API error:', errorData);\n        throw new Error(errorData.error || 'Failed to create subscription');\n      }\n\n      const result = await response.json();\n      console.log('[ProSubscriptionDialog] API result:', result);\n      \n      if (result.success && result.url) {\n        // Stripe Checkout flow - redirect to Stripe\n        // Pending subscription row is already inserted server-side via RPC\n        console.log('[ProSubscriptionDialog] Redirecting to Stripe Checkout:', result.url);\n        window.location.href = result.url;\n        return; // Don't reset state - we're navigating away\n      } else if (result.success) {\n        // Direct subscription flow (legacy/fallback)\n        console.log('[ProSubscriptionDialog] Subscription created successfully');\n        // Invalidate subscription and streak saver queries to refresh UI\n        queryClient.invalidateQueries({ queryKey: ['/api/subscription'] });\n        queryClient.invalidateQueries({ queryKey: ['/api/streak-saver/status'] });\n        toast({\n          title: 'Success!',\n          description: 'Your subscription has been activated.',\n        });\n        onSuccess(selectedTier.tier);\n      }\n    } catch (error: any) {\n      console.error('[ProSubscriptionDialog] Subscription error:', error);\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to create subscription. Please try again.',\n        variant: 'destructive',\n      });\n    } finally {\n      setIsProcessing(false);\n      setSelectedTier(null);\n    }\n  };\n\n  // Handle backdrop click - show exit warning when in streak saver flow\n  const handleBackdropClick = useCallback((e: MouseEvent<HTMLDivElement>) => {\n    // Only handle clicks on the backdrop itself, not on children\n    if (e.target === e.currentTarget) {\n      if (fromStreakSaver && currentStreak > 0) {\n        setShowExitWarning(true);\n      } else {\n        onClose();\n      }\n    }\n  }, [fromStreakSaver, currentStreak, onClose]);\n\n  return (\n    <>\n    <AnimatePresence>\n      {isOpen && (\n        <motion.div\n          key=\"pro-subscription-dialog\"\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          exit={{ opacity: 0 }}\n          transition={{ duration: 0.3 }}\n          className=\"fixed inset-0 z-[100] bg-background flex flex-col\"\n          data-testid=\"pro-subscription-dialog\"\n          onClick={handleBackdropClick}\n        >\n          <div \n            className=\"absolute top-0 left-0 right-0 flex items-center p-4 z-[101]\"\n            onClick={(e) => e.stopPropagation()}\n          >\n            <button\n              onClick={handleBackClick}\n              className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n              data-testid=\"button-close-pro-dialog\"\n            >\n              <ChevronLeft className=\"h-9 w-9 text-gray-700 dark:text-gray-300\" />\n            </button>\n          </div>\n\n          <div \n            className=\"flex-1 flex flex-col items-center px-4 pt-16 pb-4 overflow-y-auto\"\n            onClick={(e) => e.stopPropagation()}\n          >\n            <div className=\"max-w-md w-full max-h-screen flex flex-col\" style={{ gap: 'clamp(1rem, 2vh, 1.5rem)' }}>\n              <div className=\"text-center flex flex-col items-center\" style={{ gap: 'clamp(0.5rem, 1vh, 0.75rem)' }}>\n                <img src={signupHamsterGrey} alt=\"Pro\" className=\"h-24 w-auto object-contain\" />\n                <h1 className=\"text-2xl font-bold text-foreground\" data-testid=\"text-pro-title\">\n                  Go Ad Free and Play Limitless Personalised Games!\n                </h1>\n              </div>\n\n              <div style={{ gap: 'clamp(0.75rem, 1.5vh, 1rem)' }} className=\"flex flex-col\">\n                {tiersLoading ? (\n                  <div className=\"flex justify-center py-8\">\n                    <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n                  </div>\n                ) : (\n                  <div className=\"grid grid-cols-3 gap-2\">\n                    {(tiers || []).map((tier) => {\n                      const style = getTierStyle(tier.tierType);\n                      const Icon = style.icon;\n                      const isSelected = selectedTier?.id === tier.id;\n                      \n                      return (\n                        <button\n                          key={tier.id}\n                          onClick={() => handleTierClick(tier)}\n                          disabled={isProcessing}\n                          className={`\n                            relative flex flex-col items-center p-4 rounded-2xl transition-all\n                            ${isSelected ? 'ring-2 ring-primary/20' : ''}\n                            ${style.bgColor}\n                            disabled:opacity-50 disabled:cursor-not-allowed\n                          `}\n                          data-testid={`button-tier-${tier.tierType}`}\n                        >\n                          <Icon className={`h-8 w-8 mb-2 ${style.color}`} />\n                          <span className=\"font-bold text-sm text-foreground\">{style.displayName}</span>\n                          <span className=\"text-lg font-bold text-foreground mt-1\">\n                            {formatPrice(tier.subscriptionCost, tier.currency)}\n                          </span>\n                          \n                          {isSelected && isProcessing && (\n                            <div className=\"absolute inset-0 flex items-center justify-center bg-background/80 rounded-2xl\">\n                              <div className=\"w-6 h-6 border-2 border-primary border-t-transparent rounded-full animate-spin\" />\n                            </div>\n                          )}\n                        </button>\n                      );\n                    })}\n                  </div>\n                )}\n              </div>\n\n              <div style={{ gap: 'clamp(0.75rem, 1vh, 1rem)' }} className=\"flex flex-col items-center max-w-sm\">\n                <h3 className=\"font-semibold text-foreground text-xl\">Benefits of Pro:</h3>\n                <ul style={{ gap: 'clamp(0.5rem, 1vh, 0.75rem)' }} className=\"flex flex-col w-full\">\n                  {[\n                    'No banner ads anywhere',\n                    'No ads after completing puzzles',\n                    'Unlimited personalised games',\n                    'Choose your own categories',\n                    '6 monthly Streak Savers (3 per game)',\n                    '4 streak protecting annual holiday periods',\n                  ].map((benefit, index) => (\n                    <li key={index} className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                      <Check className=\"h-4 w-4 text-green-500 flex-shrink-0\" />\n                      <span>{benefit}</span>\n                    </li>\n                  ))}\n                </ul>\n                <p className=\"text-xs text-gray-400 dark:text-gray-600 mt-4 text-center\">\n                  *always a pro member for the full serviceable life of the game\n                </p>\n              </div>\n            </div>\n          </div>\n        </motion.div>\n      )}\n    </AnimatePresence>\n\n    {/* Subscription Confirm Dialog */}\n    {showConfirmDialog && selectedTier && (\n      <div \n        className=\"fixed inset-0 z-[200] flex items-center justify-center bg-black/80\"\n        data-testid=\"confirm-subscription-dialog\"\n        onClick={(e) => {\n          if (e.target === e.currentTarget) {\n            setShowConfirmDialog(false);\n            setSelectedTier(null);\n          }\n        }}\n      >\n        <div \n          className=\"bg-background border rounded-lg p-6 max-w-sm mx-4 shadow-lg\"\n          onClick={(e) => e.stopPropagation()}\n        >\n          <h2 className=\"text-lg font-semibold mb-2\">Confirm Subscription</h2>\n          <p className=\"text-sm text-muted-foreground mb-4\">\n            You are about to subscribe to <strong>{getTierStyle(selectedTier.tierType).displayName}</strong> for{' '}\n            <strong>{formatPrice(selectedTier.subscriptionCost, selectedTier.currency)}</strong>.\n            <br /><br />\n            Do you want to continue?\n          </p>\n          <div className=\"flex flex-col-reverse sm:flex-row sm:justify-end gap-2\">\n            <Button \n              variant=\"outline\"\n              onClick={() => {\n                setShowConfirmDialog(false);\n                setSelectedTier(null);\n              }}\n              data-testid=\"button-cancel-subscription\"\n            >\n              Cancel\n            </Button>\n            <Button \n              onClick={handleConfirmSubscription}\n              data-testid=\"button-confirm-subscription\"\n            >\n              Yes\n            </Button>\n          </div>\n        </div>\n      </div>\n    )}\n\n    {/* Exit Warning Dialog for Streak Saver Flow */}\n    {showExitWarning && (\n      <div \n        className=\"fixed inset-0 z-[200] flex items-center justify-center bg-black/80\"\n        data-testid=\"streak-exit-warning-dialog\"\n      >\n        <div \n          className=\"bg-background border rounded-lg p-6 max-w-sm mx-4 shadow-lg\"\n          onClick={(e) => e.stopPropagation()}\n        >\n          <div className=\"flex items-center gap-2 mb-4\">\n            <AlertTriangle className=\"h-6 w-6 text-orange-500\" />\n            <h2 className=\"text-lg font-semibold\">Are you sure?</h2>\n          </div>\n          <p className=\"text-sm text-muted-foreground mb-4\">\n            If you exit now without subscribing, you will lose your <strong className=\"text-orange-500\">{currentStreak} day streak</strong>.\n          </p>\n          <div className=\"flex flex-col gap-2\">\n            <Button \n              onClick={handleCancelExit}\n              className=\"w-full\"\n              data-testid=\"button-stay-on-page\"\n            >\n              Stay on Page\n            </Button>\n            <Button \n              variant=\"ghost\"\n              onClick={handleConfirmExit}\n              className=\"w-full text-muted-foreground\"\n              data-testid=\"button-exit-lose-streak\"\n            >\n              Exit and Lose Streak\n            </Button>\n          </div>\n        </div>\n      </div>\n    )}\n    </>\n  );\n}\n","path":null,"size_bytes":17342,"size_tokens":null},"client/src/components/GoProButton.tsx":{"content":"import { useSubscription } from '@/hooks/useSubscription';\n\ninterface GoProButtonProps {\n  onClick: () => void;\n  isPro?: boolean;\n}\n\nexport function GoProButton({ onClick, isPro: externalIsPro }: GoProButtonProps) {\n  const { isPro: hookIsPro } = useSubscription();\n  const isPro = externalIsPro ?? hookIsPro;\n\n  if (isPro) {\n    return (\n      <button\n        onClick={onClick}\n        className=\"flex items-center justify-center px-3 py-1.5 rounded-lg bg-gradient-to-b from-orange-400 to-orange-500 shadow-sm hover:shadow-md transition-all\"\n        data-testid=\"button-pro-status\"\n      >\n        <span className=\"text-sm font-bold text-white\">Pro</span>\n      </button>\n    );\n  }\n\n  return (\n    <button\n      onClick={onClick}\n      className=\"flex flex-col items-center justify-center px-2 py-1.5 rounded-lg bg-gradient-to-b from-orange-400 to-orange-500 shadow-sm hover:shadow-md transition-all\"\n      data-testid=\"button-go-pro\"\n    >\n      <div className=\"flex items-center gap-0.5\">\n        <div className=\"w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse\" />\n        <span className=\"text-[10px] font-normal text-white\">Ads on</span>\n      </div>\n      <span className=\"text-xs font-bold text-white\">Go Pro</span>\n    </button>\n  );\n}\n","path":null,"size_bytes":1250,"size_tokens":null},"client/src/components/AdBanner.tsx":{"content":"import { useEffect, useRef, useState, createContext, useContext } from 'react';\nimport { useSubscription } from '@/hooks/useSubscription';\n\ndeclare global {\n  interface Window {\n    adsbygoogle: any[];\n  }\n}\n\ninterface AdBannerProps {\n  className?: string;\n}\n\n// Context to track if ads should be shown on current screen\nexport const AdBannerContext = createContext<boolean>(true);\n\nexport function useAdBannerVisibility() {\n  return useContext(AdBannerContext);\n}\n\n// Hook that returns whether the ad banner is actually visible (combines isPro + screen context)\n// Use this to determine if bottom padding is needed\nexport function useAdBannerActive() {\n  const { isPro } = useSubscription();\n  const shouldShowOnScreen = useAdBannerVisibility();\n  return !isPro && shouldShowOnScreen;\n}\n\nexport function AdBanner({ className = '' }: AdBannerProps) {\n  const adRef = useRef<HTMLModElement>(null);\n  const [adLoaded, setAdLoaded] = useState(false);\n  const [adError, setAdError] = useState(false);\n  const { isPro } = useSubscription();\n  const shouldShowBanner = useAdBannerVisibility();\n\n  useEffect(() => {\n    if (isPro || !shouldShowBanner) return;\n    \n    const loadAd = () => {\n      try {\n        if (typeof window !== 'undefined' && window.adsbygoogle && adRef.current) {\n          (window.adsbygoogle = window.adsbygoogle || []).push({});\n          setAdLoaded(true);\n        }\n      } catch (e) {\n        console.error('AdSense error:', e);\n        setAdError(true);\n      }\n    };\n\n    if (!document.querySelector('script[src*=\"adsbygoogle\"]')) {\n      const script = document.createElement('script');\n      script.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js';\n      script.async = true;\n      script.crossOrigin = 'anonymous';\n      script.onload = loadAd;\n      script.onerror = () => setAdError(true);\n      document.head.appendChild(script);\n    } else {\n      loadAd();\n    }\n  }, [isPro]);\n\n  if (isPro || !shouldShowBanner) return null;\n\n  // In development/test mode, always show the test banner placeholder\n  const showTestBanner = !adLoaded || adError;\n\n  return (\n    <div \n      id=\"banner-ad\" \n      className={`fixed bottom-0 left-0 right-0 z-[90] ${className}`}\n      style={{ minHeight: '50px' }}\n      data-testid=\"ad-banner-container\"\n    >\n      {!showTestBanner && (\n        <ins \n          ref={adRef}\n          className=\"adsbygoogle\"\n          style={{ display: 'block', width: '100%', height: '50px' }}\n          data-ad-client=\"ca-pub-3940256099942544\"\n          data-ad-slot=\"6300978111\"\n          data-ad-format=\"banner\"\n          data-full-width-responsive=\"true\"\n        />\n      )}\n      {showTestBanner && (\n        <div \n          className=\"flex items-center justify-center h-[50px] border-t border-gray-300 dark:border-gray-600\"\n          style={{\n            background: 'linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 50%, #f0f0f0 100%)',\n          }}\n        >\n          <div className=\"flex items-center gap-3\">\n            <div className=\"flex items-center justify-center w-8 h-8 rounded bg-blue-500 text-white text-xs font-bold\">\n              AD\n            </div>\n            <div className=\"flex flex-col\">\n              <span className=\"text-sm font-medium text-gray-700\">Test Advertisement</span>\n              <span className=\"text-xs text-gray-500\">Go Pro for ad-free experience</span>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":3446,"size_tokens":null},"client/src/components/InterstitialAd.tsx":{"content":"import { useState, useEffect, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { X } from 'lucide-react';\nimport { useSubscription } from '@/hooks/useSubscription';\n\ninterface InterstitialAdProps {\n  isOpen: boolean;\n  onClose: () => void;\n}\n\nexport function InterstitialAd({ isOpen, onClose }: InterstitialAdProps) {\n  const [countdown, setCountdown] = useState(5);\n  const [canClose, setCanClose] = useState(false);\n  const { isPro } = useSubscription();\n\n  useEffect(() => {\n    if (!isOpen || isPro) return;\n\n    setCountdown(5);\n    setCanClose(false);\n\n    const timer = setInterval(() => {\n      setCountdown((prev) => {\n        if (prev <= 1) {\n          setCanClose(true);\n          clearInterval(timer);\n          return 0;\n        }\n        return prev - 1;\n      });\n    }, 1000);\n\n    return () => clearInterval(timer);\n  }, [isOpen, isPro]);\n\n  const handleClose = useCallback(() => {\n    if (canClose) {\n      onClose();\n    }\n  }, [canClose, onClose]);\n\n  if (isPro) {\n    onClose();\n    return null;\n  }\n\n  return (\n    <AnimatePresence>\n      {isOpen && (\n        <motion.div\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          exit={{ opacity: 0 }}\n          transition={{ duration: 0.3 }}\n          className=\"fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center\"\n          data-testid=\"interstitial-ad-overlay\"\n        >\n          <div className=\"absolute top-4 right-4\">\n            <button\n              onClick={handleClose}\n              disabled={!canClose}\n              className={`w-12 h-12 flex items-center justify-center rounded-full transition-all ${\n                canClose \n                  ? 'bg-white/20 hover:bg-white/30 cursor-pointer' \n                  : 'bg-white/10 cursor-not-allowed'\n              }`}\n              data-testid=\"button-close-interstitial\"\n            >\n              {canClose ? (\n                <X className=\"h-6 w-6 text-white\" />\n              ) : (\n                <span className=\"text-white font-bold text-lg\">{countdown}</span>\n              )}\n            </button>\n          </div>\n\n          <div className=\"flex-1 flex items-center justify-center w-full max-w-2xl px-4\">\n            <div \n              className=\"w-full h-[300px] bg-gray-800 rounded-lg flex items-center justify-center\"\n              data-testid=\"interstitial-ad-container\"\n            >\n              <div className=\"text-center text-white\">\n                <p className=\"text-lg font-semibold mb-2\">Advertisement</p>\n                <p className=\"text-sm text-gray-400\">\n                  Google Interstitial Ad\n                </p>\n                <p className=\"text-xs text-gray-500 mt-2\">\n                  Test Ad Unit: ca-pub-3940256099942544/1033173712\n                </p>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"pb-8 text-center\">\n            {!canClose && (\n              <p className=\"text-gray-400 text-sm\">\n                Ad closes in {countdown} seconds...\n              </p>\n            )}\n            {canClose && (\n              <p className=\"text-gray-400 text-sm\">\n                Tap X to continue\n              </p>\n            )}\n          </div>\n        </motion.div>\n      )}\n    </AnimatePresence>\n  );\n}\n\nexport function useInterstitialAd() {\n  const [showAd, setShowAd] = useState(false);\n  const [onAdClosed, setOnAdClosed] = useState<(() => void) | null>(null);\n\n  const triggerAd = useCallback((callback: () => void) => {\n    setOnAdClosed(() => callback);\n    setShowAd(true);\n  }, []);\n\n  const handleClose = useCallback(() => {\n    setShowAd(false);\n    if (onAdClosed) {\n      onAdClosed();\n      setOnAdClosed(null);\n    }\n  }, [onAdClosed]);\n\n  return {\n    showAd,\n    triggerAd,\n    handleClose,\n    InterstitialAdComponent: () => (\n      <InterstitialAd isOpen={showAd} onClose={handleClose} />\n    ),\n  };\n}\n","path":null,"size_bytes":3929,"size_tokens":null},"client/src/hooks/useSubscription.ts":{"content":"import { useQuery } from '@tanstack/react-query';\nimport { useAuth } from './useAuth';\nimport { getSupabaseClient } from '@/lib/supabaseClient';\n\ninterface TierMetadata {\n  streakSavers: number;\n  holidaySavers: number;\n  holidayDurationDays: number;\n  subscriptionCost: number | null;\n  currency: string;\n  subscriptionDurationMonths: number | null;\n  description: string | null;\n  sortOrder: number | null;\n}\n\nexport interface SubscriptionData {\n  tier: 'free' | 'pro';\n  tierName: string;\n  tierType: 'monthly' | 'annual' | 'lifetime' | 'default';\n  tierId: string | null;\n  userId: string | null;\n  endDate: string | null;\n  autoRenew: boolean;\n  isActive: boolean;\n  isExpired: boolean;\n  metadata: TierMetadata | null;\n\n  // New fields\n  stripeSubscriptionId?: string | null;\n  stripeCustomerId?: string | null;\n  stripePriceId?: string | null;\n}\n\nconst FREE_SUBSCRIPTION: SubscriptionData = {\n  tier: 'free',\n  tierName: 'Standard',\n  tierType: 'default',\n  tierId: null,\n  userId: null,\n  endDate: null,\n  autoRenew: false,\n  isActive: true, // Standard tier is always active\n  isExpired: false,\n  metadata: {\n    streakSavers: 1,\n    holidaySavers: 0,\n    holidayDurationDays: 14,\n    subscriptionCost: 0,\n    currency: 'GBP',\n    subscriptionDurationMonths: null,\n    description: 'Free tier',\n    sortOrder: 0,\n  },\n};\n\nexport function useSubscription() {\n  const { isAuthenticated, user } = useAuth();\n\n  const { data: subscription, isLoading, refetch } = useQuery<SubscriptionData>({\n    queryKey: ['/api/subscription', user?.id],\n    queryFn: async () => {\n      if (!isAuthenticated || !user) return FREE_SUBSCRIPTION;\n      \n      try {\n        const supabase = await getSupabaseClient();\n        const { data: { session } } = await supabase.auth.getSession();\n        if (!session) return FREE_SUBSCRIPTION;\n\n        const response = await fetch('/api/subscription', {\n          credentials: 'include',\n          headers: {\n            'Authorization': `Bearer ${session.access_token}`,\n          },\n        });\n        \n        if (!response.ok) {\n          if (response.status === 404) {\n            return FREE_SUBSCRIPTION;\n          }\n          throw new Error('Failed to fetch subscription');\n        }\n        \n        const data = await response.json();\n        \n        return {\n          tier: data.tier || 'free',\n          tierName: data.tierName || 'Standard',\n          tierType: data.tierType || 'default',\n          tierId: data.tierId ?? null,\n          userId: data.userId ?? null,\n          endDate: data.endDate ?? null,\n          autoRenew: data.autoRenew ?? false,\n          isActive: data.isActive ?? false,\n          isExpired: data.isExpired ?? false,\n          metadata: data.metadata ?? FREE_SUBSCRIPTION.metadata,\n\n          // Pass through Stripe fields\n          stripeSubscriptionId: data.stripeSubscriptionId ?? null,\n          stripeCustomerId: data.stripeCustomerId ?? null,\n          stripePriceId: data.stripePriceId ?? null,\n        };\n      } catch (error) {\n        console.error('Error fetching subscription:', error);\n        return FREE_SUBSCRIPTION;\n      }\n    },\n    enabled: isAuthenticated && !!user,\n    staleTime: 5 * 60 * 1000,\n  });\n\n  const effectiveSubscription = subscription || FREE_SUBSCRIPTION;\n  const tier = effectiveSubscription.tier;\n  const tierName = effectiveSubscription.tierName;\n  const tierType = effectiveSubscription.tierType;\n  const isPro = tier === 'pro' && effectiveSubscription.isActive;\n  const isExpired = effectiveSubscription.isExpired;\n  \n  const isProMonthly = isPro && tierType === 'monthly';\n  const isProAnnual = isPro && tierType === 'annual';\n  const isProLifetime = isPro && tierType === 'lifetime';\n  \n  const isGold = isProLifetime;\n  const isSilver = isProAnnual;\n  const isBronze = isProMonthly;\n\n  const needsRenewal = tier === 'pro' && isExpired && !effectiveSubscription.isActive;\n  const canRenew = isExpired && tierType !== 'lifetime';\n\n  return {\n    subscription: effectiveSubscription,\n    tier,\n    tierName,\n    tierType,\n    isPro,\n    isExpired,\n    needsRenewal,\n    canRenew,\n    isProMonthly,\n    isProAnnual,\n    isProLifetime,\n    isGold,\n    isSilver,\n    isBronze,\n    isLoading,\n    refetch,\n    streakSavers: effectiveSubscription.metadata?.streakSavers ?? 1,\n    holidaySavers: effectiveSubscription.metadata?.holidaySavers ?? 0,\n    holidayDurationDays: effectiveSubscription.metadata?.holidayDurationDays ?? 14,\n    endDate: effectiveSubscription.endDate,\n    autoRenew: effectiveSubscription.autoRenew,\n  };\n}\n","path":null,"size_bytes":4543,"size_tokens":null},"client/src/components/ScreenAdBanner.tsx":{"content":"import { useEffect, useRef, useState, useMemo } from 'react';\nimport { useSubscription } from '@/hooks/useSubscription';\n\ndeclare global {\n  interface Window {\n    adsbygoogle: any[];\n  }\n}\n\ninterface ScreenAdBannerProps {\n  screenId: string;\n}\n\nexport function ScreenAdBanner({ screenId }: ScreenAdBannerProps) {\n  const adRef = useRef<HTMLModElement>(null);\n  const [adLoaded, setAdLoaded] = useState(false);\n  const [adError, setAdError] = useState(false);\n  const { isPro, isLoading: subscriptionLoading } = useSubscription();\n  \n  const instanceKey = useMemo(() => `${screenId}-${Date.now()}`, [screenId]);\n\n  useEffect(() => {\n    if (subscriptionLoading || isPro) return;\n    \n    setAdLoaded(false);\n    setAdError(false);\n    \n    const loadAd = () => {\n      try {\n        if (typeof window !== 'undefined' && adRef.current) {\n          (window.adsbygoogle = window.adsbygoogle || []).push({});\n          setAdLoaded(true);\n        }\n      } catch (e) {\n        console.error('AdSense error:', e);\n        setAdError(true);\n      }\n    };\n\n    const timer = setTimeout(() => {\n      if (!document.querySelector('script[src*=\"adsbygoogle\"]')) {\n        const script = document.createElement('script');\n        script.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js';\n        script.async = true;\n        script.crossOrigin = 'anonymous';\n        script.onload = loadAd;\n        script.onerror = () => setAdError(true);\n        document.head.appendChild(script);\n      } else {\n        loadAd();\n      }\n    }, 100);\n    \n    return () => clearTimeout(timer);\n  }, [isPro, subscriptionLoading, instanceKey]);\n\n  if (subscriptionLoading) return null;\n  if (isPro) return null;\n\n  const showTestBanner = adError || !adLoaded;\n\n  return (\n    <div \n      key={instanceKey}\n      id={`banner-ad-${screenId}`}\n      className=\"fixed bottom-0 left-0 right-0 z-[90]\"\n      style={{ minHeight: '50px' }}\n      data-testid={`ad-banner-${screenId}`}\n    >\n      <ins \n        ref={adRef}\n        className=\"adsbygoogle\"\n        style={{ \n          display: adLoaded && !adError ? 'block' : 'none', \n          width: '100%', \n          height: '50px' \n        }}\n        data-ad-client=\"ca-pub-3940256099942544\"\n        data-ad-slot=\"6300978111\"\n        data-ad-format=\"banner\"\n        data-full-width-responsive=\"true\"\n      />\n      {showTestBanner && (\n        <div \n          className=\"flex items-center justify-center h-[50px] border-t border-gray-300 dark:border-gray-600\"\n          style={{\n            background: 'linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 50%, #f0f0f0 100%)',\n          }}\n        >\n          <div className=\"flex items-center gap-3\">\n            <div className=\"flex items-center justify-center w-8 h-8 rounded bg-blue-500 text-white text-xs font-bold\">\n              AD\n            </div>\n            <div className=\"flex flex-col\">\n              <span className=\"text-sm font-medium text-gray-700\">Test Advertisement</span>\n              <span className=\"text-xs text-gray-500\">Go Pro for ad-free experience</span>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":3144,"size_tokens":null},"client/src/hooks/useRealtimeSubscriptions.ts":{"content":"import { useEffect, useCallback, useRef } from 'react';\nimport { useQueryClient } from '@tanstack/react-query';\nimport { useSupabase } from '@/lib/SupabaseProvider';\nimport type { RealtimeChannel } from '@supabase/supabase-js';\n\ninterface UseRealtimeSubscriptionsOptions {\n  userId: string | null | undefined;\n  region: string;\n  isAuthenticated: boolean;\n}\n\nexport function useRealtimeSubscriptions({ userId, region, isAuthenticated }: UseRealtimeSubscriptionsOptions) {\n  const supabase = useSupabase();\n  const queryClient = useQueryClient();\n  const channelRef = useRef<RealtimeChannel | null>(null);\n  const currentRegionRef = useRef<string | null>(null);\n  const currentUserIdRef = useRef<string | null>(null);\n  const isSubscribedRef = useRef(false);\n  \n  // Store queryClient in a ref to avoid dependency issues\n  const queryClientRef = useRef(queryClient);\n  queryClientRef.current = queryClient;\n\n  // Refetch functions - use refetchQueries to force immediate refetch regardless of staleTime\n  // This is necessary because staleTime: Infinity means invalidateQueries alone won't trigger refetch\n  const invalidateGlobalData = useCallback(() => {\n    console.log('[Realtime] Refetching global data');\n    queryClientRef.current.refetchQueries({\n      predicate: (query) => {\n        const key = query.queryKey[0];\n        if (typeof key !== 'string') return false;\n        return key.startsWith('/api/puzzles') || \n               key === '/api/game-attempts/user' ||\n               key === '/api/stats' ||\n               key === '/api/stats/percentile';\n      }\n    });\n  }, []);\n\n  const invalidateLocalData = useCallback(() => {\n    console.log('[Realtime] Refetching local data');\n    queryClientRef.current.refetchQueries({\n      predicate: (query) => {\n        const key = query.queryKey[0];\n        if (typeof key !== 'string') return false;\n        return key.startsWith('/api/user/puzzles') || \n               key === '/api/user/game-attempts/user' ||\n               key === '/api/user/stats' ||\n               key === '/api/user/stats/percentile';\n      }\n    });\n  }, []);\n\n  const invalidateProfile = useCallback(() => {\n    console.log('[Realtime] Refetching profile data');\n    queryClientRef.current.refetchQueries({ queryKey: ['/api/auth/profile'] });\n    queryClientRef.current.refetchQueries({ queryKey: ['/api/user/settings'] });\n    queryClientRef.current.refetchQueries({ queryKey: ['/api/user/preferences'] });\n  }, []);\n\n  const invalidateCategories = useCallback(() => {\n    console.log('[Realtime] Refetching category preferences');\n    queryClientRef.current.refetchQueries({ queryKey: ['/api/user/categories'] });\n    queryClientRef.current.refetchQueries({ queryKey: ['/api/categories'] });\n  }, []);\n\n  useEffect(() => {\n    // Helper to cleanup channel\n    const cleanupChannel = () => {\n      if (channelRef.current) {\n        console.log('[Realtime] Cleaning up existing channel');\n        supabase.removeChannel(channelRef.current).catch((error) => {\n          console.warn('[Realtime] Error removing channel:', error);\n        });\n        channelRef.current = null;\n        isSubscribedRef.current = false;\n      }\n    };\n\n    // Skip if not authenticated or no userId\n    if (!isAuthenticated || !userId) {\n      cleanupChannel();\n      currentUserIdRef.current = null;\n      currentRegionRef.current = null;\n      return;\n    }\n\n    // Check if we already have an active subscription for this user/region\n    if (\n      isSubscribedRef.current &&\n      channelRef.current && \n      userId === currentUserIdRef.current && \n      region === currentRegionRef.current\n    ) {\n      // No changes needed, channel is already set up\n      return;\n    }\n\n    // Cleanup existing channel before creating a new one\n    cleanupChannel();\n    \n    currentUserIdRef.current = userId;\n    currentRegionRef.current = region;\n\n    console.log('[Realtime] Setting up subscriptions for user:', userId, 'region:', region);\n\n    const channelName = `elementle-realtime-${userId}-${Date.now()}`;\n    const channel = supabase.channel(channelName);\n\n    // User allocations - refresh both local AND global data\n    channel.on(\n      'postgres_changes',\n      { \n        event: 'INSERT', \n        schema: 'public', \n        table: 'questions_allocated_user', \n        filter: `user_id=eq.${userId}` \n      },\n      (payload) => {\n        console.log('[Realtime] User allocation INSERT:', payload);\n        invalidateLocalData();\n        invalidateGlobalData();\n      }\n    );\n\n    // Region allocations\n    channel.on(\n      'postgres_changes',\n      { \n        event: 'INSERT', \n        schema: 'public', \n        table: 'questions_allocated_region', \n        filter: `region=eq.${region}` \n      },\n      (payload) => {\n        console.log('[Realtime] Region allocation INSERT:', payload);\n        invalidateGlobalData();\n      }\n    );\n\n    // Location allocations - refresh profile and both data sources\n    channel.on(\n      'postgres_changes',\n      { \n        event: '*', \n        schema: 'public', \n        table: 'location_allocation', \n        filter: `user_id=eq.${userId}` \n      },\n      (payload) => {\n        console.log('[Realtime] Location allocation change:', payload);\n        invalidateProfile();\n        invalidateGlobalData();\n        invalidateLocalData();\n      }\n    );\n\n    // Category preferences - refresh categories and local data\n    channel.on(\n      'postgres_changes',\n      { \n        event: '*', \n        schema: 'public', \n        table: 'user_category_preferences', \n        filter: `user_id=eq.${userId}` \n      },\n      (payload) => {\n        console.log('[Realtime] Category preferences change:', payload);\n        invalidateCategories();\n        invalidateLocalData();\n      }\n    );\n\n    // Profile updates\n    channel.on(\n      'postgres_changes',\n      { \n        event: 'UPDATE', \n        schema: 'public', \n        table: 'user_profiles', \n        filter: `user_id=eq.${userId}` \n      },\n      (payload) => {\n        console.log('[Realtime] Profile update:', payload);\n        invalidateProfile();\n      }\n    );\n\n    // Subscribe with status callback for error handling\n    channel.subscribe((status, error) => {\n      console.log('[Realtime] Subscription status:', status);\n      \n      if (status === 'SUBSCRIBED') {\n        channelRef.current = channel;\n        isSubscribedRef.current = true;\n      } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {\n        console.warn('[Realtime] Subscription failed with status:', status, error);\n        isSubscribedRef.current = false;\n        supabase.removeChannel(channel).catch((e) => {\n          console.warn('[Realtime] Error cleaning up failed channel:', e);\n        });\n      }\n    });\n\n    // Cleanup on unmount or when dependencies change\n    return cleanupChannel;\n    // Note: invalidate* functions are stable (empty deps + using refs) so not included in deps array\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [isAuthenticated, userId, region, supabase]);\n\n  // Return manual refresh functions for use by components if needed\n  return {\n    refreshGlobalData: invalidateGlobalData,\n    refreshLocalData: invalidateLocalData,\n    refreshProfile: invalidateProfile,\n    refreshCategories: invalidateCategories,\n    refreshAllData: useCallback(() => {\n      invalidateGlobalData();\n      invalidateLocalData();\n      invalidateProfile();\n      invalidateCategories();\n    }, [invalidateGlobalData, invalidateLocalData, invalidateProfile, invalidateCategories]),\n  };\n}\n","path":null,"size_bytes":7526,"size_tokens":null},"client/src/components/AdminPage.tsx":{"content":"import { useState, useEffect, useMemo } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { ChevronLeft, Shield, Clock, CalendarClock, Zap, Layers } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useAdBannerActive } from \"@/components/AdBanner\";\nimport { useSupabase } from \"@/lib/SupabaseProvider\";\nimport { AdminScreenNavigator } from \"@/components/AdminScreenNavigator\";\n\ninterface AdminPageProps {\n  onBack: () => void;\n}\n\ninterface SchedulerConfig {\n  start_time: string;\n  frequency_hours: number;\n  exists: boolean;\n}\n\ninterface TierVisibility {\n  id: string;\n  tier: string;\n  tierType: string;\n  active: boolean;\n  region: string;\n}\n\nfunction calculateNextRunTimes(startTime: string, frequencyHours: number, count: number = 4): Date[] {\n  const [hours, minutes] = startTime.split(':').map(Number);\n  const now = new Date();\n  const runTimes: Date[] = [];\n  \n  // Calculate all run hours based on start time and frequency\n  const runHours: number[] = [];\n  let currentHour = hours;\n  \n  for (let i = 0; i < Math.floor(24 / frequencyHours); i++) {\n    runHours.push(currentHour);\n    currentHour = (currentHour + frequencyHours) % 24;\n  }\n  \n  runHours.sort((a, b) => a - b);\n  \n  // Find next run times\n  let checkDate = new Date(now);\n  checkDate.setSeconds(0, 0);\n  \n  while (runTimes.length < count) {\n    for (const hour of runHours) {\n      const runTime = new Date(checkDate);\n      runTime.setHours(hour, minutes, 0, 0);\n      \n      if (runTime > now && runTimes.length < count) {\n        runTimes.push(runTime);\n      }\n    }\n    // Move to next day\n    checkDate.setDate(checkDate.getDate() + 1);\n    checkDate.setHours(0, 0, 0, 0);\n  }\n  \n  return runTimes.slice(0, count);\n}\n\nfunction formatDateTime(date: Date): string {\n  return date.toLocaleString('en-GB', {\n    weekday: 'short',\n    day: 'numeric',\n    month: 'short',\n    hour: '2-digit',\n    minute: '2-digit',\n    hour12: false\n  });\n}\n\nexport function AdminPage({ onBack }: AdminPageProps) {\n  const { toast } = useToast();\n  const { user } = useAuth();\n  const supabase = useSupabase();\n  const adBannerActive = useAdBannerActive();\n  const [showScreenNavigator, setShowScreenNavigator] = useState(false);\n  \n  // Postcode/Region restriction state\n  const [postcodeRestrictionDays, setPostcodeRestrictionDays] = useState<string>(\"14\");\n  \n  // Category restriction state (Pro users)\n  const [categoryRestrictionDays, setCategoryRestrictionDays] = useState<string>(\"14\");\n  \n  // Demand scheduler state\n  const [schedulerStartTime, setSchedulerStartTime] = useState<string>(\"01:00\");\n  const [schedulerFrequency, setSchedulerFrequency] = useState<string>(\"24\");\n  const [schedulerConfigExists, setSchedulerConfigExists] = useState(false);\n  \n  // Tier visibility state\n  const [tiers, setTiers] = useState<TierVisibility[]>([]);\n  const [tierVisibilityMap, setTierVisibilityMap] = useState<Record<string, boolean>>({});\n  \n  // Loading states\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n  const [savingScheduler, setSavingScheduler] = useState(false);\n  const [fixingTrigger, setFixingTrigger] = useState(false);\n  const [savingTiers, setSavingTiers] = useState(false);\n\n  useEffect(() => {\n    const fetchSettings = async () => {\n      try {\n        const session = (await supabase.auth.getSession()).data.session;\n        const accessToken = session?.access_token;\n        \n        // Fetch admin settings, demand scheduler, and tiers in parallel\n        const [settingsResponse, schedulerResponse, tiersResponse] = await Promise.all([\n          fetch('/api/admin/settings', {\n            headers: { 'Authorization': `Bearer ${accessToken}` },\n          }),\n          fetch('/api/admin/demand-scheduler', {\n            headers: { 'Authorization': `Bearer ${accessToken}` },\n          }),\n          fetch('/api/admin/tiers', {\n            headers: { 'Authorization': `Bearer ${accessToken}` },\n          }),\n        ]);\n        \n        if (settingsResponse.ok) {\n          const settings = await settingsResponse.json();\n          const postcodeSetting = settings.find((s: any) => s.key === 'postcode_restriction_days');\n          if (postcodeSetting) {\n            setPostcodeRestrictionDays(postcodeSetting.value);\n          }\n          const categorySetting = settings.find((s: any) => s.key === 'category_restriction_days');\n          if (categorySetting) {\n            setCategoryRestrictionDays(categorySetting.value);\n          }\n        }\n        \n        if (schedulerResponse.ok) {\n          const schedulerConfig: SchedulerConfig = await schedulerResponse.json();\n          setSchedulerStartTime(schedulerConfig.start_time);\n          setSchedulerFrequency(schedulerConfig.frequency_hours.toString());\n          setSchedulerConfigExists(schedulerConfig.exists);\n        }\n        \n        if (tiersResponse.ok) {\n          const tiersData: TierVisibility[] = await tiersResponse.json();\n          setTiers(tiersData);\n          const visibilityMap: Record<string, boolean> = {};\n          tiersData.forEach(t => {\n            visibilityMap[t.id] = t.active;\n          });\n          setTierVisibilityMap(visibilityMap);\n        }\n      } catch (error) {\n        console.error('Error fetching admin settings:', error);\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    fetchSettings();\n  }, [supabase]);\n\n  const handleSave = async () => {\n    setSaving(true);\n    try {\n      const session = (await supabase.auth.getSession()).data.session;\n      const accessToken = session?.access_token;\n      \n      // Save both settings in parallel\n      const [postcodeResponse, categoryResponse] = await Promise.all([\n        fetch('/api/admin/settings', {\n          method: 'PUT',\n          headers: {\n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${accessToken}`,\n          },\n          body: JSON.stringify({\n            key: 'postcode_restriction_days',\n            value: postcodeRestrictionDays,\n            description: 'Number of days between allowed postcode/region changes',\n          }),\n        }),\n        fetch('/api/admin/settings', {\n          method: 'PUT',\n          headers: {\n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${accessToken}`,\n          },\n          body: JSON.stringify({\n            key: 'category_restriction_days',\n            value: categoryRestrictionDays,\n            description: 'Number of days between allowed category changes (Pro users)',\n          }),\n        }),\n      ]);\n\n      if (!postcodeResponse.ok || !categoryResponse.ok) {\n        const errorData = await (postcodeResponse.ok ? categoryResponse : postcodeResponse).json().catch(() => ({}));\n        throw new Error(errorData.error || 'Failed to save settings');\n      }\n\n      toast({\n        title: \"Settings saved\",\n        description: \"Restriction settings have been updated.\",\n      });\n      \n      // Also fix the database trigger to respect the new settings\n      await handleFixTrigger(false); // Silent update - no separate toast\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save settings\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setSaving(false);\n    }\n  };\n  \n  const handleFixTrigger = async (showToast: boolean = true) => {\n    setFixingTrigger(true);\n    try {\n      const session = (await supabase.auth.getSession()).data.session;\n      const accessToken = session?.access_token;\n      \n      const response = await fetch('/api/admin/fix-postcode-trigger', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${accessToken}`,\n        },\n      });\n      \n      const data = await response.json();\n      \n      if (!response.ok) {\n        throw new Error(data.error || 'Failed to fix trigger');\n      }\n      \n      if (showToast) {\n        toast({\n          title: \"Trigger updated\",\n          description: data.message || \"Database trigger has been fixed.\",\n        });\n      }\n    } catch (error: any) {\n      if (showToast) {\n        toast({\n          title: \"Error\",\n          description: error.message || \"Failed to fix trigger. You may need to run the SQL manually in Supabase.\",\n          variant: \"destructive\",\n        });\n      }\n      console.error('Error fixing trigger:', error);\n    } finally {\n      setFixingTrigger(false);\n    }\n  };\n\n  const handleSaveScheduler = async () => {\n    setSavingScheduler(true);\n    try {\n      const session = (await supabase.auth.getSession()).data.session;\n      const accessToken = session?.access_token;\n      \n      // Save the scheduler config\n      const saveResponse = await fetch('/api/admin/demand-scheduler', {\n        method: 'PUT',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${accessToken}`,\n        },\n        body: JSON.stringify({\n          start_time: schedulerStartTime,\n          frequency_hours: parseInt(schedulerFrequency, 10),\n        }),\n      });\n\n      if (!saveResponse.ok) {\n        const errorData = await saveResponse.json().catch(() => ({}));\n        throw new Error(errorData.error || 'Failed to save scheduler config');\n      }\n\n      // Apply the new schedule by calling the Edge Function\n      const applyResponse = await fetch('/api/admin/demand-scheduler/apply', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${accessToken}`,\n        },\n      });\n\n      if (!applyResponse.ok) {\n        const errorData = await applyResponse.json().catch(() => ({}));\n        // Still show success for config save, but warn about apply failure\n        toast({\n          title: \"Config saved, but schedule not applied\",\n          description: `The config was saved, but the cron job could not be updated: ${errorData.details || errorData.error || 'Unknown error'}`,\n          variant: \"destructive\",\n        });\n        setSchedulerConfigExists(true);\n        return;\n      }\n\n      setSchedulerConfigExists(true);\n      toast({\n        title: \"Scheduler updated\",\n        description: \"The demand scheduler has been configured and applied.\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save scheduler config\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setSavingScheduler(false);\n    }\n  };\n\n  const handleSaveTierVisibility = async () => {\n    setSavingTiers(true);\n    try {\n      const session = (await supabase.auth.getSession()).data.session;\n      const accessToken = session?.access_token;\n      \n      // Save all tier visibility changes\n      const updates = Object.entries(tierVisibilityMap).map(([tierId, active]) => ({\n        tierId,\n        active,\n      }));\n      \n      const response = await fetch('/api/admin/tiers', {\n        method: 'PUT',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${accessToken}`,\n        },\n        body: JSON.stringify({ updates }),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(errorData.error || 'Failed to save tier visibility');\n      }\n\n      toast({\n        title: \"Tier settings saved\",\n        description: \"Subscription tier visibility has been updated.\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save tier settings\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setSavingTiers(false);\n    }\n  };\n\n  // Calculate next run times preview\n  const nextRunTimes = useMemo(() => {\n    return calculateNextRunTimes(schedulerStartTime, parseInt(schedulerFrequency, 10), 4);\n  }, [schedulerStartTime, schedulerFrequency]);\n\n  const dayOptions = Array.from({ length: 61 }, (_, i) => i);\n  const frequencyOptions = [\n    { value: \"6\", label: \"Every 6 hours\" },\n    { value: \"8\", label: \"Every 8 hours\" },\n    { value: \"12\", label: \"Every 12 hours\" },\n    { value: \"24\", label: \"Every 24 hours (daily)\" },\n  ];\n\n  if (showScreenNavigator) {\n    return <AdminScreenNavigator onBack={() => setShowScreenNavigator(false)} />;\n  }\n\n  return (\n    <div className={`min-h-screen flex flex-col p-4 bg-background ${adBannerActive ? 'pb-[50px]' : ''}`}>\n      <div className=\"w-full max-w-md mx-auto space-y-4\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <button\n            onClick={onBack}\n            data-testid=\"button-back-from-admin\"\n            className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n          >\n            <ChevronLeft className=\"h-9 w-9 text-gray-700 dark:text-gray-300\" />\n          </button>\n\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-3xl font-bold\">Admin</h1>\n          </div>\n\n          <div className=\"w-14\" />\n        </div>\n\n        {loading ? (\n          <div className=\"flex justify-center py-8\">\n            <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\"></div>\n          </div>\n        ) : (\n          <>\n            <Button\n              onClick={() => setShowScreenNavigator(true)}\n              variant=\"outline\"\n              className=\"w-full mb-4 justify-start gap-2\"\n              data-testid=\"button-screen-navigator\"\n            >\n              <Layers className=\"h-4 w-4\" />\n              Screen Navigator (Test Screens)\n            </Button>\n\n            {/* Restriction Settings Card */}\n            <Card className=\"p-6 space-y-6\">\n              <div className=\"flex items-center gap-2 pb-4 border-b\">\n                <Shield className=\"h-5 w-5 text-red-500\" />\n                <span className=\"font-semibold text-red-600 dark:text-red-400\">Change Restrictions</span>\n              </div>\n\n              {/* Postcode/Region Restriction */}\n              <div className=\"space-y-3\">\n                <Label htmlFor=\"postcode-restriction\" className=\"text-base font-semibold\">\n                  Postcode/Region Change Restriction\n                </Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Number of days users must wait before changing their postcode or region again.\n                </p>\n                <Select\n                  value={postcodeRestrictionDays}\n                  onValueChange={setPostcodeRestrictionDays}\n                >\n                  <SelectTrigger id=\"postcode-restriction\" data-testid=\"select-postcode-days\">\n                    <SelectValue placeholder=\"Select days\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {dayOptions.map((days) => (\n                      <SelectItem key={days} value={days.toString()}>\n                        {days === 0 ? \"No restriction\" : `${days} day${days === 1 ? '' : 's'}`}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                <p className=\"text-xs text-muted-foreground\">\n                  Current setting: {postcodeRestrictionDays === \"0\" \n                    ? \"Users can change postcode/region anytime\" \n                    : `Users must wait ${postcodeRestrictionDays} days between changes`}\n                </p>\n              </div>\n\n              {/* Category Restriction (Pro users) */}\n              <div className=\"space-y-3 pt-4 border-t\">\n                <Label htmlFor=\"category-restriction\" className=\"text-base font-semibold\">\n                  Category Change Restriction (Pro)\n                </Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Number of days Pro users must wait before changing their category preferences again.\n                </p>\n                <Select\n                  value={categoryRestrictionDays}\n                  onValueChange={setCategoryRestrictionDays}\n                >\n                  <SelectTrigger id=\"category-restriction\" data-testid=\"select-category-days\">\n                    <SelectValue placeholder=\"Select days\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {dayOptions.map((days) => (\n                      <SelectItem key={days} value={days.toString()}>\n                        {days === 0 ? \"No restriction\" : `${days} day${days === 1 ? '' : 's'}`}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                <p className=\"text-xs text-muted-foreground\">\n                  Current setting: {categoryRestrictionDays === \"0\" \n                    ? \"Pro users can change categories anytime\" \n                    : `Pro users must wait ${categoryRestrictionDays} days between changes`}\n                </p>\n              </div>\n\n              <Button\n                className=\"w-full\"\n                onClick={handleSave}\n                disabled={saving || fixingTrigger}\n                data-testid=\"button-save-admin-settings\"\n              >\n                {saving ? \"Saving...\" : \"Save Restriction Settings\"}\n              </Button>\n              \n              <div className=\"pt-4 border-t\">\n                <p className=\"text-xs text-muted-foreground mb-2\">\n                  If postcode changes are being blocked by the database, click below to sync the database trigger with the current settings.\n                </p>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  className=\"w-full\"\n                  onClick={() => handleFixTrigger(true)}\n                  disabled={fixingTrigger || saving}\n                  data-testid=\"button-fix-trigger\"\n                >\n                  {fixingTrigger ? \"Fixing Trigger...\" : \"Fix Database Trigger\"}\n                </Button>\n              </div>\n            </Card>\n\n            {/* Subscription Tier Visibility Card */}\n            <Card className=\"p-6 space-y-6\">\n              <div className=\"flex items-center gap-2 pb-4 border-b\">\n                <Zap className=\"h-5 w-5 text-purple-500\" />\n                <span className=\"font-semibold text-purple-600 dark:text-purple-400\">Subscription Tier Visibility</span>\n              </div>\n\n              <div className=\"space-y-4\">\n                <p className=\"text-sm text-muted-foreground\">\n                  Toggle which subscription tiers are available for purchase. Pro tiers are enabled by default, others are disabled.\n                </p>\n                \n                <div className=\"space-y-3 max-h-60 overflow-y-auto bg-muted/30 rounded-md p-3\">\n                  {tiers.length === 0 ? (\n                    <p className=\"text-sm text-muted-foreground text-center py-4\">No subscription tiers found.</p>\n                  ) : (\n                    tiers.filter(t => t.tier !== 'Standard').map((tier) => (\n                      <div key={tier.id} className=\"flex items-center justify-between p-3 rounded-md bg-background border\">\n                        <div className=\"flex flex-col gap-1 flex-1\">\n                          <span className=\"font-medium\">{tier.tier}</span>\n                          <span className=\"text-xs text-muted-foreground capitalize\">{tier.tierType}  {tier.region}</span>\n                        </div>\n                        <Switch\n                          checked={tierVisibilityMap[tier.id] ?? tier.active}\n                          onCheckedChange={(checked) => {\n                            setTierVisibilityMap(prev => ({\n                              ...prev,\n                              [tier.id]: checked,\n                            }));\n                          }}\n                          data-testid={`toggle-tier-${tier.id}`}\n                        />\n                      </div>\n                    ))\n                  )}\n                </div>\n              </div>\n\n              <Button\n                className=\"w-full\"\n                onClick={handleSaveTierVisibility}\n                disabled={savingTiers}\n                data-testid=\"button-save-tier-visibility\"\n              >\n                {savingTiers ? \"Saving...\" : \"Save Tier Visibility\"}\n              </Button>\n            </Card>\n\n            {/* Demand Scheduler Card */}\n            <Card className=\"p-6 space-y-6\">\n              <div className=\"flex items-center gap-2 pb-4 border-b\">\n                <CalendarClock className=\"h-5 w-5 text-blue-500\" />\n                <span className=\"font-semibold text-blue-600 dark:text-blue-400\">Demand Scheduler</span>\n              </div>\n\n              <div className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"scheduler-start-time\" className=\"text-base font-semibold\">\n                    Start Time (24-hour format)\n                  </Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    First scheduled run time of the day.\n                  </p>\n                  <div className=\"flex items-center gap-2\">\n                    <Clock className=\"h-5 w-5 text-muted-foreground\" />\n                    <Input\n                      id=\"scheduler-start-time\"\n                      type=\"time\"\n                      value={schedulerStartTime}\n                      onChange={(e) => setSchedulerStartTime(e.target.value)}\n                      className=\"w-32\"\n                      data-testid=\"input-scheduler-start-time\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"scheduler-frequency\" className=\"text-base font-semibold\">\n                    Frequency\n                  </Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    How often to run the demand calculation.\n                  </p>\n                  <Select\n                    value={schedulerFrequency}\n                    onValueChange={setSchedulerFrequency}\n                  >\n                    <SelectTrigger id=\"scheduler-frequency\" data-testid=\"select-scheduler-frequency\">\n                      <SelectValue placeholder=\"Select frequency\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {frequencyOptions.map((option) => (\n                        <SelectItem key={option.value} value={option.value}>\n                          {option.label}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                {/* Next Run Times Preview */}\n                <div className=\"space-y-2 pt-2\">\n                  <Label className=\"text-sm font-medium text-muted-foreground\">\n                    Next Scheduled Runs\n                  </Label>\n                  <div className=\"bg-muted/50 rounded-md p-3 space-y-1\">\n                    {nextRunTimes.map((time, index) => (\n                      <div \n                        key={index} \n                        className=\"text-sm flex items-center gap-2\"\n                        data-testid={`text-next-run-${index}`}\n                      >\n                        <span className=\"text-muted-foreground w-6\">{index + 1}.</span>\n                        <span className=\"font-mono\">{formatDateTime(time)}</span>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n\n                {!schedulerConfigExists && (\n                  <p className=\"text-xs text-amber-600 dark:text-amber-400\">\n                    No scheduler config exists yet. Save to create one.\n                  </p>\n                )}\n              </div>\n\n              <Button\n                className=\"w-full\"\n                onClick={handleSaveScheduler}\n                disabled={savingScheduler}\n                data-testid=\"button-save-scheduler\"\n              >\n                {savingScheduler ? \"Applying Schedule...\" : \"Save & Apply Schedule\"}\n              </Button>\n            </Card>\n\n            <p className=\"text-xs text-muted-foreground text-center\">\n              Changes take effect immediately after saving.\n            </p>\n          </>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":24874,"size_tokens":null},"DEMAND_SCHEDULER_SETUP.md":{"content":"# Demand Scheduler Setup\n\nThis document contains the setup instructions for the Demand Scheduler feature in the Admin Panel.\n\n## Prerequisites\n\nEnsure these environment variables are set in your Replit project (they should already exist if Supabase is configured):\n- `SUPABASE_URL` - Your Supabase project URL\n- `SUPABASE_ANON_KEY` - Your Supabase anonymous key\n- `SUPABASE_SERVICE_ROLE_KEY` - Your Supabase service role key (for Edge Function)\n\n## 1. Database Table\n\nRun this SQL in your Supabase SQL Editor to create the required table:\n\n```sql\n-- Create demand_scheduler_config table (singleton - only ONE row should ever exist)\nCREATE TABLE IF NOT EXISTS public.demand_scheduler_config (\n  id uuid PRIMARY KEY,\n  start_time text NOT NULL, -- format 'HH:mm'\n  frequency_hours integer NOT NULL CHECK (frequency_hours > 0),\n  updated_at timestamp with time zone DEFAULT now(),\n  updated_by uuid REFERENCES user_profiles(id)\n);\n\n-- Insert the singleton config with a fixed ID (01:00 daily default)\n-- The app always uses this fixed ID for upserts\nINSERT INTO public.demand_scheduler_config (id, start_time, frequency_hours)\nVALUES ('00000000-0000-0000-0000-000000000001', '01:00', 24)\nON CONFLICT (id) DO NOTHING;\n\n-- Grant access to authenticated users (admins will be checked in API)\nALTER TABLE public.demand_scheduler_config ENABLE ROW LEVEL SECURITY;\n\n-- Policy for admins to manage demand scheduler config\nCREATE POLICY \"Allow admins to manage demand scheduler config\"\n  ON public.demand_scheduler_config\n  FOR ALL\n  USING (auth.jwt() ->> 'is_admin' = 'true')\n  WITH CHECK (auth.jwt() ->> 'is_admin' = 'true');\n\n-- Allow service role full access (needed for Edge Function)\nCREATE POLICY \"Allow service role full access\"\n  ON public.demand_scheduler_config\n  FOR ALL\n  USING (auth.role() = 'service_role');\n```\n\n### Cleanup: If you have duplicate rows\n\nIf you already created the table and have multiple rows, run this to clean up:\n\n```sql\n-- Step 1: Delete all rows except keep the most recent one\nDELETE FROM demand_scheduler_config\nWHERE id NOT IN (\n  SELECT id FROM demand_scheduler_config \n  ORDER BY updated_at DESC \n  LIMIT 1\n);\n\n-- Step 2: Update the remaining row to use the singleton ID\nUPDATE demand_scheduler_config\nSET id = '00000000-0000-0000-0000-000000000001'\nWHERE id != '00000000-0000-0000-0000-000000000001';\n\n-- Verify: Should show exactly 1 row with the singleton ID\nSELECT * FROM demand_scheduler_config;\n```\n\n## 2. Database Function for Cron Update\n\nCreate this PostgreSQL function to allow updating the cron schedule. This must be created before deploying the Edge Function:\n\n```sql\n-- Function to update the demand cron schedule\n-- This function uses SECURITY DEFINER to run with elevated privileges\nCREATE OR REPLACE FUNCTION update_demand_cron_schedule(new_schedule text)\nRETURNS void\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nDECLARE\n  job_id bigint;\nBEGIN\n  -- Find the job ID for elementle_demand\n  SELECT jobid INTO job_id\n  FROM cron.job\n  WHERE jobname = 'elementle_demand';\n  \n  IF job_id IS NULL THEN\n    RAISE EXCEPTION 'Cron job elementle_demand not found. Please ensure the cron job exists.';\n  END IF;\n  \n  -- Update the schedule\n  PERFORM cron.alter_job(job_id, schedule := new_schedule);\nEND;\n$$;\n\n-- Grant execute permission to service role\nGRANT EXECUTE ON FUNCTION update_demand_cron_schedule(text) TO service_role;\n```\n\n## 3. Edge Function: update-demand-schedule\n\nCreate a new Edge Function in Supabase called `update-demand-schedule`.\n\n### Deployment Steps:\n1. Go to Supabase Dashboard > Edge Functions\n2. Click \"New Function\"\n3. Name it `update-demand-schedule`\n4. Paste the code below and deploy\n\n### File: supabase/functions/update-demand-schedule/index.ts\n\n```typescript\nimport { createClient } from 'https://esm.sh/@supabase/supabase-js@2'\n\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type, x-user-access-token',\n}\n\ninterface SchedulerConfig {\n  id: string\n  start_time: string\n  frequency_hours: number\n}\n\nfunction calculateCronExpression(startTime: string, frequencyHours: number): string {\n  const [hours, minutes] = startTime.split(':').map(Number)\n  \n  if (frequencyHours === 24) {\n    // Daily at the specified time\n    return `${minutes} ${hours} * * *`\n  }\n  \n  // Calculate all run hours based on start time and frequency\n  const runHours: number[] = []\n  let currentHour = hours\n  \n  for (let i = 0; i < Math.floor(24 / frequencyHours); i++) {\n    runHours.push(currentHour)\n    currentHour = (currentHour + frequencyHours) % 24\n  }\n  \n  // Sort hours and format as comma-separated list\n  runHours.sort((a, b) => a - b)\n  \n  return `${minutes} ${runHours.join(',')} * * *`\n}\n\nDeno.serve(async (req) => {\n  // Handle CORS preflight\n  if (req.method === 'OPTIONS') {\n    return new Response('ok', { headers: corsHeaders })\n  }\n\n  try {\n    // Initialize Supabase client with service role for cron job management\n    const supabaseUrl = Deno.env.get('SUPABASE_URL')!\n    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!\n    \n    const supabase = createClient(supabaseUrl, supabaseServiceKey)\n\n    // Get the user access token from custom header (passed from backend)\n    // The backend authenticates with anon key, but passes user token for admin verification\n    const userAccessToken = req.headers.get('x-user-access-token')\n    \n    if (!userAccessToken) {\n      return new Response(\n        JSON.stringify({ error: 'Missing user access token' }),\n        { status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n      )\n    }\n\n    // Verify the user token and check admin status\n    const { data: { user }, error: authError } = await supabase.auth.getUser(userAccessToken)\n    \n    if (authError || !user) {\n      return new Response(\n        JSON.stringify({ error: 'Invalid user token' }),\n        { status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n      )\n    }\n\n    // Check if user is admin\n    const { data: profile, error: profileError } = await supabase\n      .from('user_profiles')\n      .select('is_admin')\n      .eq('id', user.id)\n      .single()\n\n    if (profileError || !profile?.is_admin) {\n      return new Response(\n        JSON.stringify({ error: 'Admin access required' }),\n        { status: 403, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n      )\n    }\n\n    // Fetch the current scheduler config\n    const { data: config, error: configError } = await supabase\n      .from('demand_scheduler_config')\n      .select('*')\n      .single()\n\n    if (configError || !config) {\n      return new Response(\n        JSON.stringify({ error: 'No scheduler config found', details: configError?.message }),\n        { status: 404, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n      )\n    }\n\n    const typedConfig = config as SchedulerConfig\n    \n    // Calculate the new cron expression\n    const cronExpression = calculateCronExpression(\n      typedConfig.start_time,\n      typedConfig.frequency_hours\n    )\n\n    console.log(`Updating cron job with expression: ${cronExpression}`)\n\n    // Update the existing cron job 'elementle_demand' using the RPC function\n    const { error: updateError } = await supabase.rpc(\n      'update_demand_cron_schedule',\n      { new_schedule: cronExpression }\n    )\n\n    if (updateError) {\n      console.error('Error updating cron job:', updateError)\n      return new Response(\n        JSON.stringify({ \n          error: 'Failed to update cron job',\n          details: updateError.message,\n          cronExpression \n        }),\n        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n      )\n    }\n\n    return new Response(\n      JSON.stringify({\n        success: true,\n        message: 'Cron job updated successfully',\n        cronExpression,\n        startTime: typedConfig.start_time,\n        frequencyHours: typedConfig.frequency_hours\n      }),\n      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n    )\n\n  } catch (error) {\n    console.error('Error in update-demand-schedule:', error)\n    return new Response(\n      JSON.stringify({ error: 'Internal server error', details: error.message }),\n      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n    )\n  }\n})\n```\n\n## 4. Ensure Cron Job Exists\n\nBefore using the scheduler, ensure the `elementle_demand` cron job exists in Supabase. This should already be set up, but you can verify with:\n\n```sql\nSELECT * FROM cron.job WHERE jobname = 'elementle_demand';\n```\n\nIf it doesn't exist, create it:\n\n```sql\nSELECT cron.schedule(\n  'elementle_demand',\n  '0 1 * * *', -- Default: daily at 01:00 UTC\n  $$SELECT net.http_post(\n    url := 'https://YOUR_PROJECT_REF.supabase.co/functions/v1/calculate-demand',\n    headers := '{\"Authorization\": \"Bearer YOUR_SERVICE_ROLE_KEY\"}'::jsonb,\n    body := '{}'::jsonb\n  )$$\n);\n```\n\n## 5. Usage\n\n1. Navigate to Admin page in the app (Settings > Admin, visible only to admins)\n2. In the \"Demand Scheduler\" section:\n   - Set the **Start Time** (24-hour format, e.g., \"01:00\")\n   - Set the **Frequency** (6, 8, 12, or 24 hours)\n3. Click \"Save & Apply Schedule\"\n4. The preview will show the next 4 scheduled run times\n\n## Cron Expression Examples\n\n| Start Time | Frequency | Cron Expression |\n|------------|-----------|-----------------|\n| 01:00 | 24 hours | `0 1 * * *` (daily at 01:00) |\n| 01:00 | 12 hours | `0 1,13 * * *` (at 01:00 and 13:00) |\n| 01:00 | 6 hours | `0 1,7,13,19 * * *` (at 01:00, 07:00, 13:00, 19:00) |\n| 00:30 | 8 hours | `30 0,8,16 * * *` (at 00:30, 08:30, 16:30) |\n\n## Troubleshooting\n\n### \"Cron job elementle_demand not found\" error\nThis means the cron job hasn't been created yet. Follow step 4 above to create it.\n\n### \"No scheduler config found\" error\nRun the SQL in step 1 to create the config table and insert a default row.\n\n### Edge Function returns 401\nEnsure the backend is passing the user access token via the `x-user-access-token` header. Check that `SUPABASE_ANON_KEY` and `SUPABASE_URL` are set in your environment.\n\n### Edge Function returns 403\nThe user making the request is not an admin. Verify `is_admin` is set to `true` in the `user_profiles` table for that user.\n","path":null,"size_bytes":10289,"size_tokens":null},"SUBSCRIPTION_TIER_SETUP.md":{"content":"# Subscription Tier System Setup\n\nThis document explains how to set up the new dynamic subscription tier system in Supabase.\n\n## Overview\n\nThe new subscription system replaces the hardcoded tier definitions with a database-driven approach:\n- **`user_tier`** table: Defines available subscription tiers per region with pricing\n- **`user_subscriptions`** table: Tracks user subscription history\n- **`user_active_tier_view`** view: Resolves the active tier for each user\n\n## Backward Compatibility\n\nThe system includes graceful fallback to the legacy `user_profiles.tier` column:\n- If the new tables don't exist, the app continues to work with the old system\n- Legacy tiers are shown in the Pro dialog until the new tables are created\n- Once tables exist, the app automatically uses the new tier system\n\n## Database Setup\n\n### 1. Create the `user_tier` Table\n\n```sql\nCREATE TABLE IF NOT EXISTS user_tier (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  region VARCHAR(10) NOT NULL,\n  tier VARCHAR(50) NOT NULL,\n  subscription_cost INTEGER,\n  currency VARCHAR(3),\n  subscription_duration_months INTEGER,\n  streak_savers INTEGER DEFAULT 0,\n  holiday_savers INTEGER DEFAULT 0,\n  holiday_duration_days INTEGER DEFAULT 0,\n  description TEXT,\n  sort_order INTEGER DEFAULT 0,\n  active BOOLEAN DEFAULT true,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\nCREATE INDEX idx_user_tier_region ON user_tier(region);\nCREATE INDEX idx_user_tier_active ON user_tier(active);\n```\n\n### 2. Create the `user_subscriptions` Table\n\n```sql\nCREATE TABLE IF NOT EXISTS user_subscriptions (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n  user_tier_id UUID NOT NULL REFERENCES user_tier(id),\n  amount_paid INTEGER,\n  currency VARCHAR(3),\n  expires_at TIMESTAMPTZ,\n  auto_renew BOOLEAN DEFAULT false,\n  source VARCHAR(50) DEFAULT 'web',\n  validity VARCHAR(20) DEFAULT 'active',\n  effective_start_at TIMESTAMPTZ DEFAULT NOW(),\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\nCREATE INDEX idx_user_subscriptions_user_id ON user_subscriptions(user_id);\nCREATE INDEX idx_user_subscriptions_validity ON user_subscriptions(validity);\n```\n\n### 3. Create the `user_active_tier_view` View\n\nThis view resolves the active tier for each user, falling back to 'standard' if no active subscription:\n\n```sql\nCREATE OR REPLACE VIEW user_active_tier_view AS\nSELECT \n  u.id AS user_id,\n  COALESCE(ut.id, st.id) AS tier_id,\n  COALESCE(ut.tier, 'standard') AS tier,\n  COALESCE(ut.region, 'UK') AS region,\n  ut.subscription_cost,\n  ut.currency,\n  ut.subscription_duration_months,\n  COALESCE(ut.streak_savers, 0) AS streak_savers,\n  COALESCE(ut.holiday_savers, 0) AS holiday_savers,\n  COALESCE(ut.holiday_duration_days, 0) AS holiday_duration_days,\n  ut.description,\n  us.expires_at,\n  us.auto_renew,\n  CASE WHEN us.id IS NOT NULL AND us.validity = 'active' AND (us.expires_at IS NULL OR us.expires_at > NOW()) THEN true ELSE false END AS is_active\nFROM auth.users u\nLEFT JOIN user_subscriptions us ON us.user_id = u.id \n  AND us.validity = 'active' \n  AND (us.expires_at IS NULL OR us.expires_at > NOW())\nLEFT JOIN user_tier ut ON ut.id = us.user_tier_id\nLEFT JOIN user_tier st ON st.tier = 'standard' AND st.region = 'UK';\n```\n\n### 4. Insert Standard Tier Definitions\n\nInsert the default UK tiers (modify pricing/currency for other regions):\n\n```sql\nINSERT INTO user_tier (region, tier, subscription_cost, currency, subscription_duration_months, streak_savers, holiday_savers, holiday_duration_days, description, sort_order) VALUES\n  ('UK', 'standard', NULL, NULL, NULL, 0, 0, 0, 'Free tier with ads', 0),\n  ('UK', 'pro_monthly', 79, 'GBP', 1, 1, 0, 0, 'Auto-renews monthly', 1),\n  ('UK', 'pro_annual', 699, 'GBP', 12, 3, 1, 7, 'Auto-renews annually', 2),\n  ('UK', 'pro_lifetime', 1199, 'GBP', NULL, 999, 999, 365, 'One off - Best value', 3);\n```\n\n### 5. Add Column to user_profiles (if not exists)\n\nAdd the `user_tier_id` column to track the current tier FK:\n\n```sql\nALTER TABLE user_profiles \nADD COLUMN IF NOT EXISTS user_tier_id UUID REFERENCES user_tier(id);\n```\n\n### 6. Create Sync Trigger (Optional)\n\nCreate a trigger to sync `user_profiles.tier` when subscriptions change:\n\n```sql\nCREATE OR REPLACE FUNCTION sync_user_tier_on_subscription() \nRETURNS TRIGGER AS $$\nBEGIN\n  UPDATE user_profiles \n  SET \n    tier = (SELECT tier FROM user_tier WHERE id = NEW.user_tier_id),\n    user_tier_id = NEW.user_tier_id,\n    updated_at = NOW()\n  WHERE id = NEW.user_id;\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER trg_sync_user_tier\nAFTER INSERT OR UPDATE ON user_subscriptions\nFOR EACH ROW\nEXECUTE FUNCTION sync_user_tier_on_subscription();\n```\n\n## Multi-Region Pricing\n\nTo support different pricing per region, insert additional rows:\n\n```sql\nINSERT INTO user_tier (region, tier, subscription_cost, currency, subscription_duration_months, description, sort_order) VALUES\n  ('US', 'standard', NULL, NULL, NULL, 'Free tier with ads', 0),\n  ('US', 'pro_monthly', 99, 'USD', 1, 'Auto-renews monthly', 1),\n  ('US', 'pro_annual', 899, 'USD', 12, 'Auto-renews annually', 2),\n  ('US', 'pro_lifetime', 1499, 'USD', NULL, 'One off - Best value', 3);\n```\n\n## API Endpoints\n\nThe following API endpoints are updated:\n\n- **GET `/api/subscription`**: Returns user's active tier from `user_active_tier_view`\n- **GET `/api/tiers`**: Returns available purchasable tiers for user's region\n- **POST `/api/subscription/create-checkout`**: Creates subscription with `tierId` (UUID)\n\n## Frontend Components\n\n- **`useSubscription`** hook: Now includes `tierName`, `metadata` (streakSavers, holidaySavers, etc.)\n- **`ProSubscriptionDialog`**: Fetches tiers dynamically from `/api/tiers`\n","path":null,"size_bytes":5767,"size_tokens":null},"client/src/hooks/useStreakSaverStatus.ts":{"content":"import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useAuth } from \"./useAuth\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nexport interface StreakSaverAllowances {\n  streakSaversPerMonth: number;\n  holidaySaversPerYear: number;\n  holidaysUsedThisYear: number;\n  holidayDurationDays: number;\n  isPro: boolean;\n}\n\nexport interface StreakSaverStatus {\n  region: {\n    currentStreak: number;\n    streakSaversUsedMonth: number;\n    missedYesterdayFlag: boolean;\n    canUseStreakSaver: boolean; // true only if missed just yesterday (played day before)\n    hasValidStreakForHoliday: boolean; // true if current_streak > 0 AND recent streak activity within 7 days\n  } | null;\n  user: {\n    currentStreak: number;\n    streakSaversUsedMonth: number;\n    holidayActive: boolean;\n    holidayStartDate: string | null;\n    holidayEndDate: string | null;\n    holidayDaysTakenCurrentPeriod: number;\n    holidayEnded: boolean;\n    missedYesterdayFlag: boolean;\n    canUseStreakSaver: boolean; // true only if missed just yesterday (played day before)\n    hasValidStreakForHoliday: boolean; // true if current_streak > 0 AND recent streak activity within 7 days\n  } | null;\n  allowances: StreakSaverAllowances | null;\n}\n\nexport function useStreakSaverStatus() {\n  const { isAuthenticated } = useAuth();\n  const queryClient = useQueryClient();\n\n  const { data: status, isLoading, refetch } = useQuery<StreakSaverStatus>({\n    queryKey: [\"/api/streak-saver/status\"],\n    enabled: isAuthenticated,\n    staleTime: 30000,\n  });\n\n  const useStreakSaverMutation = useMutation({\n    mutationFn: async (gameType: \"region\" | \"user\") => {\n      const response = await apiRequest(\"POST\", \"/api/streak-saver/use\", { gameType });\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/streak-saver/status\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stats\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/user/stats\"] });\n    },\n  });\n\n  const declineStreakSaverMutation = useMutation({\n    mutationFn: async (gameType: \"region\" | \"user\") => {\n      const response = await apiRequest(\"POST\", \"/api/streak-saver/decline\", { gameType });\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/streak-saver/status\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stats\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/user/stats\"] });\n    },\n  });\n\n  const startHolidayMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/holiday/start\");\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/streak-saver/status\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/user/stats\"] });\n    },\n  });\n\n  const endHolidayMutation = useMutation({\n    mutationFn: async (acknowledge?: boolean) => {\n      const response = await apiRequest(\"POST\", \"/api/holiday/end\", { acknowledge: acknowledge ?? false });\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/streak-saver/status\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/user/stats\"] });\n    },\n  });\n\n  const clearHolidayMissedFlagsMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/streak-saver/clear-holiday\");\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/streak-saver/status\"] });\n    },\n  });\n\n  const hasMissedRegion = status?.region?.missedYesterdayFlag ?? false;\n  const hasMissedUser = status?.user?.missedYesterdayFlag ?? false;\n  const hasMissedAny = hasMissedRegion || hasMissedUser;\n  \n  // Can use streak saver only if missed just yesterday (played day before)\n  const regionCanUseStreakSaver = status?.region?.canUseStreakSaver ?? false;\n  const userCanUseStreakSaver = status?.user?.canUseStreakSaver ?? false;\n  \n  const holidayActive = status?.user?.holidayActive ?? false;\n  const holidayEndDate = status?.user?.holidayEndDate ?? null;\n  const holidayStartDate = status?.user?.holidayStartDate ?? null;\n  const holidayEnded = status?.user?.holidayEnded ?? false;\n  const holidayDaysTakenCurrentPeriod = status?.user?.holidayDaysTakenCurrentPeriod ?? 0;\n  \n  const regionStreakSaversRemaining = status?.allowances \n    ? status.allowances.streakSaversPerMonth - (status?.region?.streakSaversUsedMonth ?? 0)\n    : 0;\n  const userStreakSaversRemaining = status?.allowances \n    ? status.allowances.streakSaversPerMonth - (status?.user?.streakSaversUsedMonth ?? 0)\n    : 0;\n    \n  const holidaysRemaining = status?.allowances\n    ? status.allowances.holidaySaversPerYear - status.allowances.holidaysUsedThisYear\n    : 0;\n  \n  // Check if either game mode has a valid streak for holiday protection\n  const regionHasValidStreakForHoliday = status?.region?.hasValidStreakForHoliday ?? false;\n  const userHasValidStreakForHoliday = status?.user?.hasValidStreakForHoliday ?? false;\n  const hasAnyValidStreakForHoliday = regionHasValidStreakForHoliday || userHasValidStreakForHoliday;\n\n  return {\n    status,\n    isLoading,\n    refetch,\n    hasMissedRegion,\n    hasMissedUser,\n    hasMissedAny,\n    regionCanUseStreakSaver,\n    userCanUseStreakSaver,\n    holidayActive,\n    holidayStartDate,\n    holidayEndDate,\n    holidayEnded,\n    holidayDaysTakenCurrentPeriod,\n    regionStreakSaversRemaining,\n    userStreakSaversRemaining,\n    holidaysRemaining,\n    regionHasValidStreakForHoliday,\n    userHasValidStreakForHoliday,\n    hasAnyValidStreakForHoliday,\n    isPro: status?.allowances?.isPro ?? false,\n    holidayDurationDays: status?.allowances?.holidayDurationDays ?? 0,\n    useStreakSaver: useStreakSaverMutation.mutateAsync,\n    isUsingStreakSaver: useStreakSaverMutation.isPending,\n    declineStreakSaver: declineStreakSaverMutation.mutateAsync,\n    isDeclining: declineStreakSaverMutation.isPending,\n    startHoliday: startHolidayMutation.mutateAsync,\n    isStartingHoliday: startHolidayMutation.isPending,\n    endHoliday: endHolidayMutation.mutateAsync,\n    isEndingHoliday: endHolidayMutation.isPending,\n    acknowledgeHolidayEnd: () => endHolidayMutation.mutateAsync(true),\n    isAcknowledging: endHolidayMutation.isPending,\n    clearHolidayMissedFlags: clearHolidayMissedFlagsMutation.mutateAsync,\n    isClearingHolidayMissedFlags: clearHolidayMissedFlagsMutation.isPending,\n  };\n}\n","path":null,"size_bytes":6588,"size_tokens":null},"client/src/components/StreakSaverPopup.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { ProSubscriptionDialog } from \"./ProSubscriptionDialog\";\nimport { useStreakSaverStatus } from \"@/hooks/useStreakSaverStatus\";\nimport { useStreakSaver } from \"@/contexts/StreakSaverContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useProfile } from \"@/hooks/useProfile\";\nimport { Flame, Umbrella } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { clearArchiveCache } from \"@/lib/localCache\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport hamsterStreakSaver from \"@assets/Historian-Hamster-Blue.svg\";\n\nimport Streak_Hamster_Black from \"@assets/Streak-Hamster-Black.svg\";\n\ninterface HolidayAnimationData {\n  regionHolidayDates: string[];\n  userHolidayDates: string[];\n  showUserAfterRegion: boolean;\n  holidayDurationDays: number;\n}\n\n// Action types for streak saver popup close\nexport type StreakSaverCloseAction = 'use_streak_saver' | 'decline' | 'holiday' | 'dismiss';\n\ninterface StreakSaverPopupProps {\n  open: boolean;\n  onClose: (action?: StreakSaverCloseAction) => void;\n  gameType: \"region\" | \"user\";\n  currentStreak: number;\n  onPlayYesterdaysPuzzle?: (gameType: \"region\" | \"user\", puzzleDate: string) => void;\n  onStreakLost?: () => void;\n  onStartHolidayWithAnimation?: (data: HolidayAnimationData) => void;\n  onShowCategorySelection?: () => void;\n}\n\nexport function StreakSaverPopup({ \n  open, \n  onClose, \n  gameType, \n  currentStreak, \n  onPlayYesterdaysPuzzle,\n  onStreakLost,\n  onStartHolidayWithAnimation,\n  onShowCategorySelection,\n}: StreakSaverPopupProps) {\n  const { toast } = useToast();\n  const { profile } = useProfile();\n  const queryClient = useQueryClient();\n  const [showProDialog, setShowProDialog] = useState(false);\n  const [showStreakSaverAfterPro, setShowStreakSaverAfterPro] = useState(false);\n  const {\n    isPro,\n    regionStreakSaversRemaining,\n    userStreakSaversRemaining,\n    regionCanUseStreakSaver,\n    userCanUseStreakSaver,\n    holidaysRemaining,\n    holidayDurationDays,\n    hasAnyValidStreakForHoliday,\n    declineStreakSaver,\n    isDeclining,\n    startHoliday,\n    isStartingHoliday,\n    refetch,\n  } = useStreakSaverStatus();\n  \n  const { startStreakSaverSession } = useStreakSaver();\n\n  const streakSaversRemaining = gameType === \"region\" ? regionStreakSaversRemaining : userStreakSaversRemaining;\n  const hasStreakSaversLeft = streakSaversRemaining > 0;\n  const canStartHoliday = isPro && holidaysRemaining > 0 && holidayDurationDays > 0;\n  \n  // Check if user can use streak saver (missed only yesterday, not multiple days)\n  const canUseStreakSaverForMode = gameType === \"region\" ? regionCanUseStreakSaver : userCanUseStreakSaver;\n  // Show streak saver button only if: missed just yesterday AND (has savers left OR can upgrade to Pro)\n  const showStreakSaverButton = canUseStreakSaverForMode;\n  \n  const regionDisplayNames: Record<string, string> = {\n    'UK': 'UK Edition',\n    'US': 'US Edition',\n    'EU': 'EU Edition',\n    'AU': 'AU Edition',\n    'CA': 'CA Edition',\n    'Global': 'Global',\n  };\n  \n  const gameModeLabel = gameType === \"region\" \n    ? (regionDisplayNames[profile?.region || 'UK'] || `${profile?.region} Edition`)\n    : \"Personal\";\n  \n  // When returning from successful Pro subscription, refetch status and ensure popup is shown\n  useEffect(() => {\n    if (showStreakSaverAfterPro) {\n      refetch();\n      setShowStreakSaverAfterPro(false);\n    }\n  }, [showStreakSaverAfterPro, refetch]);\n  \n  // Calculate yesterday's date\n  const getYesterdayDate = () => {\n    const yesterday = new Date();\n    yesterday.setDate(yesterday.getDate() - 1);\n    return yesterday.toISOString().split('T')[0];\n  };\n\n  const handleUseStreakSaver = () => {\n    if (!hasStreakSaversLeft) {\n      setShowProDialog(true);\n      return;\n    }\n    \n    const yesterdayDate = getYesterdayDate();\n    \n    // Start the streak saver session (don't increment usage yet - that happens on completion)\n    startStreakSaverSession(gameType, yesterdayDate, currentStreak);\n    \n    // Navigate to yesterday's puzzle if callback provided\n    if (onPlayYesterdaysPuzzle) {\n      onPlayYesterdaysPuzzle(gameType, yesterdayDate);\n    }\n    \n    onClose('use_streak_saver');\n  };\n\n  const handleDecline = async () => {\n    try {\n      await declineStreakSaver(gameType);\n      toast({\n        title: \"Streak Reset\",\n        description: \"Your streak has been reset to 0. Start fresh today!\",\n      });\n      onClose('decline');\n      if (onStreakLost) {\n        onStreakLost();\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error?.message || \"Failed to reset streak\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleStartHoliday = async () => {\n    try {\n      await startHoliday();\n      \n      // Clear archive local cache and invalidate game attempts queries\n      clearArchiveCache();\n      queryClient.invalidateQueries({ queryKey: ['/api/game-attempts/user'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/user/game-attempts/user'] });\n      \n      // Fetch animation data as best-effort - don't fail the activation if this fails\n      let showRegion = false;\n      let showUser = false;\n      \n      try {\n        const response = await apiRequest(\"GET\", \"/api/holiday/animation-data\");\n        if (response.ok) {\n          const animationData = await response.json();\n          \n          // Check conditions for each game mode with optional chaining\n          showRegion = !!(animationData?.region?.hasStreak && animationData?.region?.todayStreakDayStatusZero);\n          showUser = !!(animationData?.user?.hasStreak && animationData?.user?.todayStreakDayStatusZero);\n          \n          if ((showRegion || showUser) && onStartHolidayWithAnimation) {\n            // Close popup and trigger animation overlay\n            onClose('holiday');\n            onStartHolidayWithAnimation({\n              regionHolidayDates: showRegion ? (animationData?.region?.holidayDates || []) : [],\n              userHolidayDates: showUser ? (animationData?.user?.holidayDates || []) : [],\n              showUserAfterRegion: showRegion && showUser,\n              holidayDurationDays: holidayDurationDays ?? 14,\n            });\n            return; // Exit early, animation will show toast on completion\n          }\n        }\n      } catch (animationError) {\n        // Log but don't fail - animation is non-critical\n        console.warn(\"Failed to fetch animation data:\", animationError);\n      }\n      \n      // No animation needed or animation fetch failed - just show toast\n      toast({\n        title: \"Holiday Started!\",\n        description: `You're on holiday for ${holidayDurationDays} days. Your streak is protected.`,\n      });\n      onClose('holiday');\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error?.message || \"Failed to start holiday\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleNoStreakSavers = () => {\n    setShowProDialog(true);\n  };\n\n  const handleProDialogClose = () => {\n    // This is called when user clicks back arrow and confirms exit warning\n    // Do nothing here - the streak loss is handled by onStreakLost callback\n    setShowProDialog(false);\n  };\n\n  const handleProDialogSuccess = async () => {\n    // User successfully subscribed to Pro\n    // Refetch streak saver status to get updated allowances\n    await refetch();\n    setShowProDialog(false);\n    \n    toast({\n      title: \"Welcome to Pro!\",\n      description: \"You now have more streak savers available.\",\n    });\n    \n    // After successful Pro subscription, show CategorySelectionScreen\n    // Close the streak saver popup first, then open category selection\n    onClose('dismiss');\n    if (onShowCategorySelection) {\n      onShowCategorySelection();\n    }\n  };\n\n  const handleStreakLost = async () => {\n    // User chose to exit Pro dialog and lose their streak\n    try {\n      await declineStreakSaver(gameType);\n      toast({\n        title: \"Streak Reset\",\n        description: \"Your streak has been reset to 0. Start fresh today!\",\n      });\n      setShowProDialog(false);\n      onClose('decline');\n      if (onStreakLost) {\n        onStreakLost();\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error?.message || \"Failed to reset streak\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleStayOnProDialog = () => {\n    // User chose to stay on Pro dialog after exit warning\n    // Do nothing - they remain on the Pro dialog\n  };\n\n  // Keep the StreakSaverPopup dialog open but hidden when ProDialog is shown\n  // This ensures when Pro dialog closes successfully, we can show the popup again\n  const showMainPopup = open && !showProDialog;\n\n  // Prevent the dialog from closing via backdrop when going to Pro signup\n  const handleDialogOpenChange = (isOpen: boolean) => {\n    if (!isOpen) {\n      // Only allow closing through our explicit handlers\n      onClose('dismiss');\n    }\n  };\n\n  // Set background color based on game type (matching Archive button colors)\n  const popupBackgroundColor = gameType === \"region\" ? \"#FFD429\" : \"#fdab58\";\n\n  return (\n    <>\n      <Dialog\n        open={showMainPopup}\n        onOpenChange={handleDialogOpenChange}\n      >\n        <DialogContent\n          className=\"max-w-sm rounded-2xl\"\n          data-testid=\"streak-saver-popup\"\n          style={{ backgroundColor: popupBackgroundColor }}\n          //  prevent closing via Escape or backdrop click\n          onEscapeKeyDown={(e) => e.preventDefault()}\n          onPointerDownOutside={(e) => e.preventDefault()}\n        >\n          {/*  no close button will be rendered because we don't include <DialogClose /> */}\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2 text-xl text-gray-800\">\n              <Flame className=\"h-6 w-6 text-orange-500\" />\n              {showStreakSaverButton ? \"Save Your Streak?\" : \"Protect Your Streak?\"}\n            </DialogTitle>\n            <DialogDescription className=\"text-center text-gray-700\">\n              {showStreakSaverButton \n                ? `You missed yesterday's ${gameModeLabel} puzzle!`\n                : `You've been away for multiple days. Use holiday mode to protect your streak, or let it reset.`\n              }\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"flex flex-col items-center gap-4 py-4\">\n            <div className=\"w-36 h-36 bg-black rounded-full flex items-center justify-center\">\n              <img \n                src={Streak_Hamster_Black} \n                alt=\"Hamster\" \n                className=\"w-24 h-24\"\n              />\n            </div>\n            \n            <div className=\"text-center\">\n              <p className=\"text-2xl font-bold text-gray-800\">{currentStreak} Day Streak</p>\n              <p className=\"text-sm text-gray-700 mt-1\">\n                {showStreakSaverButton \n                  ? (hasStreakSaversLeft \n                    ? `You have ${streakSaversRemaining} streak saver${streakSaversRemaining > 1 ? 's' : ''} remaining this month`\n                    : \"You've used all your streak savers this month\")\n                  : (isPro \n                    ? `You have ${holidaysRemaining} holiday${holidaysRemaining !== 1 ? 's' : ''} remaining this year`\n                    : \"Upgrade to Pro to access holiday protection\")\n                }\n              </p>\n            </div>\n\n            <div className=\"w-full space-y-3\">\n              {/* Only show streak saver button if missed just yesterday (not multiple days) */}\n              {showStreakSaverButton && (\n                hasStreakSaversLeft ? (\n                  <Button\n                    onClick={handleUseStreakSaver}\n                    className=\"w-full text-[16px] bg-black hover:bg-gray-800\"\n                    data-testid=\"button-use-streak-saver\"\n                  >\n                    Use Streak Saver\n                  </Button>\n                ) : (\n                  <Button\n                    onClick={handleNoStreakSavers}\n                    className=\"w-full bg-gradient-to-r from-orange-400 to-amber-500\"\n                    data-testid=\"button-get-more-savers\"\n                  >\n                    Get More Streak Savers\n                  </Button>\n                )\n              )}\n\n              {/* Show holiday button for Pro users - disabled if no allowances or no valid streak */}\n              {isPro && (\n                <Button\n                  onClick={handleStartHoliday}\n                  disabled={isStartingHoliday || holidaysRemaining <= 0 || holidayDurationDays <= 0 || !hasAnyValidStreakForHoliday}\n                  variant=\"outline\"\n                  className={`w-full text-white text-[16px] border-blue-400 ${\n                    holidaysRemaining > 0 && holidayDurationDays > 0 && hasAnyValidStreakForHoliday\n                      ? 'bg-[#7DAAE8] hover:bg-blue-400' \n                      : 'bg-gray-400 cursor-not-allowed opacity-60'\n                  }`}\n                  data-testid=\"button-start-holiday\"\n                >\n                  {isStartingHoliday \n                    ? \"Starting...\" \n                    : !hasAnyValidStreakForHoliday\n                      ? \"No streak to protect\"\n                      : holidaysRemaining <= 0 \n                        ? \"No Holidays Remaining\" \n                        : `Go on Holiday (up to ${holidayDurationDays} days)`\n                  }\n                </Button>\n              )}\n\n              <Button\n                onClick={handleDecline}\n                disabled={isDeclining}\n                className=\"w-full text-muted-foreground bg-white text-[16px] hover:bg-gray-100\"\n                data-testid=\"button-decline-streak-saver\"\n              >\n                {isDeclining ? \"Resetting...\" : \"Let Streak Reset\"}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n      <ProSubscriptionDialog\n        isOpen={showProDialog}\n        onClose={handleProDialogClose}\n        onSuccess={handleProDialogSuccess}\n        fromStreakSaver={true}\n        currentStreak={currentStreak}\n        gameType={gameType}\n        onStreakLost={handleStreakLost}\n        onStayOnPage={handleStayOnProDialog}\n      />\n    </>\n  );\n}\n","path":null,"size_bytes":14515,"size_tokens":null},"client/src/components/ManageSubscriptionPage.tsx":{"content":"import { useState, useEffect, useMemo } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { ChevronLeft, Crown, Calendar, Flame, Umbrella, AlertTriangle, Globe, User, ExternalLink } from \"lucide-react\";\nimport { useSubscription } from \"@/hooks/useSubscription\";\nimport { useStreakSaverStatus } from \"@/hooks/useStreakSaverStatus\";\nimport { useProfile } from \"@/hooks/useProfile\";\nimport { useAdBannerActive } from \"@/components/AdBanner\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { getSupabaseClient } from \"@/lib/supabaseClient\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { cn } from \"@/lib/utils\";\nimport { clearArchiveCache } from \"@/lib/localCache\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\n\ninterface ManageSubscriptionPageProps {\n  onBack: () => void;\n  onGoProClick?: () => void;\n}\n\nfunction formatTierDisplayName(tierName: string, tierType: string): string {\n  if (tierName.toLowerCase() === 'standard') {\n    return 'Standard';\n  }\n  \n  switch (tierType) {\n    case 'monthly':\n      return 'Pro - Monthly';\n    case 'annual':\n      return 'Pro - Annual';\n    case 'lifetime':\n      return 'Pro - Lifetime';\n    default:\n      return tierName.charAt(0).toUpperCase() + tierName.slice(1);\n  }\n}\n\nfunction formatRenewalDate(dateString: string | null): string {\n  if (!dateString) return 'N/A';\n  const date = new Date(dateString);\n  return date.toLocaleDateString('en-GB', {\n    day: 'numeric',\n    month: 'long',\n    year: 'numeric',\n  });\n}\n\nexport function ManageSubscriptionPage({ onBack, onGoProClick }: ManageSubscriptionPageProps) {\n  const { subscription, isPro, tierName, tierType, streakSavers, holidaySavers, holidayDurationDays, isExpired } = useSubscription();\n  const { \n    status,\n    isLoading: statusLoading,\n    holidayActive,\n    holidayStartDate,\n    holidayEndDate,\n    holidayDaysTakenCurrentPeriod,\n    holidaysRemaining,\n    hasAnyValidStreakForHoliday,\n    startHoliday,\n    isStartingHoliday,\n    endHoliday,\n    isEndingHoliday,\n    holidayDurationDays: hookHolidayDurationDays,\n  } = useStreakSaverStatus();\n  const { profile } = useProfile();\n  const adBannerActive = useAdBannerActive();\n  \n  const regionLabel = profile?.region ? `${profile.region} Edition` : 'UK Edition';\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  const [autoRenew, setAutoRenew] = useState<boolean | null>(null);\n  const [showCancelWarning, setShowCancelWarning] = useState(false);\n  const [isUpdating, setIsUpdating] = useState(false);\n  const [showStartHolidayConfirm, setShowStartHolidayConfirm] = useState(false);\n  const [showEndHolidayConfirm, setShowEndHolidayConfirm] = useState(false);\n  const [isOpeningBillingPortal, setIsOpeningBillingPortal] = useState(false);\n\n  // Refresh subscription data when returning from Stripe portal\n  useEffect(() => {\n    // Check if we're returning from Stripe (page load or focus)\n    const handleVisibilityChange = () => {\n      if (document.visibilityState === 'visible') {\n        // Refresh subscription data when tab becomes visible\n        queryClient.invalidateQueries({ queryKey: [\"/api/subscription\"] });\n        queryClient.invalidateQueries({ queryKey: [\"/api/subscription/status\"] });\n      }\n    };\n\n    document.addEventListener('visibilitychange', handleVisibilityChange);\n    \n    // Also refresh on mount in case we're returning from Stripe\n    queryClient.invalidateQueries({ queryKey: [\"/api/subscription\"] });\n    \n    return () => {\n      document.removeEventListener('visibilitychange', handleVisibilityChange);\n    };\n  }, [queryClient]);\n\n  const handleManageBilling = async () => {\n    if (!subscription?.stripeCustomerId) {\n      toast({\n        title: \"Error\",\n        description: \"No billing account found. Please contact support.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsOpeningBillingPortal(true);\n\n    try {\n      const supabase = await getSupabaseClient();\n      const { data: { session } } = await supabase.auth.getSession();\n      \n      if (!session?.access_token) {\n        throw new Error(\"Not authenticated\");\n      }\n\n      // Build Edge Function URL\n      const supabaseUrl = import.meta.env.VITE_SUPABASE_URL || (supabase as any).supabaseUrl;\n      if (!supabaseUrl) {\n        throw new Error(\"Supabase URL not configured\");\n      }\n      const functionBaseUrl = supabaseUrl.replace('.supabase.co', '.functions.supabase.co');\n      \n      const response = await fetch(`${functionBaseUrl}/manage-billing`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Authorization\": `Bearer ${session.access_token}`,\n        },\n        body: JSON.stringify({\n          customerId: subscription.stripeCustomerId,\n          returnUrl: window.location.origin + \"/manage-subscription\",\n        }),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(\"Edge Function error:\", errorText);\n        throw new Error(\"Failed to open billing portal\");\n      }\n\n      const { url } = await response.json();\n      \n      // Redirect to Stripe Customer Portal\n      window.location.href = url;\n    } catch (error) {\n      console.error(\"Failed to open billing portal:\", error);\n      setIsOpeningBillingPortal(false);\n      toast({\n        title: \"Error\",\n        description: \"Failed to open billing portal. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n  \n  // Holiday activation overlay state\n  const [showHolidayOverlay, setShowHolidayOverlay] = useState(false);\n  const [holidayOverlayMode, setHolidayOverlayMode] = useState<'region' | 'user'>('region');\n  const [overlayPhase, setOverlayPhase] = useState<'fade-in' | 'glow' | 'fade-out'>('fade-in');\n  \n  // Holiday animation data - dates to highlight with yellow glow\n  const [regionHolidayDates, setRegionHolidayDates] = useState<string[]>([]);\n  const [userHolidayDates, setUserHolidayDates] = useState<string[]>([]);\n  const [showUserAfterRegion, setShowUserAfterRegion] = useState(false);\n\n// Sync local autoRenew state with subscription data when it loads/changes\nuseEffect(() => {\n  if (subscription?.autoRenew !== undefined) {\n    setAutoRenew(subscription.autoRenew);\n  }\n}, [subscription?.autoRenew]);\n\n// Display value - use subscription value if local state not yet set\nconst displayAutoRenew = autoRenew ?? subscription?.autoRenew ?? true;\n\nconst handleAutoRenewToggle = async (newValue: boolean) => {\n  if (!isPro) return;\n\n  const previousValue = autoRenew;\n  setIsUpdating(true);\n  setAutoRenew(newValue);\n\n  try {\n    // Call Supabase Edge Function to update Stripe\n    const supabase = await getSupabaseClient();\n    const { data: { session } } = await supabase.auth.getSession();\n    \n    if (!session?.access_token) {\n      throw new Error(\"Not authenticated\");\n    }\n    \n    // Build Edge Function URL\n    const supabaseUrl = import.meta.env.VITE_SUPABASE_URL || (supabase as any).supabaseUrl;\n    if (!supabaseUrl) {\n      throw new Error(\"Supabase URL not configured\");\n    }\n    const functionBaseUrl = supabaseUrl.replace('.supabase.co', '.functions.supabase.co');\n    \n    const response = await fetch(`${functionBaseUrl}/update-auto-renew`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"Authorization\": `Bearer ${session.access_token}`,\n      },\n      body: JSON.stringify({\n        stripeSubscriptionId: subscription.stripeSubscriptionId,\n        autoRenew: newValue,\n      }),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error(\"Edge Function error:\", errorText);\n      throw new Error(\"Failed to update auto-renew\");\n    }\n\n    // Wait for webhook to sync back into Supabase, then invalidate cache\n    // Add a small delay to allow webhook to process\n    await new Promise(resolve => setTimeout(resolve, 1000));\n    queryClient.invalidateQueries({ queryKey: [\"/api/subscription\"] });\n    queryClient.invalidateQueries({ queryKey: [\"/api/subscription/status\"] });\n\n    toast({\n      title: newValue ? \"Auto-renew enabled\" : \"Auto-renew disabled\",\n      description: newValue\n        ? \"Your subscription will renew automatically.\"\n        : \"Your subscription will not renew after the current period.\",\n    });\n  } catch (error) {\n    console.error(\"Failed to update auto-renew:\", error);\n    setAutoRenew(previousValue);\n    toast({\n      title: \"Error\",\n      description: \"Failed to update auto-renew setting. Please try again.\",\n      variant: \"destructive\",\n    });\n  } finally {\n    setIsUpdating(false);\n  }\n};\n\nconst confirmCancelAutoRenew = async () => {\n  setShowCancelWarning(false);\n  await handleAutoRenewToggle(false);\n};\n\n\n  const handleStartHoliday = async () => {\n    setShowStartHolidayConfirm(false);\n    try {\n      await startHoliday();\n      \n      // Clear archive local cache and invalidate game attempts queries\n      // This ensures Archive page shows fresh data with holiday rows and yellow borders\n      clearArchiveCache();\n      queryClient.invalidateQueries({ queryKey: ['/api/game-attempts/user'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/user/game-attempts/user'] });\n      \n      // Fetch animation data as best-effort - don't fail the activation if this fails\n      let showRegion = false;\n      let showUser = false;\n      \n      try {\n        const response = await apiRequest(\"GET\", \"/api/holiday/animation-data\");\n        if (response.ok) {\n          const animationData = await response.json();\n          \n          // Check conditions for each game mode with optional chaining\n          showRegion = !!(animationData?.region?.hasStreak && animationData?.region?.todayStreakDayStatusZero);\n          showUser = !!(animationData?.user?.hasStreak && animationData?.user?.todayStreakDayStatusZero);\n          \n          if (showRegion) {\n            // Set region holiday dates and start with region mode\n            setRegionHolidayDates(animationData?.region?.holidayDates || []);\n            setUserHolidayDates(animationData?.user?.holidayDates || []);\n            setShowUserAfterRegion(showUser);\n            setHolidayOverlayMode('region');\n            setOverlayPhase('fade-in');\n            setShowHolidayOverlay(true);\n            return; // Exit early, animation will show toast on completion\n          } else if (showUser) {\n            // Skip region, go straight to user mode\n            setUserHolidayDates(animationData?.user?.holidayDates || []);\n            setShowUserAfterRegion(false);\n            setHolidayOverlayMode('user');\n            setOverlayPhase('fade-in');\n            setShowHolidayOverlay(true);\n            return; // Exit early, animation will show toast on completion\n          }\n        }\n      } catch (animationError) {\n        // Log but don't fail - animation is non-critical\n        console.warn(\"Failed to fetch animation data:\", animationError);\n      }\n      \n      // No animation needed or animation fetch failed - just show toast\n      toast({\n        title: \"Holiday mode activated\",\n        description: `Your streak is now protected for the next ${effectiveHolidayDurationDays} days.`,\n      });\n    } catch (error) {\n      console.error(\"Failed to start holiday:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to activate holiday mode. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleEndHoliday = async () => {\n    setShowEndHolidayConfirm(false);\n    try {\n      await endHoliday(false);\n      \n      // Clear archive local cache and invalidate game attempts queries\n      clearArchiveCache();\n      queryClient.invalidateQueries({ queryKey: ['/api/game-attempts/user'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/user/game-attempts/user'] });\n      \n      toast({\n        title: \"Holiday mode ended\",\n        description: \"Your streak protection has been deactivated.\",\n      });\n    } catch (error) {\n      console.error(\"Failed to end holiday:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to end holiday mode. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const formatHolidayDate = (dateStr: string | null): string => {\n    if (!dateStr) return 'N/A';\n    const date = new Date(dateStr);\n    return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });\n  };\n\n  const regionUsed = status?.region?.streakSaversUsedMonth ?? 0;\n  const userUsed = status?.user?.streakSaversUsedMonth ?? 0;\n  const totalStreakSaversUsed = Math.max(regionUsed, userUsed);\n  const effectiveStreakSavers = streakSavers ?? (isPro ? 3 : 1);\n  const streakSaversRemaining = effectiveStreakSavers - totalStreakSaversUsed;\n\n  const holidaysUsedThisYear = status?.allowances?.holidaysUsedThisYear ?? 0;\n  const effectiveHolidaySavers = holidaySavers ?? (isPro ? 2 : 0);\n  const effectiveHolidayDurationDays = holidayDurationDays ?? (isPro ? 14 : 0);\n  const holidaysRemainingValue = effectiveHolidaySavers - holidaysUsedThisYear;\n\n  const isLifetime = tierType === 'lifetime';\n\n  // Holiday overlay animation effect\n  useEffect(() => {\n    if (!showHolidayOverlay) return;\n    \n    let timer: NodeJS.Timeout;\n    \n    if (overlayPhase === 'fade-in') {\n      // 1 second fade in, then start glow\n      timer = setTimeout(() => setOverlayPhase('glow'), 1000);\n    } else if (overlayPhase === 'glow') {\n      // 3 seconds of glow animation, then fade out\n      timer = setTimeout(() => setOverlayPhase('fade-out'), 3000);\n    } else if (overlayPhase === 'fade-out') {\n      // 1 second fade out, then switch mode or close\n      timer = setTimeout(() => {\n        if (holidayOverlayMode === 'region' && showUserAfterRegion) {\n          // Switch to user mode only if conditions were met for user mode\n          setHolidayOverlayMode('user');\n          setOverlayPhase('fade-in');\n        } else {\n          // Done, close overlay and show toast\n          setShowHolidayOverlay(false);\n          setShowUserAfterRegion(false);\n          toast({\n            title: \"Holiday mode activated\",\n            description: `Your streak is now protected for the next ${effectiveHolidayDurationDays} days.`,\n          });\n        }\n      }, 1000);\n    }\n    \n    return () => clearTimeout(timer);\n  }, [showHolidayOverlay, overlayPhase, holidayOverlayMode, showUserAfterRegion, effectiveHolidayDurationDays, toast]);\n\n  // Get today's date for the calendar\n  const today = new Date();\n  const currentMonth = today.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });\n  const currentDay = today.getDate();\n  const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();\n  const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).getDay();\n  // Adjust for Monday start (0 = Monday, 6 = Sunday)\n  const adjustedFirstDay = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;\n\n  return (\n    <div className={`min-h-screen flex flex-col p-4 bg-background ${adBannerActive ? 'pb-[50px]' : ''}`}>\n      <div className=\"w-full max-w-md mx-auto space-y-4\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <button\n            onClick={onBack}\n            data-testid=\"button-back-from-manage-subscription\"\n            className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n          >\n            <ChevronLeft className=\"h-9 w-9 text-gray-700\" />\n          </button>\n\n          <div className=\"flex flex-col items-center\">\n            <h1 className=\"text-2xl font-bold\">Manage Subscription</h1>\n          </div>\n\n          <div className=\"w-14\" />\n        </div>\n\n        {isPro ? (\n          <>\n            <Card className=\"p-4 space-y-4\">\n              <div className=\"flex items-center justify-between gap-3\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-full bg-gradient-to-br from-orange-400 to-orange-500\">\n                    <Crown className=\"h-5 w-5 text-white\" />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Subscription</p>\n                    <p className=\"font-semibold text-lg\" data-testid=\"text-subscription-tier\">\n                      {formatTierDisplayName(tierName, tierType)}\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              {!isLifetime && subscription?.endDate && (\n                <div className=\"flex items-center justify-between gap-3\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"p-2 rounded-full bg-muted\">\n                      <Calendar className=\"h-5 w-5 text-muted-foreground\" />\n                    </div>\n                    <div>\n                      <p className=\"text-sm text-muted-foreground\">\n                        {displayAutoRenew ? \"Renews on\" : \"Expires on\"}\n                      </p>\n                      <p className=\"font-semibold\" data-testid=\"text-renewal-date\">\n                        {formatRenewalDate(subscription.endDate)}\n                      </p>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"text-xs text-muted-foreground\">Auto-renew</span>\n                    <Switch\n                      checked={displayAutoRenew}\n                      onCheckedChange={handleAutoRenewToggle}\n                      disabled={isUpdating}\n                      className=\"data-[state=checked]:bg-blue-500\"\n                      data-testid=\"switch-auto-renew\"\n                    />\n                  </div>\n                </div>\n              )}\n\n              {!isLifetime && subscription?.stripeCustomerId && (\n                <Button\n                  onClick={handleManageBilling}\n                  disabled={isOpeningBillingPortal}\n                  className=\"w-full bg-blue-500 hover:bg-blue-600 text-white\"\n                  data-testid=\"button-manage-billing\"\n                >\n                  {isOpeningBillingPortal ? \"Opening...\" : \"Manage Billing & Subscription\"}\n                </Button>\n              )}\n\n              {isLifetime && (\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-full bg-muted\">\n                    <Calendar className=\"h-5 w-5 text-muted-foreground\" />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Subscription type</p>\n                    <p className=\"font-semibold\" data-testid=\"text-lifetime-status\">\n                      Lifetime - Never expires\n                    </p>\n                  </div>\n                </div>\n              )}\n            </Card>\n\n            <Card className=\"p-4 space-y-4\">\n              <h2 className=\"font-semibold text-lg\">Your Allowances</h2>\n              \n              <div className=\"space-y-2\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-full bg-amber-100 dark:bg-amber-900/30\">\n                    <Flame className=\"h-5 w-5 text-amber-500\" />\n                  </div>\n                  <div className=\"flex-1\">\n                    <p className=\"text-sm text-muted-foreground\">Monthly streak savers</p>\n                  </div>\n                </div>\n                <div className=\"pl-12 space-y-1\">\n                  <div className=\"flex items-center gap-2\">\n                    {/*<Globe className=\"h-4 w-4 text-muted-foreground\" />*/}\n                    <p className=\"font-semibold\" data-testid=\"text-streak-savers-remaining-region\">\n                      {regionLabel} - {statusLoading \n                        ? `${effectiveStreakSavers} of ${effectiveStreakSavers} remaining`\n                        : `${Math.max(0, effectiveStreakSavers - regionUsed)} of ${effectiveStreakSavers} remaining`\n                      }\n                    </p>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    {/*<User className=\"h-4 w-4 text-muted-foreground\" />*/}\n                    <p className=\"font-semibold\" data-testid=\"text-streak-savers-remaining-user\">\n                      Personal Game - {statusLoading \n                        ? `${effectiveStreakSavers} of ${effectiveStreakSavers} remaining`\n                        : `${Math.max(0, effectiveStreakSavers - userUsed)} of ${effectiveStreakSavers} remaining`\n                      }\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 rounded-full bg-blue-100 dark:bg-blue-900/30\">\n                  <Umbrella className=\"h-5 w-5 text-blue-500\" />\n                </div>\n                <div className=\"flex-1\">\n                  <p className=\"text-sm text-muted-foreground\">Annual {effectiveHolidayDurationDays} day holiday allowance</p>\n                  <p className=\"font-semibold\" data-testid=\"text-holidays-remaining\">\n                    {statusLoading \n                      ? `${effectiveHolidaySavers} of ${effectiveHolidaySavers} remaining`\n                      : `${Math.max(0, holidaysRemainingValue)} of ${effectiveHolidaySavers} remaining`\n                    }\n                  </p>\n                </div>\n              </div>\n            </Card>\n\n            <Card className=\"p-4 space-y-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 rounded-full bg-blue-100 dark:bg-blue-900/30\">\n                  <Umbrella className=\"h-5 w-5 text-blue-500\" />\n                </div>\n                <div className=\"flex-1\">\n                  <h2 className=\"font-semibold text-lg\">Holiday Mode</h2>\n                  <p className=\"text-sm text-muted-foreground\">\n                    {holidayActive \n                      ? \"Your streak is currently protected\"\n                      : \"Protect your streak for up to \" + effectiveHolidayDurationDays + \" days\"\n                    }\n                  </p>\n                </div>\n              </div>\n\n              {holidayActive ? (\n                <div className=\"space-y-3 pl-12\">\n                  <div className=\"flex items-center justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">Started</span>\n                    <span className=\"font-medium\" data-testid=\"text-holiday-start-date\">\n                      {formatHolidayDate(holidayStartDate)}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">Ends</span>\n                    <span className=\"font-medium\" data-testid=\"text-holiday-end-date\">\n                      {formatHolidayDate(holidayEndDate)}\n                    </span>\n                  </div>\n                  {/* \n                  <div className=\"flex items-center justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">Days taken</span>\n                    <span className=\"font-medium\" data-testid=\"text-holiday-days-taken\">\n                      {holidayDaysTakenCurrentPeriod} of {effectiveHolidayDurationDays}\n                    </span>\n                  </div>\n                  */}\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setShowEndHolidayConfirm(true)}\n                    disabled={isEndingHoliday}\n                    className=\"w-full mt-2\"\n                    data-testid=\"button-end-holiday\"\n                  >\n                    {isEndingHoliday ? \"Ending...\" : \"End Holiday Early\"}\n                  </Button>\n                </div>\n              ) : (\n                <div className=\"pl-12\">\n                  {holidaysRemaining > 0 ? (\n                    <Button\n                      onClick={() => setShowStartHolidayConfirm(true)}\n                      disabled={isStartingHoliday || !hasAnyValidStreakForHoliday}\n                      className=\"w-full\"\n                      data-testid=\"button-start-holiday\"\n                    >\n                      {isStartingHoliday \n                        ? \"Activating...\" \n                        : !hasAnyValidStreakForHoliday \n                          ? \"No streak to protect\" \n                          : \"Start Holiday Mode\"\n                      }\n                    </Button>\n                  ) : (\n                    <p className=\"text-sm text-muted-foreground\">\n                      You've used all your holiday allowances this year. Your allowance will reset one year after your initial subscription was activated.\n                    </p>\n                  )}\n                </div>\n              )}\n            </Card>\n          </>\n        ) : (\n          <>\n            <Card className=\"p-4 space-y-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 rounded-full bg-muted\">\n                  <Crown className=\"h-5 w-5 text-muted-foreground\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Subscription</p>\n                  <p className=\"font-semibold text-lg\" data-testid=\"text-subscription-tier\">\n                    Standard\n                  </p>\n                </div>\n              </div>\n            </Card>\n\n            <Card className=\"p-4 space-y-4\">\n              <h2 className=\"font-semibold text-lg\">Your Allowances</h2>\n              \n              <div className=\"space-y-2\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-full bg-amber-100 dark:bg-amber-900/30\">\n                    <Flame className=\"h-5 w-5 text-amber-500\" />\n                  </div>\n                  <div className=\"flex-1\">\n                    <p className=\"text-sm text-muted-foreground\">Monthly streak savers</p>\n                  </div>\n                </div>\n                <div className=\"pl-12 space-y-1\">\n                  <div className=\"flex items-center gap-2\">\n                    {/*<Globe className=\"h-4 w-4 text-muted-foreground\" />*/}\n                    <p className=\"font-semibold\" data-testid=\"text-streak-savers-remaining-region\">\n                      {regionLabel} - {Math.max(0, 1 - regionUsed)} of 1 remaining\n                    </p>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    {/*<User className=\"h-4 w-4 text-muted-foreground\" />*/}\n                    <p className=\"font-semibold\" data-testid=\"text-streak-savers-remaining-user\">\n                      Personal Game - {Math.max(0, 1 - userUsed)} of 1 remaining\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 rounded-full bg-blue-100 dark:bg-blue-900/30\">\n                  <Umbrella className=\"h-5 w-5 text-blue-500\" />\n                </div>\n                <div className=\"flex-1\">\n                  <p className=\"text-sm text-muted-foreground\">Annual 14 day holiday allowance</p>\n                  <p className=\"font-semibold text-muted-foreground\" data-testid=\"text-holidays-remaining\">\n                    0 of 0 remaining\n                  </p>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Pro members can pause their streak with holidays\n                  </p>\n                </div>\n              </div>\n            </Card>\n\n            <Button\n              onClick={onGoProClick}\n              className=\"w-full bg-gradient-to-r from-orange-400 to-orange-500 hover:from-orange-500 hover:to-orange-600 text-white\"\n              data-testid=\"button-go-pro-upgrade\"\n            >\n              <Crown className=\"h-4 w-4 mr-2\" />\n              Go Pro to increase your allowances\n            </Button>\n          </>\n        )}\n      </div>\n\n      <AlertDialog open={showCancelWarning} onOpenChange={setShowCancelWarning}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle className=\"flex items-center gap-2\">\n              <AlertTriangle className=\"h-5 w-5 text-amber-500\" />\n              Turn off auto-renew?\n            </AlertDialogTitle>\n            <AlertDialogDescription asChild>\n              <div className=\"text-left space-y-3 text-sm text-muted-foreground\">\n                <p>\n                  If you don't renew your subscription, you'll lose access to these Pro benefits:\n                </p>\n                <ul className=\"list-disc pl-5 space-y-1 text-foreground\">\n                  <li><strong>Ad-free experience</strong> - No more banner or interstitial ads</li>\n                  <li><strong>Custom categories</strong> - Choose your preferred puzzle categories</li>\n                  <li><strong>{effectiveStreakSavers} streak savers per month</strong> - Instead of just 1</li>\n                  <li><strong>{effectiveHolidaySavers} holiday breaks per year</strong> - Protect your streak for up to {effectiveHolidayDurationDays} days each</li>\n                  <li><strong>Personal mode puzzles</strong> - Puzzles tailored to your location</li>\n                </ul>\n                <p className=\"text-muted-foreground\">\n                  Your subscription will remain active until {formatRenewalDate(subscription?.endDate || null)}, but will not renew after that.\n                </p>\n              </div>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-warning-dismiss\">\n              Keep auto-renew on\n            </AlertDialogCancel>\n            <AlertDialogAction \n              onClick={confirmCancelAutoRenew}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-cancel-renewal\"\n            >\n              Turn off auto-renew\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      <AlertDialog open={showStartHolidayConfirm} onOpenChange={setShowStartHolidayConfirm}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle className=\"flex items-center gap-2\">\n              <Umbrella className=\"h-5 w-5 text-blue-500\" />\n              Start Holiday Mode?\n            </AlertDialogTitle>\n            <AlertDialogDescription asChild>\n              <div className=\"text-left space-y-3 text-sm text-muted-foreground\">\n                <p>\n                  This will protect your streak for up to {effectiveHolidayDurationDays} days. During this time:\n                </p>\n                <ul className=\"list-disc pl-5 space-y-1 text-foreground\">\n                  <li>Your streak will be preserved even if you don't play</li>\n                  <li>You can still play puzzles if you want</li>\n                  <li>Holiday days will be marked in your archive</li>\n                </ul>\n                <p>\n                  You have {holidaysRemaining} holiday allowance{holidaysRemaining !== 1 ? 's' : ''} remaining this year.\n                </p>\n              </div>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-start-holiday\">\n              Cancel\n            </AlertDialogCancel>\n            <AlertDialogAction \n              onClick={handleStartHoliday}\n              className=\"bg-blue-500 text-white hover:bg-blue-600\"\n              data-testid=\"button-confirm-start-holiday\"\n            >\n              Start Holiday\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      <AlertDialog open={showEndHolidayConfirm} onOpenChange={setShowEndHolidayConfirm}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle className=\"flex items-center gap-2\">\n              <Umbrella className=\"h-5 w-5 text-blue-500\" />\n              End Holiday Mode?\n            </AlertDialogTitle>\n            <AlertDialogDescription asChild>\n              <div className=\"text-left space-y-3 text-sm text-muted-foreground\">\n                <p>\n                  Are you sure you want to end your holiday early?\n                </p>\n                <p>\n                  You've used {holidayDaysTakenCurrentPeriod} of your {effectiveHolidayDurationDays} holiday days. \n                  Ending early won't give you these days back.\n                </p>\n              </div>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-end-holiday\">\n              Keep Holiday Active\n            </AlertDialogCancel>\n            <AlertDialogAction \n              onClick={handleEndHoliday}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-end-holiday\"\n            >\n              End Holiday\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Holiday Activation Overlay */}\n      <AnimatePresence>\n        {showHolidayOverlay && (\n          <motion.div\n            className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/80\"\n            initial={{ opacity: 0 }}\n            animate={{ opacity: overlayPhase === 'fade-out' ? 0 : 1 }}\n            exit={{ opacity: 0 }}\n            transition={{ duration: 1 }}\n          >\n            <motion.div\n              className=\"bg-card rounded-lg p-6 max-w-sm w-full mx-4 shadow-xl\"\n              initial={{ scale: 0.9, opacity: 0 }}\n              animate={{ scale: 1, opacity: overlayPhase === 'fade-out' ? 0 : 1 }}\n              transition={{ duration: 0.5 }}\n            >\n              {/* Header with mode icon */}\n              <div className=\"flex items-center justify-center gap-2 mb-4\">\n                <div className={cn(\n                  \"p-2 rounded-full\",\n                  holidayOverlayMode === 'region' \n                    ? \"bg-blue-100 dark:bg-blue-900/30\" \n                    : \"bg-purple-100 dark:bg-purple-900/30\"\n                )}>\n                  {holidayOverlayMode === 'region' ? (\n                    <Globe className=\"h-5 w-5 text-blue-500\" />\n                  ) : (\n                    <User className=\"h-5 w-5 text-purple-500\" />\n                  )}\n                </div>\n                <h3 className=\"text-lg font-semibold\">\n                  {holidayOverlayMode === 'region' ? 'Global Game' : 'Personal Game'}\n                </h3>\n              </div>\n\n              <p className=\"text-center text-sm text-muted-foreground mb-4\">\n                Holiday mode is now active\n              </p>\n\n              {/* Calendar Grid */}\n              <div className=\"bg-muted/50 rounded-lg p-4\">\n                <p className=\"text-center text-sm font-medium mb-3\">{currentMonth}</p>\n                \n                {/* Day headers */}\n                <div className=\"grid grid-cols-7 gap-1 mb-2\">\n                  {['M', 'T', 'W', 'T', 'F', 'S', 'S'].map((day, i) => (\n                    <div key={i} className=\"text-center text-xs text-muted-foreground font-medium\">\n                      {day}\n                    </div>\n                  ))}\n                </div>\n\n                {/* Calendar days */}\n                <div className=\"grid grid-cols-7 gap-1\">\n                  {/* Empty cells for days before the first of the month */}\n                  {Array.from({ length: adjustedFirstDay }).map((_, i) => (\n                    <div key={`empty-${i}`} className=\"aspect-square\" />\n                  ))}\n                  \n                  {/* Days of the month */}\n                  {Array.from({ length: daysInMonth }).map((_, i) => {\n                    const day = i + 1;\n                    const isToday = day === currentDay;\n                    \n                    // Check if this day should be highlighted based on holidayDates\n                    const currentHolidayDates = holidayOverlayMode === 'region' ? regionHolidayDates : userHolidayDates;\n                    const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;\n                    const isHolidayDate = currentHolidayDates.includes(dateStr);\n                    \n                    return (\n                      <div\n                        key={day}\n                        className={cn(\n                          \"aspect-square flex items-center justify-center text-xs rounded-md relative\",\n                          (isToday || isHolidayDate) && \"font-bold\"\n                        )}\n                      >\n                        {isHolidayDate && overlayPhase === 'glow' && (\n                          <motion.div\n                            className=\"absolute inset-0 rounded-md border-2 border-yellow-400\"\n                            initial={{ opacity: 0 }}\n                            animate={{\n                              opacity: 1,\n                              boxShadow: [\n                                \"0 0 5px 2px rgba(250, 204, 21, 0.4)\",\n                                \"0 0 15px 5px rgba(250, 204, 21, 0.7)\",\n                                \"0 0 5px 2px rgba(250, 204, 21, 0.4)\",\n                              ],\n                            }}\n                            transition={{\n                              duration: 1.5,\n                              repeat: Infinity,\n                              ease: \"easeInOut\",\n                            }}\n                          />\n                        )}\n                        <span className={cn(isHolidayDate && overlayPhase === 'glow' && \"relative z-10\")}>{day}</span>\n                      </div>\n                    );\n                  })}\n                </div>\n              </div>\n            </motion.div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n","path":null,"size_bytes":38766,"size_tokens":null},"client/src/lib/SpinnerProvider.tsx":{"content":"import { createContext, useContext, useState, useEffect, useCallback, useRef, useMemo, ReactNode } from 'react';\n\ninterface LottieAnimation {\n  destroy: () => void;\n  play: () => void;\n  stop: () => void;\n  pause: () => void;\n  setSpeed: (speed: number) => void;\n  goToAndStop: (value: number, isFrame: boolean) => void;\n  goToAndPlay: (value: number, isFrame: boolean) => void;\n  getDuration: (inFrames?: boolean) => number;\n  addEventListener: (event: string, cb: () => void) => void;\n  removeEventListener: (event: string, cb: () => void) => void;\n}\n\ndeclare global {\n  interface Window {\n    lottie: {\n      loadAnimation: (options: {\n        container: HTMLElement | null;\n        renderer: string;\n        loop: boolean | number;\n        autoplay: boolean;\n        path: string;\n      }) => LottieAnimation;\n    };\n  }\n}\n\ninterface SpinnerContextValue {\n  isLoading: boolean;\n  showSpinner: (delay?: number, backgroundColor?: string) => void;\n  hideSpinner: () => void;\n}\n\nconst SpinnerContext = createContext<SpinnerContextValue | undefined>(undefined);\n\nconst DEFAULT_DELAY_MS = 150;\nconst FADE_DURATION_MS = 300;\nconst MIN_DISPLAY_TIME_MS = 1500;\n\nexport function SpinnerProvider({ children }: { children: ReactNode }) {\n  const [isLoading, setIsLoading] = useState(false);\n  const [isVisible, setIsVisible] = useState(false);\n  const delayTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const minDisplayTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const fadeOutTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const animationRef = useRef<{ destroy: () => void } | null>(null);\n  const showTimeRef = useRef<number>(0);\n  const hideRequestedRef = useRef<boolean>(false);\n  const isVisibleRef = useRef<boolean>(false);\n\n  const performHide = useCallback(() => {\n    const spinnerElement = document.getElementById('spinner');\n    if (spinnerElement) {\n      spinnerElement.classList.remove('fade-in');\n      spinnerElement.classList.add('fade-out');\n    }\n    \n    fadeOutTimeoutRef.current = setTimeout(() => {\n      setIsLoading(false);\n      setIsVisible(false);\n      isVisibleRef.current = false;\n      hideRequestedRef.current = false;\n    }, FADE_DURATION_MS);\n  }, []);\n\n  const checkAndHide = useCallback(() => {\n    if (!hideRequestedRef.current || !isVisibleRef.current) return;\n    \n    const elapsedTime = Date.now() - showTimeRef.current;\n    if (elapsedTime >= MIN_DISPLAY_TIME_MS) {\n      performHide();\n    } else {\n      const remainingTime = MIN_DISPLAY_TIME_MS - elapsedTime;\n      minDisplayTimeoutRef.current = setTimeout(() => {\n        if (hideRequestedRef.current && isVisibleRef.current) {\n          performHide();\n        }\n      }, remainingTime);\n    }\n  }, [performHide]);\n\n  const showSpinner = useCallback((delay: number = DEFAULT_DELAY_MS, backgroundColor?: string) => {\n    hideRequestedRef.current = false;\n    setIsLoading(true);\n    \n    if (delayTimeoutRef.current) {\n      clearTimeout(delayTimeoutRef.current);\n    }\n    if (minDisplayTimeoutRef.current) {\n      clearTimeout(minDisplayTimeoutRef.current);\n    }\n    if (fadeOutTimeoutRef.current) {\n      clearTimeout(fadeOutTimeoutRef.current);\n    }\n    \n    // Set custom background color if provided\n    const spinnerElement = document.getElementById('spinner');\n    if (spinnerElement && backgroundColor) {\n      spinnerElement.style.setProperty('--spinner-bg', backgroundColor);\n    } else if (spinnerElement) {\n      spinnerElement.style.removeProperty('--spinner-bg');\n    }\n    \n    delayTimeoutRef.current = setTimeout(() => {\n      showTimeRef.current = Date.now();\n      setIsVisible(true);\n      isVisibleRef.current = true;\n    }, delay);\n  }, []);\n\n  const hideSpinner = useCallback(() => {\n    if (delayTimeoutRef.current) {\n      clearTimeout(delayTimeoutRef.current);\n      delayTimeoutRef.current = null;\n    }\n    \n    if (!isVisibleRef.current) {\n      setIsLoading(false);\n      return;\n    }\n    \n    hideRequestedRef.current = true;\n    checkAndHide();\n  }, [checkAndHide]);\n\n  useEffect(() => {\n    const spinnerElement = document.getElementById('spinner');\n    const hamsterElement = document.getElementById('hamster');\n    \n    if (!spinnerElement || !hamsterElement) return;\n\n    if (isVisible) {\n      spinnerElement.style.display = 'flex';\n      spinnerElement.setAttribute('aria-hidden', 'false');\n      spinnerElement.classList.remove('fade-out');\n      \n      requestAnimationFrame(() => {\n        spinnerElement.classList.add('fade-in');\n      });\n      \n      if (!animationRef.current && window.lottie) {\n        try {\n          animationRef.current = window.lottie.loadAnimation({\n            container: hamsterElement,\n            renderer: 'svg',\n            loop: true,\n            autoplay: true,\n            path: '/assets/hamster.json'\n          });\n        } catch (error) {\n          console.error('[SpinnerProvider] Failed to load Lottie animation:', error);\n        }\n      }\n    } else {\n      spinnerElement.style.display = 'none';\n      spinnerElement.setAttribute('aria-hidden', 'true');\n      spinnerElement.classList.remove('fade-in', 'fade-out');\n      \n      if (animationRef.current) {\n        animationRef.current.destroy();\n        animationRef.current = null;\n      }\n      \n      if (hamsterElement) {\n        hamsterElement.innerHTML = '';\n      }\n    }\n  }, [isVisible]);\n\n  useEffect(() => {\n    return () => {\n      if (delayTimeoutRef.current) {\n        clearTimeout(delayTimeoutRef.current);\n      }\n      if (minDisplayTimeoutRef.current) {\n        clearTimeout(minDisplayTimeoutRef.current);\n      }\n      if (fadeOutTimeoutRef.current) {\n        clearTimeout(fadeOutTimeoutRef.current);\n      }\n      if (animationRef.current) {\n        animationRef.current.destroy();\n      }\n    };\n  }, []);\n\n  return (\n    <SpinnerContext.Provider value={{ isLoading, showSpinner, hideSpinner }}>\n      {children}\n    </SpinnerContext.Provider>\n  );\n}\n\nexport function useSpinner() {\n  const context = useContext(SpinnerContext);\n  if (!context) {\n    throw new Error('useSpinner must be used within a SpinnerProvider');\n  }\n  return context;\n}\n\ninterface SpinnerTimeoutOptions {\n  retryDelayMs?: number;\n  timeoutMs?: number;\n  onRetry?: () => void;\n  onTimeout?: () => void;\n  onFadeOutComplete?: () => void;\n}\n\nconst DEFAULT_RETRY_DELAY_MS = 4000;\nconst DEFAULT_TIMEOUT_MS = 8000;\n\nexport function useSpinnerWithTimeout(options: SpinnerTimeoutOptions = {}) {\n  const { showSpinner, hideSpinner } = useSpinner();\n  const {\n    retryDelayMs = DEFAULT_RETRY_DELAY_MS,\n    timeoutMs = DEFAULT_TIMEOUT_MS,\n    onRetry,\n    onTimeout,\n    onFadeOutComplete,\n  } = options;\n  \n  const retryTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const failTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const fadeOutCompleteTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const spinnerVisibleTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const hasRetriedRef = useRef(false);\n  const isActiveRef = useRef(false);\n  const spinnerVisibleTimeRef = useRef<number>(0);\n  const wasSpinnerShownRef = useRef(false);\n  \n  const clearTimeouts = useCallback(() => {\n    if (retryTimeoutRef.current) {\n      clearTimeout(retryTimeoutRef.current);\n      retryTimeoutRef.current = null;\n    }\n    if (failTimeoutRef.current) {\n      clearTimeout(failTimeoutRef.current);\n      failTimeoutRef.current = null;\n    }\n    if (fadeOutCompleteTimeoutRef.current) {\n      clearTimeout(fadeOutCompleteTimeoutRef.current);\n      fadeOutCompleteTimeoutRef.current = null;\n    }\n    if (spinnerVisibleTimeoutRef.current) {\n      clearTimeout(spinnerVisibleTimeoutRef.current);\n      spinnerVisibleTimeoutRef.current = null;\n    }\n  }, []);\n  \n  const start = useCallback((delay?: number, backgroundColor?: string) => {\n    if (isActiveRef.current) return;\n    \n    isActiveRef.current = true;\n    hasRetriedRef.current = false;\n    wasSpinnerShownRef.current = false;\n    spinnerVisibleTimeRef.current = 0;\n    clearTimeouts();\n    \n    showSpinner(delay ?? 0, backgroundColor);\n    \n    const showDelay = delay ?? DEFAULT_DELAY_MS;\n    spinnerVisibleTimeoutRef.current = setTimeout(() => {\n      wasSpinnerShownRef.current = true;\n      spinnerVisibleTimeRef.current = Date.now();\n    }, showDelay);\n    \n    if (onRetry) {\n      retryTimeoutRef.current = setTimeout(() => {\n        if (isActiveRef.current && !hasRetriedRef.current) {\n          hasRetriedRef.current = true;\n          console.log('[SpinnerWithTimeout] Triggering retry after', retryDelayMs, 'ms');\n          onRetry();\n        }\n      }, retryDelayMs);\n    }\n    \n    if (onTimeout) {\n      failTimeoutRef.current = setTimeout(() => {\n        if (isActiveRef.current) {\n          console.log('[SpinnerWithTimeout] Triggering timeout after', timeoutMs, 'ms');\n          isActiveRef.current = false;\n          clearTimeouts();\n          hideSpinner();\n          onTimeout();\n        }\n      }, timeoutMs);\n    }\n  }, [showSpinner, hideSpinner, clearTimeouts, onRetry, onTimeout, retryDelayMs, timeoutMs]);\n  \n  const complete = useCallback(() => {\n    if (!isActiveRef.current) return;\n    \n    isActiveRef.current = false;\n    clearTimeouts();\n    hideSpinner();\n    console.log('[SpinnerWithTimeout] Completed successfully');\n    \n    if (onFadeOutComplete) {\n      if (!wasSpinnerShownRef.current) {\n        console.log('[SpinnerWithTimeout] Spinner never became visible - triggering callback immediately');\n        onFadeOutComplete();\n      } else {\n        const elapsedTime = Date.now() - spinnerVisibleTimeRef.current;\n        const remainingMinDisplayTime = Math.max(0, MIN_DISPLAY_TIME_MS - elapsedTime);\n        const totalWaitTime = remainingMinDisplayTime + FADE_DURATION_MS;\n        \n        fadeOutCompleteTimeoutRef.current = setTimeout(() => {\n          console.log('[SpinnerWithTimeout] Fade out complete - triggering callback');\n          onFadeOutComplete();\n        }, totalWaitTime);\n      }\n    }\n  }, [hideSpinner, clearTimeouts, onFadeOutComplete]);\n  \n  const cancel = useCallback(() => {\n    isActiveRef.current = false;\n    clearTimeouts();\n    hideSpinner();\n  }, [hideSpinner, clearTimeouts]);\n  \n  useEffect(() => {\n    return () => {\n      clearTimeouts();\n      if (isActiveRef.current) {\n        hideSpinner();\n      }\n    };\n  }, [clearTimeouts, hideSpinner]);\n  \n  return {\n    start,\n    complete,\n    cancel,\n    isActive: isActiveRef.current,\n  };\n}\n","path":null,"size_bytes":10404,"size_tokens":null},"client/src/components/RenewalPopup.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { ProSubscriptionDialog } from \"./ProSubscriptionDialog\";\nimport { useSubscription } from \"@/hooks/useSubscription\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Crown, X, RefreshCw } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport hamsterPro from \"@assets/Historian-Hamster-Blue.svg\";\n\ninterface RenewalPopupProps {\n  open: boolean;\n  onClose: () => void;\n}\n\nexport function RenewalPopup({ open, onClose }: RenewalPopupProps) {\n  const { toast } = useToast();\n  const { tierName, tierType, endDate, refetch } = useSubscription();\n  const [showProDialog, setShowProDialog] = useState(false);\n  const [isDowngrading, setIsDowngrading] = useState(false);\n\n  const displayTierName = tierType === 'monthly' ? 'Pro Monthly' \n    : tierType === 'annual' ? 'Pro Annual' \n    : tierType === 'lifetime' ? 'Pro Lifetime' \n    : tierName;\n\n  const formattedEndDate = endDate ? new Date(endDate).toLocaleDateString('en-GB', {\n    day: 'numeric',\n    month: 'short',\n    year: 'numeric',\n  }) : 'Unknown';\n\n  const handleRenew = () => {\n    setShowProDialog(true);\n  };\n\n  const handleDontRenew = async () => {\n    setIsDowngrading(true);\n    try {\n      const response = await apiRequest('POST', '/api/subscription/downgrade');\n      if (!response.ok) {\n        throw new Error('Failed to downgrade subscription');\n      }\n      \n      queryClient.invalidateQueries({ queryKey: ['/api/subscription'] });\n      \n      toast({\n        title: \"Subscription Updated\",\n        description: \"You've been moved to the Standard tier. You can upgrade again anytime.\",\n      });\n      onClose();\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error?.message || \"Failed to update subscription\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsDowngrading(false);\n    }\n  };\n\n  return (\n    <>\n      <Dialog open={open} onOpenChange={() => onClose()}>\n        <DialogContent className=\"max-w-sm\" data-testid=\"renewal-popup\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2 text-xl\">\n              <Crown className=\"h-6 w-6 text-amber-500\" />\n              Subscription Expired\n            </DialogTitle>\n            <DialogDescription className=\"text-center\">\n              Your {displayTierName} subscription ended on {formattedEndDate}\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"flex flex-col items-center gap-4 py-4\">\n            <img \n              src={hamsterPro} \n              alt=\"Hamster\" \n              className=\"w-24 h-24\"\n            />\n            \n            <div className=\"text-center\">\n              <p className=\"text-lg font-medium\">Want to continue enjoying Pro features?</p>\n              <p className=\"text-sm text-muted-foreground mt-2\">\n                Renew now to keep ad-free puzzles, custom categories, streak savers, and more.\n              </p>\n            </div>\n\n            <div className=\"w-full space-y-3\">\n              <Button\n                onClick={handleRenew}\n                className=\"w-full bg-gradient-to-r from-amber-400 to-orange-500 hover:from-amber-500 hover:to-orange-600\"\n                data-testid=\"button-renew-subscription\"\n              >\n                <RefreshCw className=\"h-4 w-4 mr-2\" />\n                Renew Subscription\n              </Button>\n\n              <Button\n                onClick={handleDontRenew}\n                disabled={isDowngrading}\n                variant=\"ghost\"\n                className=\"w-full text-muted-foreground\"\n                data-testid=\"button-dont-renew\"\n              >\n                <X className=\"h-4 w-4 mr-2\" />\n                {isDowngrading ? \"Processing...\" : \"Don't Go Pro\"}\n              </Button>\n            </div>\n\n            <p className=\"text-xs text-muted-foreground text-center\">\n              Choosing \"Don't Go Pro\" will move you to the free Standard tier.\n            </p>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      <ProSubscriptionDialog\n        isOpen={showProDialog}\n        onClose={() => {\n          setShowProDialog(false);\n        }}\n        onSuccess={() => {\n          setShowProDialog(false);\n          queryClient.invalidateQueries({ queryKey: ['/api/subscription'] });\n          onClose();\n        }}\n      />\n    </>\n  );\n}\n","path":null,"size_bytes":4549,"size_tokens":null},"client/src/hooks/useCategoryRestriction.ts":{"content":"import { useQuery, useQueryClient } from '@tanstack/react-query';\nimport { useAuth } from './useAuth';\nimport { getSupabaseClient } from '@/lib/supabaseClient';\n\ninterface CategoryRestrictionResponse {\n  status: 'allowed' | 'restricted' | 'error';\n  restrictionDays: number;\n  lastChangedAt: string | null;\n  message: string | null;\n  error?: string;\n}\n\nconst DEFAULT_RESPONSE: CategoryRestrictionResponse = {\n  status: 'restricted',\n  restrictionDays: 14,\n  lastChangedAt: null,\n  message: 'Checking restriction status...',\n};\n\nexport function useCategoryRestriction() {\n  const { isAuthenticated, user } = useAuth();\n\n  const { data, isLoading, isError, refetch } = useQuery<CategoryRestrictionResponse>({\n    queryKey: ['/api/category-restriction-status', user?.id],\n    queryFn: async () => {\n      if (!isAuthenticated || !user) {\n        return { ...DEFAULT_RESPONSE, status: 'allowed' as const, message: null };\n      }\n      \n      try {\n        const supabase = await getSupabaseClient();\n        const { data: { session } } = await supabase.auth.getSession();\n        \n        if (!session?.access_token) {\n          return DEFAULT_RESPONSE;\n        }\n\n        const response = await fetch('/api/category-restriction-status', {\n          credentials: 'include',\n          headers: {\n            'Authorization': `Bearer ${session.access_token}`,\n          },\n        });\n\n        if (!response.ok) {\n          console.error('[useCategoryRestriction] API error:', response.status);\n          return DEFAULT_RESPONSE;\n        }\n\n        const result = await response.json();\n        console.log('[useCategoryRestriction] Got status:', result.status);\n        return result;\n      } catch (error) {\n        console.error('[useCategoryRestriction] Error:', error);\n        return DEFAULT_RESPONSE;\n      }\n    },\n    enabled: isAuthenticated && !!user,\n    staleTime: 5 * 60 * 1000,\n    gcTime: 10 * 60 * 1000,\n    retry: 2,\n    retryDelay: 1000,\n  });\n\n  const effectiveData = data || DEFAULT_RESPONSE;\n  const isAllowed = !isLoading && !isError && effectiveData.status === 'allowed';\n  const isRestricted = !isLoading && !isError && effectiveData.status === 'restricted';\n\n  return {\n    isLoading: isLoading || (!data && isAuthenticated && !!user),\n    isAllowed,\n    isRestricted,\n    restrictionDays: effectiveData.restrictionDays,\n    lastChangedAt: effectiveData.lastChangedAt,\n    message: effectiveData.message,\n    refetch: () => refetch(),\n  };\n}\n\nexport function useCategoryRestrictionActions() {\n  const queryClient = useQueryClient();\n  \n  const markAsRestricted = (restrictionDays: number) => {\n    queryClient.setQueryData(['/api/category-restriction-status'], {\n      status: 'restricted',\n      restrictionDays,\n      lastChangedAt: new Date().toISOString(),\n      message: `You can update your categories once every ${restrictionDays} days and Hammie will regenerate your questions.`\n    });\n  };\n  \n  const invalidateRestriction = () => {\n    queryClient.invalidateQueries({ queryKey: ['/api/category-restriction-status'] });\n  };\n  \n  return { markAsRestricted, invalidateRestriction };\n}\n","path":null,"size_bytes":3116,"size_tokens":null},"client/src/contexts/StreakSaverContext.tsx":{"content":"import { createContext, useContext, useState, useCallback, type ReactNode } from 'react';\n\ninterface StreakSaverSession {\n  gameType: 'region' | 'user';\n  puzzleDate: string; // Yesterday's date in YYYY-MM-DD format\n  originalStreak: number;\n}\n\ninterface StreakSaverContextValue {\n  isInStreakSaverMode: boolean;\n  session: StreakSaverSession | null;\n  startStreakSaverSession: (gameType: 'region' | 'user', puzzleDate: string, originalStreak: number) => void;\n  completeStreakSaverSession: (won: boolean) => void;\n  cancelStreakSaverSession: () => void;\n  onSessionComplete?: (result: { won: boolean; gameType: 'region' | 'user' }) => void;\n  onSessionCancelled?: (gameType: 'region' | 'user') => void;\n  setOnSessionComplete: (callback: ((result: { won: boolean; gameType: 'region' | 'user' }) => void) | undefined) => void;\n  setOnSessionCancelled: (callback: ((gameType: 'region' | 'user') => void) | undefined) => void;\n  isJustCompleted: (gameType: 'region' | 'user') => boolean;\n  acknowledgeCompletion: (gameType: 'region' | 'user') => void;\n}\n\nconst StreakSaverContext = createContext<StreakSaverContextValue | null>(null);\n\nexport function StreakSaverProvider({ children }: { children: ReactNode }) {\n  const [session, setSession] = useState<StreakSaverSession | null>(null);\n  const [onSessionComplete, setOnSessionComplete] = useState<((result: { won: boolean; gameType: 'region' | 'user' }) => void) | undefined>();\n  const [onSessionCancelled, setOnSessionCancelled] = useState<((gameType: 'region' | 'user') => void) | undefined>();\n  \n  // Track which game types have just been completed (to prevent popup re-appearing during cache update)\n  const [justCompletedRegion, setJustCompletedRegion] = useState(false);\n  const [justCompletedUser, setJustCompletedUser] = useState(false);\n\n  const startStreakSaverSession = useCallback((\n    gameType: 'region' | 'user',\n    puzzleDate: string,\n    originalStreak: number\n  ) => {\n    console.log('[StreakSaverContext] Starting session:', { gameType, puzzleDate, originalStreak });\n    setSession({ gameType, puzzleDate, originalStreak });\n  }, []);\n\n  const completeStreakSaverSession = useCallback((won: boolean) => {\n    if (!session) return;\n    console.log('[StreakSaverContext] Completing session:', { won, session });\n    const { gameType } = session;\n    \n    // Mark this game type as \"just completed\" to suppress popup until API confirms flag is cleared\n    if (gameType === 'region') {\n      setJustCompletedRegion(true);\n    } else {\n      setJustCompletedUser(true);\n    }\n    \n    setSession(null);\n    onSessionComplete?.({ won, gameType });\n  }, [session, onSessionComplete]);\n\n  const cancelStreakSaverSession = useCallback(() => {\n    if (!session) return;\n    console.log('[StreakSaverContext] Cancelling session:', session);\n    const gameType = session.gameType;\n    setSession(null);\n    onSessionCancelled?.(gameType);\n  }, [session, onSessionCancelled]);\n\n  // Check if a streak saver was just completed for this game type\n  // Used to prevent popup from re-appearing due to stale API cache\n  const isJustCompleted = useCallback((gameType: 'region' | 'user'): boolean => {\n    return gameType === 'region' ? justCompletedRegion : justCompletedUser;\n  }, [justCompletedRegion, justCompletedUser]);\n\n  // Called when the API confirms the missed flag is cleared (hasMissed becomes false)\n  // This clears the \"just completed\" state so future misses can trigger the popup\n  const acknowledgeCompletion = useCallback((gameType: 'region' | 'user') => {\n    console.log('[StreakSaverContext] Acknowledging completion for:', gameType);\n    if (gameType === 'region') {\n      setJustCompletedRegion(false);\n    } else {\n      setJustCompletedUser(false);\n    }\n  }, []);\n\n  return (\n    <StreakSaverContext.Provider\n      value={{\n        isInStreakSaverMode: session !== null,\n        session,\n        startStreakSaverSession,\n        completeStreakSaverSession,\n        cancelStreakSaverSession,\n        onSessionComplete,\n        onSessionCancelled,\n        setOnSessionComplete,\n        setOnSessionCancelled,\n        isJustCompleted,\n        acknowledgeCompletion,\n      }}\n    >\n      {children}\n    </StreakSaverContext.Provider>\n  );\n}\n\nexport function useStreakSaver() {\n  const context = useContext(StreakSaverContext);\n  if (!context) {\n    throw new Error('useStreakSaver must be used within a StreakSaverProvider');\n  }\n  return context;\n}\n","path":null,"size_bytes":4427,"size_tokens":null},"client/src/components/StreakSaverExitWarning.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { AlertTriangle } from \"lucide-react\";\n\ninterface StreakSaverExitWarningProps {\n  open: boolean;\n  onClose: () => void;\n  onCancelAndLoseStreak: () => void;\n  onContinuePlaying: () => void;\n}\n\nexport function StreakSaverExitWarning({\n  open,\n  onClose,\n  onCancelAndLoseStreak,\n  onContinuePlaying,\n}: StreakSaverExitWarningProps) {\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-sm\" data-testid=\"streak-saver-exit-warning\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2 text-xl\">\n            <AlertTriangle className=\"h-6 w-6 text-orange-500\" />\n            Are you sure?\n          </DialogTitle>\n          <DialogDescription className=\"text-center pt-2\">\n            If you don't complete and win yesterday's game you will lose your streak.\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"flex flex-col gap-3 pt-4\">\n          <Button\n            onClick={onContinuePlaying}\n            className=\"w-full bg-orange-500 hover:bg-orange-600\"\n            data-testid=\"button-continue-playing\"\n          >\n            Continue Playing\n          </Button>\n          \n          <Button\n            onClick={onCancelAndLoseStreak}\n            variant=\"ghost\"\n            className=\"w-full text-muted-foreground\"\n            data-testid=\"button-cancel-streak-saver\"\n          >\n            Cancel Streak Saver and Lose Streak\n          </Button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":1681,"size_tokens":null},"client/src/components/badges/BadgesRow.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { BadgeSlot } from \"./BadgeSlot\";\nimport { AllBadgesPopup } from \"./AllBadgesPopup\";\nimport { Card } from \"@/components/ui/card\";\nimport { Trophy, Loader2, ChevronRight } from \"lucide-react\";\nimport type { UserBadgeWithDetails } from \"@shared/schema\";\n\ninterface BadgesRowProps {\n  gameType: 'USER' | 'REGION';\n  newlyAwardedBadge?: UserBadgeWithDetails | null;\n  onAnimationComplete?: () => void;\n}\n\ntype HighestBadges = Record<'elementle' | 'streak' | 'percentile', UserBadgeWithDetails | null>;\n\n// Normalize category names to match our slot categories\nfunction normalizeCategory(category: string): 'elementle' | 'streak' | 'percentile' {\n  const lower = category.toLowerCase();\n  if (lower === 'elementle in' || lower === 'elementle') return 'elementle';\n  if (lower === 'streak') return 'streak';\n  if (lower === 'percentile') return 'percentile';\n  return 'elementle'; // Default fallback\n}\n\nexport function BadgesRow({ gameType, newlyAwardedBadge, onAnimationComplete }: BadgesRowProps) {\n  const { isAuthenticated } = useAuth();\n  const [showAllBadges, setShowAllBadges] = useState(false);\n  const [initialCategory, setInitialCategory] = useState<'elementle' | 'streak' | 'percentile'>('elementle');\n  const [badgesReady, setBadgesReady] = useState(false);\n  \n  const endpoint = gameType === 'USER' \n    ? '/api/user/badges/earned' \n    : '/api/badges/earned';\n  \n  const { data: badges, isLoading, isFetching } = useQuery<HighestBadges>({\n    queryKey: [endpoint],\n    enabled: isAuthenticated,\n    refetchOnMount: newlyAwardedBadge ? 'always' : true,\n  });\n\n  useEffect(() => {\n    if (!isLoading && badges !== undefined) {\n      const timer = setTimeout(() => {\n        setBadgesReady(true);\n      }, 100);\n      return () => clearTimeout(timer);\n    }\n  }, [isLoading, badges]);\n\n  if (!isAuthenticated) {\n    return null;\n  }\n\n  // Determine which category should animate\n  // Only animate if:\n  // 1. There's a newly awarded badge\n  // 2. The badge data matches (confirming fresh data is loaded)\n  // 3. Not currently refetching\n  const animatingCategory = newlyAwardedBadge && !isFetching\n    ? (() => {\n        const category = normalizeCategory(newlyAwardedBadge.badge.category);\n        const matchingBadge = badges?.[category];\n        // Only animate if the badge in data matches the newly awarded one\n        if (matchingBadge && matchingBadge.badgeId === newlyAwardedBadge.badgeId) {\n          return category;\n        }\n        return null;\n      })()\n    : null;\n\n  return (\n    <>\n      <Card className=\"p-4\" data-testid=\"badges-row-card\">\n        <div className=\"font-bold text-sm mb-2 flex items-center justify-between gap-2\">\n          <div className=\"flex items-center gap-2\">\n            <Trophy className=\"h-5 w-5\" />\n            Badges\n          </div>\n          <button\n            onClick={() => {\n              setInitialCategory('elementle');\n              setShowAllBadges(true);\n            }}\n            className=\"text-sm text-primary hover:underline font-normal flex items-center gap-0.5\"\n            data-testid=\"button-see-all-badges\"\n          >\n            View all\n            <ChevronRight className=\"h-4 w-4\" />\n          </button>\n        </div>\n        {/* Fixed height container to prevent layout shift */}\n        <div className=\"relative h-[160px] flex items-center justify-center\">\n          {/* Spinner - fades out when badges are ready */}\n          <div \n            className=\"absolute inset-0 flex items-center justify-center transition-opacity duration-300\"\n            style={{ opacity: badgesReady ? 0 : 1, pointerEvents: badgesReady ? 'none' : 'auto' }}\n          >\n            <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n          </div>\n          \n          {/* Badges - fade in when ready */}\n          <div \n            className=\"flex justify-center gap-3 transition-opacity duration-300\"\n            style={{ opacity: badgesReady ? 1 : 0 }}\n          >\n            <div \n              className=\"cursor-pointer\"\n              onClick={() => {\n                setInitialCategory('elementle');\n                setShowAllBadges(true);\n              }}\n            >\n              <BadgeSlot \n                category=\"elementle\" \n                badge={badges?.elementle || null}\n                isAnimating={animatingCategory === 'elementle'}\n                onAnimationComplete={animatingCategory === 'elementle' ? onAnimationComplete : undefined}\n              />\n            </div>\n            <div \n              className=\"cursor-pointer\"\n              onClick={() => {\n                setInitialCategory('streak');\n                setShowAllBadges(true);\n              }}\n            >\n              <BadgeSlot \n                category=\"streak\" \n                badge={badges?.streak || null}\n                isAnimating={animatingCategory === 'streak'}\n                onAnimationComplete={animatingCategory === 'streak' ? onAnimationComplete : undefined}\n              />\n            </div>\n            <div \n              className=\"cursor-pointer\"\n              onClick={() => {\n                setInitialCategory('percentile');\n                setShowAllBadges(true);\n              }}\n            >\n              <BadgeSlot \n                category=\"percentile\" \n                badge={badges?.percentile || null}\n                isAnimating={animatingCategory === 'percentile'}\n                onAnimationComplete={animatingCategory === 'percentile' ? onAnimationComplete : undefined}\n              />\n            </div>\n          </div>\n        </div>\n      </Card>\n\n      {showAllBadges && (\n        <AllBadgesPopup\n          gameType={gameType}\n          earnedBadges={badges}\n          initialCategory={initialCategory}\n          onClose={() => setShowAllBadges(false)}\n        />\n      )}\n    </>\n  );\n}\n","path":null,"size_bytes":5959,"size_tokens":null},"client/src/components/badges/index.ts":{"content":"export { BadgeSlot } from './BadgeSlot';\nexport { BadgesRow } from './BadgesRow';\nexport { BadgeCelebrationPopup } from './BadgeCelebrationPopup';\nexport { AllBadgesPopup } from './AllBadgesPopup';\n","path":null,"size_bytes":198,"size_tokens":null},"client/src/components/badges/BadgeSlot.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { cn } from \"@/lib/utils\";\nimport { Target, Flame, Percent } from \"lucide-react\";\nimport { motion } from \"framer-motion\";\nimport type { UserBadgeWithDetails } from \"@shared/schema\";\nimport badgeImage from \"@assets/Signup-Hamster-Cutout.png\";\n\ninterface BadgeSlotProps {\n  category: 'elementle' | 'streak' | 'percentile';\n  badge: UserBadgeWithDetails | null;\n  size?: 'sm' | 'md' | 'lg' | 'xl';\n  isAnimating?: boolean;\n  onAnimationComplete?: () => void;\n}\n\nexport function BadgeSlot({ category, badge, size = 'xl', isAnimating = false, onAnimationComplete }: BadgeSlotProps) {\n  const isEmpty = !badge;\n  \n  // Sizes increased by 20% for badges area\n  const sizeClasses = {\n    sm: 'w-14 h-[68px]',      // was w-12 h-14 (48x56 -> 58x68)\n    md: 'w-[77px] h-24',      // was w-16 h-20 (64x80 -> 77x96)\n    lg: 'w-24 h-[115px]',     // was w-20 h-24 (80x96 -> 96x115)\n    xl: 'w-[100px] h-[118px]', // was w-24 h-32 (96x128 -> 115x154)\n  };\n  \n  // Image sizes increased by 20%\n  const imageSizeClasses = {\n    sm: 'w-10 h-10',          // was w-8 h-8\n    md: 'w-14 h-14',          // was w-12 h-12\n    lg: 'w-[77px] h-[77px]',  // was w-16 h-16\n    xl: 'w-[77px] h-[77px]',  // was w-16 h-16\n  };\n\n  // Placeholder sizes increased by 20%\n  const emptyCircleSizeClasses = {\n    sm: 'w-14 h-12',          // was w-12 h-10\n    md: 'w-[77px] h-[67px]',  // was w-16 h-14\n    lg: 'w-[115px] h-24',     // was w-24 h-20\n    xl: 'w-[115px] h-24',     // was w-24 h-20\n  };\n  \n  const iconSizeClasses = {\n    sm: 'w-3 h-3',\n    md: 'w-4 h-4',\n    lg: 'w-5 h-5',\n    xl: 'w-5 h-5',\n  };\n  \n  const categoryLabelClasses = {\n    sm: 'text-[10px]',\n    md: 'text-xs',\n    lg: 'text-sm',\n    xl: 'text-sm',\n  };\n  \n  const valueTextClasses = {\n    sm: 'text-sm font-bold',\n    md: 'text-base font-bold',\n    lg: 'text-lg font-bold',\n    xl: 'text-base font-bold',\n  };\n  \n  const badgeNameClasses = {\n    sm: 'text-[8px]',\n    md: 'text-[10px]',\n    lg: 'text-xs',\n    xl: 'text-[10px]',\n  };\n\n  const getCategoryIcon = () => {\n    switch (category) {\n      case 'elementle':\n        return <Target className={iconSizeClasses[size]} />;\n      case 'streak':\n        return <Flame className={iconSizeClasses[size]} />;\n      case 'percentile':\n        return <Percent className={iconSizeClasses[size]} />;\n    }\n  };\n\n  const getCategoryLabel = () => {\n    switch (category) {\n      case 'elementle':\n        return 'Won In';\n      case 'streak':\n        return 'Streak';\n      case 'percentile':\n        return 'Top %';\n    }\n  };\n\n  const getBadgeValue = () => {\n    if (!badge) return null;\n    const threshold = badge.badge.threshold;\n    \n    switch (category) {\n      case 'elementle':\n        return threshold === 1 ? '1' : '2';\n      case 'streak':\n        return threshold.toString();\n      case 'percentile':\n        return `${threshold}%`;\n    }\n  };\n\n  const getBadgeTextColor = () => {\n    if (!badge) return 'text-gray-400';\n    \n    const threshold = badge.badge.threshold;\n    \n    switch (category) {\n      case 'elementle':\n        return threshold === 1 ? 'text-amber-500' : 'text-emerald-500';\n      case 'streak':\n        if (threshold >= 365) return 'text-purple-500';\n        if (threshold >= 100) return 'text-amber-500';\n        if (threshold >= 30) return 'text-cyan-500';\n        return 'text-emerald-500';\n      case 'percentile':\n        if (threshold <= 1) return 'text-purple-500';\n        if (threshold <= 5) return 'text-amber-500';\n        if (threshold <= 10) return 'text-cyan-500';\n        return 'text-emerald-500';\n    }\n  };\n\n  // Animation state for newly awarded badges\n  const [hasAnimated, setHasAnimated] = useState(false);\n  \n  // Reset animation state when badge changes (e.g., new threshold in same category)\n  useEffect(() => {\n    if (isAnimating) {\n      setHasAnimated(false);\n    }\n  }, [badge?.badge?.id, isAnimating]);\n  \n  // Handle animation completion via framer-motion callback\n  const handleAnimationComplete = () => {\n    setHasAnimated(true);\n    if (onAnimationComplete) {\n      onAnimationComplete();\n    }\n  };\n\n  // Badge content to render (with or without animation)\n  const badgeContent = (\n    <div className=\"relative flex flex-col items-center justify-center w-full h-full\">\n      {isEmpty ? (\n        <div className={cn(\n          \"flex flex-col items-center justify-center w-full h-full\"\n        )}>\n          <img \n            src={badgeImage} \n            alt=\"Unearned badge\"\n            className={cn(imageSizeClasses[size], \"object-contain opacity-30\")}\n          />\n        </div>\n      ) : (\n        <>\n          <img \n            src={badgeImage} \n            alt={badge.badge.name}\n            className={cn(imageSizeClasses[size], \"object-contain\")}\n          />\n          <div className={cn(\n            \"flex items-center gap-1 mt-1\",\n            getBadgeTextColor()\n          )}>\n            {getCategoryIcon()}\n            <span className={cn(valueTextClasses[size], \"leading-none\")}>\n              {getBadgeValue()}\n            </span>\n          </div>\n        </>\n      )}\n    </div>\n  );\n\n  return (\n    <div className=\"flex flex-col items-center gap-0.5\">\n      {/* Category title - top */}\n      <span className={cn(\n        categoryLabelClasses[size],\n        \"text-center text-muted-foreground font-bold whitespace-nowrap mb-0.5\"\n      )}>\n        {getCategoryLabel()}\n      </span>\n      \n      {/* Badge hexagon - middle (with animation if newly awarded) */}\n      {isAnimating && !hasAnimated ? (\n        <motion.div \n          className={cn(\n            \"relative flex items-center justify-center\",\n            sizeClasses[size]\n          )}\n          data-testid={`badge-slot-${category}`}\n          initial={{ opacity: 0, scale: 0.1 }}\n          animate={{ opacity: 1, scale: 1 }}\n          transition={{ \n            duration: 0.6, \n            ease: [0.34, 1.56, 0.64, 1], // Bouncy ease\n            delay: 0.1\n          }}\n          onAnimationComplete={handleAnimationComplete}\n        >\n          {badgeContent}\n        </motion.div>\n      ) : (\n        <div \n          className={cn(\n            \"relative flex items-center justify-center\",\n            \"transition-all duration-300\",\n            sizeClasses[size]\n          )}\n          data-testid={`badge-slot-${category}`}\n        >\n          {badgeContent}\n        </div>\n      )}\n      \n      {/* Badge name - bottom (only show when earned) */}\n      {!isEmpty && (\n        <motion.span \n          className={cn(\n            badgeNameClasses[size],\n            \"text-center text-muted-foreground leading-tight line-clamp-2 max-w-[14rem] mt-0.5\"\n          )}\n          initial={isAnimating && !hasAnimated ? { opacity: 0, y: 10 } : false}\n          animate={isAnimating && !hasAnimated ? { opacity: 1, y: 0 } : undefined}\n          transition={{ duration: 0.3, delay: 0.5 }}\n        >\n          {badge.badge.name}\n        </motion.span>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":6964,"size_tokens":null},"client/src/components/badges/BadgeCelebrationPopup.tsx":{"content":"import { useEffect, useRef } from \"react\";\nimport { soundManager } from \"@/lib/sounds\";\nimport { motion } from \"framer-motion\";\nimport { pageVariants, pageTransition } from \"@/lib/pageAnimations\";\nimport { Target, Flame, Percent } from \"lucide-react\";\nimport type { UserBadgeWithDetails } from \"@shared/schema\";\nimport badgePlaceholder from \"@assets/Signup-Hamster-Cutout.png\";\n\nimport Streak_Hamster_Black from \"@assets/Streak-Hamster-Black.svg\";\n\ninterface LottieAnimation {\n  destroy: () => void;\n  play: () => void;\n  stop: () => void;\n  pause: () => void;\n  setSpeed: (speed: number) => void;\n  goToAndStop: (value: number, isFrame: boolean) => void;\n  goToAndPlay: (value: number, isFrame: boolean) => void;\n  getDuration: (inFrames?: boolean) => number;\n  addEventListener: (event: string, cb: () => void) => void;\n  removeEventListener: (event: string, cb: () => void) => void;\n}\n\ndeclare global {\n  interface Window {\n    lottie: {\n      loadAnimation: (options: {\n        container: HTMLElement | null;\n        renderer: string;\n        loop: boolean | number;\n        autoplay: boolean;\n        path: string;\n      }) => LottieAnimation;\n    };\n  }\n}\n\n\ninterface BadgeCelebrationPopupProps {\n  badge: UserBadgeWithDetails;\n  onDismiss: () => void;\n}\n\nexport function BadgeCelebrationPopup({ badge, onDismiss }: BadgeCelebrationPopupProps) {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const animationRef = useRef<{ destroy: () => void } | null>(null);\n\n  useEffect(() => {\n    soundManager.playStreak();\n\n    if (containerRef.current && window.lottie) {\n      const animation = window.lottie.loadAnimation({\n        container: containerRef.current,\n        renderer: \"svg\",\n        loop: 1,          // loop exactly twice\n        autoplay: false,\n        path: \"/assets/Trophy.json\",\n      });\n\n      // store reference\n      animationRef.current = animation;\n\n      // freeze on last frame when finished\n      animation.addEventListener(\"complete\", () => {\n        const lastFrame = animation.getDuration(true); // total frames\n        animation.goToAndStop(lastFrame, true);\n      });\n      //  start after 500ms\n      setTimeout(() => {\n        animation.play();\n      }, 500);\n    }\n\n    // increase the timeout (8s instead of 5s)\n    const timer = setTimeout(() => {\n      onDismiss();\n    }, 8000);\n\n    return () => {\n      clearTimeout(timer);\n      if (animationRef.current) {\n        animationRef.current.destroy();\n      }\n    };\n  }, [onDismiss]);\n\n  const normalizeCategory = (cat: string): 'elementle' | 'streak' | 'percentile' | null => {\n    const lower = cat.toLowerCase();\n    if (lower.includes('elementle')) return 'elementle';\n    if (lower.includes('streak')) return 'streak';\n    if (lower.includes('percentile')) return 'percentile';\n    return null;\n  };\n\n  const getCategoryIcon = () => {\n    const category = normalizeCategory(badge.badge.category);\n    const iconClass = \"w-6 h-6\";\n    \n    switch (category) {\n      case 'elementle':\n        return <Target className={iconClass} />;\n      case 'streak':\n        return <Flame className={iconClass} />;\n      case 'percentile':\n        return <Percent className={iconClass} />;\n      default:\n        return null;\n    }\n  };\n\n  const getBadgeTitle = () => {\n    const category = normalizeCategory(badge.badge.category);\n    const threshold = badge.badge.threshold;\n    \n    switch (category) {\n      case 'elementle':\n        return threshold === 1 ? 'Perfect Guess!' : 'Elementle In 2!';\n      case 'streak':\n        if (threshold >= 365) return `${threshold} Day Legend!`;\n        if (threshold >= 100) return `${threshold} Day Master!`;\n        if (threshold >= 30) return `${threshold} Day Champion!`;\n        return `${threshold} Day Streak!`;\n      case 'percentile':\n        return `Top ${threshold}% Player!`;\n      default:\n        return 'Badge Earned!';\n    }\n  };\n\n  const getBadgeDescription = () => {\n    const category = normalizeCategory(badge.badge.category);\n    const threshold = badge.badge.threshold;\n    \n    switch (category) {\n      case 'elementle':\n        return threshold === 1 \n          ? \"You guessed correctly on your first try!\" \n          : \"You guessed correctly in just 2 attempts!\";\n      case 'streak':\n        return `You've won ${threshold} days in a row!`;\n      case 'percentile':\n        return `You're in the top ${threshold}% of players this month!`;\n      default:\n        return \"Congratulations on your achievement!\";\n    }\n  };\n\n  const getBadgeColor = () => {\n    const category = normalizeCategory(badge.badge.category);\n    const threshold = badge.badge.threshold;\n    \n    switch (category) {\n      case 'elementle':\n        return threshold === 1 ? 'text-amber-400' : 'text-emerald-400';\n      case 'streak':\n        if (threshold >= 365) return 'text-purple-400';\n        if (threshold >= 100) return 'text-amber-400';\n        if (threshold >= 30) return 'text-cyan-400';\n        return 'text-emerald-400';\n      case 'percentile':\n        if (threshold <= 1) return 'text-purple-400';\n        if (threshold <= 5) return 'text-amber-400';\n        if (threshold <= 10) return 'text-cyan-400';\n        return 'text-emerald-400';\n      default:\n        return 'text-amber-400';\n    }\n  };\n\n  return (\n    <motion.div\n      className=\"fixed inset-0 z-50 flex items-center justify-center bg-black backdrop-blur-sm\"\n      onClick={onDismiss}\n      data-testid=\"badge-celebration-overlay\"\n      initial={pageVariants.fadeIn.initial}\n      animate={pageVariants.fadeIn.animate}\n      exit={pageVariants.fadeIn.exit}\n      transition={pageTransition}\n    >\n      <div\n        className=\"cursor-pointer p-8 max-w-sm w-full mx-4 text-center\"\n        onClick={onDismiss}\n        data-testid=\"badge-celebration-card\"\n      >\n        <div className=\"flex flex-col items-center gap-4\">\n          <div \n            ref={containerRef}\n            className=\"w-48 h-48\"\n            data-testid=\"trophy-animation\"\n          />\n          \n          <img \n            src={Streak_Hamster_Black} \n            alt=\"Badge\" \n            className=\"w-20 h-20 object-contain\"\n            data-testid=\"badge-image\"\n          />\n          \n          <div className={`flex items-center gap-2 ${getBadgeColor()}`}>\n            {getCategoryIcon()}\n            <h3 \n              className=\"text-2xl font-bold\"\n              data-testid=\"text-badge-title\"\n            >\n              {getBadgeTitle()}\n            </h3>\n          </div>\n          \n          <p \n            className=\"text-lg text-white/80\"\n            data-testid=\"text-badge-description\"\n          >\n            {getBadgeDescription()}\n          </p>\n\n          <div className=\"flex items-center gap-2 mt-2\">\n            <span className=\"text-sm text-white/60\">\n              Badge Earned\n            </span>\n          </div>\n\n          <p className=\"text-sm text-white/40 mt-4\">\n            Click anywhere to dismiss\n          </p>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":6981,"size_tokens":null},"client/src/hooks/useBadgeChecker.ts":{"content":"import { useState, useCallback } from 'react';\nimport { apiRequest } from '@/lib/queryClient';\nimport type { UserBadgeWithDetails } from '@shared/schema';\n\ninterface BadgeCheckResult {\n  newBadge: UserBadgeWithDetails | null;\n  error: string | null;\n}\n\nexport function useBadgeChecker() {\n  const [pendingBadge, setPendingBadge] = useState<UserBadgeWithDetails | null>(null);\n  const [isChecking, setIsChecking] = useState(false);\n\n  const checkElementleBadge = useCallback(async (\n    guessCount: number,\n    gameType: 'USER' | 'REGION'\n  ): Promise<BadgeCheckResult> => {\n    if (guessCount !== 1 && guessCount !== 2) {\n      return { newBadge: null, error: null };\n    }\n\n    setIsChecking(true);\n    try {\n      const endpoint = gameType === 'USER' \n        ? '/api/user/badges/check-elementle'\n        : '/api/badges/check-elementle';\n      \n      const response = await apiRequest('POST', endpoint, {\n        guessCount\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json();\n        return { newBadge: null, error: errorData.error || 'Failed to check badge' };\n      }\n\n      const data = await response.json();\n      if (data.awarded && data.badge) {\n        setPendingBadge(data.badge);\n        return { newBadge: data.badge, error: null };\n      }\n\n      return { newBadge: null, error: null };\n    } catch (error) {\n      console.error('[useBadgeChecker] Error checking elementle badge:', error);\n      return { newBadge: null, error: 'Network error' };\n    } finally {\n      setIsChecking(false);\n    }\n  }, []);\n\n  const checkStreakBadge = useCallback(async (\n    currentStreak: number,\n    gameType: 'USER' | 'REGION'\n  ): Promise<BadgeCheckResult> => {\n    if (currentStreak < 7) {\n      return { newBadge: null, error: null };\n    }\n\n    setIsChecking(true);\n    try {\n      const endpoint = gameType === 'USER' \n        ? '/api/user/badges/check-streak'\n        : '/api/badges/check-streak';\n      \n      const response = await apiRequest('POST', endpoint, {\n        streak: currentStreak\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json();\n        return { newBadge: null, error: errorData.error || 'Failed to check badge' };\n      }\n\n      const data = await response.json();\n      if (data.awarded && data.badge) {\n        setPendingBadge(data.badge);\n        return { newBadge: data.badge, error: null };\n      }\n\n      return { newBadge: null, error: null };\n    } catch (error) {\n      console.error('[useBadgeChecker] Error checking streak badge:', error);\n      return { newBadge: null, error: 'Network error' };\n    } finally {\n      setIsChecking(false);\n    }\n  }, []);\n\n  const checkPercentileBadge = useCallback(async (\n    gameType: 'USER' | 'REGION'\n  ): Promise<BadgeCheckResult> => {\n    setIsChecking(true);\n    try {\n      const endpoint = gameType === 'USER'\n        ? '/api/user/badges/check-percentile'\n        : '/api/badges/check-percentile';\n      \n      const response = await apiRequest('POST', endpoint);\n\n      if (!response.ok) {\n        const errorData = await response.json();\n        return { newBadge: null, error: errorData.error || 'Failed to check percentile badge' };\n      }\n\n      const data = await response.json();\n      if (data.awarded && data.badge) {\n        setPendingBadge(data.badge);\n        return { newBadge: data.badge, error: null };\n      }\n\n      return { newBadge: null, error: null };\n    } catch (error) {\n      console.error('[useBadgeChecker] Error checking percentile badge:', error);\n      return { newBadge: null, error: 'Network error' };\n    } finally {\n      setIsChecking(false);\n    }\n  }, []);\n\n  // Check badges after game completion - only checks Elementle (won in 1-2) and Streak badges\n  // TOP % percentile badges are handled separately by a monthly cron job that inserts pending badges,\n  // which are then awarded when GameSelectionPage loads and processes unawarded badges\n  const checkAllBadgesOnGameComplete = useCallback(async (\n    won: boolean,\n    guessCount: number,\n    currentStreak: number,\n    gameType: 'USER' | 'REGION'\n  ): Promise<UserBadgeWithDetails | null> => {\n    if (!won) return null;\n\n    // Check for \"Elementle In\" badges (won in 1 or 2 guesses)\n    const elementleResult = await checkElementleBadge(guessCount, gameType);\n    if (elementleResult.newBadge) {\n      return elementleResult.newBadge;\n    }\n\n    // Check for streak milestone badges (7, 14, 30, etc. day streaks)\n    const streakResult = await checkStreakBadge(currentStreak, gameType);\n    if (streakResult.newBadge) {\n      return streakResult.newBadge;\n    }\n\n    // Note: TOP % percentile badges are NOT checked here - they are managed by a monthly cron job\n    // and processed as pending badges when the user visits GameSelectionPage\n\n    return null;\n  }, [checkElementleBadge, checkStreakBadge]);\n\n  const dismissBadge = useCallback(() => {\n    setPendingBadge(null);\n  }, []);\n\n  return {\n    pendingBadge,\n    isChecking,\n    checkElementleBadge,\n    checkStreakBadge,\n    checkPercentileBadge,\n    checkAllBadgesOnGameComplete,\n    dismissBadge\n  };\n}\n","path":null,"size_bytes":5110,"size_tokens":null},"server.js":{"content":"import express from \"express\";\nimport path from \"path\";\nimport { fileURLToPath } from \"url\";\n\nconst __dirname = path.dirname(fileURLToPath(import.meta.url));\nconst app = express();\nconst port = process.env.PORT || 3000;\n\nconst distPath = path.join(__dirname, \"dist/public\");\n\napp.use(express.static(distPath));\n\n// Fallback: always serve index.html for unknown routes\napp.get(\"*\", (req, res) => {\n  res.sendFile(path.join(distPath, \"index.html\"));\n});\n\napp.listen(port, () => {\n  console.log(`Server running on port ${port}`);\n});\n","path":null,"size_bytes":531,"size_tokens":null},"server/diagnose-db.ts":{"content":"// Diagnostic script to check database tables and data\nimport { db } from \"./db\";\nimport { sql } from \"drizzle-orm\";\n\nasync function diagnoseTables() {\n  console.log(\"\\n===== DATABASE DIAGNOSTICS =====\\n\");\n\n  try {\n    // Check which tables exist\n    const tables = await db.execute(sql`\n      SELECT table_name \n      FROM information_schema.tables \n      WHERE table_schema = 'public' \n      ORDER BY table_name\n    `);\n    \n    console.log(\" Existing tables:\");\n    tables.rows.forEach((row: any) => {\n      console.log(`  - ${row.table_name}`);\n    });\n\n    // Check row counts for key tables\n    console.log(\"\\n Row counts:\");\n    \n    const tablesToCheck = [\n      'user_profiles',\n      'user_settings',\n      'user_stats_region',\n      'questions_master_region',\n      'questions_allocated_region',\n      'game_attempts_region',\n      'guesses_region',\n      'questions_master_user',\n      'questions_allocated_user',\n      'game_attempts_user',\n      'guesses_user',\n      'user_stats_user',\n      'regions'\n    ];\n\n    for (const table of tablesToCheck) {\n      try {\n        const result = await db.execute(sql.raw(`SELECT COUNT(*) FROM ${table}`));\n        console.log(`  ${table}: ${result.rows[0].count} rows`);\n      } catch (e: any) {\n        console.log(`  ${table}: ERROR - ${e.message}`);\n      }\n    }\n\n    // Check for RLS policies\n    console.log(\"\\n RLS Status:\");\n    const rlsStatus = await db.execute(sql`\n      SELECT \n        schemaname,\n        tablename,\n        rowsecurity\n      FROM pg_tables \n      WHERE schemaname = 'public' \n      ORDER BY tablename\n    `);\n    \n    rlsStatus.rows.forEach((row: any) => {\n      console.log(`  ${row.tablename}: ${row.rowsecurity ? 'ENABLED' : 'DISABLED'}`);\n    });\n\n    // Check policies for each table\n    console.log(\"\\n  RLS Policies:\");\n    const policies = await db.execute(sql`\n      SELECT \n        schemaname,\n        tablename,\n        policyname,\n        permissive,\n        roles,\n        cmd\n      FROM pg_policies \n      WHERE schemaname = 'public'\n      ORDER BY tablename, policyname\n    `);\n    \n    if (policies.rows.length === 0) {\n      console.log(\"    NO POLICIES FOUND - This may cause data access issues!\");\n    } else {\n      policies.rows.forEach((row: any) => {\n        console.log(`  ${row.tablename}.${row.policyname} (${row.cmd}) for roles: ${row.roles}`);\n      });\n    }\n\n  } catch (error) {\n    console.error(\" Diagnostic error:\", error);\n  }\n  \n  console.log(\"\\n================================\\n\");\n}\n\ndiagnoseTables().then(() => process.exit(0));\n","path":null,"size_bytes":2583,"size_tokens":null},"client/src/components/badges/AllBadgesPopup.tsx":{"content":"import { useState, useEffect, useRef, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { motion, AnimatePresence, useMotionValue, animate, PanInfo } from \"framer-motion\";\nimport { X, ChevronUp, ChevronDown } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport type { Badge, UserBadgeWithDetails } from \"@shared/schema\";\nimport badgeImage from \"@assets/Signup-Hamster-Cutout.png\";\nimport { useAdBannerActive } from \"@/components/AdBanner\";\n\ntype CategoryType = 'elementle' | 'streak' | 'percentile';\ntype HighestBadges = Record<CategoryType, UserBadgeWithDetails | null>;\n\ninterface AllBadgesPopupProps {\n  gameType: 'USER' | 'REGION';\n  earnedBadges?: HighestBadges | null;\n  initialCategory?: CategoryType;\n  onClose: () => void;\n}\n\ninterface BadgeItem {\n  badge: Badge;\n  isEarned: boolean;\n  userBadge?: UserBadgeWithDetails;\n}\n\nconst CATEGORIES: CategoryType[] = ['elementle', 'streak', 'percentile'];\n\nconst CATEGORY_CONFIG: Record<CategoryType, {\n  title: string;\n  getBadgeLabel: (threshold: number) => string;\n  getBadgeDescription: (threshold: number) => string;\n}> = {\n  elementle: {\n    title: 'Won In',\n    getBadgeLabel: (t) => t === 1 ? '1 Guess' : '2 Guesses',\n    getBadgeDescription: (t) => t === 1 \n      ? 'Win the game on your first guess'\n      : 'Win the game in just 2 guesses',\n  },\n  streak: {\n    title: 'Streak',\n    getBadgeLabel: (t) => `${t} Days`,\n    getBadgeDescription: (t) => `Maintain a ${t} day winning streak`,\n  },\n  percentile: {\n    title: 'Top %',\n    getBadgeLabel: (t) => `Top ${t}%`,\n    getBadgeDescription: (t) => `Rank in the top ${t}% of players`,\n  },\n};\n\nfunction normalizeCategory(category: string): CategoryType {\n  const lower = category.toLowerCase();\n  if (lower === 'elementle in' || lower === 'elementle') return 'elementle';\n  if (lower === 'streak') return 'streak';\n  if (lower === 'percentile') return 'percentile';\n  return 'elementle';\n}\n\n// Animation variants for category transitions\n// When swiping UP or clicking DOWN arrow (going to NEXT category):\n//   - Content scrolls UPWARD (exits to negative Y), new content enters from BELOW (positive Y)\n// When swiping DOWN or clicking UP arrow (going to PREVIOUS category):\n//   - Content scrolls DOWNWARD (exits to positive Y), new content enters from ABOVE (negative Y)\nconst categoryVariants = {\n  enter: (direction: number) => ({\n    opacity: 0,\n    y: direction > 0 ? 100 : -100, // From below when going next, from above when going prev\n  }),\n  center: {\n    opacity: 1,\n    y: 0,\n  },\n  exit: (direction: number) => ({\n    opacity: 0,\n    y: direction > 0 ? -100 : 100, // Goes up when going next, goes down when going prev\n  }),\n};\n\nexport function AllBadgesPopup({ gameType, earnedBadges, initialCategory, onClose }: AllBadgesPopupProps) {\n  const initialIndex = initialCategory ? CATEGORIES.indexOf(initialCategory) : 0;\n  const [currentCategoryIndex, setCurrentCategoryIndex] = useState(initialIndex >= 0 ? initialIndex : 0);\n  const [currentBadgeIndex, setCurrentBadgeIndex] = useState<Record<CategoryType, number>>({\n    elementle: 0,\n    streak: 0,\n    percentile: 0,\n  });\n  // Track animation direction: 1 = going to next (higher index), -1 = going to prev (lower index)\n  const [direction, setDirection] = useState(0);\n  // Track locked scroll direction during a gesture\n  const [lockedDirection, setLockedDirection] = useState<'horizontal' | 'vertical' | null>(null);\n  // Track if we're currently animating a category change\n  const [isAnimating, setIsAnimating] = useState(false);\n  // Track if a category change was triggered (to prevent bounce back)\n  const categoryChangeTriggered = useRef(false);\n  \n  // Motion values for drag tracking\n  const dragY = useMotionValue(0);\n  const dragX = useMotionValue(0);\n  \n  // Check if ad banner is active (Standard users)\n  const adBannerActive = useAdBannerActive();\n\n  const { data: allBadges } = useQuery<Badge[]>({\n    queryKey: ['/api/badges'],\n  });\n\n  // Fetch ALL earned badges (not just highest) for exact ID matching\n  const allEarnedEndpoint = gameType === 'USER' \n    ? '/api/user/badges/earned/all' \n    : '/api/badges/earned/all';\n  \n  const { data: allEarnedBadges } = useQuery<UserBadgeWithDetails[]>({\n    queryKey: [allEarnedEndpoint],\n  });\n\n  // Create a set of earned badge IDs for O(1) lookup\n  const earnedBadgeIds = useMemo(() => {\n    if (!allEarnedBadges) return new Set<number>();\n    return new Set(allEarnedBadges.map(ub => ub.badge.id));\n  }, [allEarnedBadges]);\n\n  const currentCategory = CATEGORIES[currentCategoryIndex];\n  const config = CATEGORY_CONFIG[currentCategory];\n\n  const getBadgesForCategory = (category: CategoryType): BadgeItem[] => {\n    if (!allBadges) return [];\n\n    const categoryBadges = allBadges\n      .filter(b => normalizeCategory(b.category) === category)\n      .sort((a, b) => a.id - b.id);\n\n    const earnedBadge = earnedBadges?.[category];\n    const earnedThreshold = earnedBadge?.badge?.threshold ?? -1;\n\n    return categoryBadges.map(badge => {\n      let isEarned: boolean;\n      \n      if (category === 'elementle') {\n        // Elementle badges are INDEPENDENT - check exact badge ID match\n        // A user can have \"Elementle in 1\", \"Elementle in 2\", both, or neither\n        isEarned = earnedBadgeIds.has(badge.id);\n      } else if (category === 'percentile') {\n        // Percentile badges cascade: lower is better (Top 1% implies Top 5%, 10%, etc.)\n        isEarned = earnedThreshold !== -1 && badge.threshold >= earnedThreshold;\n      } else {\n        // Streak badges cascade: higher is better (30-day streak implies 7-day, 14-day)\n        isEarned = earnedThreshold !== -1 && badge.threshold <= earnedThreshold;\n      }\n      \n      // Find the matching user badge for this specific badge if earned\n      const matchingUserBadge = allEarnedBadges?.find(ub => ub.badge.id === badge.id);\n      \n      return {\n        badge,\n        isEarned,\n        userBadge: matchingUserBadge,\n      };\n    });\n  };\n\n  const categoryBadges = getBadgesForCategory(currentCategory);\n\n  useEffect(() => {\n    if (categoryBadges.length === 0) return;\n\n    const earnedBadge = earnedBadges?.[currentCategory];\n    if (earnedBadge) {\n      const earnedIndex = categoryBadges.findIndex(\n        b => b.badge.id === earnedBadge.badge.id\n      );\n      if (earnedIndex !== -1) {\n        setCurrentBadgeIndex(prev => ({\n          ...prev,\n          [currentCategory]: earnedIndex,\n        }));\n        return;\n      }\n    }\n    setCurrentBadgeIndex(prev => ({\n      ...prev,\n      [currentCategory]: 0,\n    }));\n  }, [currentCategory, categoryBadges.length, earnedBadges]);\n\n  const handleBadgeSwipe = (swipeDirection: number) => {\n    const badges = getBadgesForCategory(currentCategory);\n    const currentIndex = currentBadgeIndex[currentCategory];\n    const newIndex = Math.max(0, Math.min(badges.length - 1, currentIndex + swipeDirection));\n    \n    setCurrentBadgeIndex(prev => ({\n      ...prev,\n      [currentCategory]: newIndex,\n    }));\n  };\n\n  const handleCategoryChange = (newIndex: number) => {\n    if (newIndex === currentCategoryIndex) return;\n    if (newIndex < 0 || newIndex >= CATEGORIES.length) return;\n    if (isAnimating) return;\n    \n    categoryChangeTriggered.current = true;\n    // Set direction based on which way we're going\n    // Positive direction = going to higher index (next category)\n    // Negative direction = going to lower index (previous category)\n    setDirection(newIndex > currentCategoryIndex ? 1 : -1);\n    setIsAnimating(true);\n    setCurrentCategoryIndex(newIndex);\n  };\n\n  const handleAnimationComplete = () => {\n    setIsAnimating(false);\n    categoryChangeTriggered.current = false;\n  };\n\n  const handlePanStart = () => {\n    setLockedDirection(null);\n    categoryChangeTriggered.current = false;\n    dragY.set(0);\n    dragX.set(0);\n  };\n\n  const handlePan = (event: MouseEvent | TouchEvent | PointerEvent, info: PanInfo) => {\n    const { offset } = info;\n    \n    // Lock direction on first significant movement\n    if (lockedDirection === null) {\n      const absX = Math.abs(offset.x);\n      const absY = Math.abs(offset.y);\n      const threshold = 10;\n      \n      if (absX > threshold || absY > threshold) {\n        if (absY > absX) {\n          setLockedDirection('vertical');\n        } else {\n          setLockedDirection('horizontal');\n        }\n      }\n    }\n    \n    // Update motion values for visual feedback during drag\n    if (lockedDirection === 'vertical') {\n      dragY.set(offset.y * 0.3); // Damped movement\n    } else if (lockedDirection === 'horizontal') {\n      dragX.set(offset.x * 0.3);\n    }\n  };\n\n  const handlePanEnd = (event: MouseEvent | TouchEvent | PointerEvent, info: PanInfo) => {\n    const { offset, velocity } = info;\n    const swipeThreshold = 50;\n    const velocityThreshold = 500;\n\n    if (lockedDirection === 'vertical') {\n      const sufficientSwipe = Math.abs(offset.y) > swipeThreshold || Math.abs(velocity.y) > velocityThreshold;\n      \n      if (sufficientSwipe) {\n        // Swipe up (negative offset.y) = go to next category (higher index)\n        // Swipe down (positive offset.y) = go to previous category (lower index)\n        const swipeDir = offset.y < 0 ? 1 : -1;\n        const newIndex = currentCategoryIndex + swipeDir;\n        \n        // Only change if valid index\n        if (newIndex >= 0 && newIndex < CATEGORIES.length) {\n          handleCategoryChange(newIndex);\n        }\n      }\n    } else if (lockedDirection === 'horizontal') {\n      if (Math.abs(offset.x) > swipeThreshold || Math.abs(velocity.x) > velocityThreshold) {\n        handleBadgeSwipe(offset.x < 0 ? 1 : -1);\n      }\n    }\n    \n    // Always animate both dragX and dragY back to center for smooth snap-back\n    // The category transition animation is separate from the drag feedback\n    animate(dragX, 0, { type: \"spring\", stiffness: 300, damping: 30 });\n    animate(dragY, 0, { type: \"spring\", stiffness: 300, damping: 30 });\n    \n    setLockedDirection(null);\n  };\n\n  const activeBadgeIndex = currentBadgeIndex[currentCategory];\n  const activeBadge = categoryBadges[activeBadgeIndex];\n\n  useEffect(() => {\n    document.body.style.overflow = 'hidden';\n    return () => {\n      document.body.style.overflow = '';\n    };\n  }, []);\n\n  const arrowButtonColor = \"#7DAAE8\";\n\n  // Badge sizes increased by 30% for \"See all\" screen:\n  // Original: non-center w-20 h-20 (80px), center w-24 h-24 (96px)\n  // New: non-center ~104px, center ~125px\n  const badgeSizeNormal = \"w-[104px] h-[104px]\"; // 30% larger than original 80px\n  const badgeSizeCenter = \"w-[125px] h-[125px]\"; // 30% larger than original 96px\n\n  return (\n    <motion.div\n      className=\"fixed inset-0 z-50 bg-background flex flex-col touch-none\"\n      initial={{ opacity: 0 }}\n      animate={{ opacity: 1 }}\n      exit={{ opacity: 0 }}\n      data-testid=\"all-badges-popup\"\n      onTouchMove={(e) => e.preventDefault()}\n    >\n      <button\n        onClick={onClose}\n        className=\"absolute top-4 right-4 z-30 p-2 text-muted-foreground hover:text-foreground transition-colors\"\n        data-testid=\"button-close-all-badges\"\n      >\n        <X className=\"w-6 h-6\" />\n      </button>\n\n      {/* Top section with UP arrow icon (goes to next category) - fixed at top */}\n      <div className=\"relative z-20 pt-8 pb-2 flex justify-center\">\n        {/* Background overlay to hide content animating behind */}\n        <div className=\"absolute inset-0 bg-background\" />\n        <div className=\"relative z-10\">\n          {currentCategoryIndex < CATEGORIES.length - 1 ? (\n            <button\n              onClick={() => handleCategoryChange(currentCategoryIndex + 1)}\n              className=\"w-14 h-14 flex items-center justify-center rounded-full transition-opacity hover:opacity-80\"\n              style={{ backgroundColor: arrowButtonColor }}\n              data-testid=\"button-category-next\"\n            >\n              <ChevronUp className=\"h-10 w-10 text-white\" />\n            </button>\n          ) : (\n            <div className=\"w-14 h-14\" /> \n          )}\n        </div>\n      </div>\n\n      {/* Main content area */}\n      <div className=\"flex-1 flex flex-col items-center justify-center overflow-hidden touch-none\">\n        <AnimatePresence mode=\"wait\" custom={direction} initial={false} onExitComplete={handleAnimationComplete}>\n          <motion.div\n            key={currentCategory}\n            custom={direction}\n            variants={categoryVariants}\n            initial=\"enter\"\n            animate=\"center\"\n            exit=\"exit\"\n            transition={{ \n              duration: 0.3,\n              ease: \"easeOut\"\n            }}\n            className=\"flex flex-col items-center w-full\"\n          >\n            {/* Title without icon */}\n            <div className=\"flex items-center justify-center text-foreground mb-6\">\n              <h2 className=\"text-xl font-bold\">{config.title}</h2>\n            </div>\n\n            {/* Badge carousel with pan gestures */}\n            <motion.div\n              className=\"relative w-full flex items-center justify-center touch-none cursor-grab active:cursor-grabbing overflow-hidden\"\n              style={{ height: '220px', y: dragY }}\n              onPanStart={handlePanStart}\n              onPan={handlePan}\n              onPanEnd={handlePanEnd}\n            >\n              <motion.div \n                className=\"relative flex items-center justify-center\" \n                style={{ width: '100%', height: '100%', x: dragX }}\n              >\n                {categoryBadges.map((item, index) => {\n                  const offset = index - activeBadgeIndex;\n                  const isCenter = offset === 0;\n                  const xPosition = offset * 130; // Increased spacing for larger badges\n\n                  return (\n                    <motion.div\n                      key={item.badge.id}\n                      className=\"absolute flex flex-col items-center cursor-pointer\"\n                      initial={false}\n                      animate={{\n                        x: xPosition,\n                        scale: isCenter ? 1 : 0.7,\n                        opacity: isCenter ? 1 : (item.isEarned ? 0.7 : 0.3),\n                        zIndex: isCenter ? 10 : 1,\n                      }}\n                      transition={{ \n                        type: \"spring\", \n                        stiffness: 300, \n                        damping: 30 \n                      }}\n                      onClick={() => {\n                        setCurrentBadgeIndex(prev => ({\n                          ...prev,\n                          [currentCategory]: index,\n                        }));\n                      }}\n                      data-testid={`badge-item-${item.badge.id}`}\n                    >\n                      <div className={cn(\n                        \"relative\",\n                        !item.isEarned && \"opacity-30\"\n                      )}>\n                        <img\n                          src={badgeImage}\n                          alt={item.badge.name}\n                          className={cn(\n                            \"object-contain transition-all duration-300\",\n                            isCenter ? badgeSizeCenter : badgeSizeNormal\n                          )}\n                        />\n                      </div>\n                      <span className={cn(\n                        \"mt-2 text-sm font-medium whitespace-nowrap\",\n                        item.isEarned ? \"text-foreground\" : \"text-muted-foreground\"\n                      )}>\n                        {config.getBadgeLabel(item.badge.threshold)}\n                      </span>\n                    </motion.div>\n                  );\n                })}\n              </motion.div>\n            </motion.div>\n\n            {/* Description and Earned text */}\n            <div className=\"mt-4 text-center px-8 h-[72px] flex flex-col justify-start\">\n              {activeBadge && (\n                <motion.div\n                  initial={{ opacity: 0, y: 10 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ delay: 0.1 }}\n                >\n                  <p className={cn(\n                    \"text-lg\",\n                    activeBadge.isEarned ? \"text-foreground\" : \"text-muted-foreground\"\n                  )}>\n                    {config.getBadgeDescription(activeBadge.badge.threshold)}\n                  </p>\n                </motion.div>\n              )}\n              <div className=\"h-16 mt-2 flex items-center justify-center\">\n                {activeBadge?.isEarned && (\n                  <span \n                    className=\"px-6 py-2 text-white rounded-full text-lg font-semibold\"\n                    style={{ backgroundColor: gameType === 'USER' ? '#93cd78' : '#A4DB57' }}\n                  >\n                    Earned!\n                  </span>\n                )}\n              </div>\n            </div>\n          </motion.div>\n        </AnimatePresence>\n      </div>\n\n      {/* Bottom section with toggle and DOWN arrow icon (goes to previous category) - fixed at bottom */}\n      <div className={cn(\n        \"relative z-20 flex flex-col items-center\",\n        adBannerActive ? \"pb-20\" : \"pb-8\"\n      )}>\n        {/* Background overlay to hide content animating behind */}\n        <div className=\"absolute inset-0 bg-background\" />\n        \n        <div className=\"relative z-10 flex flex-col items-center\">\n          {/* Category toggle indicators - positioned with proper spacing */}\n          <div className=\"flex gap-2 py-3 mb-6\">\n            {CATEGORIES.map((cat, index) => (\n              <button\n                key={cat}\n                onClick={() => handleCategoryChange(index)}\n                className={cn(\n                  \"w-2 h-2 rounded-full transition-all\",\n                  index === currentCategoryIndex \n                    ? \"bg-foreground w-6\" \n                    : \"bg-muted-foreground/30 hover:bg-muted-foreground/50\"\n                )}\n                data-testid={`category-indicator-${cat}`}\n              />\n            ))}\n          </div>\n\n          {/* Down Arrow icon (goes to previous category) */}\n          {currentCategoryIndex > 0 ? (\n            <button\n              onClick={() => handleCategoryChange(currentCategoryIndex - 1)}\n              className=\"w-14 h-14 flex items-center justify-center rounded-full transition-opacity hover:opacity-80\"\n              style={{ backgroundColor: arrowButtonColor }}\n              data-testid=\"button-category-prev\"\n            >\n              <ChevronDown className=\"h-10 w-10 text-white\" />\n            </button>\n          ) : (\n            <div className=\"w-14 h-14\" />\n          )}\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":18711,"size_tokens":null},"client/src/components/AdminScreenNavigator.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { ChevronLeft } from \"lucide-react\";\nimport { StreakSaverPopup } from \"./StreakSaverPopup\";\nimport { BadgeCelebrationPopup } from \"./badges/BadgeCelebrationPopup\";\nimport { GuestRestrictionPopup } from \"./GuestRestrictionPopup\";\nimport { GeneratingQuestionsScreen } from \"./GeneratingQuestionsScreen\";\nimport { IntroScreen } from \"./IntroScreen\";\nimport { useProfile } from \"@/hooks/useProfile\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport type { UserBadgeWithDetails } from \"@shared/schema\";\n\ninterface AdminScreenNavigatorProps {\n  onBack: () => void;\n}\n\nconst MOCK_BADGE: UserBadgeWithDetails = {\n  id: 1,\n  userId: \"test\",\n  badge: {\n    id: 1,\n    name: \"Test Badge\",\n    category: \"streak\",\n    threshold: 7,\n    createdAt: null,\n    iconUrl: \"/assets/badges/streak-7.png\",\n  },\n  isAwarded: true,\n  awardedAt: new Date(),\n};\n\nexport function AdminScreenNavigator({ onBack }: AdminScreenNavigatorProps) {\n  const { user } = useAuth();\n  const { profile } = useProfile();\n  const [activeScreen, setActiveScreen] = useState<string | null>(null);\n  const [selectedGameType, setSelectedGameType] = useState<\"region\" | \"user\">(\"region\");\n\n  const handleClose = () => setActiveScreen(null);\n  const handleBack = () => {\n    if (activeScreen) {\n      setActiveScreen(null);\n    } else {\n      onBack();\n    }\n  };\n\n  if (activeScreen === \"streak-saver-region\" || activeScreen === \"streak-saver-user\") {\n    const gameType = activeScreen === \"streak-saver-region\" ? \"region\" : \"user\";\n    return (\n      <div className=\"fixed inset-0 bg-background flex flex-col z-50\">\n        <div className=\"flex items-center justify-between p-4 border-b\">\n          <h1 className=\"text-lg font-bold\">Streak Saver Popup - {gameType === \"region\" ? \"Global\" : \"Personal\"}</h1>\n          <button\n            onClick={handleBack}\n            className=\"w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors\"\n            data-testid=\"button-back\"\n          >\n            <ChevronLeft className=\"h-6 w-6\" />\n          </button>\n        </div>\n        <div className=\"flex-1 flex items-center justify-center p-4\">\n          <StreakSaverPopup\n            open={true}\n            onClose={handleClose}\n            gameType={gameType}\n            currentStreak={15}\n            onPlayYesterdaysPuzzle={() => {}}\n          />\n        </div>\n      </div>\n    );\n  }\n\n  if (activeScreen === \"badge-celebration-region\" || activeScreen === \"badge-celebration-user\") {\n    return (\n      <div className=\"fixed inset-0 bg-background flex flex-col z-50\">\n        <div className=\"flex items-center justify-between p-4 border-b\">\n          <h1 className=\"text-lg font-bold\">Badge Celebration - {activeScreen === \"badge-celebration-region\" ? \"Global\" : \"Personal\"}</h1>\n          <button\n            onClick={handleBack}\n            className=\"w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors\"\n            data-testid=\"button-back\"\n          >\n            <ChevronLeft className=\"h-6 w-6\" />\n          </button>\n        </div>\n        <div className=\"flex-1 flex items-center justify-center p-4\">\n          <BadgeCelebrationPopup\n            badge={MOCK_BADGE}\n            onDismiss={handleClose}\n          />\n        </div>\n      </div>\n    );\n  }\n\n  if (activeScreen === \"guest-restriction-archive\" || activeScreen === \"guest-restriction-personal\" || activeScreen === \"guest-restriction-pro\") {\n    const typeMap = {\n      \"guest-restriction-archive\": \"archive\" as const,\n      \"guest-restriction-personal\": \"personal\" as const,\n      \"guest-restriction-pro\": \"pro\" as const,\n    };\n    const type = typeMap[activeScreen as keyof typeof typeMap];\n    const titles = { archive: \"Archive\", personal: \"Personal\", pro: \"Pro\" };\n    \n    return (\n      <div className=\"fixed inset-0 bg-background flex flex-col z-50\">\n        <div className=\"flex items-center justify-between p-4 border-b\">\n          <h1 className=\"text-lg font-bold\">Guest Restriction - {titles[type]}</h1>\n          <button\n            onClick={handleBack}\n            className=\"w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors\"\n            data-testid=\"button-back\"\n          >\n            <ChevronLeft className=\"h-6 w-6\" />\n          </button>\n        </div>\n        <div className=\"flex-1\">\n          <GuestRestrictionPopup\n            isOpen={true}\n            type={type}\n            onClose={handleClose}\n            onRegister={() => {}}\n            onLogin={() => {}}\n          />\n        </div>\n      </div>\n    );\n  }\n\n  if (activeScreen === \"generating-questions-region\" || activeScreen === \"generating-questions-user\") {\n    if (!user || !profile) {\n      return (\n        <div className=\"fixed inset-0 bg-background flex flex-col z-50\">\n          <div className=\"flex items-center justify-between p-4 border-b\">\n            <h1 className=\"text-lg font-bold\">Generating Questions</h1>\n            <button\n              onClick={handleBack}\n              className=\"w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors\"\n              data-testid=\"button-back\"\n            >\n              <ChevronLeft className=\"h-6 w-6\" />\n            </button>\n          </div>\n          <div className=\"flex-1 flex items-center justify-center\">\n            <p className=\"text-muted-foreground\">Loading...</p>\n          </div>\n        </div>\n      );\n    }\n    \n    return (\n      <div className=\"fixed inset-0 bg-background flex flex-col z-50\">\n        <div className=\"flex items-center justify-between p-4 border-b\">\n          <h1 className=\"text-lg font-bold\">Generating Questions - {activeScreen === \"generating-questions-region\" ? \"Global\" : \"Personal\"}</h1>\n          <button\n            onClick={handleBack}\n            className=\"w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors\"\n            data-testid=\"button-back\"\n          >\n            <ChevronLeft className=\"h-6 w-6\" />\n          </button>\n        </div>\n        <div className=\"flex-1\">\n          <GeneratingQuestionsScreen\n            userId={user.id}\n            region={profile.region || \"UK\"}\n            postcode={profile.postcode ?? \"\"}\n            onComplete={handleClose}\n            regenerationType=\"first_login\"\n          />\n        </div>\n      </div>\n    );\n  }\n\n  if (activeScreen === \"intro-region\" || activeScreen === \"intro-user\") {\n    return (\n      <div className=\"fixed inset-0 bg-background flex flex-col z-50\">\n        <div className=\"flex items-center justify-between p-4 border-b\">\n          <h1 className=\"text-lg font-bold\">Intro Screen - {activeScreen === \"intro-region\" ? \"Global\" : \"Personal\"}</h1>\n          <button\n            onClick={handleBack}\n            className=\"w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors\"\n            data-testid=\"button-back\"\n          >\n            <ChevronLeft className=\"h-6 w-6\" />\n          </button>\n        </div>\n        <div className=\"flex-1\">\n          <IntroScreen\n            puzzleDateCanonical=\"2024-12-05\"\n            eventTitle=\"Test Historical Event\"\n            hasCluesEnabled={true}\n            isLocalMode={activeScreen === \"intro-user\"}\n            categoryName={activeScreen === \"intro-user\" ? \"Science\" : undefined}\n            locationName={activeScreen === \"intro-user\" ? \"London\" : undefined}\n            onPlayClick={handleClose}\n            onBack={handleBack}\n            formatDateForDisplay={(date) => date}\n            currentStreak={5}\n            isStreakGame={true}\n          />\n        </div>\n      </div>\n    );\n  }\n\n  // Main menu\n  return (\n    <div className=\"fixed inset-0 bg-background flex flex-col z-50\">\n      <div className=\"flex items-center justify-between p-4 border-b\">\n        <h1 className=\"text-lg font-bold\">Admin Screen Navigator</h1>\n        <button\n          onClick={onBack}\n          className=\"w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors\"\n          data-testid=\"button-back\"\n        >\n          <ChevronLeft className=\"h-6 w-6\" />\n        </button>\n      </div>\n      \n      <div className=\"flex-1 overflow-y-auto p-4\">\n        <div className=\"space-y-3 max-w-2xl\">\n          <div className=\"space-y-2\">\n            <h2 className=\"font-semibold text-sm text-muted-foreground\">Streak Saver</h2>\n            <div className=\"grid grid-cols-2 gap-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setActiveScreen(\"streak-saver-region\")}\n                data-testid=\"button-streak-saver-region\"\n              >\n                Global Streak Saver\n              </Button>\n              <Button\n                variant=\"outline\"\n                onClick={() => setActiveScreen(\"streak-saver-user\")}\n                data-testid=\"button-streak-saver-user\"\n              >\n                Personal Streak Saver\n              </Button>\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <h2 className=\"font-semibold text-sm text-muted-foreground\">Badge Celebration</h2>\n            <div className=\"grid grid-cols-2 gap-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setActiveScreen(\"badge-celebration-region\")}\n                data-testid=\"button-badge-region\"\n              >\n                Global Badge Celebration\n              </Button>\n              <Button\n                variant=\"outline\"\n                onClick={() => setActiveScreen(\"badge-celebration-user\")}\n                data-testid=\"button-badge-user\"\n              >\n                Personal Badge Celebration\n              </Button>\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <h2 className=\"font-semibold text-sm text-muted-foreground\">Guest Restriction Popup</h2>\n            <div className=\"grid grid-cols-3 gap-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setActiveScreen(\"guest-restriction-archive\")}\n                data-testid=\"button-guest-archive\"\n              >\n                Archive\n              </Button>\n              <Button\n                variant=\"outline\"\n                onClick={() => setActiveScreen(\"guest-restriction-personal\")}\n                data-testid=\"button-guest-personal\"\n              >\n                Personal\n              </Button>\n              <Button\n                variant=\"outline\"\n                onClick={() => setActiveScreen(\"guest-restriction-pro\")}\n                data-testid=\"button-guest-pro\"\n              >\n                Pro\n              </Button>\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <h2 className=\"font-semibold text-sm text-muted-foreground\">Generating Questions Screen</h2>\n            <div className=\"grid grid-cols-2 gap-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setActiveScreen(\"generating-questions-region\")}\n                data-testid=\"button-generating-region\"\n              >\n                Global Generating\n              </Button>\n              <Button\n                variant=\"outline\"\n                onClick={() => setActiveScreen(\"generating-questions-user\")}\n                data-testid=\"button-generating-user\"\n              >\n                Personal Generating\n              </Button>\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <h2 className=\"font-semibold text-sm text-muted-foreground\">Intro Screen</h2>\n            <div className=\"grid grid-cols-2 gap-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setActiveScreen(\"intro-region\")}\n                data-testid=\"button-intro-region\"\n              >\n                Global Intro\n              </Button>\n              <Button\n                variant=\"outline\"\n                onClick={() => setActiveScreen(\"intro-user\")}\n                data-testid=\"button-intro-user\"\n              >\n                Personal Intro\n              </Button>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":12485,"size_tokens":null},"client/src/components/HolidayEndedPopup.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useStreakSaverStatus } from \"@/hooks/useStreakSaverStatus\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { Umbrella } from \"lucide-react\";\n\nexport function HolidayEndedPopup() {\n  const { isAuthenticated } = useAuth();\n  const { \n    holidayEnded,\n    holidayDaysTakenCurrentPeriod,\n    acknowledgeHolidayEnd,\n    isAcknowledging,\n    isLoading\n  } = useStreakSaverStatus();\n  \n  const [isOpen, setIsOpen] = useState(false);\n\n  useEffect(() => {\n    if (!isLoading && isAuthenticated && holidayEnded) {\n      setIsOpen(true);\n    }\n  }, [isLoading, isAuthenticated, holidayEnded]);\n\n  const handleAcknowledge = async () => {\n    try {\n      await acknowledgeHolidayEnd();\n      setIsOpen(false);\n    } catch (error) {\n      console.error(\"Failed to acknowledge holiday end:\", error);\n      setIsOpen(false);\n    }\n  };\n\n  if (!isAuthenticated || !holidayEnded) {\n    return null;\n  }\n\n  return (\n    <AlertDialog open={isOpen} onOpenChange={setIsOpen}>\n      <AlertDialogContent>\n        <AlertDialogHeader>\n          <AlertDialogTitle className=\"flex items-center gap-2\">\n            <Umbrella className=\"h-5 w-5 text-blue-500\" />\n            Holiday Mode Ended\n          </AlertDialogTitle>\n          <AlertDialogDescription asChild>\n            <div className=\"text-left space-y-3 text-sm text-muted-foreground\">\n              <p>\n                Your holiday mode has ended after {holidayDaysTakenCurrentPeriod} day{holidayDaysTakenCurrentPeriod !== 1 ? 's' : ''}.\n              </p>\n              <p>\n                Your streak was protected during this time. Now it's time to get back to playing!\n              </p>\n            </div>\n          </AlertDialogDescription>\n        </AlertDialogHeader>\n        <AlertDialogFooter>\n          <AlertDialogAction \n            onClick={handleAcknowledge}\n            disabled={isAcknowledging}\n            className=\"bg-blue-500 text-white hover:bg-blue-600\"\n            data-testid=\"button-acknowledge-holiday-end\"\n          >\n            {isAcknowledging ? \"...\" : \"Got it!\"}\n          </AlertDialogAction>\n        </AlertDialogFooter>\n      </AlertDialogContent>\n    </AlertDialog>\n  );\n}\n","path":null,"size_bytes":2395,"size_tokens":null},"scripts/recalculate-all-stats.ts":{"content":"import { db } from \"../server/db\";\nimport { DatabaseStorage } from \"../server/storage\";\nimport { sql } from \"drizzle-orm\";\n\nasync function recalculateAllStats() {\n  console.log(\"Starting bulk stats recalculation...\");\n  \n  const storage = new DatabaseStorage();\n  \n  // Get all unique user IDs from both game modes\n  const regionUsersResult = await db.execute(sql`\n    SELECT DISTINCT user_id FROM user_stats_region WHERE user_id IS NOT NULL\n  `);\n  const userModeUsersResult = await db.execute(sql`\n    SELECT DISTINCT user_id FROM user_stats_user WHERE user_id IS NOT NULL\n  `);\n  \n  const regionRows = Array.isArray(regionUsersResult) ? regionUsersResult : (regionUsersResult as any).rows || [];\n  const userRows = Array.isArray(userModeUsersResult) ? userModeUsersResult : (userModeUsersResult as any).rows || [];\n  \n  // Combine unique user IDs from both tables\n  const allUserIds = new Set<string>();\n  for (const row of regionRows) {\n    if (row.user_id) allUserIds.add(row.user_id);\n  }\n  for (const row of userRows) {\n    if (row.user_id) allUserIds.add(row.user_id);\n  }\n  \n  const userIdArray = Array.from(allUserIds);\n  console.log(`Found ${userIdArray.length} unique users to recalculate`);\n  \n  let successCount = 0;\n  let errorCount = 0;\n  \n  for (const userId of userIdArray) {\n    try {\n      console.log(`Processing user: ${userId}`);\n      \n      // Recalculate Region mode stats\n      try {\n        const regionStats = await storage.recalculateUserStatsRegion(userId);\n        console.log(`  Region - currentStreak: ${regionStats.currentStreak}, maxStreak: ${regionStats.maxStreak}`);\n      } catch (e: any) {\n        console.log(`  Region - skipped (${e.message})`);\n      }\n      \n      // Recalculate User mode stats\n      try {\n        const userStats = await storage.recalculateUserStatsUser(userId);\n        console.log(`  User - currentStreak: ${userStats.currentStreak}, maxStreak: ${userStats.maxStreak}`);\n      } catch (e: any) {\n        console.log(`  User - skipped (${e.message})`);\n      }\n      \n      successCount++;\n    } catch (error: any) {\n      console.error(`  Error: ${error.message}`);\n      errorCount++;\n    }\n  }\n  \n  console.log(`\\nCompleted! Processed ${successCount} users successfully, ${errorCount} errors.`);\n  process.exit(0);\n}\n\nrecalculateAllStats().catch((error) => {\n  console.error(\"Fatal error:\", error);\n  process.exit(1);\n});\n","path":null,"size_bytes":2389,"size_tokens":null},"client/src/components/HolidayActivationOverlay.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Globe, User } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface HolidayActivationOverlayProps {\n  show: boolean;\n  regionHolidayDates: string[];\n  userHolidayDates: string[];\n  showUserAfterRegion: boolean;\n  holidayDurationDays: number;\n  onComplete: () => void;\n}\n\nexport function HolidayActivationOverlay({\n  show,\n  regionHolidayDates,\n  userHolidayDates,\n  showUserAfterRegion,\n  holidayDurationDays,\n  onComplete,\n}: HolidayActivationOverlayProps) {\n  const [overlayMode, setOverlayMode] = useState<'region' | 'user'>('region');\n  const [phase, setPhase] = useState<'fade-in' | 'glow' | 'fade-out'>('fade-in');\n  const [shouldShowUserAfter, setShouldShowUserAfter] = useState(false);\n\n  useEffect(() => {\n    if (show) {\n      const hasRegion = regionHolidayDates.length > 0;\n      const hasUser = userHolidayDates.length > 0;\n      \n      if (hasRegion) {\n        setOverlayMode('region');\n        setShouldShowUserAfter(showUserAfterRegion && hasUser);\n      } else if (hasUser) {\n        setOverlayMode('user');\n        setShouldShowUserAfter(false);\n      }\n      setPhase('fade-in');\n    }\n  }, [show, regionHolidayDates, userHolidayDates, showUserAfterRegion]);\n\n  useEffect(() => {\n    if (!show) return;\n    \n    let timer: NodeJS.Timeout;\n    \n    if (phase === 'fade-in') {\n      timer = setTimeout(() => setPhase('glow'), 1000);\n    } else if (phase === 'glow') {\n      timer = setTimeout(() => setPhase('fade-out'), 3000);\n    } else if (phase === 'fade-out') {\n      timer = setTimeout(() => {\n        if (overlayMode === 'region' && shouldShowUserAfter) {\n          setOverlayMode('user');\n          setShouldShowUserAfter(false);\n          setPhase('fade-in');\n        } else {\n          onComplete();\n        }\n      }, 1000);\n    }\n    \n    return () => clearTimeout(timer);\n  }, [show, phase, overlayMode, shouldShowUserAfter, onComplete]);\n\n  const today = new Date();\n  const currentMonth = today.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });\n  const currentDay = today.getDate();\n  const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();\n  const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).getDay();\n  const adjustedFirstDay = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;\n\n  const currentHolidayDates = overlayMode === 'region' ? regionHolidayDates : userHolidayDates;\n\n  return (\n    <AnimatePresence>\n      {show && (\n        <motion.div\n          className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/80\"\n          initial={{ opacity: 0 }}\n          animate={{ opacity: phase === 'fade-out' ? 0 : 1 }}\n          exit={{ opacity: 0 }}\n          transition={{ duration: 1 }}\n        >\n          <motion.div\n            className=\"bg-card rounded-lg p-6 max-w-sm w-full mx-4 shadow-xl\"\n            initial={{ scale: 0.9, opacity: 0 }}\n            animate={{ scale: 1, opacity: phase === 'fade-out' ? 0 : 1 }}\n            transition={{ duration: 0.5 }}\n          >\n            <div className=\"flex items-center justify-center gap-2 mb-4\">\n              <div className={cn(\n                \"p-2 rounded-full\",\n                overlayMode === 'region' \n                  ? \"bg-blue-100 dark:bg-blue-900/30\" \n                  : \"bg-purple-100 dark:bg-purple-900/30\"\n              )}>\n                {overlayMode === 'region' ? (\n                  <Globe className=\"h-5 w-5 text-blue-500\" />\n                ) : (\n                  <User className=\"h-5 w-5 text-purple-500\" />\n                )}\n              </div>\n              <h3 className=\"text-lg font-semibold\">\n                {overlayMode === 'region' ? 'Global Game' : 'Personal Game'}\n              </h3>\n            </div>\n\n            <p className=\"text-center text-sm text-muted-foreground mb-4\">\n              Holiday mode is now active\n            </p>\n\n            <div className=\"bg-muted/50 rounded-lg p-4\">\n              <p className=\"text-center text-sm font-medium mb-3\">{currentMonth}</p>\n              \n              <div className=\"grid grid-cols-7 gap-1 mb-2\">\n                {['M', 'T', 'W', 'T', 'F', 'S', 'S'].map((day, i) => (\n                  <div key={i} className=\"text-center text-xs text-muted-foreground font-medium\">\n                    {day}\n                  </div>\n                ))}\n              </div>\n\n              <div className=\"grid grid-cols-7 gap-1\">\n                {Array.from({ length: adjustedFirstDay }).map((_, i) => (\n                  <div key={`empty-${i}`} className=\"aspect-square\" />\n                ))}\n                \n                {Array.from({ length: daysInMonth }).map((_, i) => {\n                  const day = i + 1;\n                  const isToday = day === currentDay;\n                  \n                  const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;\n                  const isHolidayDate = currentHolidayDates.includes(dateStr);\n                  \n                  return (\n                    <div\n                      key={day}\n                      className={cn(\n                        \"aspect-square flex items-center justify-center text-xs rounded-md relative\",\n                        (isToday || isHolidayDate) && \"font-bold\"\n                      )}\n                    >\n                      {isHolidayDate && phase === 'glow' && (\n                        <motion.div\n                          className=\"absolute inset-0 rounded-md border-2 border-yellow-400\"\n                          initial={{ opacity: 0 }}\n                          animate={{\n                            opacity: 1,\n                            boxShadow: [\n                              \"0 0 5px 2px rgba(250, 204, 21, 0.4)\",\n                              \"0 0 15px 5px rgba(250, 204, 21, 0.7)\",\n                              \"0 0 5px 2px rgba(250, 204, 21, 0.4)\",\n                            ],\n                          }}\n                          transition={{\n                            duration: 1.5,\n                            repeat: Infinity,\n                            ease: \"easeInOut\",\n                          }}\n                        />\n                      )}\n                      <span className={cn(isHolidayDate && phase === 'glow' && \"relative z-10\")}>{day}</span>\n                    </div>\n                  );\n                })}\n              </div>\n            </div>\n          </motion.div>\n        </motion.div>\n      )}\n    </AnimatePresence>\n  );\n}\n","path":null,"size_bytes":6626,"size_tokens":null},"client/src/components/LoginPage.tsx":{"content":"import { useState, useEffect, useMemo, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { PasswordInput } from \"@/components/ui/password-input\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { ChevronLeft } from \"lucide-react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useSupabase } from \"@/lib/SupabaseProvider\";\nimport { SiGoogle, SiApple } from \"react-icons/si\";\nimport { validatePassword, getPasswordRequirementsText } from \"@/lib/passwordValidation\";\nimport { isIosPwa } from \"@/lib/pwaContext\";\n\nconst isValidEmail = (email: string): boolean => {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email.trim());\n};\n\ninterface LoginPageProps {\n  onSuccess: () => void;\n  onBack: () => void;\n  onSignup: () => void;\n  onForgotPassword?: () => void;\n  onPersonalise?: (email: string, password?: string) => void;\n  subtitle?: string; // Optional subtitle to show below the main title\n  prefilledEmail?: string; // Pre-fill email field when returning from personalise\n}\n\ntype LoginStep = \"email\" | \"password\" | \"magic-link\" | \"create-account\" | \"set-password\";\n\ninterface UserAuthInfo {\n  exists: boolean;\n  hasPassword: boolean;\n  hasMagicLink: boolean;\n  magicLinkEnabled: boolean;\n  googleLinked: boolean;\n  appleLinked: boolean;\n}\n\nconst MAGIC_LINK_COOLDOWN_SECONDS = 60;\n\nexport default function LoginPage({ onSuccess, onBack, onSignup, onForgotPassword, onPersonalise, subtitle, prefilledEmail }: LoginPageProps) {\n  const { signIn, isAuthenticated } = useAuth();\n  const supabase = useSupabase();\n  const { toast } = useToast();\n  \n  // If user is already authenticated and came from personalise screen, redirect them back\n  useEffect(() => {\n    if (isAuthenticated && prefilledEmail) {\n      console.log('[LoginPage] User already authenticated with prefilled email, calling onSuccess');\n      onSuccess();\n    }\n  }, [isAuthenticated, prefilledEmail, onSuccess]);\n  \n  const [email, setEmail] = useState(prefilledEmail || \"\");\n  const [password, setPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [step, setStep] = useState<LoginStep>(\"email\");\n  const [loading, setLoading] = useState(false);\n  const [sendingMagicLink, setSendingMagicLink] = useState(false);\n  const [magicLinkSent, setMagicLinkSent] = useState(false);\n  const [magicLinkCooldown, setMagicLinkCooldown] = useState(0);\n  const [userAuthInfo, setUserAuthInfo] = useState<UserAuthInfo | null>(null);\n  const [fadeIn, setFadeIn] = useState(false);\n  const [creatingAccount, setCreatingAccount] = useState(false);\n  const [settingPassword, setSettingPassword] = useState(false);\n  \n  // Check if running in iOS PWA context (magic links don't work in PWA)\n  const isInIosPwa = useMemo(() => isIosPwa(), []);\n\n  const cooldownIntervalRef = useRef<NodeJS.Timeout | null>(null);\n\n  const [isDarkMode, setIsDarkMode] = useState(() => \n    document.documentElement.classList.contains('dark')\n  );\n  \n  useEffect(() => {\n    const observer = new MutationObserver((mutations) => {\n      mutations.forEach((mutation) => {\n        if (mutation.attributeName === 'class') {\n          setIsDarkMode(document.documentElement.classList.contains('dark'));\n        }\n      });\n    });\n    \n    observer.observe(document.documentElement, { attributes: true });\n    return () => observer.disconnect();\n  }, []);\n\n  useEffect(() => {\n    return () => {\n      if (cooldownIntervalRef.current) {\n        clearInterval(cooldownIntervalRef.current);\n      }\n    };\n  }, []);\n  \n  const backgroundColor = useMemo(() => {\n    return isDarkMode ? 'hsl(222, 47%, 11%)' : '#FAFAFA';\n  }, [isDarkMode]);\n  \n  const textColor = useMemo(() => {\n    return isDarkMode ? '#FAFAFA' : '#54524F';\n  }, [isDarkMode]);\n\n  const secondaryTextColor = useMemo(() => {\n    return isDarkMode ? 'rgba(255, 255, 255, 0.7)' : '#666';\n  }, [isDarkMode]);\n\n  useEffect(() => {\n    requestAnimationFrame(() => {\n      setFadeIn(true);\n    });\n  }, []);\n\n  const startCooldown = () => {\n    setMagicLinkCooldown(MAGIC_LINK_COOLDOWN_SECONDS);\n    \n    if (cooldownIntervalRef.current) {\n      clearInterval(cooldownIntervalRef.current);\n    }\n    \n    cooldownIntervalRef.current = setInterval(() => {\n      setMagicLinkCooldown((prev) => {\n        if (prev <= 1) {\n          if (cooldownIntervalRef.current) {\n            clearInterval(cooldownIntervalRef.current);\n            cooldownIntervalRef.current = null;\n          }\n          return 0;\n        }\n        return prev - 1;\n      });\n    }, 1000);\n  };\n\n  const handleEmailContinue = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!email.trim()) {\n      toast({\n        title: \"Email required\",\n        description: \"Please enter your email address.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setLoading(true);\n    \n    try {\n      const response = await fetch(`/api/auth/check-user?email=${encodeURIComponent(email.trim())}`);\n      const data = await response.json();\n      \n      if (data.exists) {\n        setUserAuthInfo(data);\n        if (data.hasPassword) {\n          setStep(\"password\");\n        } else {\n          // User exists but has no password\n          // In iOS PWA, they must create a password (magic links don't work in PWA)\n          if (isInIosPwa) {\n            setStep(\"set-password\");\n          } else {\n            setStep(\"magic-link\");\n          }\n        }\n      } else {\n        setStep(\"create-account\");\n      }\n    } catch (error) {\n      console.error(\"[LoginPage] Error checking user:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to check account. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handlePasswordLogin = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!password) {\n      toast({\n        title: \"Password required\",\n        description: \"Please enter your password.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setLoading(true);\n    \n    try {\n      const { data, error } = await supabase.auth.signInWithPassword({\n        email: email.trim(),\n        password,\n      });\n\n      if (error) {\n        toast({\n          title: \"Login failed\",\n          description: error.message,\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      if (data.session) {\n        onSuccess();\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Authentication failed\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleSendMagicLink = async (isNewAccount: boolean = false) => {\n    setSendingMagicLink(true);\n    \n    try {\n      const { error } = await supabase.auth.signInWithOtp({\n        email: email.trim(),\n        options: {\n          emailRedirectTo: window.location.origin,\n          shouldCreateUser: isNewAccount,\n        },\n      });\n\n      if (error) {\n        if (error.message.includes(\"rate\") || error.message.includes(\"limit\")) {\n          toast({\n            title: \"Too many requests\",\n            description: \"Please wait a few minutes before requesting another link.\",\n            variant: \"destructive\",\n          });\n        } else {\n          toast({\n            title: \"Error sending link\",\n            description: error.message,\n            variant: \"destructive\",\n          });\n        }\n        return;\n      }\n\n      setMagicLinkSent(true);\n      startCooldown();\n      toast({\n        title: \"Link sent!\",\n        description: \"Check your inbox for a secure login link. It expires in 5 minutes.\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to send magic link\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setSendingMagicLink(false);\n    }\n  };\n\n  const handleCreateAccount = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!password || !confirmPassword) {\n      toast({\n        title: \"Password required\",\n        description: \"Please enter and confirm your password.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (password !== confirmPassword) {\n      toast({\n        title: \"Passwords don't match\",\n        description: \"Please make sure both passwords are the same.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const validation = validatePassword(password);\n    if (!validation.valid) {\n      toast({\n        title: \"Invalid Password\",\n        description: validation.errors.join(\", \"),\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setCreatingAccount(true);\n    \n    try {\n      const { data, error } = await supabase.auth.signUp({\n        email: email.trim(),\n        password,\n        options: {\n          data: {\n            first_login_completed: false,\n          },\n        },\n      });\n\n      if (error) {\n        toast({\n          title: \"Error\",\n          description: error.message,\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      if (data.user) {\n        let session = data.session;\n        \n        if (!session) {\n          const signInResult = await supabase.auth.signInWithPassword({\n            email: email.trim(),\n            password,\n          });\n          \n          if (signInResult.error) {\n            toast({\n              title: \"Account created!\",\n              description: \"Please check your email to confirm your account, then log in.\",\n            });\n            setStep(\"email\");\n            return;\n          }\n          \n          session = signInResult.data.session;\n        }\n\n        // Mark password_created and signup_method in user_profiles since user created account with password\n        if (session) {\n          try {\n            await fetch('/api/auth/profile/password-created', {\n              method: 'POST',\n              headers: {\n                'Content-Type': 'application/json',\n                'Authorization': `Bearer ${session.access_token}`,\n              },\n              body: JSON.stringify({ setSignupMethod: true }), // Also set signup_method='password'\n            });\n          } catch (err) {\n            console.error('[LoginPage] Error setting password_created:', err);\n          }\n        }\n\n        if (onPersonalise) {\n          onPersonalise(email.trim(), password);\n        } else {\n          onSuccess();\n        }\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create account\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setCreatingAccount(false);\n    }\n  };\n\n  const handleEditEmail = () => {\n    setStep(\"email\");\n    setPassword(\"\");\n    setConfirmPassword(\"\");\n    setUserAuthInfo(null);\n    setMagicLinkSent(false);\n    setMagicLinkCooldown(0);\n    if (cooldownIntervalRef.current) {\n      clearInterval(cooldownIntervalRef.current);\n      cooldownIntervalRef.current = null;\n    }\n  };\n\n  // Handle sending password reset for iOS PWA users who need to create a password\n  const handleSendPasswordReset = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    setSettingPassword(true);\n    \n    try {\n      const response = await fetch('/api/auth/send-password-reset', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ email: email.trim() }),\n      });\n      \n      const data = await response.json();\n      \n      if (!response.ok) {\n        throw new Error(data.error || 'Failed to send reset email');\n      }\n      \n      toast({\n        title: \"Email sent\",\n        description: \"Check your email for a link to set your password. After setting it, return to this app to log in.\",\n      });\n      \n      // Stay on this screen so user knows what to do next\n      setMagicLinkSent(true);\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to send reset email\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setSettingPassword(false);\n    }\n  };\n\n  const handleGoogleLogin = async () => {\n    try {\n      const { error } = await supabase.auth.signInWithOAuth({\n        provider: \"google\",\n        options: {\n          redirectTo: window.location.origin,\n        },\n      });\n      \n      if (error) {\n        toast({\n          title: \"Error\",\n          description: error.message,\n          variant: \"destructive\",\n        });\n      }\n      // User will be redirected to Google for authentication\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to sign in with Google\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleAppleLogin = () => {\n    toast({\n      title: \"Coming soon\",\n      description: \"Apple login will be available soon.\",\n    });\n  };\n\n  const getMagicLinkButtonText = () => {\n    if (sendingMagicLink) return \"Sending...\";\n    if (magicLinkCooldown > 0) return `Resend in ${magicLinkCooldown}s`;\n    if (magicLinkSent) return \"Resend link\";\n    return \"Email me a one-time sign in link\";\n  };\n\n  // Get the step title for the header\n  const getStepTitle = () => {\n    switch (step) {\n      case \"email\": return \"Log in\";\n      case \"password\": return \"Welcome back\";\n      case \"magic-link\": return \"Welcome back\";\n      case \"create-account\": return \"Create account\";\n      case \"set-password\": return \"Set password\";\n      default: return \"Log in\";\n    }\n  };\n\n  return (\n    <motion.div\n      initial={{ opacity: 0 }}\n      animate={{ opacity: fadeIn ? 1 : 0 }}\n      exit={{ opacity: 0 }}\n      transition={{ duration: 0.4, ease: \"easeOut\" }}\n      className=\"fixed inset-0 flex flex-col z-50 overflow-y-auto\"\n      style={{ backgroundColor }}\n      data-testid=\"login-page\"\n    >\n      {/* Header - matching AccountInfoPage style */}\n      <div className=\"flex items-center justify-between p-4 mb-2\" style={{ backgroundColor }}>\n        <button\n          onClick={step === \"email\" ? onBack : handleEditEmail}\n          data-testid=\"button-back\"\n          className=\"w-14 h-14 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n        >\n          <ChevronLeft className=\"h-9 w-9 text-gray-700 dark:text-gray-300\" />\n        </button>\n\n        <div className=\"flex flex-col items-center\">\n          <h1 \n            className=\"text-4xl font-bold\"\n            style={{ color: textColor }}\n            data-testid=\"text-title\"\n          >\n            {getStepTitle()}\n          </h1>\n        </div>\n\n        {/* Spacer to balance layout */}\n        <div className=\"w-14\" />\n      </div>\n\n      <div className=\"flex-1 flex flex-col items-center px-4 pb-12 max-w-md mx-auto w-full\">\n        <AnimatePresence mode=\"wait\">\n          {step === \"email\" && (\n            <motion.div\n              key=\"email-step\"\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              exit={{ opacity: 0 }}\n              transition={{ duration: 0.3 }}\n              className=\"w-full\"\n            >\n              <Card className=\"w-full\">\n                <CardContent className=\"pt-6 space-y-4\">\n                  {subtitle && (\n                    <p \n                      className=\"text-center text-sm text-muted-foreground\"\n                      data-testid=\"text-subtitle\"\n                    >\n                      {subtitle}\n                    </p>\n                  )}\n\n                  <form onSubmit={handleEmailContinue} className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                      <label \n                        htmlFor=\"email\" \n                        className=\"text-sm font-medium\"\n                        style={{ color: textColor }}\n                      >\n                        Email address\n                      </label>\n                      <Input\n                        id=\"email\"\n                        type=\"email\"\n                        value={email}\n                        onChange={(e) => setEmail(e.target.value)}\n                        placeholder=\"Enter your email\"\n                        className=\"w-full\"\n                        data-testid=\"input-email\"\n                        autoFocus\n                      />\n                    </div>\n\n                    <Button\n                      type=\"submit\"\n                      className={`w-full py-6 text-lg font-semibold ${\n                        isValidEmail(email) && !loading\n                          ? \"bg-blue-700 hover:bg-blue-800 text-white\"\n                          : \"bg-muted text-muted-foreground cursor-not-allowed\"\n                      }`}\n                      disabled={loading || !isValidEmail(email)}\n                      data-testid=\"button-continue\"\n                    >\n                      {loading ? \"Checking...\" : \"Continue\"}\n                    </Button>\n                  </form>\n\n                  <div className=\"flex items-center my-2\">\n                    <div className=\"flex-1 border-t\" style={{ borderColor: isDarkMode ? 'rgba(255,255,255,0.2)' : '#ddd' }} />\n                    <span className=\"px-4 text-sm\" style={{ color: secondaryTextColor }}>or</span>\n                    <div className=\"flex-1 border-t\" style={{ borderColor: isDarkMode ? 'rgba(255,255,255,0.2)' : '#ddd' }} />\n                  </div>\n\n                  <div className=\"space-y-3\">\n                    <Button\n                      type=\"button\"\n                      variant=\"outline\"\n                      className=\"w-full py-6 text-base font-medium border-2\"\n                      onClick={handleGoogleLogin}\n                      data-testid=\"button-google\"\n                    >\n                      <SiGoogle className=\"w-5 h-5 mr-3\" />\n                      Continue with Google\n                    </Button>\n\n                    <Button\n                      type=\"button\"\n                      variant=\"outline\"\n                      className=\"w-full py-6 text-base font-medium border-2\"\n                      onClick={handleAppleLogin}\n                      data-testid=\"button-apple\"\n                    >\n                      <SiApple className=\"w-5 h-5 mr-3\" />\n                      Continue with Apple\n                    </Button>\n                  </div>\n\n                  <p className=\"text-xs text-center text-muted-foreground\">\n                    By continuing, you agree to the{\" \"}\n                    <a href=\"/terms\" className=\"underline\">Terms of Sale</a>,{\" \"}\n                    <a href=\"/terms\" className=\"underline\">Terms of Service</a>, and{\" \"}\n                    <a href=\"/privacy\" className=\"underline\">Privacy Policy</a>.\n                  </p>\n                </CardContent>\n              </Card>\n            </motion.div>\n          )}\n\n          {step === \"password\" && (\n            <motion.div\n              key=\"password-step\"\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              exit={{ opacity: 0 }}\n              transition={{ duration: 0.3 }}\n              className=\"w-full\"\n            >\n              <Card className=\"w-full\">\n                <CardContent className=\"pt-6 space-y-4\">\n                  <p className=\"text-center text-muted-foreground\">\n                    Enter your password to log in.\n                  </p>\n\n                  <form onSubmit={handlePasswordLogin} className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                      <label \n                        htmlFor=\"email-display\" \n                        className=\"text-sm font-medium\"\n                        style={{ color: textColor }}\n                      >\n                        Email address\n                      </label>\n                      <div className=\"relative\">\n                        <Input\n                          id=\"email-display\"\n                          type=\"email\"\n                          value={email}\n                          disabled\n                          className=\"w-full pr-16 bg-muted\"\n                          data-testid=\"input-email-display\"\n                        />\n                        <button\n                          type=\"button\"\n                          onClick={handleEditEmail}\n                          className=\"absolute right-3 top-1/2 -translate-y-1/2 text-sm font-medium text-blue-600 dark:text-blue-400\"\n                          data-testid=\"button-edit-email\"\n                        >\n                          Edit\n                        </button>\n                      </div>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <label \n                        htmlFor=\"password\" \n                        className=\"text-sm font-medium\"\n                        style={{ color: textColor }}\n                      >\n                        Password\n                      </label>\n                      <PasswordInput\n                        id=\"password\"\n                        value={password}\n                        onChange={(e) => setPassword(e.target.value)}\n                        placeholder=\"Enter your password\"\n                        className=\"w-full\"\n                        data-testid=\"input-password\"\n                        autoFocus\n                      />\n                    </div>\n\n                    {onForgotPassword && (\n                      <button\n                        type=\"button\"\n                        onClick={onForgotPassword}\n                        className=\"text-sm underline text-blue-600 dark:text-blue-400\"\n                        data-testid=\"button-forgot-password\"\n                      >\n                        Forgot your password?\n                      </button>\n                    )}\n\n                    <Button\n                      type=\"submit\"\n                      className={`w-full py-6 text-lg font-semibold ${\n                        password && !loading\n                          ? \"bg-blue-700 hover:bg-blue-800 text-white\"\n                          : \"bg-muted text-muted-foreground cursor-not-allowed\"\n                      }`}\n                      disabled={loading || !password}\n                      data-testid=\"button-login\"\n                    >\n                      {loading ? \"Logging in...\" : \"Log in\"}\n                    </Button>\n                  </form>\n\n                  {/* Other login options - show based on what user has activated */}\n                  <div className=\"space-y-3\">\n                    {/* Magic link - only show if enabled and not iOS PWA */}\n                    {!isInIosPwa && userAuthInfo?.magicLinkEnabled !== false && (\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        className=\"w-full py-6 text-base font-medium border-2\"\n                        onClick={() => handleSendMagicLink(false)}\n                        disabled={sendingMagicLink || magicLinkCooldown > 0}\n                        data-testid=\"button-magic-link\"\n                      >\n                        {getMagicLinkButtonText()}\n                      </Button>\n                    )}\n\n                    {/* Google - only show if user has linked Google */}\n                    {userAuthInfo?.googleLinked && (\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        className=\"w-full py-6 text-base font-medium border-2\"\n                        onClick={handleGoogleLogin}\n                        data-testid=\"button-google-login\"\n                      >\n                        <SiGoogle className=\"w-5 h-5 mr-3\" />\n                        Continue with Google\n                      </Button>\n                    )}\n\n                    {/* Apple - only show if user has linked Apple */}\n                    {userAuthInfo?.appleLinked && (\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        className=\"w-full py-6 text-base font-medium border-2\"\n                        onClick={handleAppleLogin}\n                        data-testid=\"button-apple-login\"\n                      >\n                        <SiApple className=\"w-5 h-5 mr-3\" />\n                        Continue with Apple\n                      </Button>\n                    )}\n                  </div>\n\n                  {magicLinkSent && !isInIosPwa && (\n                    <motion.p\n                      initial={{ opacity: 0, y: -10 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      className=\"text-sm text-center p-3 rounded-lg\"\n                      style={{ \n                        backgroundColor: isDarkMode ? 'rgba(34, 197, 94, 0.2)' : 'rgba(34, 197, 94, 0.1)',\n                        color: isDarkMode ? '#86efac' : '#166534'\n                      }}\n                      data-testid=\"text-magic-link-success\"\n                    >\n                      Check your inbox for a secure login link. It expires in 5 minutes.\n                    </motion.p>\n                  )}\n                </CardContent>\n              </Card>\n            </motion.div>\n          )}\n\n          {step === \"magic-link\" && (\n            <motion.div\n              key=\"magic-link-step\"\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              exit={{ opacity: 0 }}\n              transition={{ duration: 0.3 }}\n              className=\"w-full\"\n            >\n              <Card className=\"w-full\">\n                <CardContent className=\"pt-6 space-y-4\">\n                  <p className=\"text-center text-muted-foreground\">\n                    We'll send you a secure login link.\n                  </p>\n\n                  <div className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                      <label \n                        htmlFor=\"email-display\" \n                        className=\"text-sm font-medium\"\n                        style={{ color: textColor }}\n                      >\n                        Email address\n                      </label>\n                      <div className=\"relative\">\n                        <Input\n                          id=\"email-display\"\n                          type=\"email\"\n                          value={email}\n                          disabled\n                          className=\"w-full pr-16 bg-muted\"\n                          data-testid=\"input-email-display\"\n                        />\n                        <button\n                          type=\"button\"\n                          onClick={handleEditEmail}\n                          className=\"absolute right-3 top-1/2 -translate-y-1/2 text-sm font-medium text-blue-600 dark:text-blue-400\"\n                          data-testid=\"button-edit-email\"\n                        >\n                          Edit\n                        </button>\n                      </div>\n                    </div>\n\n                    <Button\n                      type=\"button\"\n                      className=\"w-full bg-blue-700 hover:bg-blue-800 text-white py-6 text-lg font-semibold\"\n                      onClick={() => handleSendMagicLink(false)}\n                      disabled={sendingMagicLink || magicLinkCooldown > 0}\n                      data-testid=\"button-send-magic-link\"\n                    >\n                      {getMagicLinkButtonText()}\n                    </Button>\n\n                    {/* OAuth options - show if user has linked them */}\n                    {userAuthInfo?.googleLinked && (\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        className=\"w-full py-6 text-base font-medium border-2\"\n                        onClick={handleGoogleLogin}\n                        data-testid=\"button-google-login\"\n                      >\n                        <SiGoogle className=\"w-5 h-5 mr-3\" />\n                        Continue with Google\n                      </Button>\n                    )}\n\n                    {userAuthInfo?.appleLinked && (\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        className=\"w-full py-6 text-base font-medium border-2\"\n                        onClick={handleAppleLogin}\n                        data-testid=\"button-apple-login\"\n                      >\n                        <SiApple className=\"w-5 h-5 mr-3\" />\n                        Continue with Apple\n                      </Button>\n                    )}\n\n                    {magicLinkSent && (\n                      <motion.p\n                        initial={{ opacity: 0, y: -10 }}\n                        animate={{ opacity: 1, y: 0 }}\n                        className=\"text-sm text-center p-3 rounded-lg\"\n                        style={{ \n                          backgroundColor: isDarkMode ? 'rgba(34, 197, 94, 0.2)' : 'rgba(34, 197, 94, 0.1)',\n                          color: isDarkMode ? '#86efac' : '#166534'\n                        }}\n                        data-testid=\"text-magic-link-success\"\n                      >\n                        Check your inbox for a secure login link. It expires in 5 minutes.\n                      </motion.p>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n            </motion.div>\n          )}\n\n          {step === \"set-password\" && (\n            <motion.div\n              key=\"set-password-step\"\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              exit={{ opacity: 0 }}\n              transition={{ duration: 0.3 }}\n              className=\"w-full\"\n            >\n              <Card className=\"w-full\">\n                <CardContent className=\"pt-6 space-y-4\">\n                  <p className=\"text-center text-muted-foreground\">\n                    To sign in via the app, you need to set up a password.\n                  </p>\n                  <p className=\"text-center text-xs text-muted-foreground\">\n                    We'll send you an email with a link to create your password. After setting it, return here to sign in.\n                  </p>\n\n                  <form onSubmit={handleSendPasswordReset} className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                      <label \n                        htmlFor=\"email-display\" \n                        className=\"text-sm font-medium\"\n                        style={{ color: textColor }}\n                      >\n                        Email address\n                      </label>\n                      <div className=\"relative\">\n                        <Input\n                          id=\"email-display\"\n                          type=\"email\"\n                          value={email}\n                          disabled\n                          className=\"w-full pr-16 bg-muted\"\n                          data-testid=\"input-email-display\"\n                        />\n                        <button\n                          type=\"button\"\n                          onClick={handleEditEmail}\n                          className=\"absolute right-3 top-1/2 -translate-y-1/2 text-sm font-medium text-blue-600 dark:text-blue-400\"\n                          data-testid=\"button-edit-email\"\n                        >\n                          Edit\n                        </button>\n                      </div>\n                    </div>\n\n                    <Button\n                      type=\"submit\"\n                      className=\"w-full bg-blue-700 hover:bg-blue-800 text-white py-6 text-lg font-semibold\"\n                      disabled={settingPassword || magicLinkSent}\n                      data-testid=\"button-send-password-reset\"\n                    >\n                      {settingPassword ? \"Sending...\" : magicLinkSent ? \"Email sent\" : \"Send password setup email\"}\n                    </Button>\n\n                    {magicLinkSent && (\n                      <motion.div\n                        initial={{ opacity: 0, y: -10 }}\n                        animate={{ opacity: 1, y: 0 }}\n                        className=\"text-sm text-center p-3 rounded-lg space-y-2\"\n                        style={{ \n                          backgroundColor: isDarkMode ? 'rgba(34, 197, 94, 0.2)' : 'rgba(34, 197, 94, 0.1)',\n                          color: isDarkMode ? '#86efac' : '#166534'\n                        }}\n                      >\n                        <p>Check your email and click the link to set your password.</p>\n                        <p>After setting your password, return here and enter it to sign in.</p>\n                      </motion.div>\n                    )}\n\n                    {magicLinkSent && (\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        className=\"w-full py-6 text-base font-medium border-2\"\n                        onClick={handleEditEmail}\n                        data-testid=\"button-back-to-login\"\n                      >\n                        Back to sign in\n                      </Button>\n                    )}\n                  </form>\n                </CardContent>\n              </Card>\n            </motion.div>\n          )}\n\n          {step === \"create-account\" && (\n            <motion.div\n              key=\"create-account-step\"\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              exit={{ opacity: 0 }}\n              transition={{ duration: 0.3 }}\n              className=\"w-full\"\n            >\n              <Card className=\"w-full\">\n                <CardContent className=\"pt-6 space-y-4\">\n                  <div className=\"space-y-2\">\n                    <label \n                      htmlFor=\"email-display\" \n                      className=\"text-sm font-medium\"\n                      style={{ color: textColor }}\n                    >\n                      Email address\n                    </label>\n                    <div className=\"relative\">\n                      <Input\n                        id=\"email-display\"\n                        type=\"email\"\n                        value={email}\n                        disabled\n                        className=\"w-full pr-16 bg-muted\"\n                        data-testid=\"input-email-display\"\n                      />\n                      <button\n                        type=\"button\"\n                        onClick={handleEditEmail}\n                        className=\"absolute right-3 top-1/2 -translate-y-1/2 text-sm font-medium text-blue-600 dark:text-blue-400\"\n                        data-testid=\"button-edit-email\"\n                      >\n                        Edit\n                      </button>\n                    </div>\n                  </div>\n\n                  {/* Hide magic link option for iOS PWA users */}\n                  {!isInIosPwa && (\n                    <>\n                      <motion.div\n                        initial={{ opacity: 0, y: 10 }}\n                        animate={{ opacity: 1, y: 0 }}\n                        transition={{ duration: 0.3, delay: 0.1 }}\n                      >\n                        <Button\n                          type=\"button\"\n                          variant=\"outline\"\n                          className=\"w-full py-6 text-base font-medium border-2\"\n                          onClick={() => handleSendMagicLink(true)}\n                          disabled={sendingMagicLink || magicLinkCooldown > 0}\n                          data-testid=\"button-magic-link-signup\"\n                        >\n                          {getMagicLinkButtonText()}\n                        </Button>\n                      </motion.div>\n\n                      {magicLinkSent && (\n                        <motion.p\n                          initial={{ opacity: 0, y: -10 }}\n                          animate={{ opacity: 1, y: 0 }}\n                          className=\"text-sm text-center p-3 rounded-lg\"\n                          style={{ \n                            backgroundColor: isDarkMode ? 'rgba(34, 197, 94, 0.2)' : 'rgba(34, 197, 94, 0.1)',\n                            color: isDarkMode ? '#86efac' : '#166534'\n                          }}\n                          data-testid=\"text-magic-link-success\"\n                        >\n                          Check your inbox for a secure sign up link. It expires in 5 minutes.\n                        </motion.p>\n                      )}\n\n                      <motion.div\n                        initial={{ opacity: 0 }}\n                        animate={{ opacity: 1 }}\n                        transition={{ duration: 0.3, delay: 0.2 }}\n                        className=\"flex items-center my-2\"\n                      >\n                        <div className=\"flex-1 border-t\" style={{ borderColor: isDarkMode ? 'rgba(255,255,255,0.2)' : '#ddd' }} />\n                        <span className=\"px-4 text-sm\" style={{ color: secondaryTextColor }}>or</span>\n                        <div className=\"flex-1 border-t\" style={{ borderColor: isDarkMode ? 'rgba(255,255,255,0.2)' : '#ddd' }} />\n                      </motion.div>\n                    </>\n                  )}\n\n                  <motion.form\n                    initial={{ opacity: 0, y: 10 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    transition={{ duration: 0.3, delay: 0.3 }}\n                    onSubmit={handleCreateAccount}\n                    className=\"space-y-4\"\n                  >\n                    <div className=\"space-y-2\">\n                      <label \n                        htmlFor=\"new-password\" \n                        className=\"text-sm font-medium\"\n                        style={{ color: textColor }}\n                      >\n                        Password\n                      </label>\n                      <PasswordInput\n                        id=\"new-password\"\n                        value={password}\n                        onChange={(e) => setPassword(e.target.value)}\n                        placeholder=\"Create a password\"\n                        className=\"w-full\"\n                        data-testid=\"input-password\"\n                      />\n                      <p className=\"text-xs text-muted-foreground\">\n                        {getPasswordRequirementsText()}\n                      </p>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <label \n                        htmlFor=\"confirm-password\" \n                        className=\"text-sm font-medium\"\n                        style={{ color: textColor }}\n                      >\n                        Confirm Password\n                      </label>\n                      <PasswordInput\n                        id=\"confirm-password\"\n                        value={confirmPassword}\n                        onChange={(e) => setConfirmPassword(e.target.value)}\n                        placeholder=\"Confirm your password\"\n                        className=\"w-full\"\n                        data-testid=\"input-confirm-password\"\n                      />\n                    </div>\n\n                    <p className=\"text-xs text-center text-muted-foreground\">\n                      By creating an account, you agree to the{\" \"}\n                      <a href=\"/terms\" className=\"underline\">Terms of Sale</a>,{\" \"}\n                      <a href=\"/terms\" className=\"underline\">Terms of Service</a>, and{\" \"}\n                      <a href=\"/privacy\" className=\"underline\">Privacy Policy</a>.\n                    </p>\n\n                    <Button\n                      type=\"submit\"\n                      className={`w-full py-6 text-lg font-semibold ${\n                        validatePassword(password).valid && password === confirmPassword && !creatingAccount\n                          ? \"bg-blue-700 hover:bg-blue-800 text-white\"\n                          : \"bg-muted text-muted-foreground cursor-not-allowed\"\n                      }`}\n                      disabled={creatingAccount || !validatePassword(password).valid || password !== confirmPassword}\n                      data-testid=\"button-create-account\"\n                    >\n                      {creatingAccount ? \"Creating account...\" : \"Create account\"}\n                    </Button>\n                  </motion.form>\n                </CardContent>\n              </Card>\n            </motion.div>\n          )}\n        </AnimatePresence>\n      </div>\n\n      <div \n        className=\"py-4 text-center text-xs border-t\"\n        style={{ \n          borderColor: isDarkMode ? 'rgba(255,255,255,0.1)' : '#eee',\n          color: secondaryTextColor \n        }}\n      >\n        <a href=\"/privacy\" className=\"underline mx-2\">Privacy Policy</a>\n        <span>|</span>\n        <a href=\"/help\" className=\"underline mx-2\">Help</a>\n      </div>\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":41283,"size_tokens":null},"client/src/components/OnboardingScreen.tsx":{"content":"import { motion } from \"framer-motion\";\nimport { useState, useEffect, useMemo } from \"react\";\nimport welcomeHamsterGrey from \"@assets/Welcome-Hamster-Grey.svg\";\nimport { formatCanonicalDateWithOrdinal } from \"@/lib/dateFormat\";\n\ninterface OnboardingScreenProps {\n  eventTitle: string;\n  puzzleDateCanonical: string;\n  onPlay: () => void;\n  onLogin: () => void;\n  onSubscribe: () => void;\n}\n\nexport function OnboardingScreen({\n  eventTitle,\n  puzzleDateCanonical,\n  onPlay,\n  onLogin,\n  onSubscribe,\n}: OnboardingScreenProps) {\n  const [fadeIn, setFadeIn] = useState(false);\n  \n  // Format date as \"10th December 2025\"\n  const displayDate = formatCanonicalDateWithOrdinal(puzzleDateCanonical);\n  \n  const [isDarkMode, setIsDarkMode] = useState(() => \n    document.documentElement.classList.contains('dark')\n  );\n  \n  useEffect(() => {\n    const observer = new MutationObserver((mutations) => {\n      mutations.forEach((mutation) => {\n        if (mutation.attributeName === 'class') {\n          setIsDarkMode(document.documentElement.classList.contains('dark'));\n        }\n      });\n    });\n    \n    observer.observe(document.documentElement, { attributes: true });\n    return () => observer.disconnect();\n  }, []);\n  \n  const backgroundColor = useMemo(() => {\n    return isDarkMode ? 'hsl(222, 47%, 11%)' : '#FAFAFA';\n  }, [isDarkMode]);\n  \n  const textColor = useMemo(() => {\n    return isDarkMode ? '#FAFAFA' : '#54524F';\n  }, [isDarkMode]);\n  \n  useEffect(() => {\n    requestAnimationFrame(() => {\n      setFadeIn(true);\n    });\n  }, []);\n\n  return (\n    <motion.div\n      initial={{ opacity: 0 }}\n      animate={{ opacity: fadeIn ? 1 : 0 }}\n      exit={{ opacity: 0 }}\n      transition={{ duration: 0.4, ease: \"easeOut\" }}\n      className=\"fixed inset-0 flex flex-col items-center justify-center p-4 z-50\"\n      style={{ backgroundColor }}\n      data-testid=\"onboarding-screen\"\n    >\n      <div className=\"flex flex-col items-center justify-center max-w-md w-full space-y-6\">\n        <h1 \n          className=\"text-4xl font-bold\"\n          style={{ color: textColor }}\n          data-testid=\"text-onboarding-title\"\n        >\n          Elementle\n        </h1>\n        \n        <div className=\"h-32 w-32 flex items-center justify-center\">\n          <img\n            src={welcomeHamsterGrey}\n            alt=\"Welcome Hamster\"\n            className=\"h-32 w-auto object-contain\"\n            data-testid=\"img-onboarding-hamster\"\n          />\n        </div>\n\n        <div className=\"text-center space-y-4\">\n          <p \n            className=\"font-bold text-lg\"\n            style={{ color: textColor, maxWidth: '280px', margin: '0 auto' }}\n            data-testid=\"text-onboarding-prompt\"\n          >\n            On what date did this historical event occur?\n          </p>\n          \n          <p \n            className=\"text-xl font-bold\"\n            style={{ color: textColor }}\n            data-testid=\"text-onboarding-event\"\n          >\n            {eventTitle}\n          </p>\n        </div>\n\n        <div className=\"flex flex-col items-center gap-3 w-full pt-2\">\n          <button\n            onClick={onPlay}\n            className=\"w-3/5 text-white font-bold text-xl py-4 rounded-full hover:opacity-90 transition-opacity\"\n            style={{ backgroundColor: '#7DAAE8' }}\n            data-testid=\"button-onboarding-play\"\n          >\n            Play\n          </button>\n          \n          <button\n            onClick={onLogin}\n            className=\"w-3/5 text-white font-bold text-xl py-4 rounded-full hover:opacity-90 transition-opacity\"\n            style={{ backgroundColor: '#8A8A8A' }}\n            data-testid=\"button-onboarding-login\"\n          >\n            Log in\n          </button>\n          \n          <button\n            onClick={onSubscribe}\n            className=\"w-3/5 text-white font-bold text-xl py-4 rounded-full hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed\"\n            style={{ backgroundColor: '#8A8A8A' }}\n            data-testid=\"button-onboarding-subscribe\"\n            disabled\n          >\n            Subscribe\n          </button>\n        </div>\n\n        <p \n          className=\"text-sm pt-4\"\n          style={{ color: isDarkMode ? 'rgba(255, 255, 255, 0.6)' : '#999' }}\n          data-testid=\"text-onboarding-date\"\n        >\n          Puzzle date: {displayDate}\n        </p>\n      </div>\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":4387,"size_tokens":null},"client/src/lib/pwaContext.ts":{"content":"const PWA_INSTALLED_KEY = 'elementle_pwa_installed';\n\nexport function isPwaContext(): boolean {\n  if (typeof window === 'undefined') return false;\n  \n  const isStandalone = window.matchMedia('(display-mode: standalone)').matches;\n  const isIOSStandalone = (window.navigator as any).standalone === true;\n  const isAndroidTWA = document.referrer.includes('android-app://');\n  \n  return isStandalone || isIOSStandalone || isAndroidTWA;\n}\n\nexport function isIOS(): boolean {\n  if (typeof window === 'undefined') return false;\n  \n  const ua = window.navigator.userAgent;\n  const isIOSDevice = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);\n  \n  return isIOSDevice;\n}\n\nexport function isIosPwa(): boolean {\n  return isIOS() && isPwaContext();\n}\n\nexport function isIOSSafari(): boolean {\n  if (typeof window === 'undefined') return false;\n  \n  const ua = window.navigator.userAgent;\n  const isIOSDevice = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);\n  const isSafari = /Safari/.test(ua) && !/CriOS|FxiOS|OPiOS|EdgiOS/.test(ua);\n  \n  return isIOSDevice && isSafari && !isPwaContext();\n}\n\nexport function markPwaInstalled(): void {\n  try {\n    localStorage.setItem(PWA_INSTALLED_KEY, 'true');\n  } catch (e) {\n    console.warn('[pwaContext] Could not mark PWA as installed:', e);\n  }\n}\n\nexport function hasPwaInstalledFlag(): boolean {\n  try {\n    return localStorage.getItem(PWA_INSTALLED_KEY) === 'true';\n  } catch (e) {\n    return false;\n  }\n}\n","path":null,"size_bytes":1545,"size_tokens":null},"client/src/components/PasswordResetScreen.tsx":{"content":"import { useState, useEffect, useMemo } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useSupabase, usePasswordRecovery } from \"@/lib/SupabaseProvider\";\nimport { PasswordInput } from \"@/components/ui/password-input\";\nimport { validatePassword, getPasswordRequirementsText } from \"@/lib/passwordValidation\";\n\ninterface PasswordResetScreenProps {\n  onSuccess: () => void;\n}\n\nexport default function PasswordResetScreen({ onSuccess }: PasswordResetScreenProps) {\n  const supabase = useSupabase();\n  const { clearPasswordRecovery } = usePasswordRecovery();\n  const { toast } = useToast();\n  \n  const [password, setPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  const [fadeIn, setFadeIn] = useState(false);\n\n  const [isDarkMode, setIsDarkMode] = useState(() => \n    document.documentElement.classList.contains('dark')\n  );\n  \n  useEffect(() => {\n    const observer = new MutationObserver((mutations) => {\n      mutations.forEach((mutation) => {\n        if (mutation.attributeName === 'class') {\n          setIsDarkMode(document.documentElement.classList.contains('dark'));\n        }\n      });\n    });\n    \n    observer.observe(document.documentElement, { attributes: true });\n    return () => observer.disconnect();\n  }, []);\n\n  useEffect(() => {\n    requestAnimationFrame(() => {\n      setFadeIn(true);\n    });\n  }, []);\n  \n  const backgroundColor = useMemo(() => {\n    return isDarkMode ? 'hsl(222, 47%, 11%)' : '#FAFAFA';\n  }, [isDarkMode]);\n  \n  const textColor = useMemo(() => {\n    return isDarkMode ? '#FAFAFA' : '#54524F';\n  }, [isDarkMode]);\n\n  const secondaryTextColor = useMemo(() => {\n    return isDarkMode ? 'rgba(255, 255, 255, 0.7)' : '#666';\n  }, [isDarkMode]);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!password || !confirmPassword) {\n      toast({\n        title: \"Password required\",\n        description: \"Please enter and confirm your new password.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (password !== confirmPassword) {\n      toast({\n        title: \"Passwords don't match\",\n        description: \"Please make sure both passwords are the same.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const validation = validatePassword(password);\n    if (!validation.valid) {\n      toast({\n        title: \"Invalid Password\",\n        description: validation.errors.join(\", \"),\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setLoading(true);\n    \n    try {\n      const { error } = await supabase.auth.updateUser({ password });\n      \n      if (error) {\n        toast({\n          title: \"Error\",\n          description: error.message,\n          variant: \"destructive\",\n        });\n        return;\n      }\n      \n      // Update password_created in user_profiles\n      try {\n        const { data: sessionData } = await supabase.auth.getSession();\n        if (sessionData?.session) {\n          await fetch('/api/auth/profile/password-created', {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n              'Authorization': `Bearer ${sessionData.session.access_token}`,\n            },\n          });\n        }\n      } catch (err) {\n        console.error('[PasswordResetScreen] Error updating password_created:', err);\n      }\n      \n      toast({\n        title: \"Password updated\",\n        description: \"Your password has been successfully updated.\",\n      });\n      \n      clearPasswordRecovery();\n      onSuccess();\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update password\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div \n      className=\"fixed inset-0 flex flex-col items-center justify-center px-6\"\n      style={{ \n        backgroundColor,\n        opacity: fadeIn ? 1 : 0,\n        transition: 'opacity 0.3s ease-in-out'\n      }}\n    >\n      <div className=\"w-full max-w-md\">\n        <AnimatePresence mode=\"wait\">\n          <motion.div\n            key=\"password-reset\"\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            transition={{ duration: 0.3 }}\n            className=\"w-full\"\n          >\n            <h2 \n              className=\"text-2xl font-bold text-center mb-2\"\n              style={{ color: textColor }}\n              data-testid=\"text-heading\"\n            >\n              Set your new password\n            </h2>\n            <p \n              className=\"text-center mb-8\"\n              style={{ color: secondaryTextColor }}\n            >\n              Enter your new password below.\n            </p>\n\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <label \n                  htmlFor=\"new-password\" \n                  className=\"text-sm font-medium\"\n                  style={{ color: textColor }}\n                >\n                  New Password\n                </label>\n                <PasswordInput\n                  id=\"new-password\"\n                  value={password}\n                  onChange={(e) => setPassword(e.target.value)}\n                  placeholder=\"Enter new password\"\n                  className=\"w-full\"\n                  data-testid=\"input-new-password\"\n                  autoFocus\n                />\n                <p className=\"text-xs\" style={{ color: secondaryTextColor }}>\n                  {getPasswordRequirementsText()}\n                </p>\n              </div>\n\n              <div className=\"space-y-2\">\n                <label \n                  htmlFor=\"confirm-password\" \n                  className=\"text-sm font-medium\"\n                  style={{ color: textColor }}\n                >\n                  Confirm Password\n                </label>\n                <PasswordInput\n                  id=\"confirm-password\"\n                  value={confirmPassword}\n                  onChange={(e) => setConfirmPassword(e.target.value)}\n                  placeholder=\"Confirm new password\"\n                  className=\"w-full\"\n                  data-testid=\"input-confirm-password\"\n                />\n              </div>\n\n              <Button\n                type=\"submit\"\n                className=\"w-full bg-[#1a1a1a] hover:bg-[#333] text-white py-6 text-lg font-semibold\"\n                disabled={loading || !password || !confirmPassword}\n                data-testid=\"button-update-password\"\n              >\n                {loading ? \"Updating...\" : \"Update Password\"}\n              </Button>\n            </form>\n          </motion.div>\n        </AnimatePresence>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6929,"size_tokens":null},"client/src/pages/Subscriptions.tsx":{"content":"import { useEffect, useState } from 'react';\nimport { useLocation } from 'wouter';\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\nimport { motion } from 'framer-motion';\nimport { CheckCircle2, XCircle, Loader2, ChevronLeft, Crown } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { useToast } from '@/hooks/use-toast';\nimport { useAuth } from '@/hooks/useAuth';\nimport { getSupabaseClient } from '@/lib/supabaseClient';\n\ninterface SubscriptionStatus {\n  hasActiveSubscription: boolean;\n  subscription?: {\n    id: string;\n    tierId: string;\n    tierName: string;\n    status: string;\n    expiresAt: string | null;\n    autoRenew: boolean;\n  };\n}\n\nexport default function Subscriptions() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const { isAuthenticated, isLoading: authLoading } = useAuth();\n  const queryClient = useQueryClient();\n  \n  const urlParams = new URLSearchParams(window.location.search);\n  const isSuccess = urlParams.get('success') === 'true';\n  const isCanceled = urlParams.get('canceled') === 'true';\n  \n  const [pollCount, setPollCount] = useState(0);\n  const [hasShownToast, setHasShownToast] = useState(false);\n  const [subscriptionFound, setSubscriptionFound] = useState(false);\n  const maxPolls = 10;\n  const pollInterval = 3000;\n\n  const shouldPoll = isSuccess && \n    isAuthenticated && \n    !subscriptionFound && \n    pollCount < maxPolls;\n\n  const { data: subscriptionStatus, isLoading } = useQuery<SubscriptionStatus>({\n    queryKey: ['/api/subscription/status'],\n    queryFn: async () => {\n      const supabase = await getSupabaseClient();\n      const { data: { session } } = await supabase.auth.getSession();\n      if (!session) throw new Error('Not authenticated');\n\n      const response = await fetch('/api/subscription/status', {\n        credentials: 'include',\n        headers: {\n          'Authorization': `Bearer ${session.access_token}`,\n        },\n      });\n      \n      if (!response.ok) throw new Error('Failed to fetch subscription status');\n      \n      setPollCount(prev => prev + 1);\n      return response.json();\n    },\n    enabled: isAuthenticated && isSuccess,\n    refetchInterval: shouldPoll ? pollInterval : false,\n  });\n\n  useEffect(() => {\n    if (isSuccess && subscriptionStatus?.hasActiveSubscription && !hasShownToast) {\n      setSubscriptionFound(true);\n      setHasShownToast(true);\n      queryClient.invalidateQueries({ queryKey: ['/api/subscription'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/streak-saver/status'] });\n      \n      toast({\n        title: 'Subscription Activated!',\n        description: `Welcome to ${subscriptionStatus.subscription?.tierName || 'Pro'}!`,\n      });\n    }\n  }, [subscriptionStatus, isSuccess, queryClient, toast, hasShownToast]);\n\n  const handleBackToGame = () => {\n    const cleanUrl = window.location.pathname;\n    window.history.replaceState({}, '', cleanUrl);\n    setLocation('/');\n  };\n\n  if (authLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-background\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  if (isSuccess) {\n    const isActivated = subscriptionStatus?.hasActiveSubscription;\n    const isPolling = !isActivated && pollCount < maxPolls;\n    const pollingTimedOut = !isActivated && pollCount >= maxPolls;\n\n    return (\n      <motion.div\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        className=\"min-h-screen flex flex-col items-center justify-center bg-background p-4\"\n        data-testid=\"subscription-success-page\"\n      >\n        <div className=\"max-w-md w-full text-center space-y-6\">\n          {isPolling ? (\n            <>\n              <Loader2 className=\"h-16 w-16 animate-spin text-primary mx-auto\" />\n              <h1 className=\"text-2xl font-bold text-foreground\">\n                Activating Your Subscription...\n              </h1>\n              <p className=\"text-muted-foreground\">\n                Please wait while we confirm your payment.\n              </p>\n            </>\n          ) : isActivated ? (\n            <>\n              <div className=\"relative\">\n                <CheckCircle2 className=\"h-16 w-16 text-green-500 mx-auto\" />\n                <Crown className=\"h-6 w-6 text-yellow-500 absolute top-0 right-1/3 -translate-y-1\" />\n              </div>\n              <h1 className=\"text-2xl font-bold text-foreground\">\n                Welcome to Pro!\n              </h1>\n              <p className=\"text-muted-foreground\">\n                Your subscription is now active. Enjoy ad-free gameplay and unlimited personalized games!\n              </p>\n              <Button \n                onClick={handleBackToGame}\n                className=\"mt-4\"\n                data-testid=\"button-back-to-game\"\n              >\n                Start Playing\n              </Button>\n            </>\n          ) : pollingTimedOut ? (\n            <>\n              <Loader2 className=\"h-16 w-16 text-amber-500 mx-auto\" />\n              <h1 className=\"text-2xl font-bold text-foreground\">\n                Processing Your Payment\n              </h1>\n              <p className=\"text-muted-foreground\">\n                Your payment is being processed. This may take a few moments. You can start playing and your subscription will be activated shortly.\n              </p>\n              <Button \n                onClick={handleBackToGame}\n                className=\"mt-4\"\n                data-testid=\"button-back-to-game-pending\"\n              >\n                Continue to Game\n              </Button>\n            </>\n          ) : null}\n        </div>\n      </motion.div>\n    );\n  }\n\n  if (isCanceled) {\n    return (\n      <motion.div\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        className=\"min-h-screen flex flex-col items-center justify-center bg-background p-4\"\n        data-testid=\"subscription-canceled-page\"\n      >\n        <div className=\"max-w-md w-full text-center space-y-6\">\n          <XCircle className=\"h-16 w-16 text-muted-foreground mx-auto\" />\n          <h1 className=\"text-2xl font-bold text-foreground\">\n            Subscription Not Completed\n          </h1>\n          <p className=\"text-muted-foreground\">\n            No worries! You can subscribe anytime from the settings menu.\n          </p>\n          <Button \n            onClick={handleBackToGame}\n            className=\"mt-4\"\n            data-testid=\"button-back-to-game-canceled\"\n          >\n            <ChevronLeft className=\"h-4 w-4 mr-2\" />\n            Back to Game\n          </Button>\n        </div>\n      </motion.div>\n    );\n  }\n\n  return (\n    <motion.div\n      initial={{ opacity: 0 }}\n      animate={{ opacity: 1 }}\n      className=\"min-h-screen flex flex-col items-center justify-center bg-background p-4\"\n      data-testid=\"subscriptions-page\"\n    >\n      <div className=\"max-w-md w-full text-center space-y-6\">\n        <h1 className=\"text-2xl font-bold text-foreground\">Subscriptions</h1>\n        <p className=\"text-muted-foreground\">\n          Manage your subscription from the settings menu.\n        </p>\n        <Button \n          onClick={handleBackToGame}\n          data-testid=\"button-back-to-home\"\n        >\n          <ChevronLeft className=\"h-4 w-4 mr-2\" />\n          Back to Game\n        </Button>\n      </div>\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":7396,"size_tokens":null},"client/src/pages/ManageSubscriptionRoute.tsx":{"content":"import { useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { ManageSubscriptionPage } from \"@/components/ManageSubscriptionPage\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useSubscription } from \"@/hooks/useSubscription\";\nimport { AdBanner, AdBannerContext } from \"@/components/AdBanner\";\n\nexport default function ManageSubscriptionRoute() {\n  const [, setLocation] = useLocation();\n  const { isAuthenticated, isLoading: authLoading } = useAuth();\n  const { isLoading: subLoading } = useSubscription();\n  \n  // Redirect if not authenticated\n  useEffect(() => {\n    if (authLoading) return;\n    \n    if (!isAuthenticated) {\n      setLocation(\"/\");\n      return;\n    }\n  }, [authLoading, isAuthenticated, setLocation]);\n  \n  const handleBack = () => {\n    setLocation(\"/\");\n  };\n  \n  if (authLoading || subLoading) {\n    return (\n      <div className=\"min-h-screen flex flex-col items-center justify-center bg-background p-4\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4\" />\n      </div>\n    );\n  }\n  \n  return (\n    <AdBannerContext.Provider value={true}>\n      <ManageSubscriptionPage\n        onBack={handleBack}\n        onGoProClick={() => {}}\n      />\n      <AdBanner />\n    </AdBannerContext.Provider>\n  );\n}\n","path":null,"size_bytes":1290,"size_tokens":null},"client/src/pages/SubscriptionSuccessRoute.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { CategorySelectionScreen } from \"@/components/CategorySelectionScreen\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { getSupabaseClient } from \"@/lib/supabaseClient\";\n\nconst SUBSCRIPTION_SUCCESS_FLAG = \"elementle-subscription-success-pending\";\n\ninterface SubscriptionStatus {\n  hasActiveSubscription: boolean;\n  subscription?: {\n    id: string;\n    tierId: string;\n    tierName: string;\n    status: string;\n    expiresAt: string | null;\n    autoRenew: boolean;\n  };\n}\n\nexport default function SubscriptionSuccessRoute() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { isAuthenticated, isLoading: authLoading } = useAuth();\n  \n  const [showCategorySelection, setShowCategorySelection] = useState(false);\n  const hasShownSuccessToast = useRef(false);\n  \n  // Polling state for subscription activation\n  const [pollCount, setPollCount] = useState(0);\n  const [subscriptionFound, setSubscriptionFound] = useState(false);\n  const maxPolls = 5; // 5 polls at 2 second intervals = 10 seconds max\n  const pollInterval = 2000;\n  \n  // Hard timeout after 10 seconds - redirect to manage subscription\n  useEffect(() => {\n    const timeout = setTimeout(() => {\n      if (!subscriptionFound) {\n        toast({\n          title: \"Subscription processing\",\n          description: \"Your subscription may take a moment to activate. Check your subscription status.\",\n        });\n        setLocation(\"/manage-subscription\");\n      }\n    }, 10000);\n    \n    return () => clearTimeout(timeout);\n  }, [subscriptionFound, setLocation, toast]);\n  \n  // Should poll while waiting for subscription to activate\n  const shouldPoll = isAuthenticated && \n    !subscriptionFound && \n    pollCount < maxPolls;\n  \n  // Poll for subscription status\n  const { data: subscriptionStatus } = useQuery<SubscriptionStatus>({\n    queryKey: ['/api/subscription/status'],\n    queryFn: async () => {\n      const supabase = await getSupabaseClient();\n      const { data: { session } } = await supabase.auth.getSession();\n      if (!session) throw new Error('Not authenticated');\n\n      const response = await fetch('/api/subscription/status', {\n        credentials: 'include',\n        headers: {\n          'Authorization': `Bearer ${session.access_token}`,\n        },\n      });\n      \n      if (!response.ok) throw new Error('Failed to fetch subscription status');\n      \n      setPollCount(prev => prev + 1);\n      return response.json();\n    },\n    enabled: isAuthenticated && !subscriptionFound,\n    refetchInterval: shouldPoll ? pollInterval : false,\n  });\n  \n  // When subscription is found, show category selection\n  useEffect(() => {\n    if (subscriptionStatus?.hasActiveSubscription && !hasShownSuccessToast.current) {\n      hasShownSuccessToast.current = true;\n      setSubscriptionFound(true);\n      \n      // Invalidate subscription queries to refresh data\n      queryClient.invalidateQueries({ queryKey: ['/api/subscription'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/subscription/status'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/streak-saver/status'] });\n      \n      const pendingFlag = sessionStorage.getItem(SUBSCRIPTION_SUCCESS_FLAG);\n      if (!pendingFlag) {\n        sessionStorage.setItem(SUBSCRIPTION_SUCCESS_FLAG, \"true\");\n        \n        toast({\n          title: \"Subscription successfully activated\",\n          description: \"Welcome to Elementle Pro! Now choose your categories.\",\n        });\n      }\n      \n      // Show category selection immediately\n      setShowCategorySelection(true);\n    }\n  }, [subscriptionStatus, queryClient, toast]);\n  \n  // Redirect if not authenticated\n  useEffect(() => {\n    if (authLoading) return;\n    \n    if (!isAuthenticated) {\n      setLocation(\"/\");\n      return;\n    }\n  }, [authLoading, isAuthenticated, setLocation]);\n  \n  const handleCategoryClose = () => {\n    sessionStorage.removeItem(SUBSCRIPTION_SUCCESS_FLAG);\n    setShowCategorySelection(false);\n    setLocation(\"/\");\n  };\n  \n  const handleCategoryGenerate = () => {\n    sessionStorage.removeItem(SUBSCRIPTION_SUCCESS_FLAG);\n    setShowCategorySelection(false);\n    setLocation(\"/\");\n  };\n  \n  // Show spinner while polling for subscription activation\n  const isPollingForActivation = !subscriptionFound && pollCount < maxPolls;\n  const pollingTimedOut = !subscriptionFound && pollCount >= maxPolls;\n  \n  if (authLoading || isPollingForActivation) {\n    return (\n      <div className=\"min-h-screen flex flex-col items-center justify-center bg-background p-4\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4\" />\n        <p className=\"text-muted-foreground text-center\" data-testid=\"text-activating\">\n          Activating your subscription...\n        </p>\n      </div>\n    );\n  }\n  \n  // If polling timed out, the useEffect timeout will redirect, but show loading in meantime\n  if (pollingTimedOut) {\n    return (\n      <div className=\"min-h-screen flex flex-col items-center justify-center bg-background p-4\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4\" />\n        <p className=\"text-muted-foreground text-center\" data-testid=\"text-redirecting\">\n          Redirecting...\n        </p>\n      </div>\n    );\n  }\n  \n  return (\n    <CategorySelectionScreen\n      isOpen={showCategorySelection}\n      onClose={handleCategoryClose}\n      onGenerate={handleCategoryGenerate}\n    />\n  );\n}\n","path":null,"size_bytes":5680,"size_tokens":null}},"version":2}