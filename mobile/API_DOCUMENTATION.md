# API Documentation

## Supabase Backend API

### Authentication

Standard Supabase Auth is used.
- **Sign Up**: `supabase.auth.signUp()`
- **Sign In**: `supabase.auth.signInWithPassword()`
- **Sign Out**: `supabase.auth.signOut()`
- **Reset Password**: `supabase.auth.resetPasswordForEmail()`

### Database Tables (Schema)

#### User Management
- **`user_profiles`**: Core profile data.
    - Columns: `id` (PK, uuid), `email`, `first_name`, `last_name`, `region`, `categories`, `user_tier_id`, `stripe_customer_id`, `accepted_terms`, `ads_consent`, `email_verified`, `active_locations_count`, `total_locations_allocated`.
- **`user_settings`**: User preferences linked to profile.
    - Columns: `id`, `user_id`, `text_size`, `sounds_enabled`, `dark_mode`, `clues_enabled`, `streak_saver_active`, `holiday_saver_active`, `category_preferences` (json), `digit_preference`.
- **`user_tier`**: Subscription tier definitions.
    - Columns: `id`, `tier` (e.g. free, pro), `tier_type` (monthly/annual), `subscription_cost`, `streak_savers`, `holiday_savers`, `holiday_duration_days`, `revenuecat_product_id`.
- **`user_subscriptions`**: Active user subscriptions.
    - Columns: `id`, `user_id`, `status` (active/expired), `tier`, `revenuecat_product_id`, `expires_at`, `auto_renew`.
- **`user_category_preferences`**: Categories preferred by the user (likely duplicates or relates to `user_settings.category_preferences`).
- **`user_promo_grants`**: Promotional grants given to users (e.g. free months).

#### Game Data (Region Mode)
- **`questions_allocated_region`**: Puzzles assigned to regions for specific dates.
    - Columns: `id`, `puzzle_date`, `region`, `question_id`, `category_id`, `category_hint`.
- **`game_attempts_region`**: User attempts on region puzzles.
    - Columns: `id`, `user_id`, `allocated_region_id`, `digits`, `num_guesses`, `result` (won/lost), `streak_day_status`, `started_at`, `completed_at`.
- **`guesses_region`**: Individual guesses for a region attempt.
    - Columns: `id`, `game_attempt_id`, `guess_value`, `guessed_at`.
- **`user_stats_region`**: Aggregated stats for a user in Region mode.
    - Columns: `id`, `user_id`, `region`, `games_played`, `games_won`, `current_streak`, `max_streak`, `streak_savers_used_month`, `score_final`.

#### Game Data (User Mode)
- **`questions_allocated_user`**: Puzzles assigned specifically to a user.
    - Columns: `id`, `user_id`, `puzzle_date`, `question_id`, `category_id`, `slot_type`.
- **`game_attempts_user`**: User attempts on user-specific puzzles.
    - Columns: `id`, `user_id`, `allocated_user_id`, `digits`, `num_guesses`, `result`.
- **`guesses_user`**: Individual guesses for a user attempt.
    - Columns: `id`, `game_attempt_id`, `guess_value`.
- **`user_stats_user`**: Aggregated stats for a user in User mode.
    - Columns: `id`, `user_id`, `games_played`, `games_won`, `current_streak`, `max_streak`, `holiday_active`, `holiday_start_date`, `holiday_end_date`, `holidays_used_year`.

#### Content & Logistics
- **`questions_master_region`**: Master pool of questions for regions.
- **`questions_master_user`**: Master pool of questions for users.
- **`available_question_spec`**: Configuration for potential questions.
- **`categories`**: Game categories (Geography, History, etc.).
- **`populated_places`**: Location data source (Cities, Towns).
- **`regions`**: Geographic regions definition (e.g. "UK", "USA").
- **`postcodes`**, **`postcode_districts`**: Postal code data.
- **`locations`**: General location data.

#### Demand Scheduling & Generation (Infrastructure)
- **`demand_scheduler_config`**: Configuration for when demand jobs run.
- **`demand_summary`**: Summary of demand for puzzles (what needs to be generated).
- **`questions_to_generate`**: Queue of questions that need to be generated by AI.
- **`questions_to_generate_archive`**: Archive of generated questions.
- **`questions_to_generate_log`**: Logs of generation process.
- **`allocation_log`**: Logs of puzzle allocation to users/regions.
- **`question_generation_settings`**: Settings for the generator (thresholds, seeds).
- **`location_allocation`**: Allocation of locations to users (score based).
- **`location_allocation_audit`**: Audit trail for location allocation changes.

#### Logs & Admin
- **`admin_settings`**: Global system settings.
- **`daily_percentile_job_logs`**: Logs for daily percentile calculations.
- **`monthly_job_logs`**: Logs for monthly job runs.
- **`debug_events`**: Generic debug event logging.
- **`audit_missed_flag_changes`**: Audit trail for manual flag changes.

#### Payments & Commerce
- **`payments`**: Record of payments (Stripe/RevenueCat).
- **`promotions`**: Discount codes and promotions.

#### Gamification
- **`badges`**: Definitions of available badges.
    - Columns: `id`, `name`, `description`, `category`, `threshold`, `icon_url`.
- **`user_badges`**: Badges earned by users.
    - Columns: `id`, `user_id`, `badge_id`, `game_type` (REGION/USER), `region`, `is_awarded`, `awarded_at`.

### Key Logic Notes

- **Separation of Modes**: The app strictly separates "Region Mode" (everyone in a region gets the same puzzle) and "User Mode" (personalized). Almost all game tables are duplicated with `_region` and `_user` suffixes.
- **Streak & Holiday**: 
    - `streak_saver_active` is in `user_settings`.
    - `streak_savers_used_month` is tracked in `user_stats_region` and `user_stats_user`.
    - `holiday_active`, `holiday_start_date`, etc., are tracked in `user_stats_user` (and likely derived/managed differently for region mode or stored in user stats generically).
- **Infrastructure**: A complex demand scheduling system ensures puzzles are generated and allocated ahead of time. This is managed via `demand_summary` and `questions_allocated_*` tables.

### RPC Functions (Verified)

- `get_current_streak(p_user_id, p_mode)`
- `get_max_streak(p_user_id, p_mode)`

_(Note: This documentation is auto-generated based on `database.types.ts` analysis)_
